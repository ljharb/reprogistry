[
	{
		"reproduceVersion": "0.0.0-local",
		"timestamp": "2025-12-31T06:52:19.479Z",
		"os": "linux",
		"arch": "x64",
		"strategy": "npm:11.7.0",
		"reproduced": false,
		"attested": false,
		"package": {
			"spec": "koa@3.0.0-alpha.3",
			"name": "koa",
			"version": "3.0.0-alpha.3",
			"location": "https://registry.npmjs.org/koa/-/koa-3.0.0-alpha.3.tgz",
			"integrity": "sha512-ZD2YDi9VhrncTJ++l7GuScrLxIEUX/pw7xvpbUsG1aboem7ohbpjmS8NnqtR4Q6ZWkZSrq3JlYNZ1ILE8meVgg==",
			"publishedAt": "2025-02-11T13:01:37.929Z",
			"publishedWith": {
				"node": "22.13.1",
				"npm": "10.9.2"
			}
		},
		"source": {
			"integrity": "sha512-KDDuvpfqSK0ZKEO2gCPedNjl5wYpfj+HNiuVRlbhd1A88S3M0ySkdf2V/EJ4NWt5dwh5PXCdcenrKK2IQJAxsg==",
			"location": "git+https://github.com/koajs/koa.git",
			"spec": "github:koajs/koa#1d7d0947509949c85d22509fb170fe068bc8f2ea"
		},
		"comparisonHash": "8a2a8dcbb729bf3ee9216e490c955701f0ddebe1",
		"diff": {
			"files": {
				"Readme.md": {
					"diff": "--- published/Readme.md\n+++ rebuilt/Readme.md\n@@ -19,8 +19,8 @@\n \n Koa requires __node v18.0.0__ or higher for ES2015 and async function support.\n \n-```\n-$ npm install koa\n+```sh\n+npm install koa\n ```\n \n ## Hello Koa\n@@ -81,10 +81,9 @@\n \n The middleware signature changed between v1.x and v2.x.  The older signature is deprecated.\n \n-**Old signature middleware support will be removed in v3**\n+**Old signature middleware support has been removed in v3**\n \n-Please see the [Migration Guide](docs/migration.md) for more information on upgrading from v1.x and\n-using v1.x middleware with v2.x.\n+Please see the [Migration Guide from v2.x to v3.x](docs/migration-v2-to-v3.md) for information on upgrading from v2.x to v3.x, and the [Migration Guide from v1.x to v2.x](docs/migration-v1-to-v2.md) for information on upgrading from v1.x to v2.x.\n \n ## Context, Request and Response\n \n@@ -96,7 +95,7 @@\n app.use(async (ctx, next) => { await next(); });\n ```\n \n-Koa provides a `Request` object as the `request` property of the `Context`.  \n+Koa provides a `Request` object as the `request` property of the `Context`.\n Koa's `Request` object provides helpful methods for working with\n http requests which delegate to an [IncomingMessage](https://nodejs.org/api/http.html#http_class_http_incomingmessage)\n from the node `http` module.\n@@ -112,10 +111,10 @@\n });\n ```\n \n-Koa provides a `Response` object as the `response` property of the `Context`.  \n+Koa provides a `Response` object as the `response` property of the `Context`.\n Koa's `Response` object provides helpful methods for working with\n http responses which delegate to a [ServerResponse](https://nodejs.org/api/http.html#http_class_http_serverresponse)\n-.  \n+.\n \n Koa's pattern of delegating to Node's request and response objects rather than extending them\n provides a cleaner interface and reduces conflicts between different middleware and with Node\n",
					"match": false,
					"packageHash": "634327be794ebe45969fb1299bc1d4175cff96f4342c5c2a604fc565a7d3f832",
					"size": 17224,
					"sourceHash": "329c6cc2f798c5cc96a6761fe106583ae78c1c65d3568f27baa3e0a8694f1bfb",
					"status": "content"
				},
				"lib/application.js": {
					"diff": "--- published/lib/application.js\n+++ rebuilt/lib/application.js\n@@ -3,22 +3,24 @@\n /**\n  * Module dependencies.\n  */\n+const util = require('node:util')\n+const debug = util.debuglog('koa:application')\n+const Emitter = require('node:events')\n+const Stream = require('node:stream')\n+const http = require('node:http')\n+const { AsyncLocalStorage } = require('node:async_hooks')\n \n-const debug = require('debug')('koa:application')\n-const assert = require('assert')\n const onFinished = require('on-finished')\n-const response = require('./response')\n const compose = require('koa-compose')\n-const context = require('./context')\n-const request = require('./request')\n const statuses = require('statuses')\n-const Emitter = require('events')\n-const util = require('util')\n-const Stream = require('stream')\n-const http = require('http')\n-const only = require('./only.js')\n const { HttpError } = require('http-errors')\n \n+const request = require('./request')\n+const response = require('./response')\n+const context = require('./context')\n+const isStream = require('./is-stream.js')\n+const only = require('./only.js')\n+\n /** @typedef {typeof import ('./context') & {\n  *  app: Application\n  *  req: import('http').IncomingMessage\n@@ -46,18 +48,18 @@\n    */\n \n   /**\n-    *\n-    * @param {object} [options] Application options\n-    * @param {string} [options.env='development'] Environment\n-    * @param {string[]} [options.keys] Signed cookie keys\n-    * @param {boolean} [options.proxy] Trust proxy headers\n-    * @param {number} [options.subdomainOffset] Subdomain offset\n-    * @param {string} [options.proxyIpHeader] Proxy IP header, defaults to X-Forwarded-For\n-    * @param {number} [options.maxIpsCount] Max IPs read from proxy IP header, default to 0 (means infinity)\n-    * @param {function} [options.compose] Function to handle middleware composition\n-    * @param {boolean} [options.asyncLocalStorage] Max IPs read from proxy IP header, default to 0 (means infinity)\n-    *\n-    */\n+   *\n+   * @param {object} [options] Application options\n+   * @param {string} [options.env='development'] Environment\n+   * @param {string[]} [options.keys] Signed cookie keys\n+   * @param {boolean} [options.proxy] Trust proxy headers\n+   * @param {number} [options.subdomainOffset] Subdomain offset\n+   * @param {string} [options.proxyIpHeader] Proxy IP header, defaults to X-Forwarded-For\n+   * @param {number} [options.maxIpsCount] Max IPs read from proxy IP header, default to 0 (means infinity)\n+   * @param {function} [options.compose] Function to handle middleware composition\n+   * @param {boolean} [options.asyncLocalStorage] Enable AsyncLocalStorage, default to false\n+   *\n+   */\n \n   constructor (options) {\n     super()\n@@ -79,9 +81,11 @@\n       this[util.inspect.custom] = this.inspect\n     }\n     if (options.asyncLocalStorage) {\n-      const { AsyncLocalStorage } = require('async_hooks')\n-      assert(AsyncLocalStorage, 'Requires node 12.17.0 or higher to enable asyncLocalStorage')\n-      this.ctxStorage = new AsyncLocalStorage()\n+      if (options.asyncLocalStorage instanceof AsyncLocalStorage) {\n+        this.ctxStorage = options.asyncLocalStorage\n+      } else {\n+        this.ctxStorage = new AsyncLocalStorage()\n+      }\n     }\n   }\n \n@@ -110,11 +114,7 @@\n    */\n \n   toJSON () {\n-    return only(this, [\n-      'subdomainOffset',\n-      'proxy',\n-      'env'\n-    ])\n+    return only(this, ['subdomainOffset', 'proxy', 'env'])\n   }\n \n   /**\n@@ -139,7 +139,7 @@\n    */\n \n   use (fn) {\n",
					"match": false,
					"packageHash": "d34f7a03f85bfa1e6249fc68c7f0495190c92a49b972ecc8aea15a2f3ebb057a",
					"size": 8454,
					"sourceHash": "148c9d70309869d8e8f1256aa2a95b0138974071a1c6aa046e3c5305e0c9d8a6",
					"status": "content"
				},
				"lib/context.js": {
					"diff": "--- published/lib/context.js\n+++ rebuilt/lib/context.js\n@@ -150,9 +150,6 @@\n \n     let statusCode = err.status || err.statusCode\n \n-    // ENOENT support\n-    if (err.code === 'ENOENT') statusCode = 404\n-\n     // default to 500\n     if (typeof statusCode !== 'number' || !statuses.message[statusCode]) statusCode = 500\n \n",
					"match": false,
					"packageHash": "bcc2731f0b36981086a704202059115de801433fc9724d961019055e00f02d3c",
					"size": 5582,
					"sourceHash": "b45d1961d1cbd7a6460ad4a5e268ac1ecc78a14690696f6942ce3630822032fe",
					"status": "content"
				},
				"lib/request.js": {
					"diff": "--- published/lib/request.js\n+++ rebuilt/lib/request.js\n@@ -89,14 +89,14 @@\n   },\n \n   /**\n-   * Get origin of URL.\n+   * Get the origin header.\n    *\n    * @return {String}\n    * @api public\n    */\n \n   get origin () {\n-    return `${this.protocol}://${this.host}`\n+    return this.req.headers.origin || null\n   },\n \n   /**\n@@ -109,7 +109,7 @@\n   get href () {\n     // support: `GET http://example.com/foo`\n     if (/^https?:\\/\\//i.test(this.originalUrl)) return this.originalUrl\n-    return this.origin + this.originalUrl\n+    return this.protocol + '://' + this.host + this.originalUrl\n   },\n \n   /**\n@@ -288,7 +288,7 @@\n     if (!this.memoizedURL) {\n       const originalUrl = this.originalUrl || '' // avoid undefined in template string\n       try {\n-        this.memoizedURL = new URL(`${this.origin}${originalUrl}`)\n+        this.memoizedURL = new URL(`${this.protocol}://${this.host}${originalUrl}`)\n       } catch (err) {\n         this.memoizedURL = Object.create(null)\n       }\n@@ -732,6 +732,6 @@\n  * @param {number} [limit] - The maximum number of values to return.\n  * @returns {string[]} An array of values from the comma-separated string.\n  */\n-function splitCommaSeparatedValues(value, limit) {\n-  return value.split(',', limit).map(v => v.trim());\n+function splitCommaSeparatedValues (value, limit) {\n+  return value.split(',', limit).map(v => v.trim())\n }\n",
					"match": false,
					"packageHash": "7dbba649af21318cf6edf9d64993de49961909131fef01b155893a4ded4e95ff",
					"size": 14916,
					"sourceHash": "0ba20780fb1669544a10525bd7376d50f46f94886c91330a899e2e0187f63ada",
					"status": "content"
				},
				"lib/response.js": {
					"diff": "--- published/lib/response.js\n+++ rebuilt/lib/response.js\n@@ -4,21 +4,22 @@\n  * Module dependencies.\n  */\n \n+const assert = require('node:assert')\n+const extname = require('node:path').extname\n+const util = require('node:util')\n+\n const contentDisposition = require('content-disposition')\n-const getType = require('cache-content-type')\n const onFinish = require('on-finished')\n const escape = require('escape-html')\n const typeis = require('type-is').is\n const statuses = require('statuses')\n const destroy = require('destroy')\n-const assert = require('assert')\n-const extname = require('path').extname\n+const encodeUrl = require('encodeurl')\n const vary = require('vary')\n+const getType = require('mime-types').contentType\n+\n+const isStream = require('./is-stream.js')\n const only = require('./only.js')\n-const util = require('util')\n-const encodeUrl = require('encodeurl')\n-const Stream = require('stream')\n-const deprecate = require('depd')('koa')\n \n /**\n  * Prototype.\n@@ -134,6 +135,17 @@\n   set body (val) {\n     const original = this._body\n     this._body = val\n+\n+    const cleanupPreviousStream = () => {\n+      if (original && isStream(original)) {\n+        original.once('error', () => {})\n+        // Only destroy if the new value is not a stream\n+        if (!isStream(val)) {\n+          destroy(original)\n+        }\n+      }\n+    }\n+\n     // no content\n \n     if (val == null) {\n@@ -148,6 +160,7 @@\n       this.remove('Content-Type')\n       this.remove('Content-Length')\n       this.remove('Transfer-Encoding')\n+      cleanupPreviousStream()\n       return\n     }\n \n@@ -161,6 +174,7 @@\n     if (typeof val === 'string') {\n       if (setType) this.type = /^\\s*</.test(val) ? 'html' : 'text'\n       this.length = Buffer.byteLength(val)\n+      cleanupPreviousStream()\n       return\n     }\n \n@@ -168,16 +182,16 @@\n     if (Buffer.isBuffer(val)) {\n       if (setType) this.type = 'bin'\n       this.length = val.length\n+      cleanupPreviousStream()\n       return\n     }\n \n     // stream\n-    if (val instanceof Stream) {\n+    if (isStream(val)) {\n       onFinish(this.res, destroy.bind(null, val))\n       if (original !== val) {\n-        val.once('error', err => this.ctx.onerror(err))\n-        // overwriting\n         if (original != null) this.remove('Content-Length')\n+        cleanupPreviousStream()\n       }\n \n       if (setType) this.type = 'bin'\n@@ -187,6 +201,7 @@\n     // ReadableStream\n     if (val instanceof ReadableStream) {\n       if (setType) this.type = 'bin'\n+      cleanupPreviousStream()\n       return\n     }\n \n@@ -194,6 +209,7 @@\n     if (val instanceof Blob) {\n       if (setType) this.type = 'bin'\n       this.length = val.size\n+      cleanupPreviousStream()\n       return\n",
					"match": false,
					"packageHash": "aaf1604c9a5112aa6d7cb7628b1f96dc92046a28036764c1e2e32bbf70ad27d4",
					"size": 13559,
					"sourceHash": "2b03a5d9c80d8c436de16da10fbca36f19b7427fa949b48f7d4f856997bddf85",
					"status": "content"
				},
				"package.json": {
					"diff": "--- published/package.json\n+++ rebuilt/package.json\n@@ -1,9 +1,6 @@\n {\n   \"name\": \"koa\",\n-  \"version\": \"3.0.0-alpha.3\",\n-  \"publishConfig\": {\n-    \"tag\": \"experimental\"\n-  },\n+  \"version\": \"3.1.1\",\n   \"description\": \"Koa web app framework\",\n   \"main\": \"lib/application.js\",\n   \"exports\": {\n@@ -19,8 +16,9 @@\n   },\n   \"scripts\": {\n     \"test\": \"node --test\",\n-    \"test:coverage\": \"node --test --experimental-test-coverage\",\n+    \"test:coverage\": \"c8 --reporter=lcov --reporter=text-summary node --test\",\n     \"lint\": \"standard\",\n+    \"lint:fix\": \"standard --fix\",\n     \"lint:pretty\": \"standard | snazzy\",\n     \"authors\": \"git log --format='%aN <%aE>' | sort -u > AUTHORS\",\n     \"build\": \"gen-esm-wrapper . ./dist/koa.mjs\",\n@@ -38,31 +36,31 @@\n   ],\n   \"license\": \"MIT\",\n   \"dependencies\": {\n-    \"accepts\": \"^1.3.5\",\n-    \"cache-content-type\": \"^1.0.0\",\n-    \"content-disposition\": \"~0.5.2\",\n-    \"content-type\": \"^1.0.4\",\n+    \"accepts\": \"^1.3.8\",\n+    \"content-disposition\": \"~0.5.4\",\n+    \"content-type\": \"^1.0.5\",\n     \"cookies\": \"~0.9.1\",\n-    \"debug\": \"^4.3.2\",\n     \"delegates\": \"^1.0.0\",\n-    \"destroy\": \"^1.0.4\",\n+    \"destroy\": \"^1.2.0\",\n     \"encodeurl\": \"^2.0.0\",\n     \"escape-html\": \"^1.0.3\",\n     \"fresh\": \"~0.5.2\",\n-    \"http-assert\": \"^1.3.0\",\n+    \"http-assert\": \"^1.5.0\",\n     \"http-errors\": \"^2.0.0\",\n     \"koa-compose\": \"^4.1.0\",\n-    \"on-finished\": \"^2.3.0\",\n-    \"parseurl\": \"^1.3.2\",\n+    \"mime-types\": \"^3.0.1\",\n+    \"on-finished\": \"^2.4.1\",\n+    \"parseurl\": \"^1.3.3\",\n     \"statuses\": \"^2.0.1\",\n-    \"type-is\": \"^1.6.16\",\n+    \"type-is\": \"^2.0.1\",\n     \"vary\": \"^1.1.2\"\n   },\n   \"devDependencies\": {\n-    \"gen-esm-wrapper\": \"^1.0.6\",\n+    \"c8\": \"^10.1.3\",\n+    \"gen-esm-wrapper\": \"^1.1.3\",\n     \"snazzy\": \"^9.0.0\",\n-    \"standard\": \"^17.1.0\",\n-    \"supertest\": \"^7.0.0\"\n+    \"standard\": \"^17.1.2\",\n+    \"supertest\": \"^7.1.1\"\n   },\n   \"engines\": {\n     \"node\": \">= 18\"\n@@ -70,5 +68,6 @@\n   \"files\": [\n     \"dist\",\n     \"lib\"\n-  ]\n+  ],\n+  \"homepage\": \"https://koajs.com\"\n }\n",
					"match": false,
					"packageHash": "515f118c99d50219557d17caa0cb29c6db2e16be878acb006239cf92debb33bd",
					"size": 1699,
					"sourceHash": "39075751293967a94e004c83465d41287733b9d50f877a11ddca1c1cd3631cb1",
					"status": "content"
				},
				"lib/is-stream.js": {
					"match": false,
					"status": "missing-in-package"
				}
			},
			"summary": {
				"differentFiles": 6,
				"matchingFiles": 4,
				"missingInPackage": 1,
				"missingInSource": 0,
				"score": 0.36363636363636365,
				"totalFiles": 11
			}
		}
	}
]
