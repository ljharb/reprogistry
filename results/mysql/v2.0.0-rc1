[
	{
		"reproduceVersion": "0.0.0-local",
		"timestamp": "2025-12-31T08:39:29.393Z",
		"os": "linux",
		"arch": "x64",
		"strategy": "npm:11.7.0",
		"reproduced": false,
		"attested": false,
		"package": {
			"spec": "mysql@2.0.0-rc1",
			"name": "mysql",
			"version": "2.0.0-rc1",
			"location": "https://registry.npmjs.org/mysql/-/mysql-2.0.0-rc1.tgz",
			"integrity": "sha512-splUg9Aa/dzUJoWS7Rse0fgSVVSaV63BmxPmg/b1UJf7BWVon5BlSrJZM07IpiVwmjaEeX41pvoAyoJD+I4ZVA==",
			"publishedAt": "2013-11-30T10:19:02.504Z",
			"publishedWith": {
				"node": null,
				"npm": "1.2.21"
			}
		},
		"source": {
			"integrity": null,
			"location": "https://github.com/felixge/node-mysql",
			"spec": "github:felixge/node-mysql#HEAD"
		},
		"comparisonHash": "8a2a8dcbb729bf3ee9216e490c955701f0ddebe1",
		"diff": {
			"files": {
				"..gitignore.un~": {
					"match": false,
					"packageHash": "b37f949e34d8a2a6a47b6a0643bfa4a330d67ccc6406902a58d8a6aad10ed176",
					"size": 541,
					"status": "missing-in-source"
				},
				"..travis.yml.un~": {
					"match": false,
					"packageHash": "6a358c16bfcf00bbbacbb9e3acaa5a75765d00f87f77e6cf47a4b81d720a0a75",
					"size": 956,
					"status": "missing-in-source"
				},
				".Changelog.md.un~": {
					"match": false,
					"packageHash": "27a11a01ffe25f974e1e9303519904d4255158f63950240fd63bccfb9c37e727",
					"size": 5700,
					"status": "missing-in-source"
				},
				".Changes.md.un~": {
					"match": false,
					"packageHash": "e6ee68e604a021ccb6fc9e8442c5dafebf9b20a1da49956c67521061b278ace7",
					"size": 13594,
					"status": "missing-in-source"
				},
				".License.un~": {
					"match": false,
					"packageHash": "15286d9de4e8725284052ed10af9bef5cc2d28ec230f512e306be3922273ca79",
					"size": 1129,
					"status": "missing-in-source"
				},
				".Makefile.un~": {
					"match": false,
					"packageHash": "26aee2101ebf4ad3ab62cdaa30ea0111a3045f84baf0072ec1899691c7f1f9b1",
					"size": 965,
					"status": "missing-in-source"
				},
				".NEWS.md.un~": {
					"match": false,
					"packageHash": "559e928e97c8cdd50eb9dc884b3a7c8e89d49dbf2dcd950c140e5bf34a7db207",
					"size": 4330,
					"status": "missing-in-source"
				},
				".NEWS.un~": {
					"match": false,
					"packageHash": "708aa148540fcbb0ccf07f41ad271c2cda2f0d309fb3976aa0216444768ae975",
					"size": 40772,
					"status": "missing-in-source"
				},
				".NEXT.md.un~": {
					"match": false,
					"packageHash": "a8287a867ddb66fbdf74953ce40bdff8c8e5a54308e84007a8b2d77ca16bd60f",
					"size": 1829,
					"status": "missing-in-source"
				},
				".Readme.md.un~": {
					"match": false,
					"packageHash": "5c0e3ad3950ad84079dfc9c45dd23c922984f49eeec5d087cccbfecbba665146",
					"size": 4726,
					"status": "missing-in-source"
				},
				".Upgrading.md.un~": {
					"match": false,
					"packageHash": "d9807e42d52826fa0d8b3985788918d6064db334060d19e9aac97110dd5488ad",
					"size": 26161,
					"status": "missing-in-source"
				},
				".alone.js.un~": {
					"match": false,
					"packageHash": "491a7ae8a6047f4691aa9380d15b51642bc7648a4ed6de01818086372c502950",
					"size": 83814,
					"status": "missing-in-source"
				},
				".benchmark.js.un~": {
					"match": false,
					"packageHash": "3acc4218bffb09ebe64ece7f0baa180057b5516addb77767f80e3f8c93cdb436",
					"size": 1017,
					"status": "missing-in-source"
				},
				".example.js.un~": {
					"match": false,
					"packageHash": "057cfdf46ba1b29ec89fad1759a525a6f641d7c0195c0f50c9cb769b6d88ce04",
					"size": 40971,
					"status": "missing-in-source"
				},
				".failover.js.un~": {
					"match": false,
					"packageHash": "5ab4b83a195dc7f8aeb7086418b8a62191ed1a012905cab654bc98f83ee1ab92",
					"size": 27245,
					"status": "missing-in-source"
				},
				".foo.js.un~": {
					"match": false,
					"packageHash": "736bbf2a7ec9df810568b08ef1f6209e50597550684b3495cb7677cf904c73e0",
					"size": 523,
					"status": "missing-in-source"
				},
				".index.js.un~": {
					"match": false,
					"packageHash": "f752a0b926b5ef2bbfa4a3f27f02dd839ee672ed3f3d06e5d558246c597e36e1",
					"size": 8694,
					"status": "missing-in-source"
				},
				".leak.js.un~": {
					"match": false,
					"packageHash": "86fa525c9d0a6b9029ef81d2122871f2587486cf5567f5671ede360cc4e31b92",
					"size": 41781,
					"status": "missing-in-source"
				},
				".npmignore": {
					"match": false,
					"packageHash": "1c1f85254eebbca7e476372b5aebab3b3e6c9699e3e1abc6199ba71edf537ee3",
					"size": 15,
					"status": "missing-in-source"
				},
				".package.json.un~": {
					"match": false,
					"packageHash": "3cf034493b9ea259936f4c11aef4b6a51b50212d74a67646e5aff66f5dc4f901",
					"size": 6350,
					"status": "missing-in-source"
				},
				".server.js.un~": {
					"match": false,
					"packageHash": "99a4f6d5649749048b1ca333518e6045a10d4ff558d7438072e009bb37317d1f",
					"size": 13991,
					"status": "missing-in-source"
				},
				".sphinx.conf.un~": {
					"match": false,
					"packageHash": "e75ddabc84dd6e5451e006faa1625cdd345d499aa7e372754677ca78e4f13cb0",
					"size": 2452,
					"status": "missing-in-source"
				},
				".test.js.un~": {
					"match": false,
					"packageHash": "f3eecfbeca50db46f858ebce48dca3403d7ccb39128965a1aa4713efca5931af",
					"size": 44569,
					"status": "missing-in-source"
				},
				".travis.yml": {
					"match": false,
					"packageHash": "5bffdd97e3ab5421cba12460eac458bc0811e6cd83ef13125342280244a21fdc",
					"size": 236,
					"status": "missing-in-source"
				},
				"Changes.md": {
					"diff": "--- published/Changes.md\n+++ rebuilt/Changes.md\n@@ -4,6 +4,348 @@\n to add your changes here when sending pull requests. Also send corrections if\n you spot any mistakes.\n \n+## HEAD\n+\n+* Accept the `maxVersion` and `minVersion` properties in connection `ssl` option #2301 #2304\n+* Support Node.js 14.x\n+* Support Node.js 15.x\n+* Support Node.js 16.x\n+* Support Node.js 17.x\n+* Update `bignumber.js` to 9.0.2\n+* Update `safe-buffer` to 5.2.1\n+* Update `sqlstring` to 2.3.3\n+  - Fix escaping `Date` objects from foreign isolates\n+  - perf: remove outdated array pattern\n+\n+## v2.18.1 (2020-01-23)\n+\n+* Fix Amazon RDS profile for yaSSL MySQL servers with 2019 CA #2292\n+\n+## v2.18.0 (2020-01-21)\n+\n+* Add `localInfile` option to control `LOAD DATA LOCAL INFILE`\n+* Add new Amazon RDS Root 2019 CA to Amazon RDS SSL profile #2280\n+* Add new error codes up to MySQL 5.7.29\n+* Fix early detection of bad callback to `connection.query`\n+* Support Node.js 12.x #2211\n+* Support Node.js 13.x\n+* Support non-enumerable properties in object argument to `connection.query` #2253\n+* Update `bignumber.js` to 9.0.0\n+* Update `readable-stream` to 2.3.7\n+\n+## v2.17.1 (2019-04-18)\n+\n+* Update `bignumber.js` to 7.2.1 #2206\n+  - Fix npm deprecation warning\n+\n+## v2.17.0 (2019-04-17)\n+\n+* Add reverse type lookup for small performance gain #2170\n+* Fix `connection.threadId` missing on handshake failure\n+* Fix duplicate packet name in debug output\n+* Fix no password support for old password protocol\n+* Remove special case for handshake in determine packet code\n+* Small performance improvement starting command sequence\n+* Support auth switch in change user flow #1776\n+* Support Node.js 11.x\n+* Update `bignumber.js` to 6.0.0\n+\n+## v2.16.0 (2018-07-17)\n+\n+* Add Amazon RDS GovCloud SSL certificates #1876\n+* Add new error codes up to MySQL 5.7.21\n+* Include connection ID in debug output\n+* Support Node.js 9.x\n+* Support Node.js 10.x #2003 #2024 #2026 #2034\n+* Update Amazon RDS SSL certificates\n+* Update `bignumber.js` to 4.1.0\n+* Update `readable-stream` to 2.3.6\n+* Update `sqlstring` to 2.3.1\n+  - Fix incorrectly replacing non-placeholders in SQL\n+\n+## v2.15.0 (2017-10-05)\n+\n+* Add new Amazon RDS ca-central-1 certificate CA to Amazon RDS SSL profile #1809\n+* Add new error codes up to MySQL 5.7.19\n+* Add `mysql.raw()` to generate pre-escaped values #877 #1821\n+* Fix \"changedRows\" to work on non-English servers #1819\n+* Fix error when server sends RST on `QUIT` #1811\n+* Fix typo in insecure auth error message\n+* Support `mysql_native_password` auth switch request for Azure #1396 #1729 #1730\n+* Update `sqlstring` to 2.3.0\n+  - Add `.toSqlString()` escape overriding\n+  - Small performance improvement on `escapeId`\n+* Update `bignumber.js` to 4.0.4\n+\n+## v2.14.1 (2017-08-01)\n+\n+* Fix holding first closure for lifetime of connection #1785\n+\n+## v2.14.0 (2017-07-25)\n+\n+* Add new Amazon RDS ap-south-1 certificate CA to Amazon RDS SSL profile #1780\n+* Add new Amazon RDS eu-west-2 certificate CA to Amazon RDS SSL profile #1770\n+* Add `sql` property to query `Error` objects #1462 #1628 #1629\n+* Add `sqlMessage` property to `Error` objects #1714\n+* Fix the MySQL 5.7.17 error codes\n+* Support Node.js 8.x\n+* Update `bignumber.js` to 4.0.2\n+* Update `readable-stream` to 2.3.3\n+* Use `safe-buffer` for improved Buffer API\n+\n+## v2.13.0 (2017-01-24)\n+\n+* Accept regular expression as pool cluster pattern #1572\n+* Accept wildcard anywhere in pool cluster pattern #1570\n+* Add `acquire` and `release` events to `Pool` for tracking #1366 #1449 #1528 #1625\n",
					"match": false,
					"packageHash": "5e027fd0bf045cfb7620ce32c65e92aac753fd9da21a4e2146603961b17a14ae",
					"size": 9319,
					"sourceHash": "72275277fb28b72ed81eea4ce3a59c2a542e2a0686a020410b849e027a73533e",
					"status": "content"
				},
				"Makefile": {
					"match": false,
					"packageHash": "f248cdfb40fbc245396920ebbba4705118b81e93add58cd32c15b245152577e7",
					"size": 38,
					"status": "missing-in-source"
				},
				"NEXT.md": {
					"match": false,
					"packageHash": "968f968398b9df2b1e0ee2f82a321c7ee7f00147f5368e292ebccd8dba0aac80",
					"size": 55,
					"status": "missing-in-source"
				},
				"Readme.md": {
					"diff": "--- published/Readme.md\n+++ rebuilt/Readme.md\n@@ -1,24 +1,95 @@\n-# node-mysql\n+# mysql\n \n-[![Build Status](https://secure.travis-ci.org/felixge/node-mysql.png)](http://travis-ci.org/felixge/node-mysql)\n+[![NPM Version][npm-version-image]][npm-url]\n+[![NPM Downloads][npm-downloads-image]][npm-url]\n+[![Node.js Version][node-image]][node-url]\n+[![Linux Build][github-actions-ci-image]][github-actions-ci-url]\n+[![Windows Build][appveyor-image]][appveyor-url]\n+[![Test Coverage][coveralls-image]][coveralls-url]\n+\n+## Table of Contents\n+\n+- [Install](#install)\n+- [Introduction](#introduction)\n+- [Contributors](#contributors)\n+- [Sponsors](#sponsors)\n+- [Community](#community)\n+- [Establishing connections](#establishing-connections)\n+- [Connection options](#connection-options)\n+  - [SSL options](#ssl-options)\n+  - [Connection flags](#connection-flags)\n+- [Terminating connections](#terminating-connections)\n+- [Pooling connections](#pooling-connections)\n+- [Pool options](#pool-options)\n+- [Pool events](#pool-events)\n+  - [acquire](#acquire)\n+  - [connection](#connection)\n+  - [enqueue](#enqueue)\n+  - [release](#release)\n+- [Closing all the connections in a pool](#closing-all-the-connections-in-a-pool)\n+- [PoolCluster](#poolcluster)\n+  - [PoolCluster options](#poolcluster-options)\n+- [Switching users and altering connection state](#switching-users-and-altering-connection-state)\n+- [Server disconnects](#server-disconnects)\n+- [Performing queries](#performing-queries)\n+- [Escaping query values](#escaping-query-values)\n+- [Escaping query identifiers](#escaping-query-identifiers)\n+  - [Preparing Queries](#preparing-queries)\n+  - [Custom format](#custom-format)\n+- [Getting the id of an inserted row](#getting-the-id-of-an-inserted-row)\n+- [Getting the number of affected rows](#getting-the-number-of-affected-rows)\n+- [Getting the number of changed rows](#getting-the-number-of-changed-rows)\n+- [Getting the connection ID](#getting-the-connection-id)\n+- [Executing queries in parallel](#executing-queries-in-parallel)\n+- [Streaming query rows](#streaming-query-rows)\n+  - [Piping results with Streams](#piping-results-with-streams)\n+- [Multiple statement queries](#multiple-statement-queries)\n+- [Stored procedures](#stored-procedures)\n+- [Joins with overlapping column names](#joins-with-overlapping-column-names)\n+- [Transactions](#transactions)\n+- [Ping](#ping)\n+- [Timeouts](#timeouts)\n+- [Error handling](#error-handling)\n+- [Exception Safety](#exception-safety)\n+- [Type casting](#type-casting)\n+  - [Number](#number)\n+  - [Date](#date)\n+  - [Buffer](#buffer)\n+  - [String](#string)\n+  - [Custom type casting](#custom-type-casting)\n+- [Debugging and reporting problems](#debugging-and-reporting-problems)\n+- [Security issues](#security-issues)\n+- [Contributing](#contributing)\n+- [Running tests](#running-tests)\n+  - [Running unit tests](#running-unit-tests)\n+  - [Running integration tests](#running-integration-tests)\n+- [Todo](#todo)\n \n ## Install\n \n-```bash\n-npm install mysql@2.0.0-alpha9\n+This is a [Node.js](https://nodejs.org/en/) module available through the\n+[npm registry](https://www.npmjs.com/).\n+\n+Before installing, [download and install Node.js](https://nodejs.org/en/download/).\n+Node.js 0.6 or higher is required.\n+\n+Installation is done using the\n+[`npm install` command](https://docs.npmjs.com/getting-started/installing-npm-packages-locally):\n+\n+```sh\n+$ npm install mysql\n ```\n \n-Despite the alpha tag, this is the recommended version for new applications.\n For information about the previous 0.9.x releases, visit the [v0.9 branch][].\n \n Sometimes I may also ask you to install the latest version from Github to check\n if a bugfix is working. In this case, please do:\n \n-```\n-npm install felixge/node-mysql\n+```sh\n+$ npm install mysqljs/mysql\n ```\n",
					"match": false,
					"packageHash": "6b0c60d79184e790346f198e9b7601b091a7edd1453873a77b7133e36fba16df",
					"size": 35263,
					"sourceHash": "64b626dbcb667927494caf45bb2a134327a94988d077b5a0aad7251f4701a660",
					"status": "content"
				},
				"alone.js": {
					"match": false,
					"packageHash": "e53f4b0aa2d20291701f6a86d1820a6aa6f5a6ab64ee6725639a5e7063adcaec",
					"size": 946,
					"status": "missing-in-source"
				},
				"index.js": {
					"diff": "--- published/index.js\n+++ rebuilt/index.js\n@@ -1,26 +1,161 @@\n-var Connection       = require('./lib/Connection');\n-var ConnectionConfig = require('./lib/ConnectionConfig');\n-var Types            = require('./lib/protocol/constants/types');\n-var SqlString        = require('./lib/protocol/SqlString');\n-var Pool             = require('./lib/Pool');\n-var PoolConfig       = require('./lib/PoolConfig');\n-var PoolCluster      = require('./lib/PoolCluster');\n+var Classes = Object.create(null);\n+\n+/**\n+ * Create a new Connection instance.\n+ * @param {object|string} config Configuration or connection string for new MySQL connection\n+ * @return {Connection} A new MySQL connection\n+ * @public\n+ */\n+exports.createConnection = function createConnection(config) {\n+  var Connection       = loadClass('Connection');\n+  var ConnectionConfig = loadClass('ConnectionConfig');\n \n-exports.createConnection = function(config) {\n   return new Connection({config: new ConnectionConfig(config)});\n };\n \n-exports.createPool = function(config) {\n+/**\n+ * Create a new Pool instance.\n+ * @param {object|string} config Configuration or connection string for new MySQL connections\n+ * @return {Pool} A new MySQL pool\n+ * @public\n+ */\n+exports.createPool = function createPool(config) {\n+  var Pool       = loadClass('Pool');\n+  var PoolConfig = loadClass('PoolConfig');\n+\n   return new Pool({config: new PoolConfig(config)});\n };\n \n-exports.createPoolCluster = function(config) {\n+/**\n+ * Create a new PoolCluster instance.\n+ * @param {object} [config] Configuration for pool cluster\n+ * @return {PoolCluster} New MySQL pool cluster\n+ * @public\n+ */\n+exports.createPoolCluster = function createPoolCluster(config) {\n+  var PoolCluster = loadClass('PoolCluster');\n+\n   return new PoolCluster(config);\n };\n \n-exports.createQuery = Connection.createQuery;\n+/**\n+ * Create a new Query instance.\n+ * @param {string} sql The SQL for the query\n+ * @param {array} [values] Any values to insert into placeholders in sql\n+ * @param {function} [callback] The callback to use when query is complete\n+ * @return {Query} New query object\n+ * @public\n+ */\n+exports.createQuery = function createQuery(sql, values, callback) {\n+  var Connection = loadClass('Connection');\n+\n+  return Connection.createQuery(sql, values, callback);\n+};\n+\n+/**\n+ * Escape a value for SQL.\n+ * @param {*} value The value to escape\n+ * @param {boolean} [stringifyObjects=false] Setting if objects should be stringified\n+ * @param {string} [timeZone=local] Setting for time zone to use for Date conversion\n+ * @return {string} Escaped string value\n+ * @public\n+ */\n+exports.escape = function escape(value, stringifyObjects, timeZone) {\n+  var SqlString = loadClass('SqlString');\n+\n+  return SqlString.escape(value, stringifyObjects, timeZone);\n+};\n+\n+/**\n+ * Escape an identifier for SQL.\n+ * @param {*} value The value to escape\n+ * @param {boolean} [forbidQualified=false] Setting to treat '.' as part of identifier\n+ * @return {string} Escaped string value\n+ * @public\n+ */\n+exports.escapeId = function escapeId(value, forbidQualified) {\n+  var SqlString = loadClass('SqlString');\n+\n+  return SqlString.escapeId(value, forbidQualified);\n+};\n+\n+/**\n+ * Format SQL and replacement values into a SQL string.\n+ * @param {string} sql The SQL for the query\n+ * @param {array} [values] Any values to insert into placeholders in sql\n+ * @param {boolean} [stringifyObjects=false] Setting if objects should be stringified\n",
					"match": false,
					"packageHash": "58c713de5b1f5469590e7bb080a72abd45e79c475f89056b22fd4aa44e2f6ae3",
					"size": 871,
					"sourceHash": "dd9bb6de0e8e298be4909e9e91b359f41b4e72a888cf7d5fc6b75a69e9531d9e",
					"status": "content"
				},
				"leak.js": {
					"match": false,
					"packageHash": "3ba7f8dfb1eae130a737420f2be8c3b5796a5d4a56689d29171090106d2d4132",
					"size": 591,
					"status": "missing-in-source"
				},
				"lib/.Config.js.un~": {
					"match": false,
					"packageHash": "1a7f9088d20cb221e09b7b754c5fac3e3da4f3851bd0286ed29c09a13b582629",
					"size": 7323,
					"status": "missing-in-source"
				},
				"lib/.Connection.js.un~": {
					"match": false,
					"packageHash": "6e0613ea1c54cac07881f8acbf5b8d5718744acd1cc46bf70f7f971981cf02b5",
					"size": 2888,
					"status": "missing-in-source"
				},
				"lib/.ConnectionConfig.js.un~": {
					"match": false,
					"packageHash": "552c4726d5ec017bc4fdc45a21905f8f3ba4ee00485c51a24f497f174dc16175",
					"size": 3336,
					"status": "missing-in-source"
				},
				"lib/.Pool.js.un~": {
					"match": false,
					"packageHash": "fa13ee0f03da73aacc067ba695a1b79b3e7e8ecabfe45ca6c478a97be1d8af52",
					"size": 148040,
					"status": "missing-in-source"
				},
				"lib/.PoolConfig.js.un~": {
					"match": false,
					"packageHash": "c76848eee2071b53795cc1fa08b2816555d9c4fecddde9be34f10ca4c5d4384f",
					"size": 14334,
					"status": "missing-in-source"
				},
				"lib/.Server.js.un~": {
					"match": false,
					"packageHash": "2af5ecb1f69ae166f95bd49ec3a2471bcd4a2d45d1e98000e1b2da9fcc136561",
					"size": 59879,
					"status": "missing-in-source"
				},
				"lib/.ServerConfig.js.un~": {
					"match": false,
					"packageHash": "a8e61b3acde4f8b42be90a6a7aac97655af6ce571d49844ba3c3c154e6b85caa",
					"size": 6346,
					"status": "missing-in-source"
				},
				"lib/.ServerConnection.js.un~": {
					"match": false,
					"packageHash": "05141a5ddd2ee9dc895f880e6f5650578962a0196973961201f1c77bfe4fcdeb",
					"size": 430358,
					"status": "missing-in-source"
				},
				"lib/Connection.js": {
					"diff": "--- published/lib/Connection.js\n+++ rebuilt/lib/Connection.js\n@@ -1,162 +1,246 @@\n+var Crypto           = require('crypto');\n+var Events           = require('events');\n var Net              = require('net');\n+var tls              = require('tls');\n var ConnectionConfig = require('./ConnectionConfig');\n var Protocol         = require('./protocol/Protocol');\n var SqlString        = require('./protocol/SqlString');\n var Query            = require('./protocol/sequences/Query');\n-var EventEmitter     = require('events').EventEmitter;\n var Util             = require('util');\n \n module.exports = Connection;\n-Util.inherits(Connection, EventEmitter);\n+Util.inherits(Connection, Events.EventEmitter);\n function Connection(options) {\n-  EventEmitter.call(this);\n+  Events.EventEmitter.call(this);\n \n   this.config = options.config;\n \n   this._socket        = options.socket;\n   this._protocol      = new Protocol({config: this.config, connection: this});\n   this._connectCalled = false;\n-  this.state          = \"disconnected\";\n+  this.state          = 'disconnected';\n+  this.threadId       = null;\n }\n \n-Connection.createQuery = function(sql, values, cb) {\n+Connection.createQuery = function createQuery(sql, values, callback) {\n   if (sql instanceof Query) {\n     return sql;\n   }\n \n+  var cb      = callback;\n   var options = {};\n \n-  if (typeof sql === 'object') {\n-    // query(options, cb)\n-    options = sql;\n+  if (typeof sql === 'function') {\n+    cb = sql;\n+  } else if (typeof sql === 'object') {\n+    options = Object.create(sql);\n+\n     if (typeof values === 'function') {\n       cb = values;\n-    } else {\n-      options.values = values;\n+    } else if (values !== undefined) {\n+      Object.defineProperty(options, 'values', { value: values });\n     }\n-  } else if (typeof values === 'function') {\n-    // query(sql, cb)\n-    cb             = values;\n-    options.sql    = sql;\n-    options.values = undefined;\n   } else {\n-    // query(sql, values, cb)\n-    options.sql    = sql;\n-    options.values = values;\n+    options.sql = sql;\n+\n+    if (typeof values === 'function') {\n+      cb = values;\n+    } else if (values !== undefined) {\n+      options.values = values;\n+    }\n+  }\n+\n+  if (cb !== undefined) {\n+    cb = wrapCallbackInDomain(null, cb);\n+\n+    if (cb === undefined) {\n+      throw new TypeError('argument callback must be a function when provided');\n+    }\n   }\n+\n   return new Query(options, cb);\n };\n \n-Connection.prototype.connect = function(cb) {\n+Connection.prototype.connect = function connect(options, callback) {\n+  if (!callback && typeof options === 'function') {\n+    callback = options;\n+    options = {};\n+  }\n+\n   if (!this._connectCalled) {\n     this._connectCalled = true;\n \n     // Connect either via a UNIX domain socket or a TCP socket.\n     this._socket = (this.config.socketPath)\n       ? Net.createConnection(this.config.socketPath)\n-      : Net.createConnection(this.config);\n+      : Net.createConnection(this.config.port, this.config.host);\n \n",
					"match": false,
					"packageHash": "47b1233cd48b9825906b16a99142f809186a2ef6d719de8211e22661fcf561b3",
					"size": 5714,
					"sourceHash": "6e6b5ae07db1c8ac4e5204415380544a1eee95cbba44cc8f633ff5fcc2d5b742",
					"status": "content"
				},
				"lib/ConnectionConfig.js": {
					"diff": "--- published/lib/ConnectionConfig.js\n+++ rebuilt/lib/ConnectionConfig.js\n@@ -1,6 +1,7 @@\n var urlParse        = require('url').parse;\n var ClientConstants = require('./protocol/constants/client');\n var Charsets        = require('./protocol/constants/charsets');\n+var SSLProfiles     = null;\n \n module.exports = ConnectionConfig;\n function ConnectionConfig(options) {\n@@ -15,74 +16,164 @@\n   this.user               = options.user || undefined;\n   this.password           = options.password || undefined;\n   this.database           = options.database;\n+  this.connectTimeout     = (options.connectTimeout === undefined)\n+    ? (10 * 1000)\n+    : options.connectTimeout;\n   this.insecureAuth       = options.insecureAuth || false;\n   this.supportBigNumbers  = options.supportBigNumbers || false;\n   this.bigNumberStrings   = options.bigNumberStrings || false;\n   this.dateStrings        = options.dateStrings || false;\n   this.debug              = options.debug;\n+  this.trace              = options.trace !== false;\n   this.stringifyObjects   = options.stringifyObjects || false;\n   this.timezone           = options.timezone || 'local';\n   this.flags              = options.flags || '';\n   this.queryFormat        = options.queryFormat;\n   this.pool               = options.pool || undefined;\n-  this.multipleStatements = options.multipleStatements || false; \n+  this.ssl                = (typeof options.ssl === 'string')\n+    ? ConnectionConfig.getSSLProfile(options.ssl)\n+    : (options.ssl || false);\n+  this.localInfile        = (options.localInfile === undefined)\n+    ? true\n+    : options.localInfile;\n+  this.multipleStatements = options.multipleStatements || false;\n   this.typeCast           = (options.typeCast === undefined)\n     ? true\n     : options.typeCast;\n \n-  if (this.timezone[0] == \" \") {\n+  if (this.timezone[0] === ' ') {\n     // \"+\" is a url encoded char for space so it\n     // gets translated to space when giving a\n     // connection string..\n-    this.timezone = \"+\" + this.timezone.substr(1);\n+    this.timezone = '+' + this.timezone.substr(1);\n+  }\n+\n+  if (this.ssl) {\n+    // Default rejectUnauthorized to true\n+    this.ssl.rejectUnauthorized = this.ssl.rejectUnauthorized !== false;\n   }\n \n   this.maxPacketSize = 0;\n   this.charsetNumber = (options.charset)\n     ? ConnectionConfig.getCharsetNumber(options.charset)\n-    : options.charsetNumber||Charsets.UTF8_GENERAL_CI;\n+    : options.charsetNumber || Charsets.UTF8_GENERAL_CI;\n \n-  this.clientFlags = ConnectionConfig.mergeFlags(ConnectionConfig.getDefaultFlags(options),\n-                                                 options.flags || '');\n+  // Set the client flags\n+  var defaultFlags = ConnectionConfig.getDefaultFlags(options);\n+  this.clientFlags = ConnectionConfig.mergeFlags(defaultFlags, options.flags);\n }\n \n-ConnectionConfig.mergeFlags = function(default_flags, user_flags) {\n-  var flags = 0x0, i;\n-\n-  user_flags = (user_flags || '').toUpperCase().split(/\\s*,+\\s*/);\n+ConnectionConfig.mergeFlags = function mergeFlags(defaultFlags, userFlags) {\n+  var allFlags = ConnectionConfig.parseFlagList(defaultFlags);\n+  var newFlags = ConnectionConfig.parseFlagList(userFlags);\n+\n+  // Merge the new flags\n+  for (var flag in newFlags) {\n+    if (allFlags[flag] !== false) {\n+      allFlags[flag] = newFlags[flag];\n+    }\n+  }\n+\n+  // Build flags\n+  var flags = 0x0;\n+  for (var flag in allFlags) {\n+    if (allFlags[flag]) {\n+      // TODO: Throw here on some future release\n+      flags |= ClientConstants['CLIENT_' + flag] || 0x0;\n+    }\n+  }\n \n-  // add default flags unless \"blacklisted\"\n-  for (i in default_flags) {\n-    if (user_flags.indexOf(\"-\" + default_flags[i]) >= 0) continue;\n+  return flags;\n+};\n \n-    flags |= ClientConstants[\"CLIENT_\" + default_flags[i]] || 0x0;\n-  }\n-  // add user flags unless already already added\n",
					"match": false,
					"packageHash": "9ffe3996192c5aa512b816b399c6b61ed4301cfdf52f3de7ec3782358922f6bf",
					"size": 3859,
					"sourceHash": "8885f1f0e1c11dc90ee160b0f5096617c3d7f7dcd98d4e8c2335fd12f43ade05",
					"status": "content"
				},
				"lib/Pool.js": {
					"diff": "--- published/lib/Pool.js\n+++ rebuilt/lib/Pool.js\n@@ -1,7 +1,7 @@\n-var mysql        = require('../');\n-var Connection   = require('./Connection');\n-var EventEmitter = require('events').EventEmitter;\n-var Util         = require('util');\n+var mysql          = require('../');\n+var Connection     = require('./Connection');\n+var EventEmitter   = require('events').EventEmitter;\n+var Util           = require('util');\n var PoolConnection = require('./PoolConnection');\n \n module.exports = Pool;\n@@ -12,149 +12,283 @@\n   this.config = options.config;\n   this.config.connectionConfig.pool = this;\n \n-  this._allConnections   = [];\n-  this._freeConnections  = [];\n-  this._connectionQueue  = [];\n-  this._closed           = false;\n+  this._acquiringConnections = [];\n+  this._allConnections       = [];\n+  this._freeConnections      = [];\n+  this._connectionQueue      = [];\n+  this._closed               = false;\n }\n \n Pool.prototype.getConnection = function (cb) {\n+\n   if (this._closed) {\n-    return process.nextTick(function(){\n-      return cb(new Error('Pool is closed.'));\n+    var err = new Error('Pool is closed.');\n+    err.code = 'POOL_CLOSED';\n+    process.nextTick(function () {\n+      cb(err);\n     });\n+    return;\n   }\n \n   var connection;\n+  var pool = this;\n \n   if (this._freeConnections.length > 0) {\n     connection = this._freeConnections.shift();\n-\n-    return process.nextTick(function(){\n-      return cb(null, connection);\n-    });\n+    this.acquireConnection(connection, cb);\n+    return;\n   }\n \n   if (this.config.connectionLimit === 0 || this._allConnections.length < this.config.connectionLimit) {\n-    connection = new PoolConnection(this, { config: this.config.connectionConfig });\n+    connection = new PoolConnection(this, { config: this.config.newConnectionConfig() });\n \n+    this._acquiringConnections.push(connection);\n     this._allConnections.push(connection);\n \n-    return connection.connect(function(err) {\n-      if (this._closed) {\n-        return cb(new Error('Pool is closed.'));\n+    connection.connect({timeout: this.config.acquireTimeout}, function onConnect(err) {\n+      spliceConnection(pool._acquiringConnections, connection);\n+\n+      if (pool._closed) {\n+        err = new Error('Pool is closed.');\n+        err.code = 'POOL_CLOSED';\n       }\n+\n       if (err) {\n-        return cb(err);\n+        pool._purgeConnection(connection);\n+        cb(err);\n+        return;\n       }\n \n-      this.emit('connection', connection);\n-      return cb(null, connection);\n-    }.bind(this));\n+      pool.emit('connection', connection);\n+      pool.emit('acquire', connection);\n+      cb(null, connection);\n+    });\n+    return;\n   }\n \n   if (!this.config.waitForConnections) {\n-    return process.nextTick(function(){\n-      return cb(new Error('No connections available.'));\n+    process.nextTick(function(){\n+      var err = new Error('No connections available.');\n+      err.code = 'POOL_CONNLIMIT';\n+      cb(err);\n     });\n+    return;\n   }\n",
					"match": false,
					"packageHash": "e337a9e2a981ea3795a1a530f2635184b3612496fc1e544fd1615356894c789d",
					"size": 3867,
					"sourceHash": "b6e8d830822418442dd73e3d4280977fe802c419e99c96f43e3723baa28571dc",
					"status": "content"
				},
				"lib/PoolCluster.js": {
					"diff": "--- published/lib/PoolCluster.js\n+++ rebuilt/lib/PoolCluster.js\n@@ -1,242 +1,288 @@\n-var Pool         = require('./Pool');\r\n-var PoolConfig   = require('./PoolConfig');\r\n-var Util         = require('util');\r\n-var EventEmitter = require('events').EventEmitter;\r\n-\r\n-module.exports = PoolCluster;\r\n-\r\n-/**\r\n- * PoolCluster\r\n- */\r\n-function PoolCluster(config) {\r\n-  EventEmitter.call(this);\r\n-\r\n-  config = config || {};\r\n-  this._canRetry = typeof config.canRetry === 'undefined' ? true : config.canRetry;\r\n-  this._removeNodeErrorCount = config.removeNodeErrorCount || 5;\r\n-  this._defaultSelector = config.defaultSelector || 'RR';\r\n-\r\n-  this._closed = false;\r\n-  this._lastId = 0;\r\n-  this._nodes = {};\r\n-  this._serviceableNodeIds = [];\r\n-  this._namespaces = {};\r\n-  this._findCaches = {};\r\n-}\r\n-\r\n-Util.inherits(PoolCluster, EventEmitter);\r\n-\r\n-PoolCluster.prototype.of = function(pattern, selector) {\r\n-  pattern = pattern || '*';\r\n-  \r\n-  selector = selector || this._defaultSelector;\r\n-  selector = selector.toUpperCase();\r\n-  if (typeof Selector[selector] === 'undefined') {\r\n-    selector = this._defaultSelector;\r\n-  }\r\n-  \r\n-  var key = pattern + selector;\r\n-\r\n-  if (typeof this._namespaces[key] === 'undefined') {\r\n-    this._namespaces[key] = new PoolNamespace(this, pattern, selector);\r\n-  }\r\n-\r\n-  return this._namespaces[key];\r\n-};\r\n-\r\n-PoolCluster.prototype.add = function(id, config) {\r\n-  if (typeof id === 'object') {\r\n-    config = id;\r\n-    id = 'CLUSTER::' + (++this._lastId);\r\n-  }\r\n-\r\n-  if (typeof this._nodes[id] === 'undefined') {\r\n-    this._nodes[id] = {\r\n-      id: id,\r\n-      errorCount: 0,\r\n-      pool: new Pool({config: new PoolConfig(config)})\r\n-    };\r\n-\r\n-    this._serviceableNodeIds.push(id);\r\n-    \r\n-    this._clearFindCaches();\r\n-  }\r\n-};\r\n-\r\n-PoolCluster.prototype.getConnection = function(pattern, selector, cb) {\r\n-  var namespace;\r\n-  if (typeof pattern === 'function') {\r\n-    cb = pattern;\r\n-    namespace = this.of();\r\n-  } else {\r\n-    if (typeof selector === 'function') {\r\n-      cb = selector;\r\n-      selector = this._defaultSelector;\r\n-    }\r\n-\r\n-    namespace = this.of(pattern, selector);\r\n-  }\r\n-\r\n-  namespace.getConnection(cb);\r\n-};\r\n-\r\n-PoolCluster.prototype.end = function() {\r\n-  if (this._closed) {\r\n-    return;\r\n-  }\r\n-\r\n-  this._closed = true;\r\n-\r\n-  for (var id in this._nodes) {\r\n-    this._nodes[id].pool.end();\r\n-  }\r\n-};\r\n-\r\n-PoolCluster.prototype._findNodeIds = function(pattern) {\r\n-  if (typeof this._findCaches[pattern] !== 'undefined') {\r\n-    return this._findCaches[pattern];\r\n",
					"match": false,
					"packageHash": "a050bd0d5c128b6e44b3022d5db4a31e91cebb623d03c5af91bbb6722b61135b",
					"size": 5641,
					"sourceHash": "f7f7816e6c471e652724582d49b2315d18bdd14cdb7eba413bbc7a57d7ddd00d",
					"status": "content"
				},
				"lib/PoolConfig.js": {
					"diff": "--- published/lib/PoolConfig.js\n+++ rebuilt/lib/PoolConfig.js\n@@ -3,6 +3,13 @@\n \n module.exports = PoolConfig;\n function PoolConfig(options) {\n+  if (typeof options === 'string') {\n+    options = ConnectionConfig.parseUrl(options);\n+  }\n+\n+  this.acquireTimeout     = (options.acquireTimeout === undefined)\n+    ? 10 * 1000\n+    : Number(options.acquireTimeout);\n   this.connectionConfig   = new ConnectionConfig(options);\n   this.waitForConnections = (options.waitForConnections === undefined)\n     ? true\n@@ -14,3 +21,12 @@\n     ? 0\n     : Number(options.queueLimit);\n }\n+\n+PoolConfig.prototype.newConnectionConfig = function newConnectionConfig() {\n+  var connectionConfig = new ConnectionConfig(this.connectionConfig);\n+\n+  connectionConfig.clientFlags   = this.connectionConfig.clientFlags;\n+  connectionConfig.maxPacketSize = this.connectionConfig.maxPacketSize;\n+\n+  return connectionConfig;\n+};\n",
					"match": false,
					"packageHash": "7d9f4e2550bd31ed61694e056f0623b62f8aca2e055afafa90fd04ddd7632173",
					"size": 523,
					"sourceHash": "19a63110a6b750fc19765323a1a8aff43d27906459e15bd58170249bf01318ec",
					"status": "content"
				},
				"lib/PoolConnection.js": {
					"diff": "--- published/lib/PoolConnection.js\n+++ rebuilt/lib/PoolConnection.js\n@@ -1,46 +1,59 @@\n-var inherits = require('util').inherits\n-  , Connection = require('./Connection')\n+var inherits   = require('util').inherits;\n+var Connection = require('./Connection');\n+var Events     = require('events');\n \n module.exports = PoolConnection;\n inherits(PoolConnection, Connection);\n \n function PoolConnection(pool, options) {\n   Connection.call(this, options);\n-  this._pool = pool;\n+  this._pool  = pool;\n+\n+  // Bind connection to pool domain\n+  if (Events.usingDomains) {\n+    this.domain = pool.domain;\n+  }\n \n   // When a fatal error occurs the connection's protocol ends, which will cause\n   // the connection to end as well, thus we only need to watch for the end event\n   // and we will be notified of disconnects.\n   this.on('end', this._removeFromPool);\n-  this.on('error', this._removeFromPool);\n+  this.on('error', function (err) {\n+    if (err.fatal) {\n+      this._removeFromPool();\n+    }\n+  });\n }\n \n-PoolConnection.prototype.release = function () {\n-  if (!this._pool || this._pool._closed) {\n-    return;\n+PoolConnection.prototype.release = function release() {\n+  var pool = this._pool;\n+\n+  if (!pool || pool._closed) {\n+    return undefined;\n   }\n \n-  return this._pool.releaseConnection(this);\n+  return pool.releaseConnection(this);\n };\n \n // TODO: Remove this when we are removing PoolConnection#end\n PoolConnection.prototype._realEnd = Connection.prototype.end;\n \n PoolConnection.prototype.end = function () {\n-  console.warn( 'Calling conn.end() to release a pooled connection is '\n-              + 'deprecated. In next version calling conn.end() will be '\n-              + 'restored to default conn.end() behavior. Use '\n-              + 'conn.release() instead.'\n-              );\n+  console.warn(\n+    'Calling conn.end() to release a pooled connection is ' +\n+    'deprecated. In next version calling conn.end() will be ' +\n+    'restored to default conn.end() behavior. Use ' +\n+    'conn.release() instead.'\n+  );\n   this.release();\n };\n \n PoolConnection.prototype.destroy = function () {\n+  Connection.prototype.destroy.apply(this, arguments);\n   this._removeFromPool(this);\n-  return Connection.prototype.destroy.apply(this, arguments);\n };\n \n-PoolConnection.prototype._removeFromPool = function(connection) {\n+PoolConnection.prototype._removeFromPool = function _removeFromPool() {\n   if (!this._pool || this._pool._closed) {\n     return;\n   }\n@@ -48,5 +61,5 @@\n   var pool = this._pool;\n   this._pool = null;\n \n-  pool._removeConnection(this);\n+  pool._purgeConnection(this);\n };\n",
					"match": false,
					"packageHash": "16330d50b0a7ac0b1c6328d20c7f12e239cd29b48a5fd58bb0d03b5f697c8297",
					"size": 1513,
					"sourceHash": "afff8247fbc2513c6a56d1025e23b8d9f77c50a2ee38d75ac9d382db55d326b7",
					"status": "content"
				},
				"lib/protocol/.ElementWriter.js.un~": {
					"match": false,
					"packageHash": "d6e26d569d22080f96930a2521e38da37323a7234bd83e41cdc65a7e68a30735",
					"size": 84957,
					"status": "missing-in-source"
				},
				"lib/protocol/.PacketWriter.js.un~": {
					"match": false,
					"packageHash": "03c3550c4f55f2c27204a9597c34631a4c67f34f493f5b1be8f6017832ab6403",
					"size": 26693,
					"status": "missing-in-source"
				},
				"lib/protocol/.Parser.js.un~": {
					"match": false,
					"packageHash": "64810b7ef98997d1f73bf994aa30cd48c22276e8b0f4e2955ed62325fdd23242",
					"size": 7158,
					"status": "missing-in-source"
				},
				"lib/protocol/.Protocol.js.un~": {
					"match": false,
					"packageHash": "f470b87e7fe63be9a1224db938d7842bb7f94d1308f02e2dfd99c490e613b623",
					"size": 48551,
					"status": "missing-in-source"
				},
				"lib/protocol/.ProtocolWriter.js.un~": {
					"match": false,
					"packageHash": "7efaf2ef9761c60dd33a850bce96b81d6e7f11ba6bf195d67700f9cf5e8d70da",
					"size": 31530,
					"status": "missing-in-source"
				},
				"lib/protocol/.SqlString.js.un~": {
					"match": false,
					"packageHash": "ca139c9cae69f81f72fa543dd21f2e214de62ab44dab9b71bea1dc6b1ff9343d",
					"size": 748,
					"status": "missing-in-source"
				},
				"lib/protocol/Auth.js": {
					"diff": "--- published/lib/protocol/Auth.js\n+++ rebuilt/lib/protocol/Auth.js\n@@ -1,33 +1,44 @@\n-var Buffer = require('buffer').Buffer;\n+var Buffer = require('safe-buffer').Buffer;\n var Crypto = require('crypto');\n var Auth   = exports;\n \n+function auth(name, data, options) {\n+  options = options || {};\n+\n+  switch (name) {\n+    case 'mysql_native_password':\n+      return Auth.token(options.password, data.slice(0, 20));\n+    default:\n+      return undefined;\n+  }\n+}\n+Auth.auth = auth;\n+\n function sha1(msg) {\n   var hash = Crypto.createHash('sha1');\n-  hash.update(msg);\n-  // hash.digest() does not output buffers yet\n+  hash.update(msg, 'binary');\n   return hash.digest('binary');\n-};\n+}\n Auth.sha1 = sha1;\n \n function xor(a, b) {\n-  a = new Buffer(a, 'binary');\n-  b = new Buffer(b, 'binary');\n-  var result = new Buffer(a.length);\n+  a = Buffer.from(a, 'binary');\n+  b = Buffer.from(b, 'binary');\n+  var result = Buffer.allocUnsafe(a.length);\n   for (var i = 0; i < a.length; i++) {\n     result[i] = (a[i] ^ b[i]);\n   }\n   return result;\n-};\n+}\n Auth.xor = xor;\n \n Auth.token = function(password, scramble) {\n   if (!password) {\n-    return new Buffer(0);\n+    return Buffer.alloc(0);\n   }\n \n   // password must be in binary format, not utf8\n-  var stage1 = sha1((new Buffer(password, \"utf8\")).toString(\"binary\"));\n+  var stage1 = sha1((Buffer.from(password, 'utf8')).toString('binary'));\n   var stage2 = sha1(stage1);\n   var stage3 = sha1(scramble.toString('binary') + stage2);\n   return xor(stage3, stage1);\n@@ -36,25 +47,25 @@\n // This is a port of sql/password.c:hash_password which needs to be used for\n // pre-4.1 passwords.\n Auth.hashPassword = function(password) {\n-  var nr = [0x5030, 0x5735],\n-      add = 7,\n-      nr2 = [0x1234, 0x5671],\n-      result = new Buffer(8);\n+  var nr     = [0x5030, 0x5735];\n+  var add    = 7;\n+  var nr2    = [0x1234, 0x5671];\n+  var result = Buffer.alloc(8);\n \n-  if (typeof password == 'string'){\n-    password = new Buffer(password);\n+  if (typeof password === 'string'){\n+    password = Buffer.from(password);\n   }\n \n   for (var i = 0; i < password.length; i++) {\n     var c = password[i];\n-    if (c == 32 || c == 9) {\n+    if (c === 32 || c === 9) {\n       // skip space in password\n       continue;\n     }\n \n     // nr^= (((nr & 63)+add)*c)+ (nr << 8);\n     // nr = xor(nr, add(mul(add(and(nr, 63), add), c), shl(nr, 8)))\n-    nr = this.xor32(nr, this.add32(this.mul32(this.add32(this.and32(nr, [0,63]), [0,add]), [0,c]), this.shl32(nr, 8)));\n+    nr = this.xor32(nr, this.add32(this.mul32(this.add32(this.and32(nr, [0, 63]), [0, add]), [0, c]), this.shl32(nr, 8)));\n \n     // nr2+=(nr2 << 8) ^ nr;\n     // nr2 = add(nr2, xor(shl(nr2, 8), nr))\n@@ -72,10 +83,10 @@\n \n Auth.randomInit = function(seed1, seed2) {\n   return {\n-    max_value: 0x3FFFFFFF,\n-    max_value_dbl: 0x3FFFFFFF,\n-    seed1: seed1 % 0x3FFFFFFF,\n-    seed2: seed2 % 0x3FFFFFFF\n+    max_value     : 0x3FFFFFFF,\n",
					"match": false,
					"packageHash": "0df372f2105cc736a5b0452109ad432588fb34cd0b824ce5a3d37aff1c822da4",
					"size": 4238,
					"sourceHash": "424d8425dda6a60ca55c1df20e06c9fcef89c056ba70f34027495c3dd551ff03",
					"status": "content"
				},
				"lib/protocol/PacketWriter.js": {
					"diff": "--- published/lib/protocol/PacketWriter.js\n+++ rebuilt/lib/protocol/PacketWriter.js\n@@ -1,27 +1,35 @@\n-var BIT_16 = Math.pow(2, 16);\n-var BIT_24 = Math.pow(2, 24);\n+var BIT_16            = Math.pow(2, 16);\n+var BIT_24            = Math.pow(2, 24);\n+var BUFFER_ALLOC_SIZE = Math.pow(2, 8);\n // The maximum precision JS Numbers can hold precisely\n // Don't panic: Good enough to represent byte values up to 8192 TB\n var IEEE_754_BINARY_64_PRECISION = Math.pow(2, 53);\n var MAX_PACKET_LENGTH            = Math.pow(2, 24) - 1;\n+var Buffer                       = require('safe-buffer').Buffer;\n \n module.exports = PacketWriter;\n function PacketWriter() {\n-  this._buffer = new Buffer(0);\n+  this._buffer = null;\n   this._offset = 0;\n }\n \n-PacketWriter.prototype.toBuffer = function(parser) {\n-  var packets  = Math.floor(this._buffer.length / MAX_PACKET_LENGTH) + 1;\n-  var buffer   = this._buffer;\n-  this._buffer = new Buffer(this._buffer.length + packets * 4);\n+PacketWriter.prototype.toBuffer = function toBuffer(parser) {\n+  if (!this._buffer) {\n+    this._buffer = Buffer.alloc(0);\n+    this._offset = 0;\n+  }\n \n-  for (var packet = 0; packet < packets; packet++) {\n-    this._offset = packet * (MAX_PACKET_LENGTH + 4);\n+  var buffer  = this._buffer;\n+  var length  = this._offset;\n+  var packets = Math.floor(length / MAX_PACKET_LENGTH) + 1;\n+\n+  this._buffer = Buffer.allocUnsafe(length + packets * 4);\n+  this._offset = 0;\n \n+  for (var packet = 0; packet < packets; packet++) {\n     var isLast = (packet + 1 === packets);\n     var packetLength = (isLast)\n-      ? buffer.length % MAX_PACKET_LENGTH\n+      ? length % MAX_PACKET_LENGTH\n       : MAX_PACKET_LENGTH;\n \n     var packetNumber = parser.incrementPacketNumber();\n@@ -109,11 +117,11 @@\n     );\n   }\n \n-  if (value <= BIT_16) {\n-    this._allocate(3)\n+  if (value < BIT_16) {\n+    this._allocate(3);\n     this._buffer[this._offset++] = 252;\n-  } else if (value <= BIT_24) {\n-    this._allocate(4)\n+  } else if (value < BIT_24) {\n+    this._allocate(4);\n     this._buffer[this._offset++] = 253;\n   } else {\n     this._allocate(9);\n@@ -124,12 +132,16 @@\n   this._buffer[this._offset++] = value & 0xff;\n   this._buffer[this._offset++] = (value >> 8) & 0xff;\n \n-  if (value <= BIT_16) return;\n+  if (value < BIT_16) {\n+    return;\n+  }\n \n   // 24 Bit\n   this._buffer[this._offset++] = (value >> 16) & 0xff;\n \n-  if (value <= BIT_24) return;\n+  if (value < BIT_24) {\n+    return;\n+  }\n \n   this._buffer[this._offset++] = (value >> 24) & 0xff;\n \n@@ -179,9 +191,10 @@\n   this._offset += bytes;\n };\n \n-PacketWriter.prototype._allocate = function(bytes) {\n+PacketWriter.prototype._allocate = function _allocate(bytes) {\n   if (!this._buffer) {\n-    this._buffer = new Buffer(bytes);\n+    this._buffer = Buffer.alloc(Math.max(BUFFER_ALLOC_SIZE, bytes));\n+    this._offset = 0;\n     return;\n   }\n \n@@ -190,8 +203,9 @@\n     return;\n   }\n \n",
					"match": false,
					"packageHash": "d4b89608ea415114b7e3ef2f15ad5d2008c87bd4c4d3cdcfc4e0e7f1a2de8aac",
					"size": 5046,
					"sourceHash": "514e15b89c752845cafde9c7a9d77f318ce0d45f8b06590d54657ce2db0b5811",
					"status": "content"
				},
				"lib/protocol/Parser.js": {
					"diff": "--- published/lib/protocol/Parser.js\n+++ rebuilt/lib/protocol/Parser.js\n@@ -1,98 +1,106 @@\n-var IEEE_754_BINARY_64_PRECISION = Math.pow(2, 53);\n-var MAX_PACKET_LENGTH            = Math.pow(2, 24) - 1;\n-var PacketHeader                 = require('./PacketHeader');\n-var BigNumber                    = require(\"bignumber.js\");\n+var PacketHeader = require('./PacketHeader');\n+var BigNumber    = require('bignumber.js');\n+var Buffer       = require('safe-buffer').Buffer;\n+var BufferList   = require('./BufferList');\n+\n+var MAX_PACKET_LENGTH    = Math.pow(2, 24) - 1;\n+var MUL_32BIT            = Math.pow(2, 32);\n+var PACKET_HEADER_LENGTH = 4;\n \n module.exports = Parser;\n function Parser(options) {\n   options = options || {};\n \n   this._supportBigNumbers = options.config && options.config.supportBigNumbers;\n-  this._buffer            = new Buffer(0);\n-  this._longPacketBuffers = [];\n+  this._buffer            = Buffer.alloc(0);\n+  this._nextBuffers       = new BufferList();\n+  this._longPacketBuffers = new BufferList();\n   this._offset            = 0;\n   this._packetEnd         = null;\n   this._packetHeader      = null;\n+  this._packetOffset      = null;\n+  this._onError           = options.onError || function(err) { throw err; };\n   this._onPacket          = options.onPacket || function() {};\n   this._nextPacketNumber  = 0;\n   this._encoding          = 'utf-8';\n   this._paused            = false;\n }\n \n-Parser.prototype.write = function(buffer) {\n-  this.append(buffer);\n+Parser.prototype.write = function write(chunk) {\n+  this._nextBuffers.push(chunk);\n \n-  while (true) {\n-    if (this._paused) {\n-      return;\n-    }\n-\n-    if (!this._packetHeader) {\n-      if (this._bytesRemaining() < 4) {\n-        break;\n-      }\n-\n-      this._packetHeader = new PacketHeader(\n-        this.parseUnsignedNumber(3),\n-        this.parseUnsignedNumber(1)\n-      );\n-\n-      this._trackAndVerifyPacketNumber(this._packetHeader.number);\n-    }\n+  while (!this._paused) {\n+    var packetHeader = this._tryReadPacketHeader();\n \n-    if (this._bytesRemaining() < this._packetHeader.length) {\n+    if (!packetHeader) {\n       break;\n     }\n \n-    this._packetEnd = this._offset + this._packetHeader.length;\n-\n-    if (this._packetHeader.length === MAX_PACKET_LENGTH) {\n-      this._longPacketBuffers.push(this._buffer.slice(this._offset, this._packetEnd));\n-\n-      this._advanceToNextPacket();\n-      continue;\n+    if (!this._combineNextBuffers(packetHeader.length)) {\n+      break;\n     }\n \n-    this._combineLongPacketBuffers();\n-\n-    // Try...finally to ensure exception safety. Unfortunately this is costing\n-    // us up to ~10% performance in some benchmarks.\n-    var hadException = true;\n-    try {\n-      this._onPacket(this._packetHeader);\n-      hadException = false;\n-    } finally {\n-      this._advanceToNextPacket();\n-\n-      // If we had an exception, the parser while loop will be broken out\n-      // of after the finally block. So we need to make sure to re-enter it\n-      // to continue parsing any bytes that may already have been received.\n-      if (hadException) {\n-        process.nextTick(this.write.bind(this));\n-      }\n-    }\n+    this._parsePacket(packetHeader);\n   }\n };\n \n",
					"match": false,
					"packageHash": "67cbbccdf7ab86abb7d6911ec48546a58725228ec9b7b26734d0177afcd19943",
					"size": 10479,
					"sourceHash": "0e0249efe61fb0ac98bbf5522c1fd4f631e82db52b444b71e92df75ffabc60d3",
					"status": "content"
				},
				"lib/protocol/Protocol.js": {
					"diff": "--- published/lib/protocol/Protocol.js\n+++ rebuilt/lib/protocol/Protocol.js\n@@ -1,7 +1,6 @@\n var Parser       = require('./Parser');\n var Sequences    = require('./sequences');\n var Packets      = require('./packets');\n-var Auth         = require('./Auth');\n var Stream       = require('stream').Stream;\n var Util         = require('util');\n var PacketWriter = require('./PacketWriter');\n@@ -21,13 +20,15 @@\n   this._callback                      = null;\n   this._fatalError                    = null;\n   this._quitSequence                  = null;\n-  this._handshakeSequence             = null;\n+  this._handshake                     = false;\n   this._handshaked                    = false;\n+  this._ended                         = false;\n   this._destroyed                     = false;\n   this._queue                         = [];\n   this._handshakeInitializationPacket = null;\n \n   this._parser = new Parser({\n+    onError  : this.handleParserError.bind(this),\n     onPacket : this._parsePacket.bind(this),\n     config   : this._config\n   });\n@@ -38,33 +39,71 @@\n   return true;\n };\n \n-Protocol.prototype.handshake = function(cb) {\n-  return this._handshakeSequence = this._enqueue(new Sequences.Handshake(this._config, cb));\n+Protocol.prototype.handshake = function handshake(options, callback) {\n+  if (typeof options === 'function') {\n+    callback = options;\n+    options = {};\n+  }\n+\n+  options = options || {};\n+  options.config = this._config;\n+\n+  var sequence = this._enqueue(new Sequences.Handshake(options, callback));\n+\n+  this._handshake = true;\n+\n+  return sequence;\n };\n \n-Protocol.prototype.query = function(options, cb) {\n-  return this._enqueue(new Sequences.Query(options, cb));\n+Protocol.prototype.query = function query(options, callback) {\n+  return this._enqueue(new Sequences.Query(options, callback));\n };\n \n-Protocol.prototype.changeUser = function(options, cb) {\n-  return this._enqueue(new Sequences.ChangeUser(options, cb));\n+Protocol.prototype.changeUser = function changeUser(options, callback) {\n+  return this._enqueue(new Sequences.ChangeUser(options, callback));\n };\n \n-Protocol.prototype.ping = function(cb) {\n-  return this._enqueue(new Sequences.Ping(cb));\n+Protocol.prototype.ping = function ping(options, callback) {\n+  if (typeof options === 'function') {\n+    callback = options;\n+    options = {};\n+  }\n+\n+  return this._enqueue(new Sequences.Ping(options, callback));\n };\n \n-Protocol.prototype.stats = function(cb) {\n-  return this._enqueue(new Sequences.Statistics(cb));\n+Protocol.prototype.stats = function stats(options, callback) {\n+  if (typeof options === 'function') {\n+    callback = options;\n+    options = {};\n+  }\n+\n+  return this._enqueue(new Sequences.Statistics(options, callback));\n };\n \n-Protocol.prototype.quit = function(cb) {\n-  return this._quitSequence = this._enqueue(new Sequences.Quit(cb));\n+Protocol.prototype.quit = function quit(options, callback) {\n+  if (typeof options === 'function') {\n+    callback = options;\n+    options = {};\n+  }\n+\n+  var self     = this;\n+  var sequence = this._enqueue(new Sequences.Quit(options, callback));\n+\n+  sequence.on('end', function () {\n+    self.end();\n+  });\n+\n+  return this._quitSequence = sequence;\n };\n",
					"match": false,
					"packageHash": "d1a63fcb937256b47cb0bb6b70f95ed25fb2c1492e21f17ceb758a562307b7a2",
					"size": 7950,
					"sourceHash": "634489ea7afdda787efffc95a17006d9b3ab73fbc96e4fae78c92f32e0ba1365",
					"status": "content"
				},
				"lib/protocol/SqlString.js": {
					"diff": "--- published/lib/protocol/SqlString.js\n+++ rebuilt/lib/protocol/SqlString.js\n@@ -1,151 +1 @@\n-var SqlString = exports;\n-\n-SqlString.escapeId = function (val, forbidQualified) {\n-  if (Array.isArray(val)) {\n-    return val.map(function(v) {\n-      return SqlString.escapeId(v, forbidQualified);\n-    }).join(', ');\n-  }\n-\n-  if (forbidQualified) {\n-    return '`' + val.replace(/`/g, '``') + '`';\n-  }\n-  return '`' + val.replace(/`/g, '``').replace(/\\./g, '`.`') + '`';\n-};\n-\n-SqlString.escape = function(val, stringifyObjects, timeZone) {\n-  if (val === undefined || val === null) {\n-    return 'NULL';\n-  }\n-\n-  switch (typeof val) {\n-    case 'boolean': return (val) ? 'true' : 'false';\n-    case 'number': return val+'';\n-  }\n-\n-  if (val instanceof Date) {\n-    val = SqlString.dateToString(val, timeZone || 'local');\n-  }\n-\n-  if (Buffer.isBuffer(val)) {\n-    return SqlString.bufferToString(val);\n-  }\n-\n-  if (Array.isArray(val)) {\n-    return SqlString.arrayToList(val, timeZone);\n-  }\n-\n-  if (typeof val === 'object') {\n-    if (stringifyObjects) {\n-      val = val.toString();\n-    } else {\n-      return SqlString.objectToValues(val, timeZone);\n-    }\n-  }\n-\n-  val = val.replace(/[\\0\\n\\r\\b\\t\\\\\\'\\\"\\x1a]/g, function(s) {\n-    switch(s) {\n-      case \"\\0\": return \"\\\\0\";\n-      case \"\\n\": return \"\\\\n\";\n-      case \"\\r\": return \"\\\\r\";\n-      case \"\\b\": return \"\\\\b\";\n-      case \"\\t\": return \"\\\\t\";\n-      case \"\\x1a\": return \"\\\\Z\";\n-      default: return \"\\\\\"+s;\n-    }\n-  });\n-  return \"'\"+val+\"'\";\n-};\n-\n-SqlString.arrayToList = function(array, timeZone) {\n-  return array.map(function(v) {\n-    if (Array.isArray(v)) return '(' + SqlString.arrayToList(v, timeZone) + ')';\n-    return SqlString.escape(v, true, timeZone);\n-  }).join(', ');\n-};\n-\n-SqlString.format = function(sql, values, stringifyObjects, timeZone) {\n-  values = [].concat(values);\n-\n-  return sql.replace(/\\?\\??/g, function(match) {\n-    if (!values.length) {\n-      return match;\n-    }\n-\n-    if (match == \"??\") {\n-      return SqlString.escapeId(values.shift());\n-    }\n-    return SqlString.escape(values.shift(), stringifyObjects, timeZone);\n-  });\n-};\n-\n-SqlString.dateToString = function(date, timeZone) {\n-  var dt = new Date(date);\n-\n-  if (timeZone != 'local') {\n-    var tz = convertTimezone(timeZone);\n-\n-    dt.setTime(dt.getTime() + (dt.getTimezoneOffset() * 60000));\n-    if (tz !== false) {\n-      dt.setTime(dt.getTime() + (tz * 60000));\n-    }\n-  }\n-\n-  var year   = dt.getFullYear();\n-  var month  = zeroPad(dt.getMonth() + 1, 2);\n-  var day    = zeroPad(dt.getDate(), 2);\n-  var hour   = zeroPad(dt.getHours(), 2);\n",
					"match": false,
					"packageHash": "9a2df78e155d3508f4baf0d58678ae5b22d5196607bcd12315a544ede03a5e73",
					"size": 3743,
					"sourceHash": "791c991e078580800235c9bbf60c9475f3b1610aa0ab37f3a880156fcdac89ef",
					"status": "content"
				},
				"lib/protocol/constants/.commands.js.un~": {
					"match": false,
					"packageHash": "57e319cfca1447752bde8df875a212253cfcb51f110e8596fc229b27aa0a25ae",
					"size": 27303,
					"status": "missing-in-source"
				},
				"lib/protocol/constants/.server_status.js.un~": {
					"match": false,
					"packageHash": "fe6804fa23942d9f37bbe5686a89df429ebd051fb5cc18e511a8ce6686cabc73",
					"size": 600,
					"status": "missing-in-source"
				},
				"lib/protocol/constants/charsets.js": {
					"diff": "--- published/lib/protocol/constants/charsets.js\n+++ rebuilt/lib/protocol/constants/charsets.js\n@@ -1,195 +1,262 @@\n-exports.BIG5_CHINESE_CI        = 1;\n-exports.LATIN2_CZECH_CS        = 2;\n-exports.DEC8_SWEDISH_CI        = 3;\n-exports.CP850_GENERAL_CI       = 4;\n-exports.LATIN1_GERMAN1_CI      = 5;\n-exports.HP8_ENGLISH_CI         = 6;\n-exports.KOI8R_GENERAL_CI       = 7;\n-exports.LATIN1_SWEDISH_CI      = 8;\n-exports.LATIN2_GENERAL_CI      = 9;\n-exports.SWE7_SWEDISH_CI        = 10;\n-exports.ASCII_GENERAL_CI       = 11;\n-exports.UJIS_JAPANESE_CI       = 12;\n-exports.SJIS_JAPANESE_CI       = 13;\n-exports.CP1251_BULGARIAN_CI    = 14;\n-exports.LATIN1_DANISH_CI       = 15;\n-exports.HEBREW_GENERAL_CI      = 16;\n-exports.TIS620_THAI_CI         = 18;\n-exports.EUCKR_KOREAN_CI        = 19;\n-exports.LATIN7_ESTONIAN_CS     = 20;\n-exports.LATIN2_HUNGARIAN_CI    = 21;\n-exports.KOI8U_GENERAL_CI       = 22;\n-exports.CP1251_UKRAINIAN_CI    = 23;\n-exports.GB2312_CHINESE_CI      = 24;\n-exports.GREEK_GENERAL_CI       = 25;\n-exports.CP1250_GENERAL_CI      = 26;\n-exports.LATIN2_CROATIAN_CI     = 27;\n-exports.GBK_CHINESE_CI         = 28;\n-exports.CP1257_LITHUANIAN_CI   = 29;\n-exports.LATIN5_TURKISH_CI      = 30;\n-exports.LATIN1_GERMAN2_CI      = 31;\n-exports.ARMSCII8_GENERAL_CI    = 32;\n-exports.UTF8_GENERAL_CI        = 33;\n-exports.CP1250_CZECH_CS        = 34;\n-exports.UCS2_GENERAL_CI        = 35;\n-exports.CP866_GENERAL_CI       = 36;\n-exports.KEYBCS2_GENERAL_CI     = 37;\n-exports.MACCE_GENERAL_CI       = 38;\n-exports.MACROMAN_GENERAL_CI    = 39;\n-exports.CP852_GENERAL_CI       = 40;\n-exports.LATIN7_GENERAL_CI      = 41;\n-exports.LATIN7_GENERAL_CS      = 42;\n-exports.MACCE_BIN              = 43;\n-exports.CP1250_CROATIAN_CI     = 44;\n-exports.UTF8MB4_GENERAL_CI     = 45;\n-exports.UTF8MB4_BIN            = 46;\n-exports.LATIN1_BIN             = 47;\n-exports.LATIN1_GENERAL_CI      = 48;\n-exports.LATIN1_GENERAL_CS      = 49;\n-exports.CP1251_BIN             = 50;\n-exports.CP1251_GENERAL_CI      = 51;\n-exports.CP1251_GENERAL_CS      = 52;\n-exports.MACROMAN_BIN           = 53;\n-exports.UTF16_GENERAL_CI       = 54;\n-exports.UTF16_BIN              = 55;\n-exports.CP1256_GENERAL_CI      = 57;\n-exports.CP1257_BIN             = 58;\n-exports.CP1257_GENERAL_CI      = 59;\n-exports.UTF32_GENERAL_CI       = 60;\n-exports.UTF32_BIN              = 61;\n-exports.BINARY                 = 63;\n-exports.ARMSCII8_BIN           = 64;\n-exports.ASCII_BIN              = 65;\n-exports.CP1250_BIN             = 66;\n-exports.CP1256_BIN             = 67;\n-exports.CP866_BIN              = 68;\n-exports.DEC8_BIN               = 69;\n-exports.GREEK_BIN              = 70;\n-exports.HEBREW_BIN             = 71;\n-exports.HP8_BIN                = 72;\n-exports.KEYBCS2_BIN            = 73;\n-exports.KOI8R_BIN              = 74;\n-exports.KOI8U_BIN              = 75;\n-exports.LATIN2_BIN             = 77;\n-exports.LATIN5_BIN             = 78;\n-exports.LATIN7_BIN             = 79;\n-exports.CP850_BIN              = 80;\n-exports.CP852_BIN              = 81;\n-exports.SWE7_BIN               = 82;\n-exports.UTF8_BIN               = 83;\n-exports.BIG5_BIN               = 84;\n-exports.EUCKR_BIN              = 85;\n-exports.GB2312_BIN             = 86;\n-exports.GBK_BIN                = 87;\n-exports.SJIS_BIN               = 88;\n-exports.TIS620_BIN             = 89;\n-exports.UCS2_BIN               = 90;\n-exports.UJIS_BIN               = 91;\n-exports.GEOSTD8_GENERAL_CI     = 92;\n-exports.GEOSTD8_BIN            = 93;\n-exports.LATIN1_SPANISH_CI      = 94;\n-exports.CP932_JAPANESE_CI      = 95;\n-exports.CP932_BIN              = 96;\n-exports.EUCJPMS_JAPANESE_CI    = 97;\n-exports.EUCJPMS_BIN            = 98;\n-exports.CP1250_POLISH_CI       = 99;\n-exports.UTF16_UNICODE_CI       = 101;\n-exports.UTF16_ICELANDIC_CI     = 102;\n",
					"match": false,
					"packageHash": "a3b3b0e22c0b27eaf471fbb56df3b01c8bd31dff6c2142cfa6cd9786b6a5adf9",
					"size": 7305,
					"sourceHash": "9324cdd56762903d0cde1c2010f49c18b79aa32a3c39976f999c92bdbe84a2b6",
					"status": "content"
				},
				"lib/protocol/constants/errors.js": {
					"diff": "--- published/lib/protocol/constants/errors.js\n+++ rebuilt/lib/protocol/constants/errors.js\n@@ -1,4 +1,1359 @@\n-// Generated by generate-error-constants.js, do not modify by hand\n+/**\n+ * MySQL error constants\n+ *\n+ * Extracted from version 5.7.29\n+ *\n+ * !! Generated by generate-error-constants.js, do not modify by hand !!\n+ */\n+\n+exports.EE_CANTCREATEFILE                                                                = 1;\n+exports.EE_READ                                                                          = 2;\n+exports.EE_WRITE                                                                         = 3;\n+exports.EE_BADCLOSE                                                                      = 4;\n+exports.EE_OUTOFMEMORY                                                                   = 5;\n+exports.EE_DELETE                                                                        = 6;\n+exports.EE_LINK                                                                          = 7;\n+exports.EE_EOFERR                                                                        = 9;\n+exports.EE_CANTLOCK                                                                      = 10;\n+exports.EE_CANTUNLOCK                                                                    = 11;\n+exports.EE_DIR                                                                           = 12;\n+exports.EE_STAT                                                                          = 13;\n+exports.EE_CANT_CHSIZE                                                                   = 14;\n+exports.EE_CANT_OPEN_STREAM                                                              = 15;\n+exports.EE_GETWD                                                                         = 16;\n+exports.EE_SETWD                                                                         = 17;\n+exports.EE_LINK_WARNING                                                                  = 18;\n+exports.EE_OPEN_WARNING                                                                  = 19;\n+exports.EE_DISK_FULL                                                                     = 20;\n+exports.EE_CANT_MKDIR                                                                    = 21;\n+exports.EE_UNKNOWN_CHARSET                                                               = 22;\n+exports.EE_OUT_OF_FILERESOURCES                                                          = 23;\n+exports.EE_CANT_READLINK                                                                 = 24;\n+exports.EE_CANT_SYMLINK                                                                  = 25;\n+exports.EE_REALPATH                                                                      = 26;\n+exports.EE_SYNC                                                                          = 27;\n+exports.EE_UNKNOWN_COLLATION                                                             = 28;\n+exports.EE_FILENOTFOUND                                                                  = 29;\n+exports.EE_FILE_NOT_CLOSED                                                               = 30;\n+exports.EE_CHANGE_OWNERSHIP                                                              = 31;\n+exports.EE_CHANGE_PERMISSIONS                                                            = 32;\n+exports.EE_CANT_SEEK                                                                     = 33;\n+exports.EE_CAPACITY_EXCEEDED                                                             = 34;\n+exports.HA_ERR_KEY_NOT_FOUND                                                             = 120;\n+exports.HA_ERR_FOUND_DUPP_KEY                                                            = 121;\n+exports.HA_ERR_INTERNAL_ERROR                                                            = 122;\n+exports.HA_ERR_RECORD_CHANGED                                                            = 123;\n+exports.HA_ERR_WRONG_INDEX                                                               = 124;\n+exports.HA_ERR_CRASHED                                                                   = 126;\n+exports.HA_ERR_WRONG_IN_RECORD                                                           = 127;\n+exports.HA_ERR_OUT_OF_MEM                                                                = 128;\n+exports.HA_ERR_NOT_A_TABLE                                                               = 130;\n+exports.HA_ERR_WRONG_COMMAND                                                             = 131;\n+exports.HA_ERR_OLD_FILE                                                                  = 132;\n+exports.HA_ERR_NO_ACTIVE_RECORD                                                          = 133;\n+exports.HA_ERR_RECORD_DELETED                                                            = 134;\n+exports.HA_ERR_RECORD_FILE_FULL                                                          = 135;\n+exports.HA_ERR_INDEX_FILE_FULL                                                           = 136;\n+exports.HA_ERR_END_OF_FILE                                                               = 137;\n+exports.HA_ERR_UNSUPPORTED                                                               = 138;\n+exports.HA_ERR_TOO_BIG_ROW                                                               = 139;\n+exports.HA_WRONG_CREATE_OPTION                                                           = 140;\n+exports.HA_ERR_FOUND_DUPP_UNIQUE                                                         = 141;\n+exports.HA_ERR_UNKNOWN_CHARSET                                                           = 142;\n+exports.HA_ERR_WRONG_MRG_TABLE_DEF                                                       = 143;\n+exports.HA_ERR_CRASHED_ON_REPAIR                                                         = 144;\n+exports.HA_ERR_CRASHED_ON_USAGE                                                          = 145;\n+exports.HA_ERR_LOCK_WAIT_TIMEOUT                                                         = 146;\n+exports.HA_ERR_LOCK_TABLE_FULL                                                           = 147;\n+exports.HA_ERR_READ_ONLY_TRANSACTION                                                     = 148;\n+exports.HA_ERR_LOCK_DEADLOCK                                                             = 149;\n+exports.HA_ERR_CANNOT_ADD_FOREIGN                                                        = 150;\n+exports.HA_ERR_NO_REFERENCED_ROW                                                         = 151;\n+exports.HA_ERR_ROW_IS_REFERENCED                                                         = 152;\n+exports.HA_ERR_NO_SAVEPOINT                                                              = 153;\n+exports.HA_ERR_NON_UNIQUE_BLOCK_SIZE                                                     = 154;\n+exports.HA_ERR_NO_SUCH_TABLE                                                             = 155;\n+exports.HA_ERR_TABLE_EXIST                                                               = 156;\n+exports.HA_ERR_NO_CONNECTION                                                             = 157;\n+exports.HA_ERR_NULL_IN_SPATIAL                                                           = 158;\n+exports.HA_ERR_TABLE_DEF_CHANGED                                                         = 159;\n+exports.HA_ERR_NO_PARTITION_FOUND                                                        = 160;\n+exports.HA_ERR_RBR_LOGGING_FAILED                                                        = 161;\n+exports.HA_ERR_DROP_INDEX_FK                                                             = 162;\n+exports.HA_ERR_FOREIGN_DUPLICATE_KEY                                                     = 163;\n+exports.HA_ERR_TABLE_NEEDS_UPGRADE                                                       = 164;\n+exports.HA_ERR_TABLE_READONLY                                                            = 165;\n+exports.HA_ERR_AUTOINC_READ_FAILED                                                       = 166;\n+exports.HA_ERR_AUTOINC_ERANGE                                                            = 167;\n+exports.HA_ERR_GENERIC                                                                   = 168;\n+exports.HA_ERR_RECORD_IS_THE_SAME                                                        = 169;\n+exports.HA_ERR_LOGGING_IMPOSSIBLE                                                        = 170;\n+exports.HA_ERR_CORRUPT_EVENT                                                             = 171;\n+exports.HA_ERR_NEW_FILE                                                                  = 172;\n+exports.HA_ERR_ROWS_EVENT_APPLY                                                          = 173;\n+exports.HA_ERR_INITIALIZATION                                                            = 174;\n+exports.HA_ERR_FILE_TOO_SHORT                                                            = 175;\n+exports.HA_ERR_WRONG_CRC                                                                 = 176;\n",
					"match": false,
					"packageHash": "3fc6ca0592ff5660701cf8cbd6dfe98963cb8b3641a5e8936fa546366c17d8bf",
					"size": 31414,
					"sourceHash": "020fc4881c0d24afbcc65784ecf5e0db7a146dcdbd3f5fc9dcdaf398a3e99301",
					"status": "content"
				},
				"lib/protocol/constants/server_status.js": {
					"diff": "--- published/lib/protocol/constants/server_status.js\n+++ rebuilt/lib/protocol/constants/server_status.js\n@@ -27,7 +27,7 @@\n exports.SERVER_STATUS_NO_BACKSLASH_ESCAPES = 512;\n /**\n   Sent to the client if after a prepared statement reprepare\n-  we discovered that the new statement returns a different \n+  we discovered that the new statement returns a different\n   number of result set columns.\n */\n exports.SERVER_STATUS_METADATA_CHANGED = 1024;\n",
					"match": false,
					"packageHash": "bccc66d429a9919f964f94390d252018340edeb18a3bedcdb396ebc0477e594a",
					"size": 1450,
					"sourceHash": "68bd6dc55c7e62529f128dbc72e0da6f21a3168cba9da2f45bbb19b3d467c745",
					"status": "content"
				},
				"lib/protocol/constants/types.js": {
					"diff": "--- published/lib/protocol/constants/types.js\n+++ rebuilt/lib/protocol/constants/types.js\n@@ -1,29 +1,72 @@\n-// Manually extracted from mysql-5.5.23/include/mysql_com.h\n-// some more info here: http://dev.mysql.com/doc/refman/5.5/en/c-api-prepared-statement-type-codes.html\n-exports.DECIMAL     = 0x00; // aka DECIMAL (http://dev.mysql.com/doc/refman/5.0/en/precision-math-decimal-changes.html)\n-exports.TINY        = 0x01; // aka TINYINT, 1 byte\n-exports.SHORT       = 0x02; // aka SMALLINT, 2 bytes\n-exports.LONG        = 0x03; // aka INT, 4 bytes\n-exports.FLOAT       = 0x04; // aka FLOAT, 4-8 bytes\n-exports.DOUBLE      = 0x05; // aka DOUBLE, 8 bytes\n-exports.NULL        = 0x06; // NULL (used for prepared statements, I think)\n-exports.TIMESTAMP   = 0x07; // aka TIMESTAMP\n-exports.LONGLONG    = 0x08; // aka BIGINT, 8 bytes\n-exports.INT24       = 0x09; // aka MEDIUMINT, 3 bytes\n-exports.DATE        = 0x0a; // aka DATE\n-exports.TIME        = 0x0b; // aka TIME\n-exports.DATETIME    = 0x0c; // aka DATETIME\n-exports.YEAR        = 0x0d; // aka YEAR, 1 byte (don't ask)\n-exports.NEWDATE     = 0x0e; // aka ?\n-exports.VARCHAR     = 0x0f; // aka VARCHAR (?)\n-exports.BIT         = 0x10; // aka BIT, 1-8 byte\n-exports.NEWDECIMAL  = 0xf6; // aka DECIMAL\n-exports.ENUM        = 0xf7; // aka ENUM\n-exports.SET         = 0xf8; // aka SET\n-exports.TINY_BLOB   = 0xf9; // aka TINYBLOB, TINYTEXT\n-exports.MEDIUM_BLOB = 0xfa; // aka MEDIUMBLOB, MEDIUMTEXT\n-exports.LONG_BLOB   = 0xfb; // aka LONGBLOG, LONGTEXT\n-exports.BLOB        = 0xfc; // aka BLOB, TEXT\n-exports.VAR_STRING  = 0xfd; // aka VARCHAR, VARBINARY\n-exports.STRING      = 0xfe; // aka CHAR, BINARY\n-exports.GEOMETRY    = 0xff; // aka GEOMETRY\n+/**\n+ * MySQL type constants\n+ *\n+ * Extracted from version 5.7.29\n+ *\n+ * !! Generated by generate-type-constants.js, do not modify by hand !!\n+ */\n+\n+exports.DECIMAL     = 0;\n+exports.TINY        = 1;\n+exports.SHORT       = 2;\n+exports.LONG        = 3;\n+exports.FLOAT       = 4;\n+exports.DOUBLE      = 5;\n+exports.NULL        = 6;\n+exports.TIMESTAMP   = 7;\n+exports.LONGLONG    = 8;\n+exports.INT24       = 9;\n+exports.DATE        = 10;\n+exports.TIME        = 11;\n+exports.DATETIME    = 12;\n+exports.YEAR        = 13;\n+exports.NEWDATE     = 14;\n+exports.VARCHAR     = 15;\n+exports.BIT         = 16;\n+exports.TIMESTAMP2  = 17;\n+exports.DATETIME2   = 18;\n+exports.TIME2       = 19;\n+exports.JSON        = 245;\n+exports.NEWDECIMAL  = 246;\n+exports.ENUM        = 247;\n+exports.SET         = 248;\n+exports.TINY_BLOB   = 249;\n+exports.MEDIUM_BLOB = 250;\n+exports.LONG_BLOB   = 251;\n+exports.BLOB        = 252;\n+exports.VAR_STRING  = 253;\n+exports.STRING      = 254;\n+exports.GEOMETRY    = 255;\n+\n+// Lookup-by-number table\n+exports[0]   = 'DECIMAL';\n+exports[1]   = 'TINY';\n+exports[2]   = 'SHORT';\n+exports[3]   = 'LONG';\n+exports[4]   = 'FLOAT';\n+exports[5]   = 'DOUBLE';\n+exports[6]   = 'NULL';\n+exports[7]   = 'TIMESTAMP';\n+exports[8]   = 'LONGLONG';\n+exports[9]   = 'INT24';\n+exports[10]  = 'DATE';\n+exports[11]  = 'TIME';\n+exports[12]  = 'DATETIME';\n+exports[13]  = 'YEAR';\n+exports[14]  = 'NEWDATE';\n+exports[15]  = 'VARCHAR';\n+exports[16]  = 'BIT';\n+exports[17]  = 'TIMESTAMP2';\n+exports[18]  = 'DATETIME2';\n+exports[19]  = 'TIME2';\n+exports[245] = 'JSON';\n+exports[246] = 'NEWDECIMAL';\n+exports[247] = 'ENUM';\n+exports[248] = 'SET';\n+exports[249] = 'TINY_BLOB';\n+exports[250] = 'MEDIUM_BLOB';\n+exports[251] = 'LONG_BLOB';\n",
					"match": false,
					"packageHash": "fcd25e828fd0680cb9076403f056a57e27a266e8894bbed7b8f53011e9922098",
					"size": 1562,
					"sourceHash": "621cfbd18a7e9e5a349f1d85ddb4831047512b803e3a1ca1a6cfc29d0201bb88",
					"status": "content"
				},
				"lib/protocol/packets/.BinaryRowDataPacket.js.un~": {
					"match": false,
					"packageHash": "abf24792404892f83e92a76a6cd36638d3ce75a496c1a92201c29abe977eb7f9",
					"size": 93630,
					"status": "missing-in-source"
				},
				"lib/protocol/packets/.ClientAuthenticationPacket.js.un~": {
					"match": false,
					"packageHash": "da1c6c776a721b8fa2921647bc9def06fbf07f2c657b406b6bc3e13487b260cb",
					"size": 23546,
					"status": "missing-in-source"
				},
				"lib/protocol/packets/.ComQueryPacket.js.un~": {
					"match": false,
					"packageHash": "0ee4fa6d5f087427daff65b72eaa46233ef54d34fcbe4a8ddc935d8cc128a48c",
					"size": 2760,
					"status": "missing-in-source"
				},
				"lib/protocol/packets/.ComQuitPacket.js.un~": {
					"match": false,
					"packageHash": "56480c1a03088df234c5c2e03b693e3029167f5ae5a8b6e7fdfc7d1c620c17e1",
					"size": 16182,
					"status": "missing-in-source"
				},
				"lib/protocol/packets/.ComStmtExecutePacket.js.un~": {
					"match": false,
					"packageHash": "4214acad263133847fc782c0f6359a2d69bbac205b851023b7ebbae3a14b8ae5",
					"size": 109733,
					"status": "missing-in-source"
				},
				"lib/protocol/packets/.ComStmtPreparePacket.js.un~": {
					"match": false,
					"packageHash": "08de368ffb65cddbd256c67f227a924da8fdccb09dfe28d4cf15fc5e2c339bc5",
					"size": 2687,
					"status": "missing-in-source"
				},
				"lib/protocol/packets/.EofPacket.js.un~": {
					"match": false,
					"packageHash": "ce445411ffcd30b61b1338eef97b1d6c1a2e3a4dca4c449a25015017324240a1",
					"size": 1054,
					"status": "missing-in-source"
				},
				"lib/protocol/packets/.ErrorPacket.js.un~": {
					"match": false,
					"packageHash": "3b49ba1c10517231ce62c4301c4adf34a9f6aec0d07415156b52956f16c08faa",
					"size": 2003,
					"status": "missing-in-source"
				},
				"lib/protocol/packets/.FieldPacket.js.un~": {
					"match": false,
					"packageHash": "2c5a53427c9030ee3d472d67a28371fb8f1e245671a00dbef7a91cfb08f2973b",
					"size": 15331,
					"status": "missing-in-source"
				},
				"lib/protocol/packets/.HandshakeInitializationPacket.js.un~": {
					"match": false,
					"packageHash": "2121d3b1a75e18cbb11fb700257e7640d5b3052c7546a455f7fd6b47b1d30709",
					"size": 15273,
					"status": "missing-in-source"
				},
				"lib/protocol/packets/.OkPacket.js.un~": {
					"match": false,
					"packageHash": "df38365118cb9892b23fd01379ac4f230d10581025a687df7e2a95747c05b198",
					"size": 1971,
					"status": "missing-in-source"
				},
				"lib/protocol/packets/.ResultSetHeaderPacket.js.un~": {
					"match": false,
					"packageHash": "d81e1ba6f8b114bb4f89fb9ebdb90e1a8fdd12d4b99d270eb18ce34de31ee435",
					"size": 1446,
					"status": "missing-in-source"
				},
				"lib/protocol/packets/.RowDataPacket.js.un~": {
					"match": false,
					"packageHash": "764489eea06b31e8761a107e4602357ffb6aaf126df1e02cb99af1f86ef554f1",
					"size": 29974,
					"status": "missing-in-source"
				},
				"lib/protocol/packets/.StmtPrepareOkPacket.js.un~": {
					"match": false,
					"packageHash": "38f6b2983574679826534679edb6f1e5b921a3192812bf6180ba93cdf492d484",
					"size": 34652,
					"status": "missing-in-source"
				},
				"lib/protocol/packets/BinaryRowDataPacket.js": {
					"match": false,
					"packageHash": "10d875f86779d69502abc95678f81360d8888c9552918e8786661dfa34a6ce14",
					"size": 1644,
					"status": "missing-in-source"
				},
				"lib/protocol/packets/ClientAuthenticationPacket.js": {
					"diff": "--- published/lib/protocol/packets/ClientAuthenticationPacket.js\n+++ rebuilt/lib/protocol/packets/ClientAuthenticationPacket.js\n@@ -1,3 +1,5 @@\n+var Buffer = require('safe-buffer').Buffer;\n+\n module.exports = ClientAuthenticationPacket;\n function ClientAuthenticationPacket(options) {\n   options = options || {};\n@@ -46,7 +48,7 @@\n     writer.writeBuffer(this.scrambleBuff);\n     if (this.database && this.database.length) {\n       writer.writeFiller(1);\n-      writer.writeBuffer(new Buffer(this.database));\n+      writer.writeBuffer(Buffer.from(this.database));\n     }\n   }\n };\n",
					"match": false,
					"packageHash": "8bbaf0232d898b278ef1373be78f6e7beed5ac62f09515260315cfe4a3d3c46d",
					"size": 2034,
					"sourceHash": "9ea54e1eafacb6fd414a9a43e1f56f53013fae1752a928a5a88d5fc82623262e",
					"status": "content"
				},
				"lib/protocol/packets/ComChangeUserPacket.js": {
					"diff": "--- published/lib/protocol/packets/ComChangeUserPacket.js\n+++ rebuilt/lib/protocol/packets/ComChangeUserPacket.js\n@@ -10,6 +10,7 @@\n }\n \n ComChangeUserPacket.prototype.parse = function(parser) {\n+  this.command       = parser.parseUnsignedNumber(1);\n   this.user          = parser.parseNullTerminatedString();\n   this.scrambleBuff  = parser.parseLengthCodedBuffer();\n   this.database      = parser.parseNullTerminatedString();\n",
					"match": false,
					"packageHash": "4abeec9845d17351b5b6551e5db28642f181dcfefd524720c7894e57684e5d87",
					"size": 906,
					"sourceHash": "2076a41c6e51794ddacf51b17e2c66398cdb5e647d017dd7f7cc79461649e8bb",
					"status": "content"
				},
				"lib/protocol/packets/ComPingPacket.js": {
					"diff": "--- published/lib/protocol/packets/ComPingPacket.js\n+++ rebuilt/lib/protocol/packets/ComPingPacket.js\n@@ -1,5 +1,5 @@\n module.exports = ComPingPacket;\n-function ComPingPacket(sql) {\n+function ComPingPacket() {\n   this.command = 0x0e;\n }\n \n",
					"match": false,
					"packageHash": "54475e0112354fd4cbc4355e954bc44fb9306c5fdf598e8ee8712c626a35644e",
					"size": 292,
					"sourceHash": "bfb6921ac4a93241dbe32d4674c87cbf90384b2469948f0bd83319a6ab3bddf2",
					"status": "content"
				},
				"lib/protocol/packets/ComQuitPacket.js": {
					"diff": "--- published/lib/protocol/packets/ComQuitPacket.js\n+++ rebuilt/lib/protocol/packets/ComQuitPacket.js\n@@ -1,7 +1,12 @@\n module.exports = ComQuitPacket;\n-function ComQuitPacket(sql) {\n+function ComQuitPacket() {\n+  this.command = 0x01;\n }\n \n-ComQuitPacket.prototype.write = function(writer) {\n-  writer.writeUnsignedNumber(1, 0x01);\n+ComQuitPacket.prototype.parse = function parse(parser) {\n+  this.command = parser.parseUnsignedNumber(1);\n+};\n+\n+ComQuitPacket.prototype.write = function write(writer) {\n+  writer.writeUnsignedNumber(1, this.command);\n };\n",
					"match": false,
					"packageHash": "1be34626c7bd3b52b62d19c7af3335f8d61cefcae753fbb3343a8bf43d61b1d2",
					"size": 158,
					"sourceHash": "56dc61dff0ab6471be119ca95617f848a73f59c5dd1e0070d793730973b33850",
					"status": "content"
				},
				"lib/protocol/packets/ComStatisticsPacket.js": {
					"diff": "--- published/lib/protocol/packets/ComStatisticsPacket.js\n+++ rebuilt/lib/protocol/packets/ComStatisticsPacket.js\n@@ -1,5 +1,5 @@\n module.exports = ComStatisticsPacket;\n-function ComStatisticsPacket(sql) {\n+function ComStatisticsPacket() {\n   this.command = 0x09;\n }\n \n",
					"match": false,
					"packageHash": "8241bcbb63a3e2d1a9ef499935589930d1ce3ddb1b487af12adafac206e18aaf",
					"size": 316,
					"sourceHash": "3567be174d27c73e6ee14568285af4987769632a3b7c98c180e924f0d74313ad",
					"status": "content"
				},
				"lib/protocol/packets/EmptyPacket.js": {
					"diff": "--- published/lib/protocol/packets/EmptyPacket.js\n+++ rebuilt/lib/protocol/packets/EmptyPacket.js\n@@ -2,5 +2,8 @@\n function EmptyPacket() {\n }\n \n-EmptyPacket.prototype.write = function(writer) {\n+EmptyPacket.prototype.parse = function parse() {\n+};\n+\n+EmptyPacket.prototype.write = function write() {\n };\n",
					"match": false,
					"packageHash": "118f15f394931e01fad798ffe2a18ac281bc62267356bba15b51f0d4bdaac866",
					"size": 110,
					"sourceHash": "8a5c6f064062c68e000db9d4e7ccb783243c2045e985815e4f64319799fd6737",
					"status": "content"
				},
				"lib/protocol/packets/Field.js": {
					"diff": "--- published/lib/protocol/packets/Field.js\n+++ rebuilt/lib/protocol/packets/Field.js\n@@ -9,7 +9,7 @@\n   this.db     = options.packet.db;\n   this.table  = options.packet.table;\n   this.name   = options.packet.name;\n-  this.type   = typeToString(options.packet.type);\n+  this.type   = Types[options.packet.type];\n   this.length = options.packet.length;\n }\n \n@@ -24,9 +24,3 @@\n Field.prototype.geometry = function () {\n   return this.parser.parseGeometryValue();\n };\n-\n-function typeToString(t) {\n-  for (var k in Types) {\n-    if (Types[k] == t) return k;\n-  }\n-}\n",
					"match": false,
					"packageHash": "fd6ab325e162119b40e2d06f4af373ec62db57a996747b525c97bdbb58bd114a",
					"size": 748,
					"sourceHash": "8f21447bfeb73d7d70d3218319385d7afbdaeae532c853c81efa44f997a3ae8d",
					"status": "content"
				},
				"lib/protocol/packets/FieldPacket.js": {
					"diff": "--- published/lib/protocol/packets/FieldPacket.js\n+++ rebuilt/lib/protocol/packets/FieldPacket.js\n@@ -8,16 +8,14 @@\n   this.orgTable   = options.orgTable;\n   this.name       = options.name;\n   this.orgName    = options.orgName;\n-  this.filler1    = undefined;\n   this.charsetNr  = options.charsetNr;\n   this.length     = options.length;\n   this.type       = options.type;\n   this.flags      = options.flags;\n   this.decimals   = options.decimals;\n-  this.filler2    = undefined;\n   this.default    = options.default;\n   this.zeroFill   = options.zeroFill;\n-  this.protocol41 = options.protocol41\n+  this.protocol41 = options.protocol41;\n }\n \n FieldPacket.prototype.parse = function(parser) {\n@@ -28,13 +26,25 @@\n     this.orgTable    = parser.parseLengthCodedString();\n     this.name        = parser.parseLengthCodedString();\n     this.orgName     = parser.parseLengthCodedString();\n-    this.filler1     = parser.parseFiller(1);\n+\n+    if (parser.parseLengthCodedNumber() !== 0x0c) {\n+      var err  = new TypeError('Received invalid field length');\n+      err.code = 'PARSER_INVALID_FIELD_LENGTH';\n+      throw err;\n+    }\n+\n     this.charsetNr   = parser.parseUnsignedNumber(2);\n     this.length      = parser.parseUnsignedNumber(4);\n     this.type        = parser.parseUnsignedNumber(1);\n     this.flags       = parser.parseUnsignedNumber(2);\n     this.decimals    = parser.parseUnsignedNumber(1);\n-    this.filler2     = parser.parseFiller(2);\n+\n+    var filler       = parser.parseBuffer(2);\n+    if (filler[0] !== 0x0 || filler[1] !== 0x0) {\n+      var err  = new TypeError('Received invalid filler');\n+      err.code = 'PARSER_INVALID_FILLER';\n+      throw err;\n+    }\n \n     // parsed flags\n     this.zeroFill    = (this.flags & 0x0040 ? true : false);\n@@ -43,7 +53,7 @@\n       return;\n     }\n \n-    this.default     = parser.parseLengthCodedNumber();\n+    this.default     = parser.parseLengthCodedString();\n   } else {\n     this.table       = parser.parseLengthCodedString();\n     this.name        = parser.parseLengthCodedString();\n@@ -60,7 +70,8 @@\n     writer.writeLengthCodedString(this.orgTable);\n     writer.writeLengthCodedString(this.name);\n     writer.writeLengthCodedString(this.orgName);\n-    writer.writeFiller(1);\n+\n+    writer.writeLengthCodedNumber(0x0c);\n     writer.writeUnsignedNumber(2, this.charsetNr || 0);\n     writer.writeUnsignedNumber(4, this.length || 0);\n     writer.writeUnsignedNumber(1, this.type || 0);\n",
					"match": false,
					"packageHash": "2d9da396c0d1a07334cf3c4d4caa127876621948071f0586c55ea4366b06f967",
					"size": 2991,
					"sourceHash": "2dc09400e8b5238902e843e78347ae1acddf60972a5f1e69aff51ee6cb5e61d8",
					"status": "content"
				},
				"lib/protocol/packets/HandshakeInitializationPacket.js": {
					"diff": "--- published/lib/protocol/packets/HandshakeInitializationPacket.js\n+++ rebuilt/lib/protocol/packets/HandshakeInitializationPacket.js\n@@ -1,3 +1,6 @@\n+var Buffer = require('safe-buffer').Buffer;\n+var Client = require('../constants/client');\n+\n module.exports = HandshakeInitializationPacket;\n function HandshakeInitializationPacket(options) {\n   options = options || {};\n@@ -17,6 +20,11 @@\n   this.filler3             = options.filler3;\n   this.pluginData          = options.pluginData;\n   this.protocol41          = options.protocol41;\n+\n+  if (this.protocol41) {\n+    // force set the bit in serverCapabilities1\n+    this.serverCapabilities1 |= Client.CLIENT_PROTOCOL_41;\n+  }\n }\n \n HandshakeInitializationPacket.prototype.parse = function(parser) {\n@@ -81,11 +89,13 @@\n };\n \n HandshakeInitializationPacket.prototype.scrambleBuff = function() {\n-  var buffer = new Buffer(this.scrambleBuff1.length +\n-                          (typeof this.scrambleBuff2 != \"undefined\" ? this.scrambleBuff2.length : 0));\n+  var buffer = null;\n \n-  this.scrambleBuff1.copy(buffer);\n-  if (typeof this.scrambleBuff2 != \"undefined\") {\n+  if (typeof this.scrambleBuff2 === 'undefined') {\n+    buffer = Buffer.from(this.scrambleBuff1);\n+  } else {\n+    buffer = Buffer.allocUnsafe(this.scrambleBuff1.length + this.scrambleBuff2.length);\n+    this.scrambleBuff1.copy(buffer, 0);\n     this.scrambleBuff2.copy(buffer, this.scrambleBuff1.length);\n   }\n \n",
					"match": false,
					"packageHash": "6b0e5dc2c0505d6a64483c8f1eacfc438922f9d9554ce79c2fb500147dc68e38",
					"size": 3716,
					"sourceHash": "ce4acb2f200bcc6f2df8f9aac2d2ac40bda1315de7f028e563884afe40acd1ec",
					"status": "content"
				},
				"lib/protocol/packets/LocalDataFilePacket.js": {
					"diff": "--- published/lib/protocol/packets/LocalDataFilePacket.js\n+++ rebuilt/lib/protocol/packets/LocalDataFilePacket.js\n@@ -1,8 +1,15 @@\n module.exports = LocalDataFilePacket;\n+\n+/**\n+ * Create a new LocalDataFilePacket\n+ * @constructor\n+ * @param {Buffer} data The data contents of the packet\n+ * @public\n+ */\n function LocalDataFilePacket(data) {\n   this.data = data;\n }\n \n LocalDataFilePacket.prototype.write = function(writer) {\n-  writer.writeString(this.data);\n+  writer.writeBuffer(this.data);\n };\n",
					"match": false,
					"packageHash": "0f01b17b9ab9c5409db1a4e9bb72eb38a764a237a87ff9004bac7cfe0be74575",
					"size": 191,
					"sourceHash": "4f47d3e324845690e5ab9853467acbf778087e14e7dc11a3873a246da598ae39",
					"status": "content"
				},
				"lib/protocol/packets/OkPacket.js": {
					"diff": "--- published/lib/protocol/packets/OkPacket.js\n+++ rebuilt/lib/protocol/packets/OkPacket.js\n@@ -1,3 +1,7 @@\n+\n+// Language-neutral expression to match ER_UPDATE_INFO\n+var ER_UPDATE_INFO_REGEXP = /^[^:0-9]+: [0-9]+[^:0-9]+: ([0-9]+)[^:0-9]+: [0-9]+[^:0-9]*$/;\n+\n module.exports = OkPacket;\n function OkPacket(options) {\n   options = options || {};\n@@ -22,8 +26,7 @@\n   this.message      = parser.parsePacketTerminatedString();\n   this.changedRows  = 0;\n \n-  var m = this.message.match(/\\schanged:\\s*(\\d+)/i);\n-\n+  var m = ER_UPDATE_INFO_REGEXP.exec(this.message);\n   if (m !== null) {\n     this.changedRows = parseInt(m[1], 10);\n   }\n",
					"match": false,
					"packageHash": "818ada16ed032003b0e7cd483c39d2819344a61b51e5328e476a2fe0bb466665",
					"size": 1267,
					"sourceHash": "7510684c932259f8cc300ea5d0be252f74f9f94d5db47ca35065a64f28c6f94f",
					"status": "content"
				},
				"lib/protocol/packets/OldPasswordPacket.js": {
					"diff": "--- published/lib/protocol/packets/OldPasswordPacket.js\n+++ rebuilt/lib/protocol/packets/OldPasswordPacket.js\n@@ -6,10 +6,9 @@\n }\n \n OldPasswordPacket.prototype.parse = function(parser) {\n-  this.scrambleBuff = parser.parseNullTerminatedBuffer();\n+  this.scrambleBuff = parser.parsePacketTerminatedBuffer();\n };\n \n OldPasswordPacket.prototype.write = function(writer) {\n   writer.writeBuffer(this.scrambleBuff);\n-  writer.writeFiller(1);\n };\n",
					"match": false,
					"packageHash": "7444d782e8c5bac1a13f7b103a9f295c9732a035ee4bf98dad8e50eb481ea63b",
					"size": 390,
					"sourceHash": "cdb03d8f2ea6efe7f770ef775672b17647f7d323a1a98f3464b3226f43f3953d",
					"status": "content"
				},
				"lib/protocol/packets/ResultSetHeaderPacket.js": {
					"diff": "--- published/lib/protocol/packets/ResultSetHeaderPacket.js\n+++ rebuilt/lib/protocol/packets/ResultSetHeaderPacket.js\n@@ -3,23 +3,12 @@\n   options = options || {};\n \n   this.fieldCount = options.fieldCount;\n-  this.extra      = options.extra;\n }\n \n ResultSetHeaderPacket.prototype.parse = function(parser) {\n   this.fieldCount = parser.parseLengthCodedNumber();\n-\n-  if (parser.reachedPacketEnd()) return;\n-\n-  this.extra = (this.fieldCount === null)\n-    ? parser.parsePacketTerminatedString()\n-    : parser.parseLengthCodedNumber();\n };\n \n ResultSetHeaderPacket.prototype.write = function(writer) {\n   writer.writeLengthCodedNumber(this.fieldCount);\n-\n-  if (this.extra !== undefined) {\n-    writer.writeLengthCodedNumber(this.extra);\n-  }\n };\n",
					"match": false,
					"packageHash": "5f4892e9f983f29c4a6075e171850f85773c1b23e2948d54e80407effd49a09d",
					"size": 669,
					"sourceHash": "f247639d388cc9749f8be654e0ed8eff09cccdefc61b1e71770b88667b817d0f",
					"status": "content"
				},
				"lib/protocol/packets/RowDataPacket.js": {
					"diff": "--- published/lib/protocol/packets/RowDataPacket.js\n+++ rebuilt/lib/protocol/packets/RowDataPacket.js\n@@ -7,7 +7,19 @@\n function RowDataPacket() {\n }\n \n-RowDataPacket.prototype.parse = function(parser, fieldPackets, typeCast, nestTables, connection) {\n+Object.defineProperty(RowDataPacket.prototype, 'parse', {\n+  configurable : true,\n+  enumerable   : false,\n+  value        : parse\n+});\n+\n+Object.defineProperty(RowDataPacket.prototype, '_typeCast', {\n+  configurable : true,\n+  enumerable   : false,\n+  value        : typeCast\n+});\n+\n+function parse(parser, fieldPackets, typeCast, nestTables, connection) {\n   var self = this;\n   var next = function () {\n     return self._typeCast(fieldPacket, parser, connection.config.timezone, connection.config.supportBigNumbers, connection.config.bigNumberStrings, connection.config.dateStrings);\n@@ -17,7 +29,7 @@\n     var fieldPacket = fieldPackets[i];\n     var value;\n \n-    if (typeof typeCast == \"function\") {\n+    if (typeof typeCast === 'function') {\n       value = typeCast.apply(connection, [ new Field({ packet: fieldPacket, parser: parser }), next ]);\n     } else {\n       value = (typeCast)\n@@ -27,7 +39,7 @@\n           : parser.parseLengthCodedString() );\n     }\n \n-    if (typeof nestTables == \"string\" && nestTables.length) {\n+    if (typeof nestTables === 'string' && nestTables.length) {\n       this[fieldPacket.table + nestTables + fieldPacket.name] = value;\n     } else if (nestTables) {\n       this[fieldPacket.table] = this[fieldPacket.table] || {};\n@@ -36,21 +48,23 @@\n       this[fieldPacket.name] = value;\n     }\n   }\n-};\n+}\n \n-RowDataPacket.prototype._typeCast = function(field, parser, timeZone, supportBigNumbers, bigNumberStrings, dateStrings) {\n+function typeCast(field, parser, timeZone, supportBigNumbers, bigNumberStrings, dateStrings) {\n   var numberString;\n \n   switch (field.type) {\n     case Types.TIMESTAMP:\n+    case Types.TIMESTAMP2:\n     case Types.DATE:\n     case Types.DATETIME:\n+    case Types.DATETIME2:\n     case Types.NEWDATE:\n       var dateString = parser.parseLengthCodedString();\n-      if (dateStrings) {\n-          return dateString;\n+\n+      if (typeMatch(field.type, dateStrings)) {\n+        return dateString;\n       }\n-      var dt;\n \n       if (dateString === null) {\n         return null;\n@@ -65,7 +79,7 @@\n         dateString += ' ' + timeZone;\n       }\n \n-      dt = new Date(dateString);\n+      var dt = new Date(dateString);\n       if (isNaN(dt.getTime())) {\n         return originalString;\n       }\n@@ -79,14 +93,14 @@\n     case Types.FLOAT:\n     case Types.DOUBLE:\n       numberString = parser.parseLengthCodedString();\n-      return (numberString === null || (field.zeroFill && numberString[0] == \"0\"))\n+      return (numberString === null || (field.zeroFill && numberString[0] === '0'))\n         ? numberString : Number(numberString);\n     case Types.NEWDECIMAL:\n     case Types.LONGLONG:\n       numberString = parser.parseLengthCodedString();\n-      return (numberString === null || (field.zeroFill && numberString[0] == \"0\"))\n+      return (numberString === null || (field.zeroFill && numberString[0] === '0'))\n         ? numberString\n-        : ((supportBigNumbers && (bigNumberStrings || (Number(numberString) > IEEE_754_BINARY_64_PRECISION)))\n+        : ((supportBigNumbers && (bigNumberStrings || (Number(numberString) >= IEEE_754_BINARY_64_PRECISION) || Number(numberString) <= -IEEE_754_BINARY_64_PRECISION))\n           ? numberString\n           : Number(numberString));\n     case Types.BIT:\n@@ -105,4 +119,12 @@\n     default:\n       return parser.parseLengthCodedString();\n",
					"match": false,
					"packageHash": "00d31e2f8f6f01ca63f9858ee938b53d0379461b85ab705f942551fbacc5ac2c",
					"size": 3592,
					"sourceHash": "0ad21f19108232a802d1736d79e16d06e1e027244560c7c6d80957244c342cba",
					"status": "content"
				},
				"lib/protocol/packets/index.js": {
					"diff": "--- published/lib/protocol/packets/index.js\n+++ rebuilt/lib/protocol/packets/index.js\n@@ -1,4 +1,23 @@\n-var Elements = module.exports = require('require-all')({\n-  dirname : __dirname,\n-  filter  : /([A-Z].+)\\.js$/,\n-});\n+exports.AuthSwitchRequestPacket = require('./AuthSwitchRequestPacket');\n+exports.AuthSwitchResponsePacket = require('./AuthSwitchResponsePacket');\n+exports.ClientAuthenticationPacket = require('./ClientAuthenticationPacket');\n+exports.ComChangeUserPacket = require('./ComChangeUserPacket');\n+exports.ComPingPacket = require('./ComPingPacket');\n+exports.ComQueryPacket = require('./ComQueryPacket');\n+exports.ComQuitPacket = require('./ComQuitPacket');\n+exports.ComStatisticsPacket = require('./ComStatisticsPacket');\n+exports.EmptyPacket = require('./EmptyPacket');\n+exports.EofPacket = require('./EofPacket');\n+exports.ErrorPacket = require('./ErrorPacket');\n+exports.Field = require('./Field');\n+exports.FieldPacket = require('./FieldPacket');\n+exports.HandshakeInitializationPacket = require('./HandshakeInitializationPacket');\n+exports.LocalDataFilePacket = require('./LocalDataFilePacket');\n+exports.LocalInfileRequestPacket = require('./LocalInfileRequestPacket');\n+exports.OkPacket = require('./OkPacket');\n+exports.OldPasswordPacket = require('./OldPasswordPacket');\n+exports.ResultSetHeaderPacket = require('./ResultSetHeaderPacket');\n+exports.RowDataPacket = require('./RowDataPacket');\n+exports.SSLRequestPacket = require('./SSLRequestPacket');\n+exports.StatisticsPacket = require('./StatisticsPacket');\n+exports.UseOldPasswordPacket = require('./UseOldPasswordPacket');\n",
					"match": false,
					"packageHash": "890dfb1be4aedd62952bc07467409f6679cd9150dfc34d67ea086b6b457ead8a",
					"size": 114,
					"sourceHash": "229061af33bd9b6d5925ea9f69282d8330509514fcf1597bba0cba5f2485aace",
					"status": "content"
				},
				"lib/protocol/sequences/.ChangeUser.js.un~": {
					"match": false,
					"packageHash": "935371a8c73b8a946ad207e6cefa874413f8ecc9d255176dd5214d4217f82ac6",
					"size": 48893,
					"status": "missing-in-source"
				},
				"lib/protocol/sequences/.Prepare.js.un~": {
					"match": false,
					"packageHash": "8ade1566b8922a25f4397a92d3ff35c27c5da4fe429a0f0238a74b464fda2112",
					"size": 82788,
					"status": "missing-in-source"
				},
				"lib/protocol/sequences/.PreparedQuery.js.un~": {
					"match": false,
					"packageHash": "1236e0ad29ce5676f837a42e4ea8909e6ce3c36f3a2cae76b4d8ba5b92472bd5",
					"size": 71855,
					"status": "missing-in-source"
				},
				"lib/protocol/sequences/.Query.js.un~": {
					"match": false,
					"packageHash": "ed8f95ad998eabb8e2171b220b01f90cbfbc5473ff3b674902ac874aaa8059eb",
					"size": 33977,
					"status": "missing-in-source"
				},
				"lib/protocol/sequences/.Sequence.js.un~": {
					"match": false,
					"packageHash": "20ca81f0e884d0c0fd83abcd7b926790002de2cb27fd9e3aacc7bec2260884ed",
					"size": 41887,
					"status": "missing-in-source"
				},
				"lib/protocol/sequences/.Statement.js.un~": {
					"match": false,
					"packageHash": "fd4b038aaa99cae6e045196ca9225cfe56e7da8ea48ab252f3ed831062788e1b",
					"size": 14774,
					"status": "missing-in-source"
				},
				"lib/protocol/sequences/ChangeUser.js": {
					"diff": "--- published/lib/protocol/sequences/ChangeUser.js\n+++ rebuilt/lib/protocol/sequences/ChangeUser.js\n@@ -6,7 +6,7 @@\n module.exports = ChangeUser;\n Util.inherits(ChangeUser, Sequence);\n function ChangeUser(options, callback) {\n-  Sequence.call(this, callback);\n+  Sequence.call(this, options, callback);\n \n   this._user          = options.user;\n   this._password      = options.password;\n@@ -15,6 +15,14 @@\n   this._currentConfig = options.currentConfig;\n }\n \n+ChangeUser.prototype.determinePacket = function determinePacket(firstByte) {\n+  switch (firstByte) {\n+    case 0xfe: return Packets.AuthSwitchRequestPacket;\n+    case 0xff: return Packets.ErrorPacket;\n+    default: return undefined;\n+  }\n+};\n+\n ChangeUser.prototype.start = function(handshakeInitializationPacket) {\n   var scrambleBuff = handshakeInitializationPacket.scrambleBuff();\n   scrambleBuff     = Auth.token(this._password, scrambleBuff);\n@@ -23,7 +31,7 @@\n     user          : this._user,\n     scrambleBuff  : scrambleBuff,\n     database      : this._database,\n-    charsetNumber : this._charsetNumber,\n+    charsetNumber : this._charsetNumber\n   });\n \n   this._currentConfig.user          = this._user;\n@@ -34,6 +42,24 @@\n   this.emit('packet', packet);\n };\n \n+ChangeUser.prototype['AuthSwitchRequestPacket'] = function (packet) {\n+  var name = packet.authMethodName;\n+  var data = Auth.auth(name, packet.authMethodData, {\n+    password: this._password\n+  });\n+\n+  if (data !== undefined) {\n+    this.emit('packet', new Packets.AuthSwitchResponsePacket({\n+      data: data\n+    }));\n+  } else {\n+    var err   = new Error('MySQL is requesting the ' + name + ' authentication method, which is not supported.');\n+    err.code  = 'UNSUPPORTED_AUTH_METHOD';\n+    err.fatal = true;\n+    this.end(err);\n+  }\n+};\n+\n ChangeUser.prototype['ErrorPacket'] = function(packet) {\n   var err = this._packetToError(packet);\n   err.fatal = true;\n",
					"match": false,
					"packageHash": "26c2a4a777f1e180c7f490727515351f66f9290ba1b1c179a237165d96c163a7",
					"size": 1296,
					"sourceHash": "60e41b01488e01d4cf246496cee31f24774709a0584c4bd68a659d640d44dcf1",
					"status": "content"
				},
				"lib/protocol/sequences/Handshake.js": {
					"diff": "--- published/lib/protocol/sequences/Handshake.js\n+++ rebuilt/lib/protocol/sequences/Handshake.js\n@@ -1,18 +1,21 @@\n-var Sequence = require('./Sequence');\n-var Util     = require('util');\n-var Packets  = require('../packets');\n-var Auth     = require('../Auth');\n+var Sequence        = require('./Sequence');\n+var Util            = require('util');\n+var Packets         = require('../packets');\n+var Auth            = require('../Auth');\n+var ClientConstants = require('../constants/client');\n \n module.exports = Handshake;\n Util.inherits(Handshake, Sequence);\n-function Handshake(config, callback) {\n-  Sequence.call(this, callback);\n+function Handshake(options, callback) {\n+  Sequence.call(this, options, callback);\n \n-  this._config                        = config;\n+  options = options || {};\n+\n+  this._config                        = options.config;\n   this._handshakeInitializationPacket = null;\n }\n \n-Handshake.prototype.determinePacket = function(firstByte) {\n+Handshake.prototype.determinePacket = function determinePacket(firstByte, parser) {\n   if (firstByte === 0xff) {\n     return Packets.ErrorPacket;\n   }\n@@ -22,7 +25,29 @@\n   }\n \n   if (firstByte === 0xfe) {\n-    return Packets.UseOldPasswordPacket;\n+    return (parser.packetLength() === 1)\n+      ? Packets.UseOldPasswordPacket\n+      : Packets.AuthSwitchRequestPacket;\n+  }\n+\n+  return undefined;\n+};\n+\n+Handshake.prototype['AuthSwitchRequestPacket'] = function (packet) {\n+  var name = packet.authMethodName;\n+  var data = Auth.auth(name, packet.authMethodData, {\n+    password: this._config.password\n+  });\n+\n+  if (data !== undefined) {\n+    this.emit('packet', new Packets.AuthSwitchResponsePacket({\n+      data: data\n+    }));\n+  } else {\n+    var err   = new Error('MySQL is requesting the ' + name + ' authentication method, which is not supported.');\n+    err.code  = 'UNSUPPORTED_AUTH_METHOD';\n+    err.fatal = true;\n+    this.end(err);\n   }\n };\n \n@@ -31,23 +56,54 @@\n \n   this._config.protocol41 = packet.protocol41;\n \n+  var serverSSLSupport = packet.serverCapabilities1 & ClientConstants.CLIENT_SSL;\n+\n+  if (this._config.ssl) {\n+    if (!serverSSLSupport) {\n+      var err = new Error('Server does not support secure connection');\n+\n+      err.code = 'HANDSHAKE_NO_SSL_SUPPORT';\n+      err.fatal = true;\n+\n+      this.end(err);\n+      return;\n+    }\n+\n+    this._config.clientFlags |= ClientConstants.CLIENT_SSL;\n+    this.emit('packet', new Packets.SSLRequestPacket({\n+      clientFlags   : this._config.clientFlags,\n+      maxPacketSize : this._config.maxPacketSize,\n+      charsetNumber : this._config.charsetNumber\n+    }));\n+    this.emit('start-tls');\n+  } else {\n+    this._sendCredentials();\n+  }\n+};\n+\n+Handshake.prototype._tlsUpgradeCompleteHandler = function() {\n+  this._sendCredentials();\n+};\n+\n+Handshake.prototype._sendCredentials = function() {\n+  var packet = this._handshakeInitializationPacket;\n   this.emit('packet', new Packets.ClientAuthenticationPacket({\n     clientFlags   : this._config.clientFlags,\n",
					"match": false,
					"packageHash": "21b196010209a2e7e970f458aeb44c403743ab875bb0b2ff4a34b39ef518f237",
					"size": 2106,
					"sourceHash": "666be1a9bae08effbe8bf33eb31af48b902a11e18f3d68a8cb9eb0ddca42901b",
					"status": "content"
				},
				"lib/protocol/sequences/Ping.js": {
					"diff": "--- published/lib/protocol/sequences/Ping.js\n+++ rebuilt/lib/protocol/sequences/Ping.js\n@@ -5,10 +5,15 @@\n module.exports = Ping;\n Util.inherits(Ping, Sequence);\n \n-function Ping(callback) {\n-  Sequence.call(this, callback);\n+function Ping(options, callback) {\n+  if (!callback && typeof options === 'function') {\n+    callback = options;\n+    options = {};\n+  }\n+\n+  Sequence.call(this, options, callback);\n }\n \n Ping.prototype.start = function() {\n-  this.emit('packet', new Packets.ComPingPacket);\n+  this.emit('packet', new Packets.ComPingPacket());\n };\n",
					"match": false,
					"packageHash": "90b48ac49a2b39d2ecc9f312bf0e102c37a28beddc0b5d13b037a95b87516534",
					"size": 315,
					"sourceHash": "15eb36209ad6d7eab7da86d6681dcc77536381905de767e47dc69df0bf512a07",
					"status": "content"
				},
				"lib/protocol/sequences/Query.js": {
					"diff": "--- published/lib/protocol/sequences/Query.js\n+++ rebuilt/lib/protocol/sequences/Query.js\n@@ -1,15 +1,16 @@\n-var Sequence     = require('./Sequence');\n-var Util         = require('util');\n-var Packets      = require('../packets');\n-var ResultSet    = require('../ResultSet');\n-var ServerStatus = require('../constants/server_status');\n-var fs           = require('fs');\n-var Readable     = require('stream').Readable;\n+var ClientConstants = require('../constants/client');\n+var fs              = require('fs');\n+var Packets         = require('../packets');\n+var ResultSet       = require('../ResultSet');\n+var Sequence        = require('./Sequence');\n+var ServerStatus    = require('../constants/server_status');\n+var Readable        = require('readable-stream');\n+var Util            = require('util');\n \n module.exports = Query;\n Util.inherits(Query, Sequence);\n function Query(options, callback) {\n-  Sequence.call(this, callback);\n+  Sequence.call(this, options, callback);\n \n   this.sql = options.sql;\n   this.values = options.values;\n@@ -29,38 +30,33 @@\n   this.emit('packet', new Packets.ComQueryPacket(this.sql));\n };\n \n-Query.prototype.determinePacket = function(firstByte, parser) {\n-  if (firstByte === 0) {\n-    // If we have a resultSet and got one eofPacket\n-    if (this._resultSet && this._resultSet.eofPackets.length === 1) {\n-      // Then this is a RowDataPacket with an empty string in the first column.\n-      // See: https://github.com/felixge/node-mysql/issues/222\n-    } else if (this._resultSet && this._resultSet.resultSetHeaderPacket\n-           && this._resultSet.resultSetHeaderPacket.fieldCount !== null) {\n-      return Packets.FieldPacket;\n-    } else {\n-      return;\n+Query.prototype.determinePacket = function determinePacket(byte, parser) {\n+  var resultSet = this._resultSet;\n+\n+  if (!resultSet) {\n+    switch (byte) {\n+      case 0x00: return Packets.OkPacket;\n+      case 0xfb: return Packets.LocalInfileRequestPacket;\n+      case 0xff: return Packets.ErrorPacket;\n+      default:   return Packets.ResultSetHeaderPacket;\n     }\n   }\n \n-  if (firstByte === 255) {\n-    return;\n+  if (resultSet.eofPackets.length === 0) {\n+    return (resultSet.fieldPackets.length < resultSet.resultSetHeaderPacket.fieldCount)\n+      ? Packets.FieldPacket\n+      : Packets.EofPacket;\n   }\n \n-  // EofPacket's are 5 bytes in mysql >= 4.1\n-  // This is the only / best way to differentiate their firstByte from a 9\n-  // byte length coded binary.\n-  if (firstByte === 0xfe && parser.packetLength() < 9) {\n-    return Packets.EofPacket;\n+  if (byte === 0xff) {\n+    return Packets.ErrorPacket;\n   }\n \n-  if (!this._resultSet) {\n-    return Packets.ResultSetHeaderPacket;\n+  if (byte === 0xfe && parser.packetLength() < 9) {\n+    return Packets.EofPacket;\n   }\n \n-  return (this._resultSet.eofPackets.length === 0)\n-    ? Packets.FieldPacket\n-    : Packets.RowDataPacket;\n+  return Packets.RowDataPacket;\n };\n \n Query.prototype['OkPacket'] = function(packet) {\n@@ -74,6 +70,7 @@\n     }\n   } finally {\n     this._index++;\n+    this._resultSet = null;\n     this._handleFinalResultPacket(packet);\n   }\n };\n@@ -90,18 +87,27 @@\n     : undefined;\n \n   err.index = this._index;\n+  err.sql   = this.sql;\n+\n   this.end(err, results, fields);\n };\n",
					"match": false,
					"packageHash": "94fecf52f5d5079049516e5355ba60dd8cc644fae9b25ba3790f803d2328c5d1",
					"size": 5110,
					"sourceHash": "0939afd10b3a0f053a039ed361869e0bb2501b5ba7ce979613527871767fccd3",
					"status": "content"
				},
				"lib/protocol/sequences/Quit.js": {
					"diff": "--- published/lib/protocol/sequences/Quit.js\n+++ rebuilt/lib/protocol/sequences/Quit.js\n@@ -4,10 +4,37 @@\n \n module.exports = Quit;\n Util.inherits(Quit, Sequence);\n-function Quit(callback) {\n-  Sequence.call(this, callback);\n+function Quit(options, callback) {\n+  if (!callback && typeof options === 'function') {\n+    callback = options;\n+    options = {};\n+  }\n+\n+  Sequence.call(this, options, callback);\n+\n+  this._started = false;\n }\n \n+Quit.prototype.end = function end(err) {\n+  if (this._ended) {\n+    return;\n+  }\n+\n+  if (!this._started) {\n+    Sequence.prototype.end.call(this, err);\n+    return;\n+  }\n+\n+  if (err && err.code === 'ECONNRESET' && err.syscall === 'read') {\n+    // Ignore read errors after packet sent\n+    Sequence.prototype.end.call(this);\n+    return;\n+  }\n+\n+  Sequence.prototype.end.call(this, err);\n+};\n+\n Quit.prototype.start = function() {\n-  this.emit('packet', new Packets.ComQuitPacket);\n+  this._started = true;\n+  this.emit('packet', new Packets.ComQuitPacket());\n };\n",
					"match": false,
					"packageHash": "758f94465ba64d0c86e1cf1c96796b932526a6b55140f3b7816d79d7fff46ab9",
					"size": 314,
					"sourceHash": "98393359a3246d3d5da66579ce1e9a4d4e7f71fc9dca9e2a09e72767e95b2250",
					"status": "content"
				},
				"lib/protocol/sequences/Sequence.js": {
					"diff": "--- published/lib/protocol/sequences/Sequence.js\n+++ rebuilt/lib/protocol/sequences/Sequence.js\n@@ -2,17 +2,31 @@\n var EventEmitter   = require('events').EventEmitter;\n var Packets        = require('../packets');\n var ErrorConstants = require('../constants/errors');\n+var Timer          = require('../Timer');\n+\n+// istanbul ignore next: Node.js < 0.10 not covered\n+var listenerCount = EventEmitter.listenerCount\n+  || function(emitter, type){ return emitter.listeners(type).length; };\n+\n+var LONG_STACK_DELIMITER = '\\n    --------------------\\n';\n \n module.exports = Sequence;\n Util.inherits(Sequence, EventEmitter);\n-function Sequence(callback) {\n+function Sequence(options, callback) {\n+  if (typeof options === 'function') {\n+    callback = options;\n+    options = {};\n+  }\n+\n   EventEmitter.call(this);\n \n-  this._callback         = callback;\n-  this._ended            = false;\n+  options = options || {};\n \n-  // Experimental: Long stack trace support\n-  this._callSite = new Error;\n+  this._callback = callback;\n+  this._callSite = null;\n+  this._ended    = false;\n+  this._timeout  = options.timeout;\n+  this._timer    = new Timer(this);\n }\n \n Sequence.determinePacket = function(byte) {\n@@ -20,11 +34,12 @@\n     case 0x00: return Packets.OkPacket;\n     case 0xfe: return Packets.EofPacket;\n     case 0xff: return Packets.ErrorPacket;\n+    default:   return undefined;\n   }\n };\n \n Sequence.prototype.hasErrorHandler = function() {\n-  return this._callback || this.listeners('error').length > 1;\n+  return Boolean(this._callback) || listenerCount(this, 'error') > 1;\n };\n \n Sequence.prototype._packetToError = function(packet) {\n@@ -32,18 +47,11 @@\n   var err  = new Error(code + ': ' + packet.message);\n   err.code = code;\n   err.errno = packet.errno;\n-  err.sqlState = packet.sqlState;\n-\n-  return err;\n-};\n \n-Sequence.prototype._addLongStackTrace = function(err) {\n-  var delimiter = '\\n    --------------------\\n' ;\n-  if (err.stack.indexOf(delimiter) > -1) {\n-    return;\n-  }\n+  err.sqlMessage = packet.message;\n+  err.sqlState   = packet.sqlState;\n \n-  err.stack += delimiter + this._callSite.stack.replace(/.+\\n/, '');\n+  return err;\n };\n \n Sequence.prototype.end = function(err) {\n@@ -62,7 +70,7 @@\n   // causes a cyclic reference that the GC does not detect properly, but I was\n   // unable to produce a standalone version of this leak. This would be a great\n   // challenge for somebody interested in difficult problems : )!\n-  delete this._callSite;\n+  this._callSite = null;\n \n   // try...finally for exception safety\n   try {\n@@ -90,3 +98,28 @@\n \n // Implemented by child classes\n Sequence.prototype.start = function() {};\n+\n+Sequence.prototype._addLongStackTrace = function _addLongStackTrace(err) {\n+  var callSiteStack = this._callSite && this._callSite.stack;\n+\n+  if (!callSiteStack || typeof callSiteStack !== 'string') {\n+    // No recorded call site\n+    return;\n+  }\n+\n+  if (err.stack.indexOf(LONG_STACK_DELIMITER) !== -1) {\n+    // Error stack already looks long\n+    return;\n",
					"match": false,
					"packageHash": "6d1d46cbd650f426303fc61525cdd5ca95584051a926318a0f742f9eb10a0fbd",
					"size": 2370,
					"sourceHash": "a92b164745514693ec97a3685f0281c1e118da1c7b43afaf7f56a9c0826c3961",
					"status": "content"
				},
				"lib/protocol/sequences/Statistics.js": {
					"diff": "--- published/lib/protocol/sequences/Statistics.js\n+++ rebuilt/lib/protocol/sequences/Statistics.js\n@@ -4,20 +4,27 @@\n \n module.exports = Statistics;\n Util.inherits(Statistics, Sequence);\n-function Statistics(callback) {\n-  Sequence.call(this, callback);\n+function Statistics(options, callback) {\n+  if (!callback && typeof options === 'function') {\n+    callback = options;\n+    options = {};\n+  }\n+\n+  Sequence.call(this, options, callback);\n }\n \n Statistics.prototype.start = function() {\n-  this.emit('packet', new Packets.ComStatisticsPacket);\n+  this.emit('packet', new Packets.ComStatisticsPacket());\n };\n \n Statistics.prototype['StatisticsPacket'] = function (packet) {\n   this.end(null, packet);\n };\n \n-Statistics.prototype.determinePacket = function(firstByte, parser) {\n+Statistics.prototype.determinePacket = function determinePacket(firstByte) {\n   if (firstByte === 0x55) {\n     return Packets.StatisticsPacket;\n   }\n+\n+  return undefined;\n };\n",
					"match": false,
					"packageHash": "4d68f7d14b2729d523661aeb0ed1f4cb402a37788db5af2ecbdcc808a11d54c9",
					"size": 579,
					"sourceHash": "a5c90ecab78d6bc5081098f09a798d913f2a1339e2143b0d272dab59b959d019",
					"status": "content"
				},
				"lib/protocol/sequences/index.js": {
					"diff": "--- published/lib/protocol/sequences/index.js\n+++ rebuilt/lib/protocol/sequences/index.js\n@@ -1,4 +1,7 @@\n-var Elements = module.exports = require('require-all')({\n-  dirname : __dirname,\n-  filter  : /([A-Z].+)\\.js$/,\n-});\n+exports.ChangeUser = require('./ChangeUser');\n+exports.Handshake = require('./Handshake');\n+exports.Ping = require('./Ping');\n+exports.Query = require('./Query');\n+exports.Quit = require('./Quit');\n+exports.Sequence = require('./Sequence');\n+exports.Statistics = require('./Statistics');\n",
					"match": false,
					"packageHash": "890dfb1be4aedd62952bc07467409f6679cd9150dfc34d67ea086b6b457ead8a",
					"size": 114,
					"sourceHash": "d913b9e2c73ad64132b949d7d09ddb56256097be9d2d45b6b1d2d4e319916237",
					"status": "content"
				},
				"make.bat": {
					"match": false,
					"packageHash": "f67a8d7caa267e52c1e50081148b1047eab0232186d7b75882de0b0d416aee98",
					"size": 1031,
					"status": "missing-in-source"
				},
				"package.json": {
					"diff": "--- published/package.json\n+++ rebuilt/package.json\n@@ -1,27 +1,45 @@\n {\n-  \"author\": \"Felix Geisendrfer <felix@debuggable.com> (http://debuggable.com/)\",\n   \"name\": \"mysql\",\n   \"description\": \"A node.js driver for mysql. It is written in JavaScript, does not require compiling, and is 100% MIT licensed.\",\n-  \"version\": \"2.0.0-rc1\",\n-  \"repository\": {\n-    \"type\": \"git\",\n-    \"url\": \"https://github.com/felixge/node-mysql\"\n-  },\n-  \"main\": \"./index\",\n-  \"scripts\": {\n-    \"test\": \"make test\"\n-  },\n-  \"engines\": {\n-    \"node\": \"*\"\n-  },\n+  \"version\": \"2.18.1\",\n+  \"license\": \"MIT\",\n+  \"author\": \"Felix Geisendrfer <felix@debuggable.com> (http://debuggable.com/)\",\n+  \"contributors\": [\n+    \"Andrey Sidorov <sidorares@yandex.ru>\",\n+    \"Bradley Grainger <bgrainger@gmail.com>\",\n+    \"Douglas Christopher Wilson <doug@somethingdoug.com>\",\n+    \"Diogo Resende <dresende@thinkdigital.pt>\",\n+    \"Nathan Woltman <nwoltman@outlook.com>\"\n+  ],\n+  \"repository\": \"mysqljs/mysql\",\n   \"dependencies\": {\n-    \"require-all\": \"0.0.3\",\n-    \"bignumber.js\": \"1.0.1\"\n+    \"bignumber.js\": \"9.0.2\",\n+    \"readable-stream\": \"2.3.7\",\n+    \"safe-buffer\": \"5.2.1\",\n+    \"sqlstring\": \"2.3.3\"\n   },\n   \"devDependencies\": {\n-    \"utest\": \"0.0.6\",\n-    \"urun\": \"0.0.6\",\n-    \"underscore\": \"1.3.1\"\n+    \"after\": \"0.8.2\",\n+    \"eslint\": \"7.32.0\",\n+    \"seedrandom\": \"3.0.5\",\n+    \"urun\": \"0.0.8\",\n+    \"utest\": \"0.0.8\"\n   },\n-  \"optionalDependencies\": {}\n+  \"files\": [\n+    \"lib/\",\n+    \"Changes.md\",\n+    \"License\",\n+    \"Readme.md\",\n+    \"index.js\"\n+  ],\n+  \"engines\": {\n+    \"node\": \">= 0.6\"\n+  },\n+  \"scripts\": {\n+    \"lint\": \"eslint . && node tool/lint-readme.js\",\n+    \"test\": \"node test/run.js\",\n+    \"test-ci\": \"node tool/install-nyc.js --nyc-optional --reporter=lcovonly --reporter=text -- npm test\",\n+    \"test-cov\": \"node tool/install-nyc.js --reporter=html --reporter=text -- npm test\",\n+    \"version\": \"node tool/version-changes.js && git add Changes.md\"\n+  }\n }\n",
					"match": false,
					"packageHash": "cdbd627bdca8f58db4bb1cd7ec5a2a2285e52d6006c023c0722fb12f8aada465",
					"size": 664,
					"sourceHash": "8e82dfb6760f23da8b83543eac5823415505ae00550db3a661b6eb460723b3d9",
					"status": "content"
				},
				"tool/.generate-charset-constants.js.un~": {
					"match": false,
					"packageHash": "86120c5516c6a4a0f2247b90191acaab07f3eff5516036f974ea489fe73270aa",
					"size": 52334,
					"status": "missing-in-source"
				},
				"tool/.generate-error-constants.js.un~": {
					"match": false,
					"packageHash": "cd1409ad5ec8d32db641e838407e8f7beaa3802f496dc980dad8a55f47017224",
					"size": 115328,
					"status": "missing-in-source"
				},
				"tool/generate-error-constants.js": {
					"match": false,
					"packageHash": "a63e8db19c1eb2b68d5eb240108f2b7c60501f5779e588b28efad2d266ec0aed",
					"size": 793,
					"status": "missing-in-source"
				},
				"lib/PoolNamespace.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/PoolSelector.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/protocol/BufferList.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/protocol/Timer.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/protocol/constants/ssl_profiles.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/protocol/packets/AuthSwitchRequestPacket.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/protocol/packets/AuthSwitchResponsePacket.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/protocol/packets/LocalInfileRequestPacket.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/protocol/packets/SSLRequestPacket.js": {
					"match": false,
					"status": "missing-in-package"
				}
			},
			"summary": {
				"differentFiles": 42,
				"matchingFiles": 10,
				"missingInPackage": 9,
				"missingInSource": 69,
				"score": 0.07692307692307693,
				"totalFiles": 130
			}
		}
	}
]
