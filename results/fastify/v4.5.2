[
	{
		"reproduceVersion": "0.0.0-local",
		"timestamp": "2026-01-01T14:52:45.375Z",
		"os": "linux",
		"arch": "x64",
		"strategy": "npm:8.11.0",
		"reproduced": false,
		"attested": false,
		"package": {
			"spec": "fastify@4.5.2",
			"name": "fastify",
			"version": "4.5.2",
			"location": "https://registry.npmjs.org/fastify/-/fastify-4.5.2.tgz",
			"integrity": "sha512-cDLhc0bh1ftzMoS7ccGGPUW/xTUnk6I51TktQqKFeJnhoAfk56tfn+xDs8JcJYfouPK23Ljx4OpMaEi+kIDwEg==",
			"publishedAt": "2022-08-18T14:27:24.402Z",
			"publishedWith": {
				"node": "16.15.1",
				"npm": "8.17.0"
			}
		},
		"source": {
			"integrity": null,
			"location": "git+https://github.com/fastify/fastify.git",
			"spec": "github:fastify/fastify#de2d76a755040a706513fc31bb4a9e126b6380bd"
		},
		"comparisonHash": "8a2a8dcbb729bf3ee9216e490c955701f0ddebe1",
		"diff": {
			"files": {
				".eslintrc": {
					"match": false,
					"packageHash": "8034ab06fa73ec173f17ae13e15a493ee19ecd62cde9a138af1accbd3f5ef5d7",
					"size": 44,
					"status": "missing-in-source"
				},
				".markdownlint-cli2.yaml": {
					"diff": "--- published/.markdownlint-cli2.yaml\n+++ rebuilt/.markdownlint-cli2.yaml\n@@ -7,7 +7,7 @@\n   MD013:\n     line_length: 80\n     code_block_line_length: 120\n-    headers: false\n+    headings: false\n     tables: false\n     strict: false\n     stern: false\n",
					"match": false,
					"packageHash": "9d6222c6a06a681f9b6ed4dbe6f927e0b18dcbc2e5d8ed7873fef3bf6470d07c",
					"size": 363,
					"sourceHash": "d6a5d04b12579516c91bd237ccba54c44c8d67743a05b9fbf3ac7c198fe58dfd",
					"status": "content"
				},
				".taprc": {
					"match": false,
					"packageHash": "965466ccf6e6dbe216e3ed4681beb3dd3841b597d88ed35cd09e23dd5c56b9e7",
					"size": 134,
					"status": "missing-in-source"
				},
				"GOVERNANCE.md": {
					"diff": "--- published/GOVERNANCE.md\n+++ rebuilt/GOVERNANCE.md\n@@ -1,105 +1,4 @@\n # Fastify Project Governance\n \n-<!-- TOC -->\n-\n-* [Lead Maintainers](#lead-maintainers)\n-* [Collaborators](#collaborators)\n-  * [Collaborator activities](#collaborator-activities)\n-* [Great Contributors](#great-contributors)\n-* [Collaborator nominations](#collaborator-maintainers-nominations)\n-* [Lead Maintainers nominations](#lead-maintainers-nominations)\n-* [Consensus seeking process](#consensus-seeking-process)\n-\n-<!-- /TOC -->\n-\n-## Lead Maintainers\n-\n-Fastify Lead Maintainers are the founder of the project and the organization\n-owners. They are the only members of the `@fastify/leads` team. The Lead\n-Maintainers are the curator of the Fastify project and their key responsibility\n-is to issue releases of Fastify and its dependencies.\n-\n-## Collaborators\n-\n-Fastify Collaborators maintain the projects of the Fastify organization.\n-\n-They are split into the following teams:\n-\n-|  Team | Responsibility  |  Repository |\n-|---|---|---|\n-| `@fastify/leads` | Fastify Lead Maintainers | GitHub organization owners |\n-| `@fastify/core`   |  Fastify Core development  |  `fastify`, `fast-json-stringify`, `light-my-request`, `fastify-plugin`, `middie` |\n-| `@fastify/plugins`   |  Build, maintain and release Fastify plugins  |  All plugins repositories |\n-| `@fastify/benchmarks`   |  Build and maintain our benchmarks suite  |  `benchmarks` |\n-| `@fastify/docs-chinese`   |  Translate the Fastify documentation in Chinese  |  `docs-chinese` |\n-\n-Every member of the org is also part of `@fastify/fastify`.\n-\n-Collaborators have:\n-\n-* Commit access to the projects repository of the team they belong\n- * Grant to release new versions of the project\n-\n-Both Collaborators and non-Collaborators may propose changes to the source code\n-of the projects of the organization. The mechanism to propose such a change is a\n-GitHub pull request. Collaborators review and merge (_land_) pull requests\n-following the [CONTRIBUTING](CONTRIBUTING.md#rules) guidelines.\n-\n-### Collaborator activities\n-\n-* Helping users and novice contributors\n-* Contributing code and documentation changes that improve the project\n-* Reviewing and commenting on issues and pull requests\n-* Participation in working groups\n-* Merging pull requests\n-* Release plugins\n-\n-The Lead Maintainers can remove inactive Collaborators or provide them with\n-_Past Collaborators_ status. Past Collaborators may request that the Lead\n-Maintainers restore them to active status.\n-\n-\n-## Great Contributors\n-\n-Great contributors on a specific area in the Fastify ecosystem will be invited\n-to join this group by Lead Maintainers. This group has the same permissions of a\n-contributor.\n-\n-## Collaborator nominations\n-\n-Individuals making significant and valuable contributions to the project may be\n-a candidate to join the Fastify organization.\n-\n-A Collaborator needs to open a private team discussion on GitHub and list the\n-candidates they want to sponsor with a link to the user's contributions. For\n-example:\n-\n-* Activities in the Fastify organization\n-  `[USERNAME](https://github.com/search?q=author:USERNAME+org:fastify)`\n-\n-Otherwise, a Contributor may self-apply if they believe they meet the above\n-criteria by reaching out to a Lead Maintainer privately with the links to their\n-valuable contributions. The Lead Maintainers will reply to the Contributor and\n-will decide if candidate it to be made a collaborator.\n-\n-The consensus to grant a new candidate Collaborator status is reached when:\n-\n-- at least one of the Lead Maintainers approve\n-- at least two of the Team Members approve\n-\n-After these conditions are satisfied, the [onboarding\n-process](CONTRIBUTING.md#onboarding-collaborators) may start.\n-\n-\n-## Lead Maintainers nominations\n-\n-A Team Member may be promoted to a Lead Maintainers only through nomination by a\n-Lead maintainer and with agreement from the rest of Lead Maintainers.\n",
					"match": false,
					"packageHash": "f54bd5a1010e6303936eb467f6a358bd843f8819d725c1f264a568a6cd311a4c",
					"size": 3982,
					"sourceHash": "13fa498fe8fa4d876258f85d73acaa06c6f981218e11a0dc18fa830a0950fc45",
					"status": "content"
				},
				"LICENSE": {
					"diff": "--- published/LICENSE\n+++ rebuilt/LICENSE\n@@ -1,6 +1,6 @@\n MIT License\n \n-Copyright (c) 2016-2022 The Fastify Team\n+Copyright (c) 2016-present The Fastify Team\n \n The Fastify team members are listed at https://github.com/fastify/fastify#team\n and in the README file.\n",
					"match": false,
					"packageHash": "a4463829a5b1e8b38dffe363c609847b9fcf172f5ebd7d1ba8b46a8b746067dc",
					"size": 1182,
					"sourceHash": "48763b4c2de925a5c107f7319c87fd1ec790f3f5395699939495e571b5ccf21d",
					"status": "content"
				},
				"PROJECT_CHARTER.md": {
					"diff": "--- published/PROJECT_CHARTER.md\n+++ rebuilt/PROJECT_CHARTER.md\n@@ -1,6 +1,6 @@\n # Fastify Charter\n \n-The Fastify project aims to build a fast and low overhead web framework for\n+The Fastify project aims to build a fast and low-overhead web framework for\n Node.js.\n \n \n@@ -20,7 +20,7 @@\n ### 1.1: In-scope\n \n + Develop a web framework for Node.js with a focus on developer experience,\n-  performance and extensibility.\n+  performance, and extensibility.\n + Plugin Architecture\n + Support web protocols\n + Official plugins for common user requirements\n@@ -43,7 +43,7 @@\n \n + Support versions of Node.js at EOL (end of life) stage\n + Support serverless architecture\n-+ Contributions that violates the [Code of Conduct](CODE_OF_CONDUCT.md)\n++ Contributions that violate the [Code of Conduct](CODE_OF_CONDUCT.md)\n \n \n ## Section 2: Relationship with OpenJS Foundation CPC.\n@@ -58,10 +58,10 @@\n This Fastify Charter reflects a carefully constructed balanced role for the\n Collaborators and the CPC in the governance of the OpenJS Foundation. The\n charter amendment process is for the Fastify Collaborators to propose change\n-using simple majority of the full Fastify Organization, the proposed changes\n+using a majority of the full Fastify Organization, the proposed changes\n being subject to review and approval by the CPC. The CPC may additionally make\n amendments to the Collaborators charter at any time, though the CPC will not\n-interfere with day-to-day discussions, votes or meetings of the Fastify\n+interfere with day-to-day discussions, votes, or meetings of the Fastify\n Organization.\n \n \n@@ -92,7 +92,7 @@\n Fastify's features can be discussed in GitHub issues and/or projects. Consensus\n on a discussion is reached when there is no objection by any collaborators.\n \n-Whenever there is not consensus, Lead Maintainers will have final say on the\n+When there is no consensus, Lead Maintainers will have the final say on the\n topic.\n \n **Voting, and/or Elections**\n@@ -112,7 +112,7 @@\n   Foundation Board.\n \n + *Collaborators*: contribute code and other artifacts, have the right to commit\n-  to the code base and release plugins projects. Collaborators follow the\n+  to the code base, and release plugin projects. Collaborators follow the\n   [CONTRIBUTING](CONTRIBUTING.md) guidelines to manage the project. A\n   Collaborator could be encumbered by other Fastify Collaborators and never by\n   the CPC or OpenJS Foundation Board.\n",
					"match": false,
					"packageHash": "01a373e913bc75b6491181df25173ad40a72113ffd47734f3531b8e1d919d766",
					"size": 4403,
					"sourceHash": "dd47e0b1a0b2097ab18ce7b4f58a6883d5fa7ac7ceacae1aed19dd86cc3e16fb",
					"status": "content"
				},
				"README.md": {
					"diff": "--- published/README.md\n+++ rebuilt/README.md\n@@ -1,4 +1,4 @@\n-<div align=\"center\"> <a href=\"https://fastify.io/\">\n+<div align=\"center\"> <a href=\"https://fastify.dev/\">\n     <img\n       src=\"https://github.com/fastify/graphics/raw/HEAD/fastify-landscape-outlined.svg\"\n       width=\"650\"\n@@ -9,12 +9,13 @@\n \n <div align=\"center\">\n \n-[![CI](https://github.com/fastify/fastify/workflows/ci/badge.svg)](https://github.com/fastify/fastify/actions/workflows/ci.yml)\n+[![CI](https://github.com/fastify/fastify/actions/workflows/ci.yml/badge.svg?branch=main)](https://github.com/fastify/fastify/actions/workflows/ci.yml)\n [![Package Manager\n-CI](https://github.com/fastify/fastify/workflows/package-manager-ci/badge.svg)](https://github.com/fastify/fastify/actions/workflows/package-manager-ci.yml)\n+CI](https://github.com/fastify/fastify/actions/workflows/package-manager-ci.yml/badge.svg?branch=main)](https://github.com/fastify/fastify/actions/workflows/package-manager-ci.yml)\n [![Web\n-SIte](https://github.com/fastify/fastify/workflows/website/badge.svg)](https://github.com/fastify/fastify/actions/workflows/website.yml)\n-[![js-standard-style](https://img.shields.io/badge/code%20style-standard-brightgreen.svg?style=flat)](https://standardjs.com/)\n+site](https://github.com/fastify/fastify/actions/workflows/website.yml/badge.svg?branch=main)](https://github.com/fastify/fastify/actions/workflows/website.yml)\n+[![neostandard javascript style](https://img.shields.io/badge/code_style-neostandard-brightgreen?style=flat)](https://github.com/neostandard/neostandard)\n+[![CII Best Practices](https://bestpractices.coreinfrastructure.org/projects/7585/badge)](https://bestpractices.coreinfrastructure.org/projects/7585)\n \n </div>\n \n@@ -27,21 +28,32 @@\n [![Security Responsible\n Disclosure](https://img.shields.io/badge/Security-Responsible%20Disclosure-yellow.svg)](https://github.com/fastify/fastify/blob/main/SECURITY.md)\n [![Discord](https://img.shields.io/discord/725613461949906985)](https://discord.gg/fastify)\n+[![Contribute with Gitpod](https://img.shields.io/badge/Contribute%20with-Gitpod-908a85?logo=gitpod&color=blue)](https://gitpod.io/#https://github.com/fastify/fastify)\n+[![Open Collective backers and sponsors](https://img.shields.io/opencollective/all/fastify)](https://github.com/sponsors/fastify#sponsors)\n \n </div>\n \n <br />\n \n-An efficient server implies a lower cost of the infrastructure, a better\n-responsiveness under load and happy users. How can you efficiently handle the\n+An efficient server implies a lower cost of the infrastructure, better\n+responsiveness under load, and happy users. How can you efficiently handle the\n resources of your server, knowing that you are serving the highest number of\n-requests as possible, without sacrificing security validations and handy\n+requests possible, without sacrificing security validations and handy\n development?\n \n+Enter Fastify. Fastify is a web framework highly focused on providing the best\n+developer experience with the least overhead and a powerful plugin architecture.\n+It is inspired by Hapi and Express and as far as we know, it is one of the\n+fastest web frameworks in town.\n+\n+The `main` branch refers to the Fastify `v5` release.\n+Check out the [`4.x` branch](https://github.com/fastify/fastify/tree/4.x) for `v4`.\n+\n+### Table of Contents\n+\n  - [Quick start](#quick-start)\n  - [Install](#install)\n  - [Example](#example)\n- - [Fastify v1.x and v2.x](#fastify-v1x-and-v2x)\n  - [Core features](#core-features)\n  - [Benchmarks](#benchmarks)\n  - [Documentation](#documentation)\n@@ -51,13 +63,6 @@\n  - [Hosted by](#hosted-by)\n  - [License](#license)\n \n-Enter Fastify. Fastify is a web framework highly focused on providing the best\n-developer experience with the least overhead and a powerful plugin architecture.\n-It is inspired by Hapi and Express and as far as we know, it is one of the\n-fastest web frameworks in town.\n-\n-This branch refers to the Fastify v4 release. Check out the\n-[v3.x](https://github.com/fastify/fastify/tree/v3.x) branch for v3.\n \n ### Quick start\n \n@@ -101,14 +106,9 @@\n \n To install Fastify in an existing project as a dependency:\n \n-Install with npm:\n ```sh\n npm i fastify\n ```\n-Install with yarn:\n-```sh\n-yarn add fastify\n-```\n \n ### Example\n \n@@ -117,6 +117,7 @@\n \n // ESM\n import Fastify from 'fastify'\n+\n const fastify = Fastify({\n   logger: true\n })\n",
					"match": false,
					"packageHash": "3e92e93ebde01cd00b236318cd17905dbcfe971fa7ecd56e46e48ed2a7d3fb16",
					"size": 15001,
					"sourceHash": "8e8931d5a0e372dcc63ddc0650fde17b2cf2cb1eb5b69a27eba5dbb6ac456310",
					"status": "content"
				},
				"SECURITY.md": {
					"diff": "--- published/SECURITY.md\n+++ rebuilt/SECURITY.md\n@@ -3,11 +3,30 @@\n This document describes the management of vulnerabilities for the Fastify\n project and its official plugins.\n \n+## Threat Model\n+\n+Fastify's threat model extends the\n+[Node.js threat model](https://github.com/nodejs/node/blob/main/SECURITY.md#the-nodejs-threat-model).\n+\n+**Trusted:** Application code (plugins, handlers, hooks, schemas), configuration,\n+and the runtime environment.\n+\n+**Untrusted:** All network input (HTTP headers, body, query strings, URL\n+parameters).\n+\n+### Examples of Vulnerabilities\n+\n+- Parsing flaws that bypass validation or security controls\n+- DoS through malformed input to Fastify's core\n+- Bypasses of built-in protections (prototype poisoning, schema validation)\n+\n ## Reporting vulnerabilities\n \n Individuals who find potential vulnerabilities in Fastify are invited to\n-complete a vulnerability report via the dedicated HackerOne page:\n-[https://hackerone.com/fastify](https://hackerone.com/fastify).\n+complete a vulnerability report via the dedicated pages:\n+\n+1. [HackerOne](https://hackerone.com/fastify)\n+2. [GitHub Security Advisory](https://github.com/fastify/fastify/security/advisories/new)\n \n ### Strict measures when reporting vulnerabilities\n \n@@ -15,23 +34,32 @@\n guidelines to ensure the ecosystem as a whole isn't disrupted due to improperly\n reported vulnerabilities:\n \n-* Avoid creating new \"informative\" reports on HackerOne. Only create new\n-  HackerOne reports on a vulnerability if you are absolutely sure this should be\n+* Avoid creating new \"informative\" reports. Only create new\n+  reports on a vulnerability if you are absolutely sure this should be\n   tagged as an actual vulnerability. Third-party vendors and individuals are\n-  tracking any new vulnerabilities reported in HackerOne and will flag them as\n-  such for their customers (think about snyk, npm audit, ...).\n-* HackerOne reports should never be created and triaged by the same person. If\n-  you are creating a HackerOne report for a vulnerability that you found, or on\n+  tracking any new vulnerabilities reported in HackerOne or GitHub and will flag\n+  them as such for their customers (think about snyk, npm audit, ...).\n+* Security reports should never be created and triaged by the same person. If\n+  you are creating a report for a vulnerability that you found, or on\n   behalf of someone else, there should always be a 2nd Security Team member who\n   triages it. If in doubt, invite more Fastify Collaborators to help triage the\n   validity of the report. In any case, the report should follow the same process\n   as outlined below of inviting the maintainers to review and accept the\n   vulnerability.\n+* ***Do not*** attempt to show CI/CD vulnerabilities by creating new pull\n+  requests to any of the Fastify organization's repositories. Doing so will\n+  result in a [content report][cr] to GitHub as an unsolicited exploit.\n+  The proper way to provide such reports is by creating a new repository,\n+  configured in the same manner as the repository you would like to submit\n+  a report about, and with a pull request to your own repository showing\n+  the proof of concept.\n+\n+[cr]: https://docs.github.com/en/communities/maintaining-your-safety-on-github/reporting-abuse-or-spam#reporting-an-issue-or-pull-request\n \n ### Vulnerabilities found outside this process\n \n-⚠ The Fastify project does not support any reporting outside the HackerOne\n-process.\n+⚠ The Fastify project does not support any reporting outside the process mentioned\n+in this document.\n \n ## Handling vulnerability reports\n \n@@ -45,9 +73,9 @@\n the individual who submitted the potential vulnerability. The possible responses\n can be:\n \n-* Acceptance: what was reported is considered as a new vulnerability\n-* Rejection: what was reported is not considered as a new vulnerability\n-* Need more information: the security team needs more information in order to\n+* **Acceptance**: what was reported is considered as a new vulnerability\n+* **Rejection**: what was reported is not considered as a new vulnerability\n+* **Need more information**: the security team needs more information in order to\n   evaluate what was reported.\n \n Triaging should include updating issue fields:\n@@ -91,7 +119,7 @@\n can be added with the approval of the security team and the individual who\n reported the vulnerability.\n \n-At this point, a CVE should be requested through the HackerOne platform through\n+At this point, a CVE should be requested through the selected platform through\n the UI, which should include the Report ID and a summary.\n \n Within HackerOne, this is handled through a \"public disclosure request\".\n@@ -99,10 +127,22 @@\n Reference: [HackerOne:\n",
					"match": false,
					"packageHash": "ed51834c78fd9572ae535f02059881afc8b552a383e4df82f85c9964eba7d587",
					"size": 5076,
					"sourceHash": "304b0c1dd375aa588ff9d4acfe28366bdcd74575c5cf3ce3c936e6bf586d5f78",
					"status": "content"
				},
				"build/build-error-serializer.js": {
					"diff": "--- published/build/build-error-serializer.js\n+++ rebuilt/build/build-error-serializer.js\n@@ -2,8 +2,8 @@\n 'use strict'\n \n const FJS = require('fast-json-stringify')\n-const path = require('path')\n-const fs = require('fs')\n+const path = require('node:path')\n+const fs = require('node:fs')\n \n const code = FJS({\n   type: 'object',\n@@ -18,10 +18,12 @@\n const file = path.join(__dirname, '..', 'lib', 'error-serializer.js')\n \n const moduleCode = `// This file is autogenerated by build/build-error-serializer.js, do not edit\n-/* istanbul ignore file */\n+/* c8 ignore start */\n ${code}\n+/* c8 ignore stop */\n `\n \n+/* c8 ignore start */\n if (require.main === module) {\n   fs.writeFileSync(file, moduleCode)\n   console.log(`Saved ${file} file successfully`)\n@@ -30,3 +32,4 @@\n     code: moduleCode\n   }\n }\n+/* c8 ignore stop */\n",
					"match": false,
					"packageHash": "a9a0bdf45169dad51c001f5afb88514fe1278346b0da6d1a8ed2f4b1598d66db",
					"size": 734,
					"sourceHash": "7541ec31c78a78b14b66316cc622088be267c996a381aa36436560ba0442310e",
					"status": "content"
				},
				"build/build-validation.js": {
					"diff": "--- published/build/build-validation.js\n+++ rebuilt/build/build-validation.js\n@@ -2,20 +2,21 @@\n \n const AjvStandaloneCompiler = require('@fastify/ajv-compiler/standalone')\n const { _ } = require('ajv')\n-const fs = require('fs')\n-const path = require('path')\n+const fs = require('node:fs')\n+const path = require('node:path')\n \n const factory = AjvStandaloneCompiler({\n   readMode: false,\n   storeFunction (routeOpts, schemaValidationCode) {\n-    const moduleCode = `// This file is autogenerated by ${__filename.replace(__dirname, 'build')}, do not edit\n-/* istanbul ignore file */\n+    const moduleCode = `// This file is autogenerated by build/build-validation.js, do not edit\n+/* c8 ignore start */\n ${schemaValidationCode}\n \n module.exports.defaultInitOptions = ${JSON.stringify(defaultInitOptions)}\n+/* c8 ignore stop */\n `\n \n-    const file = path.join(__dirname, '..', 'lib', 'configValidator.js')\n+    const file = path.join(__dirname, '..', 'lib', 'config-validator.js')\n     fs.writeFileSync(file, moduleCode)\n     console.log(`Saved ${file} file successfully`)\n   }\n@@ -31,17 +32,25 @@\n   caseSensitive: true,\n   allowUnsafeRegex: false,\n   disableRequestLogging: false,\n-  jsonShorthand: true,\n   ignoreTrailingSlash: false,\n   ignoreDuplicateSlashes: false,\n   maxParamLength: 100,\n   onProtoPoisoning: 'error',\n   onConstructorPoisoning: 'error',\n   pluginTimeout: 10000,\n-  requestIdHeader: 'request-id',\n+  requestIdHeader: false,\n   requestIdLogLabel: 'reqId',\n   http2SessionTimeout: 72000, // 72 seconds\n-  exposeHeadRoutes: true\n+  exposeHeadRoutes: true,\n+  useSemicolonDelimiter: false,\n+  allowErrorHandlerOverride: true, // TODO: set to false in v6\n+  routerOptions: {\n+    ignoreTrailingSlash: false,\n+    ignoreDuplicateSlashes: false,\n+    maxParamLength: 100,\n+    allowUnsafeRegex: false,\n+    useSemicolonDelimiter: false\n+  }\n }\n \n const schema = {\n@@ -92,23 +101,24 @@\n       type: 'boolean',\n       default: false\n     },\n-    jsonShorthand: { type: 'boolean', default: defaultInitOptions.jsonShorthand },\n     maxParamLength: { type: 'integer', default: defaultInitOptions.maxParamLength },\n     onProtoPoisoning: { type: 'string', default: defaultInitOptions.onProtoPoisoning },\n     onConstructorPoisoning: { type: 'string', default: defaultInitOptions.onConstructorPoisoning },\n     pluginTimeout: { type: 'integer', default: defaultInitOptions.pluginTimeout },\n-    requestIdHeader: { anyOf: [{ enum: [false] }, { type: 'string' }], default: defaultInitOptions.requestIdHeader },\n+    requestIdHeader: { anyOf: [{ type: 'boolean' }, { type: 'string' }], default: defaultInitOptions.requestIdHeader },\n     requestIdLogLabel: { type: 'string', default: defaultInitOptions.requestIdLogLabel },\n     http2SessionTimeout: { type: 'integer', default: defaultInitOptions.http2SessionTimeout },\n     exposeHeadRoutes: { type: 'boolean', default: defaultInitOptions.exposeHeadRoutes },\n-    // deprecated style of passing the versioning constraint\n-    versioning: {\n+    useSemicolonDelimiter: { type: 'boolean', default: defaultInitOptions.useSemicolonDelimiter },\n+    routerOptions: {\n       type: 'object',\n-      additionalProperties: true,\n-      required: ['storage', 'deriveVersion'],\n+      additionalProperties: false,\n       properties: {\n-        storage: { },\n-        deriveVersion: { }\n+        ignoreTrailingSlash: { type: 'boolean', default: defaultInitOptions.routerOptions.ignoreTrailingSlash },\n+        ignoreDuplicateSlashes: { type: 'boolean', default: defaultInitOptions.routerOptions.ignoreDuplicateSlashes },\n+        maxParamLength: { type: 'integer', default: defaultInitOptions.routerOptions.maxParamLength },\n+        allowUnsafeRegex: { type: 'boolean', default: defaultInitOptions.routerOptions.allowUnsafeRegex },\n+        useSemicolonDelimiter: { type: 'boolean', default: defaultInitOptions.routerOptions.useSemicolonDelimiter }\n       }\n     },\n     constraints: {\n@@ -119,9 +129,9 @@\n         additionalProperties: true,\n         properties: {\n           name: { type: 'string' },\n-          storage: { },\n-          validate: { },\n-          deriveConstraint: { }\n+          storage: {},\n+          validate: {},\n",
					"match": false,
					"packageHash": "f2aa85faf18e56cd0fa6dca3752a629d65430f9c775876a82e213e98dbaa5ada",
					"size": 5086,
					"sourceHash": "2e8bfc8812d3a0cf4abadf7b76992626936986e875e0131b23b055f29768db5f",
					"status": "content"
				},
				"build/sync-version.js": {
					"diff": "--- published/build/sync-version.js\n+++ rebuilt/build/sync-version.js\n@@ -1,7 +1,7 @@\n 'use strict'\n \n-const fs = require('fs')\n-const path = require('path')\n+const fs = require('node:fs')\n+const path = require('node:path')\n \n // package.json:version -> fastify.js:VERSION\n const { version } = JSON.parse(fs.readFileSync(path.join(__dirname, '..', 'package.json')).toString('utf8'))\n",
					"match": false,
					"packageHash": "0fc055986224844f8849ed5e2569ac09c33258076596d3ca8197f7b8435bbd34",
					"size": 423,
					"sourceHash": "310d8e4b2dae7e8a3001ecf39b7429ff54a67abc28ecd06e9565428f0656cffb",
					"status": "content"
				},
				"docs/Guides/Benchmarking.md": {
					"diff": "--- published/docs/Guides/Benchmarking.md\n+++ rebuilt/docs/Guides/Benchmarking.md\n@@ -1,18 +1,18 @@\n <h1 align=\"center\">Fastify</h1>\n \n ## Benchmarking\n-Benchmarking is important if you want to measure how a change can affect the\n-performance of your application. We provide a simple way to benchmark your\n+Benchmarking is important if you want to measure how a change can affect your\n+application's performance. We provide a simple way to benchmark your\n application from the point of view of a user and contributor. The setup allows\n you to automate benchmarks in different branches and on different Node.js\n versions.\n \n The modules we will use:\n-- [Autocannon](https://github.com/mcollina/autocannon): A HTTP/1.1 benchmarking\n+- [Autocannon](https://github.com/mcollina/autocannon): An HTTP/1.1 benchmarking\n   tool written in node.\n - [Branch-comparer](https://github.com/StarpTech/branch-comparer): Checkout\n-  multiple git branches, execute scripts and log the results.\n-- [Concurrently](https://github.com/kimmobrunfeldt/concurrently): Run commands\n+  multiple git branches, execute scripts, and log the results.\n+- [Concurrently](https://github.com/open-cli-tools/concurrently): Run commands\n   concurrently.\n - [Npx](https://github.com/npm/npx): NPM package runner used to run scripts\n   against different Node.js Versions and execute local binaries. Shipped with\n",
					"match": false,
					"packageHash": "00183b88926af3d7eaa16c0603c7fe0050bbbe5340da460453182dbfaf063018",
					"size": 1745,
					"sourceHash": "308ca36933c93c960af037c8fe43b814b5b90ee63a25bea89fb81a6c3fb8b157",
					"status": "content"
				},
				"docs/Guides/Database.md": {
					"diff": "--- published/docs/Guides/Database.md\n+++ rebuilt/docs/Guides/Database.md\n@@ -2,17 +2,17 @@\n \n ## Database\n \n-Fastify's ecosystem provides a handful of \n-plugins for connecting to various database engines. \n-This guide covers engines that have Fastify \n+Fastify's ecosystem provides a handful of\n+plugins for connecting to various database engines.\n+This guide covers engines that have Fastify\n plugins maintained within the Fastify organization.\n \n-> If a plugin for your database of choice does not exist \n-> you can still use the database as Fastify is database agnostic. \n-> By following the examples of the database plugins listed in this guide, \n-> a plugin can be written for the missing database engine. \n+> If a plugin for your database of choice does not exist\n+> you can still use the database as Fastify is database agnostic.\n+> By following the examples of the database plugins listed in this guide,\n+> a plugin can be written for the missing database engine.\n \n-> If you would like to write your own Fastify plugin \n+> If you would like to write your own Fastify plugin\n > please take a look at the [plugins guide](./Plugins-Guide.md)\n \n ### [MySQL](https://github.com/fastify/fastify-mysql)\n@@ -104,8 +104,8 @@\n })\n ```\n \n-By default `@fastify/redis` doesn't close \n-the client connection when Fastify server shuts down. \n+By default `@fastify/redis` doesn't close\n+the client connection when Fastify server shuts down.\n To opt-in to this behavior, register the client like so:\n \n ```javascript\n@@ -126,23 +126,22 @@\n   // force to close the mongodb connection when app stopped\n   // the default value is false\n   forceClose: true,\n-  \n+\n   url: 'mongodb://mongo/mydb'\n })\n \n-fastify.get('/user/:id', function (req, reply) {\n+fastify.get('/user/:id', async function (req, reply) {\n   // Or this.mongo.client.db('mydb').collection('users')\n   const users = this.mongo.db.collection('users')\n \n   // if the id is an ObjectId format, you need to create a new ObjectId\n   const id = this.mongo.ObjectId(req.params.id)\n-  users.findOne({ id }, (err, user) => {\n-    if (err) {\n-      reply.send(err)\n-      return\n-    }\n-    reply.send(user)\n-  })\n+  try {\n+    const user = await users.findOne({ id })\n+    return user\n+  } catch (err) {\n+    return err\n+  }\n })\n \n fastify.listen({ port: 3000 }, err => {\n@@ -179,8 +178,8 @@\n ```\n \n ### Writing plugin for a database library\n-We could write a plugin for a database \n-library too (e.g. Knex, Prisma, or TypeORM). \n+We could write a plugin for a database\n+library too (e.g. Knex, Prisma, or TypeORM).\n We will use [Knex](https://knexjs.org/) in our example.\n \n ```javascript\n@@ -238,15 +237,15 @@\n database's schema and prevent data loss.\n \n As stated at the beginning of the guide, Fastify is database agnostic and any\n-NodeJS database migration tool can be used with it. We will give an example of\n+Node.js database migration tool can be used with it. We will give an example of\n using [Postgrator](https://www.npmjs.com/package/postgrator) which has support\n for Postgres, MySQL, SQL Server and SQLite. For MongoDB migrations, please check\n [migrate-mongo](https://www.npmjs.com/package/migrate-mongo).\n \n #### [Postgrator](https://www.npmjs.com/package/postgrator)\n \n-Postgrator is NodeJS SQL migration tool that uses a directory of SQL scripts to\n-alter the database schema. Each file an migrations folder need to follow the\n+Postgrator is Node.js SQL migration tool that uses a directory of SQL scripts to\n+alter the database schema. Each file in a migrations folder needs to follow the\n pattern: ` [version].[action].[optional-description].sql`.\n \n",
					"match": false,
					"packageHash": "d91e3852956cb30624f50c961b245cc9b8555aaa8c6e20c0b11a7d1b25fcfe3c",
					"size": 8476,
					"sourceHash": "f16ea8f5773b446e3b3dbbf02329d4828f65635bc276ff5c745c1b51a427c977",
					"status": "content"
				},
				"docs/Guides/Delay-Accepting-Requests.md": {
					"diff": "--- published/docs/Guides/Delay-Accepting-Requests.md\n+++ rebuilt/docs/Guides/Delay-Accepting-Requests.md\n@@ -49,7 +49,7 @@\n \n 1. the mechanism for authenticating with the provider\n [decorating](../Reference/Decorators.md) the `fastify` object with the\n-authentication key (`magicKey` from here onwards)\n+authentication key (`magicKey` from here onward)\n 1. the mechanism for denying requests that would, otherwise, fail\n \n ### Hands-on\n@@ -77,8 +77,8 @@\n })\n \n server.post('/webhook', function (request, reply) {\n-  // It's good practice to validate webhook requests really come from\n-  // whoever you expect. This is skipped in this sample for the sake\n+  // It's good practice to validate webhook requests come from\n+  // who you expect. This is skipped in this sample for the sake\n   // of simplicity\n \n   const { magicKey } = request.body\n@@ -103,7 +103,7 @@\n   }\n })\n \n-server.decorate('magicKey', null)\n+server.decorate('magicKey')\n \n server.listen({ port: '1234' }, () => {\n   provider.thirdPartyMagicKeyGenerator(USUAL_WAIT_TIME_MS)\n@@ -135,7 +135,7 @@\n \n ```js\n const { fetch } = require('undici')\n-const { setTimeout } = require('timers/promises')\n+const { setTimeout } = require('node:timers/promises')\n \n const MAGIC_KEY = '12345'\n \n@@ -249,7 +249,7 @@\n \n ```js\n const { fetch } = require('undici')\n-const { setTimeout } = require('timers/promises')\n+const { setTimeout } = require('node:timers/promises')\n \n const MAGIC_KEY = '12345'\n \n@@ -303,7 +303,7 @@\n   fastify.server.on('listening', doMagic)\n \n   // Set up the placeholder for the magicKey\n-  fastify.decorate('magicKey', null)\n+  fastify.decorate('magicKey')\n \n   // Our magic -- important to make sure errors are handled. Beware of async\n   // functions outside `try/catch` blocks\n@@ -406,7 +406,7 @@\n our provider as soon as possible, with the `doMagic` function.\n \n ```js\n-  fastify.decorate('magicKey', null)\n+  fastify.decorate('magicKey')\n ```\n \n The `magicKey` decoration is also part of the plugin now. We initialize it with\n@@ -448,10 +448,10 @@\n long they should wait before retrying the request. Going even further, by\n issuing a [`503` status\n code](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/503) we're\n-signaling to our infrastructure components (namely load balancers) we're still\n-not ready to take incoming requests and they should redirect traffic to other\n-instances, if available, besides in how long we estimate that will be solved.\n-All of that in a few simple lines!\n+signaling to our infrastructure components (namely load balancers) that we're\n+still not ready to take incoming requests and they should redirect traffic to\n+other instances, if available. Additionally, we are providing a `Retry-After`\n+header with the time in milliseconds the client should wait before retrying.\n \n It's noteworthy that we didn't use the `fastify-plugin` wrapper in the `delay`\n factory. That's because we wanted the `onRequest` hook to only be set within\n@@ -524,14 +524,17 @@\n }\n ```\n \n-Then we attempt a new request (`req-2`), which was a `GET /ping`. As expected,\n+Then we attempted a new request (`req-2`), which was a `GET /ping`. As expected,\n since that was not one of the requests we asked our plugin to filter, it\n-succeeded. That could also be used as means of informing an interested party\n-whether or not we were ready to serve requests (although `/ping` is more\n-commonly associated with *liveness* checks and that would be the responsibility\n-of a *readiness* check -- the curious reader can get more info on these terms\n-[here](https://cloud.google.com/blog/products/containers-kubernetes/kubernetes-best-practices-setting-up-health-checks-with-readiness-and-liveness-probes))\n-with the `ready` field. Below is the response for that request:\n+succeeded. That could also be used as a means of informing an interested party\n+whether or not we were ready to serve requests with the `ready` field. Although\n+`/ping` is more commonly associated with *liveness* checks and that would be\n+the responsibility of a *readiness* check. The curious reader can get more info\n+on these terms in the article\n",
					"match": false,
					"packageHash": "cc5edb247e3de9ac2d290a9075690375feffca29c4bfb39d3b8a106d92293e49",
					"size": 21501,
					"sourceHash": "6ae542ff1dea2c257590810d6b1979aebbb7cd8510785de756ccc1de45a7e73c",
					"status": "content"
				},
				"docs/Guides/Ecosystem.md": {
					"diff": "--- published/docs/Guides/Ecosystem.md\n+++ rebuilt/docs/Guides/Ecosystem.md\n@@ -11,9 +11,7 @@\n - [`@fastify/accepts`](https://github.com/fastify/fastify-accepts) to have\n   [accepts](https://www.npmjs.com/package/accepts) in your request object.\n - [`@fastify/accepts-serializer`](https://github.com/fastify/fastify-accepts-serializer)\n-  to serialize to output according to `Accept` header.\n-- [`@fastify/any-schema`](https://github.com/fastify/any-schema-you-like) Save\n-  multiple schemas and decide which one to use to serialize the payload\n+  to serialize to output according to the `Accept` header.\n - [`@fastify/auth`](https://github.com/fastify/fastify-auth) Run multiple auth\n   functions in Fastify.\n - [`@fastify/autoload`](https://github.com/fastify/fastify-autoload) Require all\n@@ -42,14 +40,14 @@\n   plugin for adding\n   [CSRF](https://en.wikipedia.org/wiki/Cross-site_request_forgery) protection to\n   Fastify.\n-- [`@fastify/diagnostics-channel`](https://github.com/fastify/fastify-diagnostics-channel)\n-  Plugin to deal with `diagnostics_channel` on Fastify\n - [`@fastify/elasticsearch`](https://github.com/fastify/fastify-elasticsearch)\n   Plugin to share the same ES client.\n - [`@fastify/env`](https://github.com/fastify/fastify-env) Load and check\n   configuration.\n - [`@fastify/etag`](https://github.com/fastify/fastify-etag) Automatically\n   generate ETags for HTTP responses.\n+- [`@fastify/express`](https://github.com/fastify/fastify-express) Express\n+  compatibility layer for Fastify.\n - [`@fastify/flash`](https://github.com/fastify/fastify-flash) Set and get flash\n   messages using the session.\n - [`@fastify/formbody`](https://github.com/fastify/fastify-formbody) Plugin to\n@@ -66,6 +64,8 @@\n   your HTTP requests to another server, with hooks.\n - [`@fastify/jwt`](https://github.com/fastify/fastify-jwt) JWT utils for\n   Fastify, internally uses [fast-jwt](https://github.com/nearform/fast-jwt).\n+- [`@fastify/kafka`](https://github.com/fastify/fastify-kafka) Plugin to interact\n+  with Apache Kafka.\n - [`@fastify/leveldb`](https://github.com/fastify/fastify-leveldb) Plugin to\n   share a common LevelDB connection across Fastify.\n - [`@fastify/middie`](https://github.com/fastify/middie) Middleware engine for\n@@ -75,13 +75,29 @@\n   connection pool across every part of your server.\n - [`@fastify/multipart`](https://github.com/fastify/fastify-multipart) Multipart\n   support for Fastify.\n+- [`@fastify/mysql`](https://github.com/fastify/fastify-mysql) Fastify MySQL\n+  connection plugin.\n+- [`@fastify/nextjs`](https://github.com/fastify/fastify-nextjs) React\n+  server-side rendering support for Fastify with\n+  [Next](https://github.com/zeit/next.js/).\n - [`@fastify/oauth2`](https://github.com/fastify/fastify-oauth2) Wrap around\n   [`simple-oauth2`](https://github.com/lelylan/simple-oauth2).\n+- [`@fastify/one-line-logger`](https://github.com/fastify/one-line-logger) Formats\n+  Fastify's logs into a nice one-line message.\n+- [`@fastify/otel`](https://github.com/fastify/otel) OpenTelemetry\n+  instrumentation library.\n+- [`@fastify/passport`](https://github.com/fastify/fastify-passport) Use Passport\n+  strategies to authenticate requests and protect route.\n - [`@fastify/postgres`](https://github.com/fastify/fastify-postgres) Fastify\n   PostgreSQL connection plugin, with this you can share the same PostgreSQL\n   connection pool in every part of your server.\n - [`@fastify/rate-limit`](https://github.com/fastify/fastify-rate-limit) A low\n   overhead rate limiter for your routes.\n+- [`@fastify/redis`](https://github.com/fastify/fastify-redis) Fastify Redis\n+  connection plugin, with which you can share the same Redis connection across\n+  every part of your server.\n+- [`@fastify/reply-from`](https://github.com/fastify/fastify-reply-from) Plugin\n+  to forward the current HTTP request to another server.\n - [`@fastify/request-context`](https://github.com/fastify/fastify-request-context)\n   Request-scoped storage, based on\n   [AsyncLocalStorage](https://nodejs.org/api/async_hooks.html#async_hooks_class_asynclocalstorage)\n@@ -89,36 +105,38 @@\n   providing functionality similar to thread-local storages.\n - [`@fastify/response-validation`](https://github.com/fastify/fastify-response-validation)\n   A simple plugin that enables response validation for Fastify.\n-- [`@fastify/nextjs`](https://github.com/fastify/fastify-nextjs) React\n-  server-side rendering support for Fastify with\n-  [Next](https://github.com/zeit/next.js/).\n-- [`@fastify/redis`](https://github.com/fastify/fastify-redis) Fastify Redis\n-  connection plugin, with which you can share the same Redis connection across\n-  every part of your server.\n-- [`@fastify/reply-from`](https://github.com/fastify/fastify-reply-from) Plugin\n-  to forward the current HTTP request to another server.\n - [`@fastify/routes`](https://github.com/fastify/fastify-routes) Plugin that\n   provides a `Map` of routes.\n+- [`@fastify/routes-stats`](https://github.com/fastify/fastify-routes-stats)\n+  Provide stats for routes using `node:perf_hooks`.\n - [`@fastify/schedule`](https://github.com/fastify/fastify-schedule) Plugin for\n   scheduling periodic jobs, based on\n   [toad-scheduler](https://github.com/kibertoad/toad-scheduler).\n+- [`@fastify/secure-session`](https://github.com/fastify/fastify-secure-session)\n+  Create a secure stateless cookie session for Fastify.\n - [`@fastify/sensible`](https://github.com/fastify/fastify-sensible) Defaults\n   for Fastify that everyone can agree on. It adds some useful decorators such as\n   HTTP errors and assertions, but also more request and reply methods.\n - [`@fastify/session`](https://github.com/fastify/session) a session plugin for\n   Fastify.\n+- [`@fastify/sse`](https://github.com/fastify/sse) Plugin for Server-Sent Events\n+  (SSE) support in Fastify.\n - [`@fastify/static`](https://github.com/fastify/fastify-static) Plugin for\n   serving static files as fast as possible.\n - [`@fastify/swagger`](https://github.com/fastify/fastify-swagger) Plugin for\n",
					"match": false,
					"packageHash": "80170688d3c2c1ab4724395e76901ce642f1f0888e55910200434664de479f6d",
					"size": 36924,
					"sourceHash": "fd62ad2bc9a84a44861f27421fefe39439003981368d31f821b0a836eff15e3e",
					"status": "content"
				},
				"docs/Guides/Fluent-Schema.md": {
					"diff": "--- published/docs/Guides/Fluent-Schema.md\n+++ rebuilt/docs/Guides/Fluent-Schema.md\n@@ -55,7 +55,7 @@\n \n ### Reuse\n \n-With `fluent-json-schema` you can manipulate your schemas more easily and\n+With `fluent-json-schema`, you can manipulate your schemas more easily and\n programmatically and then reuse them thanks to the `addSchema()` method. You can\n refer to the schema in two different manners that are detailed in the\n [Validation and\n@@ -122,5 +122,5 @@\n fastify.post('/the/url', { schema }, handler)\n ```\n \n-NB You can mix up the `$ref-way` and the `replace-way` when using\n-`fastify.addSchema`.\n+> ℹ️ Note: You can mix up the `$ref-way` and the `replace-way`\n+> when using `fastify.addSchema`.\n",
					"match": false,
					"packageHash": "fc404774b09faf072fc9d809d769973678ee1753f806817711ef8f57ec512fdf",
					"size": 3530,
					"sourceHash": "2d7df1bf6e5329e836ebebf924b756e388b701efa54f25e02683b62e7b3ae053",
					"status": "content"
				},
				"docs/Guides/Getting-Started.md": {
					"diff": "--- published/docs/Guides/Getting-Started.md\n+++ rebuilt/docs/Guides/Getting-Started.md\n@@ -14,11 +14,12 @@\n <a id=\"install\"></a>\n \n Install with npm:\n-```\n+```sh\n npm i fastify\n ```\n+\n Install with yarn:\n-```\n+```sh\n yarn add fastify\n ```\n \n@@ -31,6 +32,7 @@\n \n // ESM\n import Fastify from 'fastify'\n+\n const fastify = Fastify({\n   logger: true\n })\n@@ -54,11 +56,20 @@\n })\n ```\n \n+> If you are using ECMAScript Modules (ESM) in your project, be sure to\n+> include \"type\": \"module\" in your package.json.\n+>```js\n+>{\n+>  \"type\": \"module\"\n+>}\n+>```\n+\n Do you prefer to use `async/await`? Fastify supports it out-of-the-box.\n \n ```js\n // ESM\n import Fastify from 'fastify'\n+\n const fastify = Fastify({\n   logger: true\n })\n@@ -95,7 +106,7 @@\n Fastify offers an easy platform that helps to solve all of the problems outlined\n above, and more!\n \n-> ## Note\n+> **Note**\n > The above examples, and subsequent examples in this document, default to\n > listening *only* on the localhost `127.0.0.1` interface. To listen on all\n > available IPv4 interfaces the example should be modified to listen on\n@@ -117,6 +128,9 @@\n >\n > When deploying to a Docker (or another type of) container using `0.0.0.0` or\n > `::` would be the easiest method for exposing the application.\n+>\n+> Note that when using `0.0.0.0`, the address provided in the callback argument\n+> above will be the first address the wildcard refers to.\n \n ### Your first plugin\n <a id=\"first-plugin\"></a>\n@@ -132,7 +146,7 @@\n ```js\n // ESM\n import Fastify from 'fastify'\n-import firstRoute from './our-first-route'\n+import firstRoute from './our-first-route.js'\n /**\n  * @type {import('fastify').FastifyInstance} Instance of Fastify\n  */\n@@ -171,13 +185,14 @@\n })\n ```\n \n+\n ```js\n // our-first-route.js\n \n /**\n  * Encapsulates the routes\n  * @param {FastifyInstance} fastify  Encapsulated Fastify Instance\n- * @param {Object} options plugin options, refer to https://www.fastify.io/docs/latest/Reference/Plugins/#plugin-options\n+ * @param {Object} options plugin options, refer to https://fastify.dev/docs/latest/Reference/Plugins/#plugin-options\n  */\n async function routes (fastify, options) {\n   fastify.get('/', async (request, reply) => {\n@@ -185,6 +200,10 @@\n   })\n }\n \n+//ESM\n+export default routes;\n+\n+// CommonJs\n module.exports = routes\n ```\n",
					"match": false,
					"packageHash": "e0c062d4e5abf7d3d5a53fd127173433593771f6c3d2e091d8492b8eeb717a38",
					"size": 15713,
					"sourceHash": "198d4f96ad850dd8325b475286c88409d1bcd98649f96a1bfca278e0b6df2e4c",
					"status": "content"
				},
				"docs/Guides/Index.md": {
					"diff": "--- published/docs/Guides/Index.md\n+++ rebuilt/docs/Guides/Index.md\n@@ -15,9 +15,11 @@\n   met in your application. This guide focuses on solving the problem using\n   [`Hooks`](../Reference/Hooks.md), [`Decorators`](../Reference/Decorators.md),\n   and [`Plugins`](../Reference/Plugins.md).\n++ [Detecting When Clients Abort](./Detecting-When-Clients-Abort.md): A\n+  practical guide on detecting if and when a client aborts a request.\n + [Ecosystem](./Ecosystem.md): Lists all core plugins and many known community\n   plugins.\n-+ [Fluent Schema](./Fluent-Schema.md): Shows how writing JSON Schema can be\n++ [Fluent Schema](./Fluent-Schema.md): Shows how JSON Schema can be\n   written with a fluent API and used in Fastify.\n + [Getting Started](./Getting-Started.md): Introduction tutorial for Fastify.\n   This is where beginners should start.\n",
					"match": false,
					"packageHash": "68177581e4f712925a969375dc669432743bbd58b7881f1c24f82f06ea75a188",
					"size": 2191,
					"sourceHash": "ee3f24e4612b6c803aef8dcc348b211ef65eeb9da056f4ee8536a6863733bfb6",
					"status": "content"
				},
				"docs/Guides/Migration-Guide-V4.md": {
					"diff": "--- published/docs/Guides/Migration-Guide-V4.md\n+++ rebuilt/docs/Guides/Migration-Guide-V4.md\n@@ -6,16 +6,43 @@\n warnings from v3. All v3 deprecations have been removed and they will no longer\n work after upgrading.\n \n+## Codemods\n+### Fastify v4 Codemods\n+\n+To help with the upgrade, we’ve worked with the team at\n+[Codemod](https://github.com/codemod-com/codemod) to\n+publish codemods that will automatically update your code to many of\n+the new APIs and patterns in Fastify v4.\n+\n+Run the following\n+[migration recipe](https://go.codemod.com/fastify-4-migration-recipe) to\n+automatically update your code to Fastify v4:\n+\n+```\n+npx codemod@latest fastify/4/migration-recipe\n+```\n+\n+This will run the following codemods:\n+\n+- [`fastify/4/remove-app-use`](https://go.codemod.com/fastify-4-remove-app-use)\n+- [`fastify/4/reply-raw-access`](https://go.codemod.com/fastify-4-reply-raw-access)\n+- [`fastify/4/wrap-routes-plugin`](https://go.codemod.com/fastify-4-wrap-routes-plugin)\n+- [`fastify/4/await-register-calls`](https://go.codemod.com/fastify-4-await-register-calls)\n+\n+Each of these codemods automates the changes listed in the v4 migration guide.\n+For a complete list of available Fastify codemods and further details,\n+see [Codemod Registry](https://go.codemod.com/fastify).\n+\n+\n ## Breaking Changes\n \n ### Error handling composition ([#3261](https://github.com/fastify/fastify/pull/3261))\n \n-When an error is thrown in a async error handler function, \n-the upper-level error handler is executed if set.\n-If there is not a upper-level error handler, the default will \n-be executed as it was previously.\n+When an error is thrown in an async error handler function, the upper-level\n+error handler is executed if set. If there is no upper-level error handler,\n+the default will be executed as it was previously:\n \n-```\n+```js\n import Fastify from 'fastify'\n \n const fastify = Fastify()\n@@ -25,14 +52,14 @@\n     console.log(err.message) // 'kaboom'\n     throw new Error('caught')\n   })\n-  \n+\n   fastify.get('/encapsulated', async () => {\n     throw new Error('kaboom')\n   })\n })\n \n fastify.setErrorHandler(async err => {\n-  console.log(err.message) // 'caught' \n+  console.log(err.message) // 'caught'\n   throw new Error('wrapped')\n })\n \n@@ -40,94 +67,197 @@\n console.log(res.json().message) // 'wrapped'\n ```\n \n-### Deprecation of `app.use()` ([#3506](https://github.com/fastify/fastify/pull/3506))\n-\n-Starting this version of Fastify, we have deprecated the use of `app.use()`. We\n-have decided not to support the use of middlewares. Both\n-[`@fastify/middie`](https://github.com/fastify/middie) and\n-[`@fastify/express`](https://github.com/fastify/fastify-express) will still be\n-there and maintained. Use Fastify's [hooks](../Reference/Hooks.md) instead.\n+>The root error handler is Fastify’s generic error handler.\n+>This error handler will use the headers and status code in the Error object,\n+>if they exist. **The headers and status code will not be automatically set if\n+>a custom error handler is provided**.\n+\n+### Removed `app.use()` ([#3506](https://github.com/fastify/fastify/pull/3506))\n+\n+With v4 of Fastify, `app.use()` has been removed and the use of middleware is\n+no longer supported.\n+\n+If you need to use middleware, use\n+[`@fastify/middie`](https://github.com/fastify/middie) or\n+[`@fastify/express`](https://github.com/fastify/fastify-express), which will\n+continue to be maintained.\n+However, it is strongly recommended that you migrate to Fastify's [hooks](../Reference/Hooks.md).\n+\n+> **Note**: Codemod remove `app.use()` with:\n+>\n+> ```bash\n+> npx codemod@latest fastify/4/remove-app-use\n+> ```\n",
					"match": false,
					"packageHash": "1b1c7dac44ffcdf4df9c1291f4998c49e4a1084fcd91b90545bfb3e203bb465d",
					"size": 3916,
					"sourceHash": "aebd95236fda9209e6de6e8739aa988be3e98f674331aa8ed60903d5aee3dd9d",
					"status": "content"
				},
				"docs/Guides/Plugins-Guide.md": {
					"diff": "--- published/docs/Guides/Plugins-Guide.md\n+++ rebuilt/docs/Guides/Plugins-Guide.md\n@@ -71,8 +71,8 @@\n [`avvio`](https://github.com/mcollina/avvio)! Fastify starts loading the plugin\n __after__ `.listen()`, `.inject()` or `.ready()` are called.\n \n-Inside a plugin you can do whatever you want, register routes, utilities (we\n-will see this in a moment) and do nested registers, just remember to call `done`\n+Inside a plugin you can do whatever you want, register routes and utilities (we\n+will see this in a moment), and do nested registers, just remember to call `done`\n when everything is set up!\n ```js\n module.exports = function (fastify, options, done) {\n@@ -117,7 +117,7 @@\n it - even inside your test.\n \n And here starts the magic; do you remember how just now we were talking about\n-encapsulation? Well, using `register` and `decorate` in conjunction enable\n+encapsulation? Well, using `register` and `decorate` in conjunction enables\n exactly that, let me show you an example to clarify this:\n ```js\n fastify.register((instance, opts, done) => {\n@@ -137,7 +137,7 @@\n `util` exists only inside the first register context.\n \n Let's step back for a moment and dig deeper into this: every time you use the\n-`register` API, a new context is created which avoids the negative situations\n+`register` API, a new context is created that avoids the negative situations\n mentioned above.\n \n Do note that encapsulation applies to the ancestors and siblings, but not the\n@@ -202,7 +202,7 @@\n a function that is defined using the `function` keyword is needed instead\n of an *arrow function expression*.\n \n-In the same way you can do this for the `request` object:\n+You can do the same for the `request` object:\n ```js\n fastify.decorate('getHeader', (req, header) => {\n   return req.headers[header]\n@@ -308,8 +308,52 @@\n ```\n Now your hook will run just for the first route!\n \n+An alternative approach is to make use of the [onRoute hook](../Reference/Hooks.md#onroute)\n+to customize application routes dynamically from inside the plugin. Every time\n+a new route is registered, you can read and modify the route options. For example,\n+based on a [route config option](../Reference/Routes.md#routes-options):\n+\n+```js\n+fastify.register((instance, opts, done) => {\n+  instance.decorate('util', (request, key, value) => { request[key] = value })\n+\n+  function handler(request, reply, done) {\n+    instance.util(request, 'timestamp', new Date())\n+    done()\n+  }\n+\n+  instance.addHook('onRoute', (routeOptions) => {\n+    if (routeOptions.config && routeOptions.config.useUtil === true) {\n+      // set or add our handler to the route preHandler hook\n+      if (!routeOptions.preHandler) {\n+        routeOptions.preHandler = [handler]\n+        return\n+      }\n+      if (Array.isArray(routeOptions.preHandler)) {\n+        routeOptions.preHandler.push(handler)\n+        return\n+      }\n+      routeOptions.preHandler = [routeOptions.preHandler, handler]\n+    }\n+  })\n+\n+  fastify.get('/plugin1', {config: {useUtil: true}}, (request, reply) => {\n+    reply.send(request)\n+  })\n+\n+  fastify.get('/plugin2', (request, reply) => {\n+    reply.send(request)\n+  })\n+\n+  done()\n+})\n+```\n+\n+This variant becomes extremely useful if you plan to distribute your plugin, as\n+described in the next section.\n+\n As you probably noticed by now, `request` and `reply` are not the standard\n-Nodejs *request* and *response* objects, but Fastify's objects.\n+Node.js *request* and *response* objects, but Fastify's objects.\n \n \n ## How to handle encapsulation and distribution\n@@ -351,7 +395,7 @@\n have been declared. This means that, even though the plugin may inject variables\n to the external Fastify instance via [`decorate`](../Reference/Decorators.md),\n the decorated variables will not be accessible before calling `.listen()`,\n-`.inject()` or `.ready()`.\n+`.inject()`, or `.ready()`.\n",
					"match": false,
					"packageHash": "4a683d3b8205b25826d4e6e5b821a93aebebe721be22bdae0072ca78bdbd1c53",
					"size": 16036,
					"sourceHash": "89a6b1163da339cd8bb77ee88092d54b1f5e0490061b7777adaa5298c38a928b",
					"status": "content"
				},
				"docs/Guides/Prototype-Poisoning.md": {
					"diff": "--- published/docs/Guides/Prototype-Poisoning.md\n+++ rebuilt/docs/Guides/Prototype-Poisoning.md\n@@ -4,29 +4,24 @@\n > but otherwise remains the same. The original HTML can be retrieved from the\n > above permission link.\n \n-## A Tale of (prototype) Poisoning\n+## History behind prototype poisoning\n <a id=\"pp\"></a>\n \n-This story is a behind-the-scenes look at the process and drama created by a\n-particularity interesting web security issue. It is also a perfect illustration\n-of the efforts required to maintain popular pieces of open source software and\n-the limitations of existing communication channels.\n-\n-But first, if you use a JavaScript framework to process incoming JSON data, take\n-a moment to read up on [Prototype\n-Poisoning](https://medium.com/intrinsic/javascript-prototype-poisoning-vulnerabilities-in-the-wild-7bc15347c96)\n-in general, and the specific [technical\n-details](https://github.com/hapijs/hapi/issues/3916) of this issue. I'll explain\n-it all in a bit, but since this could be a critical issue, you might want to\n-verify your own code first. While this story is focused on a specific framework,\n-any solution that uses `JSON.parse()` to process external data is potentially at\n-risk.\n+Based on the article by Eran Hammer,the issue is created by a web security bug.\n+It is also a perfect illustration of the efforts required to maintain\n+open-source software and the limitations of existing communication channels.\n+\n+But first, if we use a JavaScript framework to process incoming JSON data, take\n+a moment to read up on [Prototype Poisoning](https://medium.com/intrinsic/javascript-prototype-poisoning-vulnerabilities-in-the-wild-7bc15347c96)\n+in general, and the specific\n+[technical details](https://github.com/hapijs/hapi/issues/3916) of this issue.\n+This could be a critical issue so, we might need to verify your own code first.\n+It focuses on specific framework however, any solution that uses `JSON.parse()`\n+to process external data is potentially at risk.\n \n ### BOOM\n <a id=\"pp-boom\"></a>\n \n-Our story begins with a bang.\n-\n The engineering team at Lob (long time generous supporters of my work!) reported\n a critical security vulnerability they identified in our data validation\n module — [joi](https://github.com/hapijs/joi). They provided some technical\n@@ -34,21 +29,22 @@\n \n The main purpose of a data validation library is to ensure the output fully\n complies with the rules defined. If it doesn't, validation fails. If it passes,\n-your can blindly trust that the data you are working with is safe. In fact, most\n+we can blindly trust that the data you are working with is safe. In fact, most\n developers treat validated input as completely safe from a system integrity\n-perspective. This is crucial.\n+perspective which is crucial!\n \n-In our case, the Lob team provided an example where some data was able to sneak\n+In our case, the Lob team provided an example where some data was able to escape\n by the validation logic and pass through undetected. This is the worst possible\n defect a validation library can have.\n \n ### Prototype in a nutshell\n <a id=\"pp-nutshell\"></a>\n \n-To understand this story, you need to understand how JavaScript works a bit.\n+To understand this, we need to understand how JavaScript works a bit.\n Every object in JavaScript can have a prototype. It is a set of methods and\n-properties it \"inherits\" from another object. I put inherits in quotes because\n-JavaScript isn't really an object oriented language.\n+properties it \"inherits\" from another object. I have put inherits in quotes\n+because JavaScript isn't really an object-oriented language. It is a prototype-\n+based object-oriented language.\n \n A long time ago, for a bunch of irrelevant reasons, someone decided that it\n would be a good idea to use the special property name `__proto__` to access (and\n@@ -68,22 +64,21 @@\n { b: 5 }\n ```\n \n-As you can see, the object doesn't have a `c` property, but its prototype does.\n+The object doesn't have a `c` property, but its prototype does.\n When validating the object, the validation library ignores the prototype and\n only validates the object's own properties. This allows `c` to sneak in via the\n prototype.\n \n-Another important part of this story is the way `JSON.parse()` — a utility\n-provided by the language to convert JSON formatted text into objects  —  handles\n-this magic `__proto__` property name.\n+Another important part is the way `JSON.parse()` — a utility\n+provided by the language to convert JSON formatted text into\n+objects  —  handles this magic `__proto__` property name.\n \n ```\n-> const text = '{ \"b\": 5, \"__proto__\": { \"c\": 6 } }';\n+> const text = '{\"b\": 5, \"__proto__\": { \"c\": 6 }}';\n > const a = JSON.parse(text);\n > a;\n-{ b: 5, __proto__: { c: 6 } }\n+{b: 5, __proto__: { c: 6 }}\n ```\n-\n Notice how `a` has a `__proto__` property. This is not a prototype reference. It\n",
					"match": false,
					"packageHash": "3590a91ff5675217f0f16bc2eb7cab3c1cc62045d1ead5d0bd7177cb95d475a7",
					"size": 18662,
					"sourceHash": "9d563a56ddf65ead95fb68d8b98138ca2c1ac312812ded8a1e716a23d5495264",
					"status": "content"
				},
				"docs/Guides/Recommendations.md": {
					"diff": "--- published/docs/Guides/Recommendations.md\n+++ rebuilt/docs/Guides/Recommendations.md\n@@ -8,6 +8,8 @@\n   - [HAProxy](#haproxy)\n   - [Nginx](#nginx)\n - [Kubernetes](#kubernetes)\n+- [Capacity Planning For Production](#capacity)\n+- [Running Multiple Instances](#multiple)\n \n ## Use A Reverse Proxy\n <a id=\"reverseproxy\"></a>\n@@ -210,17 +212,19 @@\n # server group via port 3000.\n server {\n   # This listen directive asks NGINX to accept requests\n-  # coming to any address, port 443, with SSL, and HTTP/2\n-  # if possible.\n-  listen 443 ssl http2 default_server;\n-  listen [::]:443 ssl http2 default_server;\n+  # coming to any address, port 443, with SSL.\n+  listen 443 ssl default_server;\n+  listen [::]:443 ssl default_server;\n \n   # With a server_name directive you can also ask NGINX to\n   # use this server block only with matching server name(s)\n-  # listen 443 ssl http2;\n-  # listen [::]:443 ssl http2;\n+  # listen 443 ssl;\n+  # listen [::]:443 ssl;\n   # server_name example.tld;\n \n+  # Enable HTTP/2 support\n+  http2 on;\n+\n   # Your SSL/TLS certificate (chain) and secret key in the PEM format\n   ssl_certificate /path/to/fullchain.pem;\n   ssl_certificate_key /path/to/private.pem;\n@@ -281,7 +285,7 @@\n ## Kubernetes\n <a id=\"kubernetes\"></a>\n \n-The `readinessProbe` uses [(by\n+The `readinessProbe` uses ([by\n default](https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#configure-probes))\n the pod IP as the hostname. Fastify listens on `127.0.0.1` by default. The probe\n will not be able to reach the application in this case. To make it work,\n@@ -298,3 +302,52 @@\n     timeoutSeconds: 3\n     successThreshold: 1\n     failureThreshold: 5\n+```\n+\n+## Capacity Planning For Production\n+<a id=\"capacity\"></a>\n+\n+In order to rightsize the production environment for your Fastify application,\n+it is highly recommended that you perform your own measurements against\n+different configurations of the environment, which may\n+use real CPU cores, virtual CPU cores (vCPU), or even fractional\n+vCPU cores. We will use the term vCPU throughout this\n+recommendation to represent any CPU type.\n+\n+Tools such as [k6](https://github.com/grafana/k6)\n+or [autocannon](https://github.com/mcollina/autocannon) can be used for\n+conducting the necessary performance tests.\n+\n+That said, you may also consider the following as a rule of thumb:\n+\n+* To have the lowest possible latency, 2 vCPU are recommended per app\n+instance (e.g., a k8s pod). The second vCPU will mostly be used by the\n+garbage collector (GC) and libuv threadpool. This will minimize the latency\n+for your users, as well as the memory usage, as the GC will be run more\n+frequently. Also, the main thread won't have to stop to let the GC run.\n+\n+* To optimize for throughput (handling the largest possible amount of\n+requests per second per vCPU available), consider using a smaller amount of vCPUs\n+per app instance. It is totally fine to run Node.js applications with 1 vCPU.\n+\n+* You may experiment with an even smaller amount of vCPU, which may provide\n+even better throughput in certain use-cases. There are reports of API gateway\n+solutions working well with 100m-200m vCPU in Kubernetes.\n+\n+See [Node's Event Loop From the Inside Out ](https://www.youtube.com/watch?v=P9csgxBgaZ8)\n+to understand the workings of Node.js in greater detail and make a\n+better determination about what your specific application needs.\n+\n+## Running Multiple Instances\n+<a id=\"multiple\"></a>\n+\n+There are several use-cases where running multiple Fastify\n+apps on the same server might be considered. A common example\n+would be exposing metrics endpoints on a separate port,\n+to prevent public access, when using a reverse proxy or an ingress\n+firewall is not an option.\n+\n+It is perfectly fine to spin up several Fastify instances within the same\n+Node.js process and run them concurrently, even in high load systems.\n+Each Fastify instance only generates as much load as the traffic it receives,\n+plus the memory used for that Fastify instance.\n",
					"match": false,
					"packageHash": "307adda8056fff7c7a861d297d1c5cd3baf12d3516871ca923e77d0912fb4a8a",
					"size": 11775,
					"sourceHash": "f3d72e077332fd141060098fe8c266b8fe19dd22d3ad29d1e67244286a49b08b",
					"status": "content"
				},
				"docs/Guides/Serverless.md": {
					"diff": "--- published/docs/Guides/Serverless.md\n+++ rebuilt/docs/Guides/Serverless.md\n@@ -1,20 +1,20 @@\n <h1 align=\"center\">Serverless</h1>\n \n Run serverless applications and REST APIs using your existing Fastify\n-application. By default, Fastify will not work on your serverless platform of\n-choice, you will need to make some small changes to fix this. This document\n-contains a small guide for the most popular serverless providers and how to use\n+application. You may need to make code changes to work on your\n+serverless platform of choice. This document contains a small guide\n+for the most popular serverless providers and how to use\n Fastify with them.\n \n #### Should you use Fastify in a serverless platform?\n \n-That is up to you! Keep in mind that functions as a service should always use\n+That is up to you! Keep in mind, functions as a service should always use\n small and focused functions, but you can also run an entire web application with\n them. It is important to remember that the bigger the application the slower the\n initial boot will be. The best way to run Fastify applications in serverless\n-environments is to use platforms like Google Cloud Run, AWS Fargate, and Azure\n-Container Instances, where the server can handle multiple requests at the same\n-time and make full use of Fastify's features.\n+environments is to use platforms like Google Cloud Run, AWS Fargate, Azure\n+Container Instances, and Vercel where the server can handle multiple requests\n+at the same time and make full use of Fastify's features.\n \n One of the best features of using Fastify in serverless applications is the ease\n of development. In your local environment, you will always run the Fastify\n@@ -25,7 +25,9 @@\n ### Contents\n \n - [AWS](#aws)\n+- [Genezio](#genezio)\n - [Google Cloud Functions](#google-cloud-functions)\n+- [Google Firebase Functions](#google-firebase-functions)\n - [Google Cloud Run](#google-cloud-run)\n - [Netlify Lambda](#netlify-lambda)\n - [Vercel](#vercel)\n@@ -34,10 +36,10 @@\n \n To integrate with AWS, you have two choices of library:\n \n-- Using [@fastify/aws-lambda](https://github.com/fastify/aws-lambda-fastify) \n+- Using [@fastify/aws-lambda](https://github.com/fastify/aws-lambda-fastify)\n   which only adds API Gateway support but has heavy optimizations for fastify.\n-- Using [@h4ad/serverless-adapter](https://github.com/H4ad/serverless-adapter) \n-  which is a little slower as it creates an HTTP request for each AWS event but \n+- Using [@h4ad/serverless-adapter](https://github.com/H4ad/serverless-adapter)\n+  which is a little slower as it creates an HTTP request for each AWS event but\n   has support for more AWS services such as: AWS SQS, AWS SNS and others.\n \n So you can decide which option is best for you, but you can test both libraries.\n@@ -127,6 +129,13 @@\n [@h4ad/serverless-adapter](https://viniciusl.com.br/serverless-adapter/docs/main/frameworks/fastify)\n on Fastify to find out how to integrate.\n \n+## Genezio\n+\n+[Genezio](https://genezio.com/) is a platform designed to simplify the deployment\n+of serverless applications to the cloud.\n+\n+[Genezio has a dedicated guide for deploying a Fastify application.](https://genezio.com/docs/frameworks/fastify/)\n+\n ## Google Cloud Functions\n \n ### Creation of Fastify instance\n@@ -202,7 +211,7 @@\n   fastify.server.emit('request', request, reply)\n }\n \n-export.fastifyFunction = fastifyFunction;\n+exports.fastifyFunction = fastifyFunction;\n ```\n \n ### Local test\n@@ -228,14 +237,13 @@\n Or add this command to your `package.json` scripts:\n ```json\n \"scripts\": {\n-...\n-\"dev\": \"npx @google-cloud/functions-framework --target=fastifyFunction\"\n-...\n+  ...\n+  \"dev\": \"npx @google-cloud/functions-framework --target=fastifyFunction\"\n+  ...\n }\n ```\n and run it with `npm run dev`.\n \n-\n ### Deploy\n ```bash\n gcloud functions deploy fastifyFunction \\\n@@ -259,6 +267,132 @@\n - [Google Cloud Functions - Node.js Quickstart\n   ](https://cloud.google.com/functions/docs/quickstart-nodejs)\n \n+## Google Firebase Functions\n",
					"match": false,
					"packageHash": "bbcb666fc2964852a5806cef53c01a1a9f0e8df377f272eb2b62cf27bfaa443f",
					"size": 13640,
					"sourceHash": "04a3c35f1490545422d26ae98902b8013f554f65fb04c7aa1ade9faaccdfa92c",
					"status": "content"
				},
				"docs/Guides/Style-Guide.md": {
					"diff": "--- published/docs/Guides/Style-Guide.md\n+++ rebuilt/docs/Guides/Style-Guide.md\n@@ -13,7 +13,7 @@\n to our documentation. You do not need to be an expert in writing technical\n documentation. This guide is here to help you.\n \n-Visit the [contribute](https://www.fastify.io/contribute) page on our website or\n+Visit the [contribute](https://fastify.dev/contribute) page on our website or\n read the\n [CONTRIBUTING.md](https://github.com/fastify/fastify/blob/main/CONTRIBUTING.md)\n file on GitHub to join our Open Source folks.\n@@ -70,12 +70,12 @@\n **Example**\n \n ```\n-To learn more about hooks, see [Fastify hooks](https://www.fastify.io/docs/latest/Reference/Hooks/).\n+To learn more about hooks, see [Fastify hooks](https://fastify.dev/docs/latest/Reference/Hooks/).\n ```\n \n Result:\n >To learn more about hooks, see [Fastify\n->hooks](https://www.fastify.io/docs/latest/Reference/Hooks/).\n+>hooks](https://fastify.dev/docs/latest/Reference/Hooks/).\n \n \n \n@@ -83,7 +83,7 @@\n \n Make sure you avoid copying other people's work. Keep it as original as\n possible. You can learn from what they have done and reference where it is from\n-if you used a particular quote from their work.\n+if you use a particular quote from their work.\n \n \n ## Word Choice\n@@ -217,25 +217,25 @@\n \n ### Hyperlinks\n \n-Hyperlinks should have a clear title of what it references. Here is how your\n+Hyperlinks should have a clear title of what they reference. Here is how your\n hyperlink should look:\n \n ```MD\n <!-- More like this -->\n \n // Add clear & brief description\n-[Fastify Plugins] (https://www.fastify.io/docs/latest/Plugins/)\n+[Fastify Plugins] (https://fastify.dev/docs/latest/Plugins/)\n \n <!--Less like this -->\n \n // incomplete description\n-[Fastify] (https://www.fastify.io/docs/latest/Plugins/)\n+[Fastify] (https://fastify.dev/docs/latest/Plugins/)\n \n // Adding title in link brackets\n-[](https://www.fastify.io/docs/latest/Plugins/ \"fastify plugin\")\n+[](https://fastify.dev/docs/latest/Plugins/ \"fastify plugin\")\n \n // Empty title\n-[](https://www.fastify.io/docs/latest/Plugins/)\n+[](https://fastify.dev/docs/latest/Plugins/)\n \n // Adding links localhost URLs instead of using code strings (``)\n [http://localhost:3000/](http://localhost:3000/)\n",
					"match": false,
					"packageHash": "3ed87ab7426caab036b3ecc8c2ec0016461e80a21d0aa76cbe54762a550e5e6f",
					"size": 7597,
					"sourceHash": "4b218f070b2dc7e2c5f8afc4588956b4a24f3bdffc59900bfa3cfcbc9ace4bcb",
					"status": "content"
				},
				"docs/Guides/Testing.md": {
					"diff": "--- published/docs/Guides/Testing.md\n+++ rebuilt/docs/Guides/Testing.md\n@@ -1,16 +1,19 @@\n-<h1 align=\"center\">Fastify</h1>\n+<h1 style=\"text-align: center;\">Fastify</h1>\n \n-## Testing\n+# Testing\n+<a id=\"testing\"></a>\n \n Testing is one of the most important parts of developing an application. Fastify\n is very flexible when it comes to testing and is compatible with most testing\n-frameworks (such as [Tap](https://www.npmjs.com/package/tap), which is used in\n-the examples below).\n+frameworks (such as [Node Test Runner](https://nodejs.org/api/test.html),\n+which is used in the examples below).\n+\n+## Application\n \n Let's `cd` into a fresh directory called 'testing-example' and type `npm init\n -y` in our terminal.\n \n-Run `npm i fastify && npm i tap pino-pretty -D`\n+Run `npm i fastify && npm i pino-pretty -D`\n \n ### Separating concerns makes testing easy\n \n@@ -110,24 +113,25 @@\n \n In your `package.json` change the \"test\" script to:\n \n-`\"test\": \"tap --reporter=list --watch\"`\n+`\"test\": \"node --test --watch\"`\n \n **app.test.js**:\n \n ```js\n 'use strict'\n \n-const { test } = require('tap')\n+const { test } = require('node:test')\n const build = require('./app')\n \n test('requests the \"/\" route', async t => {\n+  t.plan(1)\n   const app = build()\n \n   const response = await app.inject({\n     method: 'GET',\n     url: '/'\n   })\n-  t.equal(response.statusCode, 200, 'returns a status code of 200')\n+  t.assert.strictEqual(response.statusCode, 200, 'returns a status code of 200')\n })\n ```\n \n@@ -211,26 +215,26 @@\n \n **test.js**\n ```js\n-const tap = require('tap')\n+const { test } = require('node:test')\n const buildFastify = require('./app')\n \n-tap.test('GET `/` route', t => {\n+test('GET `/` route', t => {\n   t.plan(4)\n \n   const fastify = buildFastify()\n \n   // At the end of your tests it is highly recommended to call `.close()`\n   // to ensure that all connections to external services get closed.\n-  t.teardown(() => fastify.close())\n+  t.after(() => fastify.close())\n \n   fastify.inject({\n     method: 'GET',\n     url: '/'\n   }, (err, response) => {\n-    t.error(err)\n-    t.equal(response.statusCode, 200)\n-    t.equal(response.headers['content-type'], 'application/json; charset=utf-8')\n-    t.same(response.json(), { hello: 'world' })\n+    t.assert.ifError(err)\n+    t.assert.strictEqual(response.statusCode, 200)\n+    t.assert.strictEqual(response.headers['content-type'], 'application/json; charset=utf-8')\n+    t.assert.deepStrictEqual(response.json(), { hello: 'world' })\n   })\n })\n ```\n@@ -243,47 +247,81 @@\n \n Uses **app.js** from the previous example.\n \n-**test-listen.js** (testing with\n-[`Request`](https://www.npmjs.com/package/request))\n+**test-listen.js** (testing with [`undici`](https://www.npmjs.com/package/undici))\n ```js\n-const tap = require('tap')\n-const request = require('request')\n",
					"match": false,
					"packageHash": "89f0b8c7ecb63f6a6dffe53b9149c34d8d563141c6052b9b399d561f8d40ce32",
					"size": 6706,
					"sourceHash": "fa22e63b2dc3153006ecf172a09ceb0dbb58509e20c7f6242d42c04a48b262e3",
					"status": "content"
				},
				"docs/Guides/Write-Plugin.md": {
					"diff": "--- published/docs/Guides/Write-Plugin.md\n+++ rebuilt/docs/Guides/Write-Plugin.md\n@@ -1,4 +1,4 @@\n-<h1 align=\"center\">Fastify</h1>\n+<h1 style=\"text-align: center;\">Fastify</h1>\n \n # How to write a good plugin\n First, thank you for deciding to write a plugin for Fastify. Fastify is a\n@@ -14,7 +14,7 @@\n in our issue tracker!*\n \n ## Code\n-Fastify uses different techniques to optimize its code, many of them are\n+Fastify uses different techniques to optimize its code, many of which are\n documented in our Guides. We highly recommend you read [the hitchhiker's guide\n to plugins](./Plugins-Guide.md) to discover all the APIs you can use to build\n your plugin and learn how to use them.\n@@ -53,16 +53,17 @@\n users and give a very fast way to test your plugin. Your users will be grateful.\n \n ## Test\n-It is extremely important that a plugin is thoroughly tested to verify that is\n-working properly.\n+A plugin **must** be thoroughly tested to verify that is working properly.\n \n A plugin without tests will not be accepted to the ecosystem list. A lack of\n tests does not inspire trust nor guarantee that the code will continue to work\n among different versions of its dependencies.\n \n-We do not enforce any testing library. We use [`tap`](https://www.node-tap.org/)\n+We do not enforce any testing library. We use [`node:test`](https://nodejs.org/api/test.html)\n since it offers out-of-the-box parallel testing and code coverage, but it is up\n to you to choose your library of preference.\n+We highly recommend you read the [Plugin Testing](./Testing.md#plugins) to\n+learn about how to test your plugins.\n \n ## Code Linter\n It is not mandatory, but we highly recommend you use a code linter in your\n@@ -80,7 +81,7 @@\n Actions](https://github.com/features/actions) are free for open source projects\n and easy to set up.\n \n-In addition, you can enable services like [Dependabot](https://dependabot.com/),\n+In addition, you can enable services like [Dependabot](https://github.com/dependabot),\n which will help you keep your dependencies up to date and discover if a new\n release of Fastify has some issues with your plugin.\n \n",
					"match": false,
					"packageHash": "f5d35b3c8c2c242430755a089fa0f89e89232b162bb7f0756fcc308b48df062d",
					"size": 4753,
					"sourceHash": "2c634492d2d070b171e1f934aea3a9c2299b150c7fdf2c75dd6087a53a8003dd",
					"status": "content"
				},
				"docs/Reference/ContentTypeParser.md": {
					"diff": "--- published/docs/Reference/ContentTypeParser.md\n+++ rebuilt/docs/Reference/ContentTypeParser.md\n@@ -1,31 +1,34 @@\n <h1 align=\"center\">Fastify</h1>\n \n ## `Content-Type` Parser\n-Natively, Fastify only supports `'application/json'` and `'text/plain'` content\n-types. If the content type is not one of these, an\n-`FST_ERR_CTP_INVALID_MEDIA_TYPE` error will be thrown.\n-\n-The default charset is `utf-8`. If you need to support different content types,\n-you can use the `addContentTypeParser` API. *The default JSON and/or plain text\n-parser can be changed or removed.*\n-\n-*Note: If you decide to specify your own content type with the `Content-Type`\n-header, UTF-8 will not be the default. Be sure to include UTF-8 like this\n-`text/html; charset=utf-8`.*\n-\n-As with the other APIs, `addContentTypeParser` is encapsulated in the scope in\n-which it is declared. This means that if you declare it in the root scope it\n-will be available everywhere, while if you declare it inside a plugin it will be\n-available only in that scope and its children.\n+Fastify natively supports `'application/json'` and `'text/plain'` content types\n+with a default charset of `utf-8`. These default parsers can be changed or\n+removed.\n+\n+Unsupported content types will throw an `FST_ERR_CTP_INVALID_MEDIA_TYPE` error.\n+\n+To support other content types, use the `addContentTypeParser` API or an\n+existing [plugin](https://fastify.dev/ecosystem/).\n+\n+As with other APIs, `addContentTypeParser` is encapsulated in the scope in which\n+it is declared. If declared in the root scope, it is available everywhere; if\n+declared in a plugin, it is available only in that scope and its children.\n \n Fastify automatically adds the parsed request payload to the [Fastify\n-request](./Request.md) object which you can access with `request.body`.\n+request](./Request.md) object, accessible via `request.body`.\n \n-Note that for `GET` and `HEAD` requests the payload is never parsed. For\n-`OPTIONS` and `DELETE` requests the payload is only parsed if the content type\n-is given in the content-type header. If it is not given, the\n-[catch-all](#catch-all) parser is not executed as with `POST`, `PUT` and\n-`PATCH`, but the payload is simply not parsed.\n+Note that for `GET` and `HEAD` requests, the payload is never parsed. For\n+`OPTIONS` and `DELETE` requests, the payload is parsed only if a valid\n+`content-type` header is provided. Unlike `POST`, `PUT`, and `PATCH`, the\n+[catch-all](#catch-all) parser is not executed, and the payload is simply not\n+parsed.\n+\n+> ⚠ Warning:\n+> When using regular expressions to detect `Content-Type`, it is important to\n+> ensure proper detection. For example, to match `application/*`, use\n+> `/^application\\/([\\w-]+);?/` to match the\n+> [essence MIME type](https://mimesniff.spec.whatwg.org/#mime-type-miscellaneous)\n+> only.\n \n ### Usage\n ```js\n@@ -44,13 +47,13 @@\n \n // Async is also supported in Node versions >= 8.0.0\n fastify.addContentTypeParser('application/jsoff', async function (request, payload) {\n-  var res = await jsoffParserAsync(payload)\n+  const res = await jsoffParserAsync(payload)\n \n   return res\n })\n \n // Handle all content types that matches RegExp\n-fastify.addContentTypeParser(/^image\\/.*/, function (request, payload, done) {\n+fastify.addContentTypeParser(/^image\\/([\\w-]+);?/, function (request, payload, done) {\n   imageParser(payload, function (err, body) {\n     done(err, body)\n   })\n@@ -61,11 +64,10 @@\n ```\n \n Fastify first tries to match a content-type parser with a `string` value before\n-trying to find a matching `RegExp`. If you provide overlapping content types,\n-Fastify tries to find a matching content type by starting with the last one\n-passed and ending with the first one. So if you want to specify a general\n-content type more precisely, first specify the general content type and then the\n-more specific one, like in the example below.\n+trying to find a matching `RegExp`. For overlapping content types, it starts\n+with the last one configured and ends with the first (last in, first out).\n+To specify a general content type more precisely, first specify the general\n+type, then the specific one, as shown below.\n \n ```js\n // Here only the second content type parser is called because its value also matches the first one\n@@ -78,14 +80,34 @@\n fastify.addContentTypeParser('application/vnd.custom+xml', (request, body, done) => {} )\n ```\n \n-Besides the `addContentTypeParser` API there are further APIs that can be used.\n-These are `hasContentTypeParser`, `removeContentTypeParser` and\n-`removeAllContentTypeParsers`.\n+### Using addContentTypeParser with fastify.register\n+When using `addContentTypeParser` with `fastify.register`, avoid `await`\n",
					"match": false,
					"packageHash": "94969b86da1e2454f47b6a287d1e48f90d7c63440f8200f5bda903aa68309c26",
					"size": 8784,
					"sourceHash": "9e0d75a5981577012aa2cf11899d9c10a52f7bd69cf8a281977850b7a7ca6439",
					"status": "content"
				},
				"docs/Reference/Decorators.md": {
					"diff": "--- published/docs/Reference/Decorators.md\n+++ rebuilt/docs/Reference/Decorators.md\n@@ -2,16 +2,15 @@\n \n ## Decorators\n \n-The decorators API allows customization of the core Fastify objects, such as the\n-server instance itself and any request and reply objects used during the HTTP\n-request lifecycle. The decorators API can be used to attach any type of property\n-to the core objects, e.g. functions, plain objects, or native types.\n-\n-This API is *synchronous*. Attempting to define a decoration asynchronously\n-could result in the Fastify instance booting before the decoration completes its\n-initialization. To avoid this issue, and register an asynchronous decoration,\n-the `register` API, in combination with `fastify-plugin`, must be used instead.\n-To learn more, see the [Plugins](./Plugins.md) documentation.\n+The decorators API customizes core Fastify objects, such as the server instance\n+and any request and reply objects used during the HTTP request lifecycle. It\n+can attach any type of property to core objects, e.g., functions, plain\n+objects, or native types.\n+\n+This API is *synchronous*. Defining a decoration asynchronously could result in\n+the Fastify instance booting before the decoration completes. To register an\n+asynchronous decoration, use the `register` API with `fastify-plugin`. See the\n+[Plugins](./Plugins.md) documentation for more details.\n \n Decorating core objects with this API allows the underlying JavaScript engine to\n optimize the handling of server, request, and reply objects. This is\n@@ -35,9 +34,9 @@\n })\n ```\n \n-Since the above example mutates the request object after it has already been\n-instantiated, the JavaScript engine must deoptimize access to the request\n-object. By using the decoration API this deoptimization is avoided:\n+The above example mutates the request object after instantiation, causing the\n+JavaScript engine to deoptimize access. Using the decoration API avoids this\n+deoptimization:\n \n ```js\n // Decorate request with a 'user' property\n@@ -54,17 +53,13 @@\n })\n ```\n \n-Note that it is important to keep the initial shape of a decorated field as\n-close as possible to the value intended to be set dynamically in the future.\n-Initialize a decorator as a `''` if the intended value is a string, and as\n-`null` if it will be an object or a function.\n-\n-Remember this example works only with value types as reference types will be\n-shared amongst all requests. See [decorateRequest](#decorate-request).\n-\n-See [JavaScript engine fundamentals: Shapes and Inline\n-Caches](https://mathiasbynens.be/notes/shapes-ics) for more information on this\n-topic.\n+Keep the initial shape of a decorated field close to its future dynamic value.\n+Initialize a decorator as `''` for strings and `null` for objects or functions.\n+This works only with value types; reference types will throw an error during\n+Fastify startup. See [decorateRequest](#decorate-request) and\n+[JavaScript engine fundamentals: Shapes\n+and Inline Caches](https://mathiasbynens.be/notes/shapes-ics)\n+for more information.\n \n ### Usage\n <a id=\"usage\"></a>\n@@ -72,8 +67,7 @@\n #### `decorate(name, value, [dependencies])`\n <a id=\"decorate\"></a>\n \n-This method is used to customize the Fastify [server](./Server.md)\n-instance.\n+This method customizes the Fastify [server](./Server.md) instance.\n \n For example, to attach a new method to the server instance:\n \n@@ -83,7 +77,7 @@\n })\n ```\n \n-As mentioned above, non-function values can be attached:\n+Non-function values can also be attached to the server instance:\n \n ```js\n fastify.decorate('conf', {\n@@ -101,37 +95,71 @@\n ```\n \n The decorated [Fastify server](./Server.md) is bound to `this` in\n-route [route](./Routes.md) handlers:\n+[route](./Routes.md) handlers:\n \n ```js\n fastify.decorate('db', new DbConnection())\n \n fastify.get('/', async function (request, reply) {\n-  reply({hello: await this.db.query('world')})\n+  // using return\n+  return { hello: await this.db.query('world') }\n+\n",
					"match": false,
					"packageHash": "e438c75a93afa84e4ac118151e207202ae2bf41454f8f45a0a3e4c600a725bc7",
					"size": 8716,
					"sourceHash": "13edba4996e6f8e1dce4e4436d74b7ff2ac997ea6effb659bdf576a1e3695632",
					"status": "content"
				},
				"docs/Reference/Encapsulation.md": {
					"diff": "--- published/docs/Reference/Encapsulation.md\n+++ rebuilt/docs/Reference/Encapsulation.md\n@@ -3,21 +3,20 @@\n ## Encapsulation\n <a id=\"encapsulation\"></a>\n \n-A fundamental feature of Fastify is the \"encapsulation context.\" The\n-encapsulation context governs which [decorators](./Decorators.md), registered\n-[hooks](./Hooks.md), and [plugins](./Plugins.md) are available to\n-[routes](./Routes.md). A visual representation of the encapsulation context\n-is shown in the following figure:\n+A fundamental feature of Fastify is the \"encapsulation context.\" It governs\n+which [decorators](./Decorators.md), registered [hooks](./Hooks.md), and\n+[plugins](./Plugins.md) are available to [routes](./Routes.md). A visual\n+representation of the encapsulation context is shown in the following figure:\n \n ![Figure 1](../resources/encapsulation_context.svg)\n \n-In the above figure, there are several entities:\n+In the figure above, there are several entities:\n \n 1. The _root context_\n 2. Three _root plugins_\n-3. Two _child contexts_ where each _child context_ has\n+3. Two _child contexts_, each with:\n     * Two _child plugins_\n-    * One _grandchild context_ where each _grandchild context_ has\n+    * One _grandchild context_, each with:\n         - Three _child plugins_\n \n Every _child context_ and _grandchild context_ has access to the _root plugins_.\n@@ -26,15 +25,18 @@\n containing _child context_ **does not** have access to the _child plugins_\n registered within its _grandchild context_.\n \n-Given that everything in Fastify is a [plugin](./Plugins.md), except for the\n+Given that everything in Fastify is a [plugin](./Plugins.md) except for the\n _root context_, every \"context\" and \"plugin\" in this example is a plugin\n-that can consist of decorators, hooks, plugins, and routes. Thus, to put\n-this example into concrete terms, consider a basic scenario of a REST API\n-server that has three routes: the first route (`/one`) requires authentication,\n-the second route (`/two`) does not, and the third route (`/three`) has\n-access to the same context as the second route. Using\n-[@fastify/bearer-auth][bearer] to provide the authentication, the code for this\n-example is as follows:\n+that can consist of decorators, hooks, plugins, and routes. As plugins, they\n+must still signal completion either by returning a Promise (e.g., using `async` functions)\n+or by calling the `done` function if using the callback style.\n+\n+To put this\n+example into concrete terms, consider a basic scenario of a REST API server\n+with three routes: the first route (`/one`) requires authentication, the\n+second route (`/two`) does not, and the third route (`/three`) has access to\n+the same context as the second route. Using [@fastify/bearer-auth][bearer] to\n+provide authentication, the code for this example is as follows:\n \n ```js\n 'use strict'\n@@ -52,9 +54,9 @@\n     handler (request, response) {\n       response.send({\n         answer: request.answer,\n-        // request.foo will be undefined as it's only defined in publicContext\n+        // request.foo will be undefined as it is only defined in publicContext\n         foo: request.foo,\n-        // request.bar will be undefined as it's only defined in grandchildContext\n+        // request.bar will be undefined as it is only defined in grandchildContext\n         bar: request.bar\n       })\n     }\n@@ -71,7 +73,7 @@\n       response.send({\n         answer: request.answer,\n         foo: request.foo,\n-        // request.bar will be undefined as it's only defined in grandchildContext\n+        // request.bar will be undefined as it is only defined in grandchildContext\n         bar: request.bar\n       })\n     }\n@@ -97,16 +99,16 @@\n fastify.listen({ port: 8000 })\n ```\n \n-The above server example shows all of the encapsulation concepts outlined in the\n+The server example above demonstrates the encapsulation concepts from the\n original diagram:\n \n 1. Each _child context_ (`authenticatedContext`, `publicContext`, and\n-`grandchildContext`) has access to the `answer` request decorator defined in\n-the _root context_.\n+   `grandchildContext`) has access to the `answer` request decorator defined in\n+   the _root context_.\n 2. Only the `authenticatedContext` has access to the `@fastify/bearer-auth`\n-plugin.\n+   plugin.\n 3. Both the `publicContext` and `grandchildContext` have access to the `foo`\n-request decorator.\n+   request decorator.\n 4. Only the `grandchildContext` has access to the `bar` request decorator.\n \n",
					"match": false,
					"packageHash": "6ce7667fce6f757d685b128df4a27e2f2ae9edb99d6a04ffcbc3f38fc65a7dc6",
					"size": 5903,
					"sourceHash": "35673aa0355b447b5ad9e9e839965d456b26fec96344df491a40ca3959165236",
					"status": "content"
				},
				"docs/Reference/Errors.md": {
					"diff": "--- published/docs/Reference/Errors.md\n+++ rebuilt/docs/Reference/Errors.md\n@@ -3,12 +3,109 @@\n ## Errors\n <a id=\"errors\"></a>\n \n+**Table of contents**\n+- [Errors](#errors)\n+  - [Error Handling In Node.js](#error-handling-in-nodejs)\n+    - [Uncaught Errors](#uncaught-errors)\n+    - [Catching Errors In Promises](#catching-errors-in-promises)\n+  - [Errors In Fastify](#errors-in-fastify)\n+    - [Errors In Input Data](#errors-in-input-data)\n+    - [Catching Uncaught Errors In Fastify](#catching-uncaught-errors-in-fastify)\n+  - [Errors In Fastify Lifecycle Hooks And A Custom Error Handler](#errors-in-fastify-lifecycle-hooks-and-a-custom-error-handler)\n+  - [Fastify Error Codes](#fastify-error-codes)\n+    - [FST_ERR_NOT_FOUND](#fst_err_not_found)\n+    - [FST_ERR_OPTIONS_NOT_OBJ](#fst_err_options_not_obj)\n+    - [FST_ERR_QSP_NOT_FN](#fst_err_qsp_not_fn)\n+    - [FST_ERR_SCHEMA_CONTROLLER_BUCKET_OPT_NOT_FN](#fst_err_schema_controller_bucket_opt_not_fn)\n+    - [FST_ERR_SCHEMA_ERROR_FORMATTER_NOT_FN](#fst_err_schema_error_formatter_not_fn)\n+    - [FST_ERR_AJV_CUSTOM_OPTIONS_OPT_NOT_OBJ](#fst_err_ajv_custom_options_opt_not_obj)\n+    - [FST_ERR_AJV_CUSTOM_OPTIONS_OPT_NOT_ARR](#fst_err_ajv_custom_options_opt_not_arr)\n+    - [FST_ERR_CTP_ALREADY_PRESENT](#fst_err_ctp_already_present)\n+    - [FST_ERR_CTP_INVALID_TYPE](#fst_err_ctp_invalid_type)\n+    - [FST_ERR_CTP_EMPTY_TYPE](#fst_err_ctp_empty_type)\n+    - [FST_ERR_CTP_INVALID_HANDLER](#fst_err_ctp_invalid_handler)\n+    - [FST_ERR_CTP_INVALID_PARSE_TYPE](#fst_err_ctp_invalid_parse_type)\n+    - [FST_ERR_CTP_BODY_TOO_LARGE](#fst_err_ctp_body_too_large)\n+    - [FST_ERR_CTP_INVALID_MEDIA_TYPE](#fst_err_ctp_invalid_media_type)\n+    - [FST_ERR_CTP_INVALID_CONTENT_LENGTH](#fst_err_ctp_invalid_content_length)\n+    - [FST_ERR_CTP_EMPTY_JSON_BODY](#fst_err_ctp_empty_json_body)\n+    - [FST_ERR_CTP_INVALID_JSON_BODY](#fst_err_ctp_invalid_json_body)\n+    - [FST_ERR_CTP_INSTANCE_ALREADY_STARTED](#fst_err_ctp_instance_already_started)\n+    - [FST_ERR_INSTANCE_ALREADY_LISTENING](#fst_err_instance_already_listening)\n+    - [FST_ERR_DEC_ALREADY_PRESENT](#fst_err_dec_already_present)\n+    - [FST_ERR_DEC_DEPENDENCY_INVALID_TYPE](#fst_err_dec_dependency_invalid_type)\n+    - [FST_ERR_DEC_MISSING_DEPENDENCY](#fst_err_dec_missing_dependency)\n+    - [FST_ERR_DEC_AFTER_START](#fst_err_dec_after_start)\n+    - [FST_ERR_DEC_REFERENCE_TYPE](#fst_err_dec_reference_type)\n+    - [FST_ERR_DEC_UNDECLARED](#fst_err_dec_undeclared)\n+    - [FST_ERR_HOOK_INVALID_TYPE](#fst_err_hook_invalid_type)\n+    - [FST_ERR_HOOK_INVALID_HANDLER](#fst_err_hook_invalid_handler)\n+    - [FST_ERR_HOOK_INVALID_ASYNC_HANDLER](#fst_err_hook_invalid_async_handler)\n+    - [FST_ERR_HOOK_NOT_SUPPORTED](#fst_err_hook_not_supported)\n+    - [FST_ERR_MISSING_MIDDLEWARE](#fst_err_missing_middleware)\n+    - [FST_ERR_HOOK_TIMEOUT](#fst_err_hook_timeout)\n+    - [FST_ERR_LOG_INVALID_DESTINATION](#fst_err_log_invalid_destination)\n+    - [FST_ERR_LOG_INVALID_LOGGER](#fst_err_log_invalid_logger)\n+    - [FST_ERR_LOG_INVALID_LOGGER_INSTANCE](#fst_err_log_invalid_logger_instance)\n+    - [FST_ERR_LOG_INVALID_LOGGER_CONFIG](#fst_err_log_invalid_logger_config)\n+    - [FST_ERR_LOG_LOGGER_AND_LOGGER_INSTANCE_PROVIDED](#fst_err_log_logger_and_logger_instance_provided)\n+    - [FST_ERR_REP_INVALID_PAYLOAD_TYPE](#fst_err_rep_invalid_payload_type)\n+    - [FST_ERR_REP_RESPONSE_BODY_CONSUMED](#fst_err_rep_response_body_consumed)\n+    - [FST_ERR_REP_READABLE_STREAM_LOCKED](#fst_err_rep_readable_stream_locked)\n+    - [FST_ERR_REP_ALREADY_SENT](#fst_err_rep_already_sent)\n+    - [FST_ERR_REP_SENT_VALUE](#fst_err_rep_sent_value)\n+    - [FST_ERR_SEND_INSIDE_ONERR](#fst_err_send_inside_onerr)\n+    - [FST_ERR_SEND_UNDEFINED_ERR](#fst_err_send_undefined_err)\n+    - [FST_ERR_BAD_STATUS_CODE](#fst_err_bad_status_code)\n+    - [FST_ERR_BAD_TRAILER_NAME](#fst_err_bad_trailer_name)\n+    - [FST_ERR_BAD_TRAILER_VALUE](#fst_err_bad_trailer_value)\n+    - [FST_ERR_FAILED_ERROR_SERIALIZATION](#fst_err_failed_error_serialization)\n+    - [FST_ERR_MISSING_SERIALIZATION_FN](#fst_err_missing_serialization_fn)\n+    - [FST_ERR_MISSING_CONTENTTYPE_SERIALIZATION_FN](#fst_err_missing_contenttype_serialization_fn)\n+    - [FST_ERR_REQ_INVALID_VALIDATION_INVOCATION](#fst_err_req_invalid_validation_invocation)\n+    - [FST_ERR_SCH_MISSING_ID](#fst_err_sch_missing_id)\n+    - [FST_ERR_SCH_ALREADY_PRESENT](#fst_err_sch_already_present)\n+    - [FST_ERR_SCH_CONTENT_MISSING_SCHEMA](#fst_err_sch_content_missing_schema)\n+    - [FST_ERR_SCH_DUPLICATE](#fst_err_sch_duplicate)\n+    - [FST_ERR_SCH_VALIDATION_BUILD](#fst_err_sch_validation_build)\n+    - [FST_ERR_SCH_SERIALIZATION_BUILD](#fst_err_sch_serialization_build)\n+    - [FST_ERR_SCH_RESPONSE_SCHEMA_NOT_NESTED_2XX](#fst_err_sch_response_schema_not_nested_2xx)\n+    - [FST_ERR_INIT_OPTS_INVALID](#fst_err_init_opts_invalid)\n+    - [FST_ERR_FORCE_CLOSE_CONNECTIONS_IDLE_NOT_AVAILABLE](#fst_err_force_close_connections_idle_not_available)\n+    - [FST_ERR_DUPLICATED_ROUTE](#fst_err_duplicated_route)\n+    - [FST_ERR_BAD_URL](#fst_err_bad_url)\n+    - [FST_ERR_ASYNC_CONSTRAINT](#fst_err_async_constraint)\n+    - [FST_ERR_INVALID_URL](#fst_err_invalid_url)\n+    - [FST_ERR_ROUTE_OPTIONS_NOT_OBJ](#fst_err_route_options_not_obj)\n+    - [FST_ERR_ROUTE_DUPLICATED_HANDLER](#fst_err_route_duplicated_handler)\n+    - [FST_ERR_ROUTE_HANDLER_NOT_FN](#fst_err_route_handler_not_fn)\n+    - [FST_ERR_ROUTE_MISSING_HANDLER](#fst_err_route_missing_handler)\n+    - [FST_ERR_ROUTE_METHOD_INVALID](#fst_err_route_method_invalid)\n+    - [FST_ERR_ROUTE_METHOD_NOT_SUPPORTED](#fst_err_route_method_not_supported)\n+    - [FST_ERR_ROUTE_BODY_VALIDATION_SCHEMA_NOT_SUPPORTED](#fst_err_route_body_validation_schema_not_supported)\n+    - [FST_ERR_ROUTE_BODY_LIMIT_OPTION_NOT_INT](#fst_err_route_body_limit_option_not_int)\n+    - [FST_ERR_ROUTE_REWRITE_NOT_STR](#fst_err_route_rewrite_not_str)\n+    - [FST_ERR_REOPENED_CLOSE_SERVER](#fst_err_reopened_close_server)\n+    - [FST_ERR_REOPENED_SERVER](#fst_err_reopened_server)\n+    - [FST_ERR_PLUGIN_VERSION_MISMATCH](#fst_err_plugin_version_mismatch)\n+    - [FST_ERR_PLUGIN_CALLBACK_NOT_FN](#fst_err_plugin_callback_not_fn)\n+    - [FST_ERR_PLUGIN_NOT_VALID](#fst_err_plugin_not_valid)\n+    - [FST_ERR_ROOT_PLG_BOOTED](#fst_err_root_plg_booted)\n+    - [FST_ERR_PARENT_PLUGIN_BOOTED](#fst_err_parent_plugin_booted)\n+    - [FST_ERR_PLUGIN_TIMEOUT](#fst_err_plugin_timeout)\n+    - [FST_ERR_PLUGIN_NOT_PRESENT_IN_INSTANCE](#fst_err_plugin_not_present_in_instance)\n+    - [FST_ERR_PLUGIN_INVALID_ASYNC_HANDLER](#fst_err_plugin_invalid_async_handler)\n+    - [FST_ERR_VALIDATION](#fst_err_validation)\n+    - [FST_ERR_LISTEN_OPTIONS_INVALID](#fst_err_listen_options_invalid)\n",
					"match": false,
					"packageHash": "6a71c3863f5eedbaa4d5c1824ea40cfdc6ff1bd0823be5cfff4e204bde6d1fbd",
					"size": 7746,
					"sourceHash": "46c05c2201a1339a97de3bd7ee8a956f74392ed111f39919f602162719485db9",
					"status": "content"
				},
				"docs/Reference/HTTP2.md": {
					"diff": "--- published/docs/Reference/HTTP2.md\n+++ rebuilt/docs/Reference/HTTP2.md\n@@ -2,11 +2,11 @@\n \n ## HTTP2\n \n-_Fastify_ supports HTTP2 over either HTTPS (h2) or plaintext (h2c).\n+_Fastify_ supports HTTP2 over HTTPS (h2) or plaintext (h2c).\n \n Currently, none of the HTTP2-specific APIs are available through _Fastify_, but\n-Node's `req` and `res` can be accessed through our `Request` and `Reply`\n-interface. PRs are welcome.\n+Node's `req` and `res` can be accessed through the `Request` and `Reply`\n+interfaces. PRs are welcome.\n \n ### Secure (HTTPS)\n \n@@ -15,8 +15,8 @@\n ```js\n 'use strict'\n \n-const fs = require('fs')\n-const path = require('path')\n+const fs = require('node:fs')\n+const path = require('node:path')\n const fastify = require('fastify')({\n   http2: true,\n   https: {\n@@ -32,7 +32,8 @@\n fastify.listen({ port: 3000 })\n ```\n \n-ALPN negotiation allows support for both HTTPS and HTTP/2 over the same socket.\n+[ALPN negotiation](https://datatracker.ietf.org/doc/html/rfc7301) allows\n+support for both HTTPS and HTTP/2 over the same socket.\n Node core `req` and `res` objects can be either\n [HTTP/1](https://nodejs.org/api/http.html) or\n [HTTP/2](https://nodejs.org/api/http2.html). _Fastify_ supports this out of the\n@@ -41,8 +42,8 @@\n ```js\n 'use strict'\n \n-const fs = require('fs')\n-const path = require('path')\n+const fs = require('node:fs')\n+const path = require('node:path')\n const fastify = require('fastify')({\n   http2: true,\n   https: {\n@@ -60,7 +61,7 @@\n fastify.listen({ port: 3000 })\n ```\n \n-You can test your new server with:\n+Test the new server with:\n \n ```\n $ npx h2url https://localhost:3000\n@@ -68,8 +69,8 @@\n \n ### Plain or insecure\n \n-If you are building microservices, you can connect to HTTP2 in plain text,\n-however, this is not supported by browsers.\n+For microservices, HTTP2 can connect in plain text, but this is not\n+supported by browsers.\n \n ```js\n 'use strict'\n@@ -85,7 +86,7 @@\n fastify.listen({ port: 3000 })\n ```\n \n-You can test your new server with:\n+Test the new server with:\n \n ```\n $ npx h2url http://localhost:3000\n",
					"match": false,
					"packageHash": "fc604d656381c9433da5c2da03913f6e41a96d94792cc03b46b74c0072233d65",
					"size": 2122,
					"sourceHash": "c855b2736c3f2884882a714274988aead527d5b7bf6ef57761d3a218cec4ae26",
					"status": "content"
				},
				"docs/Reference/Hooks.md": {
					"diff": "--- published/docs/Reference/Hooks.md\n+++ rebuilt/docs/Reference/Hooks.md\n@@ -19,11 +19,14 @@\n   - [onSend](#onsend)\n   - [onResponse](#onresponse)\n   - [onTimeout](#ontimeout)\n+  - [onRequestAbort](#onrequestabort)\n   - [Manage Errors from a hook](#manage-errors-from-a-hook)\n   - [Respond to a request from a hook](#respond-to-a-request-from-a-hook)\n - [Application Hooks](#application-hooks)\n   - [onReady](#onready)\n+  - [onListen](#onlisten)\n   - [onClose](#onclose)\n+  - [preClose](#preclose)\n   - [onRoute](#onroute)\n   - [onRegister](#onregister)\n - [Scope](#scope)\n@@ -31,9 +34,9 @@\n - [Using Hooks to Inject Custom Properties](#using-hooks-to-inject-custom-properties)\n - [Diagnostics Channel Hooks](#diagnostics-channel-hooks)\n \n-**Notice:** the `done` callback is not available when using `async`/`await` or\n-returning a `Promise`. If you do invoke a `done` callback in this situation\n-unexpected behavior may occur, e.g. duplicate invocation of handlers.\n+> ℹ️ Note: The `done` callback is not available when using `async`/`await` or\n+> returning a `Promise`. If you do invoke a `done` callback in this situation\n+> unexpected behavior may occur, e.g. duplicate invocation of handlers.\n \n ## Request/Reply Hooks\n \n@@ -65,9 +68,9 @@\n })\n ```\n \n-**Notice:** in the [onRequest](#onrequest) hook, `request.body` will always be\n-`undefined`, because the body parsing happens before the\n-[preValidation](#prevalidation) hook.\n+> ℹ️ Note: In the [onRequest](#onrequest) hook, `request.body` will always be\n+> `undefined`, because the body parsing happens before the\n+> [preValidation](#prevalidation) hook.\n \n ### preParsing\n \n@@ -78,7 +81,7 @@\n If it returns a value (via `return` or via the callback function), it must\n return a stream.\n \n-For instance, you can uncompress the request body:\n+For instance, you can decompress the request body:\n \n ```js\n fastify.addHook('preParsing', (request, reply, payload, done) => {\n@@ -95,14 +98,17 @@\n })\n ```\n \n-**Notice:** in the [preParsing](#preparsing) hook, `request.body` will always be\n-`undefined`, because the body parsing happens before the\n-[preValidation](#prevalidation) hook.\n-\n-**Notice:** you should also add a `receivedEncodedLength` property to the\n-returned stream. This property is used to correctly match the request payload\n-with the `Content-Length` header value. Ideally, this property should be updated\n-on each received chunk.\n+> ℹ️ Note: In the [preParsing](#preparsing) hook, `request.body` will always be\n+> `undefined`, because the body parsing happens before the\n+> [preValidation](#prevalidation) hook.\n+\n+> ℹ️ Note: You should also add a `receivedEncodedLength` property to the\n+> returned stream. This property is used to correctly match the request payload\n+> with the `Content-Length` header value. Ideally, this property should be updated\n+> on each received chunk.\n+\n+> ℹ️ Note: The size of the returned stream is checked to not exceed the limit\n+> set in [`bodyLimit`](./Server.md#bodylimit) option.\n \n ### preValidation\n \n@@ -124,6 +130,10 @@\n ```\n \n ### preHandler\n+\n+The `preHandler` hook allows you to specify a function that is executed before\n+a routes's handler.\n+\n ```js\n fastify.addHook('preHandler', (request, reply, done) => {\n   // some code\n@@ -156,8 +166,8 @@\n })\n ```\n \n-Note: the hook is NOT called if the payload is a `string`, a `Buffer`, a\n-`stream`, or `null`.\n+> ℹ️ Note: The hook is NOT called if the payload is a `string`, a `Buffer`, a\n+> `stream`, or `null`.\n \n ### onError\n ```js\n",
					"match": false,
					"packageHash": "de516ba2ee986a6d9b1b880a6a08f65327a15f895bdd15f2b2dc0ce46d5c0aa3",
					"size": 22668,
					"sourceHash": "90c5325926bd4b30058e4b6b239cbcf14b77d4091c80b8796995558c19c8044b",
					"status": "content"
				},
				"docs/Reference/Index.md": {
					"diff": "--- published/docs/Reference/Index.md\n+++ rebuilt/docs/Reference/Index.md\n@@ -69,3 +69,5 @@\n + [Validation and Serialization](./Validation-and-Serialization.md): Details\n   Fastify's support for validating incoming data and how Fastify serializes data\n   for responses.\n++ [Warnings](./Warnings.md): Details the warnings Fastify emits and how to\n+  solve them.\n",
					"match": false,
					"packageHash": "20da145b6dbb7310c598a99bd49e4610cc575709f7793293adca7f2ac1b3d339",
					"size": 3694,
					"sourceHash": "14a539141a11b1ccfff22271e048e67edc0c781cd88c492f3ac44794f3af4e7f",
					"status": "content"
				},
				"docs/Reference/LTS.md": {
					"diff": "--- published/docs/Reference/LTS.md\n+++ rebuilt/docs/Reference/LTS.md\n@@ -10,18 +10,25 @@\n    versions, are supported for a minimum period of six months from their release\n    date. The release date of any specific version can be found at\n    [https://github.com/fastify/fastify/releases](https://github.com/fastify/fastify/releases).\n-\n 2. Major releases will receive security updates for an additional six months\n    from the release of the next major release. After this period we will still\n    review and release security fixes as long as they are provided by the\n    community and they do not violate other constraints, e.g. minimum supported\n    Node.js version.\n-\n 3. Major releases will be tested and verified against all Node.js release lines\n    that are supported by the [Node.js LTS\n    policy](https://github.com/nodejs/Release) within the LTS period of that\n    given Fastify release line. This implies that only the latest Node.js release\n    of a given line is supported.\n+4. In addition to Node.js runtime, major releases of Fastify will also be tested\n+   and verified against alternative runtimes that are compatible with Node.js.\n+   The maintenance teams of these alternative runtimes are responsible for ensuring\n+   and guaranteeing these tests work properly.\n+   1. [N|Solid](https://docs.nodesource.com/docs/product_suite) tests and\n+      verifies each Fastify major release against current N|Solid LTS versions.\n+      NodeSource ensures Fastify compatibility with N|Solid, aligning with the\n+      support scope of N|Solid LTS versions at the time of the Fastify release.\n+      This guarantees N|Solid users can confidently use Fastify.\n \n A \"month\" is defined as 30 consecutive days.\n \n@@ -31,40 +38,49 @@\n > occasions where we need to release breaking changes as a _minor_ version\n > release. Such changes will _always_ be noted in the [release\n > notes](https://github.com/fastify/fastify/releases).\n->\n+> \n > To avoid automatically receiving breaking security updates it is possible to\n > use the tilde (`~`) range qualifier. For example, to get patches for the 3.15\n > release, and avoid automatically updating to the 3.16 release, specify the\n > dependency as `\"fastify\": \"~3.15.x\"`. This will leave your application\n-> vulnerable, so please use with caution.\n+> vulnerable, so please use it with caution.\n \n-[semver]: https://semver.org/\n+### Security Support Beyond LTS\n+\n+Fastify's partner, HeroDevs, provides commercial security support through the\n+OpenJS Ecosystem Sustainability Program for versions of Fastify that are EOL.\n+For more information, see their [Never Ending Support][hd-link] service.\n \n ### Schedule\n <a id=\"lts-schedule\"></a>\n \n-| Version | Release Date | End Of LTS Date | Node.js              |\n-| :------ | :----------- | :-------------- | :------------------- |\n-| 1.0.0   | 2018-03-06   | 2019-09-01      | 6, 8, 9, 10, 11      |\n-| 2.0.0   | 2019-02-25   | 2021-01-31      | 6, 8, 10, 12, 14     |\n-| 3.0.0   | 2020-07-07   | 2023-06-30      | 10, 12, 14, 16, 18   |\n-| 4.0.0   | 2022-06-08   | TBD             | 14, 16, 18           |\n+| Version | Release Date | End Of LTS Date | Node.js            | Nsolid(Node)   |\n+| :------ | :----------- | :-------------- | :----------------- | :------------- |\n+| 1.0.0   | 2018-03-06   | 2019-09-01      | 6, 8, 9, 10, 11    |                |\n+| 2.0.0   | 2019-02-25   | 2021-01-31      | 6, 8, 10, 12, 14   |                |\n+| 3.0.0   | 2020-07-07   | 2023-06-30      | 10, 12, 14, 16, 18 | v5(18)         |\n+| 4.0.0   | 2022-06-08   | 2025-06-30      | 14, 16, 18, 20, 22 | v5(18), v5(20) |\n+| 5.0.0   | 2024-09-17   | TBD             | 20, 22             | v5(20)         |\n \n ### CI tested operating systems\n <a id=\"supported-os\"></a>\n \n-Fastify uses GitHub Actions for CI testing, please refer to [GitHub's\n+Fastify uses GitHub Actions for CI testing, please refer to [GitHub&#39;s\n documentation regarding workflow\n runners](https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners#supported-runners-and-hardware-resources)\n for further details on what the latest virtual environment is in relation to the\n YAML workflow labels below:\n \n-| OS      | YAML Workflow Label    | Package Manager           | Node.js      |\n-|---------|------------------------|---------------------------|--------------|\n-| Linux   | `ubuntu-latest`        | npm                       | 14,16,18     |\n-| Linux   | `ubuntu-18.04`         | yarn,pnpm                 | 14,16,18     |\n-| Windows | `windows-latest`       | npm                       | 14,16,18     |\n-| MacOS   | `macos-latest`         | npm                       | 14,16,18     |\n+| OS      | YAML Workflow Label | Package Manager | Node.js     | Nsolid(Node)  |\n+| ------- | ------------------- | --------------- | ----------- | ------------- |\n+| Linux   | `ubuntu-latest`     | npm             | 20          | v5(20)        |\n+| Linux   | `ubuntu-latest`     | yarn,pnpm       | 20          | v5(20)        |\n+| Windows | `windows-latest`    | npm             | 20          | v5(20)        |\n+| MacOS   | `macos-latest`      | npm             | 20          | v5(20)        |\n \n Using [yarn](https://yarnpkg.com/) might require passing the `--ignore-engines`\n flag.\n+\n+[semver]: https://semver.org/\n+\n+[hd-link]: https://www.herodevs.com/support/fastify-nes?utm_source=fastify&utm_medium=link&utm_campaign=eol_support_fastify\n",
					"match": false,
					"packageHash": "841fc604cbbd30625f11a557bb7ef11328f063cabc911e0f038e8010c38022b6",
					"size": 3305,
					"sourceHash": "c67bb7629660831a93db4693161bb7100300c8909caee3219f86338a60abe239",
					"status": "content"
				},
				"docs/Reference/Lifecycle.md": {
					"diff": "--- published/docs/Reference/Lifecycle.md\n+++ rebuilt/docs/Reference/Lifecycle.md\n@@ -1,12 +1,13 @@\n <h1 align=\"center\">Fastify</h1>\n \n ## Lifecycle\n-Following the schema of the internal lifecycle of Fastify.\n+<a id=\"lifecycle\"></a>\n \n-On the right branch of every section there is the next phase of the lifecycle,\n-on the left branch there is the corresponding error code that will be generated\n-if the parent throws an error *(note that all the errors are automatically\n-handled by Fastify)*.\n+This schema shows the internal lifecycle of Fastify.\n+\n+The right branch of each section shows the next phase of the lifecycle. The left\n+branch shows the corresponding error code generated if the parent throws an\n+error. All errors are automatically handled by Fastify.\n \n ```\n Incoming Request\n@@ -40,25 +41,23 @@\n                                                                             └─▶ onResponse Hook\n ```\n \n-At any point before or during the `User Handler`, `reply.hijack()` can be called\n-to prevent Fastify from:\n-- Running all the following hooks and user handler\n-- Sending the response automatically\n+Before or during the `User Handler`, `reply.hijack()` can be called to:\n+- Prevent Fastify from running subsequent hooks and the user handler\n+- Prevent Fastify from sending the response automatically\n \n-NB (*): If `reply.raw` is used to send a response back to the user, `onResponse`\n-hooks will still be executed\n+If `reply.raw` is used to send a response, `onResponse` hooks will still\n+be executed.\n \n ## Reply Lifecycle\n+<a id=\"reply-lifecycle\"></a>\n \n-Whenever the user handles the request, the result may be:\n+When the user handles the request, the result may be:\n \n-- in async handler: it returns a payload\n-- in async handler: it throws an `Error`\n-- in sync handler: it sends a payload\n-- in sync handler: it sends an `Error` instance\n+- In an async handler: it returns a payload or throws an `Error`\n+- In a sync handler: it sends a payload or an `Error` instance\n \n-If the reply was hijacked, we skip all the below steps. Otherwise, when it is\n-being submitted, the data flow performed is the following:\n+If the reply was hijacked, all subsequent steps are skipped. Otherwise, when\n+submitted, the data flow is as follows:\n \n ```\n                         ★ schema validation Error\n@@ -71,16 +70,15 @@\n                      ★ send or return                 │                 │\n                             │                         │                 │\n                             │                         ▼                 │\n-       reply sent ◀── JSON ─┴─ Error instance ──▶ setErrorHandler ◀─────┘\n+       reply sent ◀── JSON ─┴─ Error instance ──▶ onError Hook ◀───────┘\n                                                       │\n-                                 reply sent ◀── JSON ─┴─ Error instance ──▶ onError Hook\n+                                 reply sent ◀── JSON ─┴─ Error instance ──▶ setErrorHandler\n                                                                                 │\n                                                                                 └─▶ reply sent\n ```\n \n-Note: `reply sent` means that the JSON payload will be serialized by:\n-\n-- the [reply serialized](./Server.md#setreplyserializer) if set\n-- or by the [serializer compiler](./Server.md#setserializercompiler) when a JSON\n-  schema has been set for the returning HTTP status code\n-- or by the default `JSON.stringify` function\n+`reply sent` means the JSON payload will be serialized by one of the following:\n+- The [reply serializer](./Server.md#setreplyserializer) if set\n+- The [serializer compiler](./Server.md#setserializercompiler) if a JSON schema\n+  is set for the HTTP status code\n+- The default `JSON.stringify` function\n\\ No newline at end of file\n",
					"match": false,
					"packageHash": "8c8a68b5ca0d01481f9e4f5b64ec20d1b910029ff2bfef058b9af9e1562f9a30",
					"size": 4031,
					"sourceHash": "25ab24b0bb490b03000411c5799d0a7183549b49f723c7d9384465e735e62ea1",
					"status": "content"
				},
				"docs/Reference/Logging.md": {
					"diff": "--- published/docs/Reference/Logging.md\n+++ rebuilt/docs/Reference/Logging.md\n@@ -2,17 +2,18 @@\n \n ## Logging\n \n-### Enable logging\n-Logging is disabled by default, and you can enable it by passing `{ logger: true\n-}` or `{ logger: { level: 'info' } }` when you create a Fastify instance. Note\n-that if the logger is disabled, it is impossible to enable it at runtime. We use\n-[abstract-logging](https://www.npmjs.com/package/abstract-logging) for this\n-purpose.\n+### Enable Logging\n+Logging is disabled by default. Enable it by passing `{ logger: true }` or\n+`{ logger: { level: 'info' } }` when creating a Fastify instance. Note that if\n+the logger is disabled, it cannot be enabled at runtime.\n+[abstract-logging](https://www.npmjs.com/package/abstract-logging) is used for\n+this purpose.\n \n As Fastify is focused on performance, it uses\n [pino](https://github.com/pinojs/pino) as its logger, with the default log\n-level, when enabled, set to `'info'`.\n+level set to `'info'` when enabled.\n \n+#### Basic logging setup\n Enabling the production JSON logger:\n \n ```js\n@@ -21,29 +22,33 @@\n })\n ```\n \n-Enabling the logger with appropriate configuration for both local development\n-and production environment requires bit more configuration:\n+#### Environment-Specific Configuration\n+Enabling the logger with appropriate configuration for local development,\n+production, and test environments requires more configuration:\n+\n ```js\n+const envToLogger = {\n+  development: {\n+    transport: {\n+      target: 'pino-pretty',\n+      options: {\n+        translateTime: 'HH:MM:ss Z',\n+        ignore: 'pid,hostname',\n+      },\n+    },\n+  },\n+  production: true,\n+  test: false,\n+}\n const fastify = require('fastify')({\n-  logger: {\n-      transport:\n-        environment === 'development'\n-          ? {\n-              target: 'pino-pretty',\n-              options: {\n-                translateTime: 'HH:MM:ss Z',\n-                ignore: 'pid,hostname'\n-              }\n-            }\n-          : undefined\n-    }\n+  logger: envToLogger[environment] ?? true // defaults to true if no entry matches in the map\n })\n ```\n-⚠️ `pino-pretty` needs to be installed as a dev dependency, it is not included\n+⚠️ `pino-pretty` needs to be installed as a dev dependency. It is not included\n by default for performance reasons.\n \n ### Usage\n-You can use the logger like this in your route handlers:\n+The logger can be used in route handlers as follows:\n \n ```js\n fastify.get('/', options, function (request, reply) {\n@@ -52,16 +57,16 @@\n })\n ```\n \n-You can trigger new logs outside route handlers by using the Pino instance from\n-the Fastify instance:\n+Trigger new logs outside route handlers using the Pino instance from the Fastify\n+instance:\n ```js\n fastify.log.info('Something important happened!');\n ```\n \n-If you want to pass some options to the logger, just pass them to Fastify. You\n-can find all available options in the [Pino\n-documentation](https://github.com/pinojs/pino/blob/master/docs/api.md#pinooptions-stream).\n-If you want to specify a file destination, use:\n+#### Passing Logger Options\n+To pass options to the logger, provide them to Fastify. See the\n+[Pino documentation](https://github.com/pinojs/pino/blob/master/docs/api.md#options)\n+for available options. To specify a file destination, use:\n \n ```js\n",
					"match": false,
					"packageHash": "6260aa9063d4be69d80d8d47fb49e01eae5901a123dbc95a3df1069516657d43",
					"size": 6150,
					"sourceHash": "07bfe4574c571e54051b7f220e1c7d820c965e81859a4a98d640a4d26e1b7edb",
					"status": "content"
				},
				"docs/Reference/Middleware.md": {
					"diff": "--- published/docs/Reference/Middleware.md\n+++ rebuilt/docs/Reference/Middleware.md\n@@ -22,39 +22,39 @@\n fastify.use(require('x-xss-protection')())\n ```\n \n-You can also use [`@fastify/middie`](https://github.com/fastify/middie), which provides\n-support for simple Express-style middleware but with improved performance:\n+[`@fastify/middie`](https://github.com/fastify/middie) can also be used,\n+which provides support for simple Express-style middleware with improved\n+performance:\n \n ```js\n await fastify.register(require('@fastify/middie'))\n fastify.use(require('cors')())\n ```\n \n-Remember that middleware can be encapsulated; this means that you can decide\n-where your middleware should run by using `register` as explained in the\n-[plugins guide](../Guides/Plugins-Guide.md).\n+Middleware can be encapsulated, allowing control over where it runs using\n+`register` as explained in the [plugins guide](../Guides/Plugins-Guide.md).\n \n-Fastify middleware does not expose the `send` method or other methods specific to\n-the Fastify [Reply](./Reply.md#reply) instance. This is because Fastify wraps\n+Fastify middleware does not expose the `send` method or other methods specific\n+to the Fastify [Reply](./Reply.md#reply) instance. This is because Fastify wraps\n the incoming `req` and `res` Node instances using the\n [Request](./Request.md#request) and [Reply](./Reply.md#reply) objects\n-internally, but this is done after the middleware phase. If you need to create\n-middleware, you have to use the Node `req` and `res` instances. Otherwise, you\n-can use the `preHandler` hook that already has the\n-[Request](./Request.md#request) and [Reply](./Reply.md#reply) Fastify instances.\n-For more information, see [Hooks](./Hooks.md#hooks).\n+internally, but this is done after the middleware phase. To create middleware,\n+use the Node `req` and `res` instances. Alternatively, use the `preHandler` hook\n+that already has the Fastify [Request](./Request.md#request) and\n+[Reply](./Reply.md#reply) instances. For more information, see\n+[Hooks](./Hooks.md#hooks).\n \n #### Restrict middleware execution to certain paths\n <a id=\"restrict-usage\"></a>\n \n-If you need to only run middleware under certain paths, just pass the path as\n-the first parameter to `use` and you are done!\n+To run middleware under certain paths, pass the path as the first parameter to\n+`use`.\n \n-*Note that this does not support routes with parameters, (e.g.\n-`/user/:id/comments`) and wildcards are not supported in multiple paths.*\n+> ℹ️ Note: This does not support routes with parameters\n+> (e.g. `/user/:id/comments`) and wildcards are not supported in multiple paths.\n \n ```js\n-const path = require('path')\n+const path = require('node:path')\n const serveStatic = require('serve-static')\n \n // Single path\n@@ -69,10 +69,10 @@\n \n ### Alternatives\n \n-Fastify offers some alternatives to the most commonly used middleware, such as\n-[`@fastify/helmet`](https://github.com/fastify/fastify-helmet) in case of\n+Fastify offers alternatives to commonly used middleware, such as\n+[`@fastify/helmet`](https://github.com/fastify/fastify-helmet) for\n [`helmet`](https://github.com/helmetjs/helmet),\n [`@fastify/cors`](https://github.com/fastify/fastify-cors) for\n [`cors`](https://github.com/expressjs/cors), and\n [`@fastify/static`](https://github.com/fastify/fastify-static) for\n-[`serve-static`](https://github.com/expressjs/serve-static).\n+[`serve-static`](https://github.com/expressjs/serve-static).\n\\ No newline at end of file\n",
					"match": false,
					"packageHash": "aec245db147a53a6ff3366b4d791aef7eb6c1eb925e6b410e361e9c7a7df316f",
					"size": 2940,
					"sourceHash": "64a4f244da14c5133e73255ddf91a59d582c3234921447b9f1e40a8979bc3bfc",
					"status": "content"
				},
				"docs/Reference/Plugins.md": {
					"diff": "--- published/docs/Reference/Plugins.md\n+++ rebuilt/docs/Reference/Plugins.md\n@@ -1,21 +1,18 @@\n <h1 align=\"center\">Fastify</h1>\n \n ## Plugins\n-Fastify allows the user to extend its functionalities with plugins. A plugin can\n-be a set of routes, a server [decorator](./Decorators.md), or whatever. The API\n-that you will need to use one or more plugins, is `register`.\n-\n-By default, `register` creates a *new scope*, this means that if you make some\n-changes to the Fastify instance (via `decorate`), this change will not be\n-reflected by the current context ancestors, but only by its descendants. This\n-feature allows us to achieve plugin *encapsulation* and *inheritance*, in this\n-way we create a *directed acyclic graph* (DAG) and we will not have issues\n-caused by cross dependencies.\n-\n-You may have already seen in the [Getting\n-Started](../Guides/Getting-Started.md#your-first-plugin) guide how easy it is\n-to use this API:\n-```\n+Fastify can be extended with plugins, which can be a set of routes, a server\n+[decorator](./Decorators.md), or other functionality. Use the `register` API to\n+add one or more plugins.\n+\n+By default, `register` creates a *new scope*, meaning changes to the Fastify\n+instance (via `decorate`) will not affect the current context ancestors, only\n+its descendants. This feature enables plugin *encapsulation* and *inheritance*,\n+creating a *directed acyclic graph* (DAG) and avoiding cross-dependency issues.\n+\n+The [Getting Started](../Guides/Getting-Started.md#your-first-plugin) guide\n+includes an example of using this API:\n+```js\n fastify.register(plugin, [options])\n ```\n \n@@ -33,10 +30,9 @@\n + [`logSerializers`](./Routes.md#custom-log-serializer)\n + [`prefix`](#route-prefixing-option)\n \n-**Note: Those options will be ignored when used with fastify-plugin**\n+These options will be ignored when used with fastify-plugin.\n \n-It is possible that Fastify will directly support other options in the future.\n-Thus, to avoid collisions, a plugin should consider namespacing its options. For\n+To avoid collisions, a plugin should consider namespacing its options. For\n example, a plugin `foo` might be registered like so:\n \n ```js\n@@ -49,8 +45,7 @@\n })\n ```\n \n-If collisions are not a concern, the plugin may simply accept the options object\n-as-is:\n+If collisions are not a concern, the plugin may accept the options object as-is:\n \n ```js\n fastify.register(require('fastify-foo'), {\n@@ -60,9 +55,8 @@\n })\n ```\n \n-The `options` parameter can also be a `Function` that will be evaluated at the\n-time the plugin is registered while giving access to the Fastify instance via\n-the first positional argument:\n+The `options` parameter can also be a `Function` evaluated at plugin registration,\n+providing access to the Fastify instance via the first argument:\n \n ```js\n const fp = require('fastify-plugin')\n@@ -77,40 +71,38 @@\n fastify.register(require('fastify-foo'), parent => parent.foo_bar)\n ```\n \n-The Fastify instance passed on to the function is the latest state of the\n-**external Fastify instance** the plugin was declared on, allowing access to\n-variables injected via [`decorate`](./Decorators.md) by preceding plugins\n-according to the **order of registration**. This is useful in case a plugin\n-depends on changes made to the Fastify instance by a preceding plugin i.e.\n-utilizing an existing database connection to wrap around it.\n-\n-Keep in mind that the Fastify instance passed on to the function is the same as\n-the one that will be passed into the plugin, a copy of the external Fastify\n-instance rather than a reference. Any usage of the instance will behave the same\n-as it would if called within the plugins function i.e. if `decorate` is called,\n-the decorated variables will be available within the plugins function unless it\n-was wrapped with [`fastify-plugin`](https://github.com/fastify/fastify-plugin).\n+The Fastify instance passed to the function is the latest state of the **external\n+Fastify instance** the plugin was declared on, allowing access to variables\n+injected via [`decorate`](./Decorators.md) by preceding plugins according to the\n+**order of registration**. This is useful if a plugin depends on changes made to\n+the Fastify instance by a preceding plugin, such as utilizing an existing database\n+connection.\n+\n+Keep in mind that the Fastify instance passed to the function is the same as the\n+one passed into the plugin, a copy of the external Fastify instance rather than a\n+reference. Any usage of the instance will behave the same as it would if called\n+within the plugin's function. For example, if `decorate` is called, the decorated\n+variables will be available within the plugin's function unless it was wrapped\n",
					"match": false,
					"packageHash": "aca5c0e19170f5a30d930f4e70f63e44298d0bf14fc3a1627f927c5f3535345f",
					"size": 7938,
					"sourceHash": "ed80978a835b6ac5ae71d178574e29077f857bbdf8ad1b62729cffd4f4fa8367",
					"status": "content"
				},
				"docs/Reference/Reply.md": {
					"diff": "--- published/docs/Reference/Reply.md\n+++ rebuilt/docs/Reference/Reply.md\n@@ -4,25 +4,25 @@\n - [Reply](#reply)\n   - [Introduction](#introduction)\n   - [.code(statusCode)](#codestatuscode)\n+  - [.elapsedTime](#elapsedtime)\n   - [.statusCode](#statuscode)\n   - [.server](#server)\n   - [.header(key, value)](#headerkey-value)\n-      - [set-cookie](#set-cookie)\n   - [.headers(object)](#headersobject)\n   - [.getHeader(key)](#getheaderkey)\n   - [.getHeaders()](#getheaders)\n   - [.removeHeader(key)](#removeheaderkey)\n   - [.hasHeader(key)](#hasheaderkey)\n+  - [.writeEarlyHints(hints, callback)](#writeearlyhintshints-callback)\n   - [.trailer(key, function)](#trailerkey-function)\n   - [.hasTrailer(key)](#hastrailerkey)\n   - [.removeTrailer(key)](#removetrailerkey)\n-  - [.redirect([code,] dest)](#redirectcode--dest)\n+  - [.redirect(dest, [code ,])](#redirectdest--code)\n   - [.callNotFound()](#callnotfound)\n-  - [.getResponseTime()](#getresponsetime)\n   - [.type(contentType)](#typecontenttype)\n-  - [.getSerializationFunction(schema | httpStatus)](#getserializationfunction)\n-  - [.compileSerializationSchema(schema, httpStatus)](#compileserializationschema)\n-  - [.serializeInput(data, [schema | httpStatus], [httpStatus])](#serializeinput)\n+  - [.getSerializationFunction(schema | httpStatus, [contentType])](#getserializationfunctionschema--httpstatus)\n+  - [.compileSerializationSchema(schema, [httpStatus], [contentType])](#compileserializationschemaschema-httpstatus)\n+  - [.serializeInput(data, [schema | httpStatus], [httpStatus], [contentType])](#serializeinputdata-schema--httpstatus-httpstatus)\n   - [.serializer(func)](#serializerfunc)\n   - [.raw](#raw)\n   - [.sent](#sent)\n@@ -32,6 +32,9 @@\n     - [Strings](#strings)\n     - [Streams](#streams)\n     - [Buffers](#buffers)\n+    - [TypedArrays](#typedarrays)\n+    - [ReadableStream](#readablestream)\n+    - [Response](#response)\n     - [Errors](#errors)\n     - [Type of the final payload](#type-of-the-final-payload)\n     - [Async-Await and Promises](#async-await-and-promises)\n@@ -46,6 +49,8 @@\n - `.code(statusCode)` - Sets the status code.\n - `.status(statusCode)` - An alias for `.code(statusCode)`.\n - `.statusCode` - Read and set the HTTP status code.\n+- `.elapsedTime` - Returns the amount of time passed\n+since the request was received by Fastify.\n - `.server` - A reference to the fastify instance object.\n - `.header(name, value)` - Sets a response header.\n - `.headers(object)` - Sets all the keys of the object as response headers.\n@@ -53,26 +58,29 @@\n - `.getHeaders()` - Gets a shallow copy of all current response headers.\n - `.removeHeader(key)` - Remove the value of a previously set header.\n - `.hasHeader(name)` - Determine if a header has been set.\n+- `.writeEarlyHints(hints, callback)` - Sends early hints to the user\n+  while the response is being prepared.\n - `.trailer(key, function)` - Sets a response trailer.\n - `.hasTrailer(key)` - Determine if a trailer has been set.\n - `.removeTrailer(key)` - Remove the value of a previously set trailer.\n - `.type(value)` - Sets the header `Content-Type`.\n-- `.redirect([code,] dest)` - Redirect to the specified url, the status code is\n-  optional (default to `302`).\n+- `.redirect(dest, [code,])` - Redirect to the specified URL, the status code is\n+  optional (defaults to `302`).\n - `.callNotFound()` - Invokes the custom not found handler.\n - `.serialize(payload)` - Serializes the specified payload using the default\n   JSON serializer or using the custom serializer (if one is set) and returns the\n   serialized payload.\n-- `.getSerializationFunction(schema | httpStatus)` - Returns the serialization\n+- `.getSerializationFunction(schema | httpStatus, [contentType])` - Returns the serialization\n   function for the specified schema or http status, if any of either are set.\n-- `.compileSerializationSchema(schema, httpStatus)` - Compiles the specified\n-  schema and returns a serialization function using the default (or customized)\n-  `SerializerCompiler`. The optional `httpStatus` is forwarded to the\n-  `SerializerCompiler` if provided, default to `undefined`.\n-- `.serializeInput(data, schema, [,httpStatus])` - Serializes the specified data\n-  using the specified schema and returns the serialized payload.\n-  If the optional `httpStatus` is provided, the function will use the serializer\n-  function given for that HTTP Status Code. Default to `undefined`.\n+- `.compileSerializationSchema(schema, [httpStatus], [contentType])` - Compiles\n+  the specified schema and returns a serialization function using the default\n+  (or customized) `SerializerCompiler`. The optional `httpStatus` is forwarded\n+  to the `SerializerCompiler` if provided, default to `undefined`.\n+- `.serializeInput(data, schema, [,httpStatus], [contentType])` - Serializes\n+  the specified data using the specified schema and returns the serialized payload.\n+  If the optional `httpStatus`, and `contentType` are provided, the function\n+  will use the serializer function given for that specific content type and\n+  HTTP Status Code. Default to `undefined`.\n - `.serializer(function)` - Sets a custom serializer for the payload.\n - `.send(payload)` - Sends the payload to the user, could be a plain text, a\n   buffer, JSON, stream, or an Error object.\n@@ -80,11 +88,10 @@\n   already been called.\n - `.hijack()` - interrupt the normal request lifecycle.\n - `.raw` - The\n-  [`http.ServerResponse`](https://nodejs.org/dist/latest-v14.x/docs/api/http.html#http_class_http_serverresponse)\n+  [`http.ServerResponse`](https://nodejs.org/dist/latest-v20.x/docs/api/http.html#http_class_http_serverresponse)\n",
					"match": false,
					"packageHash": "9b9e83d00c3a4aa83e7c78a1ce0d1aabdcde1e2beb7d1ad5a6f4ee84d67439cd",
					"size": 25316,
					"sourceHash": "34c5bafcb8654398ef359de0ab180bcad536c30888d03d80081b2aa230f84e39",
					"status": "content"
				},
				"docs/Reference/Request.md": {
					"diff": "--- published/docs/Reference/Request.md\n+++ rebuilt/docs/Reference/Request.md\n@@ -4,58 +4,71 @@\n The first parameter of the handler function is `Request`.\n \n Request is a core Fastify object containing the following fields:\n-- `query` - the parsed querystring, its format is specified by\n-  [`querystringParser`](./Server.md#querystringparser)\n-- `body` - the request payload, see [Content-Type\n-  Parser](./ContentTypeParser.md) for details on what request payloads Fastify\n-  natively parses and how to support other content types\n-- `params` - the params matching the URL\n-- [`headers`](#headers) - the headers getter and setter\n-- `raw` - the incoming HTTP request from Node core\n-- `server` - The Fastify server instance, scoped to the current [encapsulation\n-  context](./Encapsulation.md)\n-- `id` - the request ID\n-- `log` - the logger instance of the incoming request\n-- `ip` - the IP address of the incoming request\n-- `ips` - an array of the IP addresses, ordered from closest to furthest, in the\n+- `query` - The parsed querystring, its format is specified by\n+  [`querystringParser`](./Server.md#querystringparser).\n+- `body` - The request payload, see [Content-Type Parser](./ContentTypeParser.md)\n+  for details on what request payloads Fastify natively parses and how to support\n+  other content types.\n+- `params` - The params matching the URL.\n+- [`headers`](#headers) - The headers getter and setter.\n+- `raw` - The incoming HTTP request from Node core.\n+- `server` - The Fastify server instance, scoped to the current\n+  [encapsulation context](./Encapsulation.md).\n+- `id` - The request ID.\n+- `log` - The logger instance of the incoming request.\n+- `ip` - The IP address of the incoming request.\n+- `ips` - An array of the IP addresses, ordered from closest to furthest, in the\n   `X-Forwarded-For` header of the incoming request (only when the\n-  [`trustProxy`](./Server.md#factory-trust-proxy) option is enabled)\n-- `hostname` - the host of the incoming request (derived from `X-Forwarded-Host`\n+  [`trustProxy`](./Server.md#factory-trust-proxy) option is enabled).\n+- `host` - The host of the incoming request (derived from `X-Forwarded-Host`\n   header when the [`trustProxy`](./Server.md#factory-trust-proxy) option is\n-  enabled). For HTTP/2 compatibility it returns `:authority` if no host header\n-  exists.\n-- `protocol` - the protocol of the incoming request (`https` or `http`)\n-- `method` - the method of the incoming request\n-- `url` - the URL of the incoming request\n-- `routerMethod` - the method defined for the router that is handling the\n-  request\n-- `routerPath` - the path pattern defined for the router that is handling the\n-  request\n-- `is404` - true if request is being handled by 404 handler, false if it is not\n-- `connection` - Deprecated, use `socket` instead. The underlying connection of\n-  the incoming request.\n-- `socket` - the underlying connection of the incoming request\n-- [.getValidationFunction(schema | httpPart)](#getvalidationfunction) - \n-  Returns a validation function for the specified schema or http part,\n-  if any of either are set or cached.\n+  enabled). For HTTP/2 compatibility, it returns `:authority` if no host header\n+  exists. The host header may return an empty string if `requireHostHeader` is\n+  `false`, not provided with HTTP/1.0, or removed by schema validation.\n+- `hostname` - The hostname derived from the `host` property of the incoming request.\n+- `port` - The port from the `host` property, which may refer to the port the\n+  server is listening on.\n+- `protocol` - The protocol of the incoming request (`https` or `http`).\n+- `method` - The method of the incoming request.\n+- `url` - The URL of the incoming request.\n+- `originalUrl` - Similar to `url`, allows access to the original `url` in\n+  case of internal re-routing.\n+- `is404` - `true` if request is being handled by 404 handler, `false` otherwise.\n+- `socket` - The underlying connection of the incoming request.\n+- `context` - Deprecated, use `request.routeOptions.config` instead. A Fastify\n+  internal object. Do not use or modify it directly. It is useful to access one\n+  special key:\n+  - `context.config` - The route [`config`](./Routes.md#routes-config) object.\n+- `routeOptions` - The route [`option`](./Routes.md#routes-options) object.\n+  - `bodyLimit` - Either server limit or route limit.\n+  - `config` - The [`config`](./Routes.md#routes-config) object for this route.\n+  - `method` - The HTTP method for the route.\n+  - `url` - The path of the URL to match this route.\n+  - `handler` - The handler for this route.\n+  - `attachValidation` - Attach `validationError` to request (if there is\n+    a schema defined).\n+  - `logLevel` - Log level defined for this route.\n+  - `schema` - The JSON schemas definition for this route.\n+  - `version` - A semver compatible string that defines the version of the endpoint.\n+  - `exposeHeadRoute` - Creates a sibling HEAD route for any GET routes.\n+  - `prefixTrailingSlash` - String used to determine how to handle passing `/`\n+    as a route with a prefix.\n+- [.getValidationFunction(schema | httpPart)](#getvalidationfunction) -\n+  Returns a validation function for the specified schema or HTTP part, if\n+  set or cached.\n - [.compileValidationSchema(schema, [httpPart])](#compilevalidationschema) -\n-  Compiles the specified schema and returns a validation function\n-  using the default (or customized) `ValidationCompiler`.\n-  The optional `httpPart` is forwarded to the `ValidationCompiler`\n-  if provided, defaults to `null`.\n+  Compiles the specified schema and returns a validation function using the\n+  default (or customized) `ValidationCompiler`. The optional `httpPart` is\n+  forwarded to the `ValidationCompiler` if provided, defaults to `null`.\n - [.validateInput(data, schema | httpPart, [httpPart])](#validate) -\n-  Validates the specified input by using the specified\n",
					"match": false,
					"packageHash": "af351e01958a0424204ea883b566a9b23d23f92c3981018ad3e48ae568c4951c",
					"size": 8441,
					"sourceHash": "46ddecaf537ab5b59a5a11b865f361d2b65180cf7669157d64e901d26d982f1f",
					"status": "content"
				},
				"docs/Reference/Routes.md": {
					"diff": "--- published/docs/Reference/Routes.md\n+++ rebuilt/docs/Reference/Routes.md\n@@ -2,9 +2,8 @@\n \n ## Routes\n \n-The route methods will configure the endpoints of your application. You have two\n-ways to declare a route with Fastify: the shorthand method and the full\n-declaration.\n+The route methods configure the endpoints of the application. Routes can be\n+declared using the shorthand method or the full declaration.\n \n - [Full declaration](#full-declaration)\n - [Routes options](#routes-options)\n@@ -32,17 +31,17 @@\n ### Routes options\n <a id=\"options\"></a>\n \n-* `method`: currently it supports `'DELETE'`, `'GET'`, `'HEAD'`, `'PATCH'`,\n-  `'POST'`, `'PUT'`, `'OPTIONS'`, `'SEARCH'`, `'TRACE'`, `'PROPFIND'`,\n-  `'PROPPATCH'`, `'MKCOL'`, `'COPY'`, `'MOVE'`, `'LOCK'`  and `'UNLOCK'`.\n+* `method`: currently it supports `GET`, `HEAD`, `TRACE`, `DELETE`,\n+  `OPTIONS`, `PATCH`, `PUT` and `POST`. To accept more methods,\n+  the [`addHttpMethod`](./Server.md#addHttpMethod) must be used.\n   It could also be an array of methods.\n * `url`: the path of the URL to match this route (alias: `path`).\n * `schema`: an object containing the schemas for the request and response. They\n   need to be in [JSON Schema](https://json-schema.org/) format, check\n   [here](./Validation-and-Serialization.md) for more info.\n \n-  * `body`: validates the body of the request if it is a POST, PUT, or PATCH\n-    method.\n+  * `body`: validates the body of the request if it is a POST, PUT, PATCH,\n+    TRACE, SEARCH, PROPFIND, PROPPATCH or LOCK method.\n   * `querystring` or `query`: validates the querystring. This can be a complete\n     JSON Schema object, with the property `type` of `object` and `properties`\n     object of parameters, or simply the values of what would be contained in the\n@@ -60,8 +59,9 @@\n   one.\n * `onRequest(request, reply, done)`: a [function](./Hooks.md#onrequest) called\n   as soon as a request is received, it could also be an array of functions.\n-* `preParsing(request, reply, done)`: a [function](./Hooks.md#preparsing) called\n-  before parsing the request, it could also be an array of functions.\n+* `preParsing(request, reply, payload, done)`: a\n+  [function](./Hooks.md#preparsing) called before parsing the request, it could\n+  also be an array of functions.\n * `preValidation(request, reply, done)`: a [function](./Hooks.md#prevalidation)\n   called after the shared `preValidation` hooks, useful if you need to perform\n   authentication at route level for example, it could also be an array of\n@@ -78,7 +78,7 @@\n   when a response has been sent, so you will not be able to send more data to\n   the client. It could also be an array of functions.\n * `onTimeout(request, reply, done)`: a [function](./Hooks.md#ontimeout) called\n-  when a request is timed out and the HTTP socket has been hanged up.\n+  when a request is timed out and the HTTP socket has been hung up.\n * `onError(request, reply, error, done)`: a [function](./Hooks.md#onerror)\n   called when an Error is thrown or sent to the client by the route handler.\n * `handler(request, reply)`: the function that will handle this request. The\n@@ -90,12 +90,20 @@\n   To access the default handler, you can access `instance.errorHandler`. Note\n   that this will point to fastify's default `errorHandler` only if a plugin\n   hasn't overridden it already.\n+* `childLoggerFactory(logger, binding, opts, rawReq)`: a custom factory function\n+  that will be called to produce a child logger instance for every request.\n+  See [`childLoggerFactory`](./Server.md#childloggerfactory) for more info.\n+  Overrides the default logger factory, and anything set by\n+  [`setChildLoggerFactory`](./Server.md#setchildloggerfactory), for requests to\n+  the route. To access the default factory, you can access\n+  `instance.childLoggerFactory`. Note that this will point to Fastify's default\n+  `childLoggerFactory` only if a plugin hasn't overridden it already.\n * `validatorCompiler({ schema, method, url, httpPart })`: function that builds\n   schemas for request validations. See the [Validation and\n   Serialization](./Validation-and-Serialization.md#schema-validator)\n   documentation.\n-* `serializerCompiler({ { schema, method, url, httpStatus } })`: function that\n-  builds schemas for response serialization. See the [Validation and\n+* `serializerCompiler({ { schema, method, url, httpStatus, contentType } })`:\n+  function that builds schemas for response serialization. See the [Validation and\n   Serialization](./Validation-and-Serialization.md#schema-serializer)\n   documentation.\n * `schemaErrorFormatter(errors, dataVar)`: function that formats the errors from\n@@ -112,6 +120,11 @@\n * `config`: object used to store custom configuration.\n * `version`: a [semver](https://semver.org/) compatible string that defined the\n   version of the endpoint. [Example](#version-constraints).\n+* `constraints`: defines route restrictions based on request properties or\n+  values, enabling customized matching using\n+  [find-my-way](https://github.com/delvedor/find-my-way) constraints. Includes\n+  built-in `version` and `host` constraints, with support for custom constraint\n+  strategies.\n * `prefixTrailingSlash`: string used to determine how to handle passing `/` as a\n   route with a prefix.\n   * `both` (default): Will register both `/prefix` and `/prefix/`.\n@@ -125,11 +138,11 @@\n \n * `reply` is defined in [Reply](./Reply.md).\n \n-**Notice:** The documentation of `onRequest`, `preParsing`, `preValidation`,\n-`preHandler`, `preSerialization`, `onSend`, and `onResponse` are described in\n-more detail in [Hooks](./Hooks.md). Additionally, to send a response before the\n",
					"match": false,
					"packageHash": "5481b9ac21d627b0f36060ad6886e853566d197720f709803a1667baa1a2ce1c",
					"size": 24937,
					"sourceHash": "16f4ea4853c78b4ebd85c34ad976079b6b6cb31e7f9cfdb2521bac4cfcf3c4d6",
					"status": "content"
				},
				"docs/Reference/Server.md": {
					"diff": "--- published/docs/Reference/Server.md\n+++ rebuilt/docs/Reference/Server.md\n@@ -9,6 +9,7 @@\n describes the properties available in that options object.\n \n - [Factory](#factory)\n+  - [`http`](#http)\n   - [`http2`](#http2)\n   - [`https`](#https)\n   - [`connectionTimeout`](#connectiontimeout)\n@@ -16,26 +17,19 @@\n   - [`forceCloseConnections`](#forcecloseconnections)\n   - [`maxRequestsPerSocket`](#maxrequestspersocket)\n   - [`requestTimeout`](#requesttimeout)\n-  - [`ignoreTrailingSlash`](#ignoretrailingslash)\n-  - [`ignoreDuplicateSlashes`](#ignoreduplicateslashes)\n-  - [`maxParamLength`](#maxparamlength)\n   - [`bodyLimit`](#bodylimit)\n   - [`onProtoPoisoning`](#onprotopoisoning)\n   - [`onConstructorPoisoning`](#onconstructorpoisoning)\n   - [`logger`](#logger)\n+  - [`loggerInstance`](#loggerInstance)\n   - [`disableRequestLogging`](#disablerequestlogging)\n   - [`serverFactory`](#serverfactory)\n-  - [`jsonShorthand`](#jsonshorthand)\n-  - [`caseSensitive`](#casesensitive)\n-  - [`allowUnsafeRegex`](#allowunsaferegex)\n   - [`requestIdHeader`](#requestidheader)\n   - [`requestIdLogLabel`](#requestidloglabel)\n   - [`genReqId`](#genreqid)\n   - [`trustProxy`](#trustproxy)\n   - [`pluginTimeout`](#plugintimeout)\n-  - [`querystringParser`](#querystringparser)\n   - [`exposeHeadRoutes`](#exposeheadroutes)\n-  - [`constraints`](#constraints)\n   - [`return503OnClosing`](#return503onclosing)\n   - [`ajv`](#ajv)\n   - [`serializerOpts`](#serializeropts)\n@@ -43,6 +37,19 @@\n   - [`frameworkErrors`](#frameworkerrors)\n   - [`clientErrorHandler`](#clienterrorhandler)\n   - [`rewriteUrl`](#rewriteurl)\n+  - [`allowErrorHandlerOverride`](#allowerrorhandleroverride)\n+  - [RouterOptions](#routeroptions)\n+    - [`allowUnsafeRegex`](#allowunsaferegex)\n+    - [`buildPrettyMeta`](#buildprettymeta)\n+    - [`caseSensitive`](#casesensitive)\n+    - [`constraints`](#constraints)\n+    - [`defaultRoute`](#defaultroute)\n+    - [`ignoreDuplicateSlashes`](#ignoreduplicateslashes)\n+    - [`ignoreTrailingSlash`](#ignoretrailingslash)\n+    - [`maxParamLength`](#maxparamlength)\n+    - [`onBadUrl`](#onbadurl)\n+    - [`querystringParser`](#querystringparser)\n+    - [`useSemicolonDelimiter`](#usesemicolondelimiter)\n - [Instance](#instance)\n   - [Server Methods](#server-methods)\n     - [server](#server)\n@@ -50,20 +57,22 @@\n     - [ready](#ready)\n     - [listen](#listen)\n     - [addresses](#addresses)\n-    - [getDefaultRoute](#getdefaultroute)\n-    - [setDefaultRoute](#setdefaultroute)\n     - [routing](#routing)\n     - [route](#route)\n+    - [hasRoute](#hasroute)\n+    - [findRoute](#findroute)\n     - [close](#close)\n-    - [decorate*](#decorate)\n+    - [decorate\\*](#decorate)\n     - [register](#register)\n     - [addHook](#addhook)\n     - [prefix](#prefix)\n     - [pluginName](#pluginname)\n     - [hasPlugin](#hasplugin)\n+    - [listeningOrigin](#listeningorigin)\n     - [log](#log)\n     - [version](#version)\n     - [inject](#inject)\n+    - [addHttpMethod](#addHttpMethod)\n     - [addSchema](#addschema)\n     - [getSchemas](#getschemas)\n     - [getSchema](#getschema)\n@@ -77,6 +86,8 @@\n     - [schemaController](#schemacontroller)\n     - [setNotFoundHandler](#setnotfoundhandler)\n     - [setErrorHandler](#seterrorhandler)\n+    - [setChildLoggerFactory](#setchildloggerfactory)\n+    - [setGenReqId](#setGenReqId)\n     - [addConstraintStrategy](#addconstraintstrategy)\n     - [hasConstraintStrategy](#hasconstraintstrategy)\n     - [printRoutes](#printroutes)\n@@ -88,204 +99,167 @@\n     - [getDefaultJsonParser](#getdefaultjsonparser)\n     - [defaultTextParser](#defaulttextparser)\n     - [errorHandler](#errorhandler)\n+    - [childLoggerFactory](#childloggerfactory)\n+    - [Symbol.asyncDispose](#symbolasyncdispose)\n     - [initialConfig](#initialconfig)\n",
					"match": false,
					"packageHash": "8c995093ab2c969db3a172e8cb4fd1eb7cd90391438710b6857dfb4122667952",
					"size": 56011,
					"sourceHash": "547091b2db4f894829b485e5951b00ceeefda12786ed0072177e210781bd0827",
					"status": "content"
				},
				"docs/Reference/Type-Providers.md": {
					"diff": "--- published/docs/Reference/Type-Providers.md\n+++ rebuilt/docs/Reference/Type-Providers.md\n@@ -2,94 +2,100 @@\n \n ## Type Providers\n \n-Type Providers are a TypeScript only feature that enables Fastify to statically\n-infer type information directly from inline JSON Schema. They are an alternative\n-to specifying generic arguments on routes; and can greatly reduce the need to\n-keep associated types for each schema defined in your project.\n+Type Providers are a TypeScript feature that enables Fastify to infer type\n+information from inline JSON Schema. They are an alternative to specifying\n+generic arguments on routes and can reduce the need to keep associated types for\n+each schema in a project.\n \n ### Providers\n \n-Type Providers are offered as additional packages you will need to install into\n-your project. Each provider uses a different inference library under the hood;\n-allowing you to select the library most appropriate for your needs. Type\n-Provider packages follow a `@fastify/type-provider-{provider-name}` naming\n-convention.\n+Official Type Provider packages follow the\n+`@fastify/type-provider-{provider-name}` naming convention.\n+Several community providers are also available.\n \n The following inference packages are supported:\n \n-- `json-schema-to-ts` -\n-  [github](https://github.com/ThomasAribart/json-schema-to-ts)\n-- `typebox` - [github](https://github.com/sinclairzx81/typebox)\n+- [`json-schema-to-ts`](https://github.com/ThomasAribart/json-schema-to-ts)\n+- [`typebox`](https://github.com/sinclairzx81/typebox)\n+- [`zod`](https://github.com/colinhacks/zod)\n+\n+See also the Type Provider wrapper packages for each of the packages respectively:\n+\n+- [`@fastify/type-provider-json-schema-to-ts`](https://github.com/fastify/fastify-type-provider-json-schema-to-ts)\n+- [`@fastify/type-provider-typebox`](https://github.com/fastify/fastify-type-provider-typebox)\n+- [`fastify-type-provider-zod`](https://github.com/turkerdev/fastify-type-provider-zod)\n+ (3rd party)\n \n ### Json Schema to Ts\n \n-The following sets up a `json-schema-to-ts` Type Provider\n+The following sets up a `json-schema-to-ts` Type Provider:\n \n ```bash\n $ npm i @fastify/type-provider-json-schema-to-ts\n ```\n \n ```typescript\n-import { JsonSchemaToTsProvider } from '@fastify/type-provider-json-schema-to-ts'\n-\n import fastify from 'fastify'\n+import { JsonSchemaToTsProvider } from '@fastify/type-provider-json-schema-to-ts'\n \n const server = fastify().withTypeProvider<JsonSchemaToTsProvider>()\n \n server.get('/route', {\n-    schema: {\n-        querystring: {\n-            type: 'object',\n-            properties: {\n-                foo: { type: 'number' },\n-                bar: { type: 'string' },\n-            },\n-            required: ['foo', 'bar']\n-        }\n-    } as const // don't forget to use const !\n-\n+  schema: {\n+    querystring: {\n+      type: 'object',\n+      properties: {\n+        foo: { type: 'number' },\n+        bar: { type: 'string' },\n+      },\n+      required: ['foo', 'bar']\n+    }\n+  }\n }, (request, reply) => {\n \n-    // type Query = { foo: number, bar: string }\n-\n-    const { foo, bar } = request.query // type safe!\n+  // type Query = { foo: number, bar: string }\n+  const { foo, bar } = request.query // type safe!\n })\n ```\n \n ### TypeBox\n \n-The following sets up a TypeBox Type Provider\n+The following sets up a TypeBox Type Provider:\n \n ```bash\n $ npm i @fastify/type-provider-typebox\n ```\n \n",
					"match": false,
					"packageHash": "f5175d66077fabb048639f2cb7017a2740102ec3cba0440fa1a3c0639b7dcc63",
					"size": 6548,
					"sourceHash": "bc5ae8a750a86c6835c073de5dd6238452de7ab1ff0357143dfa956b179251ca",
					"status": "content"
				},
				"docs/Reference/TypeScript.md": {
					"diff": "--- published/docs/Reference/TypeScript.md\n+++ rebuilt/docs/Reference/TypeScript.md\n@@ -34,7 +34,7 @@\n This example will get you up and running with Fastify and TypeScript. It results\n in a blank http Fastify server.\n \n-1. Create a new npm project, install Fastify, and install typescript & node.js\n+1. Create a new npm project, install Fastify, and install typescript & Node.js\n    types as peer dependencies:\n   ```bash\n   npm init -y\n@@ -106,7 +106,7 @@\n route-level `request` object.\n \n 1. If you did not complete the previous example, follow steps 1-4 to get set up.\n-2. Inside `index.ts`, define two interfaces `IQuerystring` and `IHeaders`:\n+2. Inside `index.ts`, define three interfaces `IQuerystring`,`IHeaders` and `IReply`:\n    ```typescript\n    interface IQuerystring {\n      username: string;\n@@ -116,8 +116,14 @@\n    interface IHeaders {\n      'h-Custom': string;\n    }\n+\n+   interface IReply {\n+     200: { success: boolean };\n+     302: { url: string };\n+     '4xx': { error: string };\n+   }\n    ```\n-3. Using the two interfaces, define a new API route and pass them as generics.\n+3. Using the three interfaces, define a new API route and pass them as generics.\n    The shorthand route methods (i.e. `.get`) accept a generic object\n    `RouteGenericInterface` containing five named properties: `Body`,\n    `Querystring`, `Params`, `Headers` and `Reply`. The interfaces `Body`,\n@@ -127,18 +133,26 @@\n    ```typescript\n    server.get<{\n      Querystring: IQuerystring,\n-     Headers: IHeaders\n+     Headers: IHeaders,\n+     Reply: IReply\n    }>('/auth', async (request, reply) => {\n      const { username, password } = request.query\n      const customerHeader = request.headers['h-Custom']\n      // do something with request data\n \n-     return `logged in!`\n+     // chaining .statusCode/.code calls with .send allows type narrowing. For example:\n+     // this works\n+     reply.code(200).send({ success: true });\n+     // but this gives a type error\n+     reply.code(200).send('uh-oh');\n+     // it even works for wildcards\n+     reply.code(404).send({ error: 'Not found' });\n+     return { success: true }\n    })\n    ```\n \n 4. Build and run the server code with `npm run build` and `npm run start`\n-5. Query the api\n+5. Query the API\n    ```bash\n    curl localhost:8080/auth?username=admin&password=Password123!\n    ```\n@@ -149,7 +163,8 @@\n    ```typescript\n    server.get<{\n      Querystring: IQuerystring,\n-     Headers: IHeaders\n+     Headers: IHeaders,\n+     Reply: IReply\n    }>('/auth', {\n      preValidation: (request, reply, done) => {\n        const { username, password } = request.query\n@@ -158,7 +173,7 @@\n    }, async (request, reply) => {\n      const customerHeader = request.headers['h-Custom']\n      // do something with request data\n-     return `logged in!`\n+     return { success: true }\n    })\n    ```\n 7. Build and run and query with the `username` query string option set to\n@@ -181,36 +196,37 @@\n Also it has the advantage to use the defined type within your handlers\n (including pre-validation, etc.).\n \n-Here are some options how to achieve this.\n+Here are some options on how to achieve this.\n \n #### Fastify Type Providers\n \n Fastify offers two packages wrapping `json-schema-to-ts` and `typebox`:\n \n-- `@fastify/type-provider-json-schema-to-ts`\n-- `@fastify/type-provider-typebox`\n+- [`@fastify/type-provider-json-schema-to-ts`](https://github.com/fastify/fastify-type-provider-json-schema-to-ts)\n+- [`@fastify/type-provider-typebox`](https://github.com/fastify/fastify-type-provider-typebox)\n",
					"match": false,
					"packageHash": "2be1a3a150b4ce292fe2ef1b9cef45d72beec518a2268f240178b3bd2386ea72",
					"size": 58769,
					"sourceHash": "25436f3a03044b3cbfeb6af4bc5032fd43e996789961a01c8703afeb3898b363",
					"status": "content"
				},
				"docs/Reference/Validation-and-Serialization.md": {
					"diff": "--- published/docs/Reference/Validation-and-Serialization.md\n+++ rebuilt/docs/Reference/Validation-and-Serialization.md\n@@ -1,66 +1,63 @@\n <h1 align=\"center\">Fastify</h1>\n \n ## Validation and Serialization\n-Fastify uses a schema-based approach, and even if it is not mandatory we\n-recommend using [JSON Schema](https://json-schema.org/) to validate your routes\n-and serialize your outputs. Internally, Fastify compiles the schema into a\n-highly performant function.\n-\n-Validation will only be attempted if the content type is `application-json`, as\n-described in the documentation for the [content type\n-parser](./ContentTypeParser.md).\n-\n-All the examples in this section are using the [JSON Schema Draft\n-7](https://json-schema.org/specification-links.html#draft-7) specification.\n-\n-> ## ⚠  Security Notice\n-> Treat the schema definition as application code. Validation and serialization\n-> features dynamically evaluate code with `new Function()`, which is not safe to\n-> use with user-provided schemas. See [Ajv](https://npm.im/ajv) and\n-> [fast-json-stringify](https://npm.im/fast-json-stringify) for more details.\n+Fastify uses a schema-based approach. We recommend using\n+[JSON Schema](https://json-schema.org/) to validate routes and serialize outputs.\n+Fastify compiles the schema into a highly performant function.\n+\n+Validation is only attempted if the content type is `application/json`.\n+\n+All examples use the\n+[JSON Schema Draft 7](https://json-schema.org/specification-links.html#draft-7)\n+specification.\n+\n+> ⚠ Warning:\n+> Treat schema definitions as application code. Validation and serialization\n+> features use `new Function()`, which is unsafe with user-provided schemas. See\n+> [Ajv](https://npm.im/ajv) and\n+> [fast-json-stringify](https://npm.im/fast-json-stringify) for details.\n >\n-> Moreover, the [`$async` Ajv\n-> feature](https://ajv.js.org/guide/async-validation.html) should not be used as\n-> part of the first validation strategy. This option is used to access Databases\n-> and reading them during the validation process may lead to Denial of Service\n-> Attacks to your application. If you need to run `async` tasks, use [Fastify's\n-> hooks](./Hooks.md) instead after validation completes, such as `preHandler`.\n-\n+> Whilst Fastify supports the\n+> [`$async` Ajv feature](https://ajv.js.org/guide/async-validation.html),\n+> it should not be used for initial validation. Accessing databases during\n+> validation may lead to Denial of Service attacks. Use\n+> [Fastify's hooks](./Hooks.md) like `preHandler` for `async` tasks after validation.\n+>\n+> When using custom validators with async `preValidation` hooks,\n+> validators **must return** `{error}` objects instead of throwing errors.\n+> Throwing errors from custom validators will cause unhandled promise rejections\n+> that crash the application when combined with async hooks. See the\n+> [custom validator examples](#using-other-validation-libraries) below for the\n+> correct pattern.\n \n ### Core concepts\n-The validation and the serialization tasks are processed by two different, and\n-customizable, actors:\n-- [Ajv v8](https://www.npmjs.com/package/ajv) for the validation of a request\n+Validation and serialization are handled by two customizable dependencies:\n+- [Ajv v8](https://www.npmjs.com/package/ajv) for request validation\n - [fast-json-stringify](https://www.npmjs.com/package/fast-json-stringify) for\n-  the serialization of a response's body\n+  response body serialization\n \n-These two separate entities share only the JSON schemas added to Fastify's\n-instance through `.addSchema(schema)`.\n+These dependencies share only the JSON schemas added to Fastify's instance via\n+`.addSchema(schema)`.\n \n #### Adding a shared schema\n <a id=\"shared-schema\"></a>\n \n-Thanks to the `addSchema` API, you can add multiple schemas to the Fastify\n-instance and then reuse them in multiple parts of your application. As usual,\n-this API is encapsulated.\n+The `addSchema` API allows adding multiple schemas to the Fastify instance for\n+reuse throughout the application. This API is encapsulated.\n \n-The shared schemas can be reused through the JSON Schema\n+Shared schemas can be reused with the JSON Schema\n [**`$ref`**](https://tools.ietf.org/html/draft-handrews-json-schema-01#section-8)\n-keyword. Here is an overview of _how_ references work:\n+keyword. Here is an overview of how references work:\n \n-+ `myField: { $ref: '#foo'}` will search for field with `$id: '#foo'` inside the\n++ `myField: { $ref: '#foo' }` searches for `$id: '#foo'` in the current schema\n++ `myField: { $ref: '#/definitions/foo' }` searches for `definitions.foo` in the\n   current schema\n-+ `myField: { $ref: '#/definitions/foo'}` will search for field\n-  `definitions.foo` inside the current schema\n-+ `myField: { $ref: 'http://url.com/sh.json#'}` will search for a shared schema\n-  added with `$id: 'http://url.com/sh.json'`\n-+ `myField: { $ref: 'http://url.com/sh.json#/definitions/foo'}` will search for\n-  a shared schema added with `$id: 'http://url.com/sh.json'` and will use the\n-  field `definitions.foo`\n",
					"match": false,
					"packageHash": "7889cade82e494d0285b735abf1903b01f03e8e4519bd02fb8c187589d38d9b7",
					"size": 25096,
					"sourceHash": "906f30b72c40440f73c4b1533992e28aadd2760bf319f3cafe574e1fb111bf96",
					"status": "content"
				},
				"docs/index.md": {
					"diff": "--- published/docs/index.md\n+++ rebuilt/docs/index.md\n@@ -7,8 +7,8 @@\n \n The reference documentation utilizes a very formal style in an effort to document\n Fastify's API and implementation details thoroughly for the developer who needs\n-such. The guides category utilizes an informal, educational, style as a means to\n-introduce newcomers to core, and advanced, Fastify concepts.\n+such. The guides category utilizes an informal educational style as a means to\n+introduce newcomers to core and advanced Fastify concepts.\n \n ## Where To Start\n \n",
					"match": false,
					"packageHash": "49de9d40cf85a4f93afc27b644d18efbc2c1eea2c3d44e4679f912bb9d947f5e",
					"size": 872,
					"sourceHash": "5a9768862278c0ccdf1beea2c20227e805591faee30216c6c85d33c853563612",
					"status": "content"
				},
				"examples/asyncawait.js": {
					"diff": "--- published/examples/asyncawait.js\n+++ rebuilt/examples/asyncawait.js\n@@ -32,5 +32,7 @@\n   })\n \n fastify.listen({ port: 3000 }, err => {\n-  if (err) throw err\n+  if (err) {\n+    throw err\n+  }\n })\n",
					"match": false,
					"packageHash": "20da9ca3218273f7cc096095b688c379b56955341cd40267576bdce7e55a46d7",
					"size": 697,
					"sourceHash": "fa3810878c749d584b5cf4a3ae4c973aa5e442c32ea2f846cdadfbd219dd1231",
					"status": "content"
				},
				"examples/hooks.js": {
					"diff": "--- published/examples/hooks.js\n+++ rebuilt/examples/hooks.js\n@@ -68,6 +68,9 @@\n   .addHook('onRoute', function (routeOptions) {\n     console.log('onRoute')\n   })\n+  .addHook('onListen', async function () {\n+    console.log('onListen')\n+  })\n   .addHook('onClose', function (instance, done) {\n     console.log('onClose')\n     done()\n",
					"match": false,
					"packageHash": "f1b04249825b6d1f357161347bbaa0653f89ac4765982755e863df3425f06d89",
					"size": 1824,
					"sourceHash": "1cf974f4a348462cf08c5ee3574a491240d23bf7024e992bbb8312ce9bc402a6",
					"status": "content"
				},
				"examples/http2.js": {
					"diff": "--- published/examples/http2.js\n+++ rebuilt/examples/http2.js\n@@ -1,7 +1,7 @@\n 'use strict'\n \n-const fs = require('fs')\n-const path = require('path')\n+const fs = require('node:fs')\n+const path = require('node:path')\n const fastify = require('../fastify')({\n   http2: true,\n   https: {\n@@ -33,5 +33,7 @@\n   })\n \n fastify.listen({ port: 3000 }, err => {\n-  if (err) throw err\n+  if (err) {\n+    throw err\n+  }\n })\n",
					"match": false,
					"packageHash": "d6580b46c106bc89b0693583a14bfb51a250040beb245067443bc871ea1b337d",
					"size": 724,
					"sourceHash": "4b76d46be51cba1bfd7661ef73487cf857a8e2af121a8abc44ed7a81014bbd1a",
					"status": "content"
				},
				"examples/https.js": {
					"diff": "--- published/examples/https.js\n+++ rebuilt/examples/https.js\n@@ -1,7 +1,7 @@\n 'use strict'\n \n-const fs = require('fs')\n-const path = require('path')\n+const fs = require('node:fs')\n+const path = require('node:path')\n const fastify = require('../fastify')({\n   https: {\n     key: fs.readFileSync(path.join(__dirname, '../test/https/fastify.key')),\n@@ -32,5 +32,7 @@\n   })\n \n fastify.listen({ port: 3000 }, err => {\n-  if (err) throw err\n+  if (err) {\n+    throw err\n+  }\n })\n",
					"match": false,
					"packageHash": "1cda36a34a71450d6ce8424652a22f88af34fe5f5fc16740fa64e2ac195a1082",
					"size": 709,
					"sourceHash": "43c8605381e16c3c89be59cab1d02e9413f17b19a3eb62469283409cb8944329",
					"status": "content"
				},
				"examples/parser.js": {
					"diff": "--- published/examples/parser.js\n+++ rebuilt/examples/parser.js\n@@ -2,7 +2,7 @@\n \n const fastify = require('../fastify')({ logger: true })\n const jsonParser = require('fast-json-body')\n-const querystring = require('querystring')\n+const querystring = require('node:querystring')\n \n // Handled by fastify\n // curl -X POST -d '{\"hello\":\"world\"}' -H'Content-type: application/json' http://localhost:3000/\n@@ -47,5 +47,7 @@\n   })\n \n fastify.listen({ port: 3000 }, err => {\n-  if (err) throw err\n+  if (err) {\n+    throw err\n+  }\n })\n",
					"match": false,
					"packageHash": "8d72a0a714c7e23a15c37a0eb794f14652fa148b6b93ddd5bffd4e57db1e95d2",
					"size": 1698,
					"sourceHash": "e983bea84c4886c1bedca332ac2a61d99ad4117c891ccf6df51f13fb3c4fc65f",
					"status": "content"
				},
				"examples/shared-schema.js": {
					"diff": "--- published/examples/shared-schema.js\n+++ rebuilt/examples/shared-schema.js\n@@ -32,5 +32,7 @@\n   })\n \n fastify.listen({ port: 3000 }, err => {\n-  if (err) throw err\n+  if (err) {\n+    throw err\n+  }\n })\n",
					"match": false,
					"packageHash": "78f210735d1bf2895b2a9f45bc9453153669c72dcbe8f5393381dd5d45ae470b",
					"size": 582,
					"sourceHash": "88a2f6d828b3a8a8a1ca893b99a1667d899b7428e56e4ba39b06d05696495bae",
					"status": "content"
				},
				"examples/simple-stream.js": {
					"diff": "--- published/examples/simple-stream.js\n+++ rebuilt/examples/simple-stream.js\n@@ -4,7 +4,7 @@\n   logger: false\n })\n \n-const Readable = require('stream').Readable\n+const Readable = require('node:stream').Readable\n \n fastify\n   .get('/', function (req, reply) {\n@@ -13,6 +13,8 @@\n   })\n \n fastify.listen({ port: 3000 }, (err, address) => {\n-  if (err) throw err\n+  if (err) {\n+    throw err\n+  }\n   fastify.log.info(`server listening on ${address}`)\n })\n",
					"match": false,
					"packageHash": "706c17650cef1070e28bddd731baa9f824adc4b21a6b5e1e4f992479628727c7",
					"size": 370,
					"sourceHash": "583b4d72d43bfcd5a9ade52be9524e25496db01353721d32179dafd3264853b5",
					"status": "content"
				},
				"examples/simple.js": {
					"diff": "--- published/examples/simple.js\n+++ rebuilt/examples/simple.js\n@@ -26,5 +26,7 @@\n   })\n \n fastify.listen({ port: 3000 }, (err, address) => {\n-  if (err) throw err\n+  if (err) {\n+    throw err\n+  }\n })\n",
					"match": false,
					"packageHash": "1b341aa5892e8d9bfadea1328fedcb92cd10d8ab4f5e0ce72ff6d0189cefd4b1",
					"size": 442,
					"sourceHash": "7ba7f10a69061fbda79128d17b0561d62094f2a77cbbc066aca815390100553f",
					"status": "content"
				},
				"examples/typescript-server.ts": {
					"diff": "--- published/examples/typescript-server.ts\n+++ rebuilt/examples/typescript-server.ts\n@@ -10,8 +10,8 @@\n  * node examples/typescript-server.js\n  */\n \n-import fastify, { FastifyInstance, RouteShorthandOptions } from '../fastify';\n-import { Server, IncomingMessage, ServerResponse } from 'http';\n+import fastify, { FastifyInstance, RouteShorthandOptions } from '../fastify'\n+import { Server, IncomingMessage, ServerResponse } from 'node:http'\n \n // Create an http server. We pass the relevant typings for our http version used.\n // By passing types we get correctly typed access to the underlying http objects in routes.\n@@ -20,7 +20,7 @@\n   Server,\n   IncomingMessage,\n   ServerResponse\n-> = fastify({ logger: true });\n+> = fastify({ logger: true })\n \n // Define interfaces for our request. We can create these automatically\n // off our JSON Schema files (See TypeScript.md) but for the purpose of this\n@@ -53,26 +53,27 @@\n       }\n     }\n   }\n-};\n+}\n \n // Add our route handler with correct types\n-server.get<{\n+server.post<{\n   Querystring: PingQuerystring;\n   Params: PingParams;\n   Headers: PingHeaders;\n   Body: PingBody;\n }>('/ping/:bar', opts, (request, reply) => {\n-  console.log(request.query); // this is of type `PingQuerystring`\n-  console.log(request.params); // this is of type `PingParams`\n-  console.log(request.headers); // this is of type `PingHeaders`\n-  console.log(request.body); // this is of type `PingBody`\n-  reply.code(200).send({ pong: 'it worked!' });\n-});\n+  console.log(request.query) // this is of type `PingQuerystring`\n+  console.log(request.params) // this is of type `PingParams`\n+  console.log(request.headers) // this is of type `PingHeaders`\n+  console.log(request.body) // this is of type `PingBody`\n+  reply.code(200).send({ pong: 'it worked!' })\n+})\n \n // Start your server\n server.listen({ port: 8080 }, (err, address) => {\n   if (err) {\n-    console.error(err);\n-    process.exit(1);\n+    console.error(err)\n+    process.exit(1)\n   }\n-});\n+  console.log(`server listening on ${address}`)\n+})\n",
					"match": false,
					"packageHash": "15f943ce0a780e965addcf83ea4a14a5690e2d67b6bbdab843e91b3161efea98",
					"size": 2121,
					"sourceHash": "b55428c2a50f41656b3bf3b65589ace021c753bb6a789c17938a38f29e43b09b",
					"status": "content"
				},
				"examples/use-plugin.js": {
					"diff": "--- published/examples/use-plugin.js\n+++ rebuilt/examples/use-plugin.js\n@@ -1,3 +1,5 @@\n+'use strict'\n+\n const fastify = require('../fastify')({ logger: true })\n \n const opts = {\n@@ -15,7 +17,9 @@\n   }\n }\n fastify.register(require('./plugin'), opts, function (err) {\n-  if (err) throw err\n+  if (err) {\n+    throw err\n+  }\n })\n \n fastify.listen({ port: 3000 }, function (err) {\n",
					"match": false,
					"packageHash": "645f31a2b2f3b21f1eccf5e857d114ae2e9808ee956e612664910d8e7fdad266",
					"size": 417,
					"sourceHash": "9adac0736d4054c61102bcf664adfc80906be24e24603aee335dee24ea752bb0",
					"status": "content"
				},
				"fastify.d.ts": {
					"diff": "--- published/fastify.d.ts\n+++ rebuilt/fastify.d.ts\n@@ -1,25 +1,216 @@\n-import * as http from 'http'\n-import * as http2 from 'http2'\n-import * as https from 'https'\n-import { ConstraintStrategy, HTTPVersion } from 'find-my-way'\n+import * as http from 'node:http'\n+import * as http2 from 'node:http2'\n+import * as https from 'node:https'\n+import { Socket } from 'node:net'\n \n-import { FastifyRequest, RequestGenericInterface } from './types/request'\n-import { RawServerBase, RawServerDefault, RawRequestDefaultExpression, RawReplyDefaultExpression } from './types/utils'\n-import { FastifyBaseLogger, FastifyLoggerInstance, FastifyLoggerOptions, PinoLoggerOptions } from './types/logger'\n-import { FastifyInstance } from './types/instance'\n-import { FastifyServerFactory } from './types/serverFactory'\n-import { Options as AjvOptions } from '@fastify/ajv-compiler'\n-import { Options as FJSOptions } from '@fastify/fast-json-stringify-compiler'\n+import { Options as AjvOptions, ValidatorFactory } from '@fastify/ajv-compiler'\n import { FastifyError } from '@fastify/error'\n+import { Options as FJSOptions, SerializerFactory } from '@fastify/fast-json-stringify-compiler'\n+import { ConstraintStrategy, HTTPVersion } from 'find-my-way'\n+import { InjectOptions, CallbackFunc as LightMyRequestCallback, Chain as LightMyRequestChain, Response as LightMyRequestResponse } from 'light-my-request'\n+\n+import { AddContentTypeParser, ConstructorAction, FastifyBodyParser, FastifyContentTypeParser, getDefaultJsonParser, hasContentTypeParser, ProtoAction } from './types/content-type-parser'\n+import { FastifyContextConfig, FastifyReplyContext, FastifyRequestContext } from './types/context'\n+import { FastifyErrorCodes } from './types/errors'\n+import { DoneFuncWithErrOrRes, HookHandlerDoneFunction, onCloseAsyncHookHandler, onCloseHookHandler, onErrorAsyncHookHandler, onErrorHookHandler, onListenAsyncHookHandler, onListenHookHandler, onReadyAsyncHookHandler, onReadyHookHandler, onRegisterHookHandler, onRequestAbortAsyncHookHandler, onRequestAbortHookHandler, onRequestAsyncHookHandler, onRequestHookHandler, onResponseAsyncHookHandler, onResponseHookHandler, onRouteHookHandler, onSendAsyncHookHandler, onSendHookHandler, onTimeoutAsyncHookHandler, onTimeoutHookHandler, preCloseAsyncHookHandler, preCloseHookHandler, preHandlerAsyncHookHandler, preHandlerHookHandler, preParsingAsyncHookHandler, preParsingHookHandler, preSerializationAsyncHookHandler, preSerializationHookHandler, preValidationAsyncHookHandler, preValidationHookHandler, RequestPayload } from './types/hooks'\n+import { FastifyInstance, FastifyListenOptions, PrintRoutesOptions } from './types/instance'\n+import {\n+  FastifyBaseLogger,\n+  FastifyChildLoggerFactory,\n+  FastifyLogFn,\n+  FastifyLoggerInstance,\n+  FastifyLoggerOptions,\n+  LogLevel,\n+  PinoLoggerOptions\n+} from './types/logger'\n+import { FastifyPlugin, FastifyPluginAsync, FastifyPluginCallback, FastifyPluginOptions } from './types/plugin'\n+import { FastifyRegister, FastifyRegisterOptions, RegisterOptions } from './types/register'\n import { FastifyReply } from './types/reply'\n-import { FastifySchemaValidationError } from './types/schema'\n-import { ConstructorAction, ProtoAction } from \"./types/content-type-parser\";\n-import { Socket } from 'net'\n-import { ValidatorCompiler } from '@fastify/ajv-compiler'\n-import { SerializerCompiler } from '@fastify/fast-json-stringify-compiler'\n-import { FastifySchema } from './types/schema'\n-import { FastifyContextConfig } from './types/context'\n-import { FastifyTypeProvider, FastifyTypeProviderDefault } from './types/type-provider'\n+import { FastifyRequest, RequestGenericInterface } from './types/request'\n+import { RouteGenericInterface, RouteHandler, RouteHandlerMethod, RouteOptions, RouteShorthandMethod, RouteShorthandOptions, RouteShorthandOptionsWithHandler } from './types/route'\n+import { FastifySchema, FastifySchemaValidationError, FastifySchemaCompiler, FastifySerializerCompiler, SchemaErrorDataVar, SchemaErrorFormatter } from './types/schema'\n+import { FastifyServerFactory, FastifyServerFactoryHandler } from './types/server-factory'\n+import { FastifyTypeProvider, FastifyTypeProviderDefault, SafePromiseLike } from './types/type-provider'\n+import { ContextConfigDefault, HTTPMethods, RawReplyDefaultExpression, RawRequestDefaultExpression, RawServerBase, RawServerDefault, RequestBodyDefault, RequestHeadersDefault, RequestParamsDefault, RequestQuerystringDefault } from './types/utils'\n+\n+declare module '@fastify/error' {\n+  interface FastifyError {\n+    validationContext?: SchemaErrorDataVar;\n+    validation?: FastifySchemaValidationError[];\n+  }\n+}\n+\n+type Fastify = typeof fastify\n+\n+declare namespace fastify {\n+  export const errorCodes: FastifyErrorCodes\n+\n+  export type FastifyHttp2SecureOptions<\n+    Server extends http2.Http2SecureServer,\n+    Logger extends FastifyBaseLogger = FastifyBaseLogger\n+  > = FastifyServerOptions<Server, Logger> & {\n+    http2: true,\n+    https: http2.SecureServerOptions,\n+    http2SessionTimeout?: number\n+  }\n+\n+  export type FastifyHttp2Options<\n+    Server extends http2.Http2Server,\n+    Logger extends FastifyBaseLogger = FastifyBaseLogger\n+  > = FastifyServerOptions<Server, Logger> & {\n+    http2: true,\n+    http2SessionTimeout?: number\n+  }\n+\n+  export type FastifyHttpsOptions<\n+    Server extends https.Server,\n+    Logger extends FastifyBaseLogger = FastifyBaseLogger\n+  > = FastifyServerOptions<Server, Logger> & {\n+    https: https.ServerOptions | null\n+  }\n+\n+  export type FastifyHttpOptions<\n+    Server extends http.Server,\n+    Logger extends FastifyBaseLogger = FastifyBaseLogger\n+  > = FastifyServerOptions<Server, Logger> & {\n+    http?: http.ServerOptions | null\n+  }\n+\n",
					"match": false,
					"packageHash": "383cb8858adf202dadcff753bd4464e3c635c783da6c4d0ec2119cc3129b83af",
					"size": 10118,
					"sourceHash": "b2e0c2344f988a4b1e001c2f83b9646dede05a1e9ae95fc70881b71a3c4b38b4",
					"status": "content"
				},
				"fastify.js": {
					"diff": "--- published/fastify.js\n+++ rebuilt/fastify.js\n@@ -1,9 +1,10 @@\n 'use strict'\n \n-const VERSION = '4.5.2'\n+const VERSION = '5.6.2'\n \n const Avvio = require('avvio')\n-const http = require('http')\n+const http = require('node:http')\n+const diagnostics = require('node:diagnostics_channel')\n let lightMyRequest\n \n const {\n@@ -11,6 +12,7 @@\n   kChildren,\n   kServerBindings,\n   kBodyLimit,\n+  kSupportedHTTPMethods,\n   kRoutePrefix,\n   kLogLevel,\n   kLogSerializers,\n@@ -28,174 +30,86 @@\n   kSchemaErrorFormatter,\n   kErrorHandler,\n   kKeepAliveConnections,\n-  kFourOhFourContext\n+  kChildLoggerFactory,\n+  kGenReqId,\n+  kErrorHandlerAlreadySet\n } = require('./lib/symbols.js')\n \n-const { createServer, compileValidateHTTPVersion } = require('./lib/server')\n+const { createServer } = require('./lib/server')\n const Reply = require('./lib/reply')\n const Request = require('./lib/request')\n-const { supportedMethods } = require('./lib/httpMethods')\n+const Context = require('./lib/context.js')\n const decorator = require('./lib/decorate')\n-const ContentTypeParser = require('./lib/contentTypeParser')\n+const ContentTypeParser = require('./lib/content-type-parser.js')\n const SchemaController = require('./lib/schema-controller')\n const { Hooks, hookRunnerApplication, supportedHooks } = require('./lib/hooks')\n-const { createLogger } = require('./lib/logger')\n-const pluginUtils = require('./lib/pluginUtils')\n-const reqIdGenFactory = require('./lib/reqIdGenFactory')\n-const { buildRouting, validateBodyLimitOption } = require('./lib/route')\n-const build404 = require('./lib/fourOhFour')\n-const getSecuredInitialConfig = require('./lib/initialConfigValidation')\n-const override = require('./lib/pluginOverride')\n-const warning = require('./lib/warnings')\n-const noopSet = require('./lib/noop-set')\n-const { defaultInitOptions } = getSecuredInitialConfig\n-\n+const { createChildLogger, defaultChildLoggerFactory, createLogger } = require('./lib/logger-factory')\n+const pluginUtils = require('./lib/plugin-utils.js')\n+const { getGenReqId, reqIdGenFactory } = require('./lib/req-id-gen-factory.js')\n+const { buildRouting, validateBodyLimitOption, buildRouterOptions } = require('./lib/route')\n+const build404 = require('./lib/four-oh-four')\n+const getSecuredInitialConfig = require('./lib/initial-config-validation.js')\n+const override = require('./lib/plugin-override')\n const {\n-  FST_ERR_BAD_URL,\n-  FST_ERR_FORCE_CLOSE_CONNECTIONS_IDLE_NOT_AVAILABLE,\n+  appendStackTrace,\n   AVVIO_ERRORS_MAP,\n-  appendStackTrace\n+  ...errorCodes\n } = require('./lib/errors')\n+const PonyPromise = require('./lib/promise')\n \n-const { buildErrorHandler } = require('./lib/error-handler.js')\n-\n-const onBadUrlContext = {\n-  config: {\n-  },\n-  onSend: [],\n-  onError: [],\n-  [kFourOhFourContext]: null\n-}\n-\n-function defaultBuildPrettyMeta (route) {\n-  // return a shallow copy of route's sanitized context\n-\n-  const cleanKeys = {}\n-  const allowedProps = ['errorHandler', 'logLevel', 'logSerializers']\n-\n-  allowedProps.concat(supportedHooks).forEach(k => {\n-    cleanKeys[k] = route.store[k]\n-  })\n-\n-  return Object.assign({}, cleanKeys)\n-}\n-\n-function fastify (options) {\n-  // Options validations\n-  options = options || {}\n-\n-  if (typeof options !== 'object') {\n",
					"match": false,
					"packageHash": "38c699aa6e0862d067284270b1fa1fcb6818b91221decc9bc8204addf7c6602e",
					"size": 26492,
					"sourceHash": "0443f274dc7099308b4b5ba6543bec1f9967067205b4c23042e2775c25904327",
					"status": "content"
				},
				"integration/server.js": {
					"diff": "--- published/integration/server.js\n+++ rebuilt/integration/server.js\n@@ -1,3 +1,5 @@\n+'use strict'\n+\n const Fastify = require('../fastify')\n \n const fastify = Fastify()\n",
					"match": false,
					"packageHash": "82b8bbfe2c3e0c827747a5a792d6755326dd5159ecf02d51db127137ac778057",
					"size": 630,
					"sourceHash": "90c54aaa6bd615026729d91106ddf607f16f6303e8b42b69987284e87e5cf935",
					"status": "content"
				},
				"lib/configValidator.js": {
					"match": false,
					"packageHash": "97ccd1af58c74909b4addccd8fd4adde63eac279bb514cc82320a82382574a1a",
					"size": 29556,
					"status": "missing-in-source"
				},
				"lib/contentTypeParser.js": {
					"match": false,
					"packageHash": "4186d06e035ed96246af5b7e501ed19ade37a5c1f796aa508c5198c42acd400e",
					"size": 10130,
					"status": "missing-in-source"
				},
				"lib/context.js": {
					"diff": "--- published/lib/context.js\n+++ rebuilt/lib/context.js\n@@ -5,22 +5,26 @@\n   kReplySerializerDefault,\n   kSchemaErrorFormatter,\n   kErrorHandler,\n+  kChildLoggerFactory,\n+  kOptions,\n   kReply,\n   kRequest,\n   kBodyLimit,\n   kLogLevel,\n   kContentTypeParser,\n   kRouteByFastify,\n-  kRequestValidateWeakMap,\n-  kReplySerializeWeakMap\n+  kRequestCacheValidateFns,\n+  kReplyCacheSerializeFns\n } = require('./symbols.js')\n \n-// Objects that holds the context of every request\n+// Object that holds the context of every request\n // Every route holds an instance of this object.\n function Context ({\n   schema,\n   handler,\n   config,\n+  requestIdLogLabel,\n+  childLoggerFactory,\n   errorHandler,\n   bodyLimit,\n   logLevel,\n@@ -30,6 +34,8 @@\n   serializerCompiler,\n   replySerializer,\n   schemaErrorFormatter,\n+  exposeHeadRoute,\n+  prefixTrailingSlash,\n   server,\n   isFastify\n }) {\n@@ -45,22 +51,30 @@\n   this.preHandler = null\n   this.onResponse = null\n   this.preSerialization = null\n+  this.onRequestAbort = null\n   this.config = config\n   this.errorHandler = errorHandler || server[kErrorHandler]\n+  this.requestIdLogLabel = requestIdLogLabel || server[kOptions].requestIdLogLabel\n+  this.childLoggerFactory = childLoggerFactory || server[kChildLoggerFactory]\n   this._middie = null\n   this._parserOptions = {\n     limit: bodyLimit || server[kBodyLimit]\n   }\n+  this.exposeHeadRoute = exposeHeadRoute\n+  this.prefixTrailingSlash = prefixTrailingSlash\n   this.logLevel = logLevel || server[kLogLevel]\n   this.logSerializers = logSerializers\n   this[kFourOhFourContext] = null\n   this.attachValidation = attachValidation\n   this[kReplySerializerDefault] = replySerializer\n-  this.schemaErrorFormatter = schemaErrorFormatter || server[kSchemaErrorFormatter] || defaultSchemaErrorFormatter\n+  this.schemaErrorFormatter =\n+    schemaErrorFormatter ||\n+    server[kSchemaErrorFormatter] ||\n+    defaultSchemaErrorFormatter\n   this[kRouteByFastify] = isFastify\n \n-  this[kRequestValidateWeakMap] = null\n-  this[kReplySerializeWeakMap] = null\n+  this[kRequestCacheValidateFns] = null\n+  this[kReplyCacheSerializeFns] = null\n   this.validatorCompiler = validatorCompiler || null\n   this.serializerCompiler = serializerCompiler || null\n \n@@ -71,8 +85,7 @@\n   let text = ''\n   const separator = ', '\n \n-  // eslint-disable-next-line no-var\n-  for (var i = 0; i !== errors.length; ++i) {\n+  for (let i = 0; i !== errors.length; ++i) {\n     const e = errors[i]\n     text += dataVar + (e.instancePath || '') + ' ' + e.message + separator\n   }\n",
					"match": false,
					"packageHash": "84f52d896c3f878a45366541f2127d6215cad6a0d53decf6c1b11a3b0fcdb293",
					"size": 2087,
					"sourceHash": "b8b64e2e2f921109dca72403a349eae8263859bf9bd0fbce42e841eebf596477",
					"status": "content"
				},
				"lib/decorate.js": {
					"diff": "--- published/lib/decorate.js\n+++ rebuilt/lib/decorate.js\n@@ -1,7 +1,5 @@\n 'use strict'\n \n-/* eslint no-prototype-builtins: 0 */\n-\n const {\n   kReply,\n   kRequest,\n@@ -13,13 +11,13 @@\n   FST_ERR_DEC_ALREADY_PRESENT,\n   FST_ERR_DEC_MISSING_DEPENDENCY,\n   FST_ERR_DEC_AFTER_START,\n-  FST_ERR_DEC_DEPENDENCY_INVALID_TYPE\n+  FST_ERR_DEC_REFERENCE_TYPE,\n+  FST_ERR_DEC_DEPENDENCY_INVALID_TYPE,\n+  FST_ERR_DEC_UNDECLARED\n } = require('./errors')\n \n-const warning = require('./warnings')\n-\n function decorate (instance, name, fn, dependencies) {\n-  if (instance.hasOwnProperty(name)) {\n+  if (Object.hasOwn(instance, name)) {\n     throw new FST_ERR_DEC_ALREADY_PRESENT(name)\n   }\n \n@@ -35,9 +33,21 @@\n   }\n }\n \n+function getInstanceDecorator (name) {\n+  if (!checkExistence(this, name)) {\n+    throw new FST_ERR_DEC_UNDECLARED(name, 'instance')\n+  }\n+\n+  if (typeof this[name] === 'function') {\n+    return this[name].bind(this)\n+  }\n+\n+  return this[name]\n+}\n+\n function decorateConstructor (konstructor, name, fn, dependencies) {\n   const instance = konstructor.prototype\n-  if (instance.hasOwnProperty(name) || hasKey(konstructor, name)) {\n+  if (Object.hasOwn(instance, name) || hasKey(konstructor, name)) {\n     throw new FST_ERR_DEC_ALREADY_PRESENT(name)\n   }\n \n@@ -58,7 +68,7 @@\n \n function checkReferenceType (name, fn) {\n   if (typeof fn === 'object' && fn && !(typeof fn.getter === 'function' || typeof fn.setter === 'function')) {\n-    warning.emit('FSTDEP006', name)\n+    throw new FST_ERR_DEC_REFERENCE_TYPE(name, typeof fn)\n   }\n }\n \n@@ -102,8 +112,7 @@\n     throw new FST_ERR_DEC_DEPENDENCY_INVALID_TYPE(name)\n   }\n \n-  // eslint-disable-next-line no-var\n-  for (var i = 0; i !== deps.length; ++i) {\n+  for (let i = 0; i !== deps.length; ++i) {\n     if (!checkExistence(instance, deps[i])) {\n       throw new FST_ERR_DEC_MISSING_DEPENDENCY(deps[i])\n     }\n@@ -137,5 +146,7 @@\n   existReply: checkReplyExistence,\n   dependencies: checkDependencies,\n   decorateReply,\n-  decorateRequest\n+  decorateRequest,\n+  getInstanceDecorator,\n+  hasKey\n }\n",
					"match": false,
					"packageHash": "675432e2e452bc6df24bb6957b958583af337f27ca13185e58a3f74170acfba4",
					"size": 3487,
					"sourceHash": "60329abc576bdee0e7cb39f9b221ee8dfa8fb69bd29f8c2dccf47ffc478c9890",
					"status": "content"
				},
				"lib/error-handler.js": {
					"diff": "--- published/lib/error-handler.js\n+++ rebuilt/lib/error-handler.js\n@@ -1,13 +1,19 @@\n 'use strict'\n \n-const statusCodes = require('http').STATUS_CODES\n-const wrapThenable = require('./wrapThenable')\n+const statusCodes = require('node:http').STATUS_CODES\n+const wrapThenable = require('./wrap-thenable.js')\n+const { setErrorStatusCode } = require('./error-status.js')\n const {\n-  kReplyHeaders, kReplyNextErrorHandler, kReplyIsRunningOnErrorHook, kReplyHasStatusCode\n+  kReplyHeaders,\n+  kReplyNextErrorHandler,\n+  kReplyIsRunningOnErrorHook,\n+  kRouteContext,\n+  kDisableRequestLogging\n } = require('./symbols.js')\n \n const {\n-  FST_ERR_REP_INVALID_PAYLOAD_TYPE\n+  FST_ERR_REP_INVALID_PAYLOAD_TYPE,\n+  FST_ERR_FAILED_ERROR_SERIALIZATION\n } = require('./errors')\n \n const { getSchemaSerializer } = require('./schemas')\n@@ -24,16 +30,18 @@\n function handleError (reply, error, cb) {\n   reply[kReplyIsRunningOnErrorHook] = false\n \n-  const context = reply.context\n+  const context = reply[kRouteContext]\n   if (reply[kReplyNextErrorHandler] === false) {\n     fallbackErrorHandler(error, reply, function (reply, payload) {\n       try {\n         reply.raw.writeHead(reply.raw.statusCode, reply[kReplyHeaders])\n       } catch (error) {\n-        reply.log.warn(\n-          { req: reply.request, res: reply, err: error },\n-          error && error.message\n-        )\n+        if (!reply.log[kDisableRequestLogging]) {\n+          reply.log.warn(\n+            { req: reply.request, res: reply, err: error },\n+            error?.message\n+          )\n+        }\n         reply.raw.writeHead(reply.raw.statusCode)\n       }\n       reply.raw.end(payload)\n@@ -45,6 +53,8 @@\n   // In case the error handler throws, we set the next errorHandler so we can error again\n   reply[kReplyNextErrorHandler] = Object.getPrototypeOf(errorHandler)\n \n+  // we need to remove content-type to allow content-type guessing for serialization\n+  delete reply[kReplyHeaders]['content-type']\n   delete reply[kReplyHeaders]['content-length']\n \n   const func = errorHandler.func\n@@ -55,32 +65,37 @@\n     return\n   }\n \n-  const result = func(error, reply.request, reply)\n-  if (result !== undefined) {\n-    if (result !== null && typeof result.then === 'function') {\n-      wrapThenable(result, reply)\n-    } else {\n-      reply.send(result)\n+  try {\n+    const result = func(error, reply.request, reply)\n+    if (result !== undefined) {\n+      if (result !== null && typeof result.then === 'function') {\n+        wrapThenable(result, reply)\n+      } else {\n+        reply.send(result)\n+      }\n     }\n+  } catch (err) {\n+    reply.send(err)\n   }\n }\n \n function defaultErrorHandler (error, request, reply) {\n   setErrorHeaders(error, reply)\n-  if (!reply[kReplyHasStatusCode] || reply.statusCode === 200) {\n-    const statusCode = error.statusCode || error.status\n-    reply.code(statusCode >= 400 ? statusCode : 500)\n-  }\n+  setErrorStatusCode(reply, error)\n   if (reply.statusCode < 500) {\n-    reply.log.info(\n-      { res: reply, err: error },\n-      error && error.message\n-    )\n+    if (!reply.log[kDisableRequestLogging]) {\n+      reply.log.info(\n+        { res: reply, err: error },\n+        error?.message\n+      )\n",
					"match": false,
					"packageHash": "6d36fc9191bbce7dd7684ea7a47147e2cd8dcd0e5d9bdcfebca9ee01d1776e20",
					"size": 4357,
					"sourceHash": "5c4dc73a54255233d20017431c1bcddfff91965afef45cfb5fd301028401fdc6",
					"status": "content"
				},
				"lib/error-serializer.js": {
					"diff": "--- published/lib/error-serializer.js\n+++ rebuilt/lib/error-serializer.js\n@@ -1,250 +1,120 @@\n // This file is autogenerated by build/build-error-serializer.js, do not edit\n-/* istanbul ignore file */\n+/* c8 ignore start */\n \n   'use strict'\n \n-  \n-\n-class Serializer {\n-  constructor (options = {}) {\n-    switch (options.rounding) {\n-      case 'floor':\n-        this.parseInteger = Math.floor\n-        break\n-      case 'ceil':\n-        this.parseInteger = Math.ceil\n-        break\n-      case 'round':\n-        this.parseInteger = Math.round\n-        break\n-      default:\n-        this.parseInteger = Math.trunc\n-        break\n-    }\n-  }\n-\n-  asAny (i) {\n-    return JSON.stringify(i)\n-  }\n-\n-  asNull () {\n-    return 'null'\n-  }\n-\n-  asInteger (i) {\n-    if (typeof i === 'bigint') {\n-      return i.toString()\n-    } else if (Number.isInteger(i)) {\n-      return '' + i\n-    } else {\n-      /* eslint no-undef: \"off\" */\n-      const integer = this.parseInteger(i)\n-      if (Number.isNaN(integer) || !Number.isFinite(integer)) {\n-        throw new Error(`The value \"${i}\" cannot be converted to an integer.`)\n-      } else {\n-        return '' + integer\n-      }\n-    }\n-  }\n-\n-  asIntegerNullable (i) {\n-    return i === null ? 'null' : this.asInteger(i)\n-  }\n-\n-  asNumber (i) {\n-    const num = Number(i)\n-    if (Number.isNaN(num)) {\n-      throw new Error(`The value \"${i}\" cannot be converted to a number.`)\n-    } else if (!Number.isFinite(num)) {\n-      return null\n-    } else {\n-      return '' + num\n-    }\n-  }\n-\n-  asNumberNullable (i) {\n-    return i === null ? 'null' : this.asNumber(i)\n-  }\n-\n-  asBoolean (bool) {\n-    return bool && 'true' || 'false' // eslint-disable-line\n-  }\n-\n-  asBooleanNullable (bool) {\n-    return bool === null ? 'null' : this.asBoolean(bool)\n-  }\n-\n-  asDateTime (date) {\n-    if (date === null) return '\"\"'\n-    if (date instanceof Date) {\n-      return '\"' + date.toISOString() + '\"'\n-    }\n-    throw new Error(`The value \"${date}\" cannot be converted to a date-time.`)\n-  }\n-\n-  asDateTimeNullable (date) {\n-    return date === null ? 'null' : this.asDateTime(date)\n-  }\n-\n-  asDate (date) {\n-    if (date === null) return '\"\"'\n-    if (date instanceof Date) {\n-      return '\"' + new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 10) + '\"'\n-    }\n-    throw new Error(`The value \"${date}\" cannot be converted to a date.`)\n-  }\n+  const Serializer = require('fast-json-stringify/lib/serializer')\n",
					"match": false,
					"packageHash": "3d149517f1a8596bfef1f2063d270a748b07866453a57b68e1443f7cff39d88c",
					"size": 5595,
					"sourceHash": "7d1bd704a82b77847749336ffeabd29fbd403f6f1c427eb3072e177f8ae005d2",
					"status": "content"
				},
				"lib/errors.js": {
					"diff": "--- published/lib/errors.js\n+++ rebuilt/lib/errors.js\n@@ -1,6 +1,7 @@\n 'use strict'\n \n const createError = require('@fastify/error')\n+\n const codes = {\n   /**\n    * Basic\n@@ -10,6 +11,65 @@\n     'Not Found',\n     404\n   ),\n+  FST_ERR_OPTIONS_NOT_OBJ: createError(\n+    'FST_ERR_OPTIONS_NOT_OBJ',\n+    'Options must be an object',\n+    500,\n+    TypeError\n+  ),\n+  FST_ERR_QSP_NOT_FN: createError(\n+    'FST_ERR_QSP_NOT_FN',\n+    \"querystringParser option should be a function, instead got '%s'\",\n+    500,\n+    TypeError\n+  ),\n+  FST_ERR_SCHEMA_CONTROLLER_BUCKET_OPT_NOT_FN: createError(\n+    'FST_ERR_SCHEMA_CONTROLLER_BUCKET_OPT_NOT_FN',\n+    \"schemaController.bucket option should be a function, instead got '%s'\",\n+    500,\n+    TypeError\n+  ),\n+  FST_ERR_SCHEMA_ERROR_FORMATTER_NOT_FN: createError(\n+    'FST_ERR_SCHEMA_ERROR_FORMATTER_NOT_FN',\n+    \"schemaErrorFormatter option should be a non async function. Instead got '%s'.\",\n+    500,\n+    TypeError\n+  ),\n+  FST_ERR_AJV_CUSTOM_OPTIONS_OPT_NOT_OBJ: createError(\n+    'FST_ERR_AJV_CUSTOM_OPTIONS_OPT_NOT_OBJ',\n+    \"ajv.customOptions option should be an object, instead got '%s'\",\n+    500,\n+    TypeError\n+  ),\n+  FST_ERR_AJV_CUSTOM_OPTIONS_OPT_NOT_ARR: createError(\n+    'FST_ERR_AJV_CUSTOM_OPTIONS_OPT_NOT_ARR',\n+    \"ajv.plugins option should be an array, instead got '%s'\",\n+    500,\n+    TypeError\n+  ),\n+  FST_ERR_VALIDATION: createError(\n+    'FST_ERR_VALIDATION',\n+    '%s',\n+    400\n+  ),\n+  FST_ERR_LISTEN_OPTIONS_INVALID: createError(\n+    'FST_ERR_LISTEN_OPTIONS_INVALID',\n+    \"Invalid listen options: '%s'\",\n+    500,\n+    TypeError\n+  ),\n+  FST_ERR_ERROR_HANDLER_NOT_FN: createError(\n+    'FST_ERR_ERROR_HANDLER_NOT_FN',\n+    'Error Handler must be a function',\n+    500,\n+    TypeError\n+  ),\n+  FST_ERR_ERROR_HANDLER_ALREADY_SET: createError(\n+    'FST_ERR_ERROR_HANDLER_ALREADY_SET',\n+    \"Error Handler already set in this scope. Set 'allowErrorHandlerOverride: true' to allow overriding.\",\n+    500,\n+    TypeError\n+  ),\n \n   /**\n    * ContentTypeParser\n@@ -64,6 +124,16 @@\n     \"Body cannot be empty when content-type is set to 'application/json'\",\n     400\n   ),\n+  FST_ERR_CTP_INVALID_JSON_BODY: createError(\n+    'FST_ERR_CTP_INVALID_JSON_BODY',\n+    \"Body is not valid JSON but content-type is set to 'application/json'\",\n+    400\n+  ),\n+  FST_ERR_CTP_INSTANCE_ALREADY_STARTED: createError(\n+    'FST_ERR_CTP_INSTANCE_ALREADY_STARTED',\n+    'Cannot call \"%s\" when fastify instance is already started!',\n+    400\n+  ),\n \n   /**\n    * decorate\n@@ -74,7 +144,9 @@\n   ),\n   FST_ERR_DEC_DEPENDENCY_INVALID_TYPE: createError(\n     'FST_ERR_DEC_DEPENDENCY_INVALID_TYPE',\n-    \"The dependencies of decorator '%s' must be of type Array.\"\n+    \"The dependencies of decorator '%s' must be of type Array.\",\n+    500,\n",
					"match": false,
					"packageHash": "8ff9f1fd906b73e5ab8aa39a7c1ed1dc7eb07d98bdd9611e168926e6c1d0f2a6",
					"size": 7738,
					"sourceHash": "60f7f4c6e24b4f766c8af6b61d3752567ea3b3101caf9cb146e771719b9a1718",
					"status": "content"
				},
				"lib/fourOhFour.js": {
					"match": false,
					"packageHash": "1483b242d6300a469c342f98f98494603b060171f3f84c5e4daeb09a230c58bd",
					"size": 5889,
					"status": "missing-in-source"
				},
				"lib/handleRequest.js": {
					"match": false,
					"packageHash": "4fb10bd057ad6533e7f4545968cd96b6715d54fee0aa8f19b4a8f41f91f78536",
					"size": 3326,
					"status": "missing-in-source"
				},
				"lib/headRoute.js": {
					"match": false,
					"packageHash": "582ff4e5e87e06c4946684079934456c2372cd688d7835688bd303ce7f4049c8",
					"size": 821,
					"status": "missing-in-source"
				},
				"lib/hooks.js": {
					"diff": "--- published/lib/hooks.js\n+++ rebuilt/lib/hooks.js\n@@ -4,6 +4,8 @@\n   'onRoute',\n   'onRegister',\n   'onReady',\n+  'onListen',\n+  'preClose',\n   'onClose'\n ]\n const lifecycleHooks = [\n@@ -15,7 +17,8 @@\n   'preHandler',\n   'onSend',\n   'onResponse',\n-  'onError'\n+  'onError',\n+  'onRequestAbort'\n ]\n const supportedHooks = lifecycleHooks.concat(applicationHooks)\n const {\n@@ -23,13 +26,15 @@\n   FST_ERR_HOOK_INVALID_HANDLER,\n   FST_ERR_SEND_UNDEFINED_ERR,\n   FST_ERR_HOOK_TIMEOUT,\n+  FST_ERR_HOOK_NOT_SUPPORTED,\n   AVVIO_ERRORS_MAP,\n   appendStackTrace\n } = require('./errors')\n \n const {\n   kChildren,\n-  kHooks\n+  kHooks,\n+  kRequestPayloadStream\n } = require('./symbols')\n \n function Hooks () {\n@@ -44,15 +49,20 @@\n   this.onRoute = []\n   this.onRegister = []\n   this.onReady = []\n+  this.onListen = []\n   this.onTimeout = []\n+  this.onRequestAbort = []\n+  this.preClose = []\n }\n \n+Hooks.prototype = Object.create(null)\n+\n Hooks.prototype.validate = function (hook, fn) {\n   if (typeof hook !== 'string') throw new FST_ERR_HOOK_INVALID_TYPE()\n-  if (typeof fn !== 'function') throw new FST_ERR_HOOK_INVALID_HANDLER()\n-  if (supportedHooks.indexOf(hook) === -1) {\n-    throw new Error(`${hook} hook not supported!`)\n+  if (Array.isArray(this[hook]) === false) {\n+    throw new FST_ERR_HOOK_NOT_SUPPORTED(hook)\n   }\n+  if (typeof fn !== 'function') throw new FST_ERR_HOOK_INVALID_HANDLER(hook, Object.prototype.toString.call(fn))\n }\n \n Hooks.prototype.add = function (hook, fn) {\n@@ -73,7 +83,10 @@\n   hooks.onRoute = h.onRoute.slice()\n   hooks.onRegister = h.onRegister.slice()\n   hooks.onTimeout = h.onTimeout.slice()\n+  hooks.onRequestAbort = h.onRequestAbort.slice()\n   hooks.onReady = []\n+  hooks.onListen = []\n+  hooks.preClose = []\n   return hooks\n }\n \n@@ -85,9 +98,12 @@\n   next()\n \n   function exit (err) {\n+    const hookFnName = hooks[i - 1]?.name\n+    const hookFnFragment = hookFnName ? ` \"${hookFnName}\"` : ''\n+\n     if (err) {\n       if (err.code === 'AVV_ERR_READY_TIMEOUT') {\n-        err = appendStackTrace(err, new FST_ERR_HOOK_TIMEOUT(hookName))\n+        err = appendStackTrace(err, new FST_ERR_HOOK_TIMEOUT(hookName, hookFnFragment))\n       } else {\n         err = AVVIO_ERRORS_MAP[err.code] != null\n           ? appendStackTrace(err, new AVVIO_ERRORS_MAP[err.code](err.message))\n@@ -149,31 +165,139 @@\n         return\n       }\n \n+      try {\n+        const ret = fn.call(server)\n+        if (ret && typeof ret.then === 'function') {\n+          ret.then(done, done)\n+          return\n+        }\n+      } catch (error) {\n+        err = error\n+      }\n",
					"match": false,
					"packageHash": "6dc50f1036f91860d489fc0d7f7f5887dd2f4f26f347c862a0d3c9d628813891",
					"size": 5462,
					"sourceHash": "3d1470797f26b2beb1dcffdcb86cf92780d8811e53d8ce2007fb90d8d8434c1b",
					"status": "content"
				},
				"lib/httpMethods.js": {
					"match": false,
					"packageHash": "7568b53c7f4917b4fd4eacc6d76541bdbfa300a629b83f00901011a0e7cba7cd",
					"size": 271,
					"status": "missing-in-source"
				},
				"lib/initialConfigValidation.js": {
					"match": false,
					"packageHash": "ccda7bafa6060e6efe8723d91598bd27fb0a0d0393b35c7253446eef64af1b73",
					"size": 1007,
					"status": "missing-in-source"
				},
				"lib/logger.js": {
					"match": false,
					"packageHash": "8597f55848c4e90975a492f51cfa5ea86ceaf518001e15a43f7b1c4186c95aca",
					"size": 3284,
					"status": "missing-in-source"
				},
				"lib/pluginOverride.js": {
					"match": false,
					"packageHash": "c665f4a618e4961c7e48d35053070148f116b57e468d95db1f2ff378a90c80db",
					"size": 2786,
					"status": "missing-in-source"
				},
				"lib/pluginUtils.js": {
					"match": false,
					"packageHash": "3a42450a0e4022c1410860854005becdc92c8d51eaa450221710731feecd1441",
					"size": 4158,
					"status": "missing-in-source"
				},
				"lib/reply.js": {
					"diff": "--- published/lib/reply.js\n+++ rebuilt/lib/reply.js\n@@ -1,6 +1,7 @@\n 'use strict'\n \n-const eos = require('stream').finished\n+const eos = require('node:stream').finished\n+const Readable = require('node:stream').Readable\n \n const {\n   kFourOhFourContext,\n@@ -18,14 +19,20 @@\n   kReplyNextErrorHandler,\n   kDisableRequestLogging,\n   kSchemaResponse,\n-  kReplySerializeWeakMap,\n+  kReplyCacheSerializeFns,\n   kSchemaController,\n-  kOptions\n+  kOptions,\n+  kRouteContext\n } = require('./symbols.js')\n-const { hookRunner, hookIterator, onSendHookRunner } = require('./hooks')\n+const {\n+  onSendHookRunner,\n+  onResponseHookRunner,\n+  preHandlerHookRunner,\n+  preSerializationHookRunner\n+} = require('./hooks')\n \n-const internals = require('./handleRequest')[Symbol.for('internals')]\n-const loggerUtils = require('./logger')\n+const internals = require('./handle-request.js')[Symbol.for('internals')]\n+const loggerUtils = require('./logger-factory')\n const now = loggerUtils.now\n const { handleError } = require('./error-handler')\n const { getSchemaSerializer } = require('./schemas')\n@@ -37,15 +44,20 @@\n }\n const {\n   FST_ERR_REP_INVALID_PAYLOAD_TYPE,\n+  FST_ERR_REP_RESPONSE_BODY_CONSUMED,\n+  FST_ERR_REP_READABLE_STREAM_LOCKED,\n   FST_ERR_REP_ALREADY_SENT,\n-  FST_ERR_REP_SENT_VALUE,\n   FST_ERR_SEND_INSIDE_ONERR,\n   FST_ERR_BAD_STATUS_CODE,\n   FST_ERR_BAD_TRAILER_NAME,\n   FST_ERR_BAD_TRAILER_VALUE,\n-  FST_ERR_MISSING_SERIALIZATION_FN\n+  FST_ERR_MISSING_SERIALIZATION_FN,\n+  FST_ERR_MISSING_CONTENTTYPE_SERIALIZATION_FN,\n+  FST_ERR_DEC_UNDECLARED\n } = require('./errors')\n-const warning = require('./warnings')\n+const decorators = require('./decorate')\n+\n+const toString = Object.prototype.toString\n \n function Reply (res, request, log) {\n   this.raw = res\n@@ -63,14 +75,22 @@\n Reply.props = []\n \n Object.defineProperties(Reply.prototype, {\n-  context: {\n+  [kRouteContext]: {\n+    get () {\n+      return this.request[kRouteContext]\n+    }\n+  },\n+  elapsedTime: {\n     get () {\n-      return this.request.context\n+      if (this[kReplyStartTime] === undefined) {\n+        return 0\n+      }\n+      return (this[kReplyEndTime] || now()) - this[kReplyStartTime]\n     }\n   },\n   server: {\n     get () {\n-      return this.request.context.server\n+      return this.request[kRouteContext].server\n     }\n   },\n   sent: {\n@@ -78,20 +98,6 @@\n     get () {\n       // We are checking whether reply was hijacked or the response has ended.\n       return (this[kReplyHijacked] || this.raw.writableEnded) === true\n-    },\n-    set (value) {\n-      warning.emit('FSTDEP010')\n-\n-      if (value !== true) {\n-        throw new FST_ERR_REP_SENT_VALUE()\n-      }\n-\n-      // We throw only if sent was overwritten from Fastify\n",
					"match": false,
					"packageHash": "9376cc7d92abe9d1fb9870f8105cb5a6469c715b4403d64872f95662ce95c0c4",
					"size": 21676,
					"sourceHash": "8facc4dc9525ef8714ba7f1148e40644694de4017203c0d9a2ecd2bb7f55014c",
					"status": "content"
				},
				"lib/reqIdGenFactory.js": {
					"match": false,
					"packageHash": "939019fbc84f74c16497d3647bec42ca293f424bebddff8f23f8796b70c7c466",
					"size": 967,
					"status": "missing-in-source"
				},
				"lib/request.js": {
					"diff": "--- published/lib/request.js\n+++ rebuilt/lib/request.js\n@@ -1,8 +1,6 @@\n 'use strict'\n \n-const proxyAddr = require('proxy-addr')\n-const semver = require('semver')\n-const warning = require('./warnings')\n+const proxyAddr = require('@fastify/proxy-addr')\n const {\n   kHasBeenDecorated,\n   kSchemaBody,\n@@ -11,9 +9,12 @@\n   kSchemaQuerystring,\n   kSchemaController,\n   kOptions,\n-  kRequestValidateWeakMap\n+  kRequestCacheValidateFns,\n+  kRouteContext,\n+  kRequestOriginalUrl\n } = require('./symbols')\n-const { FST_ERR_REQ_INVALID_VALIDATION_INVOCATION } = require('./errors')\n+const { FST_ERR_REQ_INVALID_VALIDATION_INVOCATION, FST_ERR_DEC_UNDECLARED } = require('./errors')\n+const decorators = require('./decorate')\n \n const HTTP_PART_SYMBOL_MAP = {\n   body: kSchemaBody,\n@@ -25,7 +26,7 @@\n \n function Request (id, params, req, query, log, context) {\n   this.id = id\n-  this.context = context\n+  this[kRouteContext] = context\n   this.params = params\n   this.raw = req\n   this.query = query\n@@ -39,8 +40,8 @@\n     return tp\n   }\n   if (tp === true) {\n-    // Support plain true/false\n-    return function () { return true }\n+    // Support trusting everything\n+    return null\n   }\n   if (typeof tp === 'number') {\n     // Support trusting hop count\n@@ -48,8 +49,8 @@\n   }\n   if (typeof tp === 'string') {\n     // Support comma-separated tps\n-    const vals = tp.split(',').map(it => it.trim())\n-    return proxyAddr.compile(vals)\n+    const values = tp.split(',').map(it => it.trim())\n+    return proxyAddr.compile(values)\n   }\n   return proxyAddr.compile(tp)\n }\n@@ -63,20 +64,18 @@\n }\n \n function buildRegularRequest (R) {\n-  const props = [...R.props]\n+  const props = R.props.slice()\n   function _Request (id, params, req, query, log, context) {\n     this.id = id\n-    this.context = context\n+    this[kRouteContext] = context\n     this.params = params\n     this.raw = req\n     this.query = query\n     this.log = log\n     this.body = undefined\n \n-    // eslint-disable-next-line no-var\n-    var prop\n-    // eslint-disable-next-line no-var\n-    for (var i = 0; i < props.length; i++) {\n+    let prop\n+    for (let i = 0; i < props.length; i++) {\n       prop = props[i]\n       this[prop.key] = prop.value\n     }\n@@ -105,7 +104,8 @@\n   Object.defineProperties(_Request.prototype, {\n     ip: {\n       get () {\n-        return proxyAddr(this.raw, proxyFn)\n+        const addrs = proxyAddr.all(this.raw, proxyFn)\n+        return addrs[addrs.length - 1]\n       }\n     },\n     ips: {\n@@ -113,12 +113,18 @@\n         return proxyAddr.all(this.raw, proxyFn)\n       }\n     },\n-    hostname: {\n+    host: {\n       get () {\n",
					"match": false,
					"packageHash": "629b2133ca33d8506256288e1fc2b280821e3a93c309f9ec734a61d65f931f40",
					"size": 7403,
					"sourceHash": "f0df6d3cec1cd760d4483f93ba1f63e06d3b0b15f3be1926680d96c35546bbac",
					"status": "content"
				},
				"lib/route.js": {
					"diff": "--- published/lib/route.js\n+++ rebuilt/lib/route.js\n@@ -2,13 +2,10 @@\n \n const FindMyWay = require('find-my-way')\n const Context = require('./context')\n-const handleRequest = require('./handleRequest')\n-const { hookRunner, hookIterator, lifecycleHooks } = require('./hooks')\n-const { supportedMethods } = require('./httpMethods')\n+const handleRequest = require('./handle-request.js')\n+const { onRequestAbortHookRunner, lifecycleHooks, preParsingHookRunner, onTimeoutHookRunner, onRequestHookRunner } = require('./hooks')\n const { normalizeSchema } = require('./schemas')\n-const { parseHeadOnSendHandlers } = require('./headRoute')\n-const warning = require('./warnings')\n-const { kRequestAcceptVersion, kRouteByFastify } = require('./symbols')\n+const { parseHeadOnSendHandlers } = require('./head-route.js')\n \n const {\n   compileSchemasForValidation,\n@@ -18,14 +15,25 @@\n const {\n   FST_ERR_SCH_VALIDATION_BUILD,\n   FST_ERR_SCH_SERIALIZATION_BUILD,\n-  FST_ERR_DEFAULT_ROUTE_INVALID_TYPE,\n   FST_ERR_DUPLICATED_ROUTE,\n   FST_ERR_INVALID_URL,\n-  FST_ERR_SEND_UNDEFINED_ERR\n+  FST_ERR_HOOK_INVALID_HANDLER,\n+  FST_ERR_ROUTE_OPTIONS_NOT_OBJ,\n+  FST_ERR_ROUTE_DUPLICATED_HANDLER,\n+  FST_ERR_ROUTE_HANDLER_NOT_FN,\n+  FST_ERR_ROUTE_MISSING_HANDLER,\n+  FST_ERR_ROUTE_METHOD_NOT_SUPPORTED,\n+  FST_ERR_ROUTE_METHOD_INVALID,\n+  FST_ERR_ROUTE_BODY_VALIDATION_SCHEMA_NOT_SUPPORTED,\n+  FST_ERR_ROUTE_BODY_LIMIT_OPTION_NOT_INT,\n+  FST_ERR_HOOK_INVALID_ASYNC_HANDLER\n } = require('./errors')\n \n+const { FSTDEP022 } = require('./warnings')\n+\n const {\n   kRoutePrefix,\n+  kSupportedHTTPMethods,\n   kLogLevel,\n   kLogSerializers,\n   kHooks,\n@@ -37,72 +45,82 @@\n   kDisableRequestLogging,\n   kSchemaErrorFormatter,\n   kErrorHandler,\n-  kHasBeenDecorated\n+  kHasBeenDecorated,\n+  kRequestAcceptVersion,\n+  kRouteByFastify,\n+  kRouteContext\n } = require('./symbols.js')\n const { buildErrorHandler } = require('./error-handler')\n+const { createChildLogger } = require('./logger-factory.js')\n+const { getGenReqId } = require('./req-id-gen-factory.js')\n+\n+const routerKeys = [\n+  'allowUnsafeRegex',\n+  'buildPrettyMeta',\n+  'caseSensitive',\n+  'constraints',\n+  'defaultRoute',\n+  'ignoreDuplicateSlashes',\n+  'ignoreTrailingSlash',\n+  'maxParamLength',\n+  'onBadUrl',\n+  'querystringParser',\n+  'useSemicolonDelimiter'\n+]\n \n function buildRouting (options) {\n-  const router = FindMyWay(options.config)\n+  const router = FindMyWay(options)\n \n   let avvio\n   let fourOhFour\n-  let requestIdLogLabel\n   let logger\n   let hasLogger\n   let setupResponseListeners\n   let throwIfAlreadyStarted\n-  let genReqId\n   let disableRequestLogging\n   let ignoreTrailingSlash\n   let ignoreDuplicateSlashes\n   let return503OnClosing\n   let globalExposeHeadRoutes\n-  let validateHTTPVersion\n   let keepAliveConnections\n \n   let closing = false\n \n   return {\n+    /**\n+     * @param {import('../fastify').FastifyServerOptions} options\n",
					"match": false,
					"packageHash": "0b09253c318e8674660bf07132eeec289f5de73c3309e163fb5c52a5b4ad4094",
					"size": 17926,
					"sourceHash": "53d60bba071837b8efd771196a794812519b49b1f598a0a2cf3662dcab89ffe7",
					"status": "content"
				},
				"lib/schema-controller.js": {
					"diff": "--- published/lib/schema-controller.js\n+++ rebuilt/lib/schema-controller.js\n@@ -1,8 +1,6 @@\n 'use strict'\n \n const { buildSchemas } = require('./schemas')\n-const SerializerSelector = require('@fastify/fast-json-stringify-compiler')\n-const ValidatorSelector = require('@fastify/ajv-compiler')\n \n /**\n  * Called at every fastify context that is being created.\n@@ -15,17 +13,25 @@\n     return new SchemaController(parentSchemaCtrl, opts)\n   }\n \n-  let compilersFactory = {\n-    buildValidator: ValidatorSelector(),\n-    buildSerializer: SerializerSelector()\n-  }\n-  if (opts && opts.compilersFactory) {\n-    compilersFactory = Object.assign(compilersFactory, opts.compilersFactory)\n+  const compilersFactory = Object.assign({\n+    buildValidator: null,\n+    buildSerializer: null\n+  }, opts?.compilersFactory)\n+\n+  if (!compilersFactory.buildValidator) {\n+    const ValidatorSelector = require('@fastify/ajv-compiler')\n+    compilersFactory.buildValidator = ValidatorSelector()\n+  }\n+  if (!compilersFactory.buildSerializer) {\n+    const SerializerSelector = require('@fastify/fast-json-stringify-compiler')\n+    compilersFactory.buildSerializer = SerializerSelector()\n   }\n \n   const option = {\n     bucket: (opts && opts.bucket) || buildSchemas,\n-    compilersFactory\n+    compilersFactory,\n+    isCustomValidatorCompiler: typeof opts?.compilersFactory?.buildValidator === 'function',\n+    isCustomSerializerCompiler: typeof opts?.compilersFactory?.buildValidator === 'function'\n   }\n \n   return new SchemaController(undefined, option)\n@@ -33,7 +39,7 @@\n \n class SchemaController {\n   constructor (parent, options) {\n-    this.opts = options || (parent && parent.opts)\n+    this.opts = options || parent?.opts\n     this.addedSchemas = false\n \n     this.compilersFactory = this.opts.compilersFactory\n@@ -42,9 +48,13 @@\n       this.schemaBucket = this.opts.bucket(parent.getSchemas())\n       this.validatorCompiler = parent.getValidatorCompiler()\n       this.serializerCompiler = parent.getSerializerCompiler()\n+      this.isCustomValidatorCompiler = parent.isCustomValidatorCompiler\n+      this.isCustomSerializerCompiler = parent.isCustomSerializerCompiler\n       this.parent = parent\n     } else {\n       this.schemaBucket = this.opts.bucket()\n+      this.isCustomValidatorCompiler = this.opts.isCustomValidatorCompiler || false\n+      this.isCustomSerializerCompiler = this.opts.isCustomSerializerCompiler || false\n     }\n   }\n \n@@ -62,13 +72,48 @@\n     return this.schemaBucket.getSchemas()\n   }\n \n-  // Schema Controller compilers holder\n   setValidatorCompiler (validatorCompiler) {\n+    // Set up as if the fixed validator compiler had been provided\n+    // by a custom 'options.compilersFactory.buildValidator' that\n+    // always returns the same compiler object. This is required because:\n+    //\n+    // - setValidatorCompiler must immediately install a compiler to preserve\n+    //   legacy behavior\n+    // - setupValidator will recreate compilers from builders in some\n+    //   circumstances, so we have to install this adapter to make it\n+    //   behave the same if the legacy API is used\n+    //\n+    // The cloning of the compilersFactory object is necessary because\n+    // we are aliasing the parent compilersFactory if none was provided\n+    // to us (see constructor.)\n+    this.compilersFactory = Object.assign(\n+      {},\n+      this.compilersFactory,\n+      { buildValidator: () => validatorCompiler })\n     this.validatorCompiler = validatorCompiler\n+    this.isCustomValidatorCompiler = true\n   }\n \n   setSerializerCompiler (serializerCompiler) {\n+    // Set up as if the fixed serializer compiler had been provided\n+    // by a custom 'options.compilersFactory.buildSerializer' that\n+    // always returns the same compiler object. This is required because:\n+    //\n+    // - setSerializerCompiler must immediately install a compiler to preserve\n",
					"match": false,
					"packageHash": "555d18f0cf92316e7bc128787714ec2038ec1773ff7c6509baf2dc5a8d38869c",
					"size": 3566,
					"sourceHash": "aa1141d3f7babc9d7a05410ddfcf87fe9d5ab58fbe3c178e4b888646d3c4a328",
					"status": "content"
				},
				"lib/schemas.js": {
					"diff": "--- published/lib/schemas.js\n+++ rebuilt/lib/schemas.js\n@@ -7,7 +7,8 @@\n const {\n   FST_ERR_SCH_MISSING_ID,\n   FST_ERR_SCH_ALREADY_PRESENT,\n-  FST_ERR_SCH_DUPLICATE\n+  FST_ERR_SCH_DUPLICATE,\n+  FST_ERR_SCH_CONTENT_MISSING_SCHEMA\n } = require('./errors')\n \n const SCHEMAS_SOURCE = ['params', 'body', 'querystring', 'query', 'headers']\n@@ -22,7 +23,7 @@\n     : inputSchema\n   )\n \n-  // devs can add schemas without $id, but with $def instead\n+  // developers can add schemas without $id, but with $def instead\n   const id = schema.$id\n   if (!id) {\n     throw new FST_ERR_SCH_MISSING_ID()\n@@ -43,6 +44,16 @@\n   return this.store[schemaId]\n }\n \n+/**\n+ * Checks whether a schema is a non-plain object.\n+ *\n+ * @param {*} schema the schema to check\n+ * @returns {boolean} true if schema has a custom prototype\n+ */\n+function isCustomSchemaPrototype (schema) {\n+  return typeof schema === 'object' && Object.getPrototypeOf(schema) !== Object.prototype\n+}\n+\n function normalizeSchema (routeSchemas, serverOptions) {\n   if (routeSchemas[kSchemaVisited]) {\n     return routeSchemas\n@@ -59,33 +70,42 @@\n \n   generateFluentSchema(routeSchemas)\n \n-  // let's check if our schemas have a custom prototype\n-  for (const key of ['headers', 'querystring', 'params', 'body']) {\n-    if (typeof routeSchemas[key] === 'object' && Object.getPrototypeOf(routeSchemas[key]) !== Object.prototype) {\n-      return routeSchemas\n+  for (const key of SCHEMAS_SOURCE) {\n+    const schema = routeSchemas[key]\n+    if (schema && !isCustomSchemaPrototype(schema)) {\n+      if (key === 'body' && schema.content) {\n+        const contentProperty = schema.content\n+        const keys = Object.keys(contentProperty)\n+        for (let i = 0; i < keys.length; i++) {\n+          const contentType = keys[i]\n+          const contentSchema = contentProperty[contentType].schema\n+          if (!contentSchema) {\n+            throw new FST_ERR_SCH_CONTENT_MISSING_SCHEMA(contentType)\n+          }\n+        }\n+        continue\n+      }\n     }\n   }\n \n-  if (routeSchemas.body) {\n-    routeSchemas.body = getSchemaAnyway(routeSchemas.body, serverOptions.jsonShorthand)\n-  }\n-\n-  if (routeSchemas.headers) {\n-    routeSchemas.headers = getSchemaAnyway(routeSchemas.headers, serverOptions.jsonShorthand)\n-  }\n-\n-  if (routeSchemas.querystring) {\n-    routeSchemas.querystring = getSchemaAnyway(routeSchemas.querystring, serverOptions.jsonShorthand)\n-  }\n-\n-  if (routeSchemas.params) {\n-    routeSchemas.params = getSchemaAnyway(routeSchemas.params, serverOptions.jsonShorthand)\n-  }\n-\n   if (routeSchemas.response) {\n     const httpCodes = Object.keys(routeSchemas.response)\n     for (const code of httpCodes) {\n-      routeSchemas.response[code] = getSchemaAnyway(routeSchemas.response[code], serverOptions.jsonShorthand)\n+      if (isCustomSchemaPrototype(routeSchemas.response[code])) {\n+        continue\n+      }\n+\n+      const contentProperty = routeSchemas.response[code].content\n+\n+      if (contentProperty) {\n+        const keys = Object.keys(contentProperty)\n+        for (let i = 0; i < keys.length; i++) {\n+          const mediaName = keys[i]\n+          if (!contentProperty[mediaName].schema) {\n+            throw new FST_ERR_SCH_CONTENT_MISSING_SCHEMA(mediaName)\n+          }\n+        }\n+      }\n     }\n",
					"match": false,
					"packageHash": "5691eb0da2ab6e0bf00ba92e884e1812e99235f73cdfd52b254b32e447bbe646",
					"size": 4490,
					"sourceHash": "f39b1ff4213f875bc00130dc5cf9d6940ff9802e4e6f2b06c0d4aab0aee9f213",
					"status": "content"
				},
				"lib/server.js": {
					"diff": "--- published/lib/server.js\n+++ rebuilt/lib/server.js\n@@ -1,45 +1,62 @@\n 'use strict'\n \n-const http = require('http')\n-const https = require('https')\n-const dns = require('dns')\n-\n-const warnings = require('./warnings')\n-const { kState, kOptions, kServerBindings } = require('./symbols')\n-const { FST_ERR_HTTP2_INVALID_VERSION, FST_ERR_REOPENED_CLOSE_SERVER, FST_ERR_REOPENED_SERVER } = require('./errors')\n+const http = require('node:http')\n+const https = require('node:https')\n+const http2 = require('node:http2')\n+const dns = require('node:dns')\n+const os = require('node:os')\n+\n+const { kState, kOptions, kServerBindings, kHttp2ServerSessions } = require('./symbols')\n+const { FSTWRN003 } = require('./warnings')\n+const { onListenHookRunner } = require('./hooks')\n+const {\n+  FST_ERR_REOPENED_CLOSE_SERVER,\n+  FST_ERR_REOPENED_SERVER,\n+  FST_ERR_LISTEN_OPTIONS_INVALID,\n+  FST_ERR_FORCE_CLOSE_CONNECTIONS_IDLE_NOT_AVAILABLE\n+} = require('./errors')\n+const noopSet = require('./noop-set')\n+const PonyPromise = require('./promise')\n \n module.exports.createServer = createServer\n-module.exports.compileValidateHTTPVersion = compileValidateHTTPVersion\n+\n+function defaultResolveServerListeningText (address) {\n+  return `Server listening at ${address}`\n+}\n \n function createServer (options, httpHandler) {\n   const server = getServerInstance(options, httpHandler)\n \n-  return { server, listen }\n-\n   // `this` is the Fastify object\n-  function listen (listenOptions, ...args) {\n-    let cb = args.slice(-1).pop()\n-    // When the variadic signature deprecation is complete, the function\n-    // declaration should become:\n-    //   function listen (listenOptions = { port: 0, host: 'localhost' }, cb = undefined)\n-    // Upon doing so, the `normalizeListenArgs` function is no longer needed,\n-    // and all of this preamble to feed it correctly also no longer needed.\n-    const firstArgType = Object.prototype.toString.call(arguments[0])\n-    if (arguments.length === 0) {\n-      listenOptions = normalizeListenArgs([])\n-    } else if (arguments.length > 0 && (firstArgType !== '[object Object]' && firstArgType !== '[object Function]')) {\n-      warnings.emit('FSTDEP011')\n-      listenOptions = normalizeListenArgs(Array.from(arguments))\n-      cb = listenOptions.cb\n-    } else if (args.length > 1) {\n-      // `.listen(obj, a, ..., n, callback )`\n-      warnings.emit('FSTDEP011')\n-      // Deal with `.listen(port, host, backlog, [cb])`\n-      const hostPath = listenOptions.path ? [listenOptions.path] : [listenOptions.port ?? 0, listenOptions.host ?? 'localhost']\n-      Object.assign(listenOptions, normalizeListenArgs([...hostPath, ...args]))\n-    } else {\n+  function listen (\n+    listenOptions = { port: 0, host: 'localhost' },\n+    cb = undefined\n+  ) {\n+    if (typeof cb === 'function') {\n+      if (cb.constructor.name === 'AsyncFunction') {\n+        FSTWRN003('listen method')\n+      }\n+\n       listenOptions.cb = cb\n     }\n+    if (listenOptions.signal) {\n+      if (typeof listenOptions.signal.on !== 'function' && typeof listenOptions.signal.addEventListener !== 'function') {\n+        throw new FST_ERR_LISTEN_OPTIONS_INVALID('Invalid options.signal')\n+      }\n+\n+      // copy the current signal state\n+      this[kState].aborted = listenOptions.signal.aborted\n+\n+      if (this[kState].aborted) {\n+        return this.close()\n+      } else {\n+        const onAborted = () => {\n+          this[kState].aborted = true\n+          this.close()\n+        }\n+        listenOptions.signal.addEventListener('abort', onAborted, { once: true })\n+      }\n+    }\n \n     // If we have a path specified, don't default host to 'localhost' so we don't end up listening\n     // on both path and host\n@@ -50,10 +67,10 @@\n     } else {\n       host = listenOptions.host\n     }\n",
					"match": false,
					"packageHash": "2a3a4f0cc0eb5377c8738b78371d298c901faa71d4bf4db7d4237c2e832b0271",
					"size": 12126,
					"sourceHash": "514f454d947a1d33668d403876fe45acff5e4da245f8f90748ab64d7a8699a54",
					"status": "content"
				},
				"lib/symbols.js": {
					"diff": "--- published/lib/symbols.js\n+++ rebuilt/lib/symbols.js\n@@ -5,6 +5,7 @@\n   kChildren: Symbol('fastify.children'),\n   kServerBindings: Symbol('fastify.serverBindings'),\n   kBodyLimit: Symbol('fastify.bodyLimit'),\n+  kSupportedHTTPMethods: Symbol('fastify.acceptedHTTPMethods'),\n   kRoutePrefix: Symbol('fastify.routePrefix'),\n   kLogLevel: Symbol('fastify.logLevel'),\n   kLogSerializers: Symbol('fastify.logSerializers'),\n@@ -14,6 +15,9 @@\n   kOptions: Symbol('fastify.options'),\n   kDisableRequestLogging: Symbol('fastify.disableRequestLogging'),\n   kPluginNameChain: Symbol('fastify.pluginNameChain'),\n+  kRouteContext: Symbol('fastify.context'),\n+  kGenReqId: Symbol('fastify.genReqId'),\n+  kHttp2ServerSessions: Symbol('fastify.http2ServerSessions'),\n   // Schema\n   kSchemaController: Symbol('fastify.schemaController'),\n   kSchemaHeaders: Symbol('headers-schema'),\n@@ -25,9 +29,10 @@\n   kSchemaVisited: Symbol('fastify.schemas.visited'),\n   // Request\n   kRequest: Symbol('fastify.Request'),\n-  kRequestValidateFns: Symbol('fastify.request.cache.validateFns'),\n   kRequestPayloadStream: Symbol('fastify.RequestPayloadStream'),\n   kRequestAcceptVersion: Symbol('fastify.RequestAcceptVersion'),\n+  kRequestCacheValidateFns: Symbol('fastify.request.cache.validateFns'),\n+  kRequestOriginalUrl: Symbol('fastify.request.originalUrl'),\n   // 404\n   kFourOhFour: Symbol('fastify.404'),\n   kCanSetNotFoundHandler: Symbol('fastify.canSetNotFoundHandler'),\n@@ -48,10 +53,12 @@\n   kReplyErrorHandlerCalled: Symbol('fastify.reply.errorHandlerCalled'),\n   kReplyIsRunningOnErrorHook: Symbol('fastify.reply.isRunningOnErrorHook'),\n   kReplySerializerDefault: Symbol('fastify.replySerializerDefault'),\n-  kReplySerializeWeakMap: Symbol('fastify.reply.cache.serializeFns'),\n+  kReplyCacheSerializeFns: Symbol('fastify.reply.cache.serializeFns'),\n   // This symbol is only meant to be used for fastify tests and should not be used for any other purpose\n   kTestInternals: Symbol('fastify.testInternals'),\n   kErrorHandler: Symbol('fastify.errorHandler'),\n+  kErrorHandlerAlreadySet: Symbol('fastify.errorHandlerAlreadySet'),\n+  kChildLoggerFactory: Symbol('fastify.childLoggerFactory'),\n   kHasBeenDecorated: Symbol('fastify.hasBeenDecorated'),\n   kKeepAliveConnections: Symbol('fastify.keepAliveConnections'),\n   kRouteByFastify: Symbol('fastify.routeByFastify')\n",
					"match": false,
					"packageHash": "af03e211af08edeace4ae425180978c3779029cfb48757543ac8d92bec10f8c5",
					"size": 2823,
					"sourceHash": "b6ffb17de3ea8fb2f43db68ccbf0157728ba977fabd34ea6b8219583da042afd",
					"status": "content"
				},
				"lib/validation.js": {
					"diff": "--- published/lib/validation.js\n+++ rebuilt/lib/validation.js\n@@ -7,7 +7,13 @@\n   kSchemaBody: bodySchema,\n   kSchemaResponse: responseSchema\n } = require('./symbols')\n-const scChecker = /^[1-5]{1}[0-9]{2}$|^[1-5]xx$|^default$/\n+const scChecker = /^[1-5](?:\\d{2}|xx)$|^default$/\n+\n+const {\n+  FST_ERR_SCH_RESPONSE_SCHEMA_NOT_NESTED_2XX\n+} = require('./errors')\n+\n+const { FSTWRN001 } = require('./warnings')\n \n function compileSchemasForSerialization (context, compile) {\n   if (!context.schema || !context.schema.response) {\n@@ -18,21 +24,37 @@\n     .reduce(function (acc, statusCode) {\n       const schema = context.schema.response[statusCode]\n       statusCode = statusCode.toLowerCase()\n-      if (!scChecker.exec(statusCode)) {\n-        throw new Error('response schemas should be nested under a valid status code, e.g { 2xx: { type: \"object\" } }')\n+      if (!scChecker.test(statusCode)) {\n+        throw new FST_ERR_SCH_RESPONSE_SCHEMA_NOT_NESTED_2XX()\n+      }\n+\n+      if (schema.content) {\n+        const contentTypesSchemas = {}\n+        for (const mediaName of Object.keys(schema.content)) {\n+          const contentSchema = schema.content[mediaName].schema\n+          contentTypesSchemas[mediaName] = compile({\n+            schema: contentSchema,\n+            url,\n+            method,\n+            httpStatus: statusCode,\n+            contentType: mediaName\n+          })\n+        }\n+        acc[statusCode] = contentTypesSchemas\n+      } else {\n+        acc[statusCode] = compile({\n+          schema,\n+          url,\n+          method,\n+          httpStatus: statusCode\n+        })\n       }\n \n-      acc[statusCode] = compile({\n-        schema,\n-        url,\n-        method,\n-        httpStatus: statusCode\n-      })\n       return acc\n     }, {})\n }\n \n-function compileSchemasForValidation (context, compile) {\n+function compileSchemasForValidation (context, compile, isCustom) {\n   const { schema } = context\n   if (!schema) {\n     return\n@@ -41,12 +63,13 @@\n   const { method, url } = context.config || {}\n \n   const headers = schema.headers\n-  if (headers && Object.getPrototypeOf(headers) !== Object.prototype) {\n-    // do not mess with non-literals, e.g. Joi schemas\n+  // the or part is used for backward compatibility\n+  if (headers && (isCustom || Object.getPrototypeOf(headers) !== Object.prototype)) {\n+    // do not mess with schema when custom validator applied, e.g. Joi, Typebox\n     context[headersSchema] = compile({ schema: headers, method, url, httpPart: 'headers' })\n   } else if (headers) {\n     // The header keys are case insensitive\n-    //  https://tools.ietf.org/html/rfc2616#section-4.2\n+    //  https://datatracker.ietf.org/doc/html/rfc2616#section-4.2\n     const headersSchemaLowerCase = {}\n     Object.keys(headers).forEach(k => { headersSchemaLowerCase[k] = headers[k] })\n     if (headersSchemaLowerCase.required instanceof Array) {\n@@ -59,65 +82,196 @@\n       })\n     }\n     context[headersSchema] = compile({ schema: headersSchemaLowerCase, method, url, httpPart: 'headers' })\n+  } else if (Object.hasOwn(schema, 'headers')) {\n+    FSTWRN001('headers', method, url)\n   }\n \n   if (schema.body) {\n-    context[bodySchema] = compile({ schema: schema.body, method, url, httpPart: 'body' })\n+    const contentProperty = schema.body.content\n+    if (contentProperty) {\n+      const contentTypeSchemas = {}\n+      for (const contentType of Object.keys(contentProperty)) {\n+        const contentSchema = contentProperty[contentType].schema\n+        contentTypeSchemas[contentType] = compile({ schema: contentSchema, method, url, httpPart: 'body', contentType })\n+      }\n+      context[bodySchema] = contentTypeSchemas\n+    } else {\n",
					"match": false,
					"packageHash": "de807c23c32aa0c81c4b03d74b71fe7a074856ebe66362c122c6ace1e7c7e003",
					"size": 4266,
					"sourceHash": "55946b6af37728d8dc07ba6b305fe5782e893b54289cad7a965910ed9fe08790",
					"status": "content"
				},
				"lib/warnings.js": {
					"diff": "--- published/lib/warnings.js\n+++ rebuilt/lib/warnings.js\n@@ -1,24 +1,57 @@\n 'use strict'\n \n-const warning = require('process-warning')()\n+const { createWarning } = require('process-warning')\n \n /**\n  * Deprecation codes:\n- *   - FSTDEP005\n+ *   - FSTWRN001\n+ *   - FSTSEC001\n+ *   - FSTDEP022\n+ *\n+ * Deprecation Codes FSTDEP001 - FSTDEP021 were used by v4 and MUST NOT not be reused.\n+ *                             - FSTDEP022 is used by v5 and MUST NOT be reused.\n+ * Warning Codes FSTWRN001 - FSTWRN002 were used by v4 and MUST NOT not be reused.\n  */\n \n-warning.create('FastifyDeprecation', 'FSTDEP005', 'You are accessing the deprecated \"request.connection\" property. Use \"request.socket\" instead.')\n-\n-warning.create('FastifyDeprecation', 'FSTDEP006', 'You are decorating Request/Reply with a reference type. This reference is shared amongst all requests. Use onRequest hook instead. Property: %s')\n-\n-warning.create('FastifyDeprecation', 'FSTDEP007', 'You are trying to set a HEAD route using \"exposeHeadRoute\" route flag when a sibling route is already set. See documentation for more info.')\n-\n-warning.create('FastifyDeprecation', 'FSTDEP008', 'You are using route constraints via the route { version: \"...\" } option, use { constraints: { version: \"...\" } } option instead.')\n-\n-warning.create('FastifyDeprecation', 'FSTDEP009', 'You are using a custom route versioning strategy via the server { versioning: \"...\" } option, use { constraints: { version: \"...\" } } option instead.')\n-\n-warning.create('FastifyDeprecation', 'FSTDEP010', 'Modifying the \"reply.sent\" property is deprecated. Use the \"reply.hijack()\" method instead.')\n-\n-warning.create('FastifyDeprecation', 'FSTDEP011', 'Variadic listen method is deprecated. Please use \".listen(optionsObject)\" instead. The variadic signature will be removed in `fastify@5`.')\n-\n-module.exports = warning\n+const FSTWRN001 = createWarning({\n+  name: 'FastifyWarning',\n+  code: 'FSTWRN001',\n+  message: 'The %s schema for %s: %s is missing. This may indicate the schema is not well specified.',\n+  unlimited: true\n+})\n+\n+const FSTWRN003 = createWarning({\n+  name: 'FastifyWarning',\n+  code: 'FSTWRN003',\n+  message: 'The %s mixes async and callback styles that may lead to unhandled rejections. Please use only one of them.',\n+  unlimited: true\n+})\n+\n+const FSTWRN004 = createWarning({\n+  name: 'FastifyWarning',\n+  code: 'FSTWRN004',\n+  message: 'It seems that you are overriding an errorHandler in the same scope, which can lead to subtle bugs.',\n+  unlimited: true\n+})\n+\n+const FSTSEC001 = createWarning({\n+  name: 'FastifySecurity',\n+  code: 'FSTSEC001',\n+  message: 'You are using /%s/ Content-Type which may be vulnerable to CORS attack. Please make sure your RegExp start with \"^\" or include \";?\" to proper detection of the essence MIME type.',\n+  unlimited: true\n+})\n+\n+const FSTDEP022 = createWarning({\n+  name: 'FastifyWarning',\n+  code: 'FSTDEP022',\n+  message: 'The router options for %s property access is deprecated. Please use \"options.routerOptions\" instead for accessing router options. The router options will be removed in `fastify@6`.',\n+  unlimited: true\n+})\n+\n+module.exports = {\n+  FSTWRN001,\n+  FSTWRN003,\n+  FSTWRN004,\n+  FSTSEC001,\n+  FSTDEP022\n+}\n",
					"match": false,
					"packageHash": "e3d83c127af635f7b69c74bfeca4f9708417b10c84291c3c55a4cc0b467ae019",
					"size": 1398,
					"sourceHash": "d84e54b88216649fcb9bef62db53fae5b27eca5b8ba3fe35fbb3c423047c8784",
					"status": "content"
				},
				"lib/wrapThenable.js": {
					"match": false,
					"packageHash": "2c1f077e0914cebc45f1d193c2ad61cf2fe623b03cfef59dbd60528117113bb0",
					"size": 1257,
					"status": "missing-in-source"
				},
				"package.json": {
					"diff": "--- published/package.json\n+++ rebuilt/package.json\n@@ -1,31 +1,33 @@\n {\n   \"name\": \"fastify\",\n-  \"version\": \"4.5.2\",\n+  \"version\": \"5.6.2\",\n   \"description\": \"Fast and low overhead web framework, for Node.js\",\n   \"main\": \"fastify.js\",\n   \"type\": \"commonjs\",\n   \"types\": \"fastify.d.ts\",\n   \"scripts\": {\n     \"bench\": \"branchcmp -r 2 -g -s \\\"npm run benchmark\\\"\",\n-    \"benchmark\": \"npx concurrently -k -s first \\\"node ./examples/benchmark/simple.js\\\" \\\"npx autocannon -c 100 -d 30 -p 10 localhost:3000/\\\"\",\n-    \"coverage\": \"npm run unit -- --cov --coverage-report=html\",\n-    \"coverage:ci\": \"npm run unit -- --cov --coverage-report=html --no-browser --no-check-coverage -R terse\",\n-    \"coverage:ci-check-coverage\": \"nyc check-coverage --branches 100 --functions 100 --lines 100 --statements 100\",\n-    \"license-checker\": \"license-checker --production --onlyAllow=\\\"MIT;ISC;BSD-3-Clause;BSD-2-Clause\\\"\",\n-    \"lint\": \"npm run lint:standard && npm run lint:typescript && npm run lint:markdown\",\n-    \"lint:fix\": \"standard --fix\",\n+    \"benchmark\": \"concurrently -k -s first \\\"node ./examples/benchmark/simple.js\\\" \\\"autocannon -c 100 -d 30 -p 10 localhost:3000/\\\"\",\n+    \"benchmark:parser\": \"concurrently -k -s first \\\"node ./examples/benchmark/parser.js\\\" \\\"autocannon -c 100 -d 30 -p 10 -i ./examples/benchmark/body.json -H \\\"content-type:application/jsoff\\\" -m POST localhost:3000/\\\"\",\n+    \"benchmark:parser:error\": \"concurrently -k -s first \\\"node ./examples/benchmark/parser.js\\\" \\\"autocannon -c 100 -d 30 -p 10 -i ./examples/benchmark/body.json -H \\\"content-type:application/jsoff\\\" -H \\\"content-length:123\\\" -m POST localhost:3000/\\\"\",\n+    \"build:validation\": \"node build/build-error-serializer.js && node build/build-validation.js\",\n+    \"build:sync-version\": \"node build/sync-version.js\",\n+    \"coverage\": \"c8 --reporter html borp --reporter=@jsumners/line-reporter --coverage --check-coverage --lines 100 \",\n+    \"coverage:ci-check-coverage\": \"borp --reporter=@jsumners/line-reporter --coverage --check-coverage --lines 100\",\n+    \"lint\": \"npm run lint:eslint\",\n+    \"lint:fix\": \"eslint --fix\",\n     \"lint:markdown\": \"markdownlint-cli2\",\n-    \"lint:standard\": \"standard | snazzy\",\n-    \"lint:typescript\": \"eslint -c types/.eslintrc.json types/**/*.d.ts test/types/**/*.test-d.ts\",\n-    \"prepublishOnly\": \"PREPUBLISH=true tap --no-check-coverage test/build/**.test.js\",\n+    \"lint:eslint\": \"eslint\",\n+    \"prepublishOnly\": \"cross-env PREPUBLISH=true borp --reporter=@jsumners/line-reporter && npm run test:validator:integrity && npm run build:sync-version\",\n     \"test\": \"npm run lint && npm run unit && npm run test:typescript\",\n-    \"test:ci\": \"npm run unit -- -R terse --cov --coverage-report=lcovonly && npm run test:typescript\",\n+    \"test:ci\": \"npm run unit && npm run test:typescript\",\n     \"test:report\": \"npm run lint && npm run unit:report && npm run test:typescript\",\n-    \"test:typescript\": \"tsc test/types/import.ts && tsd\",\n-    \"test:watch\": \"npm run unit -- -w --no-coverage-report -R terse\",\n-    \"unit\": \"tap\",\n-    \"unit:junit\": \"tap-mocha-reporter xunit < out.tap > test/junit-testresults.xml\",\n-    \"unit:report\": \"tap --cov --coverage-report=html --coverage-report=cobertura | tee out.tap\"\n+    \"test:validator:integrity\": \"npm run build:validation && git diff --quiet --ignore-all-space --ignore-blank-lines --ignore-cr-at-eol lib/error-serializer.js && git diff --quiet --ignore-all-space --ignore-blank-lines --ignore-cr-at-eol lib/config-validator.js\",\n+    \"test:typescript\": \"tsc test/types/import.ts --target es2022 --moduleResolution node16 --module node16 --noEmit && tsd\",\n+    \"test:watch\": \"npm run unit -- --watch --coverage-report=none --reporter=terse\",\n+    \"unit\": \"borp\",\n+    \"unit:report\": \"c8 --reporter html borp --reporter=@jsumners/line-reporter\",\n+    \"citgm\": \"borp --reporter=@jsumners/line-reporter --coverage --check-coverage --concurrency=1\"\n   },\n   \"repository\": {\n     \"type\": \"git\",\n@@ -117,84 +119,105 @@\n       \"name\": \"Luis Orbaiceta\",\n       \"email\": \"luisorbaiceta@gmail.com\",\n       \"url\": \"https://luisorbaiceta.com\"\n+    },\n+    {\n+      \"name\": \"Carlos Fuentes\",\n+      \"email\": \"me@metcoder.dev\",\n+      \"url\": \"https://metcoder.dev\"\n+    },\n+    {\n+      \"name\": \"Gürgün Dayıoğlu\",\n+      \"email\": \"hey@gurgun.day\",\n+      \"url\": \"https://heyhey.to/G\"\n+    },\n+    {\n+      \"name\": \"Aras Abbasi\",\n+      \"email\": \"aras.abbasi@gmail.com\"\n+    },\n+    {\n+      \"name\": \"Frazer Smith\",\n+      \"email\": \"frazer.dev@icloud.com\",\n+      \"url\": \"https://github.com/fdawgs\"\n+    },\n+    {\n+      \"name\": \"KaKa Ng\",\n+      \"email\": \"kaka@kakang.dev\",\n+      \"url\": \"https://github.com/climba03003\"\n+    },\n+    {\n+      \"name\": \"Jean Michelet\",\n+      \"email\": \"jean.antoine.michelet@gmail.com\",\n+      \"url\": \"https://github.com/jean-michelet\"\n     }\n   ],\n   \"license\": \"MIT\",\n   \"bugs\": {\n     \"url\": \"https://github.com/fastify/fastify/issues\"\n   },\n-  \"homepage\": \"https://www.fastify.io/\",\n+  \"homepage\": \"https://fastify.dev/\",\n+  \"funding\": [\n+    {\n+      \"type\": \"github\",\n+      \"url\": \"https://github.com/sponsors/fastify\"\n+    },\n+    {\n",
					"match": false,
					"packageHash": "f83c93ddaf63f8588cb5c9f6367fe7c7ee614e661cbd8fe933ae95bef0f6739e",
					"size": 6061,
					"sourceHash": "99c1612dd2d094b7c0e9d74972e5ae308b894de7a58fb5eea5768ce5340ae3c9",
					"status": "content"
				},
				"test/404s.test.js": {
					"diff": "--- published/test/404s.test.js\n+++ rebuilt/test/404s.test.js\n@@ -1,86 +1,75 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const fp = require('fastify-plugin')\n-const sget = require('simple-get').concat\n const errors = require('http-errors')\n const split = require('split2')\n const Fastify = require('..')\n+const { getServerUrl } = require('./helper')\n \n-function getUrl (app) {\n-  const { address, port } = app.server.address()\n-  if (address === '::1') {\n-    return `http://[${address}]:${port}`\n-  } else {\n-    return `http://${address}:${port}`\n-  }\n-}\n-\n-test('default 404', t => {\n+test('default 404', async t => {\n   t.plan(4)\n \n-  const test = t.test\n   const fastify = Fastify()\n \n   fastify.get('/', function (req, reply) {\n     reply.send({ hello: 'world' })\n   })\n \n-  t.teardown(fastify.close.bind(fastify))\n+  t.after(() => { fastify.close() })\n \n-  fastify.listen({ port: 0 }, err => {\n-    t.error(err)\n+  await fastify.listen({ port: 0 })\n \n-    test('unsupported method', t => {\n-      t.plan(3)\n-      sget({\n-        method: 'PUT',\n-        url: getUrl(fastify),\n-        body: {},\n-        json: true\n-      }, (err, response, body) => {\n-        t.error(err)\n-        t.equal(response.statusCode, 404)\n-        t.equal(response.headers['content-type'], 'application/json; charset=utf-8')\n-      })\n+  await t.test('unsupported method', async (t) => {\n+    t.plan(3)\n+    const result = await fetch(getServerUrl(fastify), {\n+      method: 'PUT'\n     })\n \n-    // Return 404 instead of 405 see https://github.com/fastify/fastify/pull/862 for discussion\n-    test('framework-unsupported method', t => {\n-      t.plan(3)\n-      sget({\n-        method: 'PROPFIND',\n-        url: getUrl(fastify),\n-        body: {},\n-        json: true\n-      }, (err, response, body) => {\n-        t.error(err)\n-        t.equal(response.statusCode, 404)\n-        t.equal(response.headers['content-type'], 'application/json; charset=utf-8')\n-      })\n+    t.assert.ok(!result.ok)\n+    t.assert.strictEqual(result.status, 404)\n+    t.assert.strictEqual(result.headers.get('content-type'), 'application/json; charset=utf-8')\n+  })\n+\n+  // Return 404 instead of 405 see https://github.com/fastify/fastify/pull/862 for discussion\n+  await t.test('framework-unsupported method', async (t) => {\n+    t.plan(3)\n+    const result = await fetch(getServerUrl(fastify), {\n+      method: 'PROPFIND'\n     })\n \n-    test('unsupported route', t => {\n-      t.plan(3)\n-      sget({\n-        method: 'GET',\n-        url: getUrl(fastify) + '/notSupported',\n-        body: {},\n-        json: true\n-      }, (err, response, body) => {\n-        t.error(err)\n-        t.equal(response.statusCode, 404)\n-        t.equal(response.headers['content-type'], 'application/json; charset=utf-8')\n-      })\n+    t.assert.ok(!result.ok)\n+    t.assert.strictEqual(result.status, 404)\n+    t.assert.strictEqual(result.headers.get('content-type'), 'application/json; charset=utf-8')\n",
					"match": false,
					"packageHash": "7808f592c3e32372d9c91e0995ef2a50ed7b2e9a5a002d3129ad7c3ab3c02ca3",
					"size": 48120,
					"sourceHash": "4569b18319c87eba6164bda8409f2cd1a418d9935d3474692bee26fe056d74cb",
					"status": "content"
				},
				"test/500s.test.js": {
					"diff": "--- published/test/500s.test.js\n+++ rebuilt/test/500s.test.js\n@@ -1,14 +1,15 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const Fastify = require('..')\n const symbols = require('../lib/symbols.js')\n+const { FastifyError } = require('@fastify/error')\n \n-test('default 500', t => {\n+test('default 500', (t, done) => {\n   t.plan(4)\n \n   const fastify = Fastify()\n+  t.after(() => fastify.close())\n \n   fastify.get('/', function (req, reply) {\n     reply.send(new Error('kaboom'))\n@@ -18,29 +19,119 @@\n     method: 'GET',\n     url: '/'\n   }, (err, res) => {\n-    t.error(err)\n-    t.equal(res.statusCode, 500)\n-    t.equal(res.headers['content-type'], 'application/json; charset=utf-8')\n-    t.same(JSON.parse(res.payload), {\n+    t.assert.ifError(err)\n+    t.assert.strictEqual(res.statusCode, 500)\n+    t.assert.strictEqual(res.headers['content-type'], 'application/json; charset=utf-8')\n+    t.assert.deepStrictEqual(JSON.parse(res.payload), {\n       error: 'Internal Server Error',\n       message: 'kaboom',\n       statusCode: 500\n     })\n+    done()\n+  })\n+})\n+\n+test('default 500 with non-error string', (t, done) => {\n+  t.plan(4)\n+\n+  const fastify = Fastify()\n+  t.after(() => fastify.close())\n+\n+  fastify.get('/', function (req, reply) {\n+    throw 'kaboom' // eslint-disable-line no-throw-literal\n+  })\n+\n+  fastify.inject({\n+    method: 'GET',\n+    url: '/'\n+  }, (err, res) => {\n+    t.assert.ifError(err)\n+    t.assert.strictEqual(res.statusCode, 500)\n+    t.assert.strictEqual(res.headers['content-type'], 'text/plain; charset=utf-8')\n+    t.assert.deepStrictEqual(res.payload, 'kaboom')\n+    done()\n+  })\n+})\n+\n+test('default 500 with non-error symbol', (t, done) => {\n+  t.plan(4)\n+\n+  const fastify = Fastify()\n+  t.after(() => fastify.close())\n+\n+  fastify.get('/', function (req, reply) {\n+    throw Symbol('error')\n+  })\n+\n+  fastify.inject({\n+    method: 'GET',\n+    url: '/'\n+  }, (err, res) => {\n+    t.assert.ifError(err)\n+    t.assert.strictEqual(res.statusCode, 500)\n+    t.assert.strictEqual(res.headers['content-type'], 'application/json; charset=utf-8')\n+    t.assert.deepStrictEqual(res.payload, '')\n+    done()\n+  })\n+})\n+\n+test('default 500 with non-error false', (t, done) => {\n+  t.plan(4)\n+\n+  const fastify = Fastify()\n+  t.after(() => fastify.close())\n+\n+  fastify.get('/', function (req, reply) {\n+    throw false // eslint-disable-line no-throw-literal\n+  })\n+\n+  fastify.inject({\n+    method: 'GET',\n+    url: '/'\n+  }, (err, res) => {\n+    t.assert.ifError(err)\n",
					"match": false,
					"packageHash": "6943a0167c6c8d84405a1aae9a657a2e45f38fd6f300c9308d96323d23bd48d4",
					"size": 3660,
					"sourceHash": "b0f6d4440cd3d6deb05c08663e4d18b3ca63e14cbe932d5c3fb8e1a6efa252b2",
					"status": "content"
				},
				"test/allowUnsafeRegex.test.js": {
					"match": false,
					"packageHash": "3aa0f9efc578631c7b355df0e342ac3e87ffeb2d2db7cc4f7f22f7d953216e98",
					"size": 2444,
					"status": "missing-in-source"
				},
				"test/als.test.js": {
					"diff": "--- published/test/als.test.js\n+++ rebuilt/test/als.test.js\n@@ -1,74 +1,65 @@\n 'use strict'\n \n-const { AsyncLocalStorage } = require('async_hooks')\n-const t = require('tap')\n+const { AsyncLocalStorage } = require('node:async_hooks')\n+const { test } = require('node:test')\n const Fastify = require('..')\n-const sget = require('simple-get').concat\n \n-if (!AsyncLocalStorage) {\n-  t.skip('AsyncLocalStorage not available, skipping test')\n-  process.exit(0)\n-}\n-\n-const storage = new AsyncLocalStorage()\n-const app = Fastify({ logger: false })\n-\n-let counter = 0\n-app.addHook('onRequest', (req, reply, next) => {\n-  const id = counter++\n-  storage.run({ id }, next)\n-})\n+test('Async Local Storage test', async (t) => {\n+  t.plan(12)\n+  if (!AsyncLocalStorage) {\n+    t.skip('AsyncLocalStorage not available, skipping test')\n+    process.exit(0)\n+  }\n+\n+  const storage = new AsyncLocalStorage()\n+  const app = Fastify({ logger: false })\n+\n+  t.after(() => app.close())\n+\n+  let counter = 0\n+  app.addHook('onRequest', (req, reply, next) => {\n+    const id = counter++\n+    storage.run({ id }, next)\n+  })\n \n-app.get('/', function (request, reply) {\n-  t.ok(storage.getStore())\n-  const id = storage.getStore().id\n-  reply.send({ id })\n-})\n+  app.get('/', function (request, reply) {\n+    t.assert.ok(storage.getStore())\n+    const id = storage.getStore().id\n+    reply.send({ id })\n+  })\n \n-app.post('/', function (request, reply) {\n-  t.ok(storage.getStore())\n-  const id = storage.getStore().id\n-  reply.send({ id })\n-})\n+  app.post('/', function (request, reply) {\n+    t.assert.ok(storage.getStore())\n+    const id = storage.getStore().id\n+    reply.send({ id })\n+  })\n \n-app.listen({ port: 0 }, function (err, address) {\n-  t.error(err)\n+  const fastifyServer = await app.listen({ port: 0 })\n \n-  sget({\n+  // First POST request\n+  const result1 = await fetch(fastifyServer, {\n     method: 'POST',\n-    url: 'http://localhost:' + app.server.address().port,\n-    body: {\n-      hello: 'world'\n-    },\n-    json: true\n-  }, (err, response, body) => {\n-    t.error(err)\n-    t.equal(response.statusCode, 200)\n-    t.same(body, { id: 0 })\n-\n-    sget({\n-      method: 'POST',\n-      url: 'http://localhost:' + app.server.address().port,\n-      body: {\n-        hello: 'world'\n-      },\n-      json: true\n-    }, (err, response, body) => {\n-      t.error(err)\n-      t.equal(response.statusCode, 200)\n-      t.same(body, { id: 1 })\n-\n-      sget({\n-        method: 'GET',\n-        url: 'http://localhost:' + app.server.address().port,\n-        json: true\n-      }, (err, response, body) => {\n",
					"match": false,
					"packageHash": "02ce84c2fc5f585733d9e103bc1d44eb0ea828d2836dc8bdeff56b6d67445a3b",
					"size": 1640,
					"sourceHash": "095a9302871e49310b2b0ff0b91270356a6d2570661bac261454c710776cf9ee",
					"status": "content"
				},
				"test/async-await.test.js": {
					"diff": "--- published/test/async-await.test.js\n+++ rebuilt/test/async-await.test.js\n@@ -1,13 +1,11 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n-const sget = require('simple-get').concat\n+const { test } = require('node:test')\n const Fastify = require('..')\n const split = require('split2')\n const pino = require('pino')\n-const statusCodes = require('http').STATUS_CODES\n-const sleep = ms => new Promise(resolve => setTimeout(resolve, ms))\n+const { sleep } = require('./helper')\n+const statusCodes = require('node:http').STATUS_CODES\n \n const opts = {\n   schema: {\n@@ -24,56 +22,89 @@\n   }\n }\n \n-test('async await', t => {\n-  t.plan(11)\n+const optsWithHostnameAndPort = {\n+  schema: {\n+    response: {\n+      '2xx': {\n+        type: 'object',\n+        properties: {\n+          hello: {\n+            type: 'string'\n+          },\n+          hostname: {\n+            type: 'string'\n+          },\n+          port: {\n+            type: 'string'\n+          }\n+        }\n+      }\n+    }\n+  }\n+}\n+test('async await', async t => {\n+  t.plan(15)\n   const fastify = Fastify()\n   try {\n     fastify.get('/', opts, async function awaitMyFunc (req, reply) {\n       await sleep(200)\n       return { hello: 'world' }\n     })\n-    t.pass()\n+    t.assert.ok(true)\n   } catch (e) {\n-    t.fail()\n+    t.assert.fail()\n   }\n \n   try {\n     fastify.get('/no-await', opts, async function (req, reply) {\n       return { hello: 'world' }\n     })\n-    t.pass()\n+    t.assert.ok(true)\n   } catch (e) {\n-    t.fail()\n+    t.assert.fail()\n   }\n \n-  fastify.listen({ port: 0 }, err => {\n-    t.error(err)\n-    t.teardown(() => { fastify.close() })\n-\n-    sget({\n-      method: 'GET',\n-      url: 'http://localhost:' + fastify.server.address().port\n-    }, (err, response, body) => {\n-      t.error(err)\n-      t.equal(response.statusCode, 200)\n-      t.equal(response.headers['content-length'], '' + body.length)\n-      t.same(JSON.parse(body), { hello: 'world' })\n+  try {\n+    fastify.get('/await/hostname_port', optsWithHostnameAndPort, async function awaitMyFunc (req, reply) {\n+      await sleep(200)\n+      return { hello: 'world', hostname: req.hostname, port: req.port }\n     })\n+    t.assert.ok(true)\n+  } catch (e) {\n+    t.assert.fail()\n+  }\n \n-    sget({\n-      method: 'GET',\n-      url: 'http://localhost:' + fastify.server.address().port + '/no-await'\n-    }, (err, response, body) => {\n-      t.error(err)\n-      t.equal(response.statusCode, 200)\n-      t.equal(response.headers['content-length'], '' + body.length)\n",
					"match": false,
					"packageHash": "8b676b2a047b795590c00931f4b6ba5c6889223d70cad5af75eed73dd802a2e8",
					"size": 14041,
					"sourceHash": "38871e4228212292ab202acba6c9e0a87185d321353b955cf354efd08589b738",
					"status": "content"
				},
				"test/bodyLimit.test.js": {
					"match": false,
					"packageHash": "cee8e09bdea2e91c8a376c97c39c04035a150cd95ea3a5639466dc70c48b8fb2",
					"size": 954,
					"status": "missing-in-source"
				},
				"test/build/error-serializer.test.js": {
					"diff": "--- published/test/build/error-serializer.test.js\n+++ rebuilt/test/build/error-serializer.test.js\n@@ -1,9 +1,9 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n-const fs = require('fs')\n-const path = require('path')\n+const { test } = require('node:test')\n+const fs = require('node:fs')\n+const path = require('node:path')\n+const { loadESLint } = require('eslint')\n \n const { code } = require('../../build/build-error-serializer')\n \n@@ -15,21 +15,22 @@\n   t.plan(1)\n \n   // standard is a esm, we import it like this\n-  const { default: standard } = await import('standard')\n-  const result = await standard.lintText(code)\n+  const Eslint = await loadESLint({ useFlatConfig: true })\n+  const eslint = new Eslint()\n+  const result = await eslint.lintText(code)\n \n   // if there are any invalid syntax\n   // fatal count will be greater than 0\n-  t.equal(result[0].fatalErrorCount, 0)\n+  t.assert.strictEqual(result[0].fatalErrorCount, 0)\n })\n \n-const isPrebublish = !!process.env.PREPUBLISH\n+const isPrepublish = !!process.env.PREPUBLISH\n \n-test('ensure the current error serializer is latest', { skip: !isPrebublish }, async (t) => {\n+test('ensure the current error serializer is latest', { skip: !isPrepublish }, async (t) => {\n   t.plan(1)\n \n   const current = await fs.promises.readFile(path.resolve('lib/error-serializer.js'))\n \n   // line break should not be a problem depends on system\n-  t.equal(unifyLineBreak(current), unifyLineBreak(code))\n+  t.assert.strictEqual(unifyLineBreak(current), unifyLineBreak(code))\n })\n",
					"match": false,
					"packageHash": "06adfb3150a575f74831c514a4dce4be8a43a842a4bbe82985a91586467d7efa",
					"size": 956,
					"sourceHash": "889bca3be99a8dab3e370b23b168e0ebfcc4acefdfd5f38ea1db04d2cf8821a5",
					"status": "content"
				},
				"test/build/version.test.js": {
					"diff": "--- published/test/build/version.test.js\n+++ rebuilt/test/build/version.test.js\n@@ -1,9 +1,8 @@\n 'use strict'\n \n-const fs = require('fs')\n-const path = require('path')\n-const t = require('tap')\n-const test = t.test\n+const fs = require('node:fs')\n+const path = require('node:path')\n+const { test } = require('node:test')\n const fastify = require('../../fastify')()\n \n test('should be the same as package.json', t => {\n@@ -11,5 +10,5 @@\n \n   const json = JSON.parse(fs.readFileSync(path.join(__dirname, '..', '..', 'package.json')).toString('utf8'))\n \n-  t.equal(fastify.version, json.version)\n+  t.assert.strictEqual(fastify.version, json.version)\n })\n",
					"match": false,
					"packageHash": "d2b2f6285aa2893d02bb2fb7973dc3c322c18f1561a0f3e9fff8fac72e4ab76c",
					"size": 375,
					"sourceHash": "4f51483abb3a013ced4746b36c8892ed82c3e0cee074099b6ed68a6255c7aed8",
					"status": "content"
				},
				"test/build-certificate.js": {
					"diff": "--- published/test/build-certificate.js\n+++ rebuilt/test/build-certificate.js\n@@ -1,8 +1,97 @@\n 'use strict'\n \n-const selfCert = require('self-cert')\n+const os = require('node:os')\n+const forge = require('node-forge')\n \n-async function buildCertificate () {\n+// from self-cert module\n+function selfCert (opts) {\n+  const options = opts || {}\n+  const log = opts.logger || require('abstract-logging')\n+  const now = new Date()\n+\n+  if (!options.attrs) options.attrs = {}\n+  if (!options.expires) {\n+    options.expires = new Date(\n+      now.getFullYear() + 5, now.getMonth() + 1, now.getDate()\n+    )\n+  }\n+\n+  log.debug('generating key pair')\n+  const keys = forge.pki.rsa.generateKeyPair(options.bits || 2048)\n+  log.debug('key pair generated')\n+\n+  log.debug('generating self-signed certificate')\n+  const cert = forge.pki.createCertificate()\n+  cert.publicKey = keys.publicKey\n+  cert.serialNumber = '01'\n+  cert.validity.notBefore = now\n+  cert.validity.notAfter = options.expires\n+\n+  const attrs = [\n+    { name: 'commonName', value: options.attrs.commonName || os.hostname() },\n+    { name: 'countryName', value: options.attrs.countryName || 'US' },\n+    { name: 'stateOrProvinceName', value: options.attrs.stateName || 'Georgia' },\n+    { name: 'localityName', value: options.attrs.locality || 'Atlanta' },\n+    { name: 'organizationName', value: options.attrs.orgName || 'None' },\n+    { shortName: 'OU', value: options.attrs.shortName || 'example' }\n+  ]\n+  cert.setSubject(attrs)\n+  cert.setIssuer(attrs)\n+\n+  cert.setExtensions([\n+    { name: 'basicConstraints', cA: true },\n+    {\n+      name: 'keyUsage',\n+      keyCertSign: true,\n+      digitalSignature: true,\n+      nonRepudiation: true,\n+      keyEncipherment: true,\n+      dataEncipherment: true\n+    },\n+    {\n+      name: 'extKeyUsage',\n+      serverAuth: true,\n+      clientAuth: true,\n+      codeSigning: true,\n+      emailProtection: true,\n+      timeStamping: true\n+    },\n+    {\n+      name: 'nsCertType',\n+      client: true,\n+      server: true,\n+      email: true,\n+      objsign: true,\n+      sslCA: true,\n+      emailCA: true,\n+      objCA: true\n+    },\n+    { name: 'subjectKeyIdentifier' },\n+    {\n+      name: 'subjectAltName',\n+      altNames: [{ type: 6 /* URI */, value: 'DNS: ' + attrs[0].value }].concat((function () {\n+        const interfaces = os.networkInterfaces()\n+\n+        // fix citgm: skip invalid ips (aix72-ppc64)\n+        const ips = Object.values(interfaces).flat()\n+          .filter(i => !!forge.util.bytesFromIP(i.address))\n+          .map(i => ({ type: 7 /* IP */, ip: i.address }))\n+\n+        return ips\n+      }()))\n+    }\n+  ])\n+\n+  cert.sign(keys.privateKey)\n+  log.debug('certificate generated')\n+  return {\n+    privateKey: forge.pki.privateKeyToPem(keys.privateKey),\n+    publicKey: forge.pki.publicKeyToPem(keys.publicKey),\n+    certificate: forge.pki.certificateToPem(cert)\n+  }\n+}\n+\n+function buildCertificate () {\n   // \"global\" is used in here because \"t.context\" is only supported by \"t.beforeEach\" and \"t.afterEach\"\n",
					"match": false,
					"packageHash": "06e2743bd57c62cd989c060f3a5312c028662b8bee5cd4f82c9d3d33ef1845f1",
					"size": 617,
					"sourceHash": "13af6cb71dd2ef6e033c5bc2bb0bbd5544b0f3eee086a79b1adffd265c1f6187",
					"status": "content"
				},
				"test/bundler/README.md": {
					"diff": "--- published/test/bundler/README.md\n+++ rebuilt/test/bundler/README.md\n@@ -1,12 +1,12 @@\n # Bundlers test stack\n \n-In some cases, developers bundle their apps for several targets such as serverless applications. \n-Even if it's not recommended by Fastify team; we need to ensure we do not break the build process. \n+In some cases, developers bundle their apps for several targets such as serverless applications.\n+Even if it's not recommended by Fastify team; we need to ensure we do not break the build process.\n Please note this might result in features behaving differently, like the version handling check for plugins.\n \n ## Test bundlers\n \n-The bundler test stack has been defined separately from the rest of the Unit testing stack because it's not a \n+The bundler test stack has been defined separately from the rest of the Unit testing stack because it's not a\n part of the fastify lib itself. Note that the tests run in CI only on NodeJs LTS version.\n Developers do not need to install every bundler to run unit tests.\n \n@@ -23,7 +23,7 @@\n \n ## Bundler test development\n \n-To not break the fastify unit testing stack please name test files like this `*-test.js` and not `*.test.js`, \n+To not break the fastify unit testing stack please name test files like this `*-test.js` and not `*.test.js`,\n otherwise it will be targeted by the regular expression used for unit tests for fastify.\n-Tests need to ensure the build process works and the fastify application can be run, \n+Tests need to ensure the build process works and the fastify application can be run,\n no need to go in deep testing unless an issue is raised.\n",
					"match": false,
					"packageHash": "1a7418949d5e3912ab92219e4eef8f63c87e1ef194996fdcd2f343170206a942",
					"size": 1281,
					"sourceHash": "b1129c5870de50bdd1e909002e6f1cf30cbc57a765aabbe42fe20ab72155b7b7",
					"status": "content"
				},
				"test/bundler/esbuild/bundler-test.js": {
					"diff": "--- published/test/bundler/esbuild/bundler-test.js\n+++ rebuilt/test/bundler/esbuild/bundler-test.js\n@@ -1,31 +1,32 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const fastifySuccess = require('./dist/success')\n const fastifyFailPlugin = require('./dist/failPlugin')\n \n-test('Bundled package should work', (t) => {\n+test('Bundled package should work', (t, done) => {\n   t.plan(4)\n   fastifySuccess.ready((err) => {\n-    t.error(err)\n+    t.assert.ifError(err)\n     fastifySuccess.inject(\n       {\n         method: 'GET',\n         url: '/'\n       },\n       (error, res) => {\n-        t.error(error)\n-        t.equal(res.statusCode, 200)\n-        t.same(res.json(), { hello: 'world' })\n+        t.assert.ifError(error)\n+        t.assert.strictEqual(res.statusCode, 200)\n+        t.assert.deepStrictEqual(res.json(), { hello: 'world' })\n+        done()\n       }\n     )\n   })\n })\n \n-test('Bundled package should not work with bad plugin version', (t) => {\n+test('Bundled package should not work with bad plugin version', (t, done) => {\n   t.plan(1)\n   fastifyFailPlugin.ready((err) => {\n-    t.match(err.message, /expected '9.x' fastify version/i)\n+    t.assert.match(err.message, /expected '9.x' fastify version/i)\n+    done()\n   })\n })\n",
					"match": false,
					"packageHash": "0bfa92799f2f72b5de49410d63a0e3d09ce392b2d7c511f62733f21ea324f9e9",
					"size": 700,
					"sourceHash": "378d4925d6a6ff9de23aecd28bb049b75d3307a16aaf1f833967e0fe0054efc3",
					"status": "content"
				},
				"test/bundler/esbuild/package.json": {
					"diff": "--- published/test/bundler/esbuild/package.json\n+++ rebuilt/test/bundler/esbuild/package.json\n@@ -5,6 +5,6 @@\n     \"test\": \"npm run bundle && node bundler-test.js\"\n   },\n   \"devDependencies\": {\n-    \"esbuild\": \"^0.14.11\"\n+    \"esbuild\": \"^0.25.0\"\n   }\n }\n",
					"match": false,
					"packageHash": "fe3e13d605ad6b047db622a9acf7749a844d4fb5972d873387845b5dc8a9458b",
					"size": 276,
					"sourceHash": "11ed5a12f3ee1e92e68717f12deac16127edb39678999a1e0463e244de98ec54",
					"status": "content"
				},
				"test/bundler/esbuild/src/fail-plugin-version.js": {
					"diff": "--- published/test/bundler/esbuild/src/fail-plugin-version.js\n+++ rebuilt/test/bundler/esbuild/src/fail-plugin-version.js\n@@ -1,3 +1,5 @@\n+'use strict'\n+\n const fp = require('fastify-plugin')\n const fastify = require('../../../../')()\n \n",
					"match": false,
					"packageHash": "f3d678be9539054737e10208bbe01a7464a925b1d5975af515f0e249065a58ed",
					"size": 269,
					"sourceHash": "2a887601b6ab251bc8fbb0476f54f6d943b67a6e7db3a57e9b6c3e319654b49b",
					"status": "content"
				},
				"test/bundler/esbuild/src/index.js": {
					"diff": "--- published/test/bundler/esbuild/src/index.js\n+++ rebuilt/test/bundler/esbuild/src/index.js\n@@ -1,3 +1,5 @@\n+'use strict'\n+\n const fastify = require('../../../../')()\n // Declare a route\n fastify.get('/', function (request, reply) {\n",
					"match": false,
					"packageHash": "dab6bf5f1819b60dd1f219153229e848b4cb142791b4103527821405a20d2f89",
					"size": 168,
					"sourceHash": "2ad6c51bc41742dd886e9b5c0905273011fddb9559805f10cfc307f1f6ce6a78",
					"status": "content"
				},
				"test/bundler/webpack/bundler-test.js": {
					"diff": "--- published/test/bundler/webpack/bundler-test.js\n+++ rebuilt/test/bundler/webpack/bundler-test.js\n@@ -1,31 +1,32 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const fastifySuccess = require('./dist/success')\n const fastifyFailPlugin = require('./dist/failPlugin')\n \n-test('Bundled package should work', (t) => {\n+test('Bundled package should work', (t, done) => {\n   t.plan(4)\n   fastifySuccess.ready((err) => {\n-    t.error(err)\n+    t.assert.ifError(err)\n     fastifySuccess.inject(\n       {\n         method: 'GET',\n         url: '/'\n       },\n       (error, res) => {\n-        t.error(error)\n-        t.equal(res.statusCode, 200)\n-        t.same(res.json(), { hello: 'world' })\n+        t.assert.ifError(error)\n+        t.assert.strictEqual(res.statusCode, 200)\n+        t.assert.deepStrictEqual(res.json(), { hello: 'world' })\n+        done()\n       }\n     )\n   })\n })\n \n-test('Bundled package should not work with bad plugin version', (t) => {\n+test('Bundled package should not work with bad plugin version', (t, done) => {\n   t.plan(1)\n   fastifyFailPlugin.ready((err) => {\n-    t.match(err.message, /expected '9.x' fastify version/i)\n+    t.assert.match(err.message, /expected '9.x' fastify version/i)\n+    done()\n   })\n })\n",
					"match": false,
					"packageHash": "0bfa92799f2f72b5de49410d63a0e3d09ce392b2d7c511f62733f21ea324f9e9",
					"size": 700,
					"sourceHash": "378d4925d6a6ff9de23aecd28bb049b75d3307a16aaf1f833967e0fe0054efc3",
					"status": "content"
				},
				"test/bundler/webpack/src/fail-plugin-version.js": {
					"diff": "--- published/test/bundler/webpack/src/fail-plugin-version.js\n+++ rebuilt/test/bundler/webpack/src/fail-plugin-version.js\n@@ -1,3 +1,5 @@\n+'use strict'\n+\n const fp = require('fastify-plugin')\n const fastify = require('../../../../')()\n \n",
					"match": false,
					"packageHash": "f3d678be9539054737e10208bbe01a7464a925b1d5975af515f0e249065a58ed",
					"size": 269,
					"sourceHash": "2a887601b6ab251bc8fbb0476f54f6d943b67a6e7db3a57e9b6c3e319654b49b",
					"status": "content"
				},
				"test/bundler/webpack/src/index.js": {
					"diff": "--- published/test/bundler/webpack/src/index.js\n+++ rebuilt/test/bundler/webpack/src/index.js\n@@ -1,3 +1,5 @@\n+'use strict'\n+\n const fastify = require('../../../../')()\n // Declare a route\n fastify.get('/', function (request, reply) {\n",
					"match": false,
					"packageHash": "dab6bf5f1819b60dd1f219153229e848b4cb142791b4103527821405a20d2f89",
					"size": 168,
					"sourceHash": "2ad6c51bc41742dd886e9b5c0905273011fddb9559805f10cfc307f1f6ce6a78",
					"status": "content"
				},
				"test/bundler/webpack/webpack.config.js": {
					"diff": "--- published/test/bundler/webpack/webpack.config.js\n+++ rebuilt/test/bundler/webpack/webpack.config.js\n@@ -1,4 +1,6 @@\n-const path = require('path')\n+'use strict'\n+\n+const path = require('node:path')\n \n module.exports = {\n   entry: { success: './src/index.js', failPlugin: './src/fail-plugin-version.js' },\n",
					"match": false,
					"packageHash": "0c22e02f9b18d2fc56db903e1a281af0abb47a7dc0d0ce22aff8aa71f14061d3",
					"size": 284,
					"sourceHash": "4840a48193cc8765c6e52c805b25f78de7486a01198fff63c6e20d19b61ae02d",
					"status": "content"
				},
				"test/case-insensitive.test.js": {
					"diff": "--- published/test/case-insensitive.test.js\n+++ rebuilt/test/case-insensitive.test.js\n@@ -1,120 +1,102 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const Fastify = require('..')\n-const sget = require('simple-get').concat\n \n-test('case insensitive', t => {\n-  t.plan(4)\n+test('case insensitive', async (t) => {\n+  t.plan(3)\n \n   const fastify = Fastify({\n     caseSensitive: false\n   })\n-  t.teardown(fastify.close.bind(fastify))\n+  t.after(() => fastify.close())\n \n   fastify.get('/foo', (req, reply) => {\n     reply.send({ hello: 'world' })\n   })\n \n-  fastify.listen({ port: 0 }, err => {\n-    t.error(err)\n+  const fastifyServer = await fastify.listen({ port: 0 })\n+\n+  const result = await fetch(`${fastifyServer}/FOO`)\n \n-    sget({\n-      method: 'GET',\n-      url: 'http://localhost:' + fastify.server.address().port + '/FOO'\n-    }, (err, response, body) => {\n-      t.error(err)\n-      t.equal(response.statusCode, 200)\n-      t.same(JSON.parse(body), {\n-        hello: 'world'\n-      })\n-    })\n+  t.assert.ok(result.ok)\n+  t.assert.strictEqual(result.status, 200)\n+  t.assert.deepStrictEqual(await result.json(), {\n+    hello: 'world'\n   })\n })\n \n-test('case insensitive inject', t => {\n-  t.plan(4)\n+test('case insensitive inject', async t => {\n+  t.plan(2)\n \n   const fastify = Fastify({\n     caseSensitive: false\n   })\n-  t.teardown(fastify.close.bind(fastify))\n+  t.after(() => fastify.close())\n \n   fastify.get('/foo', (req, reply) => {\n     reply.send({ hello: 'world' })\n   })\n \n-  fastify.listen({ port: 0 }, err => {\n-    t.error(err)\n+  const fastifyServer = await fastify.listen({ port: 0 })\n+\n+  const result = await fastify.inject({\n+    method: 'GET',\n+    url: fastifyServer + '/FOO'\n+  })\n \n-    fastify.inject({\n-      method: 'GET',\n-      url: 'http://localhost:' + fastify.server.address().port + '/FOO'\n-    }, (err, response) => {\n-      t.error(err)\n-      t.equal(response.statusCode, 200)\n-      t.same(JSON.parse(response.payload), {\n-        hello: 'world'\n-      })\n-    })\n+  t.assert.strictEqual(result.statusCode, 200)\n+  t.assert.deepStrictEqual(result.json(), {\n+    hello: 'world'\n   })\n })\n \n-test('case insensitive (parametric)', t => {\n-  t.plan(5)\n+test('case insensitive (parametric)', async (t) => {\n+  t.plan(4)\n \n   const fastify = Fastify({\n     caseSensitive: false\n   })\n-  t.teardown(fastify.close.bind(fastify))\n+  t.after(() => fastify.close())\n \n",
					"match": false,
					"packageHash": "3c48d8d4f7df0ecfbb9b0d88201836ecfd69b4a010d068f97faf8f89cb8b8741",
					"size": 2524,
					"sourceHash": "bcb4776982cbbb3bd155f7ca9cb68078f14a4704e4ef8d43d7879180144a96f2",
					"status": "content"
				},
				"test/chainable.test.js": {
					"diff": "--- published/test/chainable.test.js\n+++ rebuilt/test/chainable.test.js\n@@ -1,7 +1,6 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const fastify = require('..')()\n \n const noop = () => {}\n@@ -22,17 +21,17 @@\n \n test('chainable - get', t => {\n   t.plan(1)\n-  t.type(fastify.get('/', opts, noop), fastify)\n+  t.assert.strictEqual(fastify.get('/', opts, noop), fastify)\n })\n \n test('chainable - post', t => {\n   t.plan(1)\n-  t.type(fastify.post('/', opts, noop), fastify)\n+  t.assert.strictEqual(fastify.post('/', opts, noop), fastify)\n })\n \n test('chainable - route', t => {\n   t.plan(1)\n-  t.type(fastify.route({\n+  t.assert.strictEqual(fastify.route({\n     method: 'GET',\n     url: '/other',\n     schema: opts.schema,\n",
					"match": false,
					"packageHash": "d06eb099ef3fa33507ee35833bc744eb7fcaaf493320f03f34ee0c86ec01cd90",
					"size": 668,
					"sourceHash": "8ed2aed4b61a53addc30fe27488534968e9d1fee3536db6b49c1e9177e9e5dac",
					"status": "content"
				},
				"test/close-pipelining.test.js": {
					"diff": "--- published/test/close-pipelining.test.js\n+++ rebuilt/test/close-pipelining.test.js\n@@ -1,74 +1,78 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const Fastify = require('..')\n const { Client } = require('undici')\n \n-test('Should return 503 while closing - pipelining', t => {\n+test('Should return 503 while closing - pipelining', async t => {\n   const fastify = Fastify({\n     return503OnClosing: true,\n     forceCloseConnections: false\n   })\n \n-  fastify.get('/', (req, reply) => {\n-    fastify.close()\n+  fastify.get('/', async (req, reply) => {\n+    // Simulate a delay to allow pipelining to kick in\n+    await new Promise(resolve => setTimeout(resolve, 5))\n     reply.send({ hello: 'world' })\n+    fastify.close()\n   })\n \n-  fastify.listen({ port: 0 }, async err => {\n-    t.error(err)\n+  await fastify.listen({ port: 0 })\n \n-    const instance = new Client('http://localhost:' + fastify.server.address().port, {\n-      pipelining: 1\n-    })\n-\n-    const codes = [200, 503]\n-    for (const code of codes) {\n-      instance.request(\n-        { path: '/', method: 'GET' }\n-      ).then(data => {\n-        t.equal(data.statusCode, code)\n-      }).catch((e) => {\n-        t.fail(e)\n-      })\n-    }\n-    instance.close(() => {\n-      t.end('Done')\n-    })\n+  const instance = new Client('http://localhost:' + fastify.server.address().port, {\n+    pipelining: 2\n   })\n+\n+  const [firstRequest, secondRequest, thirdRequest] = await Promise.allSettled([\n+    instance.request({ path: '/', method: 'GET', blocking: false }),\n+    instance.request({ path: '/', method: 'GET', blocking: false }),\n+    instance.request({ path: '/', method: 'GET', blocking: false })\n+  ])\n+  t.assert.strictEqual(firstRequest.status, 'fulfilled')\n+  t.assert.strictEqual(secondRequest.status, 'fulfilled')\n+\n+  t.assert.strictEqual(firstRequest.value.statusCode, 200)\n+  t.assert.strictEqual(secondRequest.value.statusCode, 200)\n+\n+  t.assert.strictEqual(thirdRequest.status, 'fulfilled')\n+  t.assert.strictEqual(thirdRequest.value.statusCode, 503)\n+\n+  await instance.close()\n })\n \n-test('Should not return 503 while closing - pipelining - return503OnClosing', t => {\n+test('Should close the socket abruptly - pipelining - return503OnClosing: false', async t => {\n+  // Since Node v20, we will always invoke server.closeIdleConnections()\n+  // therefore our socket will be closed\n   const fastify = Fastify({\n     return503OnClosing: false,\n     forceCloseConnections: false\n   })\n \n-  fastify.get('/', (req, reply) => {\n-    fastify.close()\n+  fastify.get('/', async (req, reply) => {\n+    // Simulate a delay to allow pipelining to kick in\n+    await new Promise(resolve => setTimeout(resolve, 5))\n     reply.send({ hello: 'world' })\n+    fastify.close()\n   })\n \n-  fastify.listen({ port: 0 }, err => {\n-    t.error(err)\n+  await fastify.listen({ port: 0 })\n \n-    const instance = new Client('http://localhost:' + fastify.server.address().port, {\n-      pipelining: 1\n-    })\n-\n-    const codes = [200, 200]\n-    for (const code of codes) {\n-      instance.request(\n-        { path: '/', method: 'GET' }\n-      ).then(data => {\n",
					"match": false,
					"packageHash": "b8095797072f335915bd360e2f0c1f9de2de52d991e8bfad5661e32ad6f6547c",
					"size": 1620,
					"sourceHash": "bee6405a84ba7d162b08d6abe354729e31688cd101d3af0674cd3f1e5602e044",
					"status": "content"
				},
				"test/close.test.js": {
					"diff": "--- published/test/close.test.js\n+++ rebuilt/test/close.test.js\n@@ -1,39 +1,44 @@\n 'use strict'\n \n-const net = require('net')\n-const http = require('http')\n-const t = require('tap')\n-const test = t.test\n+const net = require('node:net')\n+const http = require('node:http')\n+const { test } = require('node:test')\n const Fastify = require('..')\n const { Client } = require('undici')\n+const split = require('split2')\n+const { sleep } = require('./helper')\n \n-test('close callback', t => {\n-  t.plan(4)\n+test('close callback', (t, testDone) => {\n+  t.plan(7)\n   const fastify = Fastify()\n   fastify.addHook('onClose', onClose)\n   function onClose (instance, done) {\n-    t.type(fastify, instance)\n+    t.assert.ok(typeof fastify === typeof this)\n+    t.assert.ok(typeof fastify === typeof instance)\n+    t.assert.strictEqual(fastify, this)\n+    t.assert.strictEqual(fastify, instance)\n     done()\n   }\n \n   fastify.listen({ port: 0 }, err => {\n-    t.error(err)\n+    t.assert.ifError(err)\n \n     fastify.close((err) => {\n-      t.error(err)\n-      t.ok('close callback')\n+      t.assert.ifError(err)\n+      t.assert.ok('close callback')\n+      testDone()\n     })\n   })\n })\n \n-test('inside register', t => {\n+test('inside register', (t, done) => {\n   t.plan(5)\n   const fastify = Fastify()\n   fastify.register(function (f, opts, done) {\n     f.addHook('onClose', onClose)\n     function onClose (instance, done) {\n-      t.ok(instance.prototype === fastify.prototype)\n-      t.equal(instance, f)\n+      t.assert.ok(instance.prototype === fastify.prototype)\n+      t.assert.strictEqual(instance, f)\n       done()\n     }\n \n@@ -41,23 +46,24 @@\n   })\n \n   fastify.listen({ port: 0 }, err => {\n-    t.error(err)\n+    t.assert.ifError(err)\n \n     fastify.close((err) => {\n-      t.error(err)\n-      t.ok('close callback')\n+      t.assert.ifError(err)\n+      t.assert.ok('close callback')\n+      done()\n     })\n   })\n })\n \n-test('close order', t => {\n+test('close order', (t, done) => {\n   t.plan(5)\n   const fastify = Fastify()\n   const order = [1, 2, 3]\n \n   fastify.register(function (f, opts, done) {\n     f.addHook('onClose', (instance, done) => {\n-      t.equal(order.shift(), 1)\n+      t.assert.strictEqual(order.shift(), 1)\n       done()\n     })\n \n@@ -65,16 +71,17 @@\n   })\n \n   fastify.addHook('onClose', (instance, done) => {\n-    t.equal(order.shift(), 2)\n+    t.assert.strictEqual(order.shift(), 2)\n     done()\n   })\n \n   fastify.listen({ port: 0 }, err => {\n",
					"match": false,
					"packageHash": "eab0d145ac946a86136f2a223b3765255b6ea7851950eed41fc244390a843cfb",
					"size": 10142,
					"sourceHash": "a5cad036b38cdfbb60a3ccafd9463ae87a524a7ffdc0dceeebf70cf1a56d46f7",
					"status": "content"
				},
				"test/connectionTimeout.test.js": {
					"match": false,
					"packageHash": "fde72fedcd91aad30688e873cdb3c4c17c36db2e7f22a58b83df5ef7e8b56466",
					"size": 1020,
					"status": "missing-in-source"
				},
				"test/constrained-routes.test.js": {
					"diff": "--- published/test/constrained-routes.test.js\n+++ rebuilt/test/constrained-routes.test.js\n@@ -1,64 +1,64 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const Fastify = require('../fastify')\n \n-test('Should register a host constrained route', t => {\n-  t.plan(7)\n+test('Should register a host constrained route', async t => {\n+  t.plan(4)\n   const fastify = Fastify()\n \n   fastify.route({\n     method: 'GET',\n     url: '/',\n-    constraints: { host: 'fastify.io' },\n+    constraints: { host: 'fastify.dev' },\n     handler: (req, reply) => {\n       reply.send({ hello: 'world' })\n     }\n   })\n \n-  fastify.inject({\n-    method: 'GET',\n-    url: '/',\n-    headers: {\n-      host: 'fastify.io'\n-    }\n-  }, (err, res) => {\n-    t.error(err)\n-    t.same(JSON.parse(res.payload), { hello: 'world' })\n-    t.equal(res.statusCode, 200)\n-  })\n+  {\n+    const res = await fastify.inject({\n+      method: 'GET',\n+      url: '/',\n+      headers: {\n+        host: 'fastify.dev'\n+      }\n+    })\n+    t.assert.deepStrictEqual(JSON.parse(res.payload), { hello: 'world' })\n+    t.assert.strictEqual(res.statusCode, 200)\n+  }\n \n-  fastify.inject({\n-    method: 'GET',\n-    url: '/',\n-    headers: {\n-      host: 'example.com'\n-    }\n-  }, (err, res) => {\n-    t.error(err)\n-    t.equal(res.statusCode, 404)\n-  })\n+  {\n+    const res = await fastify.inject({\n+      method: 'GET',\n+      url: '/',\n+      headers: {\n+        host: 'example.com'\n+      }\n+    })\n \n-  fastify.inject({\n-    method: 'GET',\n-    url: '/'\n-  }, (err, res) => {\n-    t.error(err)\n-    t.equal(res.statusCode, 404)\n-  })\n+    t.assert.strictEqual(res.statusCode, 404)\n+  }\n+\n+  {\n+    const res = await fastify.inject({\n+      method: 'GET',\n+      url: '/'\n+    })\n+    t.assert.strictEqual(res.statusCode, 404)\n+  }\n })\n \n-test('Should register the same route with host constraints', t => {\n-  t.plan(8)\n+test('Should register the same route with host constraints', async t => {\n+  t.plan(5)\n   const fastify = Fastify()\n \n   fastify.route({\n     method: 'GET',\n     url: '/',\n-    constraints: { host: 'fastify.io' },\n+    constraints: { host: 'fastify.dev' },\n     handler: (req, reply) => {\n-      reply.send('fastify.io')\n",
					"match": false,
					"packageHash": "0002556d2c6f4bec733b63011cc04807e3536dbbace9a24cb6afe05748cb5d05",
					"size": 14356,
					"sourceHash": "04eca9cf042fc885c02af8707cc4477a3efb4867fb48a48e6a2d4f5ef645d6f5",
					"status": "content"
				},
				"test/content-length.test.js": {
					"diff": "--- published/test/content-length.test.js\n+++ rebuilt/test/content-length.test.js\n@@ -1,11 +1,10 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const Fastify = require('..')\n \n-test('default 413 with bodyLimit option', t => {\n-  t.plan(4)\n+test('default 413 with bodyLimit option', async (t) => {\n+  t.plan(3)\n \n   const fastify = Fastify({\n     bodyLimit: 10\n@@ -15,27 +14,25 @@\n     reply.send({ hello: 'world' })\n   })\n \n-  fastify.inject({\n+  const response = await fastify.inject({\n     method: 'POST',\n     url: '/',\n     body: {\n       text: '12345678901234567890123456789012345678901234567890'\n     }\n-  }, (err, res) => {\n-    t.error(err)\n-    t.equal(res.statusCode, 413)\n-    t.equal(res.headers['content-type'], 'application/json; charset=utf-8')\n-    t.same(JSON.parse(res.payload), {\n-      error: 'Payload Too Large',\n-      code: 'FST_ERR_CTP_BODY_TOO_LARGE',\n-      message: 'Request body is too large',\n-      statusCode: 413\n-    })\n+  })\n+  t.assert.strictEqual(response.statusCode, 413)\n+  t.assert.strictEqual(response.headers['content-type'], 'application/json; charset=utf-8')\n+  t.assert.deepStrictEqual(JSON.parse(response.payload), {\n+    error: 'Payload Too Large',\n+    code: 'FST_ERR_CTP_BODY_TOO_LARGE',\n+    message: 'Request body is too large',\n+    statusCode: 413\n   })\n })\n \n-test('default 400 with wrong content-length', t => {\n-  t.plan(4)\n+test('default 400 with wrong content-length', async (t) => {\n+  t.plan(3)\n \n   const fastify = Fastify()\n \n@@ -43,7 +40,7 @@\n     reply.send({ hello: 'world' })\n   })\n \n-  fastify.inject({\n+  const response = await fastify.inject({\n     method: 'POST',\n     url: '/',\n     headers: {\n@@ -52,21 +49,19 @@\n     body: {\n       text: '12345678901234567890123456789012345678901234567890'\n     }\n-  }, (err, res) => {\n-    t.error(err)\n-    t.equal(res.statusCode, 400)\n-    t.equal(res.headers['content-type'], 'application/json; charset=utf-8')\n-    t.same(JSON.parse(res.payload), {\n-      error: 'Bad Request',\n-      code: 'FST_ERR_CTP_INVALID_CONTENT_LENGTH',\n-      message: 'Request body size did not match Content-Length',\n-      statusCode: 400\n-    })\n+  })\n+  t.assert.strictEqual(response.statusCode, 400)\n+  t.assert.strictEqual(response.headers['content-type'], 'application/json; charset=utf-8')\n+  t.assert.deepStrictEqual(JSON.parse(response.payload), {\n+    error: 'Bad Request',\n+    code: 'FST_ERR_CTP_INVALID_CONTENT_LENGTH',\n+    message: 'Request body size did not match Content-Length',\n+    statusCode: 400\n   })\n })\n \n-test('custom 413 with bodyLimit option', t => {\n-  t.plan(4)\n+test('custom 413 with bodyLimit option', async (t) => {\n+  t.plan(3)\n \n   const fastify = Fastify({\n     bodyLimit: 10\n@@ -83,27 +78,25 @@\n       .send(err)\n   })\n",
					"match": false,
					"packageHash": "51195ae1d4686407730fdaff71eb53f3336b587e7e786167a8ccf3ffb8b699dc",
					"size": 4313,
					"sourceHash": "5b0cd06fc3e8dc1ed011e6a51b877743efc5dc4fcf96c71616869f0a6d904168",
					"status": "content"
				},
				"test/content-parser.test.js": {
					"diff": "--- published/test/content-parser.test.js\n+++ rebuilt/test/content-parser.test.js\n@@ -1,7 +1,6 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const Fastify = require('..')\n const keys = require('../lib/symbols')\n const { FST_ERR_CTP_ALREADY_PRESENT, FST_ERR_CTP_INVALID_TYPE, FST_ERR_CTP_INVALID_MEDIA_TYPE } = require('../lib/errors')\n@@ -10,42 +9,46 @@\n const second = function (req, payload, done) {}\n const third = function (req, payload, done) {}\n \n-test('hasContentTypeParser', t => {\n-  test('should know about internal parsers', t => {\n-    t.plan(4)\n+test('hasContentTypeParser', async t => {\n+  await t.test('should know about internal parsers', (t, done) => {\n+    t.plan(5)\n \n     const fastify = Fastify()\n     fastify.ready(err => {\n-      t.error(err)\n-      t.ok(fastify.hasContentTypeParser('application/json'))\n-      t.ok(fastify.hasContentTypeParser('text/plain'))\n-      t.notOk(fastify.hasContentTypeParser('application/jsoff'))\n+      t.assert.ifError(err)\n+      t.assert.ok(fastify.hasContentTypeParser('application/json'))\n+      t.assert.ok(fastify.hasContentTypeParser('text/plain'))\n+      t.assert.ok(fastify.hasContentTypeParser('  text/plain  '))\n+      t.assert.ok(!fastify.hasContentTypeParser('application/jsoff'))\n+      done()\n     })\n   })\n \n-  test('should work with string and RegExp', t => {\n-    t.plan(7)\n+  await t.test('should only work with string and RegExp', t => {\n+    t.plan(8)\n \n     const fastify = Fastify()\n     fastify.addContentTypeParser(/^image\\/.*/, first)\n     fastify.addContentTypeParser(/^application\\/.+\\+xml/, first)\n     fastify.addContentTypeParser('image/gif', first)\n \n-    t.ok(fastify.hasContentTypeParser('application/json'))\n-    t.ok(fastify.hasContentTypeParser(/^image\\/.*/))\n-    t.ok(fastify.hasContentTypeParser(/^application\\/.+\\+xml/))\n-    t.ok(fastify.hasContentTypeParser('image/gif'))\n-    t.notOk(fastify.hasContentTypeParser(/^image\\/.+\\+xml/))\n-    t.notOk(fastify.hasContentTypeParser('image/png'))\n-    t.notOk(fastify.hasContentTypeParser('*'))\n+    t.assert.ok(fastify.hasContentTypeParser('application/json'))\n+    t.assert.ok(fastify.hasContentTypeParser(/^image\\/.*/))\n+    t.assert.ok(fastify.hasContentTypeParser(/^application\\/.+\\+xml/))\n+    t.assert.ok(fastify.hasContentTypeParser('image/gif'))\n+    t.assert.ok(!fastify.hasContentTypeParser(/^image\\/.+\\+xml/))\n+    t.assert.ok(!fastify.hasContentTypeParser('image/png'))\n+    t.assert.ok(!fastify.hasContentTypeParser('*'))\n+    t.assert.throws(\n+      () => fastify.hasContentTypeParser(123),\n+      FST_ERR_CTP_INVALID_TYPE\n+    )\n   })\n-\n-  t.end()\n })\n \n-test('getParser', t => {\n-  test('should return matching parser', t => {\n-    t.plan(3)\n+test('getParser', async t => {\n+  await t.test('should return matching parser', t => {\n+    t.plan(7)\n \n     const fastify = Fastify()\n \n@@ -53,27 +56,63 @@\n     fastify.addContentTypeParser(/^application\\/.+\\+xml/, second)\n     fastify.addContentTypeParser('text/html', third)\n \n-    t.equal(fastify[keys.kContentTypeParser].getParser('application/t+xml').fn, second)\n-    t.equal(fastify[keys.kContentTypeParser].getParser('image/png').fn, first)\n-    t.equal(fastify[keys.kContentTypeParser].getParser('text/html').fn, third)\n+    t.assert.strictEqual(fastify[keys.kContentTypeParser].getParser('application/t+xml').fn, second)\n+    t.assert.strictEqual(fastify[keys.kContentTypeParser].getParser('image/png').fn, first)\n+    t.assert.strictEqual(fastify[keys.kContentTypeParser].getParser('text/html').fn, third)\n+    t.assert.strictEqual(fastify[keys.kContentTypeParser].getParser('text/html; charset=utf-8').fn, third)\n+    t.assert.strictEqual(fastify[keys.kContentTypeParser].getParser('text/html ; charset=utf-8').fn, third)\n+    t.assert.strictEqual(fastify[keys.kContentTypeParser].getParser('text/html\\t; charset=utf-8').fn, third)\n+    t.assert.strictEqual(fastify[keys.kContentTypeParser].getParser('text/htmlINVALID')?.fn, undefined)\n   })\n \n-  test('should return matching parser with caching', t => {\n+  await t.test('should return matching parser with caching /1', t => {\n     t.plan(6)\n \n     const fastify = Fastify()\n",
					"match": false,
					"packageHash": "17e5e359d5e077bd794fea4fdef67a38db80f2b1801454977ed95cb328a7aa89",
					"size": 9743,
					"sourceHash": "809c265154c16465dc86a51b7a6cacac0afc6007cfe7184ee73861b0ba9792b6",
					"status": "content"
				},
				"test/context-config.test.js": {
					"diff": "--- published/test/context-config.test.js\n+++ rebuilt/test/context-config.test.js\n@@ -1,7 +1,8 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n+\n+const { kRouteContext } = require('../lib/symbols')\n const Fastify = require('..')\n \n const schema = {\n@@ -13,11 +14,11 @@\n }\n \n function handler (req, reply) {\n-  reply.send(reply.context.config)\n+  reply.send(reply[kRouteContext].config)\n }\n \n-test('config', t => {\n-  t.plan(9)\n+test('config', async t => {\n+  t.plan(6)\n   const fastify = Fastify()\n \n   fastify.get('/get', {\n@@ -40,36 +41,33 @@\n     handler\n   })\n \n-  fastify.inject({\n+  let response = await fastify.inject({\n     method: 'GET',\n-    url: '/get'\n-  }, (err, response) => {\n-    t.error(err)\n-    t.equal(response.statusCode, 200)\n-    t.same(JSON.parse(response.payload), Object.assign({ url: '/get', method: 'GET' }, schema.config))\n+    url: '/route'\n   })\n \n-  fastify.inject({\n+  t.assert.strictEqual(response.statusCode, 200)\n+  t.assert.deepStrictEqual(response.json(), Object.assign({ url: '/route', method: 'GET' }, schema.config))\n+\n+  response = await fastify.inject({\n     method: 'GET',\n     url: '/route'\n-  }, (err, response) => {\n-    t.error(err)\n-    t.equal(response.statusCode, 200)\n-    t.same(JSON.parse(response.payload), Object.assign({ url: '/route', method: 'GET' }, schema.config))\n   })\n \n-  fastify.inject({\n+  t.assert.strictEqual(response.statusCode, 200)\n+  t.assert.deepStrictEqual(response.json(), Object.assign({ url: '/route', method: 'GET' }, schema.config))\n+\n+  response = await fastify.inject({\n     method: 'GET',\n     url: '/no-config'\n-  }, (err, response) => {\n-    t.error(err)\n-    t.equal(response.statusCode, 200)\n-    t.same(JSON.parse(response.payload), { url: '/no-config', method: 'GET' })\n   })\n+\n+  t.assert.strictEqual(response.statusCode, 200)\n+  t.assert.deepStrictEqual(response.json(), { url: '/no-config', method: 'GET' })\n })\n \n-test('config with exposeHeadRoutes', t => {\n-  t.plan(9)\n+test('config with exposeHeadRoutes', async t => {\n+  t.plan(6)\n   const fastify = Fastify({ exposeHeadRoutes: true })\n \n   fastify.get('/get', {\n@@ -92,36 +90,33 @@\n     handler\n   })\n \n-  fastify.inject({\n+  let response = await fastify.inject({\n     method: 'GET',\n     url: '/get'\n-  }, (err, response) => {\n-    t.error(err)\n-    t.equal(response.statusCode, 200)\n-    t.same(JSON.parse(response.payload), Object.assign({ url: '/get', method: 'GET' }, schema.config))\n   })\n \n-  fastify.inject({\n+  t.assert.strictEqual(response.statusCode, 200)\n+  t.assert.deepStrictEqual(response.json(), Object.assign({ url: '/get', method: 'GET' }, schema.config))\n+\n+  response = await fastify.inject({\n     method: 'GET',\n",
					"match": false,
					"packageHash": "0a365e650cc33b66bc06b64791b64ca442de70994dcb1119677041c0460d7edc",
					"size": 3787,
					"sourceHash": "6c590a6c9f693e644d39f698382ddd6c4aa90426861f808a068ca82227087d08",
					"status": "content"
				},
				"test/copy.test.js": {
					"match": false,
					"packageHash": "528a443c56410c82dc7ef0b1c3d9fded9024b7d6cf632ad8ecce9af1fedc5be3",
					"size": 796,
					"status": "missing-in-source"
				},
				"test/custom-http-server.test.js": {
					"diff": "--- published/test/custom-http-server.test.js\n+++ rebuilt/test/custom-http-server.test.js\n@@ -1,73 +1,118 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n+const http = require('node:http')\n+const dns = require('node:dns').promises\n const Fastify = require('..')\n-const http = require('http')\n const { FST_ERR_FORCE_CLOSE_CONNECTIONS_IDLE_NOT_AVAILABLE } = require('../lib/errors')\n-const sget = require('simple-get').concat\n-const dns = require('dns').promises\n \n-test('Should support a custom http server', async t => {\n+async function setup () {\n   const localAddresses = await dns.lookup('localhost', { all: true })\n \n-  t.plan(localAddresses.length + 3)\n+  test('Should support a custom http server', { skip: localAddresses.length < 1 }, async t => {\n+    t.plan(5)\n \n-  const serverFactory = (handler, opts) => {\n-    t.ok(opts.serverFactory, 'it is called twice for every HOST interface')\n+    const fastify = Fastify({\n+      serverFactory: (handler, opts) => {\n+        t.assert.ok(opts.serverFactory, 'it is called once for localhost')\n+\n+        const server = http.createServer((req, res) => {\n+          req.custom = true\n+          handler(req, res)\n+        })\n \n-    const server = http.createServer((req, res) => {\n-      req.custom = true\n-      handler(req, res)\n+        return server\n+      }\n     })\n \n-    return server\n-  }\n-\n-  const fastify = Fastify({ serverFactory })\n+    t.after(() => fastify.close())\n+    fastify.get('/', (req, reply) => {\n+      t.assert.ok(req.raw.custom)\n+      reply.send({ hello: 'world' })\n+    })\n \n-  t.teardown(fastify.close.bind(fastify))\n+    await fastify.listen({ port: 0 })\n \n-  fastify.get('/', (req, reply) => {\n-    t.ok(req.raw.custom)\n-    reply.send({ hello: 'world' })\n+    const response = await fetch('http://localhost:' + fastify.server.address().port, {\n+      method: 'GET'\n+    })\n+    t.assert.ok(response.ok)\n+    t.assert.strictEqual(response.status, 200)\n+    const body = await response.text()\n+    t.assert.deepStrictEqual(JSON.parse(body), { hello: 'world' })\n   })\n \n-  await fastify.listen({ port: 0 })\n+  test('Should not allow forceCloseConnection=idle if the server does not support closeIdleConnections', t => {\n+    t.plan(1)\n \n-  await new Promise((resolve, reject) => {\n-    sget({\n-      method: 'GET',\n-      url: 'http://localhost:' + fastify.server.address().port,\n-      rejectUnauthorized: false\n-    }, (err, response, body) => {\n-      if (err) {\n-        return reject(err)\n-      }\n-      t.equal(response.statusCode, 200)\n-      t.same(JSON.parse(body), { hello: 'world' })\n-      resolve()\n+    t.assert.throws(\n+      () => {\n+        Fastify({\n+          forceCloseConnections: 'idle',\n+          serverFactory (handler, opts) {\n+            return {\n+              on () {\n+\n+              }\n+            }\n+          }\n+        })\n+      },\n+      FST_ERR_FORCE_CLOSE_CONNECTIONS_IDLE_NOT_AVAILABLE,\n+      \"Cannot set forceCloseConnections to 'idle' as your HTTP server does not support closeIdleConnections method\"\n+    )\n+  })\n",
					"match": false,
					"packageHash": "c34a87e378c37faedc62517715f8d68ba0bc58f68d5877f3fbe6b206b4018056",
					"size": 1824,
					"sourceHash": "410256e4531ea9313f06b40357144383ced1b9bec240bf63e3a691836fc414b8",
					"status": "content"
				},
				"test/custom-parser-async.test.js": {
					"diff": "--- published/test/custom-parser-async.test.js\n+++ rebuilt/test/custom-parser-async.test.js\n@@ -1,14 +1,12 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n-const sget = require('simple-get').concat\n+const { test } = require('node:test')\n const Fastify = require('../fastify')\n \n process.removeAllListeners('warning')\n \n-test('contentTypeParser should add a custom async parser', t => {\n-  t.plan(3)\n+test('contentTypeParser should add a custom async parser', async t => {\n+  t.plan(2)\n   const fastify = Fastify()\n \n   fastify.post('/', (req, reply) => {\n@@ -24,43 +22,38 @@\n     return res\n   })\n \n-  fastify.listen({ port: 0 }, err => {\n-    t.error(err)\n+  t.after(() => fastify.close())\n+  const fastifyServer = await fastify.listen({ port: 0 })\n \n-    t.teardown(() => fastify.close())\n+  await t.test('in POST', async t => {\n+    t.plan(3)\n \n-    t.test('in POST', t => {\n-      t.plan(3)\n-\n-      sget({\n-        method: 'POST',\n-        url: 'http://localhost:' + fastify.server.address().port,\n-        body: '{\"hello\":\"world\"}',\n-        headers: {\n-          'Content-Type': 'application/jsoff'\n-        }\n-      }, (err, response, body) => {\n-        t.error(err)\n-        t.equal(response.statusCode, 200)\n-        t.same(body.toString(), JSON.stringify({ hello: 'world' }))\n-      })\n+    const result = await fetch(fastifyServer, {\n+      method: 'POST',\n+      headers: {\n+        'Content-Type': 'application/jsoff'\n+      },\n+      body: '{\"hello\":\"world\"}'\n     })\n \n-    t.test('in OPTIONS', t => {\n-      t.plan(3)\n+    t.assert.ok(result.ok)\n+    t.assert.strictEqual(result.status, 200)\n+    t.assert.deepStrictEqual(await result.json(), { hello: 'world' })\n+  })\n+\n+  await t.test('in OPTIONS', async t => {\n+    t.plan(3)\n \n-      sget({\n-        method: 'OPTIONS',\n-        url: 'http://localhost:' + fastify.server.address().port,\n-        body: '{\"hello\":\"world\"}',\n-        headers: {\n-          'Content-Type': 'application/jsoff'\n-        }\n-      }, (err, response, body) => {\n-        t.error(err)\n-        t.equal(response.statusCode, 200)\n-        t.same(body.toString(), JSON.stringify({ hello: 'world' }))\n-      })\n+    const result = await fetch(fastifyServer, {\n+      method: 'OPTIONS',\n+      headers: {\n+        'Content-Type': 'application/jsoff'\n+      },\n+      body: '{\"hello\":\"world\"}'\n     })\n+\n+    t.assert.ok(result.ok)\n+    t.assert.strictEqual(result.status, 200)\n+    t.assert.deepStrictEqual(await result.json(), { hello: 'world' })\n   })\n })\n",
					"match": false,
					"packageHash": "6b4e06b6d5ad6cce85f9177a6e5ff6ab963d4cdef3ff8bdd8232e04a508379db",
					"size": 1600,
					"sourceHash": "392d3eacd39603b462c64e3b70a0d09fcdad5af78b470b9dd03c8f21707be632",
					"status": "content"
				},
				"test/custom-parser.test.js": {
					"match": false,
					"packageHash": "ebb17cdb37569c54b3e59063f14664fc8801150f25c8a5e546f1e62be580a753",
					"size": 40496,
					"status": "missing-in-source"
				},
				"test/custom-querystring-parser.test.js": {
					"diff": "--- published/test/custom-querystring-parser.test.js\n+++ rebuilt/test/custom-querystring-parser.test.js\n@@ -1,123 +1,97 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n-const querystring = require('querystring')\n-const sget = require('simple-get').concat\n+const { test } = require('node:test')\n+const querystring = require('node:querystring')\n const Fastify = require('..')\n \n-test('Custom querystring parser', t => {\n-  t.plan(9)\n+test('Custom querystring parser', async t => {\n+  t.plan(7)\n \n   const fastify = Fastify({\n     querystringParser: function (str) {\n-      t.equal(str, 'foo=bar&baz=faz')\n+      t.assert.strictEqual(str, 'foo=bar&baz=faz')\n       return querystring.parse(str)\n     }\n   })\n \n   fastify.get('/', (req, reply) => {\n-    t.same(req.query, {\n+    t.assert.deepEqual(req.query, {\n       foo: 'bar',\n       baz: 'faz'\n     })\n     reply.send({ hello: 'world' })\n   })\n \n-  fastify.listen({ port: 0 }, (err, address) => {\n-    t.error(err)\n-    t.teardown(() => fastify.close())\n-\n-    sget({\n-      method: 'GET',\n-      url: `${address}?foo=bar&baz=faz`\n-    }, (err, response, body) => {\n-      t.error(err)\n-      t.equal(response.statusCode, 200)\n-    })\n+  const fastifyServer = await fastify.listen({ port: 0 })\n+  t.after(() => fastify.close())\n \n-    fastify.inject({\n-      method: 'GET',\n-      url: `${address}?foo=bar&baz=faz`\n-    }, (err, response, body) => {\n-      t.error(err)\n-      t.equal(response.statusCode, 200)\n-    })\n+  const result = await fetch(`${fastifyServer}?foo=bar&baz=faz`)\n+  t.assert.ok(result.ok)\n+  t.assert.strictEqual(result.status, 200)\n+\n+  const injectResponse = await fastify.inject({\n+    method: 'GET',\n+    url: `${fastifyServer}?foo=bar&baz=faz`\n   })\n+  t.assert.strictEqual(injectResponse.statusCode, 200)\n })\n \n-test('Custom querystring parser should be called also if there is nothing to parse', t => {\n-  t.plan(9)\n+test('Custom querystring parser should be called also if there is nothing to parse', async t => {\n+  t.plan(7)\n \n   const fastify = Fastify({\n     querystringParser: function (str) {\n-      t.equal(str, '')\n+      t.assert.strictEqual(str, '')\n       return querystring.parse(str)\n     }\n   })\n \n   fastify.get('/', (req, reply) => {\n-    t.same(req.query, {})\n+    t.assert.deepEqual(req.query, {})\n     reply.send({ hello: 'world' })\n   })\n \n-  fastify.listen({ port: 0 }, (err, address) => {\n-    t.error(err)\n-    t.teardown(() => fastify.close())\n-\n-    sget({\n-      method: 'GET',\n-      url: address\n-    }, (err, response, body) => {\n-      t.error(err)\n-      t.equal(response.statusCode, 200)\n-    })\n+  const fastifyServer = await fastify.listen({ port: 0 })\n+  t.after(() => fastify.close())\n \n",
					"match": false,
					"packageHash": "4241fa87cc74bd0d42b30ef4e1411ebb4483a33687c465bde604941da4c7ab3a",
					"size": 2826,
					"sourceHash": "732cbbd045d53debd8630e6ac9e81d19e86d8e91b2c7f6af50927c43d82c850c",
					"status": "content"
				},
				"test/decorator.test.js": {
					"diff": "--- published/test/decorator.test.js\n+++ rebuilt/test/decorator.test.js\n@@ -1,99 +1,103 @@\n 'use strict'\n \n-/* eslint no-prototype-builtins: 0 */\n-\n-const t = require('tap')\n-const test = t.test\n+const { test, describe } = require('node:test')\n const Fastify = require('..')\n const fp = require('fastify-plugin')\n-const sget = require('simple-get').concat\n const symbols = require('../lib/symbols.js')\n-const proxyquire = require('proxyquire')\n \n test('server methods should exist', t => {\n   t.plan(2)\n   const fastify = Fastify()\n-  t.ok(fastify.decorate)\n-  t.ok(fastify.hasDecorator)\n+  t.assert.ok(fastify.decorate)\n+  t.assert.ok(fastify.hasDecorator)\n })\n \n-test('should check if the given decoration already exist when null', t => {\n+test('should check if the given decoration already exist when null', (t, done) => {\n   t.plan(1)\n   const fastify = Fastify()\n   fastify.decorate('null', null)\n   fastify.ready(() => {\n-    t.ok(fastify.hasDecorator('null'))\n+    t.assert.ok(fastify.hasDecorator('null'))\n+    done()\n   })\n })\n \n-test('server methods should be encapsulated via .register', t => {\n+test('server methods should be encapsulated via .register', (t, done) => {\n   t.plan(2)\n   const fastify = Fastify()\n \n   fastify.register((instance, opts, done) => {\n     instance.decorate('test', () => {})\n-    t.ok(instance.test)\n+    t.assert.ok(instance.test)\n     done()\n   })\n \n   fastify.ready(() => {\n-    t.notOk(fastify.test)\n+    t.assert.strictEqual(fastify.test, undefined)\n+    done()\n   })\n })\n \n-test('hasServerMethod should check if the given method already exist', t => {\n+test('hasServerMethod should check if the given method already exist', (t, done) => {\n   t.plan(2)\n   const fastify = Fastify()\n \n   fastify.register((instance, opts, done) => {\n     instance.decorate('test', () => {})\n-    t.ok(instance.hasDecorator('test'))\n+    t.assert.ok(instance.hasDecorator('test'))\n     done()\n   })\n \n   fastify.ready(() => {\n-    t.notOk(fastify.hasDecorator('test'))\n+    t.assert.strictEqual(fastify.hasDecorator('test'), false)\n+    done()\n   })\n })\n \n-test('decorate should throw if a declared dependency is not present', t => {\n+test('decorate should throw if a declared dependency is not present', (t, done) => {\n   t.plan(3)\n   const fastify = Fastify()\n \n   fastify.register((instance, opts, done) => {\n     try {\n       instance.decorate('test', () => {}, ['dependency'])\n-      t.fail()\n+      t.assert.fail()\n     } catch (e) {\n-      t.same(e.code, 'FST_ERR_DEC_MISSING_DEPENDENCY')\n-      t.same(e.message, 'The decorator is missing dependency \\'dependency\\'.')\n+      t.assert.strictEqual(e.code, 'FST_ERR_DEC_MISSING_DEPENDENCY')\n+      t.assert.strictEqual(e.message, 'The decorator is missing dependency \\'dependency\\'.')\n     }\n     done()\n   })\n \n-  fastify.ready(() => t.pass())\n+  fastify.ready(() => {\n+    t.assert.ok('ready')\n+    done()\n+  })\n })\n",
					"match": false,
					"packageHash": "5af62c88ca252d4fa15384c815aded9c39ce6650fe331f06c52c39aab9a505ac",
					"size": 30137,
					"sourceHash": "eb1bcd226b57284481692105a67fb0c911d213e57109ac44d30c3c48ca8b44af",
					"status": "content"
				},
				"test/default-route.test.js": {
					"match": false,
					"packageHash": "fa38181a94e63db05bcb2a3efea7fcf3541e171c01e35c2ff9b83f7ab4798e3d",
					"size": 902,
					"status": "missing-in-source"
				},
				"test/delete.test.js": {
					"diff": "--- published/test/delete.test.js\n+++ rebuilt/test/delete.test.js\n@@ -1,8 +1,6 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n-const sget = require('simple-get').concat\n+const { test } = require('node:test')\n const fastify = require('..')()\n \n const schema = {\n@@ -85,15 +83,17 @@\n   }\n }\n \n-test('shorthand - delete', t => {\n+test('shorthand - delete', (t, done) => {\n   t.plan(1)\n   try {\n     fastify.delete('/', schema, function (req, reply) {\n       reply.code(200).send({ hello: 'world' })\n     })\n-    t.pass()\n+    t.assert.ok(true)\n   } catch (e) {\n-    t.fail()\n+    t.assert.fail()\n+  } finally {\n+    done()\n   }\n })\n \n@@ -103,9 +103,9 @@\n     fastify.delete('/params/:foo/:test', paramsSchema, function (req, reply) {\n       reply.code(200).send(req.params)\n     })\n-    t.pass()\n+    t.assert.ok(true)\n   } catch (e) {\n-    t.fail()\n+    t.assert.fail()\n   }\n })\n \n@@ -115,9 +115,9 @@\n     fastify.delete('/query', querySchema, function (req, reply) {\n       reply.send(req.query)\n     })\n-    t.pass()\n+    t.assert.ok(true)\n   } catch (e) {\n-    t.fail()\n+    t.assert.fail()\n   }\n })\n \n@@ -127,9 +127,9 @@\n     fastify.delete('/headers', headersSchema, function (req, reply) {\n       reply.code(200).send(req.headers)\n     })\n-    t.pass()\n+    t.assert.ok(true)\n   } catch (e) {\n-    t.fail()\n+    t.assert.fail()\n   }\n })\n \n@@ -139,9 +139,9 @@\n     fastify.delete('/missing', function (req, reply) {\n       reply.code(200).send({ hello: 'world' })\n     })\n-    t.pass()\n+    t.assert.ok(true)\n   } catch (e) {\n-    t.fail()\n+    t.assert.fail()\n   }\n })\n \n@@ -151,158 +151,184 @@\n     fastify.delete('/body', bodySchema, function (req, reply) {\n       reply.send(req.body)\n     })\n-    t.pass()\n+    t.assert.ok(true)\n   } catch (e) {\n-    t.fail()\n+    t.assert.fail()\n   }\n })\n \n-fastify.listen({ port: 0 }, err => {\n-  t.error(err)\n-  t.teardown(() => { fastify.close() })\n+test('delete tests', async t => {\n+  const fastifyServer = await fastify.listen({ port: 0 })\n+  t.after(() => { fastify.close() })\n \n",
					"match": false,
					"packageHash": "d3f5c946752e8949a25767e928673ff62cb3900df3253147ea59d9ed32e140a3",
					"size": 7035,
					"sourceHash": "43054d65f3161271e95eae4419c4486fa9d1758a05ea1c10f1ca620c83e4ef99",
					"status": "content"
				},
				"test/diagnostics-channel.test.js": {
					"match": false,
					"packageHash": "88a5f11be0317f208e1d8785925f1ccc68a17eff0c387e664e768a72536c4b01",
					"size": 1164,
					"status": "missing-in-source"
				},
				"test/encapsulated-error-handler.test.js": {
					"diff": "--- published/test/encapsulated-error-handler.test.js\n+++ rebuilt/test/encapsulated-error-handler.test.js\n@@ -1,27 +1,68 @@\n 'use strict'\n \n-const { test } = require('tap')\n+const { test } = require('node:test')\n const Fastify = require('..')\n \n-test('encapuslates an error handler', async t => {\n+// Because of how error handlers wrap things, following the control flow can be tricky\n+// In this test file numbered comments indicate the order statements are expected to execute\n+\n+test('encapsulates an asynchronous error handler', async t => {\n   t.plan(3)\n \n   const fastify = Fastify()\n   fastify.register(async function (fastify) {\n     fastify.setErrorHandler(async function a (err) {\n-      t.equal(err.message, 'kaboom')\n-      throw new Error('caught')\n+      // 3. the inner error handler catches the error, and throws a new error\n+      t.assert.strictEqual(err.message, 'from_endpoint')\n+      throw new Error('from_inner')\n+    })\n+    fastify.get('/encapsulated', async () => {\n+      // 2. the endpoint throws an error\n+      throw new Error('from_endpoint')\n     })\n-    fastify.get('/encapsulated', async () => { throw new Error('kaboom') })\n   })\n \n   fastify.setErrorHandler(async function b (err) {\n-    t.equal(err.message, 'caught')\n-    throw new Error('wrapped')\n+    // 4. the outer error handler catches the error thrown by the inner error handler\n+    t.assert.strictEqual(err.message, 'from_inner')\n+    // 5. the outer error handler throws a new error\n+    throw new Error('from_outer')\n   })\n \n+  // 1. the endpoint is called\n   const res = await fastify.inject('/encapsulated')\n-  t.equal(res.json().message, 'wrapped')\n+  // 6. the default error handler returns the error from the outer error handler\n+  t.assert.strictEqual(res.json().message, 'from_outer')\n+})\n+\n+// See discussion in https://github.com/fastify/fastify/pull/5222#discussion_r1432573655\n+test('encapsulates a synchronous error handler', async t => {\n+  t.plan(3)\n+\n+  const fastify = Fastify()\n+  fastify.register(async function (fastify) {\n+    fastify.setErrorHandler(function a (err) {\n+      // 3. the inner error handler catches the error, and throws a new error\n+      t.assert.strictEqual(err.message, 'from_endpoint')\n+      throw new Error('from_inner')\n+    })\n+    fastify.get('/encapsulated', async () => {\n+      // 2. the endpoint throws an error\n+      throw new Error('from_endpoint')\n+    })\n+  })\n+\n+  fastify.setErrorHandler(async function b (err) {\n+    // 4. the outer error handler catches the error thrown by the inner error handler\n+    t.assert.strictEqual(err.message, 'from_inner')\n+    // 5. the outer error handler throws a new error\n+    throw new Error('from_outer')\n+  })\n+\n+  // 1. the endpoint is called\n+  const res = await fastify.inject('/encapsulated')\n+  // 6. the default error handler returns the error from the outer error handler\n+  t.assert.strictEqual(res.json().message, 'from_outer')\n })\n \n test('onError hook nested', async t => {\n@@ -30,21 +71,167 @@\n   const fastify = Fastify()\n   fastify.register(async function (fastify) {\n     fastify.setErrorHandler(async function a (err) {\n-      t.equal(err.message, 'kaboom')\n-      throw new Error('caught')\n+      // 4. the inner error handler catches the error, and throws a new error\n+      t.assert.strictEqual(err.message, 'from_endpoint')\n+      throw new Error('from_inner')\n+    })\n+    fastify.get('/encapsulated', async () => {\n+      // 2. the endpoint throws an error\n+      throw new Error('from_endpoint')\n     })\n-    fastify.get('/encapsulated', async () => { throw new Error('kaboom') })\n   })\n \n   fastify.setErrorHandler(async function b (err) {\n-    t.equal(err.message, 'caught')\n-    throw new Error('wrapped')\n+    // 5. the outer error handler catches the error thrown by the inner error handler\n",
					"match": false,
					"packageHash": "48184df8c7f33f9894e1fb960436c4baa30bc4ce4b4679b804a482c9b37ca3be",
					"size": 1313,
					"sourceHash": "cb53d5adbad3298ea6629e7362fc227cef203a7096a0c0d99a40b3753d6602ed",
					"status": "content"
				},
				"test/esm/esm.mjs": {
					"match": false,
					"packageHash": "68cb9b02d15723f22f96b37a71b32797678eb343a80f7117ff6b64e46ee863d2",
					"size": 284,
					"status": "missing-in-source"
				},
				"test/esm/index.test.js": {
					"diff": "--- published/test/esm/index.test.js\n+++ rebuilt/test/esm/index.test.js\n@@ -1,18 +1,8 @@\n 'use strict'\n \n-const t = require('tap')\n-const semver = require('semver')\n-\n-if (semver.lt(process.versions.node, '14.13.0')) {\n-  t.skip('Skip named exports because Node version < 14.13.0')\n-} else {\n-  // Node v8 throw a `SyntaxError: Unexpected token import`\n-  // even if this branch is never touch in the code,\n-  // by using `eval` we can avoid this issue.\n-  // eslint-disable-next-line\n-  new Function('module', 'return import(module)')('./named-exports.mjs').catch((err) => {\n+import('./named-exports.mjs')\n+  .catch(err => {\n     process.nextTick(() => {\n       throw err\n     })\n   })\n-}\n",
					"match": false,
					"packageHash": "ce9cbaeb61de0f0963be4137fcda665fc77f8baa2f9dc01c5a0f279ac0b346d3",
					"size": 533,
					"sourceHash": "658e5f84002b2db0d717e738f66eafba88cb4e58acf42e6459510ef632d9cb7a",
					"status": "content"
				},
				"test/esm/named-exports.mjs": {
					"diff": "--- published/test/esm/named-exports.mjs\n+++ rebuilt/test/esm/named-exports.mjs\n@@ -1,7 +1,8 @@\n-import t from 'tap'\n+import { test } from 'node:test'\n import { fastify } from '../../fastify.js'\n \n-t.test('named exports support', async t => {\n+// This test is executed in index.test.js\n+test('named exports support', async t => {\n   const app = fastify()\n \n   app.register(import('./plugin.mjs'), { foo: 'bar' })\n@@ -9,5 +10,5 @@\n \n   await app.ready()\n \n-  t.equal(app.foo, 'bar')\n+  t.assert.strictEqual(app.foo, 'bar')\n })\n",
					"match": false,
					"packageHash": "d931009ce7f7a4d4663091591099523c01e4a1c7e1e3c6116037a48ff31e284f",
					"size": 278,
					"sourceHash": "3d35d0be59a63cf25aea9a8e231e8f4afedeeccf87d5a2d8475a0e4b275112db",
					"status": "content"
				},
				"test/esm/other.mjs": {
					"diff": "--- published/test/esm/other.mjs\n+++ rebuilt/test/esm/other.mjs\n@@ -1,7 +1,8 @@\n-import t from 'tap'\n+// Imported in both index.test.js & esm.test.mjs\n+import { strictEqual } from 'node:assert'\n \n async function other (fastify, opts) {\n-  t.equal(fastify.foo, 'bar')\n+  strictEqual(fastify.foo, 'bar')\n }\n \n export default other\n",
					"match": false,
					"packageHash": "d5f2220555ce619eabf177370e2563b30c1a0c61b3222aba37e5f254f3635b82",
					"size": 114,
					"sourceHash": "77dadbe1d32a0c8231605abf5ca60207e5b0c15183f67d0ea8fba7ae6e841e7f",
					"status": "content"
				},
				"test/esm/plugin.mjs": {
					"diff": "--- published/test/esm/plugin.mjs\n+++ rebuilt/test/esm/plugin.mjs\n@@ -1,3 +1,4 @@\n+// Imported in both index.test.js & esm.test.mjs\n async function plugin (fastify, opts) {\n   fastify.decorate('foo', opts.foo)\n }\n",
					"match": false,
					"packageHash": "20b2e5f9f02c454c56f9ddc87900030e039283a72737fe8841eee94be2539c7d",
					"size": 145,
					"sourceHash": "b01f6dbb87c3d7b15ffc90100bc8245882eff05400d9b81969f207d22152efa7",
					"status": "content"
				},
				"test/fastify-instance.test.js": {
					"diff": "--- published/test/fastify-instance.test.js\n+++ rebuilt/test/fastify-instance.test.js\n@@ -1,16 +1,21 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const Fastify = require('..')\n+const os = require('node:os')\n+\n const {\n   kOptions,\n-  kErrorHandler\n+  kErrorHandler,\n+  kChildLoggerFactory,\n+  kState\n } = require('../lib/symbols')\n \n+const isIPv6Missing = !Object.values(os.networkInterfaces()).flat().some(({ family }) => family === 'IPv6')\n+\n test('root fastify instance is an object', t => {\n   t.plan(1)\n-  t.type(Fastify(), 'object')\n+  t.assert.strictEqual(typeof Fastify(), 'object')\n })\n \n test('fastify instance should contains ajv options', t => {\n@@ -22,7 +27,7 @@\n       }\n     }\n   })\n-  t.same(fastify[kOptions].ajv, {\n+  t.assert.deepStrictEqual(fastify[kOptions].ajv, {\n     customOptions: {\n       nullable: false\n     },\n@@ -40,7 +45,7 @@\n       plugins: [[]]\n     }\n   })\n-  t.same(fastify[kOptions].ajv, {\n+  t.assert.deepStrictEqual(fastify[kOptions].ajv, {\n     customOptions: {\n       nullable: false\n     },\n@@ -50,7 +55,7 @@\n \n test('fastify instance get invalid ajv options', t => {\n   t.plan(1)\n-  t.throws(() => Fastify({\n+  t.assert.throws(() => Fastify({\n     ajv: {\n       customOptions: 8\n     }\n@@ -59,7 +64,7 @@\n \n test('fastify instance get invalid ajv options.plugins', t => {\n   t.plan(1)\n-  t.throws(() => Fastify({\n+  t.assert.throws(() => Fastify({\n     ajv: {\n       customOptions: {},\n       plugins: 8\n@@ -70,9 +75,9 @@\n test('fastify instance should contain default errorHandler', t => {\n   t.plan(3)\n   const fastify = Fastify()\n-  t.ok(fastify[kErrorHandler].func instanceof Function)\n-  t.same(fastify.errorHandler, fastify[kErrorHandler].func)\n-  t.same(Object.getOwnPropertyDescriptor(fastify, 'errorHandler').set, undefined)\n+  t.assert.ok(fastify[kErrorHandler].func instanceof Function)\n+  t.assert.deepStrictEqual(fastify.errorHandler, fastify[kErrorHandler].func)\n+  t.assert.deepStrictEqual(Object.getOwnPropertyDescriptor(fastify, 'errorHandler').set, undefined)\n })\n \n test('errorHandler in plugin should be separate from the external one', async t => {\n@@ -86,14 +91,210 @@\n \n     instance.setErrorHandler(inPluginErrHandler)\n \n-    t.notSame(instance.errorHandler, fastify.errorHandler)\n-    t.equal(instance.errorHandler.name, 'bound inPluginErrHandler')\n+    t.assert.notDeepStrictEqual(instance.errorHandler, fastify.errorHandler)\n+    t.assert.strictEqual(instance.errorHandler.name, 'bound inPluginErrHandler')\n+\n+    done()\n+  })\n+\n+  await fastify.ready()\n+\n+  t.assert.ok(fastify[kErrorHandler].func instanceof Function)\n+  t.assert.deepStrictEqual(fastify.errorHandler, fastify[kErrorHandler].func)\n+})\n+\n+test('fastify instance should contain default childLoggerFactory', t => {\n+  t.plan(3)\n+  const fastify = Fastify()\n+  t.assert.ok(fastify[kChildLoggerFactory] instanceof Function)\n+  t.assert.deepStrictEqual(fastify.childLoggerFactory, fastify[kChildLoggerFactory])\n",
					"match": false,
					"packageHash": "ddc3d9492871eb59a972b745cf686a37d090605096b499987eb08dc5fe147787",
					"size": 2111,
					"sourceHash": "9d32418988ccfca9a6baf0c30f7c839bd6179cd71724dfdcbf6e8bc3c81cf77d",
					"status": "content"
				},
				"test/fluent-schema.test.js": {
					"diff": "--- published/test/fluent-schema.test.js\n+++ rebuilt/test/fluent-schema.test.js\n@@ -1,12 +1,11 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const Fastify = require('..')\n const S = require('fluent-json-schema')\n \n-test('use fluent-json-schema object', t => {\n-  t.plan(15)\n+test('use fluent-json-schema object', async (t) => {\n+  t.plan(10)\n   const fastify = Fastify()\n \n   fastify.post('/:id', {\n@@ -24,73 +23,62 @@\n     }\n   })\n \n-  // check params\n-  fastify.inject({\n+  const res1 = await fastify.inject({\n     method: 'POST',\n     url: '/1',\n     headers: { 'x-custom': 'me@me.me' },\n     query: { surname: 'bar' },\n     payload: { name: 'foo' }\n-  }, (err, res) => {\n-    t.error(err)\n-    t.equal(res.statusCode, 400)\n-    t.same(res.json(), { statusCode: 400, error: 'Bad Request', message: 'params/id must be >= 42' })\n   })\n+  t.assert.strictEqual(res1.statusCode, 400)\n+  t.assert.deepStrictEqual(res1.json(), { statusCode: 400, code: 'FST_ERR_VALIDATION', error: 'Bad Request', message: 'params/id must be >= 42' })\n \n   // check header\n-  fastify.inject({\n+  const res2 = await fastify.inject({\n     method: 'POST',\n     url: '/42',\n     headers: { 'x-custom': 'invalid' },\n     query: { surname: 'bar' },\n     payload: { name: 'foo' }\n-  }, (err, res) => {\n-    t.error(err)\n-    t.equal(res.statusCode, 400)\n-    t.same(res.json(), { statusCode: 400, error: 'Bad Request', message: 'headers/x-custom must match format \"email\"' })\n   })\n+  t.assert.strictEqual(res2.statusCode, 400)\n+  t.assert.deepStrictEqual(res2.json(), { statusCode: 400, code: 'FST_ERR_VALIDATION', error: 'Bad Request', message: 'headers/x-custom must match format \"email\"' })\n \n   // check query\n-  fastify.inject({\n+  const res3 = await fastify.inject({\n     method: 'POST',\n     url: '/42',\n     headers: { 'x-custom': 'me@me.me' },\n     query: { },\n     payload: { name: 'foo' }\n-  }, (err, res) => {\n-    t.error(err)\n-    t.equal(res.statusCode, 400)\n-    t.same(res.json(), { statusCode: 400, error: 'Bad Request', message: 'querystring must have required property \\'surname\\'' })\n   })\n+  t.assert.strictEqual(res3.statusCode, 400)\n+  t.assert.deepStrictEqual(res3.json(), { statusCode: 400, code: 'FST_ERR_VALIDATION', error: 'Bad Request', message: 'querystring must have required property \\'surname\\'' })\n \n   // check body\n-  fastify.inject({\n+  const res4 = await fastify.inject({\n     method: 'POST',\n     url: '/42',\n     headers: { 'x-custom': 'me@me.me' },\n     query: { surname: 'bar' },\n     payload: { name: [1, 2, 3] }\n-  }, (err, res) => {\n-    t.error(err)\n-    t.equal(res.statusCode, 400)\n-    t.same(res.json(), { statusCode: 400, error: 'Bad Request', message: 'body/name must be string' })\n   })\n+  t.assert.strictEqual(res4.statusCode, 400)\n+  t.assert.deepStrictEqual(res4.json(), { statusCode: 400, code: 'FST_ERR_VALIDATION', error: 'Bad Request', message: 'body/name must be string' })\n \n   // check response\n-  fastify.inject({\n+  const res5 = await fastify.inject({\n     method: 'POST',\n     url: '/42',\n     headers: { 'x-custom': 'me@me.me' },\n     query: { surname: 'bar' },\n     payload: { name: 'foo' }\n-  }, (err, res) => {\n-    t.error(err)\n-    t.equal(res.statusCode, 200)\n-    t.same(res.json(), { name: 'a', surname: 'b' })\n   })\n+  t.assert.strictEqual(res5.statusCode, 200)\n",
					"match": false,
					"packageHash": "0be15cb0f0d380f58a19531098e0d76f41826eb956d5396796c7f665473734bd",
					"size": 5889,
					"sourceHash": "ffc9f13f7d5af19ac1a7c3409a2a2b0b4e9b5e43b2dd879d37abd4683ef77d8c",
					"status": "content"
				},
				"test/genReqId.test.js": {
					"diff": "--- published/test/genReqId.test.js\n+++ rebuilt/test/genReqId.test.js\n@@ -1,9 +1,11 @@\n 'use strict'\n \n-const { test } = require('tap')\n+const { Readable } = require('node:stream')\n+const { test } = require('node:test')\n+const fp = require('fastify-plugin')\n const Fastify = require('..')\n \n-test('Should accept a custom genReqId function', t => {\n+test('Should accept a custom genReqId function', (t, done) => {\n   t.plan(4)\n \n   const fastify = Fastify({\n@@ -12,21 +14,413 @@\n     }\n   })\n \n+  t.after(() => fastify.close())\n   fastify.get('/', (req, reply) => {\n-    t.ok(req.id)\n+    t.assert.ok(req.id)\n     reply.send({ id: req.id })\n   })\n \n   fastify.listen({ port: 0 }, err => {\n-    t.error(err)\n+    t.assert.ifError(err)\n     fastify.inject({\n       method: 'GET',\n-      url: 'http://localhost:' + fastify.server.address().port\n+      url: `http://localhost:${fastify.server.address().port}`\n     }, (err, res) => {\n-      t.error(err)\n+      t.assert.ifError(err)\n       const payload = JSON.parse(res.payload)\n-      t.equal(payload.id, 'a')\n-      fastify.close()\n+      t.assert.strictEqual(payload.id, 'a')\n+      done()\n     })\n   })\n })\n+\n+test('Custom genReqId function gets raw request as argument', (t, done) => {\n+  t.plan(9)\n+\n+  const REQUEST_ID = 'REQ-1234'\n+\n+  const fastify = Fastify({\n+    genReqId: function (req) {\n+      t.assert.strictEqual('id' in req, false)\n+      t.assert.strictEqual('raw' in req, false)\n+      t.assert.ok(req instanceof Readable)\n+      // http.IncomingMessage does have `rawHeaders` property, but FastifyRequest does not\n+      const index = req.rawHeaders.indexOf('x-request-id')\n+      const xReqId = req.rawHeaders[index + 1]\n+      t.assert.strictEqual(xReqId, REQUEST_ID)\n+      t.assert.strictEqual(req.headers['x-request-id'], REQUEST_ID)\n+      return xReqId\n+    }\n+  })\n+  t.after(() => fastify.close())\n+\n+  fastify.get('/', (req, reply) => {\n+    t.assert.strictEqual(req.id, REQUEST_ID)\n+    reply.send({ id: req.id })\n+  })\n+\n+  fastify.listen({ port: 0 }, err => {\n+    t.assert.ifError(err)\n+    fastify.inject({\n+      method: 'GET',\n+      headers: {\n+        'x-request-id': REQUEST_ID\n+      },\n+      url: `http://localhost:${fastify.server.address().port}`\n+    }, (err, res) => {\n+      t.assert.ifError(err)\n+      const payload = JSON.parse(res.payload)\n+      t.assert.strictEqual(payload.id, REQUEST_ID)\n+      done()\n+    })\n+  })\n+})\n+\n+test('Should handle properly requestIdHeader option', t => {\n+  t.plan(4)\n+\n+  t.assert.strictEqual(Fastify({ requestIdHeader: '' }).initialConfig.requestIdHeader, false)\n+  t.assert.strictEqual(Fastify({ requestIdHeader: false }).initialConfig.requestIdHeader, false)\n+  t.assert.strictEqual(Fastify({ requestIdHeader: true }).initialConfig.requestIdHeader, 'request-id')\n+  t.assert.strictEqual(Fastify({ requestIdHeader: 'x-request-id' }).initialConfig.requestIdHeader, 'x-request-id')\n+})\n+\n+test('Should accept option to set genReqId with setGenReqId option', (t, done) => {\n+  t.plan(9)\n+\n",
					"match": false,
					"packageHash": "d9682498d473bddf7232a0da7f7cfc0cd3a731d10aa312d12833cfe2d2163d05",
					"size": 642,
					"sourceHash": "3117c5afec50bfd029f64290752c412a230b9886d3e35dce9b5bf92deec50f2c",
					"status": "content"
				},
				"test/get.test.js": {
					"match": false,
					"packageHash": "0e01a7e1efc0fd526ec3c57dd5c759a3ee69fafa3103bd3f8c0e7c0daf544f30",
					"size": 8215,
					"status": "missing-in-source"
				},
				"test/handler-context.test.js": {
					"diff": "--- published/test/handler-context.test.js\n+++ rebuilt/test/handler-context.test.js\n@@ -1,19 +1,9 @@\n 'use strict'\n+const { test } = require('node:test')\n+const { kRouteContext } = require('../lib/symbols')\n+const fastify = require('..')\n \n-const http = require('http')\n-const test = require('tap').test\n-const fastify = require('../')\n-\n-function getUrl (app) {\n-  const { address, port } = app.server.address()\n-  if (address === '::1') {\n-    return `http://[${address}]:${port}`\n-  } else {\n-    return `http://${address}:${port}`\n-  }\n-}\n-\n-test('handlers receive correct `this` context', (t) => {\n+test('handlers receive correct `this` context', async (t) => {\n   t.plan(4)\n \n   // simulate plugin that uses fastify-plugin\n@@ -27,37 +17,29 @@\n   instance.register(plugin)\n \n   instance.get('/', function (req, reply) {\n-    t.ok(this.foo)\n-    t.equal(this.foo, 'foo')\n+    t.assert.ok(this.foo)\n+    t.assert.strictEqual(this.foo, 'foo')\n     reply.send()\n   })\n \n-  instance.listen({ port: 0 }, (err) => {\n-    instance.server.unref()\n-    if (err) t.threw(err)\n-    t.ok(instance.foo)\n-    t.equal(instance.foo, 'foo')\n+  await instance.inject('/')\n \n-    http.get(getUrl(instance), () => {}).on('error', t.threw)\n-  })\n+  t.assert.ok(instance.foo)\n+  t.assert.strictEqual(instance.foo, 'foo')\n })\n \n-test('handlers have access to the internal context', (t) => {\n+test('handlers have access to the internal context', async (t) => {\n   t.plan(5)\n \n   const instance = fastify()\n   instance.get('/', { config: { foo: 'bar' } }, function (req, reply) {\n-    t.ok(reply.context)\n-    t.ok(reply.context.config)\n-    t.type(reply.context.config, Object)\n-    t.ok(reply.context.config.foo)\n-    t.equal(reply.context.config.foo, 'bar')\n+    t.assert.ok(reply[kRouteContext])\n+    t.assert.ok(reply[kRouteContext].config)\n+    t.assert.ok(typeof reply[kRouteContext].config, Object)\n+    t.assert.ok(reply[kRouteContext].config.foo)\n+    t.assert.strictEqual(reply[kRouteContext].config.foo, 'bar')\n     reply.send()\n   })\n \n-  instance.listen({ port: 0 }, (err) => {\n-    instance.server.unref()\n-    if (err) t.threw(err)\n-    http.get(getUrl(instance), () => {}).on('error', t.threw)\n-  })\n+  await instance.inject('/')\n })\n",
					"match": false,
					"packageHash": "c1b8002cfe1f8e59d271e2dcb14a15708905ffac89c9ae56851138f09e1f95f6",
					"size": 1508,
					"sourceHash": "94b0523a33fd9bbbb0feebdb753959f45a2dbd4813a88e493ebba1dc0a2f4d7d",
					"status": "content"
				},
				"test/head.test.js": {
					"match": false,
					"packageHash": "6d9f05299e463f547382deedba53dd3f0032ae7a94f8f00c9e6817cae0bd3baa",
					"size": 3262,
					"status": "missing-in-source"
				},
				"test/helper.js": {
					"diff": "--- published/test/helper.js\n+++ rebuilt/test/helper.js\n@@ -1,13 +1,17 @@\n 'use strict'\n \n-const sget = require('simple-get').concat\n-const dns = require('dns').promises\n-const stream = require('stream')\n+const dns = require('node:dns').promises\n+const stream = require('node:stream')\n+const { promisify } = require('node:util')\n const symbols = require('../lib/symbols')\n+const { waitForCb } = require('./toolkit')\n+const assert = require('node:assert')\n+\n+module.exports.sleep = promisify(setTimeout)\n \n /**\n  * @param method HTTP request method\n- * @param t tap instance\n+ * @param t node:test instance\n  * @param isSetErrorHandler true: using setErrorHandler\n  */\n module.exports.payloadMethod = function (method, t, isSetErrorHandler = false) {\n@@ -16,8 +20,8 @@\n \n   if (isSetErrorHandler) {\n     fastify.setErrorHandler(function (err, request, reply) {\n-      t.type(request, 'object')\n-      t.type(request, fastify[symbols.kRequest].parent)\n+      assert.ok(request instanceof fastify[symbols.kRequest].parent)\n+      assert.strictEqual(typeof request, 'object')\n       reply\n         .code(err.statusCode)\n         .type('application/json; charset=utf-8')\n@@ -49,9 +53,9 @@\n       fastify[loMethod]('/', schema, function (req, reply) {\n         reply.code(200).send(req.body)\n       })\n-      t.pass()\n+      t.assert.ok(true)\n     } catch (e) {\n-      t.fail()\n+      t.assert.fail()\n     }\n   })\n \n@@ -61,9 +65,9 @@\n       fastify[loMethod]('/missing', function (req, reply) {\n         reply.code(200).send(req.body)\n       })\n-      t.pass()\n+      t.assert.ok(true)\n     } catch (e) {\n-      t.fail()\n+      t.assert.fail()\n     }\n   })\n \n@@ -74,9 +78,9 @@\n         req.body.hello = req.body.hello + req.query.foo\n         reply.code(200).send(req.body)\n       })\n-      t.pass()\n+      t.assert.ok(true)\n     } catch (e) {\n-      t.fail()\n+      t.assert.fail()\n     }\n   })\n \n@@ -86,111 +90,114 @@\n       fastify[loMethod]('/with-limit', { bodyLimit: 1 }, function (req, reply) {\n         reply.send(req.body)\n       })\n-      t.pass()\n+      t.assert.ok(true)\n     } catch (e) {\n-      t.fail()\n+      t.assert.fail()\n     }\n   })\n \n   fastify.listen({ port: 0 }, function (err) {\n     if (err) {\n-      t.error(err)\n+      t.assert.ifError(err)\n       return\n     }\n \n-    t.teardown(() => { fastify.close() })\n+    t.after(() => { fastify.close() })\n \n-    test(`${upMethod} - correctly replies`, t => {\n+    test(`${upMethod} - correctly replies`, async (t) => {\n       t.plan(3)\n-      sget({\n+\n+      const result = await fetch('http://localhost:' + fastify.server.address().port, {\n         method: upMethod,\n",
					"match": false,
					"packageHash": "f95b5d4a6fd524e33237eac3852bfa12d2f3faa3f0b5f14dec21fcee80bb4288",
					"size": 11739,
					"sourceHash": "dba07923597734039f6a11bed12ebd79e9e743c5bd8c31dc028b6b767b1f4679",
					"status": "content"
				},
				"test/hooks-async.test.js": {
					"diff": "--- published/test/hooks-async.test.js\n+++ rebuilt/test/hooks-async.test.js\n@@ -1,18 +1,16 @@\n 'use strict'\n \n-const { Readable } = require('stream')\n-const t = require('tap')\n-const test = t.test\n-const sget = require('simple-get').concat\n+const { Readable } = require('node:stream')\n+const { test, describe } = require('node:test')\n const Fastify = require('../fastify')\n-const fs = require('fs')\n-const sleep = ms => new Promise(resolve => setTimeout(resolve, ms))\n+const fs = require('node:fs')\n+const { sleep } = require('./helper')\n+const { waitForCb } = require('./toolkit')\n \n process.removeAllListeners('warning')\n \n-test('async hooks', t => {\n-  t.plan(21)\n-\n+test('async hooks', async t => {\n+  t.plan(20)\n   const fastify = Fastify({ exposeHeadRoutes: false })\n   fastify.addHook('onRequest', async function (request, reply) {\n     await sleep(1)\n@@ -25,8 +23,8 @@\n \n   fastify.addHook('preHandler', async function (request, reply) {\n     await sleep(1)\n-    t.equal(request.test, 'the request is coming')\n-    t.equal(reply.test, 'the reply has come')\n+    t.assert.strictEqual(request.test, 'the request is coming')\n+    t.assert.strictEqual(reply.test, 'the reply has come')\n     if (request.raw.method === 'HEAD') {\n       throw new Error('some error')\n     }\n@@ -34,17 +32,21 @@\n \n   fastify.addHook('onSend', async function (request, reply, payload) {\n     await sleep(1)\n-    t.ok('onSend called')\n+    t.assert.ok('onSend called')\n   })\n \n+  const completion = waitForCb({\n+    steps: 6\n+  })\n   fastify.addHook('onResponse', async function (request, reply) {\n     await sleep(1)\n-    t.ok('onResponse called')\n+    t.assert.ok('onResponse called')\n+    completion.stepIn()\n   })\n \n   fastify.get('/', function (request, reply) {\n-    t.equal(request.test, 'the request is coming')\n-    t.equal(reply.test, 'the reply has come')\n+    t.assert.strictEqual(request.test, 'the request is coming')\n+    t.assert.strictEqual(reply.test, 'the reply has come')\n     reply.code(200).send({ hello: 'world' })\n   })\n \n@@ -56,39 +58,37 @@\n     reply.code(200).send({ hello: 'world' })\n   })\n \n-  fastify.listen({ port: 0 }, err => {\n-    t.error(err)\n-    t.teardown(() => { fastify.close() })\n+  const fastifyServer = await fastify.listen({ port: 0 })\n+  t.after(() => { fastify.close() })\n \n-    sget({\n-      method: 'GET',\n-      url: 'http://localhost:' + fastify.server.address().port\n-    }, (err, response, body) => {\n-      t.error(err)\n-      t.equal(response.statusCode, 200)\n-      t.equal(response.headers['content-length'], '' + body.length)\n-      t.same(JSON.parse(body), { hello: 'world' })\n-    })\n+  const response1 = await fetch(fastifyServer, {\n+    method: 'GET'\n+  })\n+  t.assert.ok(response1.ok)\n+  t.assert.strictEqual(response1.status, 200)\n+  const body1 = await response1.text()\n+  t.assert.strictEqual(response1.headers.get('content-length'), '' + body1.length)\n+  t.assert.deepStrictEqual(JSON.parse(body1), { hello: 'world' })\n+  completion.stepIn()\n \n-    sget({\n-      method: 'HEAD',\n-      url: 'http://localhost:' + fastify.server.address().port\n-    }, (err, response, body) => {\n-      t.error(err)\n-      t.equal(response.statusCode, 500)\n",
					"match": false,
					"packageHash": "935f423ff79bbf37ebf27801b026fbea76c459cb1df4a478a6accec6db41c025",
					"size": 18388,
					"sourceHash": "d545e2d99259d260bdf15a7401e16aa4a421f51771eaf195bcfb85c18363e2ef",
					"status": "content"
				},
				"test/hooks.on-ready.test.js": {
					"diff": "--- published/test/hooks.on-ready.test.js\n+++ rebuilt/test/hooks.on-ready.test.js\n@@ -1,41 +1,60 @@\n 'use strict'\n \n-const t = require('tap')\n+const { test } = require('node:test')\n const Fastify = require('../fastify')\n-const immediate = require('util').promisify(setImmediate)\n+const immediate = require('node:util').promisify(setImmediate)\n \n-t.test('onReady should be called in order', t => {\n+test('onReady should be called in order', (t, done) => {\n   t.plan(7)\n   const fastify = Fastify()\n \n   let order = 0\n \n   fastify.addHook('onReady', function (done) {\n-    t.equal(order++, 0, 'called in root')\n-    t.equal(this.pluginName, fastify.pluginName, 'the this binding is the right instance')\n+    t.assert.strictEqual(order++, 0, 'called in root')\n+    t.assert.strictEqual(this.pluginName, fastify.pluginName, 'the this binding is the right instance')\n     done()\n   })\n \n   fastify.register(async (childOne, o) => {\n     childOne.addHook('onReady', function (done) {\n-      t.equal(order++, 1, 'called in childOne')\n-      t.equal(this.pluginName, childOne.pluginName, 'the this binding is the right instance')\n+      t.assert.strictEqual(order++, 1, 'called in childOne')\n+      t.assert.strictEqual(this.pluginName, childOne.pluginName, 'the this binding is the right instance')\n       done()\n     })\n \n     childOne.register(async (childTwo, o) => {\n       childTwo.addHook('onReady', async function () {\n         await immediate()\n-        t.equal(order++, 2, 'called in childTwo')\n-        t.equal(this.pluginName, childTwo.pluginName, 'the this binding is the right instance')\n+        t.assert.strictEqual(order++, 2, 'called in childTwo')\n+        t.assert.strictEqual(this.pluginName, childTwo.pluginName, 'the this binding is the right instance')\n       })\n     })\n   })\n \n-  fastify.ready(err => t.error(err))\n+  fastify.ready(err => {\n+    t.assert.ifError(err)\n+    done()\n+  })\n+})\n+\n+test('onReady should be called once', async (t) => {\n+  const app = Fastify()\n+  let counter = 0\n+\n+  app.addHook('onReady', async function () {\n+    counter++\n+  })\n+\n+  const promises = [1, 2, 3, 4, 5].map((id) => app.ready().then(() => id))\n+\n+  const result = await Promise.race(promises)\n+\n+  t.assert.strictEqual(result, 1, 'Should resolve in order')\n+  t.assert.strictEqual(counter, 1, 'Should call onReady only once')\n })\n \n-t.test('async onReady should be called in order', async t => {\n+test('async onReady should be called in order', async t => {\n   t.plan(7)\n   const fastify = Fastify()\n \n@@ -43,31 +62,31 @@\n \n   fastify.addHook('onReady', async function () {\n     await immediate()\n-    t.equal(order++, 0, 'called in root')\n-    t.equal(this.pluginName, fastify.pluginName, 'the this binding is the right instance')\n+    t.assert.strictEqual(order++, 0, 'called in root')\n+    t.assert.strictEqual(this.pluginName, fastify.pluginName, 'the this binding is the right instance')\n   })\n \n   fastify.register(async (childOne, o) => {\n     childOne.addHook('onReady', async function () {\n       await immediate()\n-      t.equal(order++, 1, 'called in childOne')\n-      t.equal(this.pluginName, childOne.pluginName, 'the this binding is the right instance')\n+      t.assert.strictEqual(order++, 1, 'called in childOne')\n+      t.assert.strictEqual(this.pluginName, childOne.pluginName, 'the this binding is the right instance')\n     })\n \n     childOne.register(async (childTwo, o) => {\n       childTwo.addHook('onReady', async function () {\n         await immediate()\n-        t.equal(order++, 2, 'called in childTwo')\n-        t.equal(this.pluginName, childTwo.pluginName, 'the this binding is the right instance')\n+        t.assert.strictEqual(order++, 2, 'called in childTwo')\n+        t.assert.strictEqual(this.pluginName, childTwo.pluginName, 'the this binding is the right instance')\n",
					"match": false,
					"packageHash": "2257a631a4e5bef9d6a9be94e485bb96794bb82b68ee3b8ff43ed40a0eab1709",
					"size": 9210,
					"sourceHash": "100ae847e9c05c350357fd546ad48b1696e93b4915106b7c2112073567ec133d",
					"status": "content"
				},
				"test/hooks.test.js": {
					"diff": "--- published/test/hooks.test.js\n+++ rebuilt/test/hooks.test.js\n@@ -1,90 +1,99 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n-const sget = require('simple-get').concat\n-const stream = require('stream')\n+const { test } = require('node:test')\n+const stream = require('node:stream')\n const Fastify = require('..')\n const fp = require('fastify-plugin')\n-const fs = require('fs')\n+const fs = require('node:fs')\n const split = require('split2')\n const symbols = require('../lib/symbols.js')\n const payload = { hello: 'world' }\n+const proxyquire = require('proxyquire')\n+const { connect } = require('node:net')\n+const { sleep } = require('./helper')\n+const { waitForCb } = require('./toolkit.js')\n \n process.removeAllListeners('warning')\n \n-function getUrl (app) {\n-  const { address, port } = app.server.address()\n-  if (address === '::1') {\n-    return `http://[${address}]:${port}`\n-  } else {\n-    return `http://${address}:${port}`\n-  }\n-}\n-\n-test('hooks', t => {\n-  t.plan(43)\n+test('hooks', async t => {\n+  t.plan(48)\n   const fastify = Fastify({ exposeHeadRoutes: false })\n \n   try {\n     fastify.addHook('preHandler', function (request, reply, done) {\n-      t.equal(request.test, 'the request is coming')\n-      t.equal(reply.test, 'the reply has come')\n+      t.assert.strictEqual(request.test, 'the request is coming')\n+      t.assert.strictEqual(reply.test, 'the reply has come')\n       if (request.raw.method === 'HEAD') {\n         done(new Error('some error'))\n       } else {\n         done()\n       }\n     })\n-    t.pass()\n+    t.assert.ok('should pass')\n+  } catch (e) {\n+    t.assert.fail()\n+  }\n+\n+  try {\n+    fastify.addHook('preHandler', null)\n   } catch (e) {\n-    t.fail()\n+    t.assert.strictEqual(e.code, 'FST_ERR_HOOK_INVALID_HANDLER')\n+    t.assert.strictEqual(e.message, 'preHandler hook should be a function, instead got null')\n+    t.assert.ok('should pass')\n+  }\n+\n+  try {\n+    fastify.addHook('preParsing')\n+  } catch (e) {\n+    t.assert.strictEqual(e.code, 'FST_ERR_HOOK_INVALID_HANDLER')\n+    t.assert.strictEqual(e.message, 'preParsing hook should be a function, instead got undefined')\n+    t.assert.ok('should pass')\n   }\n \n   try {\n     fastify.addHook('preParsing', function (request, reply, payload, done) {\n       request.preParsing = true\n-      t.equal(request.test, 'the request is coming')\n-      t.equal(reply.test, 'the reply has come')\n+      t.assert.strictEqual(request.test, 'the request is coming')\n+      t.assert.strictEqual(reply.test, 'the reply has come')\n       done()\n     })\n-    t.pass()\n+    t.assert.ok('should pass')\n   } catch (e) {\n-    t.fail()\n+    t.assert.fail()\n   }\n \n   try {\n     fastify.addHook('preParsing', function (request, reply, payload, done) {\n       request.preParsing = true\n-      t.equal(request.test, 'the request is coming')\n-      t.equal(reply.test, 'the reply has come')\n+      t.assert.strictEqual(request.test, 'the request is coming')\n+      t.assert.strictEqual(reply.test, 'the reply has come')\n       done()\n     })\n",
					"match": false,
					"packageHash": "b73b7a6bf62a6f6655a461792880b08c9d9d88c503fcdbf91c3be1a82f014065",
					"size": 77704,
					"sourceHash": "6ce300683c129d74b59ba31c965cd40c3941218f39750590a8a01eeee6c505f3",
					"status": "content"
				},
				"test/http2/closing.test.js": {
					"diff": "--- published/test/http2/closing.test.js\n+++ rebuilt/test/http2/closing.test.js\n@@ -1,118 +1,121 @@\n 'use strict'\n \n-const t = require('tap')\n+const { test } = require('node:test')\n const Fastify = require('../..')\n-const http2 = require('http2')\n-const { promisify } = require('util')\n+const http2 = require('node:http2')\n+const { promisify } = require('node:util')\n const connect = promisify(http2.connect)\n-const { once } = require('events')\n-\n+const { once } = require('node:events')\n const { buildCertificate } = require('../build-certificate')\n-t.before(buildCertificate)\n+const { getServerUrl } = require('../helper')\n+const { kHttp2ServerSessions } = require('../../lib/symbols')\n \n-function getUrl (app) {\n-  const { address, port } = app.server.address()\n-  if (address === '::1') {\n-    return `http://[${address}]:${port}`\n-  } else {\n-    return `http://${address}:${port}`\n-  }\n-}\n-\n-t.test('http/2 request while fastify closing', t => {\n-  let fastify\n-  try {\n-    fastify = Fastify({\n-      http2: true\n-    })\n-    t.pass('http2 successfully loaded')\n-  } catch (e) {\n-    t.fail('http2 loading failed', e)\n-  }\n+test.before(buildCertificate)\n+\n+const isNode24OrGreater = Number(process.versions.node.split('.')[0]) >= 24\n+\n+test('http/2 request while fastify closing Node <24', { skip: isNode24OrGreater }, (t, done) => {\n+  const fastify = Fastify({\n+    http2: true\n+  })\n+  t.assert.ok('http2 successfully loaded')\n \n   fastify.get('/', () => Promise.resolve({}))\n \n+  t.after(() => { fastify.close() })\n   fastify.listen({ port: 0 }, err => {\n-    t.error(err)\n-    t.teardown(() => { fastify.close() })\n+    t.assert.ifError(err)\n \n-    t.test('return 200', t => {\n-      const url = getUrl(fastify)\n-      const session = http2.connect(url, function () {\n-        this.request({\n-          ':method': 'GET',\n-          ':path': '/'\n-        }).on('response', headers => {\n-          t.equal(headers[':status'], 503)\n-          t.end()\n-          this.destroy()\n-        }).on('error', () => {\n-          // Nothing to do here,\n-          // we are not interested in this error that might\n-          // happen or not\n-        })\n-        fastify.close()\n+    const url = getServerUrl(fastify)\n+    const session = http2.connect(url, function () {\n+      this.request({\n+        ':method': 'GET',\n+        ':path': '/'\n+      }).on('response', headers => {\n+        t.assert.strictEqual(headers[':status'], 503)\n+        done()\n+        this.destroy()\n+      }).on('error', () => {\n+        // Nothing to do here,\n+        // we are not interested in this error that might\n+        // happen or not\n       })\n       session.on('error', () => {\n         // Nothing to do here,\n         // we are not interested in this error that might\n         // happen or not\n-        t.end()\n+        done()\n       })\n+      fastify.close()\n     })\n-\n-    t.end()\n   })\n",
					"match": false,
					"packageHash": "d1179cd49f6d69ba9eb110376855fe67f73d7034e49a7672fedd5981df106391",
					"size": 4334,
					"sourceHash": "0b8fab2fa58da065071a08d6d1f17042a33c8e0a6ee8a3da6adb0b64db4d279c",
					"status": "content"
				},
				"test/http2/constraint.test.js": {
					"diff": "--- published/test/http2/constraint.test.js\n+++ rebuilt/test/http2/constraint.test.js\n@@ -1,7 +1,6 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const Fastify = require('../..')\n const h2url = require('h2url')\n \n@@ -9,9 +8,9 @@\n const beta = { res: 'beta' }\n \n const { buildCertificate } = require('../build-certificate')\n-t.before(buildCertificate)\n+test.before(buildCertificate)\n \n-test('A route supports host constraints under http2 protocol and secure connection', (t) => {\n+test('A route supports host constraints under http2 protocol and secure connection', async (t) => {\n   t.plan(5)\n \n   let fastify\n@@ -23,12 +22,12 @@\n         cert: global.context.cert\n       }\n     })\n-    t.pass('Key/cert successfully loaded')\n+    t.assert.ok(true, 'Key/cert successfully loaded')\n   } catch (e) {\n-    t.fail('Key/cert loading failed', e)\n+    t.assert.fail('Key/cert loading failed')\n   }\n \n-  const constrain = 'fastify.io'\n+  const constrain = 'fastify.dev'\n \n   fastify.route({\n     method: 'GET',\n@@ -45,47 +44,66 @@\n       reply.code(200).send(beta)\n     }\n   })\n+  fastify.route({\n+    method: 'GET',\n+    url: '/hostname_port',\n+    constraints: { host: constrain },\n+    handler: function (req, reply) {\n+      reply.code(200).send({ ...beta, hostname: req.hostname })\n+    }\n+  })\n+  t.after(() => { fastify.close() })\n \n-  fastify.listen({ port: 0 }, err => {\n-    t.error(err)\n-    t.teardown(() => { fastify.close() })\n-\n-    t.test('https get request - no constrain', async (t) => {\n-      t.plan(3)\n-\n-      const url = `https://localhost:${fastify.server.address().port}`\n-      const res = await h2url.concat({ url })\n-\n-      t.equal(res.headers[':status'], 200)\n-      t.equal(res.headers['content-length'], '' + JSON.stringify(alpha).length)\n-      t.same(JSON.parse(res.body), alpha)\n-    })\n+  await fastify.listen({ port: 0 })\n+\n+  await t.test('https get request - no constrain', async (t) => {\n+    t.plan(3)\n \n-    t.test('https get request - constrain', async (t) => {\n-      t.plan(3)\n+    const url = `https://localhost:${fastify.server.address().port}`\n+    const res = await h2url.concat({ url })\n+\n+    t.assert.strictEqual(res.headers[':status'], 200)\n+    t.assert.strictEqual(res.headers['content-length'], '' + JSON.stringify(alpha).length)\n+    t.assert.deepStrictEqual(JSON.parse(res.body), alpha)\n+  })\n \n-      const url = `https://localhost:${fastify.server.address().port}/beta`\n-      const res = await h2url.concat({\n-        url,\n-        headers: {\n-          ':authority': constrain\n-        }\n-      })\n-\n-      t.equal(res.headers[':status'], 200)\n-      t.equal(res.headers['content-length'], '' + JSON.stringify(beta).length)\n-      t.same(JSON.parse(res.body), beta)\n+  await t.test('https get request - constrain', async (t) => {\n+    t.plan(3)\n+\n+    const url = `https://localhost:${fastify.server.address().port}/beta`\n+    const res = await h2url.concat({\n+      url,\n+      headers: {\n",
					"match": false,
					"packageHash": "de34e3cf298f6f69a123815c7009e9c965d771dd26ebf555ac11788c16d7270c",
					"size": 2186,
					"sourceHash": "3809c8d17ad51b23827663407b034cb80941f1d0207dc781ef62e0ac00b38045",
					"status": "content"
				},
				"test/http2/head.test.js": {
					"diff": "--- published/test/http2/head.test.js\n+++ rebuilt/test/http2/head.test.js\n@@ -1,35 +1,34 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const Fastify = require('../..')\n const h2url = require('h2url')\n const msg = { hello: 'world' }\n \n-let fastify\n-try {\n-  fastify = Fastify({\n-    http2: true\n-  })\n-  t.pass('http2 successfully loaded')\n-} catch (e) {\n-  t.fail('http2 loading failed', e)\n-}\n+test('http2 HEAD test', async (t) => {\n+  let fastify\n+  try {\n+    fastify = Fastify({\n+      http2: true\n+    })\n+    t.assert.ok(true, 'http2 successfully loaded')\n+  } catch (e) {\n+    t.assert.fail('http2 loading failed')\n+  }\n \n-fastify.all('/', function (req, reply) {\n-  reply.code(200).send(msg)\n-})\n+  fastify.all('/', function (req, reply) {\n+    reply.code(200).send(msg)\n+  })\n+  t.after(() => { fastify.close() })\n \n-fastify.listen({ port: 0 }, err => {\n-  t.error(err)\n-  t.teardown(() => { fastify.close() })\n+  await fastify.listen({ port: 0 })\n \n-  test('http HEAD request', async (t) => {\n+  await t.test('http HEAD request', async (t) => {\n     t.plan(1)\n \n     const url = `http://localhost:${fastify.server.address().port}`\n     const res = await h2url.concat({ url, method: 'HEAD' })\n \n-    t.equal(res.headers[':status'], 200)\n+    t.assert.strictEqual(res.headers[':status'], 200)\n   })\n })\n",
					"match": false,
					"packageHash": "43db15c9a0b513e047efc4eecbbe2a50b461b3c435de7a602fbb97d72b94e90d",
					"size": 709,
					"sourceHash": "84d7275c09d9b5da10b050e86600c2d201091e3372944f7a6ac9e958af220f56",
					"status": "content"
				},
				"test/http2/missing-http2-module.test.js": {
					"match": false,
					"packageHash": "aaf2d9f334d7150f74383cc45c82c3196f3fbc89151f1870811eb05fa58403f9",
					"size": 544,
					"status": "missing-in-source"
				},
				"test/http2/plain.test.js": {
					"diff": "--- published/test/http2/plain.test.js\n+++ rebuilt/test/http2/plain.test.js\n@@ -1,53 +1,68 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const Fastify = require('../..')\n const h2url = require('h2url')\n const msg = { hello: 'world' }\n \n-let fastify\n-try {\n-  fastify = Fastify({\n-    http2: true\n-  })\n-  t.pass('http2 successfully loaded')\n-} catch (e) {\n-  t.fail('http2 loading failed', e)\n-}\n+test('http2 plain test', async t => {\n+  let fastify\n+  try {\n+    fastify = Fastify({\n+      http2: true\n+    })\n+    t.assert.ok(true, 'http2 successfully loaded')\n+  } catch (e) {\n+    t.assert.fail('http2 loading failed')\n+  }\n \n-fastify.get('/', function (req, reply) {\n-  reply.code(200).send(msg)\n-})\n+  fastify.get('/', function (req, reply) {\n+    reply.code(200).send(msg)\n+  })\n \n-fastify.get('/hostname', function (req, reply) {\n-  reply.code(200).send(req.hostname)\n-})\n+  fastify.get('/host', function (req, reply) {\n+    reply.code(200).send(req.host)\n+  })\n+\n+  fastify.get('/hostname_port', function (req, reply) {\n+    reply.code(200).send({ hostname: req.hostname, port: req.port })\n+  })\n \n-fastify.listen({ port: 0 }, err => {\n-  t.error(err)\n-  t.teardown(() => { fastify.close() })\n+  t.after(() => { fastify.close() })\n \n-  test('http get request', async (t) => {\n+  await fastify.listen({ port: 0 })\n+\n+  await t.test('http get request', async (t) => {\n     t.plan(3)\n \n     const url = `http://localhost:${fastify.server.address().port}`\n     const res = await h2url.concat({ url })\n \n-    t.equal(res.headers[':status'], 200)\n-    t.equal(res.headers['content-length'], '' + JSON.stringify(msg).length)\n+    t.assert.strictEqual(res.headers[':status'], 200)\n+    t.assert.strictEqual(res.headers['content-length'], '' + JSON.stringify(msg).length)\n \n-    t.same(JSON.parse(res.body), msg)\n+    t.assert.deepStrictEqual(JSON.parse(res.body), msg)\n   })\n \n-  test('http hostname', async (t) => {\n+  await t.test('http host', async (t) => {\n     t.plan(1)\n \n-    const hostname = `localhost:${fastify.server.address().port}`\n+    const host = `localhost:${fastify.server.address().port}`\n+\n+    const url = `http://${host}/host`\n+    const res = await h2url.concat({ url })\n+\n+    t.assert.strictEqual(res.body, host)\n+  })\n+  await t.test('http hostname and port', async (t) => {\n+    t.plan(2)\n+\n+    const host = `localhost:${fastify.server.address().port}`\n \n-    const url = `http://${hostname}/hostname`\n+    const url = `http://${host}/hostname_port`\n     const res = await h2url.concat({ url })\n \n-    t.equal(res.body, hostname)\n+    t.assert.strictEqual(JSON.parse(res.body).hostname, host.split(':')[0])\n+    t.assert.strictEqual(JSON.parse(res.body).port, parseInt(host.split(':')[1]))\n   })\n })\n",
					"match": false,
					"packageHash": "033207aac2d0920d7e10c2b140b0b5e22e6f4b5233faea72eece4f4217b3b179",
					"size": 1147,
					"sourceHash": "f45e2d86539cf03e4c9e9c41c9a1e1deeeda478570f0baa57079cb57aa485b75",
					"status": "content"
				},
				"test/http2/secure-with-fallback.test.js": {
					"diff": "--- published/test/http2/secure-with-fallback.test.js\n+++ rebuilt/test/http2/secure-with-fallback.test.js\n@@ -1,17 +1,16 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const Fastify = require('../..')\n const h2url = require('h2url')\n-const sget = require('simple-get').concat\n const msg = { hello: 'world' }\n \n const { buildCertificate } = require('../build-certificate')\n-t.before(buildCertificate)\n+const { Agent } = require('undici')\n+test.before(buildCertificate)\n \n-test('secure with fallback', (t) => {\n-  t.plan(7)\n+test('secure with fallback', async (t) => {\n+  t.plan(6)\n \n   let fastify\n   try {\n@@ -23,9 +22,9 @@\n         cert: global.context.cert\n       }\n     })\n-    t.pass('Key/cert successfully loaded')\n+    t.assert.ok(true, 'Key/cert successfully loaded')\n   } catch (e) {\n-    t.fail('Key/cert loading failed', e)\n+    t.assert.fail('Key/cert loading failed')\n   }\n \n   fastify.get('/', function (req, reply) {\n@@ -40,71 +39,75 @@\n     throw new Error('kaboom')\n   })\n \n-  fastify.listen({ port: 0 }, err => {\n-    t.error(err)\n-    t.teardown(() => { fastify.close() })\n+  t.after(() => fastify.close())\n \n-    t.test('https get error', async (t) => {\n-      t.plan(1)\n+  const fastifyServer = await fastify.listen({ port: 0 })\n \n-      const url = `https://localhost:${fastify.server.address().port}/error`\n-      const res = await h2url.concat({ url })\n+  await t.test('https get error', async (t) => {\n+    t.plan(1)\n \n-      t.equal(res.headers[':status'], 500)\n-    })\n+    const url = `${fastifyServer}/error`\n+    const res = await h2url.concat({ url })\n \n-    t.test('https post', async (t) => {\n-      t.plan(2)\n+    t.assert.strictEqual(res.headers[':status'], 500)\n+  })\n \n-      const url = `https://localhost:${fastify.server.address().port}`\n-      const res = await h2url.concat({\n-        url,\n-        method: 'POST',\n-        body: JSON.stringify({ hello: 'http2' }),\n-        headers: {\n-          'content-type': 'application/json'\n-        }\n-      })\n+  await t.test('https post', async (t) => {\n+    t.plan(2)\n \n-      t.equal(res.headers[':status'], 200)\n-      t.same(JSON.parse(res.body), { hello: 'http2' })\n+    const res = await h2url.concat({\n+      url: fastifyServer,\n+      method: 'POST',\n+      body: JSON.stringify({ hello: 'http2' }),\n+      headers: {\n+        'content-type': 'application/json'\n+      }\n     })\n \n-    t.test('https get request', async (t) => {\n-      t.plan(3)\n+    t.assert.strictEqual(res.headers[':status'], 200)\n+    t.assert.deepStrictEqual(JSON.parse(res.body), { hello: 'http2' })\n+  })\n+\n+  await t.test('https get request', async (t) => {\n+    t.plan(3)\n \n-      const url = `https://localhost:${fastify.server.address().port}`\n-      const res = await h2url.concat({ url })\n+    const res = await h2url.concat({ url: fastifyServer })\n",
					"match": false,
					"packageHash": "f10ebe350101dfb51436849aed7bd255f955b29f1b376dff6bebe08b9b72267a",
					"size": 2772,
					"sourceHash": "5dc63ba8cb140798ba9d18c27a96df986f2056d67c58d33467d450c87296c57c",
					"status": "content"
				},
				"test/http2/secure.test.js": {
					"diff": "--- published/test/http2/secure.test.js\n+++ rebuilt/test/http2/secure.test.js\n@@ -1,15 +1,14 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const Fastify = require('../..')\n const h2url = require('h2url')\n const msg = { hello: 'world' }\n \n const { buildCertificate } = require('../build-certificate')\n-t.before(buildCertificate)\n+test.before(buildCertificate)\n \n-test('secure', (t) => {\n+test('secure', async (t) => {\n   t.plan(4)\n \n   let fastify\n@@ -21,9 +20,9 @@\n         cert: global.context.cert\n       }\n     })\n-    t.pass('Key/cert successfully loaded')\n+    t.assert.ok(true, 'Key/cert successfully loaded')\n   } catch (e) {\n-    t.fail('Key/cert loading failed', e)\n+    t.assert.fail('Key/cert loading failed')\n   }\n \n   fastify.get('/', function (req, reply) {\n@@ -32,28 +31,37 @@\n   fastify.get('/proto', function (req, reply) {\n     reply.code(200).send({ proto: req.protocol })\n   })\n+  fastify.get('/hostname_port', function (req, reply) {\n+    reply.code(200).send({ hostname: req.hostname, port: req.port })\n+  })\n \n-  fastify.listen({ port: 0 }, err => {\n-    t.error(err)\n-    t.teardown(() => { fastify.close() })\n-\n-    t.test('https get request', async (t) => {\n-      t.plan(3)\n-\n-      const url = `https://localhost:${fastify.server.address().port}`\n-      const res = await h2url.concat({ url })\n-\n-      t.equal(res.headers[':status'], 200)\n-      t.equal(res.headers['content-length'], '' + JSON.stringify(msg).length)\n-      t.same(JSON.parse(res.body), msg)\n-    })\n+  t.after(() => { fastify.close() })\n+  await fastify.listen({ port: 0 })\n \n-    t.test('https get request without trust proxy - protocol', async (t) => {\n-      t.plan(2)\n+  await t.test('https get request', async (t) => {\n+    t.plan(3)\n \n-      const url = `https://localhost:${fastify.server.address().port}/proto`\n-      t.same(JSON.parse((await h2url.concat({ url })).body), { proto: 'https' })\n-      t.same(JSON.parse((await h2url.concat({ url, headers: { 'X-Forwarded-Proto': 'lorem' } })).body), { proto: 'https' })\n-    })\n+    const url = `https://localhost:${fastify.server.address().port}`\n+    const res = await h2url.concat({ url })\n+\n+    t.assert.strictEqual(res.headers[':status'], 200)\n+    t.assert.strictEqual(res.headers['content-length'], '' + JSON.stringify(msg).length)\n+    t.assert.deepStrictEqual(JSON.parse(res.body), msg)\n+  })\n+\n+  await t.test('https get request without trust proxy - protocol', async (t) => {\n+    t.plan(2)\n+\n+    const url = `https://localhost:${fastify.server.address().port}/proto`\n+    t.assert.deepStrictEqual(JSON.parse((await h2url.concat({ url })).body), { proto: 'https' })\n+    t.assert.deepStrictEqual(JSON.parse((await h2url.concat({ url, headers: { 'X-Forwarded-Proto': 'lorem' } })).body), { proto: 'https' })\n+  })\n+  await t.test('https get request - test hostname and port', async (t) => {\n+    t.plan(2)\n+\n+    const url = `https://localhost:${fastify.server.address().port}/hostname_port`\n+    const parsedbody = JSON.parse((await h2url.concat({ url })).body)\n+    t.assert.strictEqual(parsedbody.hostname, 'localhost')\n+    t.assert.strictEqual(parsedbody.port, fastify.server.address().port)\n   })\n })\n",
					"match": false,
					"packageHash": "87d9f13c024c2c9f96d8b92900544a03f552816d6ed65da3f15370a975cc4d1a",
					"size": 1572,
					"sourceHash": "99517e5a1bd8bc132db861783176861d4aed443b8c4aaa40b10ee02c011c8745",
					"status": "content"
				},
				"test/http2/unknown-http-method.test.js": {
					"diff": "--- published/test/http2/unknown-http-method.test.js\n+++ rebuilt/test/http2/unknown-http-method.test.js\n@@ -1,32 +1,32 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const Fastify = require('../..')\n const h2url = require('h2url')\n const msg = { hello: 'world' }\n \n-const fastify = Fastify({\n-  http2: true\n-})\n-\n-fastify.get('/', function (req, reply) {\n-  reply.code(200).send(msg)\n-})\n-\n-fastify.listen({ port: 0 }, err => {\n-  t.error(err)\n-  t.teardown(() => { fastify.close() })\n+test('http2 unknown http method', async t => {\n+  const fastify = Fastify({\n+    http2: true\n+  })\n+\n+  fastify.get('/', function (req, reply) {\n+    reply.code(200).send(msg)\n+  })\n \n-  test('http UNKNOWN_METHOD request', async (t) => {\n+  t.after(() => { fastify.close() })\n+  await fastify.listen({ port: 0 })\n+\n+  await t.test('http UNKNOWN_METHOD request', async (t) => {\n     t.plan(2)\n \n     const url = `http://localhost:${fastify.server.address().port}`\n     const res = await h2url.concat({ url, method: 'UNKNOWN_METHOD' })\n \n-    t.equal(res.headers[':status'], 404)\n-    t.same(JSON.parse(res.body), {\n+    t.assert.strictEqual(res.headers[':status'], 404)\n+    t.assert.deepStrictEqual(JSON.parse(res.body), {\n       statusCode: 404,\n+      code: 'FST_ERR_NOT_FOUND',\n       error: 'Not Found',\n       message: 'Not Found'\n     })\n",
					"match": false,
					"packageHash": "c04035b1fbc4904a283b2de2b0d6d3e4e27cbc4ba48da5e79fc60aaab567964b",
					"size": 739,
					"sourceHash": "59c370aec844facd9932d2971d7bc0248092e7b7a31c6fd2306b785860b27bee",
					"status": "content"
				},
				"test/https/custom-https-server.test.js": {
					"diff": "--- published/test/https/custom-https-server.test.js\n+++ rebuilt/test/https/custom-https-server.test.js\n@@ -1,59 +1,58 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const Fastify = require('../..')\n-const https = require('https')\n-const sget = require('simple-get').concat\n-const dns = require('dns').promises\n-\n+const https = require('node:https')\n+const dns = require('node:dns').promises\n const { buildCertificate } = require('../build-certificate')\n-t.before(buildCertificate)\n+const { Agent } = require('undici')\n+\n+async function setup () {\n+  await buildCertificate()\n \n-test('Should support a custom https server', async t => {\n   const localAddresses = await dns.lookup('localhost', { all: true })\n \n-  t.plan(localAddresses.length + 3)\n+  test('Should support a custom https server', { skip: localAddresses.length < 1 }, async t => {\n+    t.plan(5)\n \n-  const serverFactory = (handler, opts) => {\n-    t.ok(opts.serverFactory, 'it is called twice for every HOST interface')\n+    const fastify = Fastify({\n+      serverFactory: (handler, opts) => {\n+        t.assert.ok(opts.serverFactory, 'it is called once for localhost')\n+\n+        const options = {\n+          key: global.context.key,\n+          cert: global.context.cert\n+        }\n+\n+        const server = https.createServer(options, (req, res) => {\n+          req.custom = true\n+          handler(req, res)\n+        })\n \n-    const options = {\n-      key: global.context.key,\n-      cert: global.context.cert\n-    }\n-\n-    const server = https.createServer(options, (req, res) => {\n-      req.custom = true\n-      handler(req, res)\n+        return server\n+      }\n     })\n \n-    return server\n-  }\n-\n-  const fastify = Fastify({ serverFactory })\n-\n-  t.teardown(fastify.close.bind(fastify))\n+    t.after(() => { fastify.close() })\n \n-  fastify.get('/', (req, reply) => {\n-    t.ok(req.raw.custom)\n-    reply.send({ hello: 'world' })\n-  })\n+    fastify.get('/', (req, reply) => {\n+      t.assert.ok(req.raw.custom)\n+      reply.send({ hello: 'world' })\n+    })\n \n-  await fastify.listen({ port: 0 })\n+    await fastify.listen({ port: 0 })\n \n-  await new Promise((resolve, reject) => {\n-    sget({\n-      method: 'GET',\n-      url: 'https://localhost:' + fastify.server.address().port,\n-      rejectUnauthorized: false\n-    }, (err, response, body) => {\n-      if (err) {\n-        return reject(err)\n-      }\n-      t.equal(response.statusCode, 200)\n-      t.same(JSON.parse(body), { hello: 'world' })\n-      resolve()\n+    const result = await fetch('https://localhost:' + fastify.server.address().port, {\n+      dispatcher: new Agent({\n+        connect: {\n+          rejectUnauthorized: false\n+        }\n+      })\n     })\n+    t.assert.ok(result.ok)\n+    t.assert.strictEqual(result.status, 200)\n+    t.assert.deepStrictEqual(await result.json(), { hello: 'world' })\n   })\n",
					"match": false,
					"packageHash": "9f5d20bb0f64fc9d72dca053843163d0724ee3388f106d7d8b5c3c6525fdeaa6",
					"size": 1422,
					"sourceHash": "776bd68fa095ccc8f7fbb75c9a870b6a8e040e94e22821335e3c75b90352d024",
					"status": "content"
				},
				"test/https/https.test.js": {
					"diff": "--- published/test/https/https.test.js\n+++ rebuilt/test/https/https.test.js\n@@ -1,15 +1,15 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n-const sget = require('simple-get').concat\n+const { test } = require('node:test')\n+const { request } = require('undici')\n const Fastify = require('../..')\n \n const { buildCertificate } = require('../build-certificate')\n-t.before(buildCertificate)\n+const { Agent } = require('undici')\n+test.before(buildCertificate)\n \n-test('https', (t) => {\n-  t.plan(4)\n+test('https', async (t) => {\n+  t.plan(3)\n \n   let fastify\n   try {\n@@ -19,9 +19,9 @@\n         cert: global.context.cert\n       }\n     })\n-    t.pass('Key/cert successfully loaded')\n+    t.assert.ok('Key/cert successfully loaded')\n   } catch (e) {\n-    t.fail('Key/cert loading failed', e)\n+    t.assert.fail('Key/cert loading failed')\n   }\n \n   fastify.get('/', function (req, reply) {\n@@ -32,45 +32,105 @@\n     reply.code(200).send({ proto: req.protocol })\n   })\n \n-  fastify.listen({ port: 0 }, err => {\n-    t.error(err)\n-    t.teardown(() => { fastify.close() })\n-\n-    t.test('https get request', t => {\n-      t.plan(4)\n-      sget({\n-        method: 'GET',\n-        url: 'https://localhost:' + fastify.server.address().port,\n-        rejectUnauthorized: false\n-      }, (err, response, body) => {\n-        t.error(err)\n-        t.equal(response.statusCode, 200)\n-        t.equal(response.headers['content-length'], '' + body.length)\n-        t.same(JSON.parse(body), { hello: 'world' })\n+  await fastify.listen({ port: 0 })\n+\n+  t.after(() => { fastify.close() })\n+\n+  await t.test('https get request', async t => {\n+    t.plan(4)\n+    const result = await fetch('https://localhost:' + fastify.server.address().port, {\n+      dispatcher: new Agent({\n+        connect: {\n+          rejectUnauthorized: false\n+        }\n       })\n     })\n+    t.assert.ok(result.ok)\n+    t.assert.strictEqual(result.status, 200)\n+    const body = await result.text()\n+    t.assert.strictEqual(result.headers.get('content-length'), '' + body.length)\n+    t.assert.deepStrictEqual(JSON.parse(body), { hello: 'world' })\n+  })\n+\n+  await t.test('https get request without trust proxy - protocol', async t => {\n+    t.plan(3)\n+    const result1 = await fetch(`${'https://localhost:' + fastify.server.address().port}/proto`, {\n+      dispatcher: new Agent({\n+        connect: {\n+          rejectUnauthorized: false\n+        }\n+      })\n+    })\n+    t.assert.ok(result1.ok)\n+    t.assert.deepStrictEqual(await result1.json(), { proto: 'https' })\n+\n+    const result2 = await fetch(`${'https://localhost:' + fastify.server.address().port}/proto`, {\n+      dispatcher: new Agent({\n+        connect: {\n+          rejectUnauthorized: false\n+        }\n+      }),\n+      headers: {\n+        'x-forwarded-proto': 'lorem'\n+      }\n+    })\n+    t.assert.deepStrictEqual(await result2.json(), { proto: 'https' })\n+  })\n+})\n",
					"match": false,
					"packageHash": "8183ad6bc87a402f74a5655cd61ce8a9e0eba609f3f820dec902672064fa2087",
					"size": 1940,
					"sourceHash": "5e48f317c7a0ae6330bd61d51415a3bcfd5e923c8cf15d29ff6e15bb01cf3574",
					"status": "content"
				},
				"test/imports.test.js": {
					"diff": "--- published/test/imports.test.js\n+++ rebuilt/test/imports.test.js\n@@ -1,18 +1,17 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n \n test('should import as default', t => {\n   t.plan(2)\n   const fastify = require('..')\n-  t.ok(fastify)\n-  t.equal(typeof fastify, 'function')\n+  t.assert.ok(fastify)\n+  t.assert.strictEqual(typeof fastify, 'function')\n })\n \n test('should import as esm', t => {\n   t.plan(2)\n   const { fastify } = require('..')\n-  t.ok(fastify)\n-  t.equal(typeof fastify, 'function')\n+  t.assert.ok(fastify)\n+  t.assert.strictEqual(typeof fastify, 'function')\n })\n",
					"match": false,
					"packageHash": "c647c984bf8ba1b5e63bacca7c821f393516bd2a6506bb041bf54e6dfe36363b",
					"size": 343,
					"sourceHash": "8c962510b754f0a3769a4cb9ead5264ec89a6f54c9f03a688e27b14f0d6d03c7",
					"status": "content"
				},
				"test/inject.test.js": {
					"diff": "--- published/test/inject.test.js\n+++ rebuilt/test/inject.test.js\n@@ -1,20 +1,19 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n-const Stream = require('stream')\n-const util = require('util')\n+const { test } = require('node:test')\n+const Stream = require('node:stream')\n+const util = require('node:util')\n const Fastify = require('..')\n-const FormData = require('form-data')\n+const { Readable } = require('node:stream')\n \n test('inject should exist', t => {\n   t.plan(2)\n   const fastify = Fastify()\n-  t.ok(fastify.inject)\n-  t.equal(typeof fastify.inject, 'function')\n+  t.assert.ok(fastify.inject)\n+  t.assert.strictEqual(typeof fastify.inject, 'function')\n })\n \n-test('should wait for the ready event', t => {\n+test('should wait for the ready event', (t, done) => {\n   t.plan(4)\n   const fastify = Fastify()\n   const payload = { hello: 'world' }\n@@ -23,7 +22,6 @@\n     instance.get('/', (req, reply) => {\n       reply.send(payload)\n     })\n-\n     setTimeout(done, 500)\n   })\n \n@@ -31,14 +29,15 @@\n     method: 'GET',\n     url: '/'\n   }, (err, res) => {\n-    t.error(err)\n-    t.same(payload, JSON.parse(res.payload))\n-    t.equal(res.statusCode, 200)\n-    t.equal(res.headers['content-length'], '17')\n+    t.assert.ifError(err)\n+    t.assert.deepStrictEqual(payload, JSON.parse(res.payload))\n+    t.assert.strictEqual(res.statusCode, 200)\n+    t.assert.strictEqual(res.headers['content-length'], '17')\n+    done()\n   })\n })\n \n-test('inject get request', t => {\n+test('inject get request', (t, done) => {\n   t.plan(4)\n   const fastify = Fastify()\n   const payload = { hello: 'world' }\n@@ -51,14 +50,15 @@\n     method: 'GET',\n     url: '/'\n   }, (err, res) => {\n-    t.error(err)\n-    t.same(payload, JSON.parse(res.payload))\n-    t.equal(res.statusCode, 200)\n-    t.equal(res.headers['content-length'], '17')\n+    t.assert.ifError(err)\n+    t.assert.deepStrictEqual(payload, JSON.parse(res.payload))\n+    t.assert.strictEqual(res.statusCode, 200)\n+    t.assert.strictEqual(res.headers['content-length'], '17')\n+    done()\n   })\n })\n \n-test('inject get request - code check', t => {\n+test('inject get request - code check', (t, done) => {\n   t.plan(4)\n   const fastify = Fastify()\n   const payload = { hello: 'world' }\n@@ -71,14 +71,15 @@\n     method: 'GET',\n     url: '/'\n   }, (err, res) => {\n-    t.error(err)\n-    t.same(payload, JSON.parse(res.payload))\n-    t.equal(res.statusCode, 201)\n-    t.equal(res.headers['content-length'], '17')\n+    t.assert.ifError(err)\n+    t.assert.deepStrictEqual(payload, JSON.parse(res.payload))\n+    t.assert.strictEqual(res.statusCode, 201)\n+    t.assert.strictEqual(res.headers['content-length'], '17')\n+    done()\n   })\n })\n \n-test('inject get request - headers check', t => {\n+test('inject get request - headers check', (t, done) => {\n   t.plan(4)\n   const fastify = Fastify()\n",
					"match": false,
					"packageHash": "a350881e52006523541bc613a3ff2c41d6827e2763d1e21bcb2cfccf031f5182",
					"size": 9652,
					"sourceHash": "6eb63d0fdc3bec6d418cb0be905755617d90c9760229bc129614477db1a5c843",
					"status": "content"
				},
				"test/input-validation.js": {
					"diff": "--- published/test/input-validation.js\n+++ rebuilt/test/input-validation.js\n@@ -1,10 +1,9 @@\n-\n 'use strict'\n \n-const sget = require('simple-get').concat\n const Ajv = require('ajv')\n const Joi = require('joi')\n const yup = require('yup')\n+const assert = require('node:assert')\n \n module.exports.payloadMethod = function (method, t) {\n   const test = t.test\n@@ -73,7 +72,7 @@\n           const result = schema.validateSync(data, yupOptions)\n           return { value: result }\n         } catch (e) {\n-          return { error: e }\n+          return { error: [e] }\n         }\n       }\n     }\n@@ -128,204 +127,208 @@\n \n         done()\n       })\n-      t.pass()\n+      t.assert.ok(true)\n     } catch (e) {\n-      t.fail()\n+      t.assert.fail()\n     }\n   })\n \n   fastify.listen({ port: 0 }, function (err) {\n-    if (err) {\n-      t.error(err)\n-    }\n+    assert.ifError(err)\n \n-    t.teardown(() => { fastify.close() })\n+    t.after(() => { fastify.close() })\n \n-    test(`${upMethod} - correctly replies`, t => {\n+    test(`${upMethod} - correctly replies`, async (t) => {\n       if (upMethod === 'HEAD') {\n         t.plan(2)\n-        sget({\n-          method: upMethod,\n-          url: 'http://localhost:' + fastify.server.address().port\n-        }, (err, response) => {\n-          t.error(err)\n-          t.equal(response.statusCode, 200)\n+        const result = await fetch('http://localhost:' + fastify.server.address().port, {\n+          method: upMethod\n         })\n+        t.assert.ok(result.ok)\n+        t.assert.strictEqual(result.status, 200)\n       } else {\n         t.plan(3)\n-        sget({\n+\n+        const result = await fetch('http://localhost:' + fastify.server.address().port, {\n           method: upMethod,\n-          url: 'http://localhost:' + fastify.server.address().port,\n-          body: {\n-            hello: 42\n-          },\n-          json: true\n-        }, (err, response, body) => {\n-          t.error(err)\n-          t.equal(response.statusCode, 200)\n-          t.same(body, { hello: 42 })\n+          body: JSON.stringify({ hello: 42 }),\n+          headers: {\n+            'Content-Type': 'application/json'\n+          }\n         })\n+\n+        t.assert.ok(result.ok)\n+        t.assert.strictEqual(result.status, 200)\n+        t.assert.deepStrictEqual(await result.json(), { hello: 42 })\n       }\n     })\n \n-    test(`${upMethod} - 400 on bad parameters`, t => {\n+    test(`${upMethod} - 400 on bad parameters`, async (t) => {\n       t.plan(3)\n-      sget({\n+\n+      const result = await fetch('http://localhost:' + fastify.server.address().port, {\n         method: upMethod,\n-        url: 'http://localhost:' + fastify.server.address().port,\n-        body: {\n-          hello: 'world'\n-        },\n-        json: true\n-      }, (err, response, body) => {\n-        t.error(err)\n",
					"match": false,
					"packageHash": "f82330a568a1be7dcfa85825a74ccdab268de858fd43ed89aadd0adf79527a5b",
					"size": 8703,
					"sourceHash": "60e795e05979a2d05f383bb93a6089f183314597c118881e10bfcef276952641",
					"status": "content"
				},
				"test/internals/all.test.js": {
					"diff": "--- published/test/internals/all.test.js\n+++ rebuilt/test/internals/all.test.js\n@@ -1,28 +1,27 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const Fastify = require('../..')\n-const { supportedMethods } = require('../../lib/httpMethods')\n \n-test('fastify.all should add all the methods to the same url', t => {\n+test('fastify.all should add all the methods to the same url', async t => {\n+  const fastify = Fastify()\n+\n   const requirePayload = [\n     'POST',\n     'PUT',\n     'PATCH'\n   ]\n \n-  t.plan(supportedMethods.length * 2)\n-\n-  const fastify = Fastify()\n+  const supportedMethods = fastify.supportedMethods\n+  t.plan(supportedMethods.length)\n \n   fastify.all('/', (req, reply) => {\n     reply.send({ method: req.raw.method })\n   })\n \n-  supportedMethods.forEach(injectRequest)\n+  await Promise.all(supportedMethods.map(async method => injectRequest(method)))\n \n-  function injectRequest (method) {\n+  async function injectRequest (method) {\n     const options = {\n       url: '/',\n       method\n@@ -32,10 +31,8 @@\n       options.payload = { hello: 'world' }\n     }\n \n-    fastify.inject(options, (err, res) => {\n-      t.error(err)\n-      const payload = JSON.parse(res.payload)\n-      t.same(payload, { method })\n-    })\n+    const res = await fastify.inject(options)\n+    const payload = JSON.parse(res.payload)\n+    t.assert.deepStrictEqual(payload, { method })\n   }\n })\n",
					"match": false,
					"packageHash": "07f76f4206183c4c098fc3d9076b74099b8d48a0c00dc157d7ffe47704cadd1d",
					"size": 833,
					"sourceHash": "dcc688db5d14a60466c8917971b9ff817578f6eb7ead88280996de71af167009",
					"status": "content"
				},
				"test/internals/contentTypeParser.test.js": {
					"match": false,
					"packageHash": "765404bf59e7d385b199e8c6dd9bd679d925b400dd375ce83ce9051e9d74c976",
					"size": 2506,
					"status": "missing-in-source"
				},
				"test/internals/decorator.test.js": {
					"diff": "--- published/test/internals/decorator.test.js\n+++ rebuilt/test/internals/decorator.test.js\n@@ -1,9 +1,6 @@\n 'use strict'\n \n-/* eslint no-prototype-builtins: 0 */\n-\n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const decorator = require('../../lib/decorate')\n const {\n   kState\n@@ -24,7 +21,7 @@\n \n   const server = build()\n   server.add('test', () => {})\n-  t.ok(server.test)\n+  t.assert.ok(server.test)\n })\n \n test('decorate is chainable', t => {\n@@ -46,15 +43,15 @@\n     .add('test2', () => {})\n     .add('test3', () => {})\n \n-  t.ok(server.test1)\n-  t.ok(server.test2)\n-  t.ok(server.test3)\n+  t.assert.ok(server.test1)\n+  t.assert.ok(server.test2)\n+  t.assert.ok(server.test3)\n })\n \n test('checkExistence should check if a property is part of the given instance', t => {\n   t.plan(1)\n   const instance = { test: () => {} }\n-  t.ok(decorator.exist(instance, 'test'))\n+  t.assert.ok(decorator.exist(instance, 'test'))\n })\n \n test('checkExistence should find the instance if not given', t => {\n@@ -73,7 +70,7 @@\n \n   const server = build()\n   server.add('test', () => {})\n-  t.ok(server.check('test'))\n+  t.assert.ok(server.check('test'))\n })\n \n test('checkExistence should check the prototype as well', t => {\n@@ -82,7 +79,7 @@\n   Instance.prototype.test = () => {}\n \n   const instance = new Instance()\n-  t.ok(decorator.exist(instance, 'test'))\n+  t.assert.ok(decorator.exist(instance, 'test'))\n })\n \n test('checkDependencies should throw if a dependency is not present', t => {\n@@ -90,10 +87,10 @@\n   const instance = {}\n   try {\n     decorator.dependencies(instance, 'foo', ['test'])\n-    t.fail()\n+    t.assert.fail()\n   } catch (e) {\n-    t.equal(e.code, 'FST_ERR_DEC_MISSING_DEPENDENCY')\n-    t.equal(e.message, 'The decorator is missing dependency \\'test\\'.')\n+    t.assert.strictEqual(e.code, 'FST_ERR_DEC_MISSING_DEPENDENCY')\n+    t.assert.strictEqual(e.message, 'The decorator is missing dependency \\'test\\'.')\n   }\n })\n \n@@ -114,10 +111,10 @@\n \n   try {\n     server.add('method', () => {}, ['test'])\n-    t.fail()\n+    t.assert.fail()\n   } catch (e) {\n-    t.equal(e.code, 'FST_ERR_DEC_MISSING_DEPENDENCY')\n-    t.equal(e.message, 'The decorator is missing dependency \\'test\\'.')\n+    t.assert.strictEqual(e.code, 'FST_ERR_DEC_MISSING_DEPENDENCY')\n+    t.assert.strictEqual(e.message, 'The decorator is missing dependency \\'test\\'.')\n   }\n })\n \n@@ -134,14 +131,14 @@\n   decorator.add.call(one, 'foo', {\n     getter: () => this._a,\n     setter: (val) => {\n-      t.pass()\n+      t.assert.ok(true)\n       this._a = val\n     }\n   })\n-  t.equal(one.hasOwnProperty('foo'), true)\n-  t.equal(one.foo, undefined)\n+  t.assert.strictEqual(Object.hasOwn(one, 'foo'), true)\n",
					"match": false,
					"packageHash": "8fc088b94ddd238b683eb312650ad6644427d8d0bdd9f31d0e577424537b2935",
					"size": 3349,
					"sourceHash": "38eb5b91a3d613e80c2c80d9c0b5922c64d61cbd86c335b9202a80005de90218",
					"status": "content"
				},
				"test/internals/handleRequest.test.js": {
					"match": false,
					"packageHash": "07a6aa57e021af6710b926fff8e2aa0377414e18d7a0fdf2890f48adf0ef45a4",
					"size": 6225,
					"status": "missing-in-source"
				},
				"test/internals/hookRunner.test.js": {
					"match": false,
					"packageHash": "d30cefbd48d7021771c2c6fdb80d43cf5d8f77e770f33e5109a53b0b6390478d",
					"size": 9182,
					"status": "missing-in-source"
				},
				"test/internals/hooks.test.js": {
					"diff": "--- published/test/internals/hooks.test.js\n+++ rebuilt/test/internals/hooks.test.js\n@@ -1,54 +1,51 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n-\n+const { test } = require('node:test')\n const { Hooks } = require('../../lib/hooks')\n+const { default: fastify } = require('../../fastify')\n const noop = () => {}\n \n test('hooks should have 4 array with the registered hooks', t => {\n   const hooks = new Hooks()\n-  t.equal(typeof hooks, 'object')\n-  t.ok(Array.isArray(hooks.onRequest))\n-  t.ok(Array.isArray(hooks.onSend))\n-  t.ok(Array.isArray(hooks.preParsing))\n-  t.ok(Array.isArray(hooks.preValidation))\n-  t.ok(Array.isArray(hooks.preHandler))\n-  t.ok(Array.isArray(hooks.onResponse))\n-  t.ok(Array.isArray(hooks.onError))\n-  t.end()\n+  t.assert.strictEqual(typeof hooks, 'object')\n+  t.assert.ok(Array.isArray(hooks.onRequest))\n+  t.assert.ok(Array.isArray(hooks.onSend))\n+  t.assert.ok(Array.isArray(hooks.preParsing))\n+  t.assert.ok(Array.isArray(hooks.preValidation))\n+  t.assert.ok(Array.isArray(hooks.preHandler))\n+  t.assert.ok(Array.isArray(hooks.onResponse))\n+  t.assert.ok(Array.isArray(hooks.onError))\n })\n \n test('hooks.add should add a hook to the given hook', t => {\n   const hooks = new Hooks()\n   hooks.add('onRequest', noop)\n-  t.equal(hooks.onRequest.length, 1)\n-  t.equal(typeof hooks.onRequest[0], 'function')\n+  t.assert.strictEqual(hooks.onRequest.length, 1)\n+  t.assert.strictEqual(typeof hooks.onRequest[0], 'function')\n \n   hooks.add('preParsing', noop)\n-  t.equal(hooks.preParsing.length, 1)\n-  t.equal(typeof hooks.preParsing[0], 'function')\n+  t.assert.strictEqual(hooks.preParsing.length, 1)\n+  t.assert.strictEqual(typeof hooks.preParsing[0], 'function')\n \n   hooks.add('preValidation', noop)\n-  t.equal(hooks.preValidation.length, 1)\n-  t.equal(typeof hooks.preValidation[0], 'function')\n+  t.assert.strictEqual(hooks.preValidation.length, 1)\n+  t.assert.strictEqual(typeof hooks.preValidation[0], 'function')\n \n   hooks.add('preHandler', noop)\n-  t.equal(hooks.preHandler.length, 1)\n-  t.equal(typeof hooks.preHandler[0], 'function')\n+  t.assert.strictEqual(hooks.preHandler.length, 1)\n+  t.assert.strictEqual(typeof hooks.preHandler[0], 'function')\n \n   hooks.add('onResponse', noop)\n-  t.equal(hooks.onResponse.length, 1)\n-  t.equal(typeof hooks.onResponse[0], 'function')\n+  t.assert.strictEqual(hooks.onResponse.length, 1)\n+  t.assert.strictEqual(typeof hooks.onResponse[0], 'function')\n \n   hooks.add('onSend', noop)\n-  t.equal(hooks.onSend.length, 1)\n-  t.equal(typeof hooks.onSend[0], 'function')\n+  t.assert.strictEqual(hooks.onSend.length, 1)\n+  t.assert.strictEqual(typeof hooks.onSend[0], 'function')\n \n   hooks.add('onError', noop)\n-  t.equal(hooks.onError.length, 1)\n-  t.equal(typeof hooks.onError[0], 'function')\n-  t.end()\n+  t.assert.strictEqual(hooks.onError.length, 1)\n+  t.assert.strictEqual(typeof hooks.onError[0], 'function')\n })\n \n test('hooks should throw on unexisting handler', t => {\n@@ -56,9 +53,9 @@\n   const hooks = new Hooks()\n   try {\n     hooks.add('onUnexistingHook', noop)\n-    t.fail()\n+    t.assert.fail()\n   } catch (e) {\n-    t.pass()\n+    t.assert.ok(true)\n   }\n })\n \n@@ -66,18 +63,34 @@\n   const hooks = new Hooks()\n   t.plan(4)\n   try {\n-    hooks.add(null, noop)\n-    t.fail()\n+    hooks.add(null, () => {})\n",
					"match": false,
					"packageHash": "9bfe2fac386d0250bf8bb1e09ba85f27988c26642d38e3c4a5ba2cc88c430708",
					"size": 2119,
					"sourceHash": "c3505a92f21eb3b47b3e0e637643f985d2b080a5e09378d233da42c38802f33e",
					"status": "content"
				},
				"test/internals/initialConfig.test.js": {
					"match": false,
					"packageHash": "d4920c3e9d51386416119aff02a360a8584144a6ff2ad16c5a86485c33c0add5",
					"size": 10516,
					"status": "missing-in-source"
				},
				"test/internals/logger.test.js": {
					"diff": "--- published/test/internals/logger.test.js\n+++ rebuilt/test/internals/logger.test.js\n@@ -1,34 +1,34 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const Fastify = require('../..')\n-const loggerUtils = require('../../lib/logger')\n+const loggerUtils = require('../../lib/logger-factory')\n+const { serializers } = require('../../lib/logger-pino')\n \n test('time resolution', t => {\n   t.plan(2)\n-  t.equal(typeof loggerUtils.now, 'function')\n-  t.equal(typeof loggerUtils.now(), 'number')\n+  t.assert.strictEqual(typeof loggerUtils.now, 'function')\n+  t.assert.strictEqual(typeof loggerUtils.now(), 'number')\n })\n \n-test('The logger should add a unique id for every request', t => {\n+test('The logger should add a unique id for every request', (t, done) => {\n   const ids = []\n \n   const fastify = Fastify()\n   fastify.get('/', (req, reply) => {\n-    t.ok(req.id)\n+    t.assert.ok(req.id)\n     reply.send({ id: req.id })\n   })\n \n   fastify.listen({ port: 0 }, err => {\n-    t.error(err)\n+    t.assert.ifError(err)\n     const queue = new Queue()\n     for (let i = 0; i < 10; i++) {\n       queue.add(checkId)\n     }\n     queue.add(() => {\n       fastify.close()\n-      t.end()\n+      done()\n     })\n   })\n \n@@ -37,24 +37,24 @@\n       method: 'GET',\n       url: 'http://localhost:' + fastify.server.address().port\n     }, (err, res) => {\n-      t.error(err)\n+      t.assert.ifError(err)\n       const payload = JSON.parse(res.payload)\n-      t.ok(ids.indexOf(payload.id) === -1, 'the id should not be duplicated')\n+      t.assert.ok(ids.indexOf(payload.id) === -1, 'the id should not be duplicated')\n       ids.push(payload.id)\n       done()\n     })\n   }\n })\n \n-test('The logger should reuse request id header for req.id', t => {\n+test('The logger should not reuse request id header for req.id', (t, done) => {\n   const fastify = Fastify()\n   fastify.get('/', (req, reply) => {\n-    t.ok(req.id)\n+    t.assert.ok(req.id)\n     reply.send({ id: req.id })\n   })\n \n   fastify.listen({ port: 0 }, err => {\n-    t.error(err)\n+    t.assert.ifError(err)\n \n     fastify.inject({\n       method: 'GET',\n@@ -63,11 +63,40 @@\n         'Request-Id': 'request-id-1'\n       }\n     }, (err, res) => {\n-      t.error(err)\n+      t.assert.ifError(err)\n       const payload = JSON.parse(res.payload)\n-      t.ok(payload.id === 'request-id-1', 'the request id from the header should be returned')\n+      t.assert.ok(payload.id !== 'request-id-1', 'the request id from the header should not be returned with default configuration')\n+      t.assert.ok(payload.id === 'req-1') // first request id when using the default configuration\n       fastify.close()\n-      t.end()\n+      done()\n+    })\n+  })\n+})\n+\n+test('The logger should reuse request id header for req.id if requestIdHeader is set', (t, done) => {\n+  const fastify = Fastify({\n+    requestIdHeader: 'request-id'\n+  })\n+  fastify.get('/', (req, reply) => {\n+    t.assert.ok(req.id)\n+    reply.send({ id: req.id })\n",
					"match": false,
					"packageHash": "27f4be037e8bd01b79871ca6d45ded5ba10de2c43aeb85e4c51f9d629ceb6f4b",
					"size": 2882,
					"sourceHash": "aea1fe395b2cdc756b576a59b56782fec2db1c7c8379ef9dc5976ba573fa8348",
					"status": "content"
				},
				"test/internals/plugin.test.js": {
					"diff": "--- published/test/internals/plugin.test.js\n+++ rebuilt/test/internals/plugin.test.js\n@@ -1,19 +1,18 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n \n-const pluginUtilsPublic = require('../../lib/pluginUtils.js')\n+const pluginUtilsPublic = require('../../lib/plugin-utils.js')\n const symbols = require('../../lib/symbols.js')\n-const pluginUtils = require('../../lib/pluginUtils')[symbols.kTestInternals]\n+const pluginUtils = require('../../lib/plugin-utils')[symbols.kTestInternals]\n \n test(\"shouldSkipOverride should check the 'skip-override' symbol\", t => {\n   t.plan(2)\n \n   yes[Symbol.for('skip-override')] = true\n \n-  t.ok(pluginUtils.shouldSkipOverride(yes))\n-  t.notOk(pluginUtils.shouldSkipOverride(no))\n+  t.assert.ok(pluginUtils.shouldSkipOverride(yes))\n+  t.assert.ok(!pluginUtils.shouldSkipOverride(no))\n \n   function yes () {}\n   function no () {}\n@@ -26,7 +25,22 @@\n   require.cache[expectedPluginName] = { exports: fn }\n   const pluginName = pluginUtilsPublic.getPluginName(fn)\n \n-  t.equal(pluginName, expectedPluginName)\n+  t.assert.strictEqual(pluginName, expectedPluginName)\n+})\n+\n+test('getPluginName should not throw when require.cache is undefined', t => {\n+  t.plan(1)\n+  function example () {\n+    console.log('is just an example')\n+  }\n+  const cache = require.cache\n+  require.cache = undefined\n+  t.after(() => {\n+    require.cache = cache\n+  })\n+  const pluginName = pluginUtilsPublic.getPluginName(example)\n+\n+  t.assert.strictEqual(pluginName, 'example')\n })\n \n test(\"getMeta should return the object stored with the 'plugin-meta' symbol\", t => {\n@@ -35,7 +49,7 @@\n   const meta = { hello: 'world' }\n   fn[Symbol.for('plugin-meta')] = meta\n \n-  t.same(meta, pluginUtils.getMeta(fn))\n+  t.assert.deepStrictEqual(meta, pluginUtils.getMeta(fn))\n \n   function fn () {}\n })\n@@ -58,9 +72,9 @@\n \n   try {\n     pluginUtils.checkDecorators.call(context, fn)\n-    t.pass('Everything ok')\n+    t.assert.ok('Everything ok')\n   } catch (err) {\n-    t.fail(err)\n+    t.assert.fail(err)\n   }\n \n   function fn () {}\n@@ -84,9 +98,9 @@\n \n   try {\n     pluginUtils.checkDecorators.call(context, fn)\n-    t.fail('should throw')\n+    t.assert.fail('should throw')\n   } catch (err) {\n-    t.equal(err.message, \"The decorator 'plugin' is not present in Request\")\n+    t.assert.strictEqual(err.message, \"The decorator 'plugin' is not present in Request\")\n   }\n \n   function fn () {}\n@@ -106,9 +120,9 @@\n \n   try {\n     pluginUtils.checkDecorators.call(context, fn)\n-    t.pass('Everything ok')\n+    t.assert.ok('Everything ok')\n   } catch (err) {\n-    t.fail(err)\n+    t.assert.fail(err)\n   }\n \n   function fn () {}\n@@ -122,13 +136,13 @@\n   }\n \n   function context () {}\n",
					"match": false,
					"packageHash": "2cc6ce7ecd56eaee3b2dfe4cef78afd016ae2bd4698c3067990ed64a3c482446",
					"size": 3729,
					"sourceHash": "324a90e6210647372c29a58ffa6d44dd60a122e566f71dc5cc7e73625d1fdf63",
					"status": "content"
				},
				"test/internals/reply-serialize.test.js": {
					"diff": "--- published/test/internals/reply-serialize.test.js\n+++ rebuilt/test/internals/reply-serialize.test.js\n@@ -1,7 +1,7 @@\n 'use strict'\n \n-const { test } = require('tap')\n-const { kReplySerializeWeakMap } = require('../../lib/symbols')\n+const { test } = require('node:test')\n+const { kReplyCacheSerializeFns, kRouteContext } = require('../../lib/symbols')\n const Fastify = require('../../fastify')\n \n function getDefaultSchema () {\n@@ -45,14 +45,27 @@\n           type: 'string'\n         }\n       }\n+    },\n+    '3xx': {\n+      content: {\n+        'application/json': {\n+          schema: {\n+            type: 'object',\n+            properties: {\n+              fullName: { type: 'string' },\n+              phone: { type: 'number' }\n+            }\n+          }\n+        }\n+      }\n     }\n   }\n }\n \n-test('Reply#compileSerializationSchema', t => {\n+test('Reply#compileSerializationSchema', async t => {\n   t.plan(4)\n \n-  t.test('Should return a serialization function', async t => {\n+  await t.test('Should return a serialization function', async t => {\n     const fastify = Fastify()\n \n     t.plan(4)\n@@ -60,14 +73,14 @@\n     fastify.get('/', (req, reply) => {\n       const serialize = reply.compileSerializationSchema(getDefaultSchema())\n       const input = { hello: 'world' }\n-      t.type(serialize, Function)\n-      t.type(serialize(input), 'string')\n-      t.equal(serialize(input), JSON.stringify(input))\n+      t.assert.ok(serialize instanceof Function)\n+      t.assert.ok(typeof serialize(input) === 'string')\n+      t.assert.strictEqual(serialize(input), JSON.stringify(input))\n \n       try {\n         serialize({ world: 'foo' })\n       } catch (err) {\n-        t.equal(err.message, '\"hello\" is required!')\n+        t.assert.strictEqual(err.message, '\"hello\" is required!')\n       }\n \n       reply.send({ hello: 'world' })\n@@ -79,7 +92,7 @@\n     })\n   })\n \n-  t.test('Should reuse the serialize fn across multiple invocations - Route without schema',\n+  await t.test('Should reuse the serialize fn across multiple invocations - Route without schema',\n     async t => {\n       const fastify = Fastify()\n       let serialize = null\n@@ -94,20 +107,20 @@\n         counter++\n         if (counter > 1) {\n           const newSerialize = reply.compileSerializationSchema(schemaObj)\n-          t.equal(serialize, newSerialize, 'Are the same validate function')\n+          t.assert.strictEqual(serialize, newSerialize, 'Are the same validate function')\n           serialize = newSerialize\n         } else {\n-          t.pass('build the schema compilation function')\n+          t.assert.ok(true, 'build the schema compilation function')\n           serialize = reply.compileSerializationSchema(schemaObj)\n         }\n \n-        t.type(serialize, Function)\n-        t.equal(serialize(input), JSON.stringify(input))\n+        t.assert.ok(serialize instanceof Function)\n+        t.assert.strictEqual(serialize(input), JSON.stringify(input))\n \n         try {\n           serialize({ world: 'foo' })\n         } catch (err) {\n-          t.equal(err.message, '\"hello\" is required!')\n+          t.assert.strictEqual(err.message, '\"hello\" is required!')\n         }\n \n         reply.send({ hello: 'world' })\n@@ -120,28 +133,41 @@\n         fastify.inject('/')\n       ])\n \n",
					"match": false,
					"packageHash": "bf765cb8f056139d3de5c2f836aba4b14d9a7fced453cf5ceaacbb19e9392fbb",
					"size": 13884,
					"sourceHash": "6d6d72e639f93221af5bd08d92ab91eee062176178c853c82e2fd5ef54a37981",
					"status": "content"
				},
				"test/internals/reply.test.js": {
					"diff": "--- published/test/internals/reply.test.js\n+++ rebuilt/test/internals/reply.test.js\n@@ -1,61 +1,70 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n-const sget = require('simple-get').concat\n-const http = require('http')\n+const { test } = require('node:test')\n+const http = require('node:http')\n const NotFound = require('http-errors').NotFound\n+const Request = require('../../lib/request')\n const Reply = require('../../lib/reply')\n-const { Readable, Writable } = require('stream')\n+const Fastify = require('../..')\n+const { Readable, Writable } = require('node:stream')\n const {\n   kReplyErrorHandlerCalled,\n   kReplyHeaders,\n   kReplySerializer,\n   kReplyIsError,\n-  kReplySerializerDefault\n+  kReplySerializerDefault,\n+  kRouteContext\n } = require('../../lib/symbols')\n-const fs = require('fs')\n-const path = require('path')\n-const warning = require('../../lib/warnings')\n-\n-const doGet = function (url) {\n-  return new Promise((resolve, reject) => {\n-    sget({ method: 'GET', url, followRedirects: false }, (err, response, body) => {\n-      if (err) {\n-        reject(err)\n-      } else {\n-        resolve({ response, body })\n-      }\n-    })\n+const fs = require('node:fs')\n+const path = require('node:path')\n+\n+const doGet = async function (url) {\n+  const result = await fetch(url, {\n+    method: 'GET',\n+    redirect: 'manual',\n+    keepAlive: false\n   })\n+\n+  return {\n+    response: result,\n+    body: await result.json().catch(() => undefined)\n+  }\n }\n \n test('Once called, Reply should return an object with methods', t => {\n-  t.plan(13)\n+  t.plan(15)\n   const response = { res: 'res' }\n-  const context = {}\n-  const request = { context }\n+  const context = {\n+    config: { onSend: [] },\n+    schema: {},\n+    _parserOptions: {},\n+    server: { hasConstraintStrategy: () => false, initialConfig: {} }\n+  }\n+  const request = new Request(null, null, null, null, null, context)\n   const reply = new Reply(response, request)\n-  t.equal(typeof reply, 'object')\n-  t.equal(typeof reply[kReplyIsError], 'boolean')\n-  t.equal(typeof reply[kReplyErrorHandlerCalled], 'boolean')\n-  t.equal(typeof reply.send, 'function')\n-  t.equal(typeof reply.code, 'function')\n-  t.equal(typeof reply.status, 'function')\n-  t.equal(typeof reply.header, 'function')\n-  t.equal(typeof reply.serialize, 'function')\n-  t.equal(typeof reply.getResponseTime, 'function')\n-  t.equal(typeof reply[kReplyHeaders], 'object')\n-  t.same(reply.raw, response)\n-  t.equal(reply.context, context)\n-  t.equal(reply.request, request)\n+  t.assert.strictEqual(typeof reply, 'object')\n+  t.assert.strictEqual(typeof reply[kReplyIsError], 'boolean')\n+  t.assert.strictEqual(typeof reply[kReplyErrorHandlerCalled], 'boolean')\n+  t.assert.strictEqual(typeof reply.send, 'function')\n+  t.assert.strictEqual(typeof reply.code, 'function')\n+  t.assert.strictEqual(typeof reply.status, 'function')\n+  t.assert.strictEqual(typeof reply.header, 'function')\n+  t.assert.strictEqual(typeof reply.serialize, 'function')\n+  t.assert.strictEqual(typeof reply[kReplyHeaders], 'object')\n+  t.assert.deepStrictEqual(reply.raw, response)\n+  t.assert.strictEqual(reply[kRouteContext], context)\n+  t.assert.strictEqual(reply.routeOptions.config, context.config)\n+  t.assert.strictEqual(reply.routeOptions.schema, context.schema)\n+  t.assert.strictEqual(reply.request, request)\n+  // Aim to not bad property keys (including Symbols)\n+  t.assert.ok(!('undefined' in reply))\n })\n \n",
					"match": false,
					"packageHash": "ab6ed4d8e6276fd12d8cbcfd0ef82166c1bd28e835611c38d2e91f5171bf4bf9",
					"size": 52227,
					"sourceHash": "cce5c46b49b885cd608a8db90e023c1035458c66fa45c282c14d978cad0e5efe",
					"status": "content"
				},
				"test/internals/request-validate.test.js": {
					"diff": "--- published/test/internals/request-validate.test.js\n+++ rebuilt/test/internals/request-validate.test.js\n@@ -1,8 +1,8 @@\n 'use strict'\n \n-const { test } = require('tap')\n+const { test } = require('node:test')\n const Ajv = require('ajv')\n-const { kRequestValidateWeakMap } = require('../../lib/symbols')\n+const { kRequestCacheValidateFns, kRouteContext } = require('../../lib/symbols')\n const Fastify = require('../../fastify')\n \n const defaultSchema = {\n@@ -16,29 +16,59 @@\n \n const requestSchema = {\n   params: {\n-    id: {\n-      type: 'integer',\n-      minimum: 1\n+    type: 'object',\n+    properties: {\n+      id: {\n+        type: 'integer',\n+        minimum: 1\n+      }\n     }\n   },\n   querystring: {\n-    foo: {\n-      type: 'string',\n-      enum: ['bar']\n+    type: 'object',\n+    properties: {\n+      foo: {\n+        type: 'string',\n+        enum: ['bar']\n+      }\n     }\n   },\n   body: defaultSchema,\n   headers: {\n-    'x-foo': {\n-      type: 'string'\n+    type: 'object',\n+    properties: {\n+      'x-foo': {\n+        type: 'string'\n+      }\n     }\n   }\n }\n \n-test('#compileValidationSchema', subtest => {\n-  subtest.plan(5)\n+test('#compileValidationSchema', async subtest => {\n+  subtest.plan(7)\n+\n+  await subtest.test('Should return a function - Route without schema', async t => {\n+    const fastify = Fastify()\n+\n+    t.plan(3)\n+\n+    fastify.get('/', (req, reply) => {\n+      const validate = req.compileValidationSchema(defaultSchema)\n+\n+      t.assert.ok(validate instanceof Function)\n+      t.assert.ok(validate({ hello: 'world' }))\n+      t.assert.ok(!validate({ world: 'foo' }))\n \n-  subtest.test('Should return a function - Route without schema', async t => {\n+      reply.send({ hello: 'world' })\n+    })\n+\n+    await fastify.inject({\n+      path: '/',\n+      method: 'GET'\n+    })\n+  })\n+\n+  await subtest.test('Validate function errors property should be null after validation when input is valid', async t => {\n     const fastify = Fastify()\n \n     t.plan(3)\n@@ -46,9 +76,31 @@\n     fastify.get('/', (req, reply) => {\n       const validate = req.compileValidationSchema(defaultSchema)\n \n-      t.type(validate, Function)\n-      t.ok(validate({ hello: 'world' }))\n-      t.notOk(validate({ world: 'foo' }))\n+      t.assert.ok(validate({ hello: 'world' }))\n+      t.assert.ok(Object.hasOwn(validate, 'errors'))\n+      t.assert.strictEqual(validate.errors, null)\n+\n+      reply.send({ hello: 'world' })\n+    })\n+\n+    await fastify.inject({\n+      path: '/',\n",
					"match": false,
					"packageHash": "726c35ad2c364a4f9e28e6a7d8465be39c608b4fbb99f4fdc0cd6133f6836924",
					"size": 32852,
					"sourceHash": "9422bceac877a34a06041bb53a6c8bb24acf05e2dcd9ac5d088e754825be3948",
					"status": "content"
				},
				"test/internals/request.test.js": {
					"diff": "--- published/test/internals/request.test.js\n+++ rebuilt/test/internals/request.test.js\n@@ -1,8 +1,14 @@\n 'use strict'\n \n-const { test } = require('tap')\n+const { test } = require('node:test')\n \n const Request = require('../../lib/request')\n+const Context = require('../../lib/context')\n+const {\n+  kReply,\n+  kRequest,\n+  kOptions\n+} = require('../../lib/symbols')\n \n process.removeAllListeners('warning')\n \n@@ -16,34 +22,112 @@\n     socket: { remoteAddress: 'ip' },\n     headers\n   }\n+  const context = new Context({\n+    schema: {\n+      body: {\n+        type: 'object',\n+        required: ['hello'],\n+        properties: {\n+          hello: { type: 'string' }\n+        }\n+      }\n+    },\n+    config: {\n+      some: 'config',\n+      url: req.url,\n+      method: req.method\n+    },\n+    server: {\n+      [kReply]: {},\n+      [kRequest]: Request,\n+      [kOptions]: {\n+        requestIdLogLabel: 'reqId'\n+      },\n+      server: {}\n+    }\n+  })\n   req.connection = req.socket\n-  const request = new Request('id', 'params', req, 'query', 'log')\n-  t.type(request, Request)\n-  t.type(request.validateInput, Function)\n-  t.type(request.getValidationFunction, Function)\n-  t.type(request.compileValidationSchema, Function)\n-  t.equal(request.id, 'id')\n-  t.equal(request.params, 'params')\n-  t.equal(request.raw, req)\n-  t.equal(request.query, 'query')\n-  t.equal(request.headers, headers)\n-  t.equal(request.log, 'log')\n-  t.equal(request.ip, 'ip')\n-  t.equal(request.ips, undefined)\n-  t.equal(request.hostname, 'hostname')\n-  t.equal(request.body, undefined)\n-  t.equal(request.method, 'GET')\n-  t.equal(request.url, '/')\n-  t.equal(request.socket, req.socket)\n-  t.equal(request.protocol, 'http')\n-\n-  // This will be removed, it's deprecated\n-  t.equal(request.connection, req.connection)\n-  t.end()\n+  const request = new Request('id', 'params', req, 'query', 'log', context)\n+  t.assert.ok(request instanceof Request)\n+  t.assert.ok(request.validateInput instanceof Function)\n+  t.assert.ok(request.getValidationFunction instanceof Function)\n+  t.assert.ok(request.compileValidationSchema instanceof Function)\n+  t.assert.strictEqual(request.id, 'id')\n+  t.assert.strictEqual(request.params, 'params')\n+  t.assert.strictEqual(request.raw, req)\n+  t.assert.strictEqual(request.query, 'query')\n+  t.assert.strictEqual(request.headers, headers)\n+  t.assert.strictEqual(request.log, 'log')\n+  t.assert.strictEqual(request.ip, 'ip')\n+  t.assert.strictEqual(request.ips, undefined)\n+  t.assert.strictEqual(request.host, 'hostname')\n+  t.assert.strictEqual(request.body, undefined)\n+  t.assert.strictEqual(request.method, 'GET')\n+  t.assert.strictEqual(request.url, '/')\n+  t.assert.strictEqual(request.originalUrl, '/')\n+  t.assert.strictEqual(request.socket, req.socket)\n+  t.assert.strictEqual(request.protocol, 'http')\n+  // Aim to not bad property keys (including Symbols)\n+  t.assert.ok(!('undefined' in request))\n+})\n+\n+test('Request with undefined config', t => {\n+  const headers = {\n+    host: 'hostname'\n+  }\n+  const req = {\n+    method: 'GET',\n",
					"match": false,
					"packageHash": "8c8e9c6fca7e1d27067d5afdd5123abb556cc8c331ac1bb1090e0edbd7fb2e42",
					"size": 7284,
					"sourceHash": "ea3e75c4a140e8c40f8277080f0a5016df301c8d0d1565c85924f08df138c461",
					"status": "content"
				},
				"test/internals/server.test.js": {
					"diff": "--- published/test/internals/server.test.js\n+++ rebuilt/test/internals/server.test.js\n@@ -1,6 +1,6 @@\n 'use strict'\n \n-const { test } = require('tap')\n+const { test } = require('node:test')\n const proxyquire = require('proxyquire')\n \n const Fastify = require('../../fastify')\n@@ -15,12 +15,12 @@\n   const { server, listen } = createServer({}, handler)\n   await listen.call(Fastify(), { port: 0, host: 'localhost' })\n   server.close()\n-  t.pass('server started')\n+  t.assert.ok(true, 'server started')\n })\n \n test('DNS errors does not stop the main server on localhost - promise interface', async t => {\n   const { createServer } = proxyquire('../../lib/server', {\n-    dns: {\n+    'node:dns': {\n       lookup: (hostname, options, cb) => {\n         cb(new Error('DNS error'))\n       }\n@@ -29,13 +29,13 @@\n   const { server, listen } = createServer({}, handler)\n   await listen.call(Fastify(), { port: 0, host: 'localhost' })\n   server.close()\n-  t.pass('server started')\n+  t.assert.ok(true, 'server started')\n })\n \n-test('DNS errors does not stop the main server on localhost - callback interface', t => {\n+test('DNS errors does not stop the main server on localhost - callback interface', (t, done) => {\n   t.plan(2)\n   const { createServer } = proxyquire('../../lib/server', {\n-    dns: {\n+    'node:dns': {\n       lookup: (hostname, options, cb) => {\n         cb(new Error('DNS error'))\n       }\n@@ -43,16 +43,17 @@\n   })\n   const { server, listen } = createServer({}, handler)\n   listen.call(Fastify(), { port: 0, host: 'localhost' }, (err) => {\n-    t.error(err)\n+    t.assert.ifError(err)\n     server.close()\n-    t.pass('server started')\n+    t.assert.ok(true, 'server started')\n+    done()\n   })\n })\n \n-test('DNS returns empty binding', t => {\n+test('DNS returns empty binding', (t, done) => {\n   t.plan(2)\n   const { createServer } = proxyquire('../../lib/server', {\n-    dns: {\n+    'node:dns': {\n       lookup: (hostname, options, cb) => {\n         cb(null, [])\n       }\n@@ -60,16 +61,17 @@\n   })\n   const { server, listen } = createServer({}, handler)\n   listen.call(Fastify(), { port: 0, host: 'localhost' }, (err) => {\n-    t.error(err)\n+    t.assert.ifError(err)\n     server.close()\n-    t.pass('server started')\n+    t.assert.ok(true, 'server started')\n+    done()\n   })\n })\n \n-test('DNS returns more than two binding', t => {\n+test('DNS returns more than two binding', (t, done) => {\n   t.plan(2)\n   const { createServer } = proxyquire('../../lib/server', {\n-    dns: {\n+    'node:dns': {\n       lookup: (hostname, options, cb) => {\n         cb(null, [\n           { address: '::1', family: 6 },\n@@ -81,8 +83,9 @@\n   })\n   const { server, listen } = createServer({}, handler)\n   listen.call(Fastify(), { port: 0, host: 'localhost' }, (err) => {\n-    t.error(err)\n+    t.assert.ifError(err)\n     server.close()\n-    t.pass('server started')\n+    t.assert.ok(true, 'server started')\n+    done()\n   })\n })\n",
					"match": false,
					"packageHash": "6fde0706b9364164967779e9c85ac28a004a655a435f6aad0a27cce8f1581a84",
					"size": 2386,
					"sourceHash": "8d782f29afd275de02fed9e9fde80dd20f15f01fbaff1290e178504f035cf452",
					"status": "content"
				},
				"test/internals/validation.test.js": {
					"diff": "--- published/test/internals/validation.test.js\n+++ rebuilt/test/internals/validation.test.js\n@@ -1,7 +1,6 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n \n const Ajv = require('ajv')\n const ajv = new Ajv({ coerceTypes: true })\n@@ -13,11 +12,11 @@\n \n test('Symbols', t => {\n   t.plan(5)\n-  t.equal(typeof symbols.responseSchema, 'symbol')\n-  t.equal(typeof symbols.bodySchema, 'symbol')\n-  t.equal(typeof symbols.querystringSchema, 'symbol')\n-  t.equal(typeof symbols.paramsSchema, 'symbol')\n-  t.equal(typeof symbols.headersSchema, 'symbol')\n+  t.assert.strictEqual(typeof symbols.responseSchema, 'symbol')\n+  t.assert.strictEqual(typeof symbols.bodySchema, 'symbol')\n+  t.assert.strictEqual(typeof symbols.querystringSchema, 'symbol')\n+  t.assert.strictEqual(typeof symbols.paramsSchema, 'symbol')\n+  t.assert.strictEqual(typeof symbols.headersSchema, 'symbol')\n })\n \n ;['compileSchemasForValidation',\n@@ -26,15 +25,15 @@\n     t.plan(2)\n     const context = {}\n     validation[func](context)\n-    t.equal(typeof context[symbols.bodySchema], 'undefined')\n-    t.equal(typeof context[symbols.responseSchema], 'undefined')\n+    t.assert.strictEqual(typeof context[symbols.bodySchema], 'undefined')\n+    t.assert.strictEqual(typeof context[symbols.responseSchema], 'undefined')\n   })\n \n   test(`${func} schema - missing output schema`, t => {\n     t.plan(1)\n     const context = { schema: {} }\n     validation[func](context, null)\n-    t.equal(typeof context[symbols.responseSchema], 'undefined')\n+    t.assert.strictEqual(typeof context[symbols.responseSchema], 'undefined')\n   })\n })\n \n@@ -59,11 +58,11 @@\n     }\n   }\n   validation.compileSchemasForSerialization(opts, ({ schema, method, url, httpPart }) => ajv.compile(schema))\n-  t.equal(typeof opts[symbols.responseSchema]['2xx'], 'function')\n-  t.equal(typeof opts[symbols.responseSchema]['201'], 'function')\n+  t.assert.strictEqual(typeof opts[symbols.responseSchema]['2xx'], 'function')\n+  t.assert.strictEqual(typeof opts[symbols.responseSchema]['201'], 'function')\n })\n \n-test('build schema - payload schema', t => {\n+test('build schema - body schema', t => {\n   t.plan(1)\n   const opts = {\n     schema: {\n@@ -76,14 +75,38 @@\n     }\n   }\n   validation.compileSchemasForValidation(opts, ({ schema, method, url, httpPart }) => ajv.compile(schema))\n-  t.equal(typeof opts[symbols.bodySchema], 'function')\n+  t.assert.strictEqual(typeof opts[symbols.bodySchema], 'function')\n+})\n+\n+test('build schema - body with multiple content type schemas', t => {\n+  t.plan(2)\n+  const opts = {\n+    schema: {\n+      body: {\n+        content: {\n+          'application/json': {\n+            schema: {\n+              type: 'object',\n+              properties: {\n+                hello: { type: 'string' }\n+              }\n+            }\n+          },\n+          'text/plain': {\n+            schema: { type: 'string' }\n+          }\n+        }\n+      }\n+    }\n+  }\n+  validation.compileSchemasForValidation(opts, ({ schema, method, url, httpPart }) => ajv.compile(schema))\n+  t.assert.ok(opts[symbols.bodySchema]['application/json'], 'function')\n+  t.assert.ok(opts[symbols.bodySchema]['text/plain'], 'function')\n })\n \n test('build schema - avoid repeated normalize schema', t => {\n   t.plan(3)\n-  const serverConfig = {\n-    jsonShorthand: true\n",
					"match": false,
					"packageHash": "91aaa8eedd7b6b75fee5cafd14b86769054d7bfb817a1ec4781c982fc7ab0205",
					"size": 7386,
					"sourceHash": "94373780a9a296707e932370963d3a6e8e168dbc65c8fb6c9e6ad768edf0332d",
					"status": "content"
				},
				"test/keepAliveTimeout.test.js": {
					"match": false,
					"packageHash": "70010990acbb56887bcc54215dd2936f033988175d84942c4523159bc1f1b803",
					"size": 1054,
					"status": "missing-in-source"
				},
				"test/listen.deprecated.test.js": {
					"match": false,
					"packageHash": "4c94349b59353778f3f49dd60a6d32fdfce9b5da91b49ddbeab69b67e788f5e2",
					"size": 5370,
					"status": "missing-in-source"
				},
				"test/listen.test.js": {
					"match": false,
					"packageHash": "592b5992b164f3699ea5629990147ef3ed7f480f0f1f897a8702359db2dc4281",
					"size": 10980,
					"status": "missing-in-source"
				},
				"test/lock.test.js": {
					"match": false,
					"packageHash": "de7c1125633fb6f6876bba71c870fd4291e0b3a238a78db2b15137589f6ade01",
					"size": 2110,
					"status": "missing-in-source"
				},
				"test/logger.test.js": {
					"match": false,
					"packageHash": "15b2edcdb29448275a6215d8646ce1a6f616cbc6de2fd8dbde3c13d7056c4413",
					"size": 41811,
					"status": "missing-in-source"
				},
				"test/maxRequestsPerSocket.test.js": {
					"match": false,
					"packageHash": "ebe298a666eb19b113dbcaa7521eb3a2eb3b0a182a6aa171f462ddbc7d2cb188",
					"size": 3331,
					"status": "missing-in-source"
				},
				"test/middleware.test.js": {
					"diff": "--- published/test/middleware.test.js\n+++ rebuilt/test/middleware.test.js\n@@ -1,6 +1,6 @@\n 'use strict'\n \n-const { test } = require('tap')\n+const { test } = require('node:test')\n const Fastify = require('..')\n const {\n   FST_ERR_DEC_ALREADY_PRESENT\n@@ -10,7 +10,7 @@\n   t.plan(1)\n   const fastify = Fastify()\n   fastify.decorate('use', () => true)\n-  t.equal(fastify.use(), true)\n+  t.assert.strictEqual(fastify.use(), true)\n })\n \n test('Cannot decorate use twice', t => {\n@@ -20,17 +20,16 @@\n   try {\n     fastify.decorate('use', () => true)\n   } catch (err) {\n-    t.ok(err instanceof FST_ERR_DEC_ALREADY_PRESENT)\n+    t.assert.ok(err instanceof FST_ERR_DEC_ALREADY_PRESENT)\n   }\n })\n \n test('Encapsulation works', t => {\n-  t.plan(1)\n   const fastify = Fastify()\n \n   fastify.register((instance, opts, done) => {\n     instance.decorate('use', () => true)\n-    t.equal(instance.use(), true)\n+    t.assert.strictEqual(instance.use(), true)\n     done()\n   })\n \n",
					"match": false,
					"packageHash": "7ef116e5cfd90253942bd115510b2a8e4080f1506518e945306e2a8939869b93",
					"size": 801,
					"sourceHash": "831fd377391c89b25f59205547cce70c7fa6630cd580f5447ff926b94dc27b13",
					"status": "content"
				},
				"test/mkcol.test.js": {
					"match": false,
					"packageHash": "e87362a223592cab922f2030921d5a898866eb5b916b695d52cc21a8c4957316",
					"size": 737,
					"status": "missing-in-source"
				},
				"test/move.test.js": {
					"match": false,
					"packageHash": "6d0f7bce76ea7424a6f7f25f9f3e1615a84be177198fd69fe62d65fe9664ff2c",
					"size": 952,
					"status": "missing-in-source"
				},
				"test/noop-set.test.js": {
					"diff": "--- published/test/noop-set.test.js\n+++ rebuilt/test/noop-set.test.js\n@@ -1,19 +1,19 @@\n 'use strict'\n \n-const tap = require('tap')\n+const { test } = require('node:test')\n const noopSet = require('../lib/noop-set')\n \n-tap.test('does a lot of nothing', async t => {\n+test('does a lot of nothing', async t => {\n   const aSet = noopSet()\n-  t.type(aSet, 'object')\n+  t.assert.ok(aSet, 'object')\n \n   const item = {}\n   aSet.add(item)\n   aSet.add({ another: 'item' })\n   aSet.delete(item)\n-  t.equal(aSet.has(item), true)\n+  t.assert.strictEqual(aSet.has(item), true)\n \n   for (const i of aSet) {\n-    t.fail('should not have any items', i)\n+    t.assert.fail('should not have any items: ' + i)\n   }\n })\n",
					"match": false,
					"packageHash": "102253fe69f41d764eda2fb96675016d5d4a99cb9f22f3404e6286d225d0288e",
					"size": 379,
					"sourceHash": "c155ca90d2d98a52ce8dbd71ca1243a9a1d7a452d958d7dc4f5030e74c9e70f3",
					"status": "content"
				},
				"test/nullable-validation.test.js": {
					"diff": "--- published/test/nullable-validation.test.js\n+++ rebuilt/test/nullable-validation.test.js\n@@ -1,18 +1,16 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n-const sget = require('simple-get').concat\n+const { test } = require('node:test')\n const Fastify = require('..')\n \n-test('nullable string', t => {\n+test('nullable string', (t, done) => {\n   t.plan(3)\n   const fastify = Fastify()\n   fastify.route({\n     method: 'POST',\n     url: '/',\n     handler: (req, reply) => {\n-      t.same(req.body.hello, null)\n+      t.assert.strictEqual(req.body.hello, null)\n       reply.code(200).send(req.body)\n     },\n     schema: {\n@@ -47,13 +45,14 @@\n       hello: null\n     }\n   }, (err, res) => {\n-    t.error(err)\n-    t.same(res.payload.hello, null)\n+    t.assert.ifError(err)\n+    t.assert.strictEqual(res.json().hello, null)\n+    done()\n   })\n })\n \n-test('object or null body', t => {\n-  t.plan(5)\n+test('object or null body', async (t) => {\n+  t.plan(4)\n \n   const fastify = Fastify()\n \n@@ -61,7 +60,7 @@\n     method: 'POST',\n     url: '/',\n     handler: (req, reply) => {\n-      t.equal(req.body, undefined)\n+      t.assert.strictEqual(req.body, undefined)\n       reply.code(200).send({ isUndefinedBody: req.body === undefined })\n     },\n     schema: {\n@@ -88,23 +87,20 @@\n     }\n   })\n \n-  fastify.listen({ port: 0 }, (err) => {\n-    t.error(err)\n-    t.teardown(() => { fastify.close() })\n-\n-    sget({\n-      method: 'POST',\n-      url: 'http://localhost:' + fastify.server.address().port\n-    }, (err, response, body) => {\n-      t.error(err)\n-      t.equal(response.statusCode, 200)\n-      t.same(JSON.parse(body), { isUndefinedBody: true })\n-    })\n+  const fastifyServer = await fastify.listen({ port: 0 })\n+  t.after(() => { fastify.close() })\n+\n+  const result = await fetch(fastifyServer, {\n+    method: 'POST'\n   })\n+\n+  t.assert.ok(result.ok)\n+  t.assert.strictEqual(result.status, 200)\n+  t.assert.deepStrictEqual(await result.json(), { isUndefinedBody: true })\n })\n \n-test('nullable body', t => {\n-  t.plan(5)\n+test('nullable body', async (t) => {\n+  t.plan(4)\n \n   const fastify = Fastify()\n \n@@ -112,7 +108,7 @@\n     method: 'POST',\n     url: '/',\n     handler: (req, reply) => {\n-      t.equal(req.body, undefined)\n+      t.assert.strictEqual(req.body, undefined)\n       reply.code(200).send({ isUndefinedBody: req.body === undefined })\n     },\n     schema: {\n@@ -140,23 +136,20 @@\n     }\n   })\n \n",
					"match": false,
					"packageHash": "57d4cd340a1151e75a8afdc2c4db2edd377e182da7dfe5ec3c18f0ac7a2ea3bc",
					"size": 3894,
					"sourceHash": "a59f8b8ec7485d040277096eab3ff22648ebd97564fb402501b647b5d42e5b11",
					"status": "content"
				},
				"test/options.error-handler.test.js": {
					"diff": "--- published/test/options.error-handler.test.js\n+++ rebuilt/test/options.error-handler.test.js\n@@ -1,5 +1,5 @@\n 'use strict'\n \n-const t = require('tap')\n+const t = require('node:test')\n require('./helper').payloadMethod('options', t, true)\n require('./input-validation').payloadMethod('options', t)\n",
					"match": false,
					"packageHash": "67d0a9766c1a713b10a30b869a5f0234ff63fcc9288df4452dfa686cd8baab16",
					"size": 151,
					"sourceHash": "0da71f909c1f6ceaa52845a060fbed2c69bd1e28405be6a161cbb0a702c8a385",
					"status": "content"
				},
				"test/options.test.js": {
					"diff": "--- published/test/options.test.js\n+++ rebuilt/test/options.test.js\n@@ -1,5 +1,5 @@\n 'use strict'\n \n-const t = require('tap')\n+const t = require('node:test')\n require('./helper').payloadMethod('options', t)\n require('./input-validation').payloadMethod('options', t)\n",
					"match": false,
					"packageHash": "7b29f60582f8d0568f5af9facd1a37e7099be41aadb286f92766c6aeca05fbb0",
					"size": 145,
					"sourceHash": "aa2c7036f649cf0e09091d746b5c8a939ea1fcbbaab94bcbe3d305289f921b48",
					"status": "content"
				},
				"test/output-validation.test.js": {
					"diff": "--- published/test/output-validation.test.js\n+++ rebuilt/test/output-validation.test.js\n@@ -1,8 +1,6 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n-const sget = require('simple-get').concat\n+const { test } = require('node:test')\n const fastify = require('..')()\n \n const opts = {\n@@ -34,9 +32,9 @@\n     fastify.get('/string', opts, function (req, reply) {\n       reply.code(200).send({ hello: 'world' })\n     })\n-    t.pass()\n+    t.assert.ok(true)\n   } catch (e) {\n-    t.fail()\n+    t.assert.fail()\n   }\n })\n \n@@ -46,9 +44,9 @@\n     fastify.get('/number', opts, function (req, reply) {\n       reply.code(201).send({ hello: 55 })\n     })\n-    t.pass()\n+    t.assert.ok(true)\n   } catch (e) {\n-    t.fail()\n+    t.assert.fail()\n   }\n })\n \n@@ -59,9 +57,9 @@\n       // will send { }\n       reply.code(201).send({ hello: 'world' })\n     })\n-    t.pass()\n+    t.assert.ok(true)\n   } catch (e) {\n-    t.fail()\n+    t.assert.fail()\n   }\n })\n \n@@ -72,9 +70,9 @@\n     fastify.get('/empty', opts, function (req, reply) {\n       reply.code(204).send()\n     })\n-    t.pass()\n+    t.assert.ok(true)\n   } catch (e) {\n-    t.fail()\n+    t.assert.fail()\n   }\n })\n \n@@ -84,80 +82,59 @@\n     fastify.get('/400', opts, function (req, reply) {\n       reply.code(400).send({ hello: 'DOOM' })\n     })\n-    t.pass()\n+    t.assert.ok(true)\n   } catch (e) {\n-    t.fail()\n+    t.assert.fail()\n   }\n })\n \n-fastify.listen({ port: 0 }, err => {\n-  t.error(err)\n-  t.teardown(() => { fastify.close() })\n-\n-  test('shorthand - string get ok', t => {\n-    t.plan(4)\n-    sget({\n-      method: 'GET',\n-      url: 'http://localhost:' + fastify.server.address().port + '/string'\n-    }, (err, response, body) => {\n-      t.error(err)\n-      t.equal(response.statusCode, 200)\n-      t.equal(response.headers['content-length'], '' + body.length)\n-      t.same(JSON.parse(body), { hello: 'world' })\n-    })\n+test('start server and run tests', async (t) => {\n+  const fastifyServer = await fastify.listen({ port: 0 })\n+  t.after(() => fastify.close())\n+\n+  await test('shorthand - string get ok', async (t) => {\n+    const result = await fetch(fastifyServer + '/string')\n+    t.assert.ok(result.ok)\n+    t.assert.strictEqual(result.status, 200)\n+    const body = await result.text()\n+    t.assert.strictEqual(result.headers.get('content-length'), '' + body.length)\n+    t.assert.deepStrictEqual(JSON.parse(body), { hello: 'world' })\n   })\n \n",
					"match": false,
					"packageHash": "d82655fc4da2a98ab4e445ac252fc9ddbb0fb2e369c2a9f900509414f20b9c5a",
					"size": 3641,
					"sourceHash": "ed52be204806bb487496bbac21ff5fd0c65f1515cbb4e42613ec1e3a27a4084d",
					"status": "content"
				},
				"test/patch.error-handler.test.js": {
					"diff": "--- published/test/patch.error-handler.test.js\n+++ rebuilt/test/patch.error-handler.test.js\n@@ -1,5 +1,5 @@\n 'use strict'\n \n-const t = require('tap')\n+const t = require('node:test')\n require('./helper').payloadMethod('patch', t, true)\n require('./input-validation').payloadMethod('patch', t)\n",
					"match": false,
					"packageHash": "4efb5474db0aa66fe1a71cf7cb246d77a572d488af1965ccfdb0825a22141c69",
					"size": 147,
					"sourceHash": "141d492c8947b0d06abf935e82e68c8d8139bbda07b1f1871901304944d28429",
					"status": "content"
				},
				"test/patch.test.js": {
					"diff": "--- published/test/patch.test.js\n+++ rebuilt/test/patch.test.js\n@@ -1,5 +1,5 @@\n 'use strict'\n \n-const t = require('tap')\n+const t = require('node:test')\n require('./helper').payloadMethod('patch', t)\n require('./input-validation').payloadMethod('patch', t)\n",
					"match": false,
					"packageHash": "d6684c3e8e219126047bbe30888174cb37805b2aa1861b2a127f68a14b6bb384",
					"size": 141,
					"sourceHash": "65655c809a4d6ca39f7bd6a492af06fe5da8e5f891d6479afd264f2f2215c6f6",
					"status": "content"
				},
				"test/plugin.name.display.js": {
					"diff": "--- published/test/plugin.name.display.js\n+++ rebuilt/test/plugin.name.display.js\n@@ -1,6 +1,6 @@\n 'use strict'\n \n-const assert = require('assert')\n+const assert = require('node:assert')\n \n module.exports = function (fastify, opts, done) {\n   assert.strictEqual(fastify.pluginName, 'test-plugin')\n",
					"match": false,
					"packageHash": "cfb7e9c755cb18f2d6584e8795221d904c3e7f5ada73926fb4d3262d1d6bf3a6",
					"size": 233,
					"sourceHash": "e3e1ac28a6c23696dade16c11558dfbfff92681aff11ce03d8eab4f6e92f749d",
					"status": "content"
				},
				"test/plugin.test.js": {
					"match": false,
					"packageHash": "0d4daf0bf2b6cf44f73d136da79f016dead49f75365ddea323f6dbf2213d897c",
					"size": 30002,
					"status": "missing-in-source"
				},
				"test/pretty-print.test.js": {
					"diff": "--- published/test/pretty-print.test.js\n+++ rebuilt/test/pretty-print.test.js\n@@ -1,10 +1,9 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const Fastify = require('..')\n \n-test('pretty print - static routes', t => {\n+test('pretty print - static routes', (t, done) => {\n   t.plan(2)\n \n   const fastify = Fastify({ exposeHeadRoutes: false })\n@@ -15,18 +14,56 @@\n   fastify.ready(() => {\n     const tree = fastify.printRoutes()\n \n-    const expected = `└── /\n+    const expected = `\\\n+└── /\n     ├── test (GET)\n     │   └── /hello (GET)\n     └── hello/world (GET)\n `\n \n-    t.equal(typeof tree, 'string')\n-    t.equal(tree, expected)\n+    t.assert.strictEqual(typeof tree, 'string')\n+    t.assert.strictEqual(tree, expected)\n+    done()\n   })\n })\n \n-test('pretty print - parametric routes', t => {\n+test('pretty print - internal tree - static routes', (t, done) => {\n+  t.plan(4)\n+\n+  const fastify = Fastify({ exposeHeadRoutes: false })\n+  fastify.get('/test', () => {})\n+  fastify.get('/test/hello', () => {})\n+  fastify.get('/hello/world', () => {})\n+\n+  fastify.put('/test', () => {})\n+  fastify.put('/test/foo', () => {})\n+\n+  fastify.ready(() => {\n+    const getTree = fastify.printRoutes({ method: 'GET' })\n+    const expectedGetTree = `\\\n+└── /\n+    ├── test (GET)\n+    │   └── /hello (GET)\n+    └── hello/world (GET)\n+`\n+\n+    t.assert.strictEqual(typeof getTree, 'string')\n+    t.assert.strictEqual(getTree, expectedGetTree)\n+\n+    const putTree = fastify.printRoutes({ method: 'PUT' })\n+    const expectedPutTree = `\\\n+└── /\n+    └── test (PUT)\n+        └── /foo (PUT)\n+`\n+\n+    t.assert.strictEqual(typeof putTree, 'string')\n+    t.assert.strictEqual(putTree, expectedPutTree)\n+    done()\n+  })\n+})\n+\n+test('pretty print - parametric routes', (t, done) => {\n   t.plan(2)\n \n   const fastify = Fastify({ exposeHeadRoutes: false })\n@@ -37,18 +74,61 @@\n   fastify.ready(() => {\n     const tree = fastify.printRoutes()\n \n-    const expected = `└── /\n+    const expected = `\\\n+└── /\n+    ├── test (GET)\n+    │   └── /\n+    │       └── :hello (GET)\n+    └── hello/\n+        └── :world (GET)\n+`\n+\n+    t.assert.strictEqual(typeof tree, 'string')\n+    t.assert.strictEqual(tree, expected)\n+    done()\n+  })\n+})\n+\n+test('pretty print - internal tree - parametric routes', (t, done) => {\n+  t.plan(4)\n+\n+  const fastify = Fastify({ exposeHeadRoutes: false })\n",
					"match": false,
					"packageHash": "d595a4ff9afca2d65f6a9bac590b988802d1825c861365ae2ef3bc6b40362eae",
					"size": 6203,
					"sourceHash": "2eef7ec9aa5a54d0d463d5aeb7deaa4cd2061393863b16f25fff7793cdc7f741",
					"status": "content"
				},
				"test/promises.test.js": {
					"diff": "--- published/test/promises.test.js\n+++ rebuilt/test/promises.test.js\n@@ -1,10 +1,11 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n-const sget = require('simple-get').concat\n+const { test } = require('node:test')\n+const assert = require('node:assert')\n const fastify = require('..')()\n \n+test.after(() => fastify.close())\n+\n const opts = {\n   schema: {\n     response: {\n@@ -60,81 +61,65 @@\n   return reply.send({ hello: 'world' })\n })\n \n-fastify.listen({ port: 0 }, err => {\n-  t.error(err)\n-  t.teardown(() => { fastify.close() })\n+fastify.listen({ port: 0 }, (err, fastifyServer) => {\n+  assert.ifError(err)\n \n-  test('shorthand - sget return promise es6 get', t => {\n+  test('shorthand - fetch return promise es6 get', async t => {\n     t.plan(4)\n-    sget({\n-      method: 'GET',\n-      url: 'http://localhost:' + fastify.server.address().port + '/return'\n-    }, (err, response, body) => {\n-      t.error(err)\n-      t.equal(response.statusCode, 200)\n-      t.equal(response.headers['content-length'], '' + body.length)\n-      t.same(JSON.parse(body), { hello: 'world' })\n-    })\n+\n+    const result = await fetch(`${fastifyServer}/return`)\n+    t.assert.ok(result.ok)\n+    t.assert.strictEqual(result.status, 200)\n+    const body = await result.text()\n+    t.assert.strictEqual(result.headers.get('content-length'), '' + body.length)\n+    t.assert.deepStrictEqual(JSON.parse(body), { hello: 'world' })\n   })\n \n-  test('shorthand - sget promise es6 get return error', t => {\n+  test('shorthand - fetch promise es6 get return error', async t => {\n     t.plan(2)\n-    sget({\n-      method: 'GET',\n-      url: 'http://localhost:' + fastify.server.address().port + '/return-error'\n-    }, (err, response, body) => {\n-      t.error(err)\n-      t.equal(response.statusCode, 500)\n-    })\n+\n+    const result = await fetch(`${fastifyServer}/return-error`)\n+    t.assert.ok(!result.ok)\n+    t.assert.strictEqual(result.status, 500)\n   })\n \n-  test('sget promise double send', t => {\n+  test('fetch promise double send', async t => {\n     t.plan(3)\n \n-    sget({\n-      method: 'GET',\n-      url: 'http://localhost:' + fastify.server.address().port + '/double'\n-    }, (err, response, body) => {\n-      t.error(err)\n-      t.equal(response.statusCode, 200)\n-      t.same(JSON.parse(body), { hello: '42' })\n-    })\n+    const result = await fetch(`${fastifyServer}/double`)\n+    t.assert.ok(result.ok)\n+    t.assert.strictEqual(result.status, 200)\n+    const body = await result.text()\n+    t.assert.deepStrictEqual(JSON.parse(body), { hello: '42' })\n   })\n \n-  test('thenable', t => {\n+  test('thenable', async t => {\n     t.plan(4)\n-    sget({\n-      method: 'GET',\n-      url: 'http://localhost:' + fastify.server.address().port + '/thenable'\n-    }, (err, response, body) => {\n-      t.error(err)\n-      t.equal(response.statusCode, 200)\n-      t.equal(response.headers['content-length'], '' + body.length)\n-      t.same(JSON.parse(body), { hello: 'world' })\n-    })\n+\n+    const result = await fetch(`${fastifyServer}/thenable`)\n+    t.assert.ok(result.ok)\n+    t.assert.strictEqual(result.status, 200)\n+    const body = await result.text()\n",
					"match": false,
					"packageHash": "e21bcda0a8777d88c320479c0de1c648320cf752622aded5fa01bdf47d414869",
					"size": 3391,
					"sourceHash": "577853f550c48a4dfa2f011a013d7d76359a506b03cf45d258f0d8db32dc3329",
					"status": "content"
				},
				"test/propfind.test.js": {
					"match": false,
					"packageHash": "0df6a6ceebe6f68e7324f9bb6b6ae05f283e6525516d4a5675f4b2c717b3bcb3",
					"size": 3329,
					"status": "missing-in-source"
				},
				"test/proppatch.test.js": {
					"match": false,
					"packageHash": "d5974c9623dd4eced7b82849149753a62692f70faa13dab10be7fd2c44501571",
					"size": 2234,
					"status": "missing-in-source"
				},
				"test/proto-poisoning.test.js": {
					"diff": "--- published/test/proto-poisoning.test.js\n+++ rebuilt/test/proto-poisoning.test.js\n@@ -1,159 +1,145 @@\n 'use strict'\n \n const Fastify = require('..')\n-const sget = require('simple-get').concat\n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n \n-test('proto-poisoning error', t => {\n-  t.plan(3)\n+test('proto-poisoning error', async (t) => {\n+  t.plan(2)\n \n   const fastify = Fastify()\n-  t.teardown(fastify.close.bind(fastify))\n \n   fastify.post('/', (request, reply) => {\n-    t.fail('handler should not be called')\n+    t.assert.fail('handler should not be called')\n   })\n \n-  fastify.listen({ port: 0 }, function (err) {\n-    t.error(err)\n+  t.after(() => fastify.close())\n+\n+  const fastifyServer = await fastify.listen({ port: 0 })\n \n-    sget({\n-      method: 'POST',\n-      url: 'http://localhost:' + fastify.server.address().port,\n-      headers: { 'Content-Type': 'application/json' },\n-      body: '{ \"__proto__\": { \"a\": 42 } }'\n-    }, (err, response, body) => {\n-      t.error(err)\n-      t.equal(response.statusCode, 400)\n-    })\n+  const result = await fetch(fastifyServer, {\n+    method: 'POST',\n+    headers: { 'Content-Type': 'application/json' },\n+    body: '{ \"__proto__\": { \"a\": 42 } }'\n   })\n+\n+  t.assert.ok(!result.ok)\n+  t.assert.strictEqual(result.status, 400)\n })\n \n-test('proto-poisoning remove', t => {\n-  t.plan(4)\n+test('proto-poisoning remove', async (t) => {\n+  t.plan(3)\n \n   const fastify = Fastify({ onProtoPoisoning: 'remove' })\n-  t.teardown(fastify.close.bind(fastify))\n+\n+  t.after(() => fastify.close())\n \n   fastify.post('/', (request, reply) => {\n-    t.equal(undefined, Object.assign({}, request.body).a)\n+    t.assert.strictEqual(undefined, Object.assign({}, request.body).a)\n     reply.send({ ok: true })\n   })\n \n-  fastify.listen({ port: 0 }, function (err) {\n-    t.error(err)\n+  const fastifyServer = await fastify.listen({ port: 0 })\n \n-    sget({\n-      method: 'POST',\n-      url: 'http://localhost:' + fastify.server.address().port,\n-      headers: { 'Content-Type': 'application/json' },\n-      body: '{ \"__proto__\": { \"a\": 42 }, \"b\": 42 }'\n-    }, (err, response, body) => {\n-      t.error(err)\n-      t.equal(response.statusCode, 200)\n-    })\n+  const result = await fetch(fastifyServer, {\n+    method: 'POST',\n+    headers: { 'Content-Type': 'application/json' },\n+    body: '{ \"__proto__\": { \"a\": 42 }, \"b\": 42 }'\n   })\n+\n+  t.assert.ok(result.ok)\n+  t.assert.strictEqual(result.status, 200)\n })\n \n-test('proto-poisoning ignore', t => {\n-  t.plan(4)\n+test('proto-poisoning ignore', async (t) => {\n+  t.plan(3)\n \n   const fastify = Fastify({ onProtoPoisoning: 'ignore' })\n-  t.teardown(fastify.close.bind(fastify))\n \n   fastify.post('/', (request, reply) => {\n-    t.equal(42, Object.assign({}, request.body).a)\n+    t.assert.strictEqual(42, Object.assign({}, request.body).a)\n     reply.send({ ok: true })\n",
					"match": false,
					"packageHash": "1108553280c0764cbdb60fae845f38b5f6528176696ca03f371e78fefd688fee",
					"size": 3980,
					"sourceHash": "3f39535a8e51f2b8c3cf5acd6711295ad7cc043274e51b8114bd3adf61282232",
					"status": "content"
				},
				"test/put.error-handler.test.js": {
					"diff": "--- published/test/put.error-handler.test.js\n+++ rebuilt/test/put.error-handler.test.js\n@@ -1,5 +1,5 @@\n 'use strict'\n \n-const t = require('tap')\n+const t = require('node:test')\n require('./helper').payloadMethod('put', t, true)\n require('./input-validation').payloadMethod('put', t)\n",
					"match": false,
					"packageHash": "e4859f7562b1dde02255f5969dcf5c4e99a8021ee62ce1fc7597d7fb7eacd722",
					"size": 143,
					"sourceHash": "7743cab870735a5b30a5ce1a09d2b78c08ebf832507c49a065242281cbe69315",
					"status": "content"
				},
				"test/put.test.js": {
					"diff": "--- published/test/put.test.js\n+++ rebuilt/test/put.test.js\n@@ -1,5 +1,5 @@\n 'use strict'\n \n-const t = require('tap')\n+const t = require('node:test')\n require('./helper').payloadMethod('put', t)\n require('./input-validation').payloadMethod('put', t)\n",
					"match": false,
					"packageHash": "9cc8555e80660a63a3d4c1dbc116dc877fc8a3be0ade5a31409e41e605722566",
					"size": 137,
					"sourceHash": "5064b64ae8637355214a4f3bda58a5f54182e8b99cdd79d8ea10b0bbd1f52648",
					"status": "content"
				},
				"test/register.test.js": {
					"diff": "--- published/test/register.test.js\n+++ rebuilt/test/register.test.js\n@@ -1,23 +1,19 @@\n 'use strict'\n \n-/* eslint no-prototype-builtins: 0 */\n-\n-const t = require('tap')\n-const test = t.test\n-const sget = require('simple-get').concat\n+const { test } = require('node:test')\n const Fastify = require('..')\n \n-test('register', t => {\n-  t.plan(17)\n+test('register', async (t) => {\n+  t.plan(16)\n \n   const fastify = Fastify()\n \n   fastify.register(function (instance, opts, done) {\n-    t.not(instance, fastify)\n-    t.ok(fastify.isPrototypeOf(instance))\n+    t.assert.notStrictEqual(instance, fastify)\n+    t.assert.ok(Object.prototype.isPrototypeOf.call(fastify, instance))\n \n-    t.equal(typeof opts, 'object')\n-    t.equal(typeof done, 'function')\n+    t.assert.strictEqual(typeof opts, 'object')\n+    t.assert.strictEqual(typeof done, 'function')\n \n     instance.get('/first', function (req, reply) {\n       reply.send({ hello: 'world' })\n@@ -26,11 +22,11 @@\n   })\n \n   fastify.register(function (instance, opts, done) {\n-    t.not(instance, fastify)\n-    t.ok(fastify.isPrototypeOf(instance))\n+    t.assert.notStrictEqual(instance, fastify)\n+    t.assert.ok(Object.prototype.isPrototypeOf.call(fastify, instance))\n \n-    t.equal(typeof opts, 'object')\n-    t.equal(typeof done, 'function')\n+    t.assert.strictEqual(typeof opts, 'object')\n+    t.assert.strictEqual(typeof done, 'function')\n \n     instance.get('/second', function (req, reply) {\n       reply.send({ hello: 'world' })\n@@ -38,28 +34,23 @@\n     done()\n   })\n \n-  fastify.listen({ port: 0 }, err => {\n-    t.error(err)\n-    t.teardown(() => { fastify.close() })\n+  const fastifyServer = await fastify.listen({ port: 0 })\n+  t.after(() => fastify.close())\n \n-    makeRequest('first')\n-    makeRequest('second')\n-  })\n+  await makeRequest('first')\n+  await makeRequest('second')\n \n-  function makeRequest (path) {\n-    sget({\n-      method: 'GET',\n-      url: 'http://localhost:' + fastify.server.address().port + '/' + path\n-    }, (err, response, body) => {\n-      t.error(err)\n-      t.equal(response.statusCode, 200)\n-      t.equal(response.headers['content-length'], '' + body.length)\n-      t.same(JSON.parse(body), { hello: 'world' })\n-    })\n+  async function makeRequest (path) {\n+    const response = await fetch(fastifyServer + '/' + path)\n+    t.assert.ok(response.ok)\n+    t.assert.strictEqual(response.status, 200)\n+    const body = await response.text()\n+    t.assert.strictEqual(response.headers.get('content-length'), '' + body.length)\n+    t.assert.deepStrictEqual(JSON.parse(body), { hello: 'world' })\n   }\n })\n \n-test('internal route declaration should pass the error generated by the register to the done handler / 1', t => {\n+test('internal route declaration should pass the error generated by the register to the done handler / 1', (t, done) => {\n   t.plan(1)\n   const fastify = Fastify()\n \n@@ -72,12 +63,13 @@\n   })\n \n   fastify.listen({ port: 0 }, err => {\n-    fastify.close()\n-    t.equal(err.message, 'kaboom')\n+    t.after(() => fastify.close())\n+    t.assert.strictEqual(err.message, 'kaboom')\n+    done()\n   })\n",
					"match": false,
					"packageHash": "e63e5b2c002031c3d418cd40f65538712cfb8179e60397e33ea61f58d8e1f9e0",
					"size": 4090,
					"sourceHash": "25809cfd06584124a2f64cf96b38ee9c82fec4db4ae03f1a4325a2b31a6dcf04",
					"status": "content"
				},
				"test/reply-error.test.js": {
					"diff": "--- published/test/reply-error.test.js\n+++ rebuilt/test/reply-error.test.js\n@@ -1,13 +1,12 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n-const net = require('net')\n+const { test, describe } = require('node:test')\n+const net = require('node:net')\n const Fastify = require('..')\n-const statusCodes = require('http').STATUS_CODES\n+const statusCodes = require('node:http').STATUS_CODES\n const split = require('split2')\n-const fs = require('fs')\n-const path = require('path')\n+const fs = require('node:fs')\n+const path = require('node:path')\n \n const codes = Object.keys(statusCodes)\n codes.forEach(code => {\n@@ -15,9 +14,10 @@\n })\n \n function helper (code) {\n-  test('Reply error handling - code: ' + code, t => {\n+  test('Reply error handling - code: ' + code, (t, testDone) => {\n     t.plan(4)\n     const fastify = Fastify()\n+    t.after(() => fastify.close())\n     const err = new Error('winter is coming')\n \n     fastify.get('/', (req, reply) => {\n@@ -30,10 +30,10 @@\n       method: 'GET',\n       url: '/'\n     }, (error, res) => {\n-      t.error(error)\n-      t.equal(res.statusCode, Number(code))\n-      t.equal(res.headers['content-type'], 'application/json; charset=utf-8')\n-      t.same(\n+      t.assert.ifError(error)\n+      t.assert.strictEqual(res.statusCode, Number(code))\n+      t.assert.strictEqual(res.headers['content-type'], 'application/json; charset=utf-8')\n+      t.assert.deepStrictEqual(\n         {\n           error: statusCodes[code],\n           message: err.message,\n@@ -41,13 +41,15 @@\n         },\n         JSON.parse(res.payload)\n       )\n+      testDone()\n     })\n   })\n }\n \n-test('preHandler hook error handling with external code', t => {\n+test('preHandler hook error handling with external code', (t, testDone) => {\n   t.plan(3)\n   const fastify = Fastify()\n+  t.after(() => fastify.close())\n   const err = new Error('winter is coming')\n \n   fastify.addHook('preHandler', (req, reply, done) => {\n@@ -61,9 +63,9 @@\n     method: 'GET',\n     url: '/'\n   }, (error, res) => {\n-    t.error(error)\n-    t.equal(res.statusCode, 400)\n-    t.same(\n+    t.assert.ifError(error)\n+    t.assert.strictEqual(res.statusCode, 400)\n+    t.assert.deepStrictEqual(\n       {\n         error: statusCodes['400'],\n         message: err.message,\n@@ -71,12 +73,14 @@\n       },\n       JSON.parse(res.payload)\n     )\n+    testDone()\n   })\n })\n \n-test('onRequest hook error handling with external done', t => {\n+test('onRequest hook error handling with external done', (t, testDone) => {\n   t.plan(3)\n   const fastify = Fastify()\n+  t.after(() => fastify.close())\n   const err = new Error('winter is coming')\n \n   fastify.addHook('onRequest', (req, reply, done) => {\n@@ -90,9 +94,9 @@\n     method: 'GET',\n     url: '/'\n   }, (error, res) => {\n-    t.error(error)\n-    t.equal(res.statusCode, 400)\n",
					"match": false,
					"packageHash": "763f8da9f4e4f283a535378f5127f7616160a45959e9047f1b857ff38ad8e151",
					"size": 16872,
					"sourceHash": "3bb298889f2c36aa74094286bef01d2051f40bb51a351a40665dd95b0808da52",
					"status": "content"
				},
				"test/reply-trailers.test.js": {
					"diff": "--- published/test/reply-trailers.test.js\n+++ rebuilt/test/reply-trailers.test.js\n@@ -1,19 +1,19 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test, describe } = require('node:test')\n const Fastify = require('..')\n-const { Readable } = require('stream')\n-const { createHash } = require('crypto')\n+const { Readable } = require('node:stream')\n+const { createHash } = require('node:crypto')\n+const { sleep } = require('./helper')\n \n-test('send trailers when payload is empty string', t => {\n+test('send trailers when payload is empty string', (t, testDone) => {\n   t.plan(5)\n \n   const fastify = Fastify()\n \n   fastify.get('/', function (request, reply) {\n-    reply.trailer('ETag', function (reply, payload) {\n-      return 'custom-etag'\n+    reply.trailer('ETag', function (reply, payload, done) {\n+      done(null, 'custom-etag')\n     })\n     reply.send('')\n   })\n@@ -22,22 +22,23 @@\n     method: 'GET',\n     url: '/'\n   }, (error, res) => {\n-    t.error(error)\n-    t.equal(res.statusCode, 200)\n-    t.equal(res.headers.trailer, 'etag')\n-    t.equal(res.trailers.etag, 'custom-etag')\n-    t.notHas(res.headers, 'content-length')\n+    t.assert.ifError(error)\n+    t.assert.strictEqual(res.statusCode, 200)\n+    t.assert.strictEqual(res.headers.trailer, 'etag')\n+    t.assert.strictEqual(res.trailers.etag, 'custom-etag')\n+    t.assert.ok(!res.headers['content-length'])\n+    testDone()\n   })\n })\n \n-test('send trailers when payload is empty buffer', t => {\n+test('send trailers when payload is empty buffer', (t, testDone) => {\n   t.plan(5)\n \n   const fastify = Fastify()\n \n   fastify.get('/', function (request, reply) {\n-    reply.trailer('ETag', function (reply, payload) {\n-      return 'custom-etag'\n+    reply.trailer('ETag', function (reply, payload, done) {\n+      done(null, 'custom-etag')\n     })\n     reply.send(Buffer.alloc(0))\n   })\n@@ -46,22 +47,23 @@\n     method: 'GET',\n     url: '/'\n   }, (error, res) => {\n-    t.error(error)\n-    t.equal(res.statusCode, 200)\n-    t.equal(res.headers.trailer, 'etag')\n-    t.equal(res.trailers.etag, 'custom-etag')\n-    t.notHas(res.headers, 'content-length')\n+    t.assert.ifError(error)\n+    t.assert.strictEqual(res.statusCode, 200)\n+    t.assert.strictEqual(res.headers.trailer, 'etag')\n+    t.assert.strictEqual(res.trailers.etag, 'custom-etag')\n+    t.assert.ok(!res.headers['content-length'])\n+    testDone()\n   })\n })\n \n-test('send trailers when payload is undefined', t => {\n+test('send trailers when payload is undefined', (t, testDone) => {\n   t.plan(5)\n \n   const fastify = Fastify()\n \n   fastify.get('/', function (request, reply) {\n-    reply.trailer('ETag', function (reply, payload) {\n-      return 'custom-etag'\n+    reply.trailer('ETag', function (reply, payload, done) {\n+      done(null, 'custom-etag')\n     })\n     reply.send(undefined)\n   })\n@@ -70,15 +72,16 @@\n     method: 'GET',\n     url: '/'\n   }, (error, res) => {\n-    t.error(error)\n-    t.equal(res.statusCode, 200)\n-    t.equal(res.headers.trailer, 'etag')\n",
					"match": false,
					"packageHash": "f7346b5931b1c3bdb77bf180a921d9a37ece040e587ca428ed129b97b2527609",
					"size": 6601,
					"sourceHash": "d1feae1a36f16b0c4c1b6103c7f61a5cdfa51ff5b7cf3548392f2cb9261ff9e0",
					"status": "content"
				},
				"test/request-error.test.js": {
					"diff": "--- published/test/request-error.test.js\n+++ rebuilt/test/request-error.test.js\n@@ -1,12 +1,14 @@\n 'use strict'\n \n-const { connect } = require('net')\n-const t = require('tap')\n-const test = t.test\n+const { connect } = require('node:net')\n+const { test } = require('node:test')\n const Fastify = require('..')\n const { kRequest } = require('../lib/symbols.js')\n+const split = require('split2')\n+const { Readable } = require('node:stream')\n+const { getServerUrl } = require('./helper')\n \n-test('default 400 on request error', t => {\n+test('default 400 on request error', (t, done) => {\n   t.plan(4)\n \n   const fastify = Fastify()\n@@ -25,25 +27,26 @@\n       text: '12345678901234567890123456789012345678901234567890'\n     }\n   }, (err, res) => {\n-    t.error(err)\n-    t.equal(res.statusCode, 400)\n-    t.equal(res.headers['content-type'], 'application/json; charset=utf-8')\n-    t.same(JSON.parse(res.payload), {\n+    t.assert.ifError(err)\n+    t.assert.strictEqual(res.statusCode, 400)\n+    t.assert.strictEqual(res.headers['content-type'], 'application/json; charset=utf-8')\n+    t.assert.deepStrictEqual(JSON.parse(res.payload), {\n       error: 'Bad Request',\n       message: 'Simulated',\n       statusCode: 400\n     })\n+    done()\n   })\n })\n \n-test('default 400 on request error with custom error handler', t => {\n+test('default 400 on request error with custom error handler', (t, done) => {\n   t.plan(6)\n \n   const fastify = Fastify()\n \n   fastify.setErrorHandler(function (err, request, reply) {\n-    t.type(request, 'object')\n-    t.type(request, fastify[kRequest].parent)\n+    t.assert.strictEqual(typeof request, 'object')\n+    t.assert.strictEqual(request instanceof fastify[kRequest].parent, true)\n     reply\n       .code(err.statusCode)\n       .type('application/json; charset=utf-8')\n@@ -64,18 +67,19 @@\n       text: '12345678901234567890123456789012345678901234567890'\n     }\n   }, (err, res) => {\n-    t.error(err)\n-    t.equal(res.statusCode, 400)\n-    t.equal(res.headers['content-type'], 'application/json; charset=utf-8')\n-    t.same(JSON.parse(res.payload), {\n+    t.assert.ifError(err)\n+    t.assert.strictEqual(res.statusCode, 400)\n+    t.assert.strictEqual(res.headers['content-type'], 'application/json; charset=utf-8')\n+    t.assert.deepStrictEqual(JSON.parse(res.payload), {\n       error: 'Bad Request',\n       message: 'Simulated',\n       statusCode: 400\n     })\n+    done()\n   })\n })\n \n-test('default clientError handler ignores ECONNRESET', t => {\n+test('default clientError handler ignores ECONNRESET', (t, done) => {\n   t.plan(3)\n \n   let logs = ''\n@@ -106,8 +110,8 @@\n   })\n \n   fastify.listen({ port: 0 }, function (err) {\n-    t.error(err)\n-    t.teardown(() => { fastify.close() })\n+    t.assert.ifError(err)\n+    t.after(() => fastify.close())\n \n     const client = connect(fastify.server.address().port)\n \n@@ -116,12 +120,14 @@\n     })\n \n     client.on('end', () => {\n-      t.match(response, /^HTTP\\/1.1 200 OK/)\n-      t.notMatch(logs, /ECONNRESET/)\n+      t.assert.match(response, /^HTTP\\/1.1 200 OK/)\n+      t.assert.notEqual(logs, /ECONNRESET/)\n+      done()\n",
					"match": false,
					"packageHash": "ac0991e5c109479fd969a18d56797948ec507790511a110ac4dc13c371b82144",
					"size": 6929,
					"sourceHash": "f36091c29eacae165ac82612fa4718f1c9ad7b97453da245a62c1143a71e97a7",
					"status": "content"
				},
				"test/requestTimeout.test.js": {
					"match": false,
					"packageHash": "ea5c9bd7f1c1a7284d7694e7d9a052466f7fa335050000d6531505db9f66c1db",
					"size": 1294,
					"status": "missing-in-source"
				},
				"test/route-hooks.test.js": {
					"diff": "--- published/test/route-hooks.test.js\n+++ rebuilt/test/route-hooks.test.js\n@@ -1,8 +1,7 @@\n 'use strict'\n \n-const { Readable } = require('stream')\n-const test = require('tap').test\n-const sget = require('simple-get').concat\n+const { Readable } = require('node:stream')\n+const { test } = require('node:test')\n const Fastify = require('../')\n \n process.removeAllListeners('warning')\n@@ -16,13 +15,13 @@\n }\n \n function testExecutionHook (hook) {\n-  test(`${hook}`, t => {\n+  test(`${hook}`, (t, testDone) => {\n     t.plan(3)\n     const fastify = Fastify()\n \n     fastify.post('/', {\n       [hook]: (req, reply, doneOrPayload, done) => {\n-        t.pass('hook called')\n+        t.assert.ok('hook called')\n         endRouteHook(doneOrPayload, done)\n       }\n     }, (req, reply) => {\n@@ -34,13 +33,14 @@\n       url: '/',\n       payload: { hello: 'world' }\n     }, (err, res) => {\n-      t.error(err)\n+      t.assert.ifError(err)\n       const payload = JSON.parse(res.payload)\n-      t.same(payload, { hello: 'world' })\n+      t.assert.deepStrictEqual(payload, { hello: 'world' })\n+      testDone()\n     })\n   })\n \n-  test(`${hook} option should be called after ${hook} hook`, t => {\n+  test(`${hook} option should be called after ${hook} hook`, (t, testDone) => {\n     t.plan(3)\n     const fastify = Fastify()\n     const checker = Object.defineProperty({ calledTimes: 0 }, 'check', {\n@@ -48,13 +48,13 @@\n     })\n \n     fastify.addHook(hook, (req, reply, doneOrPayload, done) => {\n-      t.equal(checker.check, 1)\n+      t.assert.strictEqual(checker.check, 1)\n       endRouteHook(doneOrPayload, done)\n     })\n \n     fastify.post('/', {\n       [hook]: (req, reply, doneOrPayload, done) => {\n-        t.equal(checker.check, 2)\n+        t.assert.strictEqual(checker.check, 2)\n         endRouteHook(doneOrPayload, done)\n       }\n     }, (req, reply) => {\n@@ -66,11 +66,12 @@\n       url: '/',\n       payload: { hello: 'world' }\n     }, (err, res) => {\n-      t.error(err)\n+      t.assert.ifError(err)\n+      testDone()\n     })\n   })\n \n-  test(`${hook} option could accept an array of functions`, t => {\n+  test(`${hook} option could accept an array of functions`, (t, testDone) => {\n     t.plan(3)\n     const fastify = Fastify()\n     const checker = Object.defineProperty({ calledTimes: 0 }, 'check', {\n@@ -80,11 +81,11 @@\n     fastify.post('/', {\n       [hook]: [\n         (req, reply, doneOrPayload, done) => {\n-          t.equal(checker.check, 1)\n+          t.assert.strictEqual(checker.check, 1)\n           endRouteHook(doneOrPayload, done)\n         },\n         (req, reply, doneOrPayload, done) => {\n-          t.equal(checker.check, 2)\n+          t.assert.strictEqual(checker.check, 2)\n           endRouteHook(doneOrPayload, done)\n         }\n       ]\n@@ -97,11 +98,42 @@\n       url: '/',\n       payload: { hello: 'world' }\n     }, (err, res) => {\n-      t.error(err)\n+      t.assert.ifError(err)\n+      testDone()\n     })\n",
					"match": false,
					"packageHash": "e899a32d13a428521d419743ccd114ab8aef8256c8307b05ade3d690c1f9f12c",
					"size": 12760,
					"sourceHash": "dadb1cfe1c7a5f2a3b37b4f82d3c2316568ed3f7e242f27e585fd38b13b952f4",
					"status": "content"
				},
				"test/route-prefix.test.js": {
					"diff": "--- published/test/route-prefix.test.js\n+++ rebuilt/test/route-prefix.test.js\n@@ -1,10 +1,10 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const Fastify = require('..')\n+const { waitForCb } = require('./toolkit')\n \n-test('Prefix options should add a prefix for all the routes inside a register / 1', t => {\n+test('Prefix options should add a prefix for all the routes inside a register / 1', (t, testDone) => {\n   t.plan(6)\n   const fastify = Fastify()\n \n@@ -27,32 +27,37 @@\n     done()\n   }, { prefix: '/v1' })\n \n+  const completion = waitForCb({ steps: 3 })\n   fastify.inject({\n     method: 'GET',\n     url: '/first'\n   }, (err, res) => {\n-    t.error(err)\n-    t.same(JSON.parse(res.payload), { route: '/first' })\n+    t.assert.ifError(err)\n+    t.assert.deepStrictEqual(JSON.parse(res.payload), { route: '/first' })\n+    completion.stepIn()\n   })\n \n   fastify.inject({\n     method: 'GET',\n     url: '/v1/first'\n   }, (err, res) => {\n-    t.error(err)\n-    t.same(JSON.parse(res.payload), { route: '/v1/first' })\n+    t.assert.ifError(err)\n+    t.assert.deepStrictEqual(JSON.parse(res.payload), { route: '/v1/first' })\n+    completion.stepIn()\n   })\n \n   fastify.inject({\n     method: 'GET',\n     url: '/v1/v2/first'\n   }, (err, res) => {\n-    t.error(err)\n-    t.same(JSON.parse(res.payload), { route: '/v1/v2/first' })\n+    t.assert.ifError(err)\n+    t.assert.deepStrictEqual(JSON.parse(res.payload), { route: '/v1/v2/first' })\n+    completion.stepIn()\n   })\n+  completion.patience.then(testDone)\n })\n \n-test('Prefix options should add a prefix for all the routes inside a register / 2', t => {\n+test('Prefix options should add a prefix for all the routes inside a register / 2', (t, testDone) => {\n   t.plan(4)\n   const fastify = Fastify()\n \n@@ -67,24 +72,27 @@\n     done()\n   }, { prefix: '/v1' })\n \n+  const completion = waitForCb({ steps: 2 })\n   fastify.inject({\n     method: 'GET',\n     url: '/v1/first'\n   }, (err, res) => {\n-    t.error(err)\n-    t.same(JSON.parse(res.payload), { route: '/v1/first' })\n+    t.assert.ifError(err)\n+    t.assert.deepStrictEqual(JSON.parse(res.payload), { route: '/v1/first' })\n+    completion.stepIn()\n   })\n-\n   fastify.inject({\n     method: 'GET',\n     url: '/v1/second'\n   }, (err, res) => {\n-    t.error(err)\n-    t.same(JSON.parse(res.payload), { route: '/v1/second' })\n+    t.assert.ifError(err)\n+    t.assert.deepStrictEqual(JSON.parse(res.payload), { route: '/v1/second' })\n+    completion.stepIn()\n   })\n+  completion.patience.then(testDone)\n })\n \n-test('Prefix options should add a prefix for all the chained routes inside a register / 3', t => {\n+test('Prefix options should add a prefix for all the chained routes inside a register / 3', (t, testDone) => {\n   t.plan(4)\n \n   const fastify = Fastify()\n@@ -100,24 +108,27 @@\n     done()\n   }, { prefix: '/v1' })\n \n+  const completion = waitForCb({ steps: 2 })\n",
					"match": false,
					"packageHash": "5794a492df43b16048c337908b22bb72e403f828b1171740d2e66015cf5476d7",
					"size": 18553,
					"sourceHash": "f698c56a252abc5723e4c7161ddd7c08d4085078400a6055a1903316af2b5649",
					"status": "content"
				},
				"test/route.test.js": {
					"match": false,
					"packageHash": "c69860e93e9e942c99ac63c8e35c80a04cd347b569fd267ac2b7a6f2f22db99c",
					"size": 32691,
					"status": "missing-in-source"
				},
				"test/router-options.test.js": {
					"diff": "--- published/test/router-options.test.js\n+++ rebuilt/test/router-options.test.js\n@@ -1,20 +1,15 @@\n 'use strict'\n \n-const test = require('tap').test\n-const sget = require('simple-get')\n+const split = require('split2')\n+const { test } = require('node:test')\n+const querystring = require('node:querystring')\n const Fastify = require('../')\n-const { FST_ERR_BAD_URL } = require('../lib/errors')\n+const {\n+  FST_ERR_BAD_URL,\n+  FST_ERR_ASYNC_CONSTRAINT\n+} = require('../lib/errors')\n \n-function getUrl (app) {\n-  const { address, port } = app.server.address()\n-  if (address === '::1') {\n-    return `http://[${address}]:${port}`\n-  } else {\n-    return `http://${address}:${port}`\n-  }\n-}\n-\n-test('Should honor ignoreTrailingSlash option', t => {\n+test('Should honor ignoreTrailingSlash option', async t => {\n   t.plan(4)\n   const fastify = Fastify({\n     ignoreTrailingSlash: true\n@@ -24,27 +19,16 @@\n     res.send('test')\n   })\n \n-  fastify.listen({ port: 0 }, (err) => {\n-    t.teardown(() => { fastify.close() })\n-    if (err) t.threw(err)\n-\n-    const baseUrl = getUrl(fastify)\n-\n-    sget.concat(baseUrl + '/test', (err, res, data) => {\n-      if (err) t.threw(err)\n-      t.equal(res.statusCode, 200)\n-      t.equal(data.toString(), 'test')\n-    })\n-\n-    sget.concat(baseUrl + '/test/', (err, res, data) => {\n-      if (err) t.threw(err)\n-      t.equal(res.statusCode, 200)\n-      t.equal(data.toString(), 'test')\n-    })\n-  })\n+  let res = await fastify.inject('/test')\n+  t.assert.strictEqual(res.statusCode, 200)\n+  t.assert.strictEqual(res.payload.toString(), 'test')\n+\n+  res = await fastify.inject('/test/')\n+  t.assert.strictEqual(res.statusCode, 200)\n+  t.assert.strictEqual(res.payload.toString(), 'test')\n })\n \n-test('Should honor ignoreDuplicateSlashes option', t => {\n+test('Should honor ignoreDuplicateSlashes option', async t => {\n   t.plan(4)\n   const fastify = Fastify({\n     ignoreDuplicateSlashes: true\n@@ -54,27 +38,16 @@\n     res.send('test')\n   })\n \n-  fastify.listen({ port: 0 }, (err) => {\n-    t.teardown(() => { fastify.close() })\n-    if (err) t.threw(err)\n-\n-    const baseUrl = getUrl(fastify)\n-\n-    sget.concat(baseUrl + '/test/test/test', (err, res, data) => {\n-      if (err) t.threw(err)\n-      t.equal(res.statusCode, 200)\n-      t.equal(data.toString(), 'test')\n-    })\n-\n-    sget.concat(baseUrl + '/test//test///test', (err, res, data) => {\n-      if (err) t.threw(err)\n-      t.equal(res.statusCode, 200)\n-      t.equal(data.toString(), 'test')\n-    })\n-  })\n+  let res = await fastify.inject('/test/test/test')\n+  t.assert.strictEqual(res.statusCode, 200)\n+  t.assert.strictEqual(res.payload.toString(), 'test')\n+\n+  res = await fastify.inject('/test//test///test')\n+  t.assert.strictEqual(res.statusCode, 200)\n+  t.assert.strictEqual(res.payload.toString(), 'test')\n })\n \n-test('Should honor ignoreTrailingSlash and ignoreDuplicateSlashes options', t => {\n+test('Should honor ignoreTrailingSlash and ignoreDuplicateSlashes options', async t => {\n",
					"match": false,
					"packageHash": "08c9ecd6b77324576803372f623dae9a0c5a707197b85380cfd5e60efb43ce13",
					"size": 4656,
					"sourceHash": "3a011a8ea8a1f43e9148f69b885c2cae9e4b68464f21f547125d9602950da09f",
					"status": "content"
				},
				"test/same-shape.test.js": {
					"diff": "--- published/test/same-shape.test.js\n+++ rebuilt/test/same-shape.test.js\n@@ -1,6 +1,6 @@\n 'use strict'\n \n-const { test } = require('tap')\n+const { test } = require('node:test')\n const fastify = require('..')\n \n test('same shape on Request', async (t) => {\n@@ -21,7 +21,7 @@\n \n   app.get('/', (req, reply) => {\n     if (request) {\n-      t.equal(%HaveSameMap(request, req), true)\n+      t.assert.deepStrictEqual(request, req)\n     }\n \n     request = req\n@@ -51,7 +51,7 @@\n \n   app.get('/', (req, reply) => {\n     if (request) {\n-      t.equal(%HaveSameMap(request, req), true)\n+      t.assert.deepStrictEqual(request, req)\n     }\n \n     request = req\n@@ -81,7 +81,7 @@\n \n   app.get('/', (req, reply) => {\n     if (_reply) {\n-      t.equal(%HaveSameMap(_reply, reply), true)\n+      t.assert.deepStrictEqual(_reply, reply)\n     }\n \n     _reply = reply\n@@ -111,7 +111,7 @@\n \n   app.get('/', (req, reply) => {\n     if (_reply) {\n-      t.equal(%HaveSameMap(_reply, reply), true)\n+      t.assert.deepStrictEqual(_reply, reply)\n     }\n \n     _reply = reply\n",
					"match": false,
					"packageHash": "72864ec3cee17350101763d82ea4a72603c2bdb23112328de085a4afad32b7d9",
					"size": 1930,
					"sourceHash": "c4d92935c5a2ddf47677e88a7462f006da8b5bdf21e5caf175eb399bc3fbda4f",
					"status": "content"
				},
				"test/schema-examples.test.js": {
					"diff": "--- published/test/schema-examples.test.js\n+++ rebuilt/test/schema-examples.test.js\n@@ -1,10 +1,10 @@\n 'use strict'\n \n-const { test } = require('tap')\n+const { test } = require('node:test')\n const localize = require('ajv-i18n')\n const Fastify = require('..')\n \n-test('Example - URI $id', t => {\n+test('Example - URI $id', (t, done) => {\n   t.plan(1)\n   const fastify = Fastify()\n   fastify.addSchema({\n@@ -25,10 +25,13 @@\n     }\n   })\n \n-  fastify.ready(err => t.error(err))\n+  fastify.ready(err => {\n+    t.assert.ifError(err)\n+    done()\n+  })\n })\n \n-test('Example - string $id', t => {\n+test('Example - string $id', (t, done) => {\n   t.plan(1)\n   const fastify = Fastify()\n   fastify.addSchema({\n@@ -47,10 +50,13 @@\n     }\n   })\n \n-  fastify.ready(err => t.error(err))\n+  fastify.ready(err => {\n+    t.assert.ifError(err)\n+    done()\n+  })\n })\n \n-test('Example - get schema', t => {\n+test('Example - get schema', (t, done) => {\n   t.plan(1)\n   const fastify = Fastify()\n   fastify.addSchema({\n@@ -63,7 +69,8 @@\n \n   const mySchemas = fastify.getSchemas()\n   const mySchema = fastify.getSchema('schemaId')\n-  t.same(mySchemas.schemaId, mySchema)\n+  t.assert.deepStrictEqual(mySchemas.schemaId, mySchema)\n+  done()\n })\n \n test('Example - get schema encapsulated', async t => {\n@@ -91,12 +98,12 @@\n   const r2 = await fastify.inject('/sub')\n   const r3 = await fastify.inject('/deep')\n \n-  t.same(Object.keys(r1.json()), ['one'])\n-  t.same(Object.keys(r2.json()), ['one', 'two'])\n-  t.same(Object.keys(r3.json()), ['one', 'two', 'three'])\n+  t.assert.deepStrictEqual(Object.keys(r1.json()), ['one'])\n+  t.assert.deepStrictEqual(Object.keys(r2.json()), ['one', 'two'])\n+  t.assert.deepStrictEqual(Object.keys(r3.json()), ['one', 'two', 'three'])\n })\n \n-test('Example - validation', t => {\n+test('Example - validation', (t, done) => {\n   t.plan(1)\n   const fastify = Fastify({\n     ajv: {\n@@ -137,13 +144,19 @@\n   }\n \n   const queryStringJsonSchema = {\n-    name: { type: 'string' },\n-    excitement: { type: 'integer' }\n+    type: 'object',\n+    properties: {\n+      name: { type: 'string' },\n+      excitement: { type: 'integer' }\n+    }\n   }\n \n   const paramsJsonSchema = {\n-    par1: { type: 'string' },\n-    par2: { type: 'number' }\n+    type: 'object',\n+    properties: {\n+      par1: { type: 'string' },\n+      par2: { type: 'number' }\n+    }\n   }\n \n   const headersJsonSchema = {\n@@ -162,10 +175,13 @@\n   }\n",
					"match": false,
					"packageHash": "9b532340e792b3560abd6887bdc0d97493e07c054ad54ab95a0fe0c958eb0d8b",
					"size": 13040,
					"sourceHash": "ea823eafa3036837cf9e206140843a507f28ff4a229865506e9248de7a54dff7",
					"status": "content"
				},
				"test/schema-feature.test.js": {
					"diff": "--- published/test/schema-feature.test.js\n+++ rebuilt/test/schema-feature.test.js\n@@ -1,11 +1,13 @@\n 'use strict'\n \n-const { test } = require('tap')\n+const { test } = require('node:test')\n const Fastify = require('..')\n const fp = require('fastify-plugin')\n const deepClone = require('rfdc')({ circles: true, proto: false })\n const Ajv = require('ajv')\n const { kSchemaController } = require('../lib/symbols.js')\n+const { FSTWRN001 } = require('../lib/warnings')\n+const { waitForCb } = require('./toolkit')\n \n const echoParams = (req, reply) => { reply.send(req.params) }\n const echoBody = (req, reply) => { reply.send(req.body) }\n@@ -14,22 +16,23 @@\n   test(`Should expose ${f} function`, t => {\n     t.plan(1)\n     const fastify = Fastify()\n-    t.equal(typeof fastify[f], 'function')\n+    t.assert.strictEqual(typeof fastify[f], 'function')\n   })\n })\n \n ;['setValidatorCompiler', 'setSerializerCompiler'].forEach(f => {\n-  test(`cannot call ${f} after binding`, t => {\n+  test(`cannot call ${f} after binding`, (t, testDone) => {\n     t.plan(2)\n     const fastify = Fastify()\n-    t.teardown(fastify.close.bind(fastify))\n+    t.after(() => fastify.close())\n     fastify.listen({ port: 0 }, err => {\n-      t.error(err)\n+      t.assert.ifError(err)\n       try {\n         fastify[f](() => { })\n-        t.fail()\n+        t.assert.fail()\n       } catch (e) {\n-        t.pass()\n+        t.assert.ok(true)\n+        testDone()\n       }\n     })\n   })\n@@ -40,7 +43,7 @@\n   const fastify = Fastify()\n   const schema = { $id: 'id', my: 'schema' }\n   fastify.addSchema(schema)\n-  t.same(fastify[kSchemaController].schemaBucket.store, { id: schema })\n+  t.assert.deepStrictEqual(fastify[kSchemaController].schemaBucket.store, { id: schema })\n })\n \n test('The schemas should be accessible via getSchemas', t => {\n@@ -54,10 +57,10 @@\n   }\n \n   Object.values(schemas).forEach(schema => { fastify.addSchema(schema) })\n-  t.same(fastify.getSchemas(), schemas)\n+  t.assert.deepStrictEqual(fastify.getSchemas(), schemas)\n })\n \n-test('The schema should be accessible by id via getSchema', t => {\n+test('The schema should be accessible by id via getSchema', (t, testDone) => {\n   t.plan(5)\n   const fastify = Fastify()\n \n@@ -67,41 +70,50 @@\n     { $id: 'bcd', my: 'schema', properties: { a: 'a', b: 1 } }\n   ]\n   schemas.forEach(schema => { fastify.addSchema(schema) })\n-  t.same(fastify.getSchema('abc'), schemas[1])\n-  t.same(fastify.getSchema('id'), schemas[0])\n-  t.same(fastify.getSchema('foo'), undefined)\n+  t.assert.deepStrictEqual(fastify.getSchema('abc'), schemas[1])\n+  t.assert.deepStrictEqual(fastify.getSchema('id'), schemas[0])\n+  t.assert.deepStrictEqual(fastify.getSchema('foo'), undefined)\n \n   fastify.register((instance, opts, done) => {\n     const pluginSchema = { $id: 'cde', my: 'schema' }\n     instance.addSchema(pluginSchema)\n-    t.same(instance.getSchema('cde'), pluginSchema)\n+    t.assert.deepStrictEqual(instance.getSchema('cde'), pluginSchema)\n     done()\n   })\n \n-  fastify.ready(err => t.error(err))\n+  fastify.ready(err => {\n+    t.assert.ifError(err)\n+    testDone()\n+  })\n })\n \n-test('Get validatorCompiler after setValidatorCompiler', t => {\n+test('Get validatorCompiler after setValidatorCompiler', (t, testDone) => {\n   t.plan(2)\n   const myCompiler = () => { }\n   const fastify = Fastify()\n",
					"match": false,
					"packageHash": "44e3c26ee3c4eed5b072e629f083199ef8541f79aff46e0e2d09080d050fad33",
					"size": 41672,
					"sourceHash": "a7fe0cd090c0907bb2b57c6c18e2f2a1b0b125a2d99b66be6ead93076e8aee2c",
					"status": "content"
				},
				"test/schema-serialization.test.js": {
					"diff": "--- published/test/schema-serialization.test.js\n+++ rebuilt/test/schema-serialization.test.js\n@@ -1,12 +1,12 @@\n 'use strict'\n \n-const t = require('tap')\n+const { test } = require('node:test')\n const Fastify = require('..')\n-const test = t.test\n+const { waitForCb } = require('./toolkit')\n \n const echoBody = (req, reply) => { reply.send(req.body) }\n \n-test('basic test', t => {\n+test('basic test', (t, testDone) => {\n   t.plan(3)\n \n   const fastify = Fastify()\n@@ -27,13 +27,14 @@\n   })\n \n   fastify.inject('/', (err, res) => {\n-    t.error(err)\n-    t.same(res.json(), { name: 'Foo', work: 'Bar' })\n-    t.equal(res.statusCode, 200)\n+    t.assert.ifError(err)\n+    t.assert.deepStrictEqual(res.json(), { name: 'Foo', work: 'Bar' })\n+    t.assert.strictEqual(res.statusCode, 200)\n+    testDone()\n   })\n })\n \n-test('custom serializer options', t => {\n+test('custom serializer options', (t, testDone) => {\n   t.plan(3)\n \n   const fastify = Fastify({\n@@ -54,13 +55,353 @@\n   })\n \n   fastify.inject('/', (err, res) => {\n-    t.error(err)\n-    t.equal(res.payload, '5', 'it must use the ceil rouding')\n-    t.equal(res.statusCode, 200)\n+    t.assert.ifError(err)\n+    t.assert.strictEqual(res.payload, '5', 'it must use the ceil rounding')\n+    t.assert.strictEqual(res.statusCode, 200)\n+    testDone()\n   })\n })\n \n-test('Use the same schema id in different places', t => {\n+test('Different content types', (t, testDone) => {\n+  t.plan(46)\n+\n+  const fastify = Fastify()\n+  fastify.addSchema({\n+    $id: 'test',\n+    type: 'object',\n+    properties: {\n+      name: { type: 'string' },\n+      age: { type: 'number' },\n+      verified: { type: 'boolean' }\n+    }\n+  })\n+\n+  fastify.get('/', {\n+    schema: {\n+      response: {\n+        200: {\n+          content: {\n+            'application/json': {\n+              schema: {\n+                type: 'object',\n+                properties: {\n+                  name: { type: 'string' },\n+                  image: { type: 'string' },\n+                  address: { type: 'string' }\n+                }\n+              }\n+            },\n+            'application/vnd.v1+json': {\n+              schema: {\n+                type: 'array',\n+                items: { $ref: 'test' }\n+              }\n+            }\n+          }\n+        },\n+        201: {\n+          content: {\n+            '*/*': {\n+              schema: { type: 'string' }\n+            }\n+          }\n+        },\n+        202: {\n+          content: {\n+            '*/*': {\n+              schema: { const: 'Processing exclusive content' }\n",
					"match": false,
					"packageHash": "cce2cfbffb7fb0c95df2056c708fea8a08bce3cd1b9c7c4696730350bbc22fe1",
					"size": 17292,
					"sourceHash": "c0eb61525b4d22844a12d3f36a82aa1dd1712a49ecd9aa62b4ed6f1863484ff5",
					"status": "content"
				},
				"test/schema-special-usage.test.js": {
					"diff": "--- published/test/schema-special-usage.test.js\n+++ rebuilt/test/schema-special-usage.test.js\n@@ -1,14 +1,17 @@\n 'use strict'\n \n-const { test } = require('tap')\n+const { test } = require('node:test')\n const Joi = require('joi')\n+const yup = require('yup')\n const AJV = require('ajv')\n const S = require('fluent-json-schema')\n const Fastify = require('..')\n const ajvMergePatch = require('ajv-merge-patch')\n const ajvErrors = require('ajv-errors')\n+const proxyquire = require('proxyquire')\n+const { waitForCb } = require('./toolkit')\n \n-test('Ajv plugins array parameter', t => {\n+test('Ajv plugins array parameter', (t, testDone) => {\n   t.plan(3)\n   const fastify = Fastify({\n     ajv: {\n@@ -49,13 +52,14 @@\n     url: '/',\n     payload: { foo: 99 }\n   }, (err, res) => {\n-    t.error(err)\n-    t.equal(res.statusCode, 400)\n-    t.equal(res.json().message, 'body/foo should be <= 10@@@@should be multipleOf 2')\n+    t.assert.ifError(err)\n+    t.assert.strictEqual(res.statusCode, 400)\n+    t.assert.strictEqual(res.json().message, 'body/foo should be <= 10@@@@should be multipleOf 2')\n+    testDone()\n   })\n })\n \n-test('Should handle root $merge keywords in header', t => {\n+test('Should handle root $merge keywords in header', (t, testDone) => {\n   t.plan(5)\n   const fastify = Fastify({\n     ajv: {\n@@ -85,14 +89,14 @@\n   })\n \n   fastify.ready(err => {\n-    t.error(err)\n+    t.assert.ifError(err)\n \n     fastify.inject({\n       method: 'GET',\n       url: '/'\n     }, (err, res) => {\n-      t.error(err)\n-      t.equal(res.statusCode, 400)\n+      t.assert.ifError(err)\n+      t.assert.strictEqual(res.statusCode, 400)\n     })\n \n     fastify.inject({\n@@ -100,13 +104,14 @@\n       url: '/',\n       headers: { q: 'foo' }\n     }, (err, res) => {\n-      t.error(err)\n-      t.equal(res.statusCode, 200)\n+      t.assert.ifError(err)\n+      t.assert.strictEqual(res.statusCode, 200)\n+      testDone()\n     })\n   })\n })\n \n-test('Should handle root $patch keywords in header', t => {\n+test('Should handle root $patch keywords in header', (t, testDone) => {\n   t.plan(5)\n   const fastify = Fastify({\n     ajv: {\n@@ -142,7 +147,7 @@\n   })\n \n   fastify.ready(err => {\n-    t.error(err)\n+    t.assert.ifError(err)\n \n     fastify.inject({\n       method: 'GET',\n@@ -151,8 +156,8 @@\n         q: 'foo'\n       }\n     }, (err, res) => {\n-      t.error(err)\n-      t.equal(res.statusCode, 400)\n+      t.assert.ifError(err)\n+      t.assert.strictEqual(res.statusCode, 400)\n     })\n \n     fastify.inject({\n@@ -160,13 +165,14 @@\n       url: '/',\n       headers: { q: 10 }\n",
					"match": false,
					"packageHash": "064ccefa0f3f89da74e8d30af8d1cd90949c2b07a436189c509cd9e1be8037de",
					"size": 14278,
					"sourceHash": "a98a02ae9cd6121f1eb388dcd206dbed074fb02fc774cf18d1cc42fbf261c796",
					"status": "content"
				},
				"test/schema-validation.test.js": {
					"diff": "--- published/test/schema-validation.test.js\n+++ rebuilt/test/schema-validation.test.js\n@@ -1,10 +1,11 @@\n 'use strict'\n \n-const { test } = require('tap')\n+const { test } = require('node:test')\n const Fastify = require('..')\n \n const AJV = require('ajv')\n const Schema = require('fluent-json-schema')\n+const { waitForCb } = require('./toolkit')\n \n const customSchemaCompilers = {\n   body: new AJV({\n@@ -69,7 +70,7 @@\n   required: ['name', 'work']\n }\n \n-test('Basic validation test', t => {\n+test('Basic validation test', (t, testDone) => {\n   t.plan(6)\n \n   const fastify = Fastify()\n@@ -81,6 +82,7 @@\n     reply.code(200).send(req.body.name)\n   })\n \n+  const completion = waitForCb({ steps: 2 })\n   fastify.inject({\n     method: 'POST',\n     payload: {\n@@ -89,24 +91,165 @@\n     },\n     url: '/'\n   }, (err, res) => {\n-    t.error(err)\n-    t.same(res.payload, 'michelangelo')\n-    t.equal(res.statusCode, 200)\n+    t.assert.ifError(err)\n+    t.assert.deepStrictEqual(res.payload, 'michelangelo')\n+    t.assert.strictEqual(res.statusCode, 200)\n+    completion.stepIn()\n   })\n-\n   fastify.inject({\n     method: 'POST',\n     payload: { name: 'michelangelo' },\n     url: '/'\n   }, (err, res) => {\n-    t.error(err)\n-    t.same(res.json(), { statusCode: 400, error: 'Bad Request', message: \"body must have required property 'work'\" })\n-    t.equal(res.statusCode, 400)\n+    t.assert.ifError(err)\n+    t.assert.deepStrictEqual(res.json(), { statusCode: 400, code: 'FST_ERR_VALIDATION', error: 'Bad Request', message: \"body must have required property 'work'\" })\n+    t.assert.strictEqual(res.statusCode, 400)\n+    completion.stepIn()\n   })\n+  completion.patience.then(testDone)\n })\n \n-test('External AJV instance', t => {\n-  t.plan(4)\n+test('Different schema per content type', (t, testDone) => {\n+  t.plan(12)\n+\n+  const fastify = Fastify()\n+  fastify.addContentTypeParser('application/octet-stream', {\n+    parseAs: 'buffer'\n+  }, async function (_, payload) {\n+    return payload\n+  })\n+  fastify.post('/', {\n+    schema: {\n+      body: {\n+        content: {\n+          'application/json': {\n+            schema: schemaArtist\n+          },\n+          'application/octet-stream': {\n+            schema: {} // Skip validation\n+          },\n+          'text/plain': {\n+            schema: { type: 'string' }\n+          }\n+        }\n+      }\n+    }\n+  }, async function (req, reply) {\n+    return reply.send(req.body)\n+  })\n+\n+  const completion = waitForCb({ steps: 4 })\n+  fastify.inject({\n+    url: '/',\n+    method: 'POST',\n+    headers: { 'Content-Type': 'application/json' },\n+    body: {\n+      name: 'michelangelo',\n+      work: 'sculptor, painter, architect and poet'\n",
					"match": false,
					"packageHash": "40c603c82167a86e73232c2254ede1d4fc73ab54f40b981dce2f0ced3f7a98fc",
					"size": 20381,
					"sourceHash": "7899b79be0d54c54fcb1c45a3e4c93e2e0082ff2a187fe1f8e2a2e8c13033879",
					"status": "content"
				},
				"test/search.test.js": {
					"match": false,
					"packageHash": "5f103d8a5b0066f4dcdb6cc77bdfc7474ea7557d5dd0fa6a186d7a127d085be6",
					"size": 1573,
					"status": "missing-in-source"
				},
				"test/skip-reply-send.test.js": {
					"diff": "--- published/test/skip-reply-send.test.js\n+++ rebuilt/test/skip-reply-send.test.js\n@@ -1,8 +1,8 @@\n 'use strict'\n \n-const { test } = require('tap')\n+const { test, describe } = require('node:test')\n const split = require('split2')\n-const net = require('net')\n+const net = require('node:net')\n const Fastify = require('../fastify')\n \n process.removeAllListeners('warning')\n@@ -19,7 +19,7 @@\n   'onError'\n ]\n \n-test('skip automatic reply.send() with reply.sent = true and a body', (t) => {\n+test('skip automatic reply.send() with reply.hijack and a body', async (t) => {\n   const stream = split(JSON.parse)\n   const app = Fastify({\n     logger: {\n@@ -28,27 +28,27 @@\n   })\n \n   stream.on('data', (line) => {\n-    t.not(line.level, 40) // there are no errors\n-    t.not(line.level, 50) // there are no errors\n+    t.assert.notStrictEqual(line.level, 40) // there are no errors\n+    t.assert.notStrictEqual(line.level, 50) // there are no errors\n   })\n \n   app.get('/', (req, reply) => {\n-    reply.sent = true\n+    reply.hijack()\n     reply.raw.end('hello world')\n \n     return Promise.resolve('this will be skipped')\n   })\n \n-  return app.inject({\n+  await app.inject({\n     method: 'GET',\n     url: '/'\n   }).then((res) => {\n-    t.equal(res.statusCode, 200)\n-    t.equal(res.body, 'hello world')\n+    t.assert.strictEqual(res.statusCode, 200)\n+    t.assert.strictEqual(res.body, 'hello world')\n   })\n })\n \n-test('skip automatic reply.send() with reply.sent = true and no body', (t) => {\n+test('skip automatic reply.send() with reply.hijack and no body', async (t) => {\n   const stream = split(JSON.parse)\n   const app = Fastify({\n     logger: {\n@@ -57,27 +57,27 @@\n   })\n \n   stream.on('data', (line) => {\n-    t.not(line.level, 40) // there are no error\n-    t.not(line.level, 50) // there are no error\n+    t.assert.notStrictEqual(line.level, 40) // there are no error\n+    t.assert.notStrictEqual(line.level, 50) // there are no error\n   })\n \n   app.get('/', (req, reply) => {\n-    reply.sent = true\n+    reply.hijack()\n     reply.raw.end('hello world')\n \n     return Promise.resolve()\n   })\n \n-  return app.inject({\n+  await app.inject({\n     method: 'GET',\n     url: '/'\n   }).then((res) => {\n-    t.equal(res.statusCode, 200)\n-    t.equal(res.body, 'hello world')\n+    t.assert.strictEqual(res.statusCode, 200)\n+    t.assert.strictEqual(res.body, 'hello world')\n   })\n })\n \n-test('skip automatic reply.send() with reply.sent = true and an error', (t) => {\n+test('skip automatic reply.send() with reply.hijack and an error', async (t) => {\n   const stream = split(JSON.parse)\n   const app = Fastify({\n     logger: {\n@@ -90,25 +90,25 @@\n   stream.on('data', (line) => {\n     if (line.level === 50) {\n       errorSeen = true\n-      t.equal(line.err.message, 'kaboom')\n-      t.equal(line.msg, 'Promise errored, but reply.sent = true was set')\n+      t.assert.strictEqual(line.err.message, 'kaboom')\n+      t.assert.strictEqual(line.msg, 'Promise errored, but reply.sent = true was set')\n",
					"match": false,
					"packageHash": "e691183b556d6f05a4f985557df7bc4973690016671d994c532bd804843a3b73",
					"size": 8857,
					"sourceHash": "38e1afd56498fe9091608163b4612a48a1157204a463e78a4b1078aa86702313",
					"status": "content"
				},
				"test/stream.test.js": {
					"match": false,
					"packageHash": "ca7744ea32798ad3603ffbe4da8d76ec67a05199dea8656979912f7234569a30",
					"size": 20065,
					"status": "missing-in-source"
				},
				"test/sync-routes.test.js": {
					"diff": "--- published/test/sync-routes.test.js\n+++ rebuilt/test/sync-routes.test.js\n@@ -1,32 +1,32 @@\n 'use strict'\n \n-const { test } = require('tap')\n+const { test } = require('node:test')\n const Fastify = require('..')\n \n test('sync route', async t => {\n-  const app = Fastify()\n-  t.teardown(app.close.bind(app))\n-  app.get('/', () => 'hello world')\n-  const res = await app.inject('/')\n-  t.equal(res.statusCode, 200)\n-  t.equal(res.body, 'hello world')\n+  const fastify = Fastify()\n+  t.after(() => fastify.close())\n+  fastify.get('/', () => 'hello world')\n+  const res = await fastify.inject('/')\n+  t.assert.strictEqual(res.statusCode, 200)\n+  t.assert.strictEqual(res.body, 'hello world')\n })\n \n test('sync route return null', async t => {\n-  const app = Fastify()\n-  t.teardown(app.close.bind(app))\n-  app.get('/', () => null)\n-  const res = await app.inject('/')\n-  t.equal(res.statusCode, 200)\n-  t.equal(res.body, 'null')\n+  const fastify = Fastify()\n+  t.after(() => fastify.close())\n+  fastify.get('/', () => null)\n+  const res = await fastify.inject('/')\n+  t.assert.strictEqual(res.statusCode, 200)\n+  t.assert.strictEqual(res.body, 'null')\n })\n \n test('sync route, error', async t => {\n-  const app = Fastify()\n-  t.teardown(app.close.bind(app))\n-  app.get('/', () => {\n+  const fastify = Fastify()\n+  t.after(() => fastify.close())\n+  fastify.get('/', () => {\n     throw new Error('kaboom')\n   })\n-  const res = await app.inject('/')\n-  t.equal(res.statusCode, 500)\n+  const res = await fastify.inject('/')\n+  t.assert.strictEqual(res.statusCode, 500)\n })\n",
					"match": false,
					"packageHash": "d37585671ff38f4d48ad25cbb2b98108a6d5b95766120f3c0427a7d014b2d0d3",
					"size": 762,
					"sourceHash": "fcfacbcfa90e4ed368ecb580e50ef5fbd70485d537bb21a01ce8d0b1c9a82f84",
					"status": "content"
				},
				"test/throw.test.js": {
					"diff": "--- published/test/throw.test.js\n+++ rebuilt/test/throw.test.js\n@@ -1,20 +1,20 @@\n 'use strict'\n \n-const { test } = require('tap')\n+const { test } = require('node:test')\n const Fastify = require('..')\n \n-test('Fastify should throw on wrong options', t => {\n+test('Fastify should throw on wrong options', (t) => {\n   t.plan(2)\n   try {\n     Fastify('lol')\n-    t.fail()\n+    t.assert.fail()\n   } catch (e) {\n-    t.equal(e.message, 'Options must be an object')\n-    t.pass()\n+    t.assert.strictEqual(e.message, 'Options must be an object')\n+    t.assert.ok(true)\n   }\n })\n \n-test('Fastify should throw on multiple assignment to the same route', t => {\n+test('Fastify should throw on multiple assignment to the same route', (t) => {\n   t.plan(1)\n   const fastify = Fastify()\n \n@@ -22,14 +22,14 @@\n \n   try {\n     fastify.get('/', () => {})\n-    t.fail('Should throw on duplicated route declaration')\n+    t.assert.fail('Should throw fastify duplicated route declaration')\n   } catch (error) {\n-    t.equal(error.message, \"Method 'GET' already declared for route '/'\")\n+    t.assert.strictEqual(error.code, 'FST_ERR_DUPLICATED_ROUTE')\n   }\n })\n \n-test('Fastify should throw for an invalid schema, printing the error route - headers', t => {\n-  t.plan(2)\n+test('Fastify should throw for an invalid schema, printing the error route - headers', async (t) => {\n+  t.plan(1)\n \n   const badSchema = {\n     type: 'object',\n@@ -39,20 +39,18 @@\n       }\n     }\n   }\n-\n   const fastify = Fastify()\n   fastify.get('/', { schema: { headers: badSchema } }, () => {})\n   fastify.get('/not-loaded', { schema: { headers: badSchema } }, () => {})\n \n-  fastify.ready(err => {\n-    t.equal(err.code, 'FST_ERR_SCH_VALIDATION_BUILD')\n-    t.match(err.message, /Failed building the validation schema for GET: \\//)\n+  await t.assert.rejects(fastify.ready(), {\n+    code: 'FST_ERR_SCH_VALIDATION_BUILD',\n+    message: /Failed building the validation schema for GET: \\//\n   })\n })\n \n-test('Fastify should throw for an invalid schema, printing the error route - body', t => {\n-  t.plan(2)\n-\n+test('Fastify should throw for an invalid schema, printing the error route - body', async (t) => {\n+  t.plan(1)\n   const badSchema = {\n     type: 'object',\n     properties: {\n@@ -68,25 +66,13 @@\n     done()\n   }, { prefix: 'hello' })\n \n-  fastify.ready(err => {\n-    t.equal(err.code, 'FST_ERR_SCH_VALIDATION_BUILD')\n-    t.match(err.message, /Failed building the validation schema for POST: \\/hello\\/form/)\n+  await t.assert.rejects(fastify.ready(), {\n+    code: 'FST_ERR_SCH_VALIDATION_BUILD',\n+    message: /Failed building the validation schema for POST: \\/hello\\/form/\n   })\n })\n \n-test('Fastify should throw for an invalid shorthand option type', t => {\n-  t.plan(3)\n-  try {\n-    Fastify({ jsonShorthand: 'hello' })\n-    t.fail()\n-  } catch (e) {\n-    t.equal(e.code, 'FST_ERR_INIT_OPTS_INVALID')\n-    t.match(e.message, /must be boolean/)\n-    t.pass()\n-  }\n-})\n-\n-test('Should throw on unsupported method', t => {\n",
					"match": false,
					"packageHash": "76d5f1084232ecc851a8f440ead7418adb9c4cfd7aac9afbf303541a8aaa17b2",
					"size": 7252,
					"sourceHash": "1567d924546ed98792c7436cdf867be9e19a92066a19ed2f9cd3a68b01443c9d",
					"status": "content"
				},
				"test/trace.test.js": {
					"match": false,
					"packageHash": "9ca704a151dcb8e2e20eaedd0f48c20941fe90272d2944869f2f86c9cc18af4e",
					"size": 352,
					"status": "missing-in-source"
				},
				"test/trust-proxy.test.js": {
					"diff": "--- published/test/trust-proxy.test.js\n+++ rebuilt/test/trust-proxy.test.js\n@@ -1,12 +1,10 @@\n 'use strict'\n \n-const t = require('tap')\n-const { test, before } = t\n-const sget = require('simple-get').concat\n+const { test, before } = require('node:test')\n const fastify = require('..')\n-const dns = require('dns').promises\n+const helper = require('./helper')\n \n-const sgetForwardedRequest = (app, forHeader, path, protoHeader) => {\n+const fetchForwardedRequest = async (fastifyServer, forHeader, path, protoHeader) => {\n   const headers = {\n     'X-Forwarded-For': forHeader,\n     'X-Forwarded-Host': 'example.com'\n@@ -14,165 +12,151 @@\n   if (protoHeader) {\n     headers['X-Forwarded-Proto'] = protoHeader\n   }\n-  sget({\n-    method: 'GET',\n-    headers,\n-    url: 'http://localhost:' + app.server.address().port + path\n-  }, () => {})\n+\n+  return fetch(fastifyServer + path, {\n+    headers\n+  })\n }\n \n const testRequestValues = (t, req, options) => {\n   if (options.ip) {\n-    t.ok(req.ip, 'ip is defined')\n-    t.equal(req.ip, options.ip, 'gets ip from x-forwarded-for')\n+    t.assert.ok(req.ip, 'ip is defined')\n+    t.assert.strictEqual(req.ip, options.ip, 'gets ip from x-forwarded-for')\n   }\n-  if (options.hostname) {\n-    t.ok(req.hostname, 'hostname is defined')\n-    t.equal(req.hostname, options.hostname, 'gets hostname from x-forwarded-host')\n+  if (options.host) {\n+    t.assert.ok(req.host, 'host is defined')\n+    t.assert.strictEqual(req.host, options.host, 'gets host from x-forwarded-host')\n+    t.assert.ok(req.hostname)\n+    t.assert.strictEqual(req.hostname, options.host, 'gets hostname from x-forwarded-host')\n   }\n   if (options.ips) {\n-    t.same(req.ips, options.ips, 'gets ips from x-forwarded-for')\n+    t.assert.deepStrictEqual(req.ips, options.ips, 'gets ips from x-forwarded-for')\n   }\n   if (options.protocol) {\n-    t.ok(req.protocol, 'protocol is defined')\n-    t.equal(req.protocol, options.protocol, 'gets protocol from x-forwarded-proto')\n+    t.assert.ok(req.protocol, 'protocol is defined')\n+    t.assert.strictEqual(req.protocol, options.protocol, 'gets protocol from x-forwarded-proto')\n+  }\n+  if (options.port) {\n+    t.assert.ok(req.port, 'port is defined')\n+    t.assert.strictEqual(req.port, options.port, 'port is taken from x-forwarded-for or host')\n   }\n }\n \n let localhost\n-\n before(async function () {\n-  const lookup = await dns.lookup('localhost')\n-  localhost = lookup.address\n+  [localhost] = await helper.getLoopbackHost()\n })\n \n-test('trust proxy, not add properties to node req', (t) => {\n-  t.plan(8)\n+test('trust proxy, not add properties to node req', async t => {\n+  t.plan(13)\n   const app = fastify({\n     trustProxy: true\n   })\n+  t.after(() => app.close())\n+\n   app.get('/trustproxy', function (req, reply) {\n-    testRequestValues(t, req, { ip: '1.1.1.1', hostname: 'example.com' })\n-    reply.code(200).send({ ip: req.ip, hostname: req.hostname })\n+    testRequestValues(t, req, { ip: '1.1.1.1', host: 'example.com', port: app.server.address().port })\n+    reply.code(200).send({ ip: req.ip, host: req.host })\n   })\n \n   app.get('/trustproxychain', function (req, reply) {\n-    testRequestValues(t, req, { ip: '2.2.2.2', ips: [localhost, '1.1.1.1', '2.2.2.2'] })\n-    reply.code(200).send({ ip: req.ip, hostname: req.hostname })\n+    testRequestValues(t, req, { ip: '2.2.2.2', ips: [localhost, '1.1.1.1', '2.2.2.2'], port: app.server.address().port })\n+    reply.code(200).send({ ip: req.ip, host: req.host })\n   })\n \n-  t.teardown(app.close.bind(app))\n+  const fastifyServer = await app.listen({ port: 0 })\n \n-  app.listen({ port: 0 }, (err) => {\n",
					"match": false,
					"packageHash": "d0245242034ac6bf059a39cbd2b60dd3f06988adaca927f10cf9894910608e01",
					"size": 5043,
					"sourceHash": "dd051f3ff996a17ec92f917bd8cd9956b050910811ba551112860b44ae08ab56",
					"status": "content"
				},
				"test/type-provider.test.js": {
					"diff": "--- published/test/type-provider.test.js\n+++ rebuilt/test/type-provider.test.js\n@@ -1,20 +1,22 @@\n 'use strict'\n \n-const { test } = require('tap')\n+const { test } = require('node:test')\n const Fastify = require('..')\n \n-test('Should export withTypeProvider function', t => {\n+test('Should export withTypeProvider function', (t, done) => {\n   t.plan(1)\n   try {\n     Fastify().withTypeProvider()\n-    t.pass()\n+    t.assert.ok('pass')\n+    done()\n   } catch (e) {\n-    t.fail()\n+    t.assert.fail(e)\n   }\n })\n \n-test('Should return same instance', t => {\n+test('Should return same instance', (t, done) => {\n   t.plan(1)\n   const fastify = Fastify()\n-  t.equal(fastify, fastify.withTypeProvider())\n+  t.assert.strictEqual(fastify, fastify.withTypeProvider())\n+  done()\n })\n",
					"match": false,
					"packageHash": "ac83907da4f887add3da3571b9f9c9cd1a0a212d2348a779f244d4cb9ecd915e",
					"size": 368,
					"sourceHash": "29cc9b6a294afd281d2fc91171ce250f4d33925a15fb018c84e4400c2ed911fc",
					"status": "content"
				},
				"test/types/content-type-parser.test-d.ts": {
					"diff": "--- published/test/types/content-type-parser.test-d.ts\n+++ rebuilt/test/types/content-type-parser.test-d.ts\n@@ -1,6 +1,6 @@\n import fastify, { FastifyBodyParser } from '../../fastify'\n import { expectError, expectType } from 'tsd'\n-import { IncomingMessage } from 'http'\n+import { IncomingMessage } from 'node:http'\n import { FastifyRequest } from '../../types/request'\n \n expectType<void>(fastify().addContentTypeParser('contentType', function (request, payload, done) {\n",
					"match": false,
					"packageHash": "3b74ce24c215abe50e836e32d799e604ef1f292f9c1c91b4841363fb9612180a",
					"size": 2748,
					"sourceHash": "62f578b51e5535b4ec63b0f268feb69c5736fc4da6533e96a61f4f3ee1aacf53",
					"status": "content"
				},
				"test/types/fastify.test-d.ts": {
					"diff": "--- published/test/types/fastify.test-d.ts\n+++ rebuilt/test/types/fastify.test-d.ts\n@@ -1,35 +1,77 @@\n+import { ErrorObject as AjvErrorObject } from 'ajv'\n+import * as http from 'node:http'\n+import * as http2 from 'node:http2'\n+import * as https from 'node:https'\n+import { Socket } from 'node:net'\n+import { expectAssignable, expectError, expectNotAssignable, expectType } from 'tsd'\n import fastify, {\n   ConnectionError,\n+  FastifyBaseLogger,\n+  FastifyError,\n+  FastifyErrorCodes,\n   FastifyInstance,\n   FastifyPlugin,\n   FastifyPluginAsync,\n   FastifyPluginCallback,\n+  InjectOptions,\n+  LightMyRequestCallback,\n   LightMyRequestChain,\n   LightMyRequestResponse,\n-  LightMyRequestCallback,\n-  InjectOptions, FastifyBaseLogger,\n-  ValidationResult\n+  RawRequestDefaultExpression,\n+  RouteGenericInterface,\n+  SafePromiseLike\n } from '../../fastify'\n-import { ErrorObject as AjvErrorObject } from 'ajv'\n-import * as http from 'http'\n-import * as https from 'https'\n-import * as http2 from 'http2'\n-import { expectType, expectError, expectAssignable } from 'tsd'\n-import { FastifyLoggerInstance } from '../../types/logger'\n-import { Socket } from 'net'\n+import { Bindings, ChildLoggerOptions } from '../../types/logger'\n \n // FastifyInstance\n // http server\n-expectType<FastifyInstance<http.Server, http.IncomingMessage, http.ServerResponse> & PromiseLike<FastifyInstance<http.Server, http.IncomingMessage, http.ServerResponse>>>(fastify())\n-expectType<FastifyInstance<http.Server, http.IncomingMessage, http.ServerResponse> & PromiseLike<FastifyInstance<http.Server, http.IncomingMessage, http.ServerResponse>>>(fastify({}))\n+expectError<\n+  FastifyInstance<http.Server, http.IncomingMessage, http.ServerResponse> &\n+  Promise<FastifyInstance<http.Server, http.IncomingMessage, http.ServerResponse>>\n+>(fastify())\n+expectAssignable<\n+  FastifyInstance<http.Server, http.IncomingMessage, http.ServerResponse> &\n+  PromiseLike<FastifyInstance<http.Server, http.IncomingMessage, http.ServerResponse>>\n+>(fastify())\n+expectType<\n+  FastifyInstance<http.Server, http.IncomingMessage, http.ServerResponse> &\n+  SafePromiseLike<FastifyInstance<http.Server, http.IncomingMessage, http.ServerResponse>>\n+>(fastify())\n+expectType<\n+  FastifyInstance<http.Server, http.IncomingMessage, http.ServerResponse> &\n+  SafePromiseLike<FastifyInstance<http.Server, http.IncomingMessage, http.ServerResponse>>\n+>(fastify({}))\n+expectType<\n+  FastifyInstance<http.Server, http.IncomingMessage, http.ServerResponse> &\n+  SafePromiseLike<FastifyInstance<http.Server, http.IncomingMessage, http.ServerResponse>>\n+>(fastify({ http: {} }))\n // https server\n-expectType<FastifyInstance<https.Server, http.IncomingMessage, http.ServerResponse> & PromiseLike<FastifyInstance<https.Server, http.IncomingMessage, http.ServerResponse>>>(fastify({ https: {} }))\n+expectType<\n+  FastifyInstance<https.Server, http.IncomingMessage, http.ServerResponse> &\n+  SafePromiseLike<FastifyInstance<https.Server, http.IncomingMessage, http.ServerResponse>>\n+>(fastify({ https: {} }))\n+expectType<\n+  FastifyInstance<https.Server, http.IncomingMessage, http.ServerResponse> &\n+  SafePromiseLike<FastifyInstance<https.Server, http.IncomingMessage, http.ServerResponse>>\n+>(fastify({ https: null }))\n // http2 server\n-expectType<FastifyInstance<http2.Http2Server, http2.Http2ServerRequest, http2.Http2ServerResponse> & PromiseLike<FastifyInstance<http2.Http2Server, http2.Http2ServerRequest, http2.Http2ServerResponse>>>(fastify({ http2: true, http2SessionTimeout: 1000 }))\n-expectType<FastifyInstance<http2.Http2SecureServer, http2.Http2ServerRequest, http2.Http2ServerResponse> & PromiseLike<FastifyInstance<http2.Http2SecureServer, http2.Http2ServerRequest, http2.Http2ServerResponse>>>(fastify({ http2: true, https: {}, http2SessionTimeout: 1000 }))\n+expectType<\n+  FastifyInstance<http2.Http2Server, http2.Http2ServerRequest, http2.Http2ServerResponse> &\n+  SafePromiseLike<FastifyInstance<http2.Http2Server, http2.Http2ServerRequest, http2.Http2ServerResponse>>\n+>(fastify({ http2: true, http2SessionTimeout: 1000 }))\n+expectType<\n+  FastifyInstance<http2.Http2SecureServer, http2.Http2ServerRequest, http2.Http2ServerResponse> &\n+  SafePromiseLike<FastifyInstance<http2.Http2SecureServer, http2.Http2ServerRequest, http2.Http2ServerResponse>>\n+>(fastify({ http2: true, https: {}, http2SessionTimeout: 1000 }))\n expectType<LightMyRequestChain>(fastify({ http2: true, https: {} }).inject())\n-expectType<FastifyInstance<https.Server, http.IncomingMessage, http.ServerResponse> & PromiseLike<FastifyInstance<https.Server, http.IncomingMessage, http.ServerResponse>>>(fastify({ schemaController: {} }))\n-expectType<FastifyInstance<https.Server, http.IncomingMessage, http.ServerResponse> & PromiseLike<FastifyInstance<https.Server, http.IncomingMessage, http.ServerResponse>>>(\n+expectType<\n+  FastifyInstance<http.Server, http.IncomingMessage, http.ServerResponse> &\n+  SafePromiseLike<FastifyInstance<http.Server, http.IncomingMessage, http.ServerResponse>>\n+>(fastify({ schemaController: {} }))\n+expectType<\n+  FastifyInstance<http.Server, http.IncomingMessage, http.ServerResponse> &\n+  SafePromiseLike<FastifyInstance<http.Server, http.IncomingMessage, http.ServerResponse>>\n+>(\n   fastify({\n     schemaController: {\n       compilersFactory: {}\n@@ -52,13 +94,18 @@\n fastify({ http2: true, https: {} }).inject().then((resp) => {\n   expectAssignable<LightMyRequestResponse>(resp)\n",
					"match": false,
					"packageHash": "fefefa1a26ff1f6c93d2f390068c41b3b9a3a86540f62951884c09d4fafb0eea",
					"size": 8970,
					"sourceHash": "b7fd616643a40e24a3127ce272f549639878772b81577b3f5e4a09b8abe9c036",
					"status": "content"
				},
				"test/types/hooks.test-d.ts": {
					"diff": "--- published/test/types/hooks.test-d.ts\n+++ rebuilt/test/types/hooks.test-d.ts\n@@ -1,21 +1,25 @@\n import { FastifyError } from '@fastify/error'\n import { expectAssignable, expectError, expectType } from 'tsd'\n import fastify, {\n+  ContextConfigDefault, FastifyContextConfig,\n   FastifyInstance,\n+  FastifyPluginOptions,\n   FastifyReply,\n   FastifyRequest,\n+  FastifySchema,\n+  FastifyTypeProviderDefault,\n   RawReplyDefaultExpression,\n   RawRequestDefaultExpression,\n-  RouteOptions,\n+  RawServerDefault,\n   RegisterOptions,\n-  FastifyPluginOptions,\n-  FastifySchema,\n-  FastifyTypeProviderDefault,\n-  ContextConfigDefault, FastifyContextConfig, RawServerDefault\n+  RouteOptions,\n+  // preClose hook types should be exported correctly https://github.com/fastify/fastify/pull/5335\n+  /* eslint-disable @typescript-eslint/no-unused-vars */\n+  preCloseAsyncHookHandler,\n+  preCloseHookHandler\n } from '../../fastify'\n-import { preHandlerAsyncHookHandler, RequestPayload } from '../../types/hooks'\n-import { RouteGenericInterface } from '../../types/route'\n-import { ResolveFastifyRequestType } from '../../types/type-provider'\n+import { DoneFuncWithErrOrRes, HookHandlerDoneFunction, RequestPayload, preHandlerAsyncHookHandler } from '../../types/hooks'\n+import { FastifyRouteConfig, RouteGenericInterface } from '../../types/route'\n \n const server = fastify()\n \n@@ -114,27 +118,40 @@\n   expectType<void>(done())\n })\n \n+server.addHook('onRequestAbort', function (request, done) {\n+  expectType<FastifyInstance>(this)\n+  expectType<FastifyRequest>(request)\n+  expectAssignable<(err?: FastifyError) => void>(done)\n+  expectAssignable<(err?: NodeJS.ErrnoException) => void>(done)\n+  expectType<void>(done(new Error()))\n+})\n+\n server.addHook('onRoute', function (opts) {\n   expectType<FastifyInstance>(this)\n-  expectType<RouteOptions & { routePath: string; path: string; prefix: string}>(opts)\n+  expectType<RouteOptions & { routePath: string; path: string; prefix: string }>(opts)\n })\n \n-server.addHook('onRegister', (instance, opts, done) => {\n+server.addHook('onRegister', function (instance, opts) {\n+  expectType<FastifyInstance>(this)\n   expectType<FastifyInstance>(instance)\n   expectType<RegisterOptions & FastifyPluginOptions>(opts)\n+})\n+\n+server.addHook('onReady', function (done) {\n+  expectType<FastifyInstance>(this)\n   expectAssignable<(err?: FastifyError) => void>(done)\n   expectAssignable<(err?: NodeJS.ErrnoException) => void>(done)\n   expectType<void>(done(new Error()))\n })\n \n-server.addHook('onReady', function (done) {\n+server.addHook('onListen', function (done) {\n   expectType<FastifyInstance>(this)\n   expectAssignable<(err?: FastifyError) => void>(done)\n   expectAssignable<(err?: NodeJS.ErrnoException) => void>(done)\n-  expectType<void>(done(new Error()))\n })\n \n-server.addHook('onClose', (instance, done) => {\n+server.addHook('onClose', function (instance, done) {\n+  expectType<FastifyInstance>(this)\n   expectType<FastifyInstance>(instance)\n   expectAssignable<(err?: FastifyError) => void>(done)\n   expectAssignable<(err?: NodeJS.ErrnoException) => void>(done)\n@@ -201,6 +218,11 @@\n   expectType<FastifyError>(error)\n })\n \n+server.addHook('onRequestAbort', async function (request) {\n+  expectType<FastifyInstance>(this)\n+  expectType<FastifyRequest>(request)\n+})\n+\n server.addHook('onRegister', async (instance, opts) => {\n   expectType<FastifyInstance>(instance)\n   expectType<RegisterOptions & FastifyPluginOptions>(opts)\n@@ -210,7 +232,12 @@\n   expectType<FastifyInstance>(this)\n })\n \n-server.addHook('onClose', async (instance) => {\n+server.addHook('onListen', async function () {\n",
					"match": false,
					"packageHash": "147744a5d00962f1f3bc200537c00857664cff1a17a3d39979701468af7d8274",
					"size": 9490,
					"sourceHash": "9a95494fc7b66b4436a99cf185d06627fc7b49128a5d733c9343d019b8247987",
					"status": "content"
				},
				"test/types/import.js": {
					"match": false,
					"packageHash": "75bfb092ee1ec502f1be5bd5316ff703fff4967229e9fada9d7b8aa713bf93e8",
					"size": 41,
					"status": "missing-in-source"
				},
				"test/types/import.ts": {
					"diff": "--- published/test/types/import.ts\n+++ rebuilt/test/types/import.ts\n@@ -1 +1,2 @@\n+/* eslint-disable @typescript-eslint/no-unused-vars */\n import { FastifyListenOptions, FastifyLogFn } from '../../fastify'\n",
					"match": false,
					"packageHash": "1fed8bcfff9c818179e7672e88cfb306fefd8719f214cc173eb9515fff62b3d9",
					"size": 67,
					"sourceHash": "c6be6de5e755dddc34e8b5265d65b01520ada64629379afb5d318cfef9a81aab",
					"status": "content"
				},
				"test/types/instance.test-d.ts": {
					"diff": "--- published/test/types/instance.test-d.ts\n+++ rebuilt/test/types/instance.test-d.ts\n@@ -1,17 +1,22 @@\n-import { expectAssignable, expectDeprecated, expectError, expectNotDeprecated, expectType } from 'tsd'\n+import { expectAssignable, expectError, expectNotDeprecated, expectType } from 'tsd'\n import fastify, {\n+  FastifyBaseLogger,\n   FastifyBodyParser,\n   FastifyError,\n   FastifyInstance,\n   RawReplyDefaultExpression,\n   RawRequestDefaultExpression,\n-  RawServerDefault\n+  RawServerDefault,\n+  RouteGenericInterface\n } from '../../fastify'\n import { HookHandlerDoneFunction } from '../../types/hooks'\n import { FastifyReply } from '../../types/reply'\n import { FastifyRequest } from '../../types/request'\n-import { DefaultRoute } from '../../types/route'\n import { FastifySchemaControllerOptions, FastifySchemaCompiler, FastifySerializerCompiler } from '../../types/schema'\n+import { AddressInfo } from 'node:net'\n+import { Bindings, ChildLoggerOptions } from '../../types/logger'\n+import { ConstraintStrategy } from 'find-my-way'\n+import { FindMyWayVersion } from '../../types/instance'\n \n const server = fastify()\n \n@@ -25,14 +30,19 @@\n   schemas: []\n }))\n \n+expectType<string>(server.pluginName)\n+\n expectType<Record<string, unknown>>(server.getSchemas())\n+expectType<AddressInfo[]>(server.addresses())\n expectType<unknown>(server.getSchema('SchemaId'))\n expectType<string>(server.printRoutes())\n expectType<string>(server.printPlugins())\n+expectType<string>(server.listeningOrigin)\n+expectType<string[]>(server.supportedMethods)\n \n expectAssignable<FastifyInstance>(\n   server.setErrorHandler(function (error, request, reply) {\n-    expectType<FastifyError>(error)\n+    expectType<unknown>(error)\n     expectAssignable<FastifyInstance>(this)\n   })\n )\n@@ -43,6 +53,18 @@\n   })\n )\n \n+expectAssignable<FastifyInstance>(\n+  server.setGenReqId(function (req) {\n+    expectType<RawRequestDefaultExpression>(req)\n+    return 'foo'\n+  })\n+)\n+\n+function fastifySetGenReqId (req: RawRequestDefaultExpression) {\n+  return 'foo'\n+}\n+server.setGenReqId(fastifySetGenReqId)\n+\n function fastifyErrorHandler (this: FastifyInstance, error: FastifyError) {}\n server.setErrorHandler(fastifyErrorHandler)\n \n@@ -70,12 +92,12 @@\n // typed sync error handler\n server.setErrorHandler<CustomError, ReplyPayload>((error, request, reply) => {\n   expectType<CustomError>(error)\n-  expectType<((payload?: ReplyPayload['Reply']) => FastifyReply<RawServerDefault, RawRequestDefaultExpression<RawServerDefault>, RawReplyDefaultExpression<RawServerDefault>, ReplyPayload>)>(reply.send)\n+  expectType<((payload?: ReplyPayload['Reply']) => FastifyReply<ReplyPayload, RawServerDefault, RawRequestDefaultExpression<RawServerDefault>, RawReplyDefaultExpression<RawServerDefault>>)>(reply.send)\n })\n // typed async error handler send\n server.setErrorHandler<CustomError, ReplyPayload>(async (error, request, reply) => {\n   expectType<CustomError>(error)\n-  expectType<((payload?: ReplyPayload['Reply']) => FastifyReply<RawServerDefault, RawRequestDefaultExpression<RawServerDefault>, RawReplyDefaultExpression<RawServerDefault>, ReplyPayload>)>(reply.send)\n+  expectType<((payload?: ReplyPayload['Reply']) => FastifyReply<ReplyPayload, RawServerDefault, RawRequestDefaultExpression<RawServerDefault>, RawReplyDefaultExpression<RawServerDefault>>)>(reply.send)\n })\n // typed async error handler return\n server.setErrorHandler<CustomError, ReplyPayload>(async (error, request, reply) => {\n@@ -105,30 +127,48 @@\n \n function notFoundHandler (request: FastifyRequest, reply: FastifyReply) {}\n async function notFoundAsyncHandler (request: FastifyRequest, reply: FastifyReply) {}\n-function notFoundpreHandlerHandler (request: FastifyRequest, reply: FastifyReply, done: HookHandlerDoneFunction) { done() }\n-async function notFoundpreHandlerAsyncHandler (request: FastifyRequest, reply: FastifyReply) {}\n-function notFoundpreValidationHandler (request: FastifyRequest, reply: FastifyReply, done: HookHandlerDoneFunction) { done() }\n-async function notFoundpreValidationAsyncHandler (request: FastifyRequest, reply: FastifyReply) {}\n+function notFoundpreHandlerHandler (\n+  request: FastifyRequest,\n+  reply: FastifyReply,\n+  done: HookHandlerDoneFunction\n+) { done() }\n+async function notFoundpreHandlerAsyncHandler (\n+  request: FastifyRequest,\n+  reply: FastifyReply\n+) {}\n",
					"match": false,
					"packageHash": "c8cad231844c2ff42e2e4c84ac851dc8a3324d6b5c97fc7a05950185d1cd2722",
					"size": 13279,
					"sourceHash": "3b25c915b5ee0531eb7f777d93ad1b2c1b5918908284d79e1681c3baf86b683d",
					"status": "content"
				},
				"test/types/logger.test-d.ts": {
					"diff": "--- published/test/types/logger.test-d.ts\n+++ rebuilt/test/types/logger.test-d.ts\n@@ -1,4 +1,4 @@\n-import { expectDeprecated, expectError, expectType } from 'tsd'\n+import { expectAssignable, expectDeprecated, expectError, expectNotAssignable, expectType } from 'tsd'\n import fastify, {\n   FastifyLogFn,\n   LogLevel,\n@@ -7,21 +7,34 @@\n   FastifyReply,\n   FastifyBaseLogger\n } from '../../fastify'\n-import { Server, IncomingMessage, ServerResponse } from 'http'\n-import * as fs from 'fs'\n+import { Server, IncomingMessage, ServerResponse } from 'node:http'\n+import * as fs from 'node:fs'\n import P from 'pino'\n+import { ResSerializerReply } from '../../types/logger'\n \n expectType<FastifyLoggerInstance>(fastify().log)\n \n class Foo {}\n \n ['trace', 'debug', 'info', 'warn', 'error', 'fatal'].forEach(logLevel => {\n-  expectType<FastifyLogFn>(fastify<Server, IncomingMessage, ServerResponse, FastifyLoggerInstance>().log[logLevel as LogLevel])\n-  expectType<void>(fastify<Server, IncomingMessage, ServerResponse, FastifyLoggerInstance>().log[logLevel as LogLevel](''))\n-  expectType<void>(fastify<Server, IncomingMessage, ServerResponse, FastifyLoggerInstance>().log[logLevel as LogLevel]({}))\n-  expectType<void>(fastify<Server, IncomingMessage, ServerResponse, FastifyLoggerInstance>().log[logLevel as LogLevel]({ foo: 'bar' }))\n-  expectType<void>(fastify<Server, IncomingMessage, ServerResponse, FastifyLoggerInstance>().log[logLevel as LogLevel](new Error()))\n-  expectType<void>(fastify<Server, IncomingMessage, ServerResponse, FastifyLoggerInstance>().log[logLevel as LogLevel](new Foo()))\n+  expectType<FastifyLogFn>(\n+    fastify<Server, IncomingMessage, ServerResponse, FastifyLoggerInstance>().log[logLevel as LogLevel]\n+  )\n+  expectType<void>(\n+    fastify<Server, IncomingMessage, ServerResponse, FastifyLoggerInstance>().log[logLevel as LogLevel]('')\n+  )\n+  expectType<void>(\n+    fastify<Server, IncomingMessage, ServerResponse, FastifyLoggerInstance>().log[logLevel as LogLevel]({})\n+  )\n+  expectType<void>(\n+    fastify<Server, IncomingMessage, ServerResponse, FastifyLoggerInstance>().log[logLevel as LogLevel]({ foo: 'bar' })\n+  )\n+  expectType<void>(\n+    fastify<Server, IncomingMessage, ServerResponse, FastifyLoggerInstance>().log[logLevel as LogLevel](new Error())\n+  )\n+  expectType<void>(\n+    fastify<Server, IncomingMessage, ServerResponse, FastifyLoggerInstance>().log[logLevel as LogLevel](new Foo())\n+  )\n })\n \n interface CustomLogger extends FastifyBaseLogger {\n@@ -72,6 +85,20 @@\n \n expectType<P.Logger>(serverWithPino.log)\n \n+serverWithPino.route({\n+  method: 'GET',\n+  url: '/',\n+  handler (request) {\n+    expectType<P.Logger>(this.log)\n+    expectType<P.Logger>(request.log)\n+  }\n+})\n+\n+serverWithPino.get('/', function (request) {\n+  expectType<P.Logger>(this.log)\n+  expectType<P.Logger>(request.log)\n+})\n+\n const serverWithLogOptions = fastify<\n Server,\n IncomingMessage,\n@@ -105,52 +132,78 @@\n \n expectType<FastifyBaseLogger>(serverAutoInferringTypes.log)\n \n-const serverWithAutoInferredPino = fastify({\n-  logger: P({\n+const serverWithLoggerInstance = fastify({\n+  loggerInstance: P({\n     level: 'info',\n     redact: ['x-userinfo']\n   })\n })\n \n-expectType<P.Logger>(serverWithAutoInferredPino.log)\n+expectType<P.Logger>(serverWithLoggerInstance.log)\n \n-const serverAutoInferredFileOption = fastify({\n+const serverWithPinoConfig = fastify({\n   logger: {\n     level: 'info',\n-    file: '/path/to/file'\n+    serializers: {\n+      req (IncomingMessage) {\n+        expectType<FastifyRequest>(IncomingMessage)\n+        return {\n+          method: 'method',\n+          url: 'url',\n+          version: 'version',\n",
					"match": false,
					"packageHash": "b50c7e228a649e463690fd8a05b36bf59764c0f482c3b3e16eca0c14579dc4cf",
					"size": 5958,
					"sourceHash": "67bcfeb357a66f1c36c23eef48cd07d06857784b1d8b324156d2aa8088ad6e19",
					"status": "content"
				},
				"test/types/plugin.test-d.ts": {
					"diff": "--- published/test/types/plugin.test-d.ts\n+++ rebuilt/test/types/plugin.test-d.ts\n@@ -1,6 +1,6 @@\n-import fastify, { FastifyInstance, FastifyPluginOptions } from '../../fastify'\n-import * as http from 'http'\n-import * as https from 'https'\n+import fastify, { FastifyInstance, FastifyPluginOptions, SafePromiseLike } from '../../fastify'\n+import * as http from 'node:http'\n+import * as https from 'node:https'\n import { expectType, expectError, expectAssignable } from 'tsd'\n import { FastifyPluginCallback, FastifyPluginAsync } from '../../types/plugin'\n import { FastifyError } from '@fastify/error'\n@@ -10,11 +10,26 @@\n   option1: string;\n   option2: boolean;\n }\n-const testPluginOpts: FastifyPluginCallback<TestOptions> = function (instance, opts, done) { }\n-const testPluginOptsAsync: FastifyPluginAsync<TestOptions> = async function (instance, opts) { }\n+const testOptions: TestOptions = {\n+  option1: 'a',\n+  option2: false\n+}\n+const testPluginOpts: FastifyPluginCallback<TestOptions> = function (instance, opts, done) {\n+  expectType<TestOptions>(opts)\n+}\n+const testPluginOptsAsync: FastifyPluginAsync<TestOptions> = async function (instance, opts) {\n+  expectType<TestOptions>(opts)\n+}\n \n-const testPluginOptsWithType = (instance: FastifyInstance, opts: FastifyPluginOptions, done: (error?: FastifyError) => void) => { }\n-const testPluginOptsWithTypeAsync = async (instance: FastifyInstance, opts: FastifyPluginOptions) => { }\n+const testPluginOptsWithType = (\n+  instance: FastifyInstance,\n+  opts: FastifyPluginOptions,\n+  done: (error?: FastifyError) => void\n+) => { }\n+const testPluginOptsWithTypeAsync = async (\n+  instance: FastifyInstance,\n+  opts: FastifyPluginOptions\n+) => { }\n \n expectError(fastify().register(testPluginOpts, {})) // error because missing required options from generic declaration\n expectError(fastify().register(testPluginOptsAsync, {})) // error because missing required options from generic declaration\n@@ -35,18 +50,31 @@\n const testPluginAsync: FastifyPluginAsync = async function (instance, opts) { }\n expectAssignable<FastifyInstance>(fastify().register(testPluginAsync, {}))\n \n-expectAssignable<FastifyInstance>(fastify().register(function (instance, opts): Promise<void> { return Promise.resolve() }))\n+expectAssignable<FastifyInstance>(\n+  fastify().register(function (instance, opts): Promise<void> { return Promise.resolve() })\n+)\n expectAssignable<FastifyInstance>(fastify().register(async function (instance, opts) { }, () => { }))\n expectAssignable<FastifyInstance>(fastify().register(async function (instance, opts) { }, { logLevel: 'info', prefix: 'foobar' }))\n \n-expectError(fastify().register(function (instance, opts, done) { }, { logLevel: '' })) // must use a valid logLevel\n+expectError(fastify().register(function (instance, opts, done) { }, { ...testOptions, logLevel: '' })) // must use a valid logLevel\n \n const httpsServer = fastify({ https: {} })\n-expectType<FastifyInstance<https.Server, http.IncomingMessage, http.ServerResponse> & PromiseLike<FastifyInstance<https.Server, http.IncomingMessage, http.ServerResponse>>>(httpsServer)\n+expectError<\n+  FastifyInstance<https.Server, http.IncomingMessage, http.ServerResponse> &\n+  Promise<FastifyInstance<https.Server, http.IncomingMessage, http.ServerResponse>>\n+>(httpsServer)\n+expectAssignable<\n+  FastifyInstance<https.Server, http.IncomingMessage, http.ServerResponse> &\n+  PromiseLike<FastifyInstance<https.Server, http.IncomingMessage, http.ServerResponse>>\n+>(httpsServer)\n+expectType<\n+  FastifyInstance<https.Server, http.IncomingMessage, http.ServerResponse> &\n+  SafePromiseLike<FastifyInstance<https.Server, http.IncomingMessage, http.ServerResponse>>\n+>(httpsServer)\n \n // Chainable\n httpsServer\n-  .register(testPluginOpts)\n+  .register(testPluginOpts, testOptions)\n   .after((_error) => { })\n   .ready((_error) => { })\n   .close(() => { })\n@@ -55,14 +83,15 @@\n expectAssignable<PromiseLike<undefined>>(httpsServer.after())\n expectAssignable<PromiseLike<undefined>>(httpsServer.close())\n expectAssignable<PromiseLike<undefined>>(httpsServer.ready())\n-expectAssignable<PromiseLike<undefined>>(httpsServer.register(testPluginOpts))\n+expectAssignable<PromiseLike<undefined>>(httpsServer.register(testPluginOpts, testOptions))\n expectAssignable<PromiseLike<undefined>>(httpsServer.register(testPluginOptsWithType))\n expectAssignable<PromiseLike<undefined>>(httpsServer.register(testPluginOptsWithTypeAsync))\n expectAssignable<PromiseLike<undefined>>(httpsServer.register(testPluginOptsWithType, { prefix: '/test' }))\n expectAssignable<PromiseLike<undefined>>(httpsServer.register(testPluginOptsWithTypeAsync, { prefix: '/test' }))\n \n+/* eslint-disable @typescript-eslint/no-unused-vars */\n async function testAsync (): Promise<void> {\n   await httpsServer\n-    .register(testPluginOpts)\n-    .register(testPluginOpts)\n+    .register(testPluginOpts, testOptions)\n+    .register(testPluginOpts, testOptions)\n }\n",
					"match": false,
					"packageHash": "3b9a5fa3f6e0cf40c67e8bbfce214c7d09dc62f1434243a50334e07b03d6bfbf",
					"size": 3799,
					"sourceHash": "6c00b2c0d00ab8a1ed13fd42083e770db1e704826cdf5d6fee2d92ffe1c55669",
					"status": "content"
				},
				"test/types/register.test-d.ts": {
					"diff": "--- published/test/types/register.test-d.ts\n+++ rebuilt/test/types/register.test-d.ts\n@@ -1,6 +1,6 @@\n import { expectAssignable, expectError, expectType } from 'tsd'\n-import { IncomingMessage, Server, ServerResponse } from 'http'\n-import { Http2Server, Http2ServerRequest, Http2ServerResponse } from 'http2'\n+import { IncomingMessage, Server, ServerResponse } from 'node:http'\n+import { Http2Server, Http2ServerRequest, Http2ServerResponse } from 'node:http2'\n import fastify, { FastifyInstance, FastifyError, FastifyLoggerInstance, FastifyPluginAsync, FastifyPluginCallback, FastifyPluginOptions, RawServerDefault } from '../../fastify'\n \n const testPluginCallback: FastifyPluginCallback = function (instance, opts, done) { }\n@@ -9,7 +9,11 @@\n const testPluginOpts: FastifyPluginCallback = function (instance, opts, done) { }\n const testPluginOptsAsync: FastifyPluginAsync = async function (instance, opts) { }\n \n-const testPluginOptsWithType = (instance: FastifyInstance, opts: FastifyPluginOptions, done: (error?: FastifyError) => void) => { }\n+const testPluginOptsWithType = (\n+  instance: FastifyInstance,\n+  opts: FastifyPluginOptions,\n+  done: (error?: FastifyError) => void\n+) => { }\n const testPluginOptsWithTypeAsync = async (instance: FastifyInstance, opts: FastifyPluginOptions) => { }\n \n interface TestOptions extends FastifyPluginOptions {\n@@ -46,16 +50,31 @@\n type ServerWithHttp2 = FastifyInstance<Http2Server, Http2ServerRequest, Http2ServerResponse>\n const testPluginWithHttp2: FastifyPluginCallback<TestOptions, Http2Server> = function (instance, opts, done) { }\n const testPluginWithHttp2Async: FastifyPluginAsync<TestOptions, Http2Server> = async function (instance, opts) { }\n-const testPluginWithHttp2WithType = (instance: ServerWithHttp2, opts: FastifyPluginOptions, done: (error?: FastifyError) => void) => { }\n-const testPluginWithHttp2WithTypeAsync = async (instance: ServerWithHttp2, opts: FastifyPluginOptions) => { }\n+const testPluginWithHttp2WithType = (\n+  instance: ServerWithHttp2,\n+  opts: FastifyPluginOptions,\n+  done: (error?: FastifyError) => void\n+) => { }\n+const testPluginWithHttp2WithTypeAsync = async (\n+  instance: ServerWithHttp2,\n+  opts: FastifyPluginOptions\n+) => { }\n+const testOptions: TestOptions = {\n+  option1: 'a',\n+  option2: false\n+}\n expectAssignable<ServerWithHttp2>(serverWithHttp2.register(testPluginCallback))\n expectAssignable<ServerWithHttp2>(serverWithHttp2.register(testPluginAsync))\n expectAssignable<ServerWithHttp2>(serverWithHttp2.register(testPluginOpts))\n expectAssignable<ServerWithHttp2>(serverWithHttp2.register(testPluginOptsAsync))\n expectAssignable<ServerWithHttp2>(serverWithHttp2.register(testPluginOptsWithType))\n expectAssignable<ServerWithHttp2>(serverWithHttp2.register(testPluginOptsWithTypeAsync))\n-expectAssignable<ServerWithHttp2>(serverWithHttp2.register(testPluginWithHttp2))\n-expectAssignable<ServerWithHttp2>(serverWithHttp2.register(testPluginWithHttp2Async))\n+// @ts-expect-error\n+serverWithHttp2.register(testPluginWithHttp2)\n+expectAssignable<ServerWithHttp2>(serverWithHttp2.register(testPluginWithHttp2, testOptions))\n+// @ts-expect-error\n+serverWithHttp2.register(testPluginWithHttp2Async)\n+expectAssignable<ServerWithHttp2>(serverWithHttp2.register(testPluginWithHttp2Async, testOptions))\n expectAssignable<ServerWithHttp2>(serverWithHttp2.register(testPluginWithHttp2WithType))\n expectAssignable<ServerWithHttp2>(serverWithHttp2.register(testPluginWithHttp2WithTypeAsync))\n expectAssignable<ServerWithHttp2>(serverWithHttp2.register((instance) => {\n@@ -72,21 +91,46 @@\n }))\n \n // With Type Provider\n-type TestTypeProvider = { input: 'test', output: 'test' }\n+type TestTypeProvider = { schema: 'test', validator: 'test', serializer: 'test' }\n const serverWithTypeProvider = fastify().withTypeProvider<TestTypeProvider>()\n-type ServerWithTypeProvider = FastifyInstance<Server, IncomingMessage, ServerResponse, FastifyLoggerInstance, TestTypeProvider>\n-const testPluginWithTypeProvider: FastifyPluginCallback<TestOptions, RawServerDefault, TestTypeProvider> = function (instance, opts, done) { }\n-const testPluginWithTypeProviderAsync: FastifyPluginAsync<TestOptions, RawServerDefault, TestTypeProvider> = async function (instance, opts) { }\n-const testPluginWithTypeProviderWithType = (instance: ServerWithTypeProvider, opts: FastifyPluginOptions, done: (error?: FastifyError) => void) => { }\n-const testPluginWithTypeProviderWithTypeAsync = async (instance: ServerWithTypeProvider, opts: FastifyPluginOptions) => { }\n+type ServerWithTypeProvider = FastifyInstance<\n+  Server,\n+  IncomingMessage,\n+  ServerResponse,\n+  FastifyLoggerInstance,\n+  TestTypeProvider\n+>\n+const testPluginWithTypeProvider: FastifyPluginCallback<\n+  TestOptions,\n+  RawServerDefault,\n+  TestTypeProvider\n+> = function (instance, opts, done) { }\n+const testPluginWithTypeProviderAsync: FastifyPluginAsync<\n+  TestOptions,\n+  RawServerDefault,\n+  TestTypeProvider\n+> = async function (instance, opts) { }\n+const testPluginWithTypeProviderWithType = (\n+  instance: ServerWithTypeProvider,\n+  opts: FastifyPluginOptions,\n+  done: (error?: FastifyError) => void\n+) => { }\n+const testPluginWithTypeProviderWithTypeAsync = async (\n+  instance: ServerWithTypeProvider,\n+  opts: FastifyPluginOptions\n+) => { }\n expectAssignable<ServerWithTypeProvider>(serverWithTypeProvider.register(testPluginCallback))\n expectAssignable<ServerWithTypeProvider>(serverWithTypeProvider.register(testPluginAsync))\n",
					"match": false,
					"packageHash": "660c2523724cc69bfa7eb07943b338e20db1f96f2b36778bc7961d670ebba91b",
					"size": 6269,
					"sourceHash": "9dbedd902d0bd4c03e90c0ec99e7d9abf7c14459ffca7b87c145e98a5360407a",
					"status": "content"
				},
				"test/types/reply.test-d.ts": {
					"diff": "--- published/test/types/reply.test-d.ts\n+++ rebuilt/test/types/reply.test-d.ts\n@@ -1,44 +1,68 @@\n-import { expectType, expectError, expectAssignable } from 'tsd'\n-import fastify, { RouteHandlerMethod, RouteHandler, RawRequestDefaultExpression, FastifyContext, FastifyContextConfig, FastifyRequest, FastifyReply } from '../../fastify'\n-import { RawServerDefault, RawReplyDefaultExpression, ContextConfigDefault } from '../../types/utils'\n-import { FastifyLoggerInstance } from '../../types/logger'\n-import { RouteGenericInterface } from '../../types/route'\n+import { Buffer } from 'node:buffer'\n+import { expectAssignable, expectError, expectType } from 'tsd'\n+import fastify, { FastifyContextConfig, FastifyReply, FastifyRequest, FastifySchema, FastifyTypeProviderDefault, RawRequestDefaultExpression, RouteHandler, RouteHandlerMethod } from '../../fastify'\n import { FastifyInstance } from '../../types/instance'\n-import { Buffer } from 'buffer'\n+import { FastifyLoggerInstance } from '../../types/logger'\n+import { ResolveReplyTypeWithRouteGeneric } from '../../types/reply'\n+import { FastifyRouteConfig, RouteGenericInterface } from '../../types/route'\n+import { ContextConfigDefault, RawReplyDefaultExpression, RawServerDefault } from '../../types/utils'\n \n-type DefaultSerializationFunction = (payload: {[key: string]: unknown}) => string\n+type DefaultSerializationFunction = (payload: { [key: string]: unknown }) => string\n+type DefaultFastifyReplyWithCode<Code extends number> = FastifyReply<RouteGenericInterface, RawServerDefault, RawRequestDefaultExpression, RawReplyDefaultExpression, ContextConfigDefault, FastifySchema, FastifyTypeProviderDefault, ResolveReplyTypeWithRouteGeneric<RouteGenericInterface['Reply'], Code, FastifySchema, FastifyTypeProviderDefault>>\n \n const getHandler: RouteHandlerMethod = function (_request, reply) {\n   expectType<RawReplyDefaultExpression>(reply.raw)\n-  expectType<FastifyContext<ContextConfigDefault>>(reply.context)\n-  expectType<FastifyContextConfig>(reply.context.config)\n   expectType<FastifyLoggerInstance>(reply.log)\n   expectType<FastifyRequest<RouteGenericInterface, RawServerDefault, RawRequestDefaultExpression>>(reply.request)\n-  expectType<(statusCode: number) => FastifyReply>(reply.code)\n-  expectType<(statusCode: number) => FastifyReply>(reply.status)\n+  expectType<<Code extends number>(statusCode: Code) => DefaultFastifyReplyWithCode<Code>>(reply.code)\n+  expectType<<Code extends number>(statusCode: Code) => DefaultFastifyReplyWithCode<Code>>(reply.status)\n+  expectType<(payload?: unknown) => FastifyReply>(reply.code(100 as number).send)\n+  expectType<number>(reply.elapsedTime)\n   expectType<number>(reply.statusCode)\n   expectType<boolean>(reply.sent)\n+  expectType<\n+          (hints: Record<string, string | string[]>, callback?: (() => void) | undefined) => void\n+            >(reply.writeEarlyHints)\n   expectType<((payload?: unknown) => FastifyReply)>(reply.send)\n-  expectType<(key: string, value: any) => FastifyReply>(reply.header)\n-  expectType<(values: {[key: string]: any}) => FastifyReply>(reply.headers)\n-  expectType<(key: string) => number | string | string[] | undefined>(reply.getHeader)\n-  expectType<() => { [key: string]: number | string | string[] | undefined }>(reply.getHeaders)\n-  expectType<(key: string) => void>(reply.removeHeader)\n-  expectType<(key: string) => boolean>(reply.hasHeader)\n-  expectType<{(statusCode: number, url: string): FastifyReply; (url: string): FastifyReply }>(reply.redirect)\n+  expectAssignable<(key: string, value: any) => FastifyReply>(reply.header)\n+  expectAssignable<(values: { [key: string]: any }) => FastifyReply>(reply.headers)\n+  expectAssignable<(key: string) => number | string | string[] | undefined>(reply.getHeader)\n+  expectAssignable<() => { [key: string]: number | string | string[] | undefined }>(reply.getHeaders)\n+  expectAssignable<(key: string) => FastifyReply>(reply.removeHeader)\n+  expectAssignable<(key: string) => boolean>(reply.hasHeader)\n+  expectType<(url: string, statusCode?: number) => FastifyReply>(reply.redirect)\n   expectType<() => FastifyReply>(reply.hijack)\n   expectType<() => void>(reply.callNotFound)\n-  expectType<() => number>(reply.getResponseTime)\n   expectType<(contentType: string) => FastifyReply>(reply.type)\n   expectType<(fn: (payload: any) => string) => FastifyReply>(reply.serializer)\n   expectType<(payload: any) => string | ArrayBuffer | Buffer>(reply.serialize)\n   expectType<(fulfilled: () => void, rejected: (err: Error) => void) => void>(reply.then)\n+  expectType<\n+      (\n+      key: string,\n+      fn: ((reply: FastifyReply, payload: string | Buffer | null) => Promise<string>) |\n+        ((reply: FastifyReply, payload: string | Buffer | null,\n+          done: (err: Error | null, value?: string) => void) => void)\n+      ) => FastifyReply\n+        >(reply.trailer)\n+  expectType<(key: string) => boolean>(reply.hasTrailer)\n+  expectType<(key: string) => FastifyReply>(reply.removeTrailer)\n   expectType<FastifyInstance>(reply.server)\n-  expectAssignable<((httpStatus: string) => DefaultSerializationFunction)>(reply.getSerializationFunction)\n-  expectAssignable<((schema: {[key: string]: unknown}) => DefaultSerializationFunction)>(reply.getSerializationFunction)\n-  expectAssignable<((schema: {[key: string]: unknown}, httpStatus?: string) => DefaultSerializationFunction)>(reply.compileSerializationSchema)\n-  expectAssignable<((input: {[key: string]: unknown}, schema: {[key: string]: unknown}, httpStatus?: string) => unknown)>(reply.serializeInput)\n-  expectAssignable<((input: {[key: string]: unknown}, httpStatus: string) => unknown)>(reply.serializeInput)\n+  expectAssignable<\n+          ((httpStatus: string) => DefaultSerializationFunction | undefined)\n+            >(reply.getSerializationFunction)\n+  expectAssignable<\n+          ((schema: { [key: string]: unknown }) => DefaultSerializationFunction | undefined)\n+            >(reply.getSerializationFunction)\n+  expectAssignable<\n+          ((schema: { [key: string]: unknown }, httpStatus?: string) => DefaultSerializationFunction)\n+            >(reply.compileSerializationSchema)\n+  expectAssignable<\n+          ((input: { [key: string]: unknown }, schema: { [key: string]: unknown }, httpStatus?: string) => unknown)\n+            >(reply.serializeInput)\n+  expectAssignable<((input: { [key: string]: unknown }, httpStatus: string) => unknown)>(reply.serializeInput)\n+  expectType<ContextConfigDefault & FastifyRouteConfig & FastifyContextConfig>(reply.routeOptions.config)\n+  expectType<string>(reply.getDecorator<string>('foo'))\n }\n \n interface ReplyPayload {\n@@ -47,6 +71,10 @@\n   };\n }\n \n+interface ReplyArrayPayload {\n",
					"match": false,
					"packageHash": "f31267ebdcf4858d4c8dd15766e3ec4bb7e45ca67f9c8846e99613d78ffebf20",
					"size": 4997,
					"sourceHash": "0338e297f2cf5db28eab9d5690737d1e74e7771f594b41db57653d56994192ac",
					"status": "content"
				},
				"test/types/request.test-d.ts": {
					"diff": "--- published/test/types/request.test-d.ts\n+++ rebuilt/test/types/request.test-d.ts\n@@ -1,26 +1,25 @@\n-import { expectAssignable, expectType } from 'tsd'\n-import pino from 'pino'\n+import { expectAssignable, expectError, expectType } from 'tsd'\n import fastify, {\n-  RouteHandler,\n-  RawRequestDefaultExpression,\n-  RequestBodyDefault,\n-  RequestGenericInterface,\n-  FastifyContext,\n   ContextConfigDefault,\n   FastifyContextConfig,\n   FastifyLogFn,\n-  RouteHandlerMethod,\n-  RawServerDefault,\n-  RawReplyDefaultExpression,\n   FastifySchema,\n-  FastifyTypeProviderDefault\n+  FastifyTypeProviderDefault,\n+  RawReplyDefaultExpression,\n+  RawRequestDefaultExpression,\n+  RawServerDefault,\n+  RequestBodyDefault,\n+  RequestGenericInterface,\n+  RouteHandler,\n+  RouteHandlerMethod,\n+  SafePromiseLike\n } from '../../fastify'\n-import { RequestParamsDefault, RequestHeadersDefault, RequestQuerystringDefault } from '../../types/utils'\n+import { FastifyInstance } from '../../types/instance'\n import { FastifyLoggerInstance } from '../../types/logger'\n-import { FastifyRequest } from '../../types/request'\n import { FastifyReply } from '../../types/reply'\n-import { FastifyInstance } from '../../types/instance'\n-import { RouteGenericInterface } from '../../types/route'\n+import { FastifyRequest, RequestRouteOptions } from '../../types/request'\n+import { FastifyRouteConfig, RouteGenericInterface } from '../../types/route'\n+import { RequestHeadersDefault, RequestParamsDefault, RequestQuerystringDefault } from '../../types/utils'\n \n interface RequestBody {\n   content: string;\n@@ -55,7 +54,7 @@\n }>\n \n type HTTPRequestPart = 'body' | 'query' | 'querystring' | 'params' | 'headers'\n-type ExpectedGetValidationFunction = (input: {[key: string]: unknown}) => boolean\n+type ExpectedGetValidationFunction = (input: { [key: string]: unknown }) => boolean\n \n interface CustomLoggerInterface extends FastifyLoggerInstance {\n   foo: FastifyLogFn; // custom severity logger method\n@@ -63,50 +62,71 @@\n \n const getHandler: RouteHandler = function (request, _reply) {\n   expectType<string>(request.url)\n+  expectType<string>(request.originalUrl)\n   expectType<string>(request.method)\n-  expectType<string>(request.routerPath)\n-  expectType<string>(request.routerMethod)\n+  expectType<Readonly<RequestRouteOptions>>(request.routeOptions)\n   expectType<boolean>(request.is404)\n   expectType<string>(request.hostname)\n+  expectType<string>(request.host)\n+  expectType<number>(request.port)\n   expectType<string>(request.ip)\n   expectType<string[] | undefined>(request.ips)\n   expectType<RawRequestDefaultExpression>(request.raw)\n   expectType<RequestBodyDefault>(request.body)\n   expectType<RequestParamsDefault>(request.params)\n-  expectType<FastifyContext<ContextConfigDefault>>(request.context)\n-  expectType<FastifyContextConfig>(request.context.config)\n+  expectType<ContextConfigDefault & FastifyRouteConfig & FastifyContextConfig>(request.routeOptions.config)\n+  expectType<FastifySchema | undefined>(request.routeOptions.schema)\n+  expectType<RouteHandlerMethod>(request.routeOptions.handler)\n+  expectType<string | undefined>(request.routeOptions.url)\n+  expectType<string | undefined>(request.routeOptions.version)\n \n   expectType<RequestHeadersDefault & RawRequestDefaultExpression['headers']>(request.headers)\n   request.headers = {}\n \n   expectType<RequestQuerystringDefault>(request.query)\n-  expectType<any>(request.id)\n+  expectType<string>(request.id)\n   expectType<FastifyLoggerInstance>(request.log)\n   expectType<RawRequestDefaultExpression['socket']>(request.socket)\n   expectType<Error & { validation: any; validationContext: string } | undefined>(request.validationError)\n   expectType<FastifyInstance>(request.server)\n   expectAssignable<(httpPart: HTTPRequestPart) => ExpectedGetValidationFunction>(request.getValidationFunction)\n-  expectAssignable<(schema: {[key: string]: unknown}) => ExpectedGetValidationFunction>(request.getValidationFunction)\n-  expectAssignable<(input: {[key: string]: unknown}, schema: {[key: string]: unknown}, httpPart?: HTTPRequestPart) => boolean>(request.validateInput)\n-  expectAssignable<(input: {[key: string]: unknown}, httpPart?: HTTPRequestPart) => boolean>(request.validateInput)\n+  expectAssignable<(schema: { [key: string]: unknown }) => ExpectedGetValidationFunction>(request.getValidationFunction)\n+  expectAssignable<\n+          (input: { [key: string]: unknown }, schema: { [key: string]: unknown }, httpPart?: HTTPRequestPart) => boolean\n+            >(request.validateInput)\n+  expectAssignable<(input: { [key: string]: unknown }, httpPart?: HTTPRequestPart) => boolean>(request.validateInput)\n+  expectType<string>(request.getDecorator<string>('foo'))\n+  expectType<void>(request.setDecorator('foo', 'hello'))\n+  expectType<void>(request.setDecorator<string>('foo', 'hello'))\n",
					"match": false,
					"packageHash": "1ea2f53093ff4fbaa1d30ad65b33789f70c0f4090d2a3768a9f3f2d7fd82c254",
					"size": 5792,
					"sourceHash": "4c2192feea20b67dcf6db7bf5f21ae68cf813a49885c40a15717140f6faa8d8d",
					"status": "content"
				},
				"test/types/route.test-d.ts": {
					"diff": "--- published/test/types/route.test-d.ts\n+++ rebuilt/test/types/route.test-d.ts\n@@ -1,9 +1,10 @@\n-import fastify, { FastifyInstance, FastifyRequest, FastifyReply, RouteHandlerMethod } from '../../fastify'\n-import { expectType, expectError, expectAssignable, printType } from 'tsd'\n-import { HTTPMethods } from '../../types/utils'\n-import * as http from 'http'\n-import { RequestPayload } from '../../types/hooks'\n import { FastifyError } from '@fastify/error'\n+import * as http from 'node:http'\n+import { expectAssignable, expectError, expectType } from 'tsd'\n+import fastify, { FastifyInstance, FastifyReply, FastifyRequest, RouteHandlerMethod } from '../../fastify'\n+import { RequestPayload } from '../../types/hooks'\n+import { FindMyWayFindResult } from '../../types/instance'\n+import { HTTPMethods, RawServerDefault } from '../../types/utils'\n \n /*\n  * Testing Fastify HTTP Routes and Route Shorthands.\n@@ -18,6 +19,23 @@\n   interface FastifyContextConfig {\n     foo: string;\n     bar: number;\n+    includeMessage?: boolean;\n+  }\n+\n+  /* eslint-disable @typescript-eslint/no-unused-vars */\n+  interface FastifyRequest<\n+    RouteGeneric,\n+    RawServer,\n+    RawRequest,\n+    SchemaCompiler,\n+    TypeProvider,\n+    ContextConfig,\n+    Logger,\n+    RequestType\n+  > {\n+    message: ContextConfig extends { includeMessage: true }\n+      ? string\n+      : null;\n   }\n }\n \n@@ -35,9 +53,29 @@\n   return reply.send()\n }\n \n-type LowerCaseHTTPMethods = 'get' | 'post' | 'put' | 'patch' | 'head' | 'delete' | 'options'\n+fastify().get(\n+  '/',\n+  { config: { foo: 'bar', bar: 100, includeMessage: true } },\n+  (req) => {\n+    expectType<string>(req.message)\n+  }\n+)\n \n-;['GET', 'POST', 'PUT', 'PATCH', 'HEAD', 'DELETE', 'OPTIONS'].forEach(method => {\n+fastify().get(\n+  '/',\n+  { config: { foo: 'bar', bar: 100, includeMessage: false } },\n+  (req) => {\n+    expectType<null>(req.message)\n+  }\n+)\n+\n+type LowerCaseHTTPMethods = 'delete' | 'get' | 'head' | 'patch' | 'post' | 'put' |\n+  'options' | 'propfind' | 'proppatch' | 'mkcol' | 'copy' | 'move' | 'lock' |\n+  'unlock' | 'trace' | 'search' | 'mkcalendar' | 'report'\n+\n+  ;['DELETE', 'GET', 'HEAD', 'PATCH', 'POST', 'PUT', 'OPTIONS', 'PROPFIND',\n+  'PROPPATCH', 'MKCOL', 'COPY', 'MOVE', 'LOCK', 'UNLOCK', 'TRACE', 'SEARCH', 'MKCALENDAR', 'REPORT'\n+].forEach(method => {\n   // route method\n   expectType<FastifyInstance>(fastify().route({\n     method: method as HTTPMethods,\n@@ -57,6 +95,9 @@\n     errorHandler: (error, request, reply) => {\n       expectType<FastifyError>(error)\n       reply.send('error')\n+    },\n+    childLoggerFactory: function (logger, bindings, opts) {\n+      return logger.child(bindings, opts)\n     }\n   }))\n \n@@ -79,12 +120,16 @@\n     expectType<QuerystringInterface>(req.query)\n     expectType<ParamsInterface>(req.params)\n     expectType<http.IncomingHttpHeaders & HeadersInterface>(req.headers)\n-    expectType<string>(req.context.config.foo)\n-    expectType<number>(req.context.config.bar)\n-    expectType<boolean>(req.context.config.extra)\n-    expectType<string>(res.context.config.foo)\n-    expectType<number>(res.context.config.bar)\n-    expectType<boolean>(res.context.config.extra)\n+    expectType<string>(req.routeOptions.config.foo)\n+    expectType<number>(req.routeOptions.config.bar)\n+    expectType<boolean>(req.routeOptions.config.extra)\n+    expectType<string>(req.routeOptions.config.url)\n+    expectType<HTTPMethods | HTTPMethods[]>(req.routeOptions.config.method)\n+    expectType<string>(res.routeOptions.config.foo)\n",
					"match": false,
					"packageHash": "ecaf7edf4ad3fb27167ce4ba828c9e124d5ea1cd9e7ca880517a41e384cae68a",
					"size": 8480,
					"sourceHash": "a07a12fd6b21ec7596ead008c058ac161beb28c0bf330c86a07a118ba452034b",
					"status": "content"
				},
				"test/types/schema.test-d.ts": {
					"diff": "--- published/test/types/schema.test-d.ts\n+++ rebuilt/test/types/schema.test-d.ts\n@@ -1,9 +1,8 @@\n-import { expectAssignable, expectError } from 'tsd'\n-import fastify, { FastifyInstance, FastifyRequest, FastifySchema } from '../../fastify'\n-import { RouteGenericInterface } from '../../types/route'\n-import { ContextConfigDefault } from '../../types/utils'\n-import { FastifyReply } from '../../types/reply'\n+import { StandaloneValidator } from '@fastify/ajv-compiler'\n+import { StandaloneSerializer } from '@fastify/fast-json-stringify-compiler'\n import Ajv from 'ajv'\n+import { expectAssignable } from 'tsd'\n+import fastify, { FastifyInstance, FastifySchema } from '../../fastify'\n \n const server = fastify()\n \n@@ -21,6 +20,25 @@\n   () => { }\n ))\n \n+expectAssignable<FastifyInstance>(server.post(\n+  '/multiple-content-schema',\n+  {\n+    schema: {\n+      body: {\n+        content: {\n+          'application/json': {\n+            schema: { type: 'object' }\n+          },\n+          'text/plain': {\n+            schema: { type: 'string' }\n+          }\n+        }\n+      }\n+    }\n+  },\n+  () => { }\n+))\n+\n expectAssignable<FastifyInstance>(server.get(\n   '/empty-schema',\n   {\n@@ -54,6 +72,27 @@\n   }\n }, async req => req.body))\n \n+expectAssignable<FastifyInstance>(server.post('/test', {\n+  validatorCompiler: ({ schema }) => {\n+    return data => {\n+      if (!data || data.constructor !== Object) {\n+        return {\n+          error: [\n+            {\n+              keyword: 'type',\n+              instancePath: '',\n+              schemaPath: '#/type',\n+              params: { type: 'object' },\n+              message: 'value is not an object'\n+            }\n+          ]\n+        }\n+      }\n+      return { value: data }\n+    }\n+  }\n+}, async req => req.body))\n+\n expectAssignable<FastifyInstance>(server.setValidatorCompiler<FastifySchema & { validate: Record<string, unknown> }>(\n   function ({ schema }) {\n     return new Ajv().compile(schema)\n@@ -63,3 +102,34 @@\n expectAssignable<FastifyInstance>(server.setSerializerCompiler<FastifySchema & { validate: string }>(\n   () => data => JSON.stringify(data)\n ))\n+\n+// https://github.com/fastify/ajv-compiler/issues/95\n+{\n+  const factory = StandaloneValidator({\n+    readMode: false,\n+    storeFunction (routeOpts, schemaValidationCode) { }\n+  })\n+\n+  fastify({\n+    schemaController: {\n+      compilersFactory: {\n+        buildValidator: factory\n+      }\n+    }\n+  })\n+}\n+\n+{\n+  const factory = StandaloneSerializer({\n+    readMode: false,\n+    storeFunction (routeOpts, schemaValidationCode) { }\n+  })\n+\n+  fastify({\n+    schemaController: {\n+      compilersFactory: {\n",
					"match": false,
					"packageHash": "0b993556096ffdaef1676821c19061543d89ecdaba0f4dd825783384f907865c",
					"size": 1685,
					"sourceHash": "faa5fc55fda4bdacf0a5f15ef5aafb1dd032b912be9c86692d03c45aa461e982",
					"status": "content"
				},
				"test/types/serverFactory.test-d.ts": {
					"diff": "--- published/test/types/serverFactory.test-d.ts\n+++ rebuilt/test/types/serverFactory.test-d.ts\n@@ -1,9 +1,9 @@\n import fastify, { FastifyServerFactory } from '../../fastify'\n-import * as http from 'http'\n+import * as http from 'node:http'\n import { expectType } from 'tsd'\n \n // Custom Server\n-type CustomType = void;\n+type CustomType = void\n interface CustomIncomingMessage extends http.IncomingMessage {\n   fakeMethod?: () => CustomType;\n }\n",
					"match": false,
					"packageHash": "6671ed3fd8b61d2e5845b072fd1b47ff23acc4092d35401ace95652cd2c09c69",
					"size": 1086,
					"sourceHash": "f7094a56791379d7e0cedefcec0654d9e42b800e4069a47a69f193cfe1fdad57",
					"status": "content"
				},
				"test/types/type-provider.test-d.ts": {
					"diff": "--- published/test/types/type-provider.test-d.ts\n+++ rebuilt/test/types/type-provider.test-d.ts\n@@ -3,10 +3,12 @@\n   HookHandlerDoneFunction,\n   FastifyRequest,\n   FastifyReply,\n-  FastifyInstance\n+  FastifyInstance,\n+  FastifyError,\n+  SafePromiseLike\n } from '../../fastify'\n import { expectAssignable, expectError, expectType } from 'tsd'\n-import { IncomingHttpHeaders } from 'http'\n+import { IncomingHttpHeaders } from 'node:http'\n import { Type, TSchema, Static } from '@sinclair/typebox'\n import { FromSchema, JSONSchema } from 'json-schema-to-ts'\n \n@@ -22,7 +24,10 @@\n // Remapping\n // -------------------------------------------------------------------\n \n-interface NumberProvider extends FastifyTypeProvider { output: number } // remap all schemas to numbers\n+interface NumberProvider extends FastifyTypeProvider {\n+  validator: number\n+  serializer: number\n+} // remap all schemas to numbers\n \n expectAssignable(server.withTypeProvider<NumberProvider>().get(\n   '/',\n@@ -46,7 +51,7 @@\n // Override\n // -------------------------------------------------------------------\n \n-interface OverriddenProvider extends FastifyTypeProvider { output: 'inferenced' }\n+interface OverriddenProvider extends FastifyTypeProvider { validator: 'inferenced' }\n \n expectAssignable(server.withTypeProvider<OverriddenProvider>().get<{ Body: 'override' }>(\n   '/',\n@@ -68,7 +73,10 @@\n // TypeBox\n // -------------------------------------------------------------------\n \n-interface TypeBoxProvider extends FastifyTypeProvider { output: this['input'] extends TSchema ? Static<this['input']> : never }\n+interface TypeBoxProvider extends FastifyTypeProvider {\n+  validator: this['schema'] extends TSchema ? Static<this['schema']> : unknown\n+  serializer: this['schema'] extends TSchema ? Static<this['schema']> : unknown\n+}\n \n expectAssignable(server.withTypeProvider<TypeBoxProvider>().get(\n   '/',\n@@ -79,6 +87,14 @@\n         y: Type.Number(),\n         z: Type.Number()\n       })\n+    },\n+    errorHandler: (error, request, reply) => {\n+      expectType<FastifyError>(error)\n+      expectAssignable<FastifyRequest>(request)\n+      expectType<number>(request.body.x)\n+      expectType<number>(request.body.y)\n+      expectType<number>(request.body.z)\n+      expectAssignable<FastifyReply>(reply)\n     }\n   },\n   (req) => {\n@@ -88,11 +104,18 @@\n   }\n ))\n \n+expectAssignable<FastifyInstance>(server.withTypeProvider<TypeBoxProvider>())\n+\n // -------------------------------------------------------------------\n // JsonSchemaToTs\n // -------------------------------------------------------------------\n \n-interface JsonSchemaToTsProvider extends FastifyTypeProvider { output: this['input'] extends JSONSchema ? FromSchema<this['input']> : never }\n+interface JsonSchemaToTsProvider extends FastifyTypeProvider {\n+  validator: this['schema'] extends JSONSchema ? FromSchema<this['schema']> : unknown\n+  serializer: this['schema'] extends JSONSchema ? FromSchema<this['schema']> : unknown\n+}\n+\n+// explicitly setting schema `as const`\n \n expectAssignable(server.withTypeProvider<JsonSchemaToTsProvider>().get(\n   '/',\n@@ -106,6 +129,14 @@\n           z: { type: 'boolean' }\n         }\n       } as const\n+    },\n+    errorHandler: (error, request, reply) => {\n+      expectType<FastifyError>(error)\n+      expectAssignable<FastifyRequest>(request)\n+      expectType<number | undefined>(request.body.x)\n+      expectType<string | undefined>(request.body.y)\n+      expectType<boolean | undefined>(request.body.z)\n+      expectAssignable<FastifyReply>(reply)\n     }\n   },\n   (req) => {\n",
					"match": false,
					"packageHash": "f9ad20995e349310e67ea2fd3874360299d21f8b65bea49e27c42d5c557856dd",
					"size": 13533,
					"sourceHash": "0c5e5220f670a4988c9b66c9eec9499a70e72bced76ca4a9a76092603d0421b9",
					"status": "content"
				},
				"test/unlock.test.js": {
					"match": false,
					"packageHash": "0e326e0d63e29c2be4b72ad8c8989863c3bc870e2ee67e3e5eb225d130eff22f",
					"size": 842,
					"status": "missing-in-source"
				},
				"test/unsupported-httpversion.test.js": {
					"match": false,
					"packageHash": "4a2d49e7f8b3a7ebc4dfe64273b694684952666ccd3afa67ea26270fc6c22788",
					"size": 1379,
					"status": "missing-in-source"
				},
				"test/upgrade.test.js": {
					"diff": "--- published/test/upgrade.test.js\n+++ rebuilt/test/upgrade.test.js\n@@ -1,53 +1,52 @@\n 'use strict'\n \n-const { test, skip } = require('tap')\n-const { lookup } = require('dns').promises\n+const { describe, test } = require('node:test')\n const Fastify = require('..')\n-const { connect } = require('net')\n-const { once } = require('events')\n+const { connect } = require('node:net')\n+const { once } = require('node:events')\n+const dns = require('node:dns').promises\n+\n+describe('upgrade to both servers', async () => {\n+  const localAddresses = await dns.lookup('localhost', { all: true })\n+  const skip = localAddresses.length === 1 && 'requires both IPv4 and IPv6'\n \n-async function setup () {\n-  const results = await lookup('localhost', { all: true })\n-  if (results.length === 1) {\n-    skip('requires both IPv4 and IPv6')\n-    return\n-  }\n-\n-  test('upgrade to both servers', async t => {\n+  await test('upgrade IPv4 and IPv6', { skip }, async t => {\n     t.plan(2)\n-    const app = Fastify()\n-    app.server.on('upgrade', (req, socket, head) => {\n-      t.pass(`upgrade event ${JSON.stringify(socket.address())}`)\n+\n+    const fastify = Fastify()\n+    fastify.server.on('upgrade', (req, socket, head) => {\n+      t.assert.ok(`upgrade event ${JSON.stringify(socket.address())}`)\n       socket.end()\n     })\n-    app.get('/', (req, res) => {\n+\n+    fastify.get('/', (req, res) => {\n+      res.send()\n     })\n-    await app.listen()\n-    t.teardown(app.close.bind(app))\n+\n+    await fastify.listen()\n+    t.after(() => fastify.close())\n \n     {\n-      const client = connect(app.server.address().port, '127.0.0.1')\n-      client.write('GET / HTTP/1.1\\r\\n')\n-      client.write('Upgrade: websocket\\r\\n')\n-      client.write('Connection: Upgrade\\r\\n')\n-      client.write('Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==\\r\\n')\n-      client.write('Sec-WebSocket-Protocol: com.xxx.service.v1\\r\\n')\n-      client.write('Sec-WebSocket-Version: 13\\r\\n\\r\\n')\n-      client.write('\\r\\n\\r\\n')\n-      await once(client, 'close')\n+      const clientIPv4 = connect(fastify.server.address().port, '127.0.0.1')\n+      clientIPv4.write('GET / HTTP/1.1\\r\\n')\n+      clientIPv4.write('Upgrade: websocket\\r\\n')\n+      clientIPv4.write('Connection: Upgrade\\r\\n')\n+      clientIPv4.write('Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==\\r\\n')\n+      clientIPv4.write('Sec-WebSocket-Protocol: com.xxx.service.v1\\r\\n')\n+      clientIPv4.write('Sec-WebSocket-Version: 13\\r\\n\\r\\n')\n+      clientIPv4.write('\\r\\n\\r\\n')\n+      await once(clientIPv4, 'close')\n     }\n \n     {\n-      const client = connect(app.server.address().port, '::1')\n-      client.write('GET / HTTP/1.1\\r\\n')\n-      client.write('Upgrade: websocket\\r\\n')\n-      client.write('Connection: Upgrade\\r\\n')\n-      client.write('Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==\\r\\n')\n-      client.write('Sec-WebSocket-Protocol: com.xxx.service.v1\\r\\n')\n-      client.write('Sec-WebSocket-Version: 13\\r\\n\\r\\n')\n-      await once(client, 'close')\n+      const clientIPv6 = connect(fastify.server.address().port, '::1')\n+      clientIPv6.write('GET / HTTP/1.1\\r\\n')\n+      clientIPv6.write('Upgrade: websocket\\r\\n')\n+      clientIPv6.write('Connection: Upgrade\\r\\n')\n+      clientIPv6.write('Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==\\r\\n')\n+      clientIPv6.write('Sec-WebSocket-Protocol: com.xxx.service.v1\\r\\n')\n+      clientIPv6.write('Sec-WebSocket-Version: 13\\r\\n\\r\\n')\n+      await once(clientIPv6, 'close')\n     }\n   })\n-}\n-\n-setup()\n+})\n",
					"match": false,
					"packageHash": "071e7d0175eff305c6a36f7f10b88015af621b9fd15b339d2d6af3cb5bb98558",
					"size": 1626,
					"sourceHash": "e0cd80f32e2173918516d56ca83f9ae44c5eb0fbe2b80cebd7e26b74f03c904e",
					"status": "content"
				},
				"test/url-rewriting.test.js": {
					"diff": "--- published/test/url-rewriting.test.js\n+++ rebuilt/test/url-rewriting.test.js\n@@ -1,15 +1,14 @@\n 'use strict'\n \n-const t = require('tap')\n-const test = t.test\n+const { test } = require('node:test')\n const Fastify = require('..')\n-const sget = require('simple-get').concat\n \n-test('Should rewrite url', t => {\n-  t.plan(5)\n+test('Should rewrite url', async t => {\n+  t.plan(4)\n   const fastify = Fastify({\n     rewriteUrl (req) {\n-      t.equal(req.url, '/this-would-404-without-url-rewrite')\n+      t.assert.strictEqual(req.url, '/this-would-404-without-url-rewrite')\n+      this.log.info('rewriting url')\n       return '/'\n     }\n   })\n@@ -22,27 +21,23 @@\n     }\n   })\n \n-  fastify.listen({ port: 0 }, function (err) {\n-    t.error(err)\n+  const fastifyServer = await fastify.listen({ port: 0 })\n \n-    sget({\n-      method: 'GET',\n-      url: 'http://localhost:' + fastify.server.address().port + '/this-would-404-without-url-rewrite'\n-    }, (err, response, body) => {\n-      t.error(err)\n-      t.same(JSON.parse(body), { hello: 'world' })\n-      t.equal(response.statusCode, 200)\n-    })\n-  })\n+  t.after(() => fastify.close())\n+\n+  const result = await fetch(`${fastifyServer}/this-would-404-without-url-rewrite`)\n \n-  t.teardown(() => fastify.close())\n+  t.assert.ok(result.ok)\n+  t.assert.strictEqual(result.status, 200)\n+  t.assert.deepStrictEqual(await result.json(), { hello: 'world' })\n })\n \n-test('Should not rewrite if the url is the same', t => {\n-  t.plan(4)\n+test('Should not rewrite if the url is the same', async t => {\n+  t.plan(3)\n   const fastify = Fastify({\n     rewriteUrl (req) {\n-      t.equal(req.url, '/this-would-404-without-url-rewrite')\n+      t.assert.strictEqual(req.url, '/this-would-404-without-url-rewrite')\n+      this.log.info('rewriting url')\n       return req.url\n     }\n   })\n@@ -55,25 +50,22 @@\n     }\n   })\n \n-  fastify.listen({ port: 0 }, function (err) {\n-    t.error(err)\n+  const fastifyServer = await fastify.listen({ port: 0 })\n \n-    sget({\n-      method: 'GET',\n-      url: 'http://localhost:' + fastify.server.address().port + '/this-would-404-without-url-rewrite'\n-    }, (err, response, body) => {\n-      t.error(err)\n-      t.equal(response.statusCode, 404)\n-    })\n-  })\n+  t.after(() => fastify.close())\n+\n+  const result = await fetch(`${fastifyServer}/this-would-404-without-url-rewrite`)\n \n-  t.teardown(() => fastify.close())\n+  t.assert.ok(!result.ok)\n+  t.assert.strictEqual(result.status, 404)\n })\n-test('Should throw an error', t => {\n-  t.plan(5)\n+\n+test('Should throw an error', async t => {\n+  t.plan(2)\n   const fastify = Fastify({\n     rewriteUrl (req) {\n-      t.equal(req.url, '/this-would-404-without-url-rewrite')\n+      t.assert.strictEqual(req.url, '/this-would-404-without-url-rewrite')\n+      this.log.info('rewriting url')\n       return undefined\n     }\n   })\n@@ -86,18 +78,45 @@\n",
					"match": false,
					"packageHash": "4474eb16b1976cb4c35459957bb74b10c2b4e2b5255a067e6ff745331db8a01a",
					"size": 2257,
					"sourceHash": "367595e1355e74550dec593a5eb71e76fb1c7417cd058a47f04cb9103de288c5",
					"status": "content"
				},
				"test/validation-error-handling.test.js": {
					"diff": "--- published/test/validation-error-handling.test.js\n+++ rebuilt/test/validation-error-handling.test.js\n@@ -1,6 +1,6 @@\n 'use strict'\n \n-const { test } = require('tap')\n+const { describe, test } = require('node:test')\n const Joi = require('joi')\n const Fastify = require('..')\n \n@@ -19,58 +19,56 @@\n   reply.code(200).send(req.body.name)\n }\n \n-test('should work with valid payload', t => {\n-  t.plan(3)\n+test('should work with valid payload', async (t) => {\n+  t.plan(2)\n \n   const fastify = Fastify()\n \n   fastify.post('/', { schema }, echoBody)\n \n-  fastify.inject({\n+  const response = await fastify.inject({\n     method: 'POST',\n     payload: {\n       name: 'michelangelo',\n       work: 'sculptor, painter, architect and poet'\n     },\n     url: '/'\n-  }, (err, res) => {\n-    t.error(err)\n-    t.same(res.payload, 'michelangelo')\n-    t.equal(res.statusCode, 200)\n   })\n+  t.assert.deepStrictEqual(response.payload, 'michelangelo')\n+  t.assert.strictEqual(response.statusCode, 200)\n })\n \n-test('should fail immediately with invalid payload', t => {\n-  t.plan(3)\n+test('should fail immediately with invalid payload', async (t) => {\n+  t.plan(2)\n \n   const fastify = Fastify()\n \n   fastify.post('/', { schema }, echoBody)\n \n-  fastify.inject({\n+  const response = await fastify.inject({\n     method: 'POST',\n     payload: {\n       hello: 'michelangelo'\n     },\n     url: '/'\n-  }, (err, res) => {\n-    t.error(err)\n-    t.same(res.json(), {\n-      statusCode: 400,\n-      error: 'Bad Request',\n-      message: \"body must have required property 'name'\"\n-    })\n-    t.equal(res.statusCode, 400)\n   })\n+\n+  t.assert.deepStrictEqual(response.json(), {\n+    statusCode: 400,\n+    code: 'FST_ERR_VALIDATION',\n+    error: 'Bad Request',\n+    message: \"body must have required property 'name'\"\n+  })\n+  t.assert.strictEqual(response.statusCode, 400)\n })\n \n-test('should be able to use setErrorHandler specify custom validation error', t => {\n-  t.plan(3)\n+test('should be able to use setErrorHandler specify custom validation error', async (t) => {\n+  t.plan(2)\n \n   const fastify = Fastify()\n \n   fastify.post('/', { schema }, function (req, reply) {\n-    t.fail('should not be here')\n+    t.assert.fail('should not be here')\n     reply.code(200).send(req.body.name)\n   })\n \n@@ -80,25 +78,24 @@\n     }\n   })\n \n-  fastify.inject({\n+  const response = await fastify.inject({\n     method: 'POST',\n     payload: {\n       hello: 'michelangelo'\n     },\n     url: '/'\n-  }, (err, res) => {\n",
					"match": false,
					"packageHash": "07db0ea52c56319faec5db973850f7e353873369607fe82a10fb9477d3878445",
					"size": 17609,
					"sourceHash": "1404127c52832fe8041fa61a46ee5e0debecc861669c4650122e3f1e180fc273",
					"status": "content"
				},
				"test/versioned-routes.test.js": {
					"diff": "--- published/test/versioned-routes.test.js\n+++ rebuilt/test/versioned-routes.test.js\n@@ -1,13 +1,11 @@\n 'use strict'\n \n-const { test, before } = require('tap')\n+const { test, before } = require('node:test')\n const helper = require('./helper')\n const Fastify = require('..')\n-const sget = require('simple-get').concat\n-const http = require('http')\n+const http = require('node:http')\n const split = require('split2')\n const append = require('vary').append\n-const proxyquire = require('proxyquire')\n \n process.removeAllListeners('warning')\n \n@@ -16,7 +14,7 @@\n   [localhost] = await helper.getLoopbackHost()\n })\n \n-test('Should register a versioned route', t => {\n+test('Should register a versioned route (inject)', (t, done) => {\n   t.plan(11)\n   const fastify = Fastify()\n \n@@ -36,9 +34,9 @@\n       'Accept-Version': '1.x'\n     }\n   }, (err, res) => {\n-    t.error(err)\n-    t.same(JSON.parse(res.payload), { hello: 'world' })\n-    t.equal(res.statusCode, 200)\n+    t.assert.ifError(err)\n+    t.assert.deepStrictEqual(JSON.parse(res.payload), { hello: 'world' })\n+    t.assert.strictEqual(res.statusCode, 200)\n   })\n \n   fastify.inject({\n@@ -48,9 +46,9 @@\n       'Accept-Version': '1.2.x'\n     }\n   }, (err, res) => {\n-    t.error(err)\n-    t.same(JSON.parse(res.payload), { hello: 'world' })\n-    t.equal(res.statusCode, 200)\n+    t.assert.ifError(err)\n+    t.assert.deepStrictEqual(JSON.parse(res.payload), { hello: 'world' })\n+    t.assert.strictEqual(res.statusCode, 200)\n   })\n \n   fastify.inject({\n@@ -60,9 +58,9 @@\n       'Accept-Version': '1.2.0'\n     }\n   }, (err, res) => {\n-    t.error(err)\n-    t.same(JSON.parse(res.payload), { hello: 'world' })\n-    t.equal(res.statusCode, 200)\n+    t.assert.ifError(err)\n+    t.assert.deepStrictEqual(JSON.parse(res.payload), { hello: 'world' })\n+    t.assert.strictEqual(res.statusCode, 200)\n   })\n \n   fastify.inject({\n@@ -72,12 +70,13 @@\n       'Accept-Version': '1.2.1'\n     }\n   }, (err, res) => {\n-    t.error(err)\n-    t.equal(res.statusCode, 404)\n+    t.assert.ifError(err)\n+    t.assert.strictEqual(res.statusCode, 404)\n+    done()\n   })\n })\n \n-test('Should register a versioned route via route constraints', t => {\n+test('Should register a versioned route via route constraints', (t, done) => {\n   t.plan(6)\n   const fastify = Fastify()\n \n@@ -97,9 +96,9 @@\n       'Accept-Version': '1.x'\n     }\n   }, (err, res) => {\n-    t.error(err)\n-    t.same(JSON.parse(res.payload), { hello: 'world' })\n-    t.equal(res.statusCode, 200)\n+    t.assert.ifError(err)\n+    t.assert.deepStrictEqual(JSON.parse(res.payload), { hello: 'world' })\n+    t.assert.strictEqual(res.statusCode, 200)\n   })\n \n   fastify.inject({\n@@ -109,13 +108,14 @@\n       'Accept-Version': '1.2.x'\n     }\n   }, (err, res) => {\n",
					"match": false,
					"packageHash": "e79855a9bc684c28b1888fa585706f8207adaf067c6b1739bb56e9cbe0234aea",
					"size": 14745,
					"sourceHash": "6db2cc22bdc20330c4c9be790188af612135830ca3adeeba8c95b4c3374cefff",
					"status": "content"
				},
				"test/wrapThenable.test.js": {
					"match": false,
					"packageHash": "9055e4bf3eedbfa39a185ffca003446f45e2a0a5aade8e35fe0143a8d1c52d07",
					"size": 774,
					"status": "missing-in-source"
				},
				"types/.eslintrc.json": {
					"match": false,
					"packageHash": "b75b560b2773165941ebd8379f1d98be3ed139520eec79aeaa6aa87448194a63",
					"size": 1315,
					"status": "missing-in-source"
				},
				"types/content-type-parser.d.ts": {
					"diff": "--- published/types/content-type-parser.d.ts\n+++ rebuilt/types/content-type-parser.d.ts\n@@ -15,7 +15,7 @@\n   RawRequest extends RawRequestDefaultExpression<RawServer> = RawRequestDefaultExpression<RawServer>,\n   RouteGeneric extends RouteGenericInterface = RouteGenericInterface,\n   SchemaCompiler extends FastifySchema = FastifySchema,\n-  TypeProvider extends FastifyTypeProvider = FastifyTypeProviderDefault,\n+  TypeProvider extends FastifyTypeProvider = FastifyTypeProviderDefault\n > = ((request: FastifyRequest<RouteGeneric, RawServer, RawRequest, SchemaCompiler, TypeProvider>, rawBody: RawBody, done: ContentTypeParserDoneFunction) => void)\n | ((request: FastifyRequest<RouteGeneric, RawServer, RawRequest, SchemaCompiler, TypeProvider>, rawBody: RawBody) => Promise<any>)\n \n@@ -27,7 +27,7 @@\n   RawRequest extends RawRequestDefaultExpression<RawServer> = RawRequestDefaultExpression<RawServer>,\n   RouteGeneric extends RouteGenericInterface = RouteGenericInterface,\n   SchemaCompiler extends FastifySchema = FastifySchema,\n-  TypeProvider extends FastifyTypeProvider = FastifyTypeProviderDefault,\n+  TypeProvider extends FastifyTypeProvider = FastifyTypeProviderDefault\n > = ((request: FastifyRequest<RouteGeneric, RawServer, RawRequest, SchemaCompiler, TypeProvider>, payload: RawRequest) => Promise<any>)\n | ((request: FastifyRequest<RouteGeneric, RawServer, RawRequest, SchemaCompiler, TypeProvider>, payload: RawRequest, done: ContentTypeParserDoneFunction) => void)\n \n@@ -39,7 +39,7 @@\n   RawRequest extends RawRequestDefaultExpression<RawServer> = RawRequestDefaultExpression<RawServer>,\n   RouteGeneric extends RouteGenericInterface = RouteGenericInterface,\n   SchemaCompiler extends FastifySchema = FastifySchema,\n-  TypeProvider extends FastifyTypeProvider = FastifyTypeProviderDefault,\n+  TypeProvider extends FastifyTypeProvider = FastifyTypeProviderDefault\n > {\n   (\n     contentType: string | string[] | RegExp,\n",
					"match": false,
					"packageHash": "feeb4514da40bd3c50f6c884c607adb142002b3c8e6a3fe76db41ba8cce644ad",
					"size": 3804,
					"sourceHash": "05e29a500e59cc5697947ee0fa9390e88ff008ec76be1f859152bda8ec01f13d",
					"status": "content"
				},
				"types/context.d.ts": {
					"diff": "--- published/types/context.d.ts\n+++ rebuilt/types/context.d.ts\n@@ -1,12 +1,22 @@\n+import { FastifyRouteConfig } from './route'\n import { ContextConfigDefault } from './utils'\n \n-// eslint-disable-next-line @typescript-eslint/no-empty-interface\n export interface FastifyContextConfig {\n }\n \n /**\n  * Route context object. Properties defined here will be available in the route's handler\n  */\n-export interface FastifyContext<ContextConfig = ContextConfigDefault> {\n-  config: FastifyContextConfig & ContextConfig;\n+export interface FastifyRequestContext<ContextConfig = ContextConfigDefault> {\n+  /**\n+   * @deprecated Use Request#routeOptions#config or Request#routeOptions#schema instead\n+   */\n+  config: FastifyContextConfig & FastifyRouteConfig & ContextConfig;\n+}\n+\n+export interface FastifyReplyContext<ContextConfig = ContextConfigDefault> {\n+  /**\n+   * @deprecated Use Reply#routeOptions#config or Reply#routeOptions#schema instead\n+   */\n+  config: FastifyContextConfig & FastifyRouteConfig & ContextConfig;\n }\n",
					"match": false,
					"packageHash": "ca30175a9d850c2e0987ea442f3224b831277221c699b5b564dd00cd3b0f8ea7",
					"size": 377,
					"sourceHash": "64102e00cb41de7f423608037d17dff83954904383e5c45f1054c2246cf5e184",
					"status": "content"
				},
				"types/hooks.d.ts": {
					"diff": "--- published/types/hooks.d.ts\n+++ rebuilt/types/hooks.d.ts\n@@ -1,11 +1,11 @@\n-import { Readable } from 'stream'\n+import { Readable } from 'node:stream'\n import { FastifyInstance } from './instance'\n import { RouteOptions, RouteGenericInterface } from './route'\n import { RawServerBase, RawServerDefault, RawRequestDefaultExpression, RawReplyDefaultExpression, ContextConfigDefault } from './utils'\n import { FastifyRequest } from './request'\n import { FastifyReply } from './reply'\n import { FastifyError } from '@fastify/error'\n-import { FastifyLoggerInstance } from './logger'\n+import { FastifyBaseLogger } from './logger'\n import {\n   FastifyTypeProvider,\n   FastifyTypeProviderDefault\n@@ -34,12 +34,12 @@\n   ContextConfig = ContextConfigDefault,\n   SchemaCompiler extends FastifySchema = FastifySchema,\n   TypeProvider extends FastifyTypeProvider = FastifyTypeProviderDefault,\n-  Logger extends FastifyLoggerInstance = FastifyLoggerInstance\n+  Logger extends FastifyBaseLogger = FastifyBaseLogger\n > {\n   (\n     this: FastifyInstance<RawServer, RawRequest, RawReply, Logger, TypeProvider>,\n     request: FastifyRequest<RouteGeneric, RawServer, RawRequest, SchemaCompiler, TypeProvider, ContextConfig, Logger>,\n-    reply: FastifyReply<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider>,\n+    reply: FastifyReply<RouteGeneric, RawServer, RawRequest, RawReply, ContextConfig, SchemaCompiler, TypeProvider>,\n     done: HookHandlerDoneFunction\n   ): void;\n }\n@@ -52,15 +52,33 @@\n   ContextConfig = ContextConfigDefault,\n   SchemaCompiler extends FastifySchema = FastifySchema,\n   TypeProvider extends FastifyTypeProvider = FastifyTypeProviderDefault,\n-  Logger extends FastifyLoggerInstance = FastifyLoggerInstance\n+  Logger extends FastifyBaseLogger = FastifyBaseLogger\n > {\n   (\n     this: FastifyInstance<RawServer, RawRequest, RawReply, Logger, TypeProvider>,\n     request: FastifyRequest<RouteGeneric, RawServer, RawRequest, SchemaCompiler, TypeProvider, ContextConfig, Logger>,\n-    reply: FastifyReply<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider>,\n+    reply: FastifyReply<RouteGeneric, RawServer, RawRequest, RawReply, ContextConfig, SchemaCompiler, TypeProvider>,\n   ): Promise<unknown>;\n }\n \n+// helper type which infers whether onRequestHookHandler or onRequestAsyncHookHandler are\n+// applicable based on the specified return type.\n+export type onRequestMetaHookHandler<\n+  RawServer extends RawServerBase = RawServerDefault,\n+  RawRequest extends RawRequestDefaultExpression<RawServer> = RawRequestDefaultExpression<RawServer>,\n+  RawReply extends RawReplyDefaultExpression<RawServer> = RawReplyDefaultExpression<RawServer>,\n+  RouteGeneric extends RouteGenericInterface = RouteGenericInterface,\n+  ContextConfig = ContextConfigDefault,\n+  SchemaCompiler extends FastifySchema = FastifySchema,\n+  TypeProvider extends FastifyTypeProvider = FastifyTypeProviderDefault,\n+  Logger extends FastifyBaseLogger = FastifyBaseLogger,\n+  Return extends ReturnType<onRequestHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger>>\n+  | ReturnType<onRequestAsyncHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger>>\n+  = ReturnType<onRequestHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger>>\n+> = Return extends ReturnType<onRequestHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger>>\n+  ? onRequestHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger>\n+  : onRequestAsyncHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger>\n+\n /**\n  * `preParsing` is the second hook to be executed in the request lifecycle. The previous hook was `onRequest`, the next hook will be `preValidation`.\n  * Notice: in the `preParsing` hook, request.body will always be null, because the body parsing happens before the `preHandler` hook.\n@@ -73,12 +91,12 @@\n   ContextConfig = ContextConfigDefault,\n   SchemaCompiler extends FastifySchema = FastifySchema,\n   TypeProvider extends FastifyTypeProvider = FastifyTypeProviderDefault,\n-  Logger extends FastifyLoggerInstance = FastifyLoggerInstance\n+  Logger extends FastifyBaseLogger = FastifyBaseLogger\n > {\n   (\n     this: FastifyInstance<RawServer, RawRequest, RawReply, Logger, TypeProvider>,\n     request: FastifyRequest<RouteGeneric, RawServer, RawRequest, SchemaCompiler, TypeProvider, ContextConfig, Logger>,\n-    reply: FastifyReply<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider>,\n+    reply: FastifyReply<RouteGeneric, RawServer, RawRequest, RawReply, ContextConfig, SchemaCompiler, TypeProvider>,\n     payload: RequestPayload,\n     done: <TError extends Error = FastifyError>(err?: TError | null, res?: RequestPayload) => void\n   ): void;\n@@ -92,16 +110,34 @@\n   ContextConfig = ContextConfigDefault,\n   SchemaCompiler extends FastifySchema = FastifySchema,\n   TypeProvider extends FastifyTypeProvider = FastifyTypeProviderDefault,\n-  Logger extends FastifyLoggerInstance = FastifyLoggerInstance\n+  Logger extends FastifyBaseLogger = FastifyBaseLogger\n > {\n   (\n     this: FastifyInstance<RawServer, RawRequest, RawReply, Logger, TypeProvider>,\n     request: FastifyRequest<RouteGeneric, RawServer, RawRequest, SchemaCompiler, TypeProvider, ContextConfig, Logger>,\n-    reply: FastifyReply<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider>,\n+    reply: FastifyReply<RouteGeneric, RawServer, RawRequest, RawReply, ContextConfig, SchemaCompiler, TypeProvider>,\n     payload: RequestPayload,\n   ): Promise<RequestPayload | unknown>;\n }\n \n+// helper type which infers whether preParsingHookHandler or preParsingAsyncHookHandler are\n+// applicable based on the specified return type.\n",
					"match": false,
					"packageHash": "30840777e87bae4ad5e553f88965805b2dc826385466308815813a6b3ffbd500",
					"size": 26336,
					"sourceHash": "4f62dc739ef3b99a93779255f85e51f02ce411d63cf294ee654258ff8c1978e4",
					"status": "content"
				},
				"types/instance.d.ts": {
					"diff": "--- published/types/instance.d.ts\n+++ rebuilt/types/instance.d.ts\n@@ -1,33 +1,39 @@\n import { FastifyError } from '@fastify/error'\n-import { ConstraintStrategy, HTTPVersion } from 'find-my-way'\n-import * as http from 'http'\n-import { CallbackFunc as LightMyRequestCallback, Chain as LightMyRequestChain, InjectOptions, Response as LightMyRequestResponse } from 'light-my-request'\n-import { AddContentTypeParser, ConstructorAction, FastifyBodyParser, getDefaultJsonParser, hasContentTypeParser, ProtoAction, removeAllContentTypeParsers, removeContentTypeParser } from './content-type-parser'\n-import { onCloseAsyncHookHandler, onCloseHookHandler, onErrorAsyncHookHandler, onErrorHookHandler, onReadyAsyncHookHandler, onReadyHookHandler, onRegisterHookHandler, onRequestAsyncHookHandler, onRequestHookHandler, onResponseAsyncHookHandler, onResponseHookHandler, onRouteHookHandler, onSendAsyncHookHandler, onSendHookHandler, onTimeoutAsyncHookHandler, onTimeoutHookHandler, preHandlerAsyncHookHandler, preHandlerHookHandler, preParsingAsyncHookHandler, preParsingHookHandler, preSerializationAsyncHookHandler, preSerializationHookHandler, preValidationAsyncHookHandler, preValidationHookHandler } from './hooks'\n-import { FastifyLoggerInstance } from './logger'\n+import { ConstraintStrategy, FindResult, HTTPVersion } from 'find-my-way'\n+import * as http from 'node:http'\n+import { InjectOptions, CallbackFunc as LightMyRequestCallback, Chain as LightMyRequestChain, Response as LightMyRequestResponse } from 'light-my-request'\n+import { AddressInfo } from 'node:net'\n+import { AddContentTypeParser, ConstructorAction, FastifyBodyParser, ProtoAction, getDefaultJsonParser, hasContentTypeParser, removeAllContentTypeParsers, removeContentTypeParser } from './content-type-parser'\n+import { ApplicationHook, HookAsyncLookup, HookLookup, LifecycleHook, onCloseAsyncHookHandler, onCloseHookHandler, onErrorAsyncHookHandler, onErrorHookHandler, onListenAsyncHookHandler, onListenHookHandler, onReadyAsyncHookHandler, onReadyHookHandler, onRegisterHookHandler, onRequestAbortAsyncHookHandler, onRequestAbortHookHandler, onRequestAsyncHookHandler, onRequestHookHandler, onResponseAsyncHookHandler, onResponseHookHandler, onRouteHookHandler, onSendAsyncHookHandler, onSendHookHandler, onTimeoutAsyncHookHandler, onTimeoutHookHandler, preCloseAsyncHookHandler, preCloseHookHandler, preHandlerAsyncHookHandler, preHandlerHookHandler, preParsingAsyncHookHandler, preParsingHookHandler, preSerializationAsyncHookHandler, preSerializationHookHandler, preValidationAsyncHookHandler, preValidationHookHandler } from './hooks'\n+import { FastifyBaseLogger, FastifyChildLoggerFactory } from './logger'\n import { FastifyRegister } from './register'\n import { FastifyReply } from './reply'\n import { FastifyRequest } from './request'\n-import { DefaultRoute, RouteGenericInterface, RouteOptions, RouteShorthandMethod } from './route'\n+import { RouteGenericInterface, RouteHandlerMethod, RouteOptions, RouteShorthandMethod } from './route'\n import {\n   FastifySchema,\n   FastifySchemaCompiler,\n   FastifySchemaControllerOptions,\n-  FastifySchemaValidationError,\n-  FastifySerializerCompiler\n+  FastifySerializerCompiler,\n+  SchemaErrorFormatter\n } from './schema'\n import {\n   FastifyTypeProvider,\n-  FastifyTypeProviderDefault\n+  FastifyTypeProviderDefault,\n+  SafePromiseLike\n } from './type-provider'\n-import { ContextConfigDefault, RawReplyDefaultExpression, RawRequestDefaultExpression, RawServerBase, RawServerDefault } from './utils'\n+import { ContextConfigDefault, HTTPMethods, RawReplyDefaultExpression, RawRequestDefaultExpression, RawServerBase, RawServerDefault } from './utils'\n+import { FastifyRouterOptions } from '../fastify'\n \n export interface PrintRoutesOptions {\n+  method?: HTTPMethods;\n   includeMeta?: boolean | (string | symbol)[]\n   commonPrefix?: boolean\n   includeHooks?: boolean\n }\n \n+type AsyncFunction = (...args: any) => Promise<any>\n+\n export interface FastifyListenOptions {\n   /**\n    * Default to `0` (picks the first available open port).\n@@ -72,10 +78,41 @@\n    * @since This option is available only in Node.js v15.6.0 and greater\n    */\n   signal?: AbortSignal;\n+\n+  /**\n+   * Function that resolves text to log after server has been successfully started\n+   * @param address\n+   */\n+  listenTextResolver?: (address: string) => string;\n }\n \n type NotInInterface<Key, _Interface> = Key extends keyof _Interface ? never : Key\n type FindMyWayVersion<RawServer extends RawServerBase> = RawServer extends http.Server ? HTTPVersion.V1 : HTTPVersion.V2\n+type FindMyWayFindResult<RawServer extends RawServerBase> = FindResult<FindMyWayVersion<RawServer>>\n+\n+type GetterSetter<This, T> = T | {\n+  getter: (this: This) => T,\n+  setter?: (this: This, value: T) => void\n+}\n+\n+type DecorationMethod<This, Return = This> = {\n+  <\n+    // Need to disable \"no-use-before-define\" to maintain backwards compatibility, as else decorate<Foo> would suddenly mean something new\n+\n+    T extends (P extends keyof This ? This[P] : unknown),\n+    P extends string | symbol = string | symbol\n+  >(property: P,\n+    value: GetterSetter<This, T extends (...args: any[]) => any\n+      ? (this: This, ...args: Parameters<T>) => ReturnType<T>\n+      : T\n+    >,\n+    dependencies?: string[]\n+  ): Return;\n+\n+  (property: string | symbol): Return;\n+\n+  (property: string | symbol, value: null | undefined, dependencies: string[]): Return;\n+}\n \n /**\n  * Fastify server instance. Returned by the core `fastify()` method.\n@@ -84,51 +121,44 @@\n   RawServer extends RawServerBase = RawServerDefault,\n   RawRequest extends RawRequestDefaultExpression<RawServer> = RawRequestDefaultExpression<RawServer>,\n   RawReply extends RawReplyDefaultExpression<RawServer> = RawReplyDefaultExpression<RawServer>,\n-  Logger extends FastifyLoggerInstance = FastifyLoggerInstance,\n",
					"match": false,
					"packageHash": "5773a413aafa145c6b897a5c157db64aead0d847486cc9e4ddc5a5cacaa32ecd",
					"size": 29175,
					"sourceHash": "ef604537776f287b22066ffe4b2e0551959a8d2023344e710470670798779914",
					"status": "content"
				},
				"types/logger.d.ts": {
					"diff": "--- published/types/logger.d.ts\n+++ rebuilt/types/logger.d.ts\n@@ -1,29 +1,34 @@\n import { FastifyError } from '@fastify/error'\n-import { RouteGenericInterface } from './route'\n-import { FastifyRequest } from './request'\n+import { FastifyInstance } from './instance'\n import { FastifyReply } from './reply'\n-import { RawServerBase, RawServerDefault, RawRequestDefaultExpression, RawReplyDefaultExpression, ContextConfigDefault } from './utils'\n-import { FastifyTypeProvider, FastifyTypeProviderDefault } from './type-provider'\n+import { FastifyRequest } from './request'\n+import { RouteGenericInterface } from './route'\n import { FastifySchema } from './schema'\n+import { FastifyTypeProvider, FastifyTypeProviderDefault } from './type-provider'\n+import { ContextConfigDefault, RawReplyDefaultExpression, RawRequestDefaultExpression, RawServerBase, RawServerDefault } from './utils'\n \n-import pino from 'pino'\n-\n-/**\n- * Standard Fastify logging function\n- */\n-export type FastifyLogFn = pino.LogFn\n-\n-export type LogLevel = pino.Level\n-\n-export type Bindings = pino.Bindings\n-\n-export type ChildLoggerOptions = pino.ChildLoggerOptions\n+import type {\n+  BaseLogger,\n+  LogFn as FastifyLogFn,\n+  LevelWithSilent as LogLevel,\n+  Bindings,\n+  ChildLoggerOptions,\n+  LoggerOptions as PinoLoggerOptions\n+} from 'pino'\n+\n+export type {\n+  FastifyLogFn,\n+  LogLevel,\n+  Bindings,\n+  ChildLoggerOptions,\n+  PinoLoggerOptions\n+}\n \n-export type FastifyBaseLogger = pino.BaseLogger & {\n+export interface FastifyBaseLogger extends Pick<BaseLogger, 'level' | 'info' | 'error' | 'debug' | 'fatal' | 'warn' | 'trace' | 'silent'> {\n   child(bindings: Bindings, options?: ChildLoggerOptions): FastifyBaseLogger\n }\n \n-// TODO delete FastifyLoggerInstance in the next major release. It seems that it is enough to have only FastifyBaseLogger.\n+// TODO delete FastifyBaseLogger in the next major release. It seems that it is enough to have only FastifyBaseLogger.\n /**\n  * @deprecated Use FastifyBaseLogger instead\n  */\n@@ -33,7 +38,14 @@\n   write(msg: string): void;\n }\n \n-export type PinoLoggerOptions = pino.LoggerOptions\n+// TODO: once node 18 is EOL, this type can be replaced with plain FastifyReply.\n+/**\n+ * Specialized reply type used for the `res` log serializer, since only `statusCode` is passed in certain cases.\n+ */\n+export type ResSerializerReply<\n+  RawServer extends RawServerBase,\n+  RawReply extends FastifyReply<RouteGenericInterface, RawServer>\n+> = Partial<RawReply> & Pick<RawReply, 'statusCode'>\n \n /**\n  * Fastify Custom Logger options.\n@@ -41,14 +53,14 @@\n export interface FastifyLoggerOptions<\n   RawServer extends RawServerBase = RawServerDefault,\n   RawRequest extends FastifyRequest<RouteGenericInterface, RawServer, RawRequestDefaultExpression<RawServer>, FastifySchema, FastifyTypeProvider> = FastifyRequest<RouteGenericInterface, RawServer, RawRequestDefaultExpression<RawServer>, FastifySchema, FastifyTypeProviderDefault>,\n-  RawReply extends FastifyReply<RawServer, RawRequestDefaultExpression<RawServer>, RawReplyDefaultExpression<RawServer>, RouteGenericInterface, ContextConfigDefault, FastifySchema, FastifyTypeProvider> = FastifyReply<RawServer, RawRequestDefaultExpression<RawServer>, RawReplyDefaultExpression<RawServer>, RouteGenericInterface, ContextConfigDefault, FastifySchema, FastifyTypeProviderDefault>,\n+  RawReply extends FastifyReply<RouteGenericInterface, RawServer, RawRequestDefaultExpression<RawServer>, RawReplyDefaultExpression<RawServer>, ContextConfigDefault, FastifySchema, FastifyTypeProvider> = FastifyReply<RouteGenericInterface, RawServer, RawRequestDefaultExpression<RawServer>, RawReplyDefaultExpression<RawServer>, ContextConfigDefault, FastifySchema, FastifyTypeProviderDefault>\n > {\n   serializers?: {\n     req?: (req: RawRequest) => {\n       method?: string;\n       url?: string;\n       version?: string;\n-      hostname?: string;\n+      host?: string;\n       remoteAddress?: string;\n       remotePort?: number;\n       [key: string]: unknown;\n@@ -59,8 +71,8 @@\n       stack: string;\n       [key: string]: unknown;\n     };\n-    res?: (res: RawReply) => {\n-      statusCode: string | number;\n+    res?: (res: ResSerializerReply<RawServer, RawReply>) => {\n+      statusCode?: string | number;\n       [key: string]: unknown;\n     };\n   };\n@@ -69,3 +81,27 @@\n",
					"match": false,
					"packageHash": "46c640e48a62b242d379f1cb0da7186aedd7a051cb274b1276e0269905199fc7",
					"size": 2590,
					"sourceHash": "0c27f4ad317e7af86961e2eb09fb5e97de1b85d58f2958e81ef16baf920b9a60",
					"status": "content"
				},
				"types/plugin.d.ts": {
					"diff": "--- published/types/plugin.d.ts\n+++ rebuilt/types/plugin.d.ts\n@@ -1,7 +1,7 @@\n import { FastifyInstance } from './instance'\n import { RawServerBase, RawRequestDefaultExpression, RawReplyDefaultExpression, RawServerDefault } from './utils'\n import { FastifyTypeProvider, FastifyTypeProviderDefault } from './type-provider'\n-import { FastifyLoggerInstance } from './logger'\n+import { FastifyBaseLogger } from './logger'\n \n export type FastifyPluginOptions = Record<string, any>\n \n@@ -10,8 +10,13 @@\n  *\n  * Fastify allows the user to extend its functionalities with plugins. A plugin can be a set of routes, a server decorator or whatever. To activate plugins, use the `fastify.register()` method.\n  */\n-export type FastifyPluginCallback<Options extends FastifyPluginOptions = Record<never, never>, Server extends RawServerBase = RawServerDefault, TypeProvider extends FastifyTypeProvider = FastifyTypeProviderDefault> = (\n-  instance: FastifyInstance<Server, RawRequestDefaultExpression<Server>, RawReplyDefaultExpression<Server>, FastifyLoggerInstance, TypeProvider>,\n+export type FastifyPluginCallback<\n+  Options extends FastifyPluginOptions = Record<never, never>,\n+  Server extends RawServerBase = RawServerDefault,\n+  TypeProvider extends FastifyTypeProvider = FastifyTypeProviderDefault,\n+  Logger extends FastifyBaseLogger = FastifyBaseLogger\n+> = (\n+  instance: FastifyInstance<Server, RawRequestDefaultExpression<Server>, RawReplyDefaultExpression<Server>, Logger, TypeProvider>,\n   opts: Options,\n   done: (err?: Error) => void\n ) => void\n@@ -25,13 +30,15 @@\n   Options extends FastifyPluginOptions = Record<never, never>,\n   Server extends RawServerBase = RawServerDefault,\n   TypeProvider extends FastifyTypeProvider = FastifyTypeProviderDefault,\n+  Logger extends FastifyBaseLogger = FastifyBaseLogger\n > = (\n-  instance: FastifyInstance<Server, RawRequestDefaultExpression<Server>, RawReplyDefaultExpression<Server>, FastifyLoggerInstance, TypeProvider>,\n+  instance: FastifyInstance<Server, RawRequestDefaultExpression<Server>, RawReplyDefaultExpression<Server>, Logger, TypeProvider>,\n   opts: Options\n-) => Promise<void>;\n+) => Promise<void>\n \n /**\n  * Generic plugin type.\n- * @deprecated union type doesn't work well with type inference in TS and is therefore deprecated in favor of explicit types. See FastifyRegister.\n+ * @deprecated union type doesn't work well with type inference in TS and is therefore deprecated in favor of explicit types. Use `FastifyPluginCallback` or `FastifyPluginAsync` instead. To activate\n+ * plugins use `FastifyRegister`. https://fastify.dev/docs/latest/Reference/TypeScript/#register\n  */\n export type FastifyPlugin<Options extends FastifyPluginOptions = Record<never, never>> = FastifyPluginCallback<Options> | FastifyPluginAsync<Options>\n",
					"match": false,
					"packageHash": "adb305ca360926ffd8a3a10fe0174ce5b9c1496c683a431df185be01fb565472",
					"size": 1964,
					"sourceHash": "479a021fec9328c8ab37f9372dcdc1022d79aeedde6febf03942b4456d1591c9",
					"status": "content"
				},
				"types/register.d.ts": {
					"diff": "--- published/types/register.d.ts\n+++ rebuilt/types/register.d.ts\n@@ -2,7 +2,7 @@\n import { LogLevel } from './logger'\n import { FastifyInstance } from './instance'\n import { RawServerBase } from './utils'\n-import { FastifyTypeProvider, RawServerDefault } from '../fastify'\n+import { FastifyBaseLogger, FastifyTypeProvider, RawServerDefault } from '../fastify'\n \n export interface RegisterOptions {\n   prefix?: string;\n@@ -17,17 +17,26 @@\n  *\n  * Function for adding a plugin to fastify. The options are inferred from the passed in FastifyPlugin parameter.\n  */\n-export interface FastifyRegister<T = void, RawServer extends RawServerBase = RawServerDefault, TypeProviderDefault extends FastifyTypeProvider = FastifyTypeProvider> {\n-  <Options extends FastifyPluginOptions, Server extends RawServerBase = RawServer, TypeProvider extends FastifyTypeProvider = TypeProviderDefault>(\n-    plugin: FastifyPluginCallback<Options, Server, TypeProvider>,\n-    opts?: FastifyRegisterOptions<Options>\n-  ): T;\n-  <Options extends FastifyPluginOptions, Server extends RawServerBase = RawServer, TypeProvider extends FastifyTypeProvider = TypeProviderDefault>(\n-    plugin: FastifyPluginAsync<Options, Server, TypeProvider>,\n-    opts?: FastifyRegisterOptions<Options>\n-  ): T;\n-  <Options extends FastifyPluginOptions, Server extends RawServerBase = RawServer, TypeProvider extends FastifyTypeProvider = TypeProviderDefault>(\n-    plugin: FastifyPluginCallback<Options, Server, TypeProvider> | FastifyPluginAsync<Options, Server, TypeProvider> | Promise<{ default: FastifyPluginCallback<Options, Server, TypeProvider> }> | Promise<{ default: FastifyPluginAsync<Options, Server, TypeProvider> }>,\n-    opts?: FastifyRegisterOptions<Options>\n+export interface FastifyRegister<T = void, RawServer extends RawServerBase = RawServerDefault, TypeProviderDefault extends FastifyTypeProvider = FastifyTypeProvider, LoggerDefault extends FastifyBaseLogger = FastifyBaseLogger> {\n+  <Server extends RawServerBase = RawServer, TypeProvider extends FastifyTypeProvider = TypeProviderDefault, Logger extends FastifyBaseLogger = LoggerDefault>(\n+    plugin: FastifyPluginCallback<FastifyPluginOptions, Server, TypeProvider, Logger>\n+  ): T;\n+  <Options extends FastifyPluginOptions, Server extends RawServerBase = RawServer, TypeProvider extends FastifyTypeProvider = TypeProviderDefault, Logger extends FastifyBaseLogger = LoggerDefault>(\n+    plugin: FastifyPluginCallback<Options, Server, TypeProvider, Logger>,\n+    opts: FastifyRegisterOptions<Options>\n+  ): T;\n+  <Server extends RawServerBase = RawServer, TypeProvider extends FastifyTypeProvider = TypeProviderDefault, Logger extends FastifyBaseLogger = LoggerDefault>(\n+    plugin: FastifyPluginAsync<FastifyPluginOptions, Server, TypeProvider, Logger>\n+  ): T;\n+  <Options extends FastifyPluginOptions, Server extends RawServerBase = RawServer, TypeProvider extends FastifyTypeProvider = TypeProviderDefault, Logger extends FastifyBaseLogger = LoggerDefault>(\n+    plugin: FastifyPluginAsync<Options, Server, TypeProvider, Logger>,\n+    opts: FastifyRegisterOptions<Options>\n+  ): T;\n+  <Server extends RawServerBase = RawServer, TypeProvider extends FastifyTypeProvider = TypeProviderDefault, Logger extends FastifyBaseLogger = LoggerDefault>(\n+    plugin: FastifyPluginCallback<FastifyPluginOptions, Server, TypeProvider, Logger> | FastifyPluginAsync<FastifyPluginOptions, Server, TypeProvider, Logger> | Promise<{ default: FastifyPluginCallback<FastifyPluginOptions, Server, TypeProvider, Logger> }> | Promise<{ default: FastifyPluginAsync<FastifyPluginOptions, Server, TypeProvider, Logger> }>,\n+  ): T;\n+  <Options extends FastifyPluginOptions, Server extends RawServerBase = RawServer, TypeProvider extends FastifyTypeProvider = TypeProviderDefault, Logger extends FastifyBaseLogger = LoggerDefault>(\n+    plugin: FastifyPluginCallback<Options, Server, TypeProvider, Logger> | FastifyPluginAsync<Options, Server, TypeProvider, Logger> | Promise<{ default: FastifyPluginCallback<Options, Server, TypeProvider, Logger> }> | Promise<{ default: FastifyPluginAsync<Options, Server, TypeProvider, Logger> }>,\n+    opts: FastifyRegisterOptions<Options>\n   ): T;\n }\n",
					"match": false,
					"packageHash": "83c9e914593943182248d84886500fe0b3d2cbc5c75a6a96096c4ac5ae199bae",
					"size": 1863,
					"sourceHash": "68d25a0614893e256a9e6fe18e2b125dbdad694381b57e63320de6a7518e47fc",
					"status": "content"
				},
				"types/reply.d.ts": {
					"diff": "--- published/types/reply.d.ts\n+++ rebuilt/types/reply.d.ts\n@@ -1,64 +1,81 @@\n-import { RawReplyDefaultExpression, RawServerBase, RawServerDefault, ContextConfigDefault, RawRequestDefaultExpression, ReplyDefault } from './utils'\n-import { FastifyReplyType, ResolveFastifyReplyType, FastifyTypeProvider, FastifyTypeProviderDefault } from './type-provider'\n-import { FastifyContext } from './context'\n-import { FastifyLoggerInstance } from './logger'\n-import { FastifyRequest } from './request'\n-import { RouteGenericInterface } from './route'\n+import { Buffer } from 'node:buffer'\n import { FastifyInstance } from './instance'\n+import { FastifyBaseLogger } from './logger'\n+import { FastifyRequest, RequestRouteOptions } from './request'\n+import { RouteGenericInterface } from './route'\n import { FastifySchema } from './schema'\n-import { Buffer } from 'buffer'\n+import { CallSerializerTypeProvider, FastifyReplyType, FastifyTypeProvider, FastifyTypeProviderDefault, ResolveFastifyReplyType } from './type-provider'\n+import { CodeToReplyKey, ContextConfigDefault, HttpHeader, HttpKeys, RawReplyDefaultExpression, RawRequestDefaultExpression, RawServerBase, RawServerDefault, ReplyDefault, ReplyKeysToCodes } from './utils'\n \n export interface ReplyGenericInterface {\n   Reply?: ReplyDefault;\n }\n \n+type HttpCodesReplyType = Partial<Record<HttpKeys, unknown>>\n+\n+type ReplyTypeConstrainer<RouteGenericReply, Code extends ReplyKeysToCodes<keyof RouteGenericReply>> =\n+  RouteGenericReply extends HttpCodesReplyType & Record<Exclude<keyof RouteGenericReply, keyof HttpCodesReplyType>, never> ?\n+    Code extends keyof RouteGenericReply ? RouteGenericReply[Code] :\n+      CodeToReplyKey<Code> extends keyof RouteGenericReply ? RouteGenericReply[CodeToReplyKey<Code>] : unknown :\n+    RouteGenericReply\n+\n+export type ResolveReplyTypeWithRouteGeneric<RouteGenericReply, Code extends ReplyKeysToCodes<keyof RouteGenericReply>,\n+  SchemaCompiler extends FastifySchema = FastifySchema,\n+  TypeProvider extends FastifyTypeProvider = FastifyTypeProviderDefault> =\n+  Code extends keyof SchemaCompiler['response'] ?\n+    CallSerializerTypeProvider<TypeProvider, SchemaCompiler['response'][Code]> :\n+    ResolveFastifyReplyType<TypeProvider, SchemaCompiler, { Reply: ReplyTypeConstrainer<RouteGenericReply, Code> }>\n /**\n  * FastifyReply is an instance of the standard http or http2 reply types.\n  * It defaults to http.ServerResponse, and it also extends the relative reply object.\n  */\n export interface FastifyReply<\n+  RouteGeneric extends RouteGenericInterface = RouteGenericInterface,\n   RawServer extends RawServerBase = RawServerDefault,\n   RawRequest extends RawRequestDefaultExpression<RawServer> = RawRequestDefaultExpression<RawServer>,\n   RawReply extends RawReplyDefaultExpression<RawServer> = RawReplyDefaultExpression<RawServer>,\n-  RouteGeneric extends RouteGenericInterface = RouteGenericInterface,\n   ContextConfig = ContextConfigDefault,\n   SchemaCompiler extends FastifySchema = FastifySchema,\n   TypeProvider extends FastifyTypeProvider = FastifyTypeProviderDefault,\n   ReplyType extends FastifyReplyType = ResolveFastifyReplyType<TypeProvider, SchemaCompiler, RouteGeneric>\n > {\n+  readonly routeOptions: Readonly<RequestRouteOptions<ContextConfig, SchemaCompiler>>\n+\n   raw: RawReply;\n-  context: FastifyContext<ContextConfig>;\n-  log: FastifyLoggerInstance;\n+  elapsedTime: number;\n+  log: FastifyBaseLogger;\n   request: FastifyRequest<RouteGeneric, RawServer, RawRequest, SchemaCompiler, TypeProvider>;\n   server: FastifyInstance;\n-  code(statusCode: number): FastifyReply<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider>;\n-  status(statusCode: number): FastifyReply<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider>;\n+  code<Code extends keyof SchemaCompiler['response'] extends never ? ReplyKeysToCodes<keyof RouteGeneric['Reply']> : keyof SchemaCompiler['response'] extends ReplyKeysToCodes<keyof RouteGeneric['Reply']> ? keyof SchemaCompiler['response'] : ReplyKeysToCodes<keyof RouteGeneric['Reply']>>(statusCode: Code): FastifyReply<RouteGeneric, RawServer, RawRequest, RawReply, ContextConfig, SchemaCompiler, TypeProvider, ResolveReplyTypeWithRouteGeneric<RouteGeneric['Reply'], Code, SchemaCompiler, TypeProvider>>;\n+  status<Code extends keyof SchemaCompiler['response'] extends never ? ReplyKeysToCodes<keyof RouteGeneric['Reply']> : keyof SchemaCompiler['response'] extends ReplyKeysToCodes<keyof RouteGeneric['Reply']> ? keyof SchemaCompiler['response'] : ReplyKeysToCodes<keyof RouteGeneric['Reply']>>(statusCode: Code): FastifyReply<RouteGeneric, RawServer, RawRequest, RawReply, ContextConfig, SchemaCompiler, TypeProvider, ResolveReplyTypeWithRouteGeneric<RouteGeneric['Reply'], Code, SchemaCompiler, TypeProvider>>;\n   statusCode: number;\n   sent: boolean;\n-  send(payload?: ReplyType): FastifyReply<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider>;\n-  header(key: string, value: any): FastifyReply<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider>;\n-  headers(values: {[key: string]: any}): FastifyReply<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider>;\n-  getHeader(key: string): number | string | string[] | undefined;\n-  getHeaders(): {\n-    // Node's `getHeaders()` can return numbers and arrays, so they're included here as possible types.\n-    [key: string]: number | string | string[] | undefined;\n-  };\n-  removeHeader(key: string): void;\n-  hasHeader(key: string): boolean;\n-  // Note: should consider refactoring the argument order for redirect. statusCode is optional so it should be after the required url param\n-  redirect(statusCode: number, url: string): FastifyReply<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider>;\n-  redirect(url: string): FastifyReply<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider>;\n-  hijack(): FastifyReply<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider>;\n+  send(payload?: ReplyType): FastifyReply<RouteGeneric, RawServer, RawRequest, RawReply, ContextConfig, SchemaCompiler, TypeProvider>;\n+  header(key: HttpHeader, value: any): FastifyReply<RouteGeneric, RawServer, RawRequest, RawReply, ContextConfig, SchemaCompiler, TypeProvider>;\n+  headers(values: Partial<Record<HttpHeader, number | string | string[] | undefined>>): FastifyReply<RouteGeneric, RawServer, RawRequest, RawReply, ContextConfig, SchemaCompiler, TypeProvider>;\n+  getHeader(key: HttpHeader): number | string | string[] | undefined;\n+  getHeaders(): Record<HttpHeader, number | string | string[] | undefined>;\n+  removeHeader(key: HttpHeader): FastifyReply<RouteGeneric, RawServer, RawRequest, RawReply, ContextConfig, SchemaCompiler, TypeProvider>;\n+  hasHeader(key: HttpHeader): boolean;\n+  redirect(url: string, statusCode?: number): FastifyReply<RouteGeneric, RawServer, RawRequest, RawReply, ContextConfig, SchemaCompiler, TypeProvider>;\n+  writeEarlyHints(hints: Record<string, string | string[]>, callback?: () => void): void;\n+  hijack(): FastifyReply<RouteGeneric, RawServer, RawRequest, RawReply, ContextConfig, SchemaCompiler, TypeProvider>;\n   callNotFound(): void;\n-  getResponseTime(): number;\n-  type(contentType: string): FastifyReply<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider>;\n-  serializer(fn: (payload: any) => string): FastifyReply<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider>;\n+  type(contentType: string): FastifyReply<RouteGeneric, RawServer, RawRequest, RawReply, ContextConfig, SchemaCompiler, TypeProvider>;\n+  serializer(fn: (payload: any) => string): FastifyReply<RouteGeneric, RawServer, RawRequest, RawReply, ContextConfig, SchemaCompiler, TypeProvider>;\n   serialize(payload: any): string | ArrayBuffer | Buffer;\n   // Serialization Methods\n-  getSerializationFunction(httpStatus: string): (payload: {[key: string]: unknown}) => string;\n",
					"match": false,
					"packageHash": "092d91b6700f4494e70459d2f7093f1da1fe8ec7caff923fffb2be51659e59ce",
					"size": 4274,
					"sourceHash": "ebb61d3b2a389d2b873efd41fbd5853fbfabd4941ee1674ca39349595bc2b590",
					"status": "content"
				},
				"types/request.d.ts": {
					"diff": "--- published/types/request.d.ts\n+++ rebuilt/types/request.d.ts\n@@ -1,10 +1,11 @@\n-import { FastifyLoggerInstance } from './logger'\n-import { ContextConfigDefault, RawServerBase, RawServerDefault, RawRequestDefaultExpression, RequestBodyDefault, RequestQuerystringDefault, RequestParamsDefault, RequestHeadersDefault } from './utils'\n-import { RouteGenericInterface } from './route'\n+import { ErrorObject } from '@fastify/ajv-compiler'\n+import { FastifyContextConfig } from './context'\n import { FastifyInstance } from './instance'\n-import { FastifyTypeProvider, FastifyTypeProviderDefault, FastifyRequestType, ResolveFastifyRequestType } from './type-provider'\n+import { FastifyBaseLogger } from './logger'\n+import { FastifyRouteConfig, RouteGenericInterface, RouteHandlerMethod } from './route'\n import { FastifySchema } from './schema'\n-import { FastifyContext } from './context'\n+import { FastifyRequestType, FastifyTypeProvider, FastifyTypeProviderDefault, ResolveFastifyRequestType } from './type-provider'\n+import { ContextConfigDefault, HTTPMethods, RawRequestDefaultExpression, RawServerBase, RawServerDefault, RequestBodyDefault, RequestHeadersDefault, RequestParamsDefault, RequestQuerystringDefault } from './utils'\n \n type HTTPRequestPart = 'body' | 'query' | 'querystring' | 'params' | 'headers'\n export interface RequestGenericInterface {\n@@ -14,6 +15,26 @@\n   Headers?: RequestHeadersDefault;\n }\n \n+export interface ValidationFunction {\n+  (input: any): boolean\n+  errors?: null | ErrorObject[];\n+}\n+\n+export interface RequestRouteOptions<ContextConfig = ContextConfigDefault, SchemaCompiler = FastifySchema> {\n+  method: HTTPMethods | HTTPMethods[];\n+  // `url` can be `undefined` for instance when `request.is404` is true\n+  url: string | undefined;\n+  bodyLimit: number;\n+  attachValidation: boolean;\n+  logLevel: string;\n+  exposeHeadRoute: boolean;\n+  prefixTrailingSlash: string;\n+  config: FastifyContextConfig & FastifyRouteConfig & ContextConfig;\n+  schema?: SchemaCompiler; // it is empty for 404 requests\n+  handler: RouteHandlerMethod;\n+  version?: string;\n+}\n+\n /**\n  * FastifyRequest is an instance of the standard http or http2 request objects.\n  * It defaults to http.IncomingMessage, and it also extends the relative request object.\n@@ -24,16 +45,16 @@\n   SchemaCompiler extends FastifySchema = FastifySchema,\n   TypeProvider extends FastifyTypeProvider = FastifyTypeProviderDefault,\n   ContextConfig = ContextConfigDefault,\n-  Logger extends FastifyLoggerInstance = FastifyLoggerInstance,\n+  Logger extends FastifyBaseLogger = FastifyBaseLogger,\n   RequestType extends FastifyRequestType = ResolveFastifyRequestType<TypeProvider, SchemaCompiler, RouteGeneric>\n-  // ^ Temporary Note: RequestType has been re-ordered to be the last argument in\n-  //   generic list. This generic argument is now considered optional as it can be\n-  //   automatically inferred from the SchemaCompiler, RouteGeneric and TypeProvider\n-  //   arguments. Implementations that already pass this argument can either omit\n-  //   the RequestType (preferred) or swap Logger and RequestType arguments when\n-  //   creating custom types of FastifyRequest. Related issue #4123\n+// ^ Temporary Note: RequestType has been re-ordered to be the last argument in\n+//   generic list. This generic argument is now considered optional as it can be\n+//   automatically inferred from the SchemaCompiler, RouteGeneric and TypeProvider\n+//   arguments. Implementations that already pass this argument can either omit\n+//   the RequestType (preferred) or swap Logger and RequestType arguments when\n+//   creating custom types of FastifyRequest. Related issue #4123\n > {\n-  id: any;\n+  id: string;\n   params: RequestType['params']; // deferred inference\n   raw: RawRequest;\n   query: RequestType['query'];\n@@ -41,7 +62,6 @@\n   log: Logger;\n   server: FastifyInstance;\n   body: RequestType['body'];\n-  context: FastifyContext<ContextConfig>;\n \n   /** in order for this to be used the user should ensure they have set the attachValidation option. */\n   validationError?: Error & { validation: any; validationContext: string };\n@@ -52,22 +72,22 @@\n   readonly req: RawRequest & RouteGeneric['Headers']; // this enables the developer to extend the existing http(s|2) headers list\n   readonly ip: string;\n   readonly ips?: string[];\n+  readonly host: string;\n+  readonly port: number;\n   readonly hostname: string;\n   readonly url: string;\n+  readonly originalUrl: string;\n   readonly protocol: 'http' | 'https';\n   readonly method: string;\n-  readonly routerPath: string;\n-  readonly routerMethod: string;\n+  readonly routeOptions: Readonly<RequestRouteOptions<ContextConfig, SchemaCompiler>>\n   readonly is404: boolean;\n   readonly socket: RawRequest['socket'];\n \n-  getValidationFunction(httpPart: HTTPRequestPart): (input: any) => boolean\n-  getValidationFunction(schema: {[key: string]: any}): (input: any) => boolean\n-  compileValidationSchema(schema: {[key: string]: any}, httpPart?: HTTPRequestPart): (input: any) => boolean\n-  validateInput(input: any, schema: {[key: string]: any}, httpPart?: HTTPRequestPart): boolean\n",
					"match": false,
					"packageHash": "ad4dff09eca378fc409363778efb98e35d4b32b24cae97db4b85ff9bad3efb98",
					"size": 3685,
					"sourceHash": "0721d2a27bcb10c815a0df1ab95a54e3a765ffe4b8d0794a47ee85d0e4dd9f29",
					"status": "content"
				},
				"types/route.d.ts": {
					"diff": "--- published/types/route.d.ts\n+++ rebuilt/types/route.d.ts\n@@ -1,19 +1,35 @@\n+import { FastifyError } from '@fastify/error'\n+import { ConstraintStrategy } from 'find-my-way'\n+import { FastifyContextConfig } from './context'\n+import { onErrorMetaHookHandler, onRequestAbortMetaHookHandler, onRequestMetaHookHandler, onResponseMetaHookHandler, onSendMetaHookHandler, onTimeoutMetaHookHandler, preHandlerMetaHookHandler, preParsingMetaHookHandler, preSerializationMetaHookHandler, preValidationMetaHookHandler } from './hooks'\n import { FastifyInstance } from './instance'\n-import { FastifyRequest, RequestGenericInterface } from './request'\n+import { FastifyBaseLogger, FastifyChildLoggerFactory, LogLevel } from './logger'\n import { FastifyReply, ReplyGenericInterface } from './reply'\n-import { FastifySchema, FastifySchemaCompiler, FastifySchemaValidationError, FastifySerializerCompiler } from './schema'\n-import { HTTPMethods, RawServerBase, RawServerDefault, RawRequestDefaultExpression, RawReplyDefaultExpression, ContextConfigDefault } from './utils'\n-import { preValidationHookHandler, preHandlerHookHandler, preSerializationHookHandler, onRequestHookHandler, preParsingHookHandler, onResponseHookHandler, onSendHookHandler, onErrorHookHandler, onTimeoutHookHandler } from './hooks'\n-import { FastifyError } from '@fastify/error'\n-import { FastifyContext } from './context'\n+import { FastifyRequest, RequestGenericInterface } from './request'\n+import { FastifySchema, FastifySchemaCompiler, FastifySerializerCompiler, SchemaErrorFormatter } from './schema'\n import {\n   FastifyTypeProvider,\n   FastifyTypeProviderDefault,\n   ResolveFastifyReplyReturnType\n } from './type-provider'\n-import { FastifyLoggerInstance, LogLevel } from './logger'\n+import { ContextConfigDefault, HTTPMethods, RawReplyDefaultExpression, RawRequestDefaultExpression, RawServerBase, RawServerDefault } from './utils'\n \n-export interface RouteGenericInterface extends RequestGenericInterface, ReplyGenericInterface {}\n+export interface FastifyRouteConfig {\n+  url: string;\n+  method: HTTPMethods | HTTPMethods[];\n+}\n+\n+export interface RouteGenericInterface extends RequestGenericInterface, ReplyGenericInterface { }\n+\n+export type RouteConstraintType = Omit<ConstraintStrategy<any>, 'deriveConstraint'> & {\n+  deriveConstraint<Context>(req: RawRequestDefaultExpression<RawServerDefault>, ctx?: Context, done?: (err: Error, ...args: any) => any): any,\n+}\n+\n+export interface RouteConstraint {\n+  version?: string\n+  host?: RegExp | string\n+  [name: string]: unknown\n+}\n \n /**\n  * Route shorthand options for the various shorthand methods\n@@ -24,38 +40,52 @@\n   RawReply extends RawReplyDefaultExpression<RawServer> = RawReplyDefaultExpression<RawServer>,\n   RouteGeneric extends RouteGenericInterface = RouteGenericInterface,\n   ContextConfig = ContextConfigDefault,\n-  SchemaCompiler = FastifySchema,\n+  SchemaCompiler extends FastifySchema = FastifySchema,\n   TypeProvider extends FastifyTypeProvider = FastifyTypeProviderDefault,\n-  Logger extends FastifyLoggerInstance = FastifyLoggerInstance\n+  Logger extends FastifyBaseLogger = FastifyBaseLogger\n > {\n   schema?: SchemaCompiler, // originally FastifySchema\n   attachValidation?: boolean;\n   exposeHeadRoute?: boolean;\n \n-  validatorCompiler?: FastifySchemaCompiler<SchemaCompiler>;\n-  serializerCompiler?: FastifySerializerCompiler<SchemaCompiler>;\n+  validatorCompiler?: FastifySchemaCompiler<NoInfer<SchemaCompiler>>;\n+  serializerCompiler?: FastifySerializerCompiler<NoInfer<SchemaCompiler>>;\n   bodyLimit?: number;\n   logLevel?: LogLevel;\n-  config?: FastifyContext<ContextConfig>['config'];\n-  version?: string;\n-  constraints?: { [name: string]: any },\n-  prefixTrailingSlash?: 'slash'|'no-slash'|'both';\n-  errorHandler?: (this: FastifyInstance, error: FastifyError, request: FastifyRequest, reply: FastifyReply) => void;\n-  // TODO: Change to actual type.\n-  schemaErrorFormatter?: (errors: FastifySchemaValidationError[], dataVar: string) => Error;\n+  config?: FastifyContextConfig & ContextConfig;\n+  constraints?: RouteConstraint,\n+  prefixTrailingSlash?: 'slash' | 'no-slash' | 'both';\n+  errorHandler?: (\n+    this: FastifyInstance<RawServer, RawRequest, RawReply, Logger, TypeProvider>,\n+    error: FastifyError,\n+    request: FastifyRequest<RouteGeneric, RawServer, RawRequest, NoInfer<SchemaCompiler>, TypeProvider, ContextConfig, Logger>,\n+    reply: FastifyReply<RouteGeneric, RawServer, RawRequest, RawReply, ContextConfig, NoInfer<SchemaCompiler>, TypeProvider>\n+  ) => void;\n+  childLoggerFactory?: FastifyChildLoggerFactory<RawServer, RawRequest, RawReply, Logger, TypeProvider>;\n+  schemaErrorFormatter?: SchemaErrorFormatter;\n \n   // hooks\n-  onRequest?: onRequestHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger> | onRequestHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger>[];\n-  preParsing?: preParsingHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger> | preParsingHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger>[];\n-  preValidation?: preValidationHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger> | preValidationHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger>[];\n-  preHandler?: preHandlerHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger> | preHandlerHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger>[];\n-  preSerialization?: preSerializationHookHandler<unknown, RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger> | preSerializationHookHandler<unknown, RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger>[];\n-  onSend?: onSendHookHandler<unknown, RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger> | onSendHookHandler<unknown, RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger>[];\n-  onResponse?: onResponseHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger> | onResponseHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger>[];\n-  onTimeout?: onTimeoutHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger> | onTimeoutHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, SchemaCompiler, TypeProvider, Logger>[];\n-  onError?: onErrorHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, FastifyError, SchemaCompiler, TypeProvider, Logger> | onErrorHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, FastifyError, SchemaCompiler, TypeProvider, Logger>[];\n+  onRequest?: onRequestMetaHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, NoInfer<SchemaCompiler>, TypeProvider, Logger>\n+  | onRequestMetaHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, NoInfer<SchemaCompiler>, TypeProvider, Logger>[];\n+  preParsing?: preParsingMetaHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, NoInfer<SchemaCompiler>, TypeProvider, Logger>\n+  | preParsingMetaHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, NoInfer<SchemaCompiler>, TypeProvider, Logger>[];\n+  preValidation?: preValidationMetaHookHandler<RawServer, RawRequest, RawReply, RouteGeneric, ContextConfig, NoInfer<SchemaCompiler>, TypeProvider, Logger>\n",
					"match": false,
					"packageHash": "9383e227cba8f3b63cb64fa4ccefc7a141aa4c855d1aec78cfa7c1cc3c627743",
					"size": 10810,
					"sourceHash": "af7cfe3f859bd980d09f008b41bff896fcfb77473f53a162438fae49c6a3baa6",
					"status": "content"
				},
				"types/schema.d.ts": {
					"diff": "--- published/types/schema.d.ts\n+++ rebuilt/types/schema.d.ts\n@@ -1,5 +1,6 @@\n-import { ValidatorCompiler } from '@fastify/ajv-compiler'\n-import { FastifyInstance, FastifyServerOptions } from '../fastify'\n+import { ValidatorFactory } from '@fastify/ajv-compiler'\n+import { SerializerFactory } from '@fastify/fast-json-stringify-compiler'\n+import { FastifyInstance, SafePromiseLike } from '../fastify'\n /**\n  * Schemas in Fastify follow the JSON-Schema standard. For this reason\n  * we have opted to not ship strict schema based types. Instead we provide\n@@ -20,18 +21,19 @@\n   url: string;\n   httpPart?: string;\n   httpStatus?: string;\n+  contentType?: string;\n }\n \n export interface FastifySchemaValidationError {\n   keyword: string;\n   instancePath: string;\n   schemaPath: string;\n-  params: Record<string, string | string[]>;\n+  params: Record<string, unknown>;\n   message?: string;\n }\n \n export interface FastifyValidationResult {\n-  (data: any): boolean | PromiseLike<any> | { error?: Error, value?: any }\n+  (data: any): boolean | SafePromiseLike<any> | { error?: Error | FastifySchemaValidationError[], value?: any }\n   errors?: FastifySchemaValidationError[] | null;\n }\n \n@@ -42,14 +44,18 @@\n \n export type FastifySerializerCompiler<T> = (routeSchema: FastifyRouteSchemaDef<T>) => (data: any) => string\n \n-export interface FastifySchemaControllerOptions{\n+export interface FastifySchemaControllerOptions {\n   bucket?: (parentSchemas?: unknown) => {\n     add(schema: unknown): FastifyInstance;\n     getSchema(schemaId: string): unknown;\n     getSchemas(): Record<string, unknown>;\n   };\n   compilersFactory?: {\n-    buildValidator?: ValidatorCompiler;\n-    buildSerializer?: (externalSchemas: unknown, serializerOptsServerOption: FastifyServerOptions['serializerOpts']) => FastifySerializerCompiler<unknown>;\n+    buildValidator?: ValidatorFactory;\n+    buildSerializer?: SerializerFactory;\n   };\n }\n+\n+export type SchemaErrorDataVar = 'body' | 'headers' | 'params' | 'querystring'\n+\n+export type SchemaErrorFormatter = (errors: FastifySchemaValidationError[], dataVar: SchemaErrorDataVar) => Error\n",
					"match": false,
					"packageHash": "d55204968ee913308bf5e469ef57f59ab0aa71d1e631aff154d753995d8194e0",
					"size": 1792,
					"sourceHash": "c3ccf44723b474b5d7a87c53eed9711e81422f0e29b3e8f8f8d42775fa802243",
					"status": "content"
				},
				"types/serverFactory.d.ts": {
					"match": false,
					"packageHash": "7247fd1853426de8fdc38a7027b488498bb00ea62c9a99037a760520e3944a26",
					"size": 949,
					"status": "missing-in-source"
				},
				"types/tsconfig.json": {
					"match": false,
					"packageHash": "f2a316296d19718e8a32c2902c895cde94f5e087f1c666dbb2e3d3d66e4ebc90",
					"size": 213,
					"status": "missing-in-source"
				},
				"types/type-provider.d.ts": {
					"diff": "--- published/types/type-provider.d.ts\n+++ rebuilt/types/type-provider.d.ts\n@@ -1,20 +1,21 @@\n-\n import { RouteGenericInterface } from './route'\n import { FastifySchema } from './schema'\n+import { HttpKeys, RecordKeysToLowercase } from './utils'\n \n // -----------------------------------------------------------------------------------------------\n // TypeProvider\n // -----------------------------------------------------------------------------------------------\n \n export interface FastifyTypeProvider {\n-  readonly input: unknown,\n-  readonly output: unknown,\n+  readonly schema: unknown,\n+  readonly validator: unknown,\n+  readonly serializer: unknown,\n }\n \n-// eslint-disable-next-line @typescript-eslint/no-empty-interface\n export interface FastifyTypeProviderDefault extends FastifyTypeProvider {}\n \n-export type CallTypeProvider<F extends FastifyTypeProvider, I> = (F & { input: I })['output']\n+export type CallValidatorTypeProvider<F extends FastifyTypeProvider, S> = (F & { schema: S })['validator']\n+export type CallSerializerTypeProvider<F extends FastifyTypeProvider, S> = (F & { schema: S })['serializer']\n \n // -----------------------------------------------------------------------------------------------\n // FastifyRequestType\n@@ -32,13 +33,13 @@\n \n // Resolves Request types either from generic argument or Type Provider.\n type ResolveRequestParams<TypeProvider extends FastifyTypeProvider, SchemaCompiler extends FastifySchema, RouteGeneric extends RouteGenericInterface> =\n-  UndefinedToUnknown<KeysOf<RouteGeneric['Params']> extends never ? CallTypeProvider<TypeProvider, SchemaCompiler['params']> : RouteGeneric['Params']>\n+  UndefinedToUnknown<KeysOf<RouteGeneric['Params']> extends never ? CallValidatorTypeProvider<TypeProvider, SchemaCompiler['params']> : RouteGeneric['Params']>\n type ResolveRequestQuerystring<TypeProvider extends FastifyTypeProvider, SchemaCompiler extends FastifySchema, RouteGeneric extends RouteGenericInterface> =\n-  UndefinedToUnknown<KeysOf<RouteGeneric['Querystring']> extends never ? CallTypeProvider<TypeProvider, SchemaCompiler['querystring']> : RouteGeneric['Querystring']>\n+  UndefinedToUnknown<KeysOf<RouteGeneric['Querystring']> extends never ? CallValidatorTypeProvider<TypeProvider, SchemaCompiler['querystring']> : RouteGeneric['Querystring']>\n type ResolveRequestHeaders<TypeProvider extends FastifyTypeProvider, SchemaCompiler extends FastifySchema, RouteGeneric extends RouteGenericInterface> =\n-  UndefinedToUnknown<KeysOf<RouteGeneric['Headers']> extends never ? CallTypeProvider<TypeProvider, SchemaCompiler['headers']> : RouteGeneric['Headers']>\n+  UndefinedToUnknown<KeysOf<RouteGeneric['Headers']> extends never ? CallValidatorTypeProvider<TypeProvider, SchemaCompiler['headers']> : RouteGeneric['Headers']>\n type ResolveRequestBody<TypeProvider extends FastifyTypeProvider, SchemaCompiler extends FastifySchema, RouteGeneric extends RouteGenericInterface> =\n-  UndefinedToUnknown<KeysOf<RouteGeneric['Body']> extends never ? CallTypeProvider<TypeProvider, SchemaCompiler['body']> : RouteGeneric['Body']>\n+  UndefinedToUnknown<KeysOf<RouteGeneric['Body']> extends never ? CallValidatorTypeProvider<TypeProvider, SchemaCompiler['body']> : RouteGeneric['Body']>\n \n // The target request type. This type is inferenced on fastify 'requests' via generic argument assignment\n export interface FastifyRequestType<Params = unknown, Querystring = unknown, Headers = unknown, Body = unknown> {\n@@ -52,7 +53,7 @@\n export interface ResolveFastifyRequestType<TypeProvider extends FastifyTypeProvider, SchemaCompiler extends FastifySchema, RouteGeneric extends RouteGenericInterface> extends FastifyRequestType {\n   params: ResolveRequestParams<TypeProvider, SchemaCompiler, RouteGeneric>,\n   query: ResolveRequestQuerystring<TypeProvider, SchemaCompiler, RouteGeneric>,\n-  headers: ResolveRequestHeaders<TypeProvider, SchemaCompiler, RouteGeneric>,\n+  headers: RecordKeysToLowercase<ResolveRequestHeaders<TypeProvider, SchemaCompiler, RouteGeneric>>,\n   body: ResolveRequestBody<TypeProvider, SchemaCompiler, RouteGeneric>\n }\n \n@@ -60,9 +61,11 @@\n // FastifyReplyType\n // -----------------------------------------------------------------------------------------------\n \n-// Resolves the Reply type by taking a union of response status codes\n+// Resolves the Reply type by taking a union of response status codes and content-types\n type ResolveReplyFromSchemaCompiler<TypeProvider extends FastifyTypeProvider, SchemaCompiler extends FastifySchema> = {\n-  [K in keyof SchemaCompiler['response']]: CallTypeProvider<TypeProvider, SchemaCompiler['response'][K]>\n+  [K1 in keyof SchemaCompiler['response']]: SchemaCompiler['response'][K1] extends { content: { [keyof: string]: { schema: unknown } } } ? ({\n+    [K2 in keyof SchemaCompiler['response'][K1]['content']]: CallSerializerTypeProvider<TypeProvider, SchemaCompiler['response'][K1]['content'][K2]['schema']>\n+  } extends infer Result ? Result[keyof Result] : unknown) : CallSerializerTypeProvider<TypeProvider, SchemaCompiler['response'][K1]>\n } extends infer Result ? Result[keyof Result] : unknown\n \n // The target reply type. This type is inferenced on fastify 'replies' via generic argument assignment\n@@ -70,24 +73,42 @@\n \n // Resolves the Reply type either via generic argument or from response schema. This type uses a different\n // resolution strategy to Requests where the Reply will infer a union of each status code type specified\n-// by the user. The Reply can be explicitly overriden by users providing a generic Reply type on the route.\n+// by the user. The Reply can be explicitly overridden by users providing a generic Reply type on the route.\n export type ResolveFastifyReplyType<TypeProvider extends FastifyTypeProvider, SchemaCompiler extends FastifySchema, RouteGeneric extends RouteGenericInterface> = UndefinedToUnknown<KeysOf<RouteGeneric['Reply']> extends never ? ResolveReplyFromSchemaCompiler<TypeProvider, SchemaCompiler> : RouteGeneric['Reply']>\n \n // -----------------------------------------------------------------------------------------------\n // FastifyReplyReturnType\n // -----------------------------------------------------------------------------------------------\n \n+// Resolves the Reply return type by taking a union of response status codes in the generic argument\n+type ResolveReplyReturnTypeFromRouteGeneric<RouteGeneric extends RouteGenericInterface> = RouteGeneric extends { Reply: infer Return }\n+  ? keyof Return extends HttpKeys ? Return[keyof Return] | Return : Return\n+  : unknown\n+\n // The target reply return type. This type is inferenced on fastify 'routes' via generic argument assignment\n export type ResolveFastifyReplyReturnType<\n   TypeProvider extends FastifyTypeProvider,\n   SchemaCompiler extends FastifySchema,\n-  RouteGeneric extends RouteGenericInterface,\n+  RouteGeneric extends RouteGenericInterface\n > = ResolveFastifyReplyType<\n TypeProvider,\n SchemaCompiler,\n RouteGeneric\n-> extends infer Return ?\n-  (Return | void | Promise<Return | void>)\n+> extends infer ReplyType\n",
					"match": false,
					"packageHash": "9ccf9495ad53145eac48547478c850c6900a275d9d77669073034fc4491257d3",
					"size": 5597,
					"sourceHash": "2887d3051b18f3e282cd043f9a180bd76bb7af85d1607d02020703094d86be05",
					"status": "content"
				},
				"types/utils.d.ts": {
					"diff": "--- published/types/utils.d.ts\n+++ rebuilt/types/utils.d.ts\n@@ -1,12 +1,23 @@\n-import * as http from 'http'\n-import * as http2 from 'http2'\n-import * as https from 'https'\n+import * as http from 'node:http'\n+import * as http2 from 'node:http2'\n+import * as https from 'node:https'\n+\n+type AutocompletePrimitiveBaseType<T> =\n+  T extends string ? string :\n+    T extends number ? number :\n+      T extends boolean ? boolean :\n+        never\n+\n+export type Autocomplete<T> = T | (AutocompletePrimitiveBaseType<T> & Record<never, never>)\n \n /**\n  * Standard HTTP method strings\n+ * for internal use\n  */\n-export type HTTPMethods = 'DELETE' | 'GET' | 'HEAD' | 'PATCH' | 'POST' | 'PUT' | 'OPTIONS' |\n-'PROPFIND' | 'PROPPATCH' | 'MKCOL' | 'COPY' | 'MOVE' | 'LOCK' | 'UNLOCK' | 'TRACE' | 'SEARCH'\n+type _HTTPMethods = 'DELETE' | 'GET' | 'HEAD' | 'PATCH' | 'POST' | 'PUT' | 'OPTIONS' |\n+'PROPFIND' | 'PROPPATCH' | 'MKCOL' | 'COPY' | 'MOVE' | 'LOCK' | 'UNLOCK' | 'TRACE' | 'SEARCH' | 'REPORT' | 'MKCALENDAR'\n+\n+export type HTTPMethods = Autocomplete<_HTTPMethods | Lowercase<_HTTPMethods>>\n \n /**\n  * A union type of the Node.js server types from the http, https, and http2 modules.\n@@ -22,7 +33,7 @@\n  * The default request type based on the server type. Utilizes generic constraining.\n  */\n export type RawRequestDefaultExpression<\n-  RawServer extends RawServerBase = RawServerDefault,\n+  RawServer extends RawServerBase = RawServerDefault\n > = RawServer extends http.Server | https.Server ? http.IncomingMessage\n   : RawServer extends http2.Http2Server | http2.Http2SecureServer ? http2.Http2ServerRequest\n     : never\n@@ -43,3 +54,45 @@\n \n export type ContextConfigDefault = unknown\n export type ReplyDefault = unknown\n+\n+/**\n+ * Helpers for determining the type of the response payload based on the code\n+ */\n+\n+type StringAsNumber<T extends string> = T extends `${infer N extends number}` ? N : never\n+type CodeClasses = 1 | 2 | 3 | 4 | 5\n+type Digit = 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9\n+type HttpCodes = StringAsNumber<`${CodeClasses}${Digit}${Digit}`>\n+type HttpKeys = HttpCodes | `${Digit}xx`\n+export type StatusCodeReply = {\n+  [Key in HttpKeys]?: unknown;\n+}\n+\n+// weird TS quirk: https://stackoverflow.com/questions/58977876/generic-conditional-type-resolves-to-never-when-the-generic-type-is-set-to-never\n+export type ReplyKeysToCodes<Key> = [Key] extends [never] ? number :\n+  Key extends HttpCodes ? Key :\n+    Key extends `${infer X extends CodeClasses}xx` ?\n+      StringAsNumber<`${X}${Digit}${Digit}`> : number\n+\n+export type CodeToReplyKey<Code extends number> = `${Code}` extends `${infer FirstDigit extends CodeClasses}${number}`\n+  ? `${FirstDigit}xx`\n+  : never\n+\n+export type RecordKeysToLowercase<Input> = Input extends Record<string, unknown>\n+  ? {\n+      [Key in keyof Input as Key extends string\n+        ? Lowercase<Key>\n+        : Key\n+      ]: Input[Key];\n+    }\n+  : Input\n+\n+type OmitIndexSignature<T> = {\n+  [K in keyof T as string extends K ? never : number extends K ? never : K]: T[K];\n+}\n+\n+/**\n+ * HTTP header strings\n+ * Use this type only for input values, not for output values.\n+ */\n+export type HttpHeader = keyof OmitIndexSignature<http.OutgoingHttpHeaders> | (string & Record<never, never>)\n",
					"match": false,
					"packageHash": "c0c0a10022dc341b6a777c9f4372a1f030537109a5a7f39f9a720d0435de7b8e",
					"size": 1576,
					"sourceHash": "37d852b3e6b30b974178674dbf2a7974a1ea4bbdbec26d0bdb8f34632cab94a2",
					"status": "content"
				},
				".borp.yaml": {
					"match": false,
					"status": "missing-in-package"
				},
				"SPONSORS.md": {
					"match": false,
					"status": "missing-in-package"
				},
				"docs/Guides/Detecting-When-Clients-Abort.md": {
					"match": false,
					"status": "missing-in-package"
				},
				"docs/Guides/Migration-Guide-V5.md": {
					"match": false,
					"status": "missing-in-package"
				},
				"docs/Guides/Write-Type-Provider.md": {
					"match": false,
					"status": "missing-in-package"
				},
				"docs/Reference/Principles.md": {
					"match": false,
					"status": "missing-in-package"
				},
				"docs/Reference/Warnings.md": {
					"match": false,
					"status": "missing-in-package"
				},
				"eslint.config.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"examples/benchmark/body.json": {
					"match": false,
					"status": "missing-in-package"
				},
				"examples/benchmark/parser.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/config-validator.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/content-type-parser.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/error-status.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/four-oh-four.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/handle-request.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/head-route.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/initial-config-validation.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/logger-factory.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/logger-pino.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/plugin-override.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/plugin-utils.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/promise.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/req-id-gen-factory.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/wrap-thenable.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/allow-unsafe-regex.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/async-dispose.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/async_hooks.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/body-limit.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/buffer.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/child-logger-factory.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/client-timeout.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/conditional-pino.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/connection-timeout.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/content-type.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/custom-parser.0.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/custom-parser.1.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/custom-parser.2.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/custom-parser.3.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/custom-parser.4.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/custom-parser.5.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/diagnostics-channel/404.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/diagnostics-channel/async-delay-request.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/diagnostics-channel/async-request.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/diagnostics-channel/error-before-handler.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/diagnostics-channel/error-request.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/diagnostics-channel/error-status.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/diagnostics-channel/init.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/diagnostics-channel/sync-delay-request.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/diagnostics-channel/sync-request-reply.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/diagnostics-channel/sync-request.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/encapsulated-child-logger-factory.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/esm/errorCodes.test.mjs": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/esm/esm.test.mjs": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/find-route.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/has-route.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/header-overflow.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/hooks.on-listen.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/http-methods/copy.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/http-methods/custom-http-methods.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/http-methods/get.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/http-methods/head.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/http-methods/lock.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/http-methods/mkcalendar.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/http-methods/mkcol.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/http-methods/move.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/http-methods/propfind.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/http-methods/proppatch.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/http-methods/report.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/http-methods/search.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/http-methods/trace.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/http-methods/unlock.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/internals/content-type-parser.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/internals/context.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/internals/errors.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/internals/handle-request.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/internals/hook-runner.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/internals/initial-config.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/internals/promise.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/internals/req-id-gen-factory.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/internals/schema-controller-perf.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/issue-4959.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/keep-alive-timeout.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/listen.1.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/listen.2.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/listen.3.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/listen.4.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/listen.5.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/logger/instantiation.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/logger/logger-test-utils.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/logger/logging.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/logger/options.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/logger/request.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/logger/response.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/logger/tap-parallel-not-ok": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/max-requests-per-socket.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/plugin.1.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/plugin.2.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/plugin.3.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/plugin.4.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/post-empty-body.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/reply-code.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/reply-early-hints.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/reply-web-stream-locked.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/request-header-host.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/request-id.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/request-timeout.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/route-shorthand.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/route.1.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/route.2.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/route.3.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/route.4.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/route.5.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/route.6.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/route.7.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/route.8.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/serialize-response.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/server.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/set-error-handler.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/stream-serializers.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/stream.1.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/stream.2.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/stream.3.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/stream.4.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/stream.5.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/toolkit.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/types/errors.test-d.ts": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/types/using.test-d.ts": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/use-semicolon-delimiter.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/web-api.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"test/wrap-thenable.test.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"types/errors.d.ts": {
					"match": false,
					"status": "missing-in-package"
				},
				"types/server-factory.d.ts": {
					"match": false,
					"status": "missing-in-package"
				},
				"types/tsconfig.eslint.json": {
					"match": false,
					"status": "missing-in-package"
				}
			},
			"summary": {
				"differentFiles": 201,
				"matchingFiles": 16,
				"missingInPackage": 133,
				"missingInSource": 52,
				"score": 0.03980099502487562,
				"totalFiles": 402
			}
		}
	}
]
