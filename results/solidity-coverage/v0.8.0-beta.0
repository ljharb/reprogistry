[
	{
		"reproduceVersion": "0.0.0-local",
		"timestamp": "2026-01-05T12:15:34.155Z",
		"os": "linux",
		"arch": "x64",
		"strategy": "npm:6.13.4",
		"reproduced": false,
		"attested": false,
		"package": {
			"spec": "solidity-coverage@0.8.0-beta.0",
			"name": "solidity-coverage",
			"version": "0.8.0-beta.0",
			"location": "https://registry.npmjs.org/solidity-coverage/-/solidity-coverage-0.8.0-beta.0.tgz",
			"integrity": "sha512-U+OeAJLEqoHJDD7eothMRpNPLcEKfk0q2gwSgCfXEaXusiwVKTs8jqNVKyfucANEWof88dt0IvxBmGpxh5BtmQ==",
			"publishedAt": "2021-01-13T07:28:42.686Z",
			"publishedWith": {
				"node": "12.16.0",
				"npm": "6.13.4"
			}
		},
		"source": {
			"integrity": null,
			"location": "git+https://github.com/sc-forks/solidity-coverage.git",
			"spec": "github:sc-forks/solidity-coverage#1c0308f748e8a3f0f16e75e0c016ea79446d5626"
		},
		"comparisonHash": "8a2a8dcbb729bf3ee9216e490c955701f0ddebe1",
		"diff": {
			"files": {
				"BUIDLER_README.md": {
					"match": false,
					"packageHash": "8fe86a2d745c9d65a09f81745d8e42695fa74b999c697b8a2ec4f76e1095db7e",
					"size": 6782,
					"status": "missing-in-source"
				},
				"CHANGELOG.md": {
					"diff": "--- published/CHANGELOG.md\n+++ rebuilt/CHANGELOG.md\n@@ -1,5 +1,126 @@\n # Changelog\n \n+0.8.11 / 2024-03-07\n+===================\n+  * Check all SWAP opcodes for inst. hashes when viaIR is true (https://github.com/sc-forks/solidity-coverage/issues/873)\n+\n+0.8.10 / 2024-02-29\n+===================\n+  * Check all PUSH opcodes for instr. hashes when viaIR is true (https://github.com/sc-forks/solidity-coverage/issues/871)\n+\n+0.8.9 / 2024-02-27\n+==================\n+  * Fix duplicate hash logic (https://github.com/sc-forks/solidity-coverage/issues/868)\n+  * Improve organization of edge case code in collector (https://github.com/sc-forks/solidity-coverage/issues/869)\n+\n+0.8.8 / 2024-02-21\n+==================\n+  * Coerce sources path to absolute path if necessary (https://github.com/sc-forks/solidity-coverage/issues/866)\n+  * Only inject file-level instr. for first pragma in file (https://github.com/sc-forks/solidity-coverage/issues/865)\n+\n+0.8.7 / 2024-02-09\n+==================\n+  * Documentation Cleanup & Improvements for 0.8.7 release\n+    (https://github.com/sc-forks/solidity-coverage/issues/859)\n+  * Add tests for file-level function declarations\n+    (https://github.com/sc-forks/solidity-coverage/issues/858)\n+  * Add try / catch unit tests (https://github.com/sc-forks/solidity-coverage/issues/857)\n+  * Fix test project configs for viaIR detection in overrides\n+    (https://github.com/sc-forks/solidity-coverage/issues/856)\n+  * Enable coverage when viaIR compiler flag is true\n+    (https://github.com/sc-forks/solidity-coverage/issues/854)\n+  * Add missing onPreCompile hook\n+    (https://github.com/sc-forks/solidity-coverage/issues/851)\n+  * Remove ganache-cli related code from API & tests\n+    (https://github.com/sc-forks/solidity-coverage/pull/849)\n+  * Add command option to specify the source files to run the coverage on\n+    (https://github.com/sc-forks/solidity-coverage/pull/838)\n+\n+0.8.6 / 2024-01-28\n+==================\n+  * Add test for multi-contract files with inheritance\n+    (https://github.com/sc-forks/solidity-coverage/issues/836)\n+  * Add test for modifiers with post-conditions (https://github.com/sc-forks/solidity-coverage/issues/835)\n+  * Document Istanbul check-coverage cli command\n+    (https://github.com/sc-forks/solidity-coverage/issues/834)\n+  * Throw error when mocha parallel is set to true\n+    (https://github.com/sc-forks/solidity-coverage/issues/833)\n+  * Fix instrumentation error for virtual modifiers\n+    (https://github.com/sc-forks/solidity-coverage/issues/832)\n+  * Add test for file level `using for` statements\n+    (https://github.com/sc-forks/solidity-coverage/issues/831)\n+  * Fix chained ternary conditionals instrumentation\n+    (https://github.com/sc-forks/solidity-coverage/issues/830)\n+  * Update faq.md with an optimizer config workaround\n+    (https://github.com/sc-forks/solidity-coverage/issues/822)\n+  * Upgrade solidity-parser to 0.18.0 (https://github.com/sc-forks/solidity-coverage/issues/829)\n+  * Perform ternary conditional injections before branch injections\n+    (https://github.com/sc-forks/solidity-coverage/issues/828)\n+  * Add drips funding config (https://github.com/sc-forks/solidity-coverage/issues/827)\n+\n+0.8.5 / 2023-09-21\n+==================\n+  * Update contributor list (https://github.com/sc-forks/solidity-coverage/issues/812)\n+  * Add dependabot config (https://github.com/sc-forks/solidity-coverage/issues/759)\n+  * Add a package description to package.json (https://github.com/sc-forks/solidity-coverage/issues/775)\n+  * change .solcoverjs occurrences to .solcover.js (https://github.com/sc-forks/solidity-coverage/issues/777)\n+  * Remove all mentions to buidler (https://github.com/sc-forks/solidity-coverage/issues/778)\n+  * Update HH dev dep & fix Zeppelin E2E test (https://github.com/sc-forks/solidity-coverage/issues/811)\n+  * Update mocha version to 10.2.0, fix deprecated debug package (https://github.com/sc-forks/solidity-coverage/issues/810)\n+\n+0.8.4 / 2023-07-04\n+==================\n+  * Update solidity-parser to 0.16.0 (https://github.com/sc-forks/solidity-coverage/issues/802)\n+\n+0.8.3 / 2023-06-22\n+==================\n+  * Updates for Hardhat v2.15.0  (https://github.com/sc-forks/solidity-coverage/pull/796)\n+\n+0.8.1 / 2022-09-06\n+===================\n+  * Restore web3-utils (https://github.com/sc-forks/solidity-coverage/issues/743)\n+\n+0.8.0 / 2022-09-05\n+==================\n+\n+* See release notes at: https://github.com/sc-forks/solidity-coverage/releases/tag/v0.8.0\n+\n+0.7.21 / 2022-04-24\n+===================\n+  * Add support for UncheckedStatement blocks (https://github.com/sc-forks/solidity-coverage/issues/712)\n+  * Lazy load hardhat plugin resources (https://github.com/sc-forks/solidity-coverage/issues/711)\n+\n+0.7.20 / 2022-02-15\n+===================\n+  * Remove early V7 Truffle patches  (https://github.com/sc-forks/solidity-coverage/issues/693)\n+\n+0.7.19 / 2022-02-09\n",
					"match": false,
					"packageHash": "8c51615a8e57d4fd83e6cd665731a156bdbd44bb328819580d8d3b2a02e883b3",
					"size": 15285,
					"sourceHash": "55d966a2a75899ccb33d3a38f1d72bbc0dea476ff812ecda6899bc2311d32918",
					"status": "content"
				},
				"HARDHAT_README.md": {
					"match": false,
					"packageHash": "202891ef575136a921af30e38e8cfcdfe65441b906f913739a6962cb2f0850f5",
					"size": 7065,
					"status": "missing-in-source"
				},
				"README.md": {
					"diff": "--- published/README.md\n+++ rebuilt/README.md\n@@ -4,7 +4,7 @@\n ![npm (tag)](https://img.shields.io/npm/v/solidity-coverage/latest)\n [![CircleCI](https://circleci.com/gh/sc-forks/solidity-coverage.svg?style=svg)][20]\n [![codecov](https://codecov.io/gh/sc-forks/solidity-coverage/branch/master/graph/badge.svg)][21]\n-[![buidler](https://buidler.dev/buidler-plugin-badge.svg?1)][26]\n+[![Hardhat](https://hardhat.org/buidler-plugin-badge.svg?1)][26]\n \n \n ## Code coverage for Solidity testing\n@@ -14,93 +14,69 @@\n   see [the accompanying article][16].\n + `solidity-coverage` is [Solcover][17]\n \n-## Install\n-```\n-$ npm install --save-dev solidity-coverage\n-```\n-\n-**Resources**:\n-+ [0.7.0 release notes][31]\n-+ [A guide][29] to upgrading from 0.6.x to 0.7.x\n-+ [0.6.3 docs][30]\n+## Requirements\n \n-### Truffle V5\n++ Hardhat >= 2.11.0\n \n-**Add** this package to your plugins array in `truffle-config.js` ([Truffle docs][27])\n-```javascript\n-module.exports = {\n-  networks: {...},\n-  plugins: [\"solidity-coverage\"]\n-}\n-```\n-**Run**\n+## Install\n ```\n-truffle run coverage [command-options]\n+$ yarn add solidity-coverage --dev\n ```\n \n-### Hardhat\n-\n-Beginning with v0.7.12, this tool supports Hardhat and runs directly on\n-HardhatEVM.\n-\n **Require** the plugin in `hardhat.config.js` ([Hardhat docs][26])\n ```javascript\n require('solidity-coverage')\n ```\n \n-**Run**\n-```\n-npx hardhat coverage [command-options]\n+Or, if you are using TypeScript, add this to your hardhat.config.ts:\n+```ts\n+import 'solidity-coverage'\n ```\n \n-(Additional Hardhat-specific info can be found [here][37])\n+**Resources**:\n++ [0.8.0 release notes][31]\n \n-### Buidler [Deprecated]\n+## Run\n+```\n+npx hardhat coverage [command-options]\n+```\n \n-**Add** the plugin in `buidler.config.js` ([Buidler docs][26])\n-```javascript\n-usePlugin('solidity-coverage')\n+### Trouble shooting\n \n-module.exports = {\n-  networks: {\n-    coverage: {\n-      url: 'http://localhost:8555'\n-    }\n-  },\n-}\n-```\n-**Run**\n+**Missing or unexpected coverage?** Make sure you're using the latest plugin version and run:\n+```sh\n+$ npx hardhat clean\n+$ npx hardhat compile\n+$ npx hardhat coverage\n ```\n-npx buidler coverage --network coverage [command-options]\n+\n+**Typescript compilation errors?**\n+```sh\n+$ npx hardhat compile\n+$ TS_NODE_TRANSPILE_ONLY=true npx hardhat coverage\n ```\n \n-**Buidler Project Examples:**\n",
					"match": false,
					"packageHash": "b3f3d179d108d25c256f24e9047a311dbd88e654d1ec269db685865460202921",
					"size": 11320,
					"sourceHash": "b9408630537e9f4369b5b1c2863578f3469b8555e77e866fe22a6eec1c13aa65",
					"status": "content"
				},
				"lib/api.js": {
					"diff": "--- published/lib/api.js\n+++ rebuilt/lib/api.js\n@@ -4,8 +4,8 @@\n const path = require('path');\n const istanbul = require('sc-istanbul');\n const assert = require('assert');\n-const detect = require('detect-port');\n const _ = require('lodash/lang');\n+const { hardforkGte, HardforkName } = require('hardhat/internal/util/hardforks');\n \n const ConfigValidator = require('./validator');\n const Instrumenter = require('./instrumenter');\n@@ -18,7 +18,7 @@\n  * Coverage Runner\n  */\n class API {\n-  constructor(config={}) {\n+  constructor(config={}, hardfork) {\n     this.validator = new ConfigValidator();\n     this.abiUtils = new AbiUtils();\n     this.config = config || {};\n@@ -43,27 +43,26 @@\n     this.onTestsComplete = config.onTestsComplete       || this.defaultHook;\n     this.onCompileComplete = config.onCompileComplete   || this.defaultHook;\n     this.onIstanbulComplete = config.onIstanbulComplete || this.defaultHook;\n-\n-    this.server = null;\n-    this.defaultPort = 8555;\n-    this.client = config.client;\n-    this.defaultNetworkName = 'soliditycoverage';\n-    this.port = config.port || this.defaultPort;\n-    this.host = config.host || \"127.0.0.1\";\n-    this.providerOptions = config.providerOptions || {};\n-    this.autoLaunchServer = config.autoLaunchServer === false ? false : true;\n+    this.onPreCompile = config.onPreCompile             || this.defaultHook;\n \n     this.skipFiles = config.skipFiles || [];\n \n     this.log = config.log || console.log;\n-    this.gasLimit = 0xffffffffff                // default \"gas sent\" with transactions\n-    this.gasLimitString = \"0x1fffffffffffff\";   // block gas limit for ganache (higher than \"gas sent\")\n-    this.gasLimitNumber = 0x1fffffffffffff;     // block gas limit for Hardhat\n+    const isEip7825Enabled = hardfork !== undefined && HardforkName.OSAKA !== undefined\n+      ? hardforkGte(hardfork, HardforkName.OSAKA)\n+      : false;\n+    this.gasLimit = isEip7825Enabled ? 2 ** 24 : 0xffffffffff   // default \"gas sent\" with transactions\n+    this.gasLimitNumber = 0x1fffffffffffff;           // block gas limit for Hardhat\n     this.gasPrice = 0x01;\n \n     this.istanbulFolder = config.istanbulFolder || false;\n     this.istanbulReporter = config.istanbulReporter || ['html', 'lcov', 'text', 'json'];\n \n+    this.viaIR = config.viaIR;\n+    this.usingSolcV4 = config.usingSolcV4;\n+    this.irMinimum = config.irMinimum;\n+    this.solcOptimizerDetails = config.solcOptimizerDetails;\n+\n     this.setLoggingLevel(config.silent);\n     this.ui = new AppUI(this.log);\n   }\n@@ -136,56 +135,6 @@\n   }\n \n   /**\n-   * Enables coverage collection on in-process ethereum client server, hooking the DataCollector\n-   * to its VM. By default, method will return a url after server has begun listening on the port\n-   * specified in the config. When `autoLaunchServer` is false, method returns`ganache.server` so\n-   * the consumer can control the 'server.listen' invocation themselves.\n-   * @param  {Object} client             ganache client\n-   * @param  {Boolean} autoLaunchServer  boolean\n-   * @return {<Promise> (String | Server) }  address of server to connect to, or initialized, unlaunched server.\n-   */\n-  async ganache(client, autoLaunchServer){\n-    // Check for port-in-use\n-    if (await detect(this.port) !== this.port){\n-      throw new Error(this.ui.generate('server-fail', [this.port]))\n-    }\n-\n-    this.collector = new DataCollector(this.instrumenter.instrumentationData);\n-\n-    this.providerOptions.gasLimit =\n-      'gasLimit' in this.providerOptions\n-        ? this.providerOptions.gasLimit\n-        : this.gasLimitString;\n-\n-    this.providerOptions.allowUnlimitedContractSize =\n-      'allowUnlimitedContractSize' in this.providerOptions\n-        ? this.providerOptions.allowUnlimitedContractSize\n-        : true;\n-\n-    // Attach to vm step of supplied client\n-    try {\n-      if (this.config.forceBackupServer) throw new Error()\n-      await this.attachToGanacheVM(client)\n-    }\n-\n-    // Fallback to ganache-cli)\n-    catch(err) {\n-      const _ganache = require('ganache-cli');\n-      this.ui.report('vm-fail', [_ganache.version]);\n",
					"match": false,
					"packageHash": "02492df06cb037374a3dae189951a69f61f325d92556f880e20adfa92199bb6f",
					"size": 12621,
					"sourceHash": "75be6d8f1a02954590a27010957d14342cc9d5cbe9d1084f8d6889b854294e3a",
					"status": "content"
				},
				"lib/collector.js": {
					"diff": "--- published/lib/collector.js\n+++ rebuilt/lib/collector.js\n@@ -1,16 +1,16 @@\n-const web3Utils = require('web3-utils')\n-\n /**\n  * Writes data from the VM step to the in-memory\n  * coverage map constructed by the Instrumenter.\n  */\n class DataCollector {\n-  constructor(instrumentationData={}){\n+  constructor(instrumentationData={}, viaIR){\n     this.instrumentationData = instrumentationData;\n \n-    this.validOpcodes = {\n-      \"PUSH1\": true,\n-    }\n+    this.validOpcodes = this._getOpcodes(viaIR);\n+    this.lastHash = null;\n+    this.viaIR = viaIR;\n+    this.pcZeroCounter = 0;\n+    this.lastPcZeroCount = 0;\n   }\n \n   /**\n@@ -19,27 +19,17 @@\n    * @param  {Object} info  vm step info\n    */\n   step(info){\n+    if (info.pc === 0) this.pcZeroCounter++;\n+\n     try {\n       if (this.validOpcodes[info.opcode.name] && info.stack.length > 0){\n         const idx = info.stack.length - 1;\n-        let hash = web3Utils.toHex(info.stack[idx]).toString();\n-        this._registerHash(hash)\n+        let hash = '0x' +  info.stack[idx].toString(16);\n+        this._registerHash(hash);\n       }\n     } catch (err) { /*Ignore*/ };\n   }\n \n-  // Temporarily disabled because some relevant traces aren't available\n-  /**\n-   * Converts pushData value to string and registers in instrumentation map.\n-   * @param  {HardhatEVMTraceInstruction} instruction\n-   */\n-  /*trackHardhatEVMInstruction(instruction){\n-    if (instruction && instruction.pushData){\n-      let hash = `0x` + instruction.pushData.toString('hex');\n-      this._registerHash(hash)\n-    }\n-  }*/\n-\n   /**\n    * Normalizes has string and marks hit.\n    * @param  {String} hash bytes32 hash\n@@ -48,7 +38,14 @@\n     hash = this._normalizeHash(hash);\n \n     if(this.instrumentationData[hash]){\n-      this.instrumentationData[hash].hits++;\n+      // abi.encode (used to circumvent viaIR) sometimes puts the hash on the stack twice\n+      // We should only skip duplicate hashes *within* a transaction (see issue #863)\n+      if (this.lastHash !== hash || this.lastPcZeroCount !== this.pcZeroCounter) {\n+        this.lastHash = hash;\n+        this.lastPcZeroCount = this.pcZeroCounter;\n+        this.instrumentationData[hash].hits++\n+      }\n+      return;\n     }\n   }\n \n@@ -58,10 +55,23 @@\n    * but prevents left-padding shorter irrelevant hashes\n    *\n    * @param  {String} hash  data hash from evm stack.\n-   * @return {String}       0x prefixed hash of length 66.\n+   * @return {String}       0x prefixed hash of length 18.\n    */\n   _normalizeHash(hash){\n-    if (hash.length < 18 && hash.length > 11){\n+    // viaIR sometimes right-pads the hashes out to 32 bytes\n+    // but it doesn't preserve leading zeroes when it does this\n+    if (this.viaIR && hash.length >= 18) {\n+      hash = hash.slice(0,18);\n+\n+      // Detect and recover from viaIR mangled hashes by left-padding single `0`\n+      if(!this.instrumentationData[hash]) {\n+        hash = hash.slice(2);\n+        hash = '0' + hash;\n+        hash = hash.slice(0,16);\n+        hash = '0x' + hash;\n+      }\n+\n+    } else if (hash.length < 18 && hash.length > 11){\n       hash = hash.slice(2);\n       while(hash.length < 16) hash = '0' + hash;\n       hash = '0x' + hash\n@@ -70,6 +80,36 @@\n",
					"match": false,
					"packageHash": "464e32060d4782a3ce6d8b47f63ba86ecdcbd9bacc7f91ba1356d585af9ec9f6",
					"size": 2224,
					"sourceHash": "765907827852c660b3c7b198e221b96e92c5cb803d7c02c6b6f15caf7c478c02",
					"status": "content"
				},
				"lib/injector.js": {
					"diff": "--- published/lib/injector.js\n+++ rebuilt/lib/injector.js\n@@ -1,7 +1,8 @@\n const web3Utils = require(\"web3-utils\");\n \n class Injector {\n-  constructor(){\n+  constructor(viaIR){\n+    this.viaIR = viaIR;\n     this.hashCounter = 0;\n     this.modifierCounter = 0;\n     this.modifiers = {};\n@@ -23,7 +24,9 @@\n       case 'modifier':\n         return ` ${this._getModifierIdentifier(id)} `;\n       default:\n-        return `${this._getDefaultMethodIdentifier(id)}(${hash}); /* ${type} */ \\n`;\n+        return (this.viaIR)\n+          ? `${this._getAbiEncodeStatementHash(hash)} /* ${type} */ \\n`\n+          : `${this._getDefaultMethodIdentifier(id)}(${hash}); /* ${type} */ \\n`;\n     }\n   }\n \n@@ -51,6 +54,16 @@\n     return `c_mod${web3Utils.keccak256(id).slice(2,10)}`\n   }\n \n+  // Way to get hash on the stack with viaIR (which seems to ignore abi.encode builtin)\n+  // Tested with v0.8.17, v0.8.24\n+    _getAbiEncodeStatementHash(hash){\n+    return `abi.encode(${hash}); `\n+  }\n+\n+  _getAbiEncodeStatementVar(hash){\n+    return `abi.encode(c__${hash}); `\n+  }\n+\n   _getInjectionComponents(contract, injectionPoint, id, type){\n     const { start, end } = this._split(contract, injectionPoint);\n     const hash = this._getHash(id)\n@@ -65,15 +78,34 @@\n   }\n \n   /**\n-   * Generates a solidity statement injection defining a method\n-   * *which returns void* to pass instrumentation hash to.\n+   * Generates an instrumentation fn definition for contract scoped methods.\n+   * Declared once per contract.\n    * @param  {String} id\n-   * @return {String}          ex: bytes32[1] memory _sc_82e0891\n+   * @return {String}\n    */\n   _getDefaultMethodDefinition(id){\n     const hash = web3Utils.keccak256(id).slice(2,10);\n     const method = this._getDefaultMethodIdentifier(id);\n-    return `\\nfunction ${method}(bytes8 c__${hash}) public pure {}\\n`;\n+\n+    return (this.viaIR)\n+      ? ``\n+      : `\\nfunction ${method}(bytes8 c__${hash}) internal pure {}\\n`;\n+  }\n+\n+  /**\n+   * Generates an instrumentation fn definition for file scoped methods.\n+   * Declared once per file. (Has no visibility modifier)\n+   * @param  {String} id\n+   * @return {String}\n+   */\n+  _getFileScopedHashMethodDefinition(id, contract){\n+    const hash = web3Utils.keccak256(id).slice(2,10);\n+    const method = this._getDefaultMethodIdentifier(id);\n+    const abi = this._getAbiEncodeStatementVar(hash);\n+\n+    return (this.viaIR)\n+      ? `\\nfunction ${method}(bytes8 c__${hash}) pure { ${abi} }\\n`\n+      : `\\nfunction ${method}(bytes8 c__${hash}) pure {}\\n`;\n   }\n \n   /**\n@@ -85,7 +117,28 @@\n   _getTrueMethodDefinition(id){\n     const hash = web3Utils.keccak256(id).slice(2,10);\n     const method = this._getTrueMethodIdentifier(id);\n-    return `function ${method}(bytes8 c__${hash}) public pure returns (bool){ return true; }\\n`;\n+    const abi = this._getAbiEncodeStatementVar(hash);\n+\n+    return (this.viaIR)\n+      ? `function ${method}(bytes8 c__${hash}) internal pure returns (bool){ ${abi} return true; }\\n`\n+      : `function ${method}(bytes8 c__${hash}) internal pure returns (bool){ return true; }\\n`;\n+  }\n+\n+  /**\n+   * Generates a solidity statement injection defining a method\n+   * *which returns boolean true* to pass instrumentation hash to.\n+   * Declared once per file. (Has no visibility modifier)\n+   * @param  {String} fileName\n+   * @return {String}          ex: bytes32[1] memory _sc_82e0891\n+   */\n+  _getFileScopeTrueMethodDefinition(id){\n+    const hash = web3Utils.keccak256(id).slice(2,10);\n",
					"match": false,
					"packageHash": "87802171bdba658288d4d00431dfe7517ebfba4dc37520476d9e43da85a67fea",
					"size": 10703,
					"sourceHash": "6d6365d33fd5274af41646fb3f5358e86c01fd1657728c46cc5b82a91cb141d7",
					"status": "content"
				},
				"lib/instrumenter.js": {
					"diff": "--- published/lib/instrumenter.js\n+++ rebuilt/lib/instrumenter.js\n@@ -14,7 +14,7 @@\n \n   constructor(config={}){\n     this.instrumentationData = {};\n-    this.injector = new Injector();\n+    this.injector = new Injector(config.viaIR);\n     this.modifierWhitelist = config.modifierWhitelist || [];\n     this.enabled = {\n       statements: (config.measureStatementCoverage === false) ? false : true,\n@@ -87,6 +87,8 @@\n \n     // Handle contracts which only contain import statements\n     contract.contractName = (root.length) ? root[0].name : null;\n+\n+    contract.finalParse = true;\n     parse[ast.type](contract, ast);\n \n     // We have to iterate through these points in descending order\n@@ -97,8 +99,10 @@\n       // Line instrumentation has to happen first\n       contract.injectionPoints[injectionPoint].sort((a, b) => {\n         const injections = [\n-          'injectLogicalOR',\n           'injectBranch',\n+          'injectOpenParen',\n+          'injectOrFalse',\n+          'injectAndTrue',\n           'injectEmptyBranch',\n           'injectLine'\n         ];\n",
					"match": false,
					"packageHash": "583f615693b4bc8766580af3a37311eb6b68d7c7ba05d9e240fd59db71656d88",
					"size": 4288,
					"sourceHash": "9af2c209f425415ef395efbfffafd49744deeaa8273406321ae10701b0791067",
					"status": "content"
				},
				"lib/parse.js": {
					"diff": "--- published/lib/parse.js\n+++ rebuilt/lib/parse.js\n@@ -3,9 +3,11 @@\n  * functions where appropriate, which determine where to inject events.\n  * (Listed in alphabetical order)\n  */\n+const semver = require('semver');\n const Registrar = require('./registrar');\n const register = new Registrar();\n \n+const FILE_SCOPED_ID = \"fileScopedId\";\n const parse = {};\n \n // Utilities\n@@ -31,16 +33,14 @@\n   // Free-floating ternary conditional\n   if (expression.left && expression.left.type === 'Conditional'){\n     parse[expression.left.type](contract, expression.left, true);\n-    register.statement(contract, expression);\n \n   // Ternary conditional assignment\n   } else if (expression.right && expression.right.type === 'Conditional'){\n     parse[expression.right.type](contract, expression.right, true);\n-    register.statement(contract, expression);\n \n   // Regular binary operation\n   } else if(!skipStatementRegistry){\n-    register.statement(contract, expression);\n+    // noop\n \n   // LogicalOR condition search...\n   } else {\n@@ -89,7 +89,15 @@\n \n parse.Conditional = function(contract, expression, skipStatementRegistry) {\n   parse[expression.condition.type] &&\n-  parse[expression.condition.type](contract, expression.condition, skipStatementRegistry);\n+  parse[expression.condition.type](contract, expression.condition, true);\n+\n+  if (expression.trueExpression && expression.trueExpression.type === 'Conditional'){\n+    parse[expression.trueExpression.type](contract, expression.trueExpression, true);\n+  }\n+\n+  if (expression.falseExpression && expression.falseExpression.type === 'Conditional'){\n+    parse[expression.falseExpression.type](contract, expression.falseExpression, true);\n+  }\n \n   register.conditional(contract, expression);\n };\n@@ -128,10 +136,14 @@\n   }\n \n   if (expression.subNodes) {\n+    // Set flag to allow alternate cov id generation of file-level fn defs\n+    contract.isContractScoped = true;\n     expression.subNodes.forEach(construct => {\n       parse[construct.type] &&\n       parse[construct.type](contract, construct);\n     });\n+    // Unset flag...\n+    contract.isContractScoped = false;\n   }\n };\n \n@@ -151,6 +163,13 @@\n };\n \n parse.FunctionDefinition = function(contract, expression) {\n+  // Use generic name component to generate the hash for cov fn ids\n+  // if we're not inside a contract\n+  let tempContractName = contract.contractName;\n+  if (!contract.isContractScoped){\n+    contract.contractName = FILE_SCOPED_ID;\n+  }\n+\n   parse.Modifiers(contract, expression.modifiers);\n   if (expression.body) {\n     // Skip fn & statement instrumentation for `receive` methods to\n@@ -163,6 +182,8 @@\n     parse[expression.body.type](contract, expression.body);\n     register.trackStatements = true;\n   }\n+  // Reset contractName in case it was changed for file scoped methods\n+  contract.contractName = tempContractName;\n };\n \n parse.IfStatement = function(contract, expression) {\n@@ -196,9 +217,11 @@\n };\n \n parse.ModifierDefinition = function(contract, expression) {\n-  register.functionDeclaration(contract, expression);\n-  parse[expression.body.type] &&\n-  parse[expression.body.type](contract, expression.body);\n+  if (expression.body) {\n+    register.functionDeclaration(contract, expression);\n+    parse[expression.body.type] &&\n+    parse[expression.body.type](contract, expression.body);\n+  }\n };\n",
					"match": false,
					"packageHash": "915642fac8de2d2840e7c20c380079aa85ba2a20c994fe68847863c97448fc9a",
					"size": 8732,
					"sourceHash": "f3ad959afb13b0d5f9a3534b57140ffdbc131eb15a3f46d32be587279e48b8e2",
					"status": "content"
				},
				"lib/registrar.js": {
					"diff": "--- published/lib/registrar.js\n+++ rebuilt/lib/registrar.js\n@@ -23,6 +23,14 @@\n     this.modifierWhitelist = [];\n   }\n \n+  _seekSemiColon(contract, pos) {\n+    const end = pos + 5;\n+    for(pos; pos <= end; pos++) {\n+      if (contract[pos] === ';') break;\n+    }\n+    return pos;\n+  }\n+\n   /**\n    * Adds injection point to injection points map\n    * @param  {Object} contract instrumentation target\n@@ -441,7 +449,7 @@\n     );\n     this._createInjectionPoint(\n       contract,\n-      expression.range[1] + 2,\n+      this._seekSemiColon(contract.instrumented, expression.range[1] + 1) + 1,\n       {\n         type: 'injectRequirePost',\n         branchId: contract.branchId,\n",
					"match": false,
					"packageHash": "432f4bd53173d74de91fcd7d75b61b1c9eb51f47b5b709864ba65c00ca16857b",
					"size": 14693,
					"sourceHash": "015976e1fa4fdf65eb50154b9364fabbd6fa789498e140b00f43aa9e67eeca2d",
					"status": "content"
				},
				"lib/ui.js": {
					"diff": "--- published/lib/ui.js\n+++ rebuilt/lib/ui.js\n@@ -4,7 +4,7 @@\n /**\n  * Coverage tool output formatters. These classes support any the logging solidity-coverage API\n  * (or plugins which consume it) do on their own behalf. NB, most output is generated by the host\n- * dev stack (ex: the truffle compile command, or istanbul).\n+ * dev stack (ex: the hardhat compile command, or istanbul).\n  */\n class UI {\n   constructor(log){\n@@ -56,10 +56,6 @@\n     const w = \":warning:\";\n \n     const kinds = {\n-      'vm-fail': `${w}  ${c.red('There was a problem attaching to the ganache VM.')}\\n` +\n-                 `${w}  ${c.red('For help, see the \"client\" & \"providerOptions\" syntax in solidity-coverage docs.')}\\n`+\n-                 `${w}  ${c.red(`Using ganache-cli (v${args[0]}) instead.`)}\\n`,\n-\n \n       'instr-start': `\\n${c.bold('Instrumenting for coverage...')}` +\n                      `\\n${c.bold('=============================')}\\n`,\n@@ -69,14 +65,10 @@\n       'istanbul': `${ct} ${c.grey('Istanbul reports written to')} ./coverage/ ` +\n                         `${c.grey('and')} ./coverage.json`,\n \n-      'finish':  `${ct} ${c.grey('solidity-coverage cleaning up, shutting down ganache server')}`,\n-\n-      'server':  `${ct} ${c.bold('server: ')}           ${c.grey(args[0])}`,\n-\n       'command': `\\n${w}  ${c.red.bold('solidity-coverage >= 0.7.0 is no longer a shell command.')} ${w}\\n` +\n                  `${c.bold('=============================================================')}\\n\\n` +\n                  `Instead, you should use the plugin produced for your development stack\\n` +\n-                 `(like Truffle, Buidler) or design a custom workflow using the package API\\n\\n` +\n+                 `(like Hardhat) or design a custom workflow using the package API\\n\\n` +\n                  `> See https://github.com/sc-forks/solidity-coverage for help with configuration.\\n\\n` +\n                  `${c.green.bold('Thanks! - sc-forks')}\\n`,\n     };\n@@ -103,10 +95,6 @@\n       'istanbul-fail': `${c.red('Istanbul coverage reports could not be generated. ')}`,\n \n       'sources-fail': `${c.red('Cannot locate expected contract sources folder: ')} ${args[0]}`,\n-\n-      'server-fail': `${c.red('Port')} ${args[0]} ${c.red('is already in use.\\n')}` +\n-                     `${c.red('\\tRun: \"lsof -i\" to find the pid of the process using it.\\n')}` +\n-                     `${c.red('\\tRun: \"kill -9 <pid>\" to kill it.\\n')}`\n     }\n \n     return this._format(kinds[kind])\n",
					"match": false,
					"packageHash": "9b43e16b62a0cf20cc348d94d76fe4952a15ce217e7cd350d48e43303b14eb96",
					"size": 3943,
					"sourceHash": "2bdb0ceff4207fde57e996d57683dbf1f6c4f41a0d07466a75fe3c08f66c8acd",
					"status": "content"
				},
				"package.json": {
					"diff": "--- published/package.json\n+++ rebuilt/package.json\n@@ -1,7 +1,7 @@\n {\n   \"name\": \"solidity-coverage\",\n-  \"version\": \"0.8.0-beta.0\",\n-  \"description\": \"\",\n+  \"version\": \"0.8.17\",\n+  \"description\": \"Code coverage for Solidity testing\",\n   \"main\": \"plugins/nomiclabs.plugin.js\",\n   \"bin\": {\n     \"solidity-coverage\": \"./plugins/bin.js\"\n@@ -10,11 +10,12 @@\n     \"test\": \"test\"\n   },\n   \"scripts\": {\n-    \"nyc\": \"SILENT=true  nyc --exclude '**/sc_temp/**' --exclude '**/test/**'\",\n-    \"test\": \"SILENT=true node --max-old-space-size=4096 ./node_modules/.bin/nyc --exclude '**/sc_temp/**' --exclude '**/test/**/' -- mocha test/units/* --timeout 100000 --no-warnings --exit\",\n-    \"test:ci\": \"SILENT=true node --max-old-space-size=4096 ./node_modules/.bin/nyc --reporter=lcov --exclude '**/sc_temp/**' --exclude '**/test/**/' --exclude 'plugins/resources/matrix.js' -- mocha test/units/* --timeout 100000 --no-warnings --exit\",\n-    \"test:debug\": \"node --max-old-space-size=4096 ./node_modules/.bin/mocha test/units/* --timeout 100000 --no-warnings --exit\",\n-    \"netlify\": \"./scripts/run-netlify.sh\"\n+    \"test:unit\": \"./scripts/unit.sh\",\n+    \"test:integration\": \"./scripts/integration.sh\",\n+    \"test:ci\": \"./scripts/ci.sh\",\n+    \"test:unit:viaIR\": \"VIA_IR=true ./scripts/unit.sh\",\n+    \"test:integration:viaIR\": \"VIA_IR=true ./scripts/integration.sh\",\n+    \"test:ci:viaIR\": \"VIA_IR=true ./scripts/ci.sh\"\n   },\n   \"homepage\": \"https://github.com/sc-forks/solidity-coverage\",\n   \"repository\": {\n@@ -25,42 +26,44 @@\n   \"license\": \"ISC\",\n   \"dependencies\": {\n     \"@ethersproject/abi\": \"^5.0.9\",\n-    \"@solidity-parser/parser\": \"^0.11.0\",\n-    \"@truffle/provider\": \"^0.2.24\",\n+    \"@solidity-parser/parser\": \"^0.20.1\",\n     \"chalk\": \"^2.4.2\",\n     \"death\": \"^1.1.0\",\n-    \"detect-port\": \"^1.3.0\",\n     \"difflib\": \"^0.2.4\",\n     \"fs-extra\": \"^8.1.0\",\n-    \"ganache-cli\": \"^6.11.0\",\n     \"ghost-testrpc\": \"^0.0.2\",\n     \"global-modules\": \"^2.0.0\",\n     \"globby\": \"^10.0.1\",\n     \"jsonschema\": \"^1.2.4\",\n-    \"lodash\": \"^4.17.15\",\n-    \"mocha\": \"7.1.2\",\n+    \"lodash\": \"^4.17.21\",\n+    \"mocha\": \"^10.2.0\",\n     \"node-emoji\": \"^1.10.0\",\n     \"pify\": \"^4.0.1\",\n     \"recursive-readdir\": \"^2.2.2\",\n     \"sc-istanbul\": \"^0.4.5\",\n     \"semver\": \"^7.3.4\",\n     \"shelljs\": \"^0.8.3\",\n-    \"web3-utils\": \"^1.3.0\"\n+    \"web3-utils\": \"^1.3.6\"\n   },\n   \"devDependencies\": {\n-    \"@nomiclabs/buidler\": \"^1.3.6\",\n-    \"@nomiclabs/buidler-truffle5\": \"^1.3.4\",\n-    \"@nomiclabs/buidler-web3\": \"^1.3.4\",\n+    \"@nomicfoundation/hardhat-network-helpers\": \"^1.0.10\",\n+    \"@nomicfoundation/hardhat-viem\": \"^2.0.0\",\n+    \"@nomiclabs/hardhat-ethers\": \"^2.0.4\",\n     \"@nomiclabs/hardhat-truffle5\": \"^2.0.0\",\n+    \"@nomiclabs/hardhat-waffle\": \"^2.0.1\",\n     \"@nomiclabs/hardhat-web3\": \"^2.0.0\",\n-    \"@truffle/contract\": \"^4.0.36\",\n-    \"buidler-gas-reporter\": \"^0.1.3\",\n+    \"chai\": \"^4.3.4\",\n+    \"chai-as-promised\": \"^7.1.1\",\n     \"decache\": \"^4.5.1\",\n-    \"hardhat\": \"2.0.2\",\n+    \"ethereum-waffle\": \"^3.4.0\",\n+    \"ethers\": \"^5.5.3\",\n+    \"hardhat\": \"^2.22.2\",\n     \"hardhat-gas-reporter\": \"^1.0.1\",\n     \"nyc\": \"^14.1.1\",\n-    \"solc\": \"^0.7.5\",\n-    \"truffle\": \"5.1.43\",\n-    \"truffle-config\": \"^1.1.18\"\n+    \"solc\": \"0.8.24\",\n+    \"viem\": \"^2.9.9\"\n+  },\n+  \"peerDependencies\": {\n+    \"hardhat\": \"^2.11.0\"\n   }\n }\n",
					"match": false,
					"packageHash": "e4e946bd812447c335f80ac26fa6710b57a8a8b032e8ff8a38639000ec87db7a",
					"size": 2294,
					"sourceHash": "7c6818f1b902493e2882bda85d2d436fc46ee86295965f7b065a4cd968642fab",
					"status": "content"
				},
				"plugins/buidler.plugin.js": {
					"match": false,
					"packageHash": "230712ac2bdb6c0b38db0607bce1b6119afcb8843904801119f55d1eda587877",
					"size": 4303,
					"status": "missing-in-source"
				},
				"plugins/hardhat.plugin.js": {
					"diff": "--- published/plugins/hardhat.plugin.js\n+++ rebuilt/plugins/hardhat.plugin.js\n@@ -1,15 +1,9 @@\n-const API = require('./../lib/api');\n-const utils = require('./resources/plugin.utils');\n-const nomiclabsUtils = require('./resources/nomiclabs.utils');\n-const PluginUI = require('./resources/nomiclabs.ui');\n-\n-const pkg = require('./../package.json');\n const path = require('path');\n-const {inspect} = require('util')\n+const PluginUI = require('./resources/nomiclabs.ui');\n \n-const { task, types } = require(\"hardhat/config\");\n+const { extendConfig, task, types } = require(\"hardhat/config\");\n const { HardhatPluginError } = require(\"hardhat/plugins\")\n-\n+const {HARDHAT_NETWORK_RESET_EVENT} = require(\"hardhat/internal/constants\");\n const {\n   TASK_TEST,\n   TASK_COMPILE,\n@@ -20,12 +14,28 @@\n \n // Toggled true for `coverage` task only.\n let measureCoverage = false;\n-let instrumentedSources\n+let configureYulOptimizer = false;\n+let irMinimum = false;\n+let instrumentedSources;\n+let optimizerDetails;\n \n // UI for the task flags...\n const ui = new PluginUI();\n \n-task(TASK_COMPILE_SOLIDITY_GET_COMPILER_INPUT).setAction(async (_, { config }, runSuper) => {\n+// Workaround for hardhat-viem-plugin and other provider redefinition conflicts\n+extendConfig((config, userConfig) => {\n+  if (Boolean(process.env.SOLIDITY_COVERAGE)) {\n+    const { configureHardhatEVMGas } = require('./resources/nomiclabs.utils');\n+    const API = require('./../lib/api');\n+    const api = new API({}, config.networks.hardhat.hardfork);\n+\n+    const hardhatNetworkForCoverage = {};\n+    configureHardhatEVMGas(hardhatNetworkForCoverage, api);\n+    config.networks.hardhat = Object.assign(config.networks.hardhat, hardhatNetworkForCoverage);\n+  }\n+});\n+\n+subtask(TASK_COMPILE_SOLIDITY_GET_COMPILER_INPUT).setAction(async (_, { config }, runSuper) => {\n   const solcInput = await runSuper();\n   if (measureCoverage) {\n     // The source name here is actually the global name in the solc input,\n@@ -42,7 +52,7 @@\n });\n \n // Solidity settings are best set here instead of the TASK_COMPILE_SOLIDITY_GET_COMPILER_INPUT task.\n-task(TASK_COMPILE_SOLIDITY_GET_COMPILATION_JOB_FOR_FILE).setAction(async (_, __, runSuper) => {\n+subtask(TASK_COMPILE_SOLIDITY_GET_COMPILATION_JOB_FOR_FILE).setAction(async (_, __, runSuper) => {\n   const compilationJob = await runSuper();\n   if (measureCoverage && typeof compilationJob === \"object\") {\n     if (compilationJob.solidityConfig.settings === undefined) {\n@@ -58,8 +68,37 @@\n     }\n     // Unset useLiteralContent due to solc metadata size restriction\n     settings.metadata.useLiteralContent = false;\n-    // Override optimizer settings for all compilers\n-    settings.optimizer.enabled = false;\n+\n+    // Beginning with v0.8.7, we let the optimizer run if viaIR is true and\n+    // instrument using `abi.encode(bytes8 covHash)`. Otherwise turn the optimizer off.\n+    if (!settings.viaIR || irMinimum) settings.optimizer.enabled = false;\n+\n+    // Almost identical to foundry's irMinimum option - may improve performance for projects compiling with viaIR\n+    // Original discussion at: https://github.com/ethereum/solidity/issues/12533#issuecomment-1013073350\n+    if (irMinimum) {\n+      settings.optimizer.details =  {\n+        yul: true,\n+        yulDetails: {\n+          stackAllocation: true,\n+          optimizerSteps: \"\",\n+        },\n+      }\n+    // LEGACY: This sometimes fixed a stack-too-deep bug in ABIEncoderV2 for coverage plugin versions up to 0.8.6\n+    // Although issue should be fixed in 0.8.7, am leaving this option in because it may still be necessary\n+    // to configure optimizer details in some cases.\n+    } else if (configureYulOptimizer) {\n+      if (optimizerDetails === undefined) {\n+        settings.optimizer.details = {\n+          yul: true,\n+          yulDetails: {\n+            stackAllocation: true,\n+          },\n+        }\n+      // Other configurations may work as well. This loads custom details from .solcoverjs\n+      } else {\n+        settings.optimizer.details = optimizerDetails;\n+      }\n+    }\n   }\n   return compilationJob;\n",
					"match": false,
					"packageHash": "2d2279c436b8d03085a13b412b30e042f0cc40e379254f0731477e2e5fc91ba4",
					"size": 7462,
					"sourceHash": "35db0f14d5fee0dbe0f006160be3750cde3efc8e1e120be05f0cd354cb001bff",
					"status": "content"
				},
				"plugins/nomiclabs.plugin.js": {
					"diff": "--- published/plugins/nomiclabs.plugin.js\n+++ rebuilt/plugins/nomiclabs.plugin.js\n@@ -1,6 +1 @@\n-if (global && global.__hardhatContext){\n-  require(\"./hardhat.plugin\");\n-  return;\n-}\n-\n-module.exports = require('./buidler.plugin')\n+require(\"./hardhat.plugin\");\n\\ No newline at end of file\n",
					"match": false,
					"packageHash": "75883888ba84beb9ad050978ecec8859908f4562d07c3870c0dc4c65552838f4",
					"size": 129,
					"sourceHash": "7fde82fc0451b2ad52e9c04867314164ab72573986f7a67767e46efc51d437ca",
					"status": "content"
				},
				"plugins/resources/nomiclabs.ui.js": {
					"diff": "--- published/plugins/resources/nomiclabs.ui.js\n+++ rebuilt/plugins/resources/nomiclabs.ui.js\n@@ -45,9 +45,6 @@\n \n       'instr-skipped': `${ds} ${c.grey(args[0])}`,\n \n-      'versions':  `${ct} ${c.bold('ganache-core')}:      ${args[0]}\\n` +\n-                   `${ct} ${c.bold('solidity-coverage')}: v${args[1]}`,\n-\n       'hardhat-versions': `\\n${c.bold('Version')}` +\n                           `\\n${c.bold('=======')}\\n` +\n                           `${ct} ${c.bold('solidity-coverage')}: v${args[0]}`,\n@@ -57,17 +54,12 @@\n                          `${ct} ${c.bold('HardhatEVM')}: v${args[0]}\\n` +\n                          `${ct} ${c.bold('network')}:    ${args[1]}\\n`,\n \n-      'ganache-network': `\\n${c.bold('Network Info')}` +\n-                         `\\n${c.bold('============')}\\n` +\n-                         `${ct} ${c.bold('port')}:         ${args[1]}\\n` +\n-                         `${ct} ${c.bold('network')}:      ${args[0]}\\n`,\n-\n-      'port-clash': `${w}  ${c.red(\"The 'port' values in your config's network url \")}` +\n-                          `${c.red(\"and .solcover.js are different. Using network's: \")} ${c.bold(args[0])}.\\n`,\n-\n-      'port-clash-hardhat': `${w}  ${c.red(\"The 'port' values in your Hardhat network's url \")}` +\n-                            `${c.red(\"and .solcover.js are different. Using Hardhat's: \")} ${c.bold(args[0])}.\\n`,\n-\n+      'hardhat-viem': `\\n${w}${c.red(\"  Coverage requires a special environment variable when used with 'hardhat-viem'  \")}${w}` +\n+                      `\\n${c.red(    \"====================================================================================\")}`   +\n+                      `\\n${c.bold(   \"Please run the coverage command as:\" )}` +\n+                      `\\n${c(        \"SOLIDITY_COVERAGE=true npx hardhat coverage\")}` +\n+                      `\\n${c.red(    \"====================================================================================\")}`\n+                      ,\n     }\n \n     this._write(kinds[kind]);\n@@ -84,8 +76,8 @@\n     const x = \":x:\";\n \n     const kinds = {\n-      'network-fail': `${c.red('--network argument: ')}${args[0]}` +\n-                      `${c.red(' is not a defined network in hardhat.config.js.')}`,\n+      'network-fail': `${c.red('--network cli flag is not supported for the coverage task. ')}` +\n+                      `${c.red('Beginning with v0.8.7, coverage must use the default \"hardhat\" network.')}`,\n \n       'sources-fail': `${c.red('Cannot locate expected contract sources folder: ')} ${args[0]}`,\n \n@@ -95,12 +87,14 @@\n \n       'tests-fail': `${x} ${c.bold(args[0])} ${c.red('test(s) failed under coverage.')}`,\n \n-\n+      'hardhat-viem': \"'hardhat-viem' requires an environment variable to be set when used with the solidity-coverage plugin\"\n     }\n \n \n     return this._format(kinds[kind])\n   }\n+\n+\n }\n \n-module.exports = PluginUI;\n\\ No newline at end of file\n+module.exports = PluginUI;\n",
					"match": false,
					"packageHash": "d1a64d6d2d8e5f961eea376bbb1d28b3e12a758a26478ad105009d4cfc5485dc",
					"size": 3790,
					"sourceHash": "a7332b302289c6244836aba830e64eb2ecc0e33bdc3294030fe7862c03c69ca2",
					"status": "content"
				},
				"plugins/resources/nomiclabs.utils.js": {
					"diff": "--- published/plugins/resources/nomiclabs.utils.js\n+++ rebuilt/plugins/resources/nomiclabs.utils.js\n@@ -18,20 +18,35 @@\n function getTestFilePaths(files){\n   const target = globby.sync([files])\n \n-  // Buidler/Hardhat supports js & ts\n+  // Hardhat supports js & ts\n   const testregex = /.*\\.(js|ts)$/;\n   return target.filter(f => f.match(testregex) != null);\n }\n \n /**\n- * Normalizes Buidler/Hardhat paths / logging for use by the plugin utilities and\n+ * Normalizes Hardhat paths / logging for use by the plugin utilities and\n  * attaches them to the config\n- * @param  {Buidler/HardhatConfig} config\n- * @return {Buidler/HardhatConfig}        updated config\n+ * @param  {HardhatConfig} config\n+ * @return {HardhatConfig}        updated config\n  */\n function normalizeConfig(config, args={}){\n+  let sources;\n+\n+  (args.sources)\n+    ? sources = path.join(config.paths.sources, args.sources)\n+    : sources = config.paths.sources;\n+\n+  if (!path.isAbsolute(sources)) {\n+    sources = path.join(config.paths.root, sources);\n+  }\n+\n+  if (config.solidity && config.solidity.compilers.length) {\n+    config.viaIR = isUsingViaIR(config.solidity);\n+    config.usingSolcV4 = isUsingSolcV4(config.solidity);\n+  }\n+\n   config.workingDir = config.paths.root;\n-  config.contractsDir = config.paths.sources;\n+  config.contractsDir = sources;\n   config.testDir = config.paths.tests;\n   config.artifactsDir = config.paths.artifacts;\n   config.logger = config.logger ? config.logger : {log: null};\n@@ -49,78 +64,83 @@\n   return config;\n }\n \n-function setupBuidlerNetwork(env, api, ui){\n-  const { createProvider } = require(\"@nomiclabs/buidler/internal/core/providers/construction\");\n-\n-  let networkConfig = {};\n-\n-  let networkName = (env.buidlerArguments.network !== 'buidlerevm')\n-    ? env.buidlerArguments.network\n-    : api.defaultNetworkName;\n-\n-  if (networkName !== api.defaultNetworkName){\n-    networkConfig = env.config.networks[networkName];\n-    configureHttpProvider(networkConfig, api, ui)\n-  } else {\n-    networkConfig.url = `http://${api.host}:${api.port}`\n+function isUsingSolcV4(solidity) {\n+  for (compiler of solidity.compilers) {\n+    if (compiler.version && semver.lt(compiler.version, '0.5.0')) {\n+      return true;\n+    }\n   }\n+  if (solidity.overrides) {\n+    for (key of Object.keys(solidity.overrides)){\n+      if (solidity.overrides[key].version && semver.lt(solidity.overrides[key].version, '0.5.0')) {\n+        return true;\n+      }\n+    }\n+  }\n+  return false;\n+}\n \n-  const provider = createProvider(networkName, networkConfig);\n-\n-  return configureNetworkEnv(\n-    env,\n-    networkName,\n-    networkConfig,\n-    provider\n-  )\n+function isUsingViaIR(solidity) {\n+  for (compiler of solidity.compilers) {\n+    if (compiler.settings && compiler.settings.viaIR) {\n+      return true;\n+    }\n+  }\n+  if (solidity.overrides) {\n+    for (key of Object.keys(solidity.overrides)){\n+      if (solidity.overrides[key].settings && solidity.overrides[key].settings.viaIR) {\n+        return true;\n+      }\n+    }\n+  }\n+  return false;\n }\n",
					"match": false,
					"packageHash": "fc1c391b9687d751d8a462106372fc8e61cb0cb246762a44e9cc03b1467b92e4",
					"size": 7347,
					"sourceHash": "44a7f9793ed91493bb313feeab1f1a421c9b0fb8f0bd3902bc48c2639b3537aa",
					"status": "content"
				},
				"plugins/resources/plugin.utils.js": {
					"diff": "--- published/plugins/resources/plugin.utils.js\n+++ rebuilt/plugins/resources/plugin.utils.js\n@@ -3,7 +3,7 @@\n  * of composing a workflow using the solidity-coverage API\n  */\n \n-const PluginUI = require('./truffle.ui');\n+const PluginUI = require('./plugin.ui');\n \n const path = require('path');\n const fs = require('fs-extra');\n@@ -94,7 +94,7 @@\n function getTempLocations(config){\n   const contractsRoot = path.parse(config.contractsDir).dir\n   const cwd = config.workingDir;\n-  const contractsDirName = '.coverage_contracts';\n+  const contractsDirName = config.coverageContractsTemp || '.coverage_contracts';\n   const artifactsDirName = config.temp || '.coverage_artifacts';\n \n   return {\n@@ -131,8 +131,18 @@\n // =============================\n \n function assembleFiles(config, skipFiles=[]){\n-  const targetsPath = path.join(config.contractsDir, '**', '*.{sol,vy}');\n-  const targets = shell.ls(targetsPath).map(path.normalize);\n+  let targets;\n+  let targetsPath;\n+\n+  // The targets (contractsDir) could actually be a single named file (OR a folder)\n+  const isDirectory = fs.statSync(config.contractsDir).isDirectory();\n+\n+  if (!isDirectory) {\n+    targets = [ path.normalize(config.contractsDir) ];\n+  } else {\n+    targetsPath = path.join(config.contractsDir, '**', '*.{sol,vy}');\n+    targets = shell.ls(targetsPath).map(path.normalize);\n+  }\n \n   skipFiles = assembleSkipped(config, targets, skipFiles);\n \n@@ -212,12 +222,18 @@\n       throw new Error(error)\n     }\n \n-  // Config is optional\n+  // Config is optional, but if passed and not found, error\n+  } else if (config.solcoverjs) {\n+    const message = ui.generate('solcoverjs-fail') + \" --solcoverjs flag was set but no file was found\";\n+    throw new Error(message);\n   } else {\n     coverageConfig = {};\n   }\n \n-  // Truffle writes to coverage config\n+  // viaIR and solc versions are eval'd in `nomiclab.utils.normalizeConfig`\n+  coverageConfig.viaIR = config.viaIR;\n+  coverageConfig.usingSolcV4 = config.usingSolcV4;\n+\n   coverageConfig.log = log;\n   coverageConfig.cwd = config.workingDir;\n   coverageConfig.originalContractsDir = config.contractsDir;\n@@ -232,6 +248,12 @@\n     );\n   }\n \n+  // Per fvictorio recommendation in #691\n+  if (config.mocha.parallel) {\n+    const message = ui.generate('mocha-parallel-fail');\n+    throw new Error(message);\n+  }\n+\n   return coverageConfig;\n }\n \n@@ -246,35 +268,6 @@\n   return provider.send(\"web3_clientVersion\", [])\n }\n \n-async function getAccountsGanache(provider){\n-  const payload = {\n-    jsonrpc: \"2.0\",\n-    method: \"eth_accounts\",\n-    params: [],\n-    id: 1\n-  };\n-  return ganacheRequest(provider, payload)\n-}\n-\n-async function getNodeInfoGanache(provider){\n-  const payload = {\n-    jsonrpc: \"2.0\",\n-    method: \"web3_clientVersion\",\n-    params: [],\n-    id: 1\n-  };\n-  return ganacheRequest(provider, payload)\n-}\n-\n-async function ganacheRequest(provider, payload){\n",
					"match": false,
					"packageHash": "be030f84df767676d81cfa5a88aac76389bd2c9145cf551341c020ee85c06c1a",
					"size": 7925,
					"sourceHash": "8f2edcab4f7820f3a107e91d369ce72f04692875a2ad13d4ade7560be472dcf9",
					"status": "content"
				},
				"plugins/resources/truffle.ui.js": {
					"match": false,
					"packageHash": "1aa8b7fa4907813a14ab6c81dba75504312f947a284cbdbd83fa3c07c07a46a1",
					"size": 3656,
					"status": "missing-in-source"
				},
				"plugins/resources/truffle.utils.js": {
					"match": false,
					"packageHash": "193040e2c171988102d8811f68c79f27813dc19395866b58b23163cf7339bee5",
					"size": 8022,
					"status": "missing-in-source"
				},
				"plugins/truffle.plugin.js": {
					"match": false,
					"packageHash": "72d3173ae481cbca6619dda9bdef2fa42fc0f846c84b08b47ca957a0ca2719d7",
					"size": 4122,
					"status": "missing-in-source"
				},
				"scripts/run-colony.sh": {
					"match": false,
					"packageHash": "c899a5f8c90a01a87928665e72de1cc5826f57aad1080ba17bcc47a8ddf84234",
					"size": 666,
					"status": "missing-in-source"
				},
				"scripts/run-metacoin.sh": {
					"match": false,
					"packageHash": "51354b23c0bcc70a77d4412b1d65e0c59e3bac042a87ae4ce9bf045cb99ffe6f",
					"size": 1519,
					"status": "missing-in-source"
				},
				"scripts/run-netlify.sh": {
					"match": false,
					"packageHash": "1ab2de705301d83798a4b64f20fbb601e8aec38996ff6d507d9cbe0acbe28e32",
					"size": 465,
					"status": "missing-in-source"
				},
				"scripts/run-nomiclabs.sh": {
					"match": false,
					"packageHash": "9cfb42c5e0be76053e0ece0f5a5f60b5cbd8b6aaa9545c0d0b24dacd4b0fe11f",
					"size": 2733,
					"status": "missing-in-source"
				},
				"scripts/run-zeppelin.sh": {
					"match": false,
					"packageHash": "924803c4390e473d66ef9c6179b888134fce6106bb904d98fa3b2b4663fbea21",
					"size": 1038,
					"status": "missing-in-source"
				},
				"truffle-plugin.json": {
					"match": false,
					"packageHash": "3e8aeecbca62bae3cd2f2a1c20316c7614324813be2f545c7dfe3fd2c0c2d09e",
					"size": 60,
					"status": "missing-in-source"
				},
				".github/dependabot.yaml": {
					"match": false,
					"status": "missing-in-package"
				},
				"FUNDING.json": {
					"match": false,
					"status": "missing-in-package"
				},
				"plugins/resources/plugin.ui.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"scripts/ci.sh": {
					"match": false,
					"status": "missing-in-package"
				},
				"scripts/integration.sh": {
					"match": false,
					"status": "missing-in-package"
				},
				"scripts/nomiclabs.sh": {
					"match": false,
					"status": "missing-in-package"
				},
				"scripts/unit.sh": {
					"match": false,
					"status": "missing-in-package"
				},
				"scripts/zeppelin.sh": {
					"match": false,
					"status": "missing-in-package"
				}
			},
			"summary": {
				"differentFiles": 15,
				"matchingFiles": 9,
				"missingInPackage": 8,
				"missingInSource": 12,
				"score": 0.20454545454545456,
				"totalFiles": 44
			}
		}
	}
]
