[
	{
		"reproduceVersion": "0.0.0-local",
		"timestamp": "2026-01-05T12:33:17.960Z",
		"os": "linux",
		"arch": "x64",
		"strategy": "npm:6.13.4",
		"reproduced": false,
		"attested": false,
		"package": {
			"spec": "solidity-coverage@0.7.18-eip165.0",
			"name": "solidity-coverage",
			"version": "0.7.18-eip165.0",
			"location": "https://registry.npmjs.org/solidity-coverage/-/solidity-coverage-0.7.18-eip165.0.tgz",
			"integrity": "sha512-25VEQ/rOCNb8PyVK66RSBcZU+H1zpBxIpwdaQMm4Vcq7GhA2bSG9holDvXYSrfHDVfrsAUdIZetcDNiBbMqp0A==",
			"publishedAt": "2021-08-28T00:50:00.060Z",
			"publishedWith": {
				"node": "12.16.0",
				"npm": "6.13.4"
			}
		},
		"source": {
			"integrity": null,
			"location": "git+https://github.com/sc-forks/solidity-coverage.git",
			"spec": "github:sc-forks/solidity-coverage#12894b3c331459f45a11b737842dcebeeedd966a"
		},
		"comparisonHash": "8a2a8dcbb729bf3ee9216e490c955701f0ddebe1",
		"diff": {
			"files": {
				"BUIDLER_README.md": {
					"match": false,
					"packageHash": "8fe86a2d745c9d65a09f81745d8e42695fa74b999c697b8a2ec4f76e1095db7e",
					"size": 6782,
					"status": "missing-in-source"
				},
				"CHANGELOG.md": {
					"diff": "--- published/CHANGELOG.md\n+++ rebuilt/CHANGELOG.md\n@@ -1,5 +1,111 @@\n # Changelog\n \n+0.8.11 / 2024-03-07\n+===================\n+  * Check all SWAP opcodes for inst. hashes when viaIR is true (https://github.com/sc-forks/solidity-coverage/issues/873)\n+\n+0.8.10 / 2024-02-29\n+===================\n+  * Check all PUSH opcodes for instr. hashes when viaIR is true (https://github.com/sc-forks/solidity-coverage/issues/871)\n+\n+0.8.9 / 2024-02-27\n+==================\n+  * Fix duplicate hash logic (https://github.com/sc-forks/solidity-coverage/issues/868)\n+  * Improve organization of edge case code in collector (https://github.com/sc-forks/solidity-coverage/issues/869)\n+\n+0.8.8 / 2024-02-21\n+==================\n+  * Coerce sources path to absolute path if necessary (https://github.com/sc-forks/solidity-coverage/issues/866)\n+  * Only inject file-level instr. for first pragma in file (https://github.com/sc-forks/solidity-coverage/issues/865)\n+\n+0.8.7 / 2024-02-09\n+==================\n+  * Documentation Cleanup & Improvements for 0.8.7 release\n+    (https://github.com/sc-forks/solidity-coverage/issues/859)\n+  * Add tests for file-level function declarations\n+    (https://github.com/sc-forks/solidity-coverage/issues/858)\n+  * Add try / catch unit tests (https://github.com/sc-forks/solidity-coverage/issues/857)\n+  * Fix test project configs for viaIR detection in overrides\n+    (https://github.com/sc-forks/solidity-coverage/issues/856)\n+  * Enable coverage when viaIR compiler flag is true\n+    (https://github.com/sc-forks/solidity-coverage/issues/854)\n+  * Add missing onPreCompile hook\n+    (https://github.com/sc-forks/solidity-coverage/issues/851)\n+  * Remove ganache-cli related code from API & tests\n+    (https://github.com/sc-forks/solidity-coverage/pull/849)\n+  * Add command option to specify the source files to run the coverage on\n+    (https://github.com/sc-forks/solidity-coverage/pull/838)\n+\n+0.8.6 / 2024-01-28\n+==================\n+  * Add test for multi-contract files with inheritance\n+    (https://github.com/sc-forks/solidity-coverage/issues/836)\n+  * Add test for modifiers with post-conditions (https://github.com/sc-forks/solidity-coverage/issues/835)\n+  * Document Istanbul check-coverage cli command\n+    (https://github.com/sc-forks/solidity-coverage/issues/834)\n+  * Throw error when mocha parallel is set to true\n+    (https://github.com/sc-forks/solidity-coverage/issues/833)\n+  * Fix instrumentation error for virtual modifiers\n+    (https://github.com/sc-forks/solidity-coverage/issues/832)\n+  * Add test for file level `using for` statements\n+    (https://github.com/sc-forks/solidity-coverage/issues/831)\n+  * Fix chained ternary conditionals instrumentation\n+    (https://github.com/sc-forks/solidity-coverage/issues/830)\n+  * Update faq.md with an optimizer config workaround\n+    (https://github.com/sc-forks/solidity-coverage/issues/822)\n+  * Upgrade solidity-parser to 0.18.0 (https://github.com/sc-forks/solidity-coverage/issues/829)\n+  * Perform ternary conditional injections before branch injections\n+    (https://github.com/sc-forks/solidity-coverage/issues/828)\n+  * Add drips funding config (https://github.com/sc-forks/solidity-coverage/issues/827)\n+\n+0.8.5 / 2023-09-21\n+==================\n+  * Update contributor list (https://github.com/sc-forks/solidity-coverage/issues/812)\n+  * Add dependabot config (https://github.com/sc-forks/solidity-coverage/issues/759)\n+  * Add a package description to package.json (https://github.com/sc-forks/solidity-coverage/issues/775)\n+  * change .solcoverjs occurrences to .solcover.js (https://github.com/sc-forks/solidity-coverage/issues/777)\n+  * Remove all mentions to buidler (https://github.com/sc-forks/solidity-coverage/issues/778)\n+  * Update HH dev dep & fix Zeppelin E2E test (https://github.com/sc-forks/solidity-coverage/issues/811)\n+  * Update mocha version to 10.2.0, fix deprecated debug package (https://github.com/sc-forks/solidity-coverage/issues/810)\n+\n+0.8.4 / 2023-07-04\n+==================\n+  * Update solidity-parser to 0.16.0 (https://github.com/sc-forks/solidity-coverage/issues/802)\n+\n+0.8.3 / 2023-06-22\n+==================\n+  * Updates for Hardhat v2.15.0  (https://github.com/sc-forks/solidity-coverage/pull/796)\n+\n+0.8.1 / 2022-09-06\n+===================\n+  * Restore web3-utils (https://github.com/sc-forks/solidity-coverage/issues/743)\n+\n+0.8.0 / 2022-09-05\n+==================\n+\n+* See release notes at: https://github.com/sc-forks/solidity-coverage/releases/tag/v0.8.0\n+\n+0.7.21 / 2022-04-24\n+===================\n+  * Add support for UncheckedStatement blocks (https://github.com/sc-forks/solidity-coverage/issues/712)\n+  * Lazy load hardhat plugin resources (https://github.com/sc-forks/solidity-coverage/issues/711)\n+\n+0.7.20 / 2022-02-15\n+===================\n+  * Remove early V7 Truffle patches  (https://github.com/sc-forks/solidity-coverage/issues/693)\n+\n+0.7.19 / 2022-02-09\n",
					"match": false,
					"packageHash": "40d0e16d273d1c933e444d389184aeffb1b6c8407c5fe678359a94b59f41c0d0",
					"size": 15910,
					"sourceHash": "55d966a2a75899ccb33d3a38f1d72bbc0dea476ff812ecda6899bc2311d32918",
					"status": "content"
				},
				"HARDHAT_README.md": {
					"match": false,
					"packageHash": "1cb0e124a5725006c8a0c4f678af5e91b6505d140ba2c59586548a4522989240",
					"size": 7239,
					"status": "missing-in-source"
				},
				"README.md": {
					"diff": "--- published/README.md\n+++ rebuilt/README.md\n@@ -4,7 +4,7 @@\n ![npm (tag)](https://img.shields.io/npm/v/solidity-coverage/latest)\n [![CircleCI](https://circleci.com/gh/sc-forks/solidity-coverage.svg?style=svg)][20]\n [![codecov](https://codecov.io/gh/sc-forks/solidity-coverage/branch/master/graph/badge.svg)][21]\n-[![buidler](https://buidler.dev/buidler-plugin-badge.svg?1)][26]\n+[![Hardhat](https://hardhat.org/buidler-plugin-badge.svg?1)][26]\n \n \n ## Code coverage for Solidity testing\n@@ -14,91 +14,69 @@\n   see [the accompanying article][16].\n + `solidity-coverage` is [Solcover][17]\n \n-## Install\n-```\n-$ npm install --save-dev solidity-coverage\n-```\n-\n-**Resources**:\n-+ [0.7.0 release notes][31]\n-+ [A guide][29] to upgrading from 0.6.x to 0.7.x\n-+ [0.6.3 docs][30]\n+## Requirements\n \n-### Truffle V5\n++ Hardhat >= 2.11.0\n \n-**Add** this package to your plugins array in `truffle-config.js` ([Truffle docs][27])\n-```javascript\n-module.exports = {\n-  networks: {...},\n-  plugins: [\"solidity-coverage\"]\n-}\n-```\n-**Run**\n+## Install\n ```\n-truffle run coverage [command-options]\n+$ yarn add solidity-coverage --dev\n ```\n \n-### Hardhat\n-\n-Beginning with v0.7.12, this tool supports Hardhat and runs directly on\n-HardhatEVM.\n-\n **Require** the plugin in `hardhat.config.js` ([Hardhat docs][26])\n ```javascript\n require('solidity-coverage')\n ```\n \n-**Run**\n-```\n-npx hardhat coverage [command-options]\n+Or, if you are using TypeScript, add this to your hardhat.config.ts:\n+```ts\n+import 'solidity-coverage'\n ```\n \n-(Additional Hardhat-specific info can be found [here][37])\n+**Resources**:\n++ [0.8.0 release notes][31]\n \n-### Buidler [Deprecated]\n+## Run\n+```\n+npx hardhat coverage [command-options]\n+```\n \n-**Add** the plugin in `buidler.config.js` ([Buidler docs][26])\n-```javascript\n-usePlugin('solidity-coverage')\n+### Trouble shooting\n \n-module.exports = {\n-  networks: {\n-    coverage: {\n-      url: 'http://localhost:8555'\n-    }\n-  },\n-}\n-```\n-**Run**\n+**Missing or unexpected coverage?** Make sure you're using the latest plugin version and run:\n+```sh\n+$ npx hardhat clean\n+$ npx hardhat compile\n+$ npx hardhat coverage\n ```\n-npx buidler coverage --network coverage [command-options]\n+\n+**Typescript compilation errors?**\n+```sh\n+$ npx hardhat compile\n+$ TS_NODE_TRANSPILE_ONLY=true npx hardhat coverage\n ```\n \n-**Buidler Project Examples:**\n",
					"match": false,
					"packageHash": "eb117a1b6e6861fc5a32c6f61cfaf1f648c9c77edbd27e63d1b9a5aa20bbb743",
					"size": 10848,
					"sourceHash": "b9408630537e9f4369b5b1c2863578f3469b8555e77e866fe22a6eec1c13aa65",
					"status": "content"
				},
				"lib/api.js": {
					"diff": "--- published/lib/api.js\n+++ rebuilt/lib/api.js\n@@ -4,22 +4,25 @@\n const path = require('path');\n const istanbul = require('sc-istanbul');\n const assert = require('assert');\n-const detect = require('detect-port');\n const _ = require('lodash/lang');\n+const { hardforkGte, HardforkName } = require('hardhat/internal/util/hardforks');\n \n const ConfigValidator = require('./validator');\n const Instrumenter = require('./instrumenter');\n const Coverage = require('./coverage');\n const DataCollector = require('./collector');\n const AppUI = require('./ui').AppUI;\n+const AbiUtils = require('./abi');\n \n /**\n  * Coverage Runner\n  */\n class API {\n-  constructor(config={}) {\n-    this.validator = new ConfigValidator()\n+  constructor(config={}, hardfork) {\n+    this.validator = new ConfigValidator();\n+    this.abiUtils = new AbiUtils();\n     this.config = config || {};\n+    this.testMatrix = {};\n \n     // Validate\n     this.validator.validate(this.config);\n@@ -30,33 +33,36 @@\n     this.testsErrored = false;\n \n     this.cwd = config.cwd || process.cwd();\n+    this.abiOutputPath = config.abiOutputPath || \"humanReadableAbis.json\";\n+    this.matrixOutputPath = config.matrixOutputPath || \"testMatrix.json\";\n+    this.mochaJsonOutputPath = config.mochaJsonOutputPath || \"mochaOutput.json\";\n+    this.matrixReporterPath = config.matrixReporterPath || \"solidity-coverage/plugins/resources/matrix.js\"\n \n     this.defaultHook = () => {};\n     this.onServerReady = config.onServerReady           || this.defaultHook;\n     this.onTestsComplete = config.onTestsComplete       || this.defaultHook;\n     this.onCompileComplete = config.onCompileComplete   || this.defaultHook;\n     this.onIstanbulComplete = config.onIstanbulComplete || this.defaultHook;\n-\n-    this.server = null;\n-    this.defaultPort = 8555;\n-    this.client = config.client;\n-    this.defaultNetworkName = 'soliditycoverage';\n-    this.port = config.port || this.defaultPort;\n-    this.host = config.host || \"127.0.0.1\";\n-    this.providerOptions = config.providerOptions || {};\n-    this.autoLaunchServer = config.autoLaunchServer === false ? false : true;\n+    this.onPreCompile = config.onPreCompile             || this.defaultHook;\n \n     this.skipFiles = config.skipFiles || [];\n \n     this.log = config.log || console.log;\n-    this.gasLimit = 0xffffffffff                // default \"gas sent\" with transactions\n-    this.gasLimitString = \"0x1fffffffffffff\";   // block gas limit for ganache (higher than \"gas sent\")\n-    this.gasLimitNumber = 0x1fffffffffffff;     // block gas limit for Hardhat\n+    const isEip7825Enabled = hardfork !== undefined && HardforkName.OSAKA !== undefined\n+      ? hardforkGte(hardfork, HardforkName.OSAKA)\n+      : false;\n+    this.gasLimit = isEip7825Enabled ? 2 ** 24 : 0xffffffffff   // default \"gas sent\" with transactions\n+    this.gasLimitNumber = 0x1fffffffffffff;           // block gas limit for Hardhat\n     this.gasPrice = 0x01;\n \n     this.istanbulFolder = config.istanbulFolder || false;\n     this.istanbulReporter = config.istanbulReporter || ['html', 'lcov', 'text', 'json'];\n \n+    this.viaIR = config.viaIR;\n+    this.usingSolcV4 = config.usingSolcV4;\n+    this.irMinimum = config.irMinimum;\n+    this.solcOptimizerDetails = config.solcOptimizerDetails;\n+\n     this.setLoggingLevel(config.silent);\n     this.ui = new AppUI(this.log);\n   }\n@@ -129,56 +135,6 @@\n   }\n \n   /**\n-   * Enables coverage collection on in-process ethereum client server, hooking the DataCollector\n-   * to its VM. By default, method will return a url after server has begun listening on the port\n-   * specified in the config. When `autoLaunchServer` is false, method returns`ganache.server` so\n-   * the consumer can control the 'server.listen' invocation themselves.\n-   * @param  {Object} client             ganache client\n-   * @param  {Boolean} autoLaunchServer  boolean\n-   * @return {<Promise> (String | Server) }  address of server to connect to, or initialized, unlaunched server.\n-   */\n-  async ganache(client, autoLaunchServer){\n-    // Check for port-in-use\n-    if (await detect(this.port) !== this.port){\n-      throw new Error(this.ui.generate('server-fail', [this.port]))\n-    }\n-\n-    this.collector = new DataCollector(this.instrumenter.instrumentationData);\n-\n",
					"match": false,
					"packageHash": "e76a4e09783e4de41cfbc8c1e6e42c26fdb20d588db62227a391bfa3440154c6",
					"size": 10288,
					"sourceHash": "75be6d8f1a02954590a27010957d14342cc9d5cbe9d1084f8d6889b854294e3a",
					"status": "content"
				},
				"lib/collector.js": {
					"diff": "--- published/lib/collector.js\n+++ rebuilt/lib/collector.js\n@@ -1,16 +1,16 @@\n-const web3Utils = require('web3-utils')\n-\n /**\n  * Writes data from the VM step to the in-memory\n  * coverage map constructed by the Instrumenter.\n  */\n class DataCollector {\n-  constructor(instrumentationData={}){\n+  constructor(instrumentationData={}, viaIR){\n     this.instrumentationData = instrumentationData;\n \n-    this.validOpcodes = {\n-      \"PUSH1\": true,\n-    }\n+    this.validOpcodes = this._getOpcodes(viaIR);\n+    this.lastHash = null;\n+    this.viaIR = viaIR;\n+    this.pcZeroCounter = 0;\n+    this.lastPcZeroCount = 0;\n   }\n \n   /**\n@@ -19,27 +19,17 @@\n    * @param  {Object} info  vm step info\n    */\n   step(info){\n+    if (info.pc === 0) this.pcZeroCounter++;\n+\n     try {\n       if (this.validOpcodes[info.opcode.name] && info.stack.length > 0){\n         const idx = info.stack.length - 1;\n-        let hash = web3Utils.toHex(info.stack[idx]).toString();\n-        this._registerHash(hash)\n+        let hash = '0x' +  info.stack[idx].toString(16);\n+        this._registerHash(hash);\n       }\n     } catch (err) { /*Ignore*/ };\n   }\n \n-  // Temporarily disabled because some relevant traces aren't available\n-  /**\n-   * Converts pushData value to string and registers in instrumentation map.\n-   * @param  {HardhatEVMTraceInstruction} instruction\n-   */\n-  /*trackHardhatEVMInstruction(instruction){\n-    if (instruction && instruction.pushData){\n-      let hash = `0x` + instruction.pushData.toString('hex');\n-      this._registerHash(hash)\n-    }\n-  }*/\n-\n   /**\n    * Normalizes has string and marks hit.\n    * @param  {String} hash bytes32 hash\n@@ -48,28 +38,78 @@\n     hash = this._normalizeHash(hash);\n \n     if(this.instrumentationData[hash]){\n-      this.instrumentationData[hash].hits++;\n+      // abi.encode (used to circumvent viaIR) sometimes puts the hash on the stack twice\n+      // We should only skip duplicate hashes *within* a transaction (see issue #863)\n+      if (this.lastHash !== hash || this.lastPcZeroCount !== this.pcZeroCounter) {\n+        this.lastHash = hash;\n+        this.lastPcZeroCount = this.pcZeroCounter;\n+        this.instrumentationData[hash].hits++\n+      }\n+      return;\n     }\n   }\n \n   /**\n-   * Left-pads zero prefixed bytes 32 hashes to length 66. The '59' in the\n+   * Left-pads zero prefixed bytes8 hashes to length 18. The '11' in the\n    * comparison below is arbitrary. It provides a margin for recurring zeros\n-   * but prevents left-padding shorter irrelevant hashes (like fn sigs)\n+   * but prevents left-padding shorter irrelevant hashes\n    *\n    * @param  {String} hash  data hash from evm stack.\n-   * @return {String}       0x prefixed hash of length 66.\n+   * @return {String}       0x prefixed hash of length 18.\n    */\n   _normalizeHash(hash){\n-    if (hash.length < 66 && hash.length > 59){\n+    // viaIR sometimes right-pads the hashes out to 32 bytes\n+    // but it doesn't preserve leading zeroes when it does this\n+    if (this.viaIR && hash.length >= 18) {\n+      hash = hash.slice(0,18);\n+\n+      // Detect and recover from viaIR mangled hashes by left-padding single `0`\n+      if(!this.instrumentationData[hash]) {\n+        hash = hash.slice(2);\n+        hash = '0' + hash;\n+        hash = hash.slice(0,16);\n+        hash = '0x' + hash;\n+      }\n+\n+    } else if (hash.length < 18 && hash.length > 11){\n",
					"match": false,
					"packageHash": "de9a346b76a650931840ad83cd5e5c13c9587782904698b2aa2c3696c5650639",
					"size": 2241,
					"sourceHash": "765907827852c660b3c7b198e221b96e92c5cb803d7c02c6b6f15caf7c478c02",
					"status": "content"
				},
				"lib/coverage.js": {
					"diff": "--- published/lib/coverage.js\n+++ rebuilt/lib/coverage.js\n@@ -69,6 +69,9 @@\n       const data = collectedData[hash];\n       const contractPath = collectedData[hash].contractPath;\n       const id = collectedData[hash].id;\n+\n+      // NB: Any branch using the injected fn which returns boolean will have artificially\n+      // doubled hits (because of something internal to Solidity about how the stack is managed)\n       const hits = collectedData[hash].hits;\n \n       switch(collectedData[hash].type){\n@@ -76,8 +79,10 @@\n         case 'function':   this.data[contractPath].f[id] = hits;                   break;\n         case 'statement':  this.data[contractPath].s[id] = hits;                   break;\n         case 'branch':     this.data[contractPath].b[id][data.locationIdx] = hits; break;\n-        case 'requirePre':  this.requireData[contractPath][id].preEvents = hits;     break;\n-        case 'requirePost': this.requireData[contractPath][id].postEvents = hits;    break;\n+        case 'and-true':   this.data[contractPath].b[id][data.locationIdx] = hits; break;\n+        case 'or-false':   this.data[contractPath].b[id][data.locationIdx] = hits; break;\n+        case 'requirePre':  this.requireData[contractPath][id].preEvents = hits;   break;\n+        case 'requirePost': this.requireData[contractPath][id].postEvents = hits;  break;\n       }\n     }\n \n",
					"match": false,
					"packageHash": "d5a21bbffc545e9b17640eb077033b3ca238d9e317e01b4baf0cc6199e0601a6",
					"size": 3367,
					"sourceHash": "53c19d1108c763c9e85fbfb6f70e25665dfbf02e5ed75efbd42772aedb13e806",
					"status": "content"
				},
				"lib/injector.js": {
					"diff": "--- published/lib/injector.js\n+++ rebuilt/lib/injector.js\n@@ -1,8 +1,11 @@\n const web3Utils = require(\"web3-utils\");\n \n class Injector {\n-  constructor(){\n+  constructor(viaIR){\n+    this.viaIR = viaIR;\n     this.hashCounter = 0;\n+    this.modifierCounter = 0;\n+    this.modifiers = {};\n   }\n \n   _split(contract, injectionPoint){\n@@ -13,16 +16,52 @@\n   }\n \n   _getInjectable(id, hash, type){\n-    return `${this._getMethodIdentifier(id)}(${hash}); /* ${type} */ \\n`;\n+    switch(type){\n+      case 'and-true':\n+        return ` && ${this._getTrueMethodIdentifier(id)}(${hash}))`;\n+      case 'or-false':\n+        return ` || ${this._getFalseMethodIdentifier(id)}(${hash}))`;\n+      case 'modifier':\n+        return ` ${this._getModifierIdentifier(id)} `;\n+      default:\n+        return (this.viaIR)\n+          ? `${this._getAbiEncodeStatementHash(hash)} /* ${type} */ \\n`\n+          : `${this._getDefaultMethodIdentifier(id)}(${hash}); /* ${type} */ \\n`;\n+    }\n   }\n \n   _getHash(id) {\n     this.hashCounter++;\n-    return web3Utils.keccak256(`${id}:${this.hashCounter}`);\n+    return web3Utils.keccak256(`${id}:${this.hashCounter}`).slice(0,18);\n+  }\n+\n+  // Method returns void\n+  _getDefaultMethodIdentifier(id){\n+    return `c_${web3Utils.keccak256(id).slice(2,10)}`\n+  }\n+\n+  // Method returns boolean: true\n+  _getTrueMethodIdentifier(id){\n+    return `c_true${web3Utils.keccak256(id).slice(2,10)}`\n+  }\n+\n+  // Method returns boolean: false\n+  _getFalseMethodIdentifier(id){\n+    return `c_false${web3Utils.keccak256(id).slice(2,10)}`\n   }\n \n-  _getMethodIdentifier(id){\n-    return `c_${web3Utils.keccak256(id).slice(0,10)}`\n+  _getModifierIdentifier(id){\n+    return `c_mod${web3Utils.keccak256(id).slice(2,10)}`\n+  }\n+\n+  // Way to get hash on the stack with viaIR (which seems to ignore abi.encode builtin)\n+  // Tested with v0.8.17, v0.8.24\n+    _getAbiEncodeStatementHash(hash){\n+    return `abi.encode(${hash}); `\n+  }\n+\n+  _getAbiEncodeStatementVar(hash){\n+    return `abi.encode(c__${hash}); `\n   }\n \n   _getInjectionComponents(contract, injectionPoint, id, type){\n@@ -44,10 +83,13 @@\n    * @param  {String} id\n    * @return {String}\n    */\n-  _getHashMethodDefinition(id, contract){\n-    const hash = web3Utils.keccak256(id).slice(0,10);\n-    const method = this._getMethodIdentifier(id);\n-    return `\\nfunction ${method}(bytes32 c__${hash}) internal pure {}\\n`;\n+  _getDefaultMethodDefinition(id){\n+    const hash = web3Utils.keccak256(id).slice(2,10);\n+    const method = this._getDefaultMethodIdentifier(id);\n+\n+    return (this.viaIR)\n+      ? ``\n+      : `\\nfunction ${method}(bytes8 c__${hash}) internal pure {}\\n`;\n   }\n \n   /**\n@@ -57,9 +99,120 @@\n    * @return {String}\n    */\n   _getFileScopedHashMethodDefinition(id, contract){\n-    const hash = web3Utils.keccak256(id).slice(0,10);\n-    const method = this._getMethodIdentifier(id);\n-    return `\\nfunction ${method}(bytes32 c__${hash}) pure {}\\n`;\n+    const hash = web3Utils.keccak256(id).slice(2,10);\n+    const method = this._getDefaultMethodIdentifier(id);\n+    const abi = this._getAbiEncodeStatementVar(hash);\n",
					"match": false,
					"packageHash": "97f6e371a59cf18773f65b475faa8b8ba01cda05be9e403572a9753c3b633c55",
					"size": 5976,
					"sourceHash": "6d6365d33fd5274af41646fb3f5358e86c01fd1657728c46cc5b82a91cb141d7",
					"status": "content"
				},
				"lib/instrumenter.js": {
					"diff": "--- published/lib/instrumenter.js\n+++ rebuilt/lib/instrumenter.js\n@@ -14,9 +14,15 @@\n \n   constructor(config={}){\n     this.instrumentationData = {};\n-    this.injector = new Injector();\n-    this.measureStatementCoverage = (config.measureStatementCoverage === false) ? false : true;\n-    this.measureFunctionCoverage = (config.measureFunctionCoverage === false) ? false: true;\n+    this.injector = new Injector(config.viaIR);\n+    this.modifierWhitelist = config.modifierWhitelist || [];\n+    this.enabled = {\n+      statements: (config.measureStatementCoverage === false) ? false : true,\n+      functions: (config.measureFunctionCoverage === false) ? false: true,\n+      modifiers: (config.measureModifierCoverage === false) ? false: true,\n+      branches: (config.measureBranchCoverage === false) ? false: true,\n+      lines: (config.measureLineCoverage === false) ? false: true\n+    };\n   }\n \n   _isRootNode(node){\n@@ -56,16 +62,17 @@\n   instrument(contractSource, fileName) {\n     const contract = {};\n \n+    this.injector.resetModifierMapping();\n+    parse.configure(this.enabled, this.modifierWhitelist);\n+\n     contract.source = contractSource;\n     contract.instrumented = contractSource;\n \n     this._initializeCoverageFields(contract);\n-    parse.configureStatementCoverage(this.measureStatementCoverage)\n-    parse.configureFunctionCoverage(this.measureFunctionCoverage)\n \n     // First, we run over the original contract to get the source mapping.\n     let ast = SolidityParser.parse(contract.source, {loc: true, range: true});\n-    //console.log(JSON.stringify(ast, null, ' '))\n+\n     parse[ast.type](contract, ast);\n     const retValue = JSON.parse(JSON.stringify(contract)); // Possibly apotropaic.\n \n@@ -80,7 +87,10 @@\n \n     // Handle contracts which only contain import statements\n     contract.contractName = (root.length) ? root[0].name : null;\n+\n+    contract.finalParse = true;\n     parse[ast.type](contract, ast);\n+\n     // We have to iterate through these points in descending order\n     const sortedPoints = Object.keys(contract.injectionPoints).sort((a, b) => b - a);\n \n@@ -88,7 +98,14 @@\n \n       // Line instrumentation has to happen first\n       contract.injectionPoints[injectionPoint].sort((a, b) => {\n-        const injections = ['injectBranch', 'injectEmptyBranch', 'injectLine'];\n+        const injections = [\n+          'injectBranch',\n+          'injectOpenParen',\n+          'injectOrFalse',\n+          'injectAndTrue',\n+          'injectEmptyBranch',\n+          'injectLine'\n+        ];\n         return injections.indexOf(b.type) - injections.indexOf(a.type);\n       });\n \n",
					"match": false,
					"packageHash": "bc4e019b370989b338703760e2e216fd07d53dc621f6e386ebe14fca4e1ef9e2",
					"size": 4033,
					"sourceHash": "9af2c209f425415ef395efbfffafd49744deeaa8273406321ae10701b0791067",
					"status": "content"
				},
				"lib/parse.js": {
					"diff": "--- published/lib/parse.js\n+++ rebuilt/lib/parse.js\n@@ -11,12 +11,9 @@\n const parse = {};\n \n // Utilities\n-parse.configureStatementCoverage = function(val){\n-  register.measureStatementCoverage = val;\n-}\n-\n-parse.configureFunctionCoverage = function(val){\n-  register.measureFunctionCoverage = val;\n+parse.configure = function(_enabled, _whitelist){\n+  register.enabled = Object.assign(register.enabled, _enabled);\n+  register.modifierWhitelist = _whitelist;\n }\n \n // Nodes\n@@ -32,17 +29,55 @@\n   }\n };\n \n-parse.BinaryOperation = function(contract, expression) {\n-  register.statement(contract, expression);\n+parse.BinaryOperation = function(contract, expression, skipStatementRegistry) {\n+  // Free-floating ternary conditional\n+  if (expression.left && expression.left.type === 'Conditional'){\n+    parse[expression.left.type](contract, expression.left, true);\n+\n+  // Ternary conditional assignment\n+  } else if (expression.right && expression.right.type === 'Conditional'){\n+    parse[expression.right.type](contract, expression.right, true);\n+\n+  // Regular binary operation\n+  } else if(!skipStatementRegistry){\n+    // noop\n+\n+  // LogicalOR condition search...\n+  } else {\n+    parse[expression.left.type] &&\n+    parse[expression.left.type](contract, expression.left, true);\n+\n+    parse[expression.right.type] &&\n+    parse[expression.right.type](contract, expression.right, true);\n+\n+    if (expression.operator === '||'){\n+      register.logicalOR(contract, expression);\n+    }\n+  }\n }\n \n-parse.FunctionCall = function(contract, expression) {\n+parse.TupleExpression = function(contract, expression, skipStatementRegistry) {\n+  expression.components.forEach(component => {\n+    parse[component.type] &&\n+    parse[component.type](contract, component, skipStatementRegistry);\n+  });\n+}\n+\n+parse.FunctionCall = function(contract, expression, skipStatementRegistry) {\n   // In any given chain of call expressions, only the last one will fail this check.\n   // This makes sure we don't instrument a chain of expressions multiple times.\n   if (expression.expression.type !== 'FunctionCall') {\n-    register.statement(contract, expression);\n+\n+    // Don't register sub-expressions (like intermediate method calls)\n+    if (!skipStatementRegistry){\n+      register.statement(contract, expression);\n+    }\n+\n     if (expression.expression.name === 'require') {\n       register.requireBranch(contract, expression);\n+      expression.arguments.forEach(arg => {\n+        parse[arg.type] && parse[arg.type](contract, arg, true);\n+      });\n     }\n     parse[expression.expression.type] &&\n     parse[expression.expression.type](contract, expression.expression);\n@@ -52,10 +87,19 @@\n   }\n };\n \n-parse.Conditional = function(contract, expression) {\n-  register.statement(contract, expression);\n-  // TODO: Investigate node structure\n-  // There are potential substatements here we aren't measuring\n+parse.Conditional = function(contract, expression, skipStatementRegistry) {\n+  parse[expression.condition.type] &&\n+  parse[expression.condition.type](contract, expression.condition, true);\n+\n+  if (expression.trueExpression && expression.trueExpression.type === 'Conditional'){\n+    parse[expression.trueExpression.type](contract, expression.trueExpression, true);\n+  }\n+\n+  if (expression.falseExpression && expression.falseExpression.type === 'Conditional'){\n+    parse[expression.falseExpression.type](contract, expression.falseExpression, true);\n+  }\n+\n+  register.conditional(contract, expression);\n };\n",
					"match": false,
					"packageHash": "1478ce8506dd850dc8bcdc58f3737febb5802084055772281d098261c29512c1",
					"size": 8253,
					"sourceHash": "f3ad959afb13b0d5f9a3534b57140ffdbc131eb15a3f46d32be587279e48b8e2",
					"status": "content"
				},
				"lib/registrar.js": {
					"diff": "--- published/lib/registrar.js\n+++ rebuilt/lib/registrar.js\n@@ -12,8 +12,23 @@\n     this.trackStatements = true;\n \n     // These are set by user option and enable/disable the measurement completely\n-    this.measureStatementCoverage = true;\n-    this.measureFunctionCoverage = true;\n+    this.enabled = {\n+      statements: true,\n+      functions: true,\n+      modifiers: true,\n+      branches: true,\n+      lines: true\n+    }\n+\n+    this.modifierWhitelist = [];\n+  }\n+\n+  _seekSemiColon(contract, pos) {\n+    const end = pos + 5;\n+    for(pos; pos <= end; pos++) {\n+      if (contract[pos] === ';') break;\n+    }\n+    return pos;\n   }\n \n   /**\n@@ -36,7 +51,7 @@\n    * @param  {Object} expression AST node\n    */\n   statement(contract, expression) {\n-    if (!this.trackStatements || !this.measureStatementCoverage) return;\n+    if (!this.trackStatements || !this.enabled.statements) return;\n \n     const startContract = contract.instrumented.slice(0, expression.range[0]);\n     const startline = ( startContract.match(/\\n/g) || [] ).length + 1;\n@@ -76,6 +91,8 @@\n    * @param  {Object} expression AST node\n    */\n   line(contract, expression) {\n+    if (!this.enabled.lines) return;\n+\n     const startchar = expression.range[0];\n     const endchar = expression.range[1] + 1;\n     const lastNewLine = contract.instrumented.slice(0, startchar).lastIndexOf('\\n');\n@@ -107,17 +124,52 @@\n    * @param  {Object} expression AST node\n    */\n   functionDeclaration(contract, expression) {\n-    if (!this.measureFunctionCoverage) return;\n+    if (!this.enabled.functions) return;\n \n     let start = 0;\n+    contract.fnId += 1;\n \n-    // It's possible functions will have modifiers that take string args\n-    // which contains an open curly brace. Skip ahead...\n     if (expression.modifiers && expression.modifiers.length){\n       for (let modifier of expression.modifiers ){\n+\n+        // It's possible functions will have modifiers that take string args\n+        // which contains an open curly brace. Skip ahead...\n         if (modifier.range[1] > start){\n           start = modifier.range[1];\n         }\n+\n+        // Add modifier branch coverage\n+        if (\n+          !this.enabled.modifiers   ||\n+          expression.isConstructor  ||\n+          this.modifierWhitelist.includes(modifier.name)\n+        ) {\n+          continue;\n+        }\n+\n+        this.addNewBranch(contract, modifier);\n+        this._createInjectionPoint(\n+          contract,\n+          modifier.range[0],\n+          {\n+            type: 'injectModifier',\n+            branchId: contract.branchId,\n+            modifierName: modifier.name,\n+            fnId: contract.fnId,\n+            condition: 'pre'\n+          }\n+        );\n+        this._createInjectionPoint(\n+          contract,\n+          modifier.range[1] + 1,\n+          {\n+            type: 'injectModifier',\n+            branchId: contract.branchId,\n+            modifierName: modifier.name,\n+            fnId: contract.fnId,\n+            condition: 'post'\n+          }\n+        );\n       }\n",
					"match": false,
					"packageHash": "eef0f8303826ed6ed5553cb4f7a34e51f11c246dc62f80da37aeb0194e42dfa7",
					"size": 8107,
					"sourceHash": "015976e1fa4fdf65eb50154b9364fabbd6fa789498e140b00f43aa9e67eeca2d",
					"status": "content"
				},
				"lib/ternary/conditional.js": {
					"match": false,
					"packageHash": "55cde3bd046e7231020c9823ea134cc957733d91868303c91ee2889bac0682ac",
					"size": 5967,
					"status": "missing-in-source"
				},
				"lib/ternary/ternary.js": {
					"match": false,
					"packageHash": "cbde2e96bc5d765e671a4b2a75cfa9ae420138d33e4f6fcf2c95ec86a3d5073a",
					"size": 5374,
					"status": "missing-in-source"
				},
				"lib/ui.js": {
					"diff": "--- published/lib/ui.js\n+++ rebuilt/lib/ui.js\n@@ -4,7 +4,7 @@\n /**\n  * Coverage tool output formatters. These classes support any the logging solidity-coverage API\n  * (or plugins which consume it) do on their own behalf. NB, most output is generated by the host\n- * dev stack (ex: the truffle compile command, or istanbul).\n+ * dev stack (ex: the hardhat compile command, or istanbul).\n  */\n class UI {\n   constructor(log){\n@@ -56,10 +56,6 @@\n     const w = \":warning:\";\n \n     const kinds = {\n-      'vm-fail': `${w}  ${c.red('There was a problem attaching to the ganache VM.')}\\n` +\n-                 `${w}  ${c.red('For help, see the \"client\" & \"providerOptions\" syntax in solidity-coverage docs.')}\\n`+\n-                 `${w}  ${c.red(`Using ganache-cli (v${args[0]}) instead.`)}\\n`,\n-\n \n       'instr-start': `\\n${c.bold('Instrumenting for coverage...')}` +\n                      `\\n${c.bold('=============================')}\\n`,\n@@ -69,14 +65,10 @@\n       'istanbul': `${ct} ${c.grey('Istanbul reports written to')} ./coverage/ ` +\n                         `${c.grey('and')} ./coverage.json`,\n \n-      'finish':  `${ct} ${c.grey('solidity-coverage cleaning up, shutting down ganache server')}`,\n-\n-      'server':  `${ct} ${c.bold('server: ')}           ${c.grey(args[0])}`,\n-\n       'command': `\\n${w}  ${c.red.bold('solidity-coverage >= 0.7.0 is no longer a shell command.')} ${w}\\n` +\n                  `${c.bold('=============================================================')}\\n\\n` +\n                  `Instead, you should use the plugin produced for your development stack\\n` +\n-                 `(like Truffle, Buidler) or design a custom workflow using the package API\\n\\n` +\n+                 `(like Hardhat) or design a custom workflow using the package API\\n\\n` +\n                  `> See https://github.com/sc-forks/solidity-coverage for help with configuration.\\n\\n` +\n                  `${c.green.bold('Thanks! - sc-forks')}\\n`,\n     };\n@@ -103,10 +95,6 @@\n       'istanbul-fail': `${c.red('Istanbul coverage reports could not be generated. ')}`,\n \n       'sources-fail': `${c.red('Cannot locate expected contract sources folder: ')} ${args[0]}`,\n-\n-      'server-fail': `${c.red('Port')} ${args[0]} ${c.red('is already in use.\\n')}` +\n-                     `${c.red('\\tRun: \"lsof -i\" to find the pid of the process using it.\\n')}` +\n-                     `${c.red('\\tRun: \"kill -9 <pid>\" to kill it.\\n')}`\n     }\n \n     return this._format(kinds[kind])\n",
					"match": false,
					"packageHash": "9b43e16b62a0cf20cc348d94d76fe4952a15ce217e7cd350d48e43303b14eb96",
					"size": 3943,
					"sourceHash": "2bdb0ceff4207fde57e996d57683dbf1f6c4f41a0d07466a75fe3c08f66c8acd",
					"status": "content"
				},
				"lib/validator.js": {
					"diff": "--- published/lib/validator.js\n+++ rebuilt/lib/validator.js\n@@ -14,14 +14,19 @@\n     client: {type: \"object\"},\n     cwd:    {type: \"string\"},\n     host:   {type: \"string\"},\n-\n+    abiOutputPath:      {type: \"string\"},\n+    matrixOutputPath:   {type: \"string\"},\n+    matrixReporterPath: {type: \"string\"},\n     port:                 {type: \"number\"},\n     providerOptions:      {type: \"object\"},\n     silent:               {type: \"boolean\"},\n     autoLaunchServer:     {type: \"boolean\"},\n     istanbulFolder:       {type: \"string\"},\n     measureStatementCoverage: {type: \"boolean\"},\n-    measureFunctionCoverage: {type: \"boolean\"},\n+    measureFunctionCoverage:  {type: \"boolean\"},\n+    measureModifierCoverage:  {type: \"boolean\"},\n+    measureLineCoverage:      {type: \"boolean\"},\n+    measureBranchCoverage:    {type: \"boolean\"},\n \n     // Hooks:\n     onServerReady:        {type: \"function\", format: \"isFunction\"},\n@@ -39,6 +44,11 @@\n       type: \"array\",\n       items: {type: \"string\"}\n     },\n+\n+    modifierWhitelist: {\n+      type: \"array\",\n+      items: {type: \"string\"}\n+    }\n   },\n };\n \n",
					"match": false,
					"packageHash": "69711877595716fb4ee5d0dd708ed1063eb384fb30f14e7f59a0d8983a2f75b7",
					"size": 1831,
					"sourceHash": "863d93414e11e302d83b1549f55218ad5e2082b1dc7d0270160d014f1f9ede40",
					"status": "content"
				},
				"package.json": {
					"diff": "--- published/package.json\n+++ rebuilt/package.json\n@@ -1,7 +1,7 @@\n {\n   \"name\": \"solidity-coverage\",\n-  \"version\": \"0.7.18-eip165.0\",\n-  \"description\": \"\",\n+  \"version\": \"0.8.17\",\n+  \"description\": \"Code coverage for Solidity testing\",\n   \"main\": \"plugins/nomiclabs.plugin.js\",\n   \"bin\": {\n     \"solidity-coverage\": \"./plugins/bin.js\"\n@@ -10,11 +10,12 @@\n     \"test\": \"test\"\n   },\n   \"scripts\": {\n-    \"nyc\": \"SILENT=true  nyc --exclude '**/sc_temp/**' --exclude '**/test/**'\",\n-    \"test\": \"SILENT=true node --max-old-space-size=4096 ./node_modules/.bin/nyc --exclude '**/sc_temp/**' --exclude '**/test/**/' -- mocha test/units/* --timeout 100000 --no-warnings --exit\",\n-    \"test:ci\": \"SILENT=true node --max-old-space-size=4096 ./node_modules/.bin/nyc --reporter=lcov --exclude '**/sc_temp/**' --exclude '**/test/**/' -- mocha test/units/* --timeout 100000 --no-warnings --exit\",\n-    \"test:debug\": \"node --max-old-space-size=4096 ./node_modules/.bin/mocha test/units/* --timeout 100000 --no-warnings --exit\",\n-    \"netlify\": \"./scripts/run-netlify.sh\"\n+    \"test:unit\": \"./scripts/unit.sh\",\n+    \"test:integration\": \"./scripts/integration.sh\",\n+    \"test:ci\": \"./scripts/ci.sh\",\n+    \"test:unit:viaIR\": \"VIA_IR=true ./scripts/unit.sh\",\n+    \"test:integration:viaIR\": \"VIA_IR=true ./scripts/integration.sh\",\n+    \"test:ci:viaIR\": \"VIA_IR=true ./scripts/ci.sh\"\n   },\n   \"homepage\": \"https://github.com/sc-forks/solidity-coverage\",\n   \"repository\": {\n@@ -24,41 +25,45 @@\n   \"author\": \"\",\n   \"license\": \"ISC\",\n   \"dependencies\": {\n-    \"@solidity-parser/parser\": \"^0.13.2\",\n-    \"@truffle/provider\": \"^0.2.24\",\n+    \"@ethersproject/abi\": \"^5.0.9\",\n+    \"@solidity-parser/parser\": \"^0.20.1\",\n     \"chalk\": \"^2.4.2\",\n     \"death\": \"^1.1.0\",\n-    \"detect-port\": \"^1.3.0\",\n+    \"difflib\": \"^0.2.4\",\n     \"fs-extra\": \"^8.1.0\",\n-    \"ganache-cli\": \"^6.12.2\",\n     \"ghost-testrpc\": \"^0.0.2\",\n     \"global-modules\": \"^2.0.0\",\n     \"globby\": \"^10.0.1\",\n     \"jsonschema\": \"^1.2.4\",\n-    \"lodash\": \"^4.17.15\",\n+    \"lodash\": \"^4.17.21\",\n+    \"mocha\": \"^10.2.0\",\n     \"node-emoji\": \"^1.10.0\",\n     \"pify\": \"^4.0.1\",\n     \"recursive-readdir\": \"^2.2.2\",\n     \"sc-istanbul\": \"^0.4.5\",\n     \"semver\": \"^7.3.4\",\n     \"shelljs\": \"^0.8.3\",\n-    \"web3-utils\": \"^1.3.0\"\n+    \"web3-utils\": \"^1.3.6\"\n   },\n   \"devDependencies\": {\n-    \"@nomiclabs/buidler\": \"^1.3.6\",\n-    \"@nomiclabs/buidler-truffle5\": \"^1.3.4\",\n-    \"@nomiclabs/buidler-web3\": \"^1.3.4\",\n+    \"@nomicfoundation/hardhat-network-helpers\": \"^1.0.10\",\n+    \"@nomicfoundation/hardhat-viem\": \"^2.0.0\",\n+    \"@nomiclabs/hardhat-ethers\": \"^2.0.4\",\n     \"@nomiclabs/hardhat-truffle5\": \"^2.0.0\",\n+    \"@nomiclabs/hardhat-waffle\": \"^2.0.1\",\n     \"@nomiclabs/hardhat-web3\": \"^2.0.0\",\n-    \"@truffle/contract\": \"^4.0.36\",\n-    \"buidler-gas-reporter\": \"^0.1.3\",\n+    \"chai\": \"^4.3.4\",\n+    \"chai-as-promised\": \"^7.1.1\",\n     \"decache\": \"^4.5.1\",\n-    \"hardhat\": \"^2.5.0\",\n+    \"ethereum-waffle\": \"^3.4.0\",\n+    \"ethers\": \"^5.5.3\",\n+    \"hardhat\": \"^2.22.2\",\n     \"hardhat-gas-reporter\": \"^1.0.1\",\n-    \"mocha\": \"5.2.0\",\n     \"nyc\": \"^14.1.1\",\n-    \"solc\": \"^0.5.10\",\n-    \"truffle\": \"5.0.31\",\n-    \"truffle-config\": \"^1.1.18\"\n+    \"solc\": \"0.8.24\",\n+    \"viem\": \"^2.9.9\"\n+  },\n+  \"peerDependencies\": {\n+    \"hardhat\": \"^2.11.0\"\n   }\n }\n",
					"match": false,
					"packageHash": "6c3c8f9f7359c912470c14873e7b84059c75feb7fa93d0caa1ed828fdf562ba8",
					"size": 2198,
					"sourceHash": "7c6818f1b902493e2882bda85d2d436fc46ee86295965f7b065a4cd968642fab",
					"status": "content"
				},
				"plugins/buidler.plugin.js": {
					"match": false,
					"packageHash": "230712ac2bdb6c0b38db0607bce1b6119afcb8843904801119f55d1eda587877",
					"size": 4303,
					"status": "missing-in-source"
				},
				"plugins/hardhat.plugin.js": {
					"diff": "--- published/plugins/hardhat.plugin.js\n+++ rebuilt/plugins/hardhat.plugin.js\n@@ -1,29 +1,40 @@\n-const API = require('./../lib/api');\n-const utils = require('./resources/plugin.utils');\n-const nomiclabsUtils = require('./resources/nomiclabs.utils');\n-const PluginUI = require('./resources/nomiclabs.ui');\n-\n-const pkg = require('./../package.json');\n const path = require('path');\n+const PluginUI = require('./resources/nomiclabs.ui');\n \n-const { task, types } = require(\"hardhat/config\");\n+const { extendConfig, task, types } = require(\"hardhat/config\");\n const { HardhatPluginError } = require(\"hardhat/plugins\")\n-\n+const {HARDHAT_NETWORK_RESET_EVENT} = require(\"hardhat/internal/constants\");\n const {\n   TASK_TEST,\n   TASK_COMPILE,\n   TASK_COMPILE_SOLIDITY_GET_COMPILER_INPUT,\n   TASK_COMPILE_SOLIDITY_GET_COMPILATION_JOB_FOR_FILE,\n+  TASK_COMPILE_SOLIDITY_LOG_COMPILATION_ERRORS\n } = require(\"hardhat/builtin-tasks/task-names\");\n \n // Toggled true for `coverage` task only.\n let measureCoverage = false;\n let configureYulOptimizer = false;\n-let instrumentedSources\n+let irMinimum = false;\n+let instrumentedSources;\n+let optimizerDetails;\n \n // UI for the task flags...\n const ui = new PluginUI();\n \n+// Workaround for hardhat-viem-plugin and other provider redefinition conflicts\n+extendConfig((config, userConfig) => {\n+  if (Boolean(process.env.SOLIDITY_COVERAGE)) {\n+    const { configureHardhatEVMGas } = require('./resources/nomiclabs.utils');\n+    const API = require('./../lib/api');\n+    const api = new API({}, config.networks.hardhat.hardfork);\n+\n+    const hardhatNetworkForCoverage = {};\n+    configureHardhatEVMGas(hardhatNetworkForCoverage, api);\n+    config.networks.hardhat = Object.assign(config.networks.hardhat, hardhatNetworkForCoverage);\n+  }\n+});\n+\n subtask(TASK_COMPILE_SOLIDITY_GET_COMPILER_INPUT).setAction(async (_, { config }, runSuper) => {\n   const solcInput = await runSuper();\n   if (measureCoverage) {\n@@ -57,23 +68,53 @@\n     }\n     // Unset useLiteralContent due to solc metadata size restriction\n     settings.metadata.useLiteralContent = false;\n-    // Override optimizer settings for all compilers\n-    settings.optimizer.enabled = false;\n \n-    // This is fixes a stack too deep bug in ABIEncoderV2\n-    // Experimental because not sure this works as expected across versions....\n-    if (configureYulOptimizer) {\n-      settings.optimizer.details = {\n+    // Beginning with v0.8.7, we let the optimizer run if viaIR is true and\n+    // instrument using `abi.encode(bytes8 covHash)`. Otherwise turn the optimizer off.\n+    if (!settings.viaIR || irMinimum) settings.optimizer.enabled = false;\n+\n+    // Almost identical to foundry's irMinimum option - may improve performance for projects compiling with viaIR\n+    // Original discussion at: https://github.com/ethereum/solidity/issues/12533#issuecomment-1013073350\n+    if (irMinimum) {\n+      settings.optimizer.details =  {\n         yul: true,\n         yulDetails: {\n           stackAllocation: true,\n+          optimizerSteps: \"\",\n         },\n       }\n+    // LEGACY: This sometimes fixed a stack-too-deep bug in ABIEncoderV2 for coverage plugin versions up to 0.8.6\n+    // Although issue should be fixed in 0.8.7, am leaving this option in because it may still be necessary\n+    // to configure optimizer details in some cases.\n+    } else if (configureYulOptimizer) {\n+      if (optimizerDetails === undefined) {\n+        settings.optimizer.details = {\n+          yul: true,\n+          yulDetails: {\n+            stackAllocation: true,\n+          },\n+        }\n+      // Other configurations may work as well. This loads custom details from .solcoverjs\n+      } else {\n+        settings.optimizer.details = optimizerDetails;\n+      }\n     }\n   }\n   return compilationJob;\n });\n \n+// Suppress compilation warnings because injected trace function triggers\n+// complaint about unused variable\n+subtask(TASK_COMPILE_SOLIDITY_LOG_COMPILATION_ERRORS).setAction(async (_, __, runSuper) => {\n",
					"match": false,
					"packageHash": "4b39e7b7842647c9f1da08cf356138cd4f8917b588fce96f753e0baa68bfeb17",
					"size": 6814,
					"sourceHash": "35db0f14d5fee0dbe0f006160be3750cde3efc8e1e120be05f0cd354cb001bff",
					"status": "content"
				},
				"plugins/nomiclabs.plugin.js": {
					"diff": "--- published/plugins/nomiclabs.plugin.js\n+++ rebuilt/plugins/nomiclabs.plugin.js\n@@ -1,6 +1 @@\n-if (global && global.__hardhatContext){\n-  require(\"./hardhat.plugin\");\n-  return;\n-}\n-\n-module.exports = require('./buidler.plugin')\n+require(\"./hardhat.plugin\");\n\\ No newline at end of file\n",
					"match": false,
					"packageHash": "75883888ba84beb9ad050978ecec8859908f4562d07c3870c0dc4c65552838f4",
					"size": 129,
					"sourceHash": "7fde82fc0451b2ad52e9c04867314164ab72573986f7a67767e46efc51d437ca",
					"status": "content"
				},
				"plugins/resources/nomiclabs.ui.js": {
					"diff": "--- published/plugins/resources/nomiclabs.ui.js\n+++ rebuilt/plugins/resources/nomiclabs.ui.js\n@@ -8,7 +8,12 @@\n     super(log);\n \n     this.flags = {\n-      file:       `Path (or glob) defining a subset of tests to run`,\n+      testfiles:  `Path (or glob) defining a subset of tests to run`,\n+\n+      testMatrix: `Generate a json object which maps which unit tests hit which lines of code.`,\n+\n+      abi:        `Generate a json object which can be used to produce a unified diff of your ` +\n+                  `contracts public interface between two commits.`,\n \n       solcoverjs: `Relative path from working directory to config. ` +\n                   `Useful for monorepo packages that share settings.`,\n@@ -16,7 +21,6 @@\n       temp:       `Path to a disposable folder to store compilation artifacts in. ` +\n                   `Useful when your test setup scripts include hard-coded paths to ` +\n                   `a build directory.`,\n-\n     }\n   }\n \n@@ -41,9 +45,6 @@\n \n       'instr-skipped': `${ds} ${c.grey(args[0])}`,\n \n-      'versions':  `${ct} ${c.bold('ganache-core')}:      ${args[0]}\\n` +\n-                   `${ct} ${c.bold('solidity-coverage')}: v${args[1]}`,\n-\n       'hardhat-versions': `\\n${c.bold('Version')}` +\n                           `\\n${c.bold('=======')}\\n` +\n                           `${ct} ${c.bold('solidity-coverage')}: v${args[0]}`,\n@@ -53,17 +54,12 @@\n                          `${ct} ${c.bold('HardhatEVM')}: v${args[0]}\\n` +\n                          `${ct} ${c.bold('network')}:    ${args[1]}\\n`,\n \n-      'ganache-network': `\\n${c.bold('Network Info')}` +\n-                         `\\n${c.bold('============')}\\n` +\n-                         `${ct} ${c.bold('port')}:         ${args[1]}\\n` +\n-                         `${ct} ${c.bold('network')}:      ${args[0]}\\n`,\n-\n-      'port-clash': `${w}  ${c.red(\"The 'port' values in your config's network url \")}` +\n-                          `${c.red(\"and .solcover.js are different. Using network's: \")} ${c.bold(args[0])}.\\n`,\n-\n-      'port-clash-hardhat': `${w}  ${c.red(\"The 'port' values in your Hardhat network's url \")}` +\n-                            `${c.red(\"and .solcover.js are different. Using Hardhat's: \")} ${c.bold(args[0])}.\\n`,\n-\n+      'hardhat-viem': `\\n${w}${c.red(\"  Coverage requires a special environment variable when used with 'hardhat-viem'  \")}${w}` +\n+                      `\\n${c.red(    \"====================================================================================\")}`   +\n+                      `\\n${c.bold(   \"Please run the coverage command as:\" )}` +\n+                      `\\n${c(        \"SOLIDITY_COVERAGE=true npx hardhat coverage\")}` +\n+                      `\\n${c.red(    \"====================================================================================\")}`\n+                      ,\n     }\n \n     this._write(kinds[kind]);\n@@ -80,8 +76,8 @@\n     const x = \":x:\";\n \n     const kinds = {\n-      'network-fail': `${c.red('--network argument: ')}${args[0]}` +\n-                      `${c.red(' is not a defined network in hardhat.config.js.')}`,\n+      'network-fail': `${c.red('--network cli flag is not supported for the coverage task. ')}` +\n+                      `${c.red('Beginning with v0.8.7, coverage must use the default \"hardhat\" network.')}`,\n \n       'sources-fail': `${c.red('Cannot locate expected contract sources folder: ')} ${args[0]}`,\n \n@@ -91,12 +87,14 @@\n \n       'tests-fail': `${x} ${c.bold(args[0])} ${c.red('test(s) failed under coverage.')}`,\n \n-\n+      'hardhat-viem': \"'hardhat-viem' requires an environment variable to be set when used with the solidity-coverage plugin\"\n     }\n \n \n     return this._format(kinds[kind])\n   }\n+\n+\n }\n \n-module.exports = PluginUI;\n\\ No newline at end of file\n+module.exports = PluginUI;\n",
					"match": false,
					"packageHash": "5ca0d12593a99af295ba2c1c03d05fa1550175400df5d6345641e6312eef0e81",
					"size": 3525,
					"sourceHash": "a7332b302289c6244836aba830e64eb2ecc0e33bdc3294030fe7862c03c69ca2",
					"status": "content"
				},
				"plugins/resources/nomiclabs.utils.js": {
					"diff": "--- published/plugins/resources/nomiclabs.utils.js\n+++ rebuilt/plugins/resources/nomiclabs.utils.js\n@@ -18,25 +18,41 @@\n function getTestFilePaths(files){\n   const target = globby.sync([files])\n \n-  // Buidler/Hardhat supports js & ts\n+  // Hardhat supports js & ts\n   const testregex = /.*\\.(js|ts)$/;\n   return target.filter(f => f.match(testregex) != null);\n }\n \n /**\n- * Normalizes Buidler/Hardhat paths / logging for use by the plugin utilities and\n+ * Normalizes Hardhat paths / logging for use by the plugin utilities and\n  * attaches them to the config\n- * @param  {Buidler/HardhatConfig} config\n- * @return {Buidler/HardhatConfig}        updated config\n+ * @param  {HardhatConfig} config\n+ * @return {HardhatConfig}        updated config\n  */\n function normalizeConfig(config, args={}){\n+  let sources;\n+\n+  (args.sources)\n+    ? sources = path.join(config.paths.sources, args.sources)\n+    : sources = config.paths.sources;\n+\n+  if (!path.isAbsolute(sources)) {\n+    sources = path.join(config.paths.root, sources);\n+  }\n+\n+  if (config.solidity && config.solidity.compilers.length) {\n+    config.viaIR = isUsingViaIR(config.solidity);\n+    config.usingSolcV4 = isUsingSolcV4(config.solidity);\n+  }\n+\n   config.workingDir = config.paths.root;\n-  config.contractsDir = config.paths.sources;\n+  config.contractsDir = sources;\n   config.testDir = config.paths.tests;\n   config.artifactsDir = config.paths.artifacts;\n   config.logger = config.logger ? config.logger : {log: null};\n   config.solcoverjs = args.solcoverjs\n   config.gasReporter = { enabled: false }\n+  config.matrix = args.matrix;\n \n   try {\n     const hardhatPackage = require('hardhat/package.json');\n@@ -48,78 +64,83 @@\n   return config;\n }\n \n-function setupBuidlerNetwork(env, api, ui){\n-  const { createProvider } = require(\"@nomiclabs/buidler/internal/core/providers/construction\");\n-\n-  let networkConfig = {};\n-\n-  let networkName = (env.buidlerArguments.network !== 'buidlerevm')\n-    ? env.buidlerArguments.network\n-    : api.defaultNetworkName;\n-\n-  if (networkName !== api.defaultNetworkName){\n-    networkConfig = env.config.networks[networkName];\n-    configureHttpProvider(networkConfig, api, ui)\n-  } else {\n-    networkConfig.url = `http://${api.host}:${api.port}`\n+function isUsingSolcV4(solidity) {\n+  for (compiler of solidity.compilers) {\n+    if (compiler.version && semver.lt(compiler.version, '0.5.0')) {\n+      return true;\n+    }\n   }\n+  if (solidity.overrides) {\n+    for (key of Object.keys(solidity.overrides)){\n+      if (solidity.overrides[key].version && semver.lt(solidity.overrides[key].version, '0.5.0')) {\n+        return true;\n+      }\n+    }\n+  }\n+  return false;\n+}\n \n-  const provider = createProvider(networkName, networkConfig);\n-\n-  return configureNetworkEnv(\n-    env,\n-    networkName,\n-    networkConfig,\n-    provider\n-  )\n+function isUsingViaIR(solidity) {\n+  for (compiler of solidity.compilers) {\n+    if (compiler.settings && compiler.settings.viaIR) {\n+      return true;\n+    }\n+  }\n+  if (solidity.overrides) {\n+    for (key of Object.keys(solidity.overrides)){\n+      if (solidity.overrides[key].settings && solidity.overrides[key].settings.viaIR) {\n",
					"match": false,
					"packageHash": "aae16f5f7331fb533fe1151f4348f58772f3920a198249ef5524130987c22484",
					"size": 6063,
					"sourceHash": "44a7f9793ed91493bb313feeab1f1a421c9b0fb8f0bd3902bc48c2639b3537aa",
					"status": "content"
				},
				"plugins/resources/plugin.utils.js": {
					"diff": "--- published/plugins/resources/plugin.utils.js\n+++ rebuilt/plugins/resources/plugin.utils.js\n@@ -3,7 +3,7 @@\n  * of composing a workflow using the solidity-coverage API\n  */\n \n-const PluginUI = require('./truffle.ui');\n+const PluginUI = require('./plugin.ui');\n \n const path = require('path');\n const fs = require('fs-extra');\n@@ -94,7 +94,7 @@\n function getTempLocations(config){\n   const contractsRoot = path.parse(config.contractsDir).dir\n   const cwd = config.workingDir;\n-  const contractsDirName = '.coverage_contracts';\n+  const contractsDirName = config.coverageContractsTemp || '.coverage_contracts';\n   const artifactsDirName = config.temp || '.coverage_artifacts';\n \n   return {\n@@ -131,8 +131,18 @@\n // =============================\n \n function assembleFiles(config, skipFiles=[]){\n-  const targetsPath = path.join(config.contractsDir, '**', '*.{sol,vy}');\n-  const targets = shell.ls(targetsPath).map(path.normalize);\n+  let targets;\n+  let targetsPath;\n+\n+  // The targets (contractsDir) could actually be a single named file (OR a folder)\n+  const isDirectory = fs.statSync(config.contractsDir).isDirectory();\n+\n+  if (!isDirectory) {\n+    targets = [ path.normalize(config.contractsDir) ];\n+  } else {\n+    targetsPath = path.join(config.contractsDir, '**', '*.{sol,vy}');\n+    targets = shell.ls(targetsPath).map(path.normalize);\n+  }\n \n   skipFiles = assembleSkipped(config, targets, skipFiles);\n \n@@ -212,12 +222,18 @@\n       throw new Error(error)\n     }\n \n-  // Config is optional\n+  // Config is optional, but if passed and not found, error\n+  } else if (config.solcoverjs) {\n+    const message = ui.generate('solcoverjs-fail') + \" --solcoverjs flag was set but no file was found\";\n+    throw new Error(message);\n   } else {\n     coverageConfig = {};\n   }\n \n-  // Truffle writes to coverage config\n+  // viaIR and solc versions are eval'd in `nomiclab.utils.normalizeConfig`\n+  coverageConfig.viaIR = config.viaIR;\n+  coverageConfig.usingSolcV4 = config.usingSolcV4;\n+\n   coverageConfig.log = log;\n   coverageConfig.cwd = config.workingDir;\n   coverageConfig.originalContractsDir = config.contractsDir;\n@@ -232,6 +248,12 @@\n     );\n   }\n \n+  // Per fvictorio recommendation in #691\n+  if (config.mocha.parallel) {\n+    const message = ui.generate('mocha-parallel-fail');\n+    throw new Error(message);\n+  }\n+\n   return coverageConfig;\n }\n \n@@ -246,35 +268,6 @@\n   return provider.send(\"web3_clientVersion\", [])\n }\n \n-async function getAccountsGanache(provider){\n-  const payload = {\n-    jsonrpc: \"2.0\",\n-    method: \"eth_accounts\",\n-    params: [],\n-    id: 1\n-  };\n-  return ganacheRequest(provider, payload)\n-}\n-\n-async function getNodeInfoGanache(provider){\n-  const payload = {\n-    jsonrpc: \"2.0\",\n-    method: \"web3_clientVersion\",\n-    params: [],\n-    id: 1\n-  };\n-  return ganacheRequest(provider, payload)\n-}\n-\n-async function ganacheRequest(provider, payload){\n",
					"match": false,
					"packageHash": "be030f84df767676d81cfa5a88aac76389bd2c9145cf551341c020ee85c06c1a",
					"size": 7925,
					"sourceHash": "8f2edcab4f7820f3a107e91d369ce72f04692875a2ad13d4ade7560be472dcf9",
					"status": "content"
				},
				"plugins/resources/truffle.library.js": {
					"match": false,
					"packageHash": "ed7eb7a4009bf710b21be163cacf039e2a85b2976817a3b1d9026bc04c174c14",
					"size": 17121727,
					"status": "missing-in-source"
				},
				"plugins/resources/truffle.library.js.map": {
					"match": false,
					"packageHash": "ed204ce86349dafd5dbd0c9daa293225787352e1e82a2f571aa68cc829d2444e",
					"size": 20947312,
					"status": "missing-in-source"
				},
				"plugins/resources/truffle.ui.js": {
					"match": false,
					"packageHash": "cc2e564b7cdd13bc384b97ed713a68d0349c208f6a1cfaf83e1c09a133934104",
					"size": 3974,
					"status": "missing-in-source"
				},
				"plugins/resources/truffle.utils.js": {
					"match": false,
					"packageHash": "571c604b8d341c28a68930fb05a559bfb3995e2753a55d5300090458c75b413d",
					"size": 6242,
					"status": "missing-in-source"
				},
				"plugins/truffle.plugin.js": {
					"match": false,
					"packageHash": "5364ae431721a087f6d62f9ab3eb72b5e2f5e0b2e6c7fcad3d483a1f932ea219",
					"size": 3404,
					"status": "missing-in-source"
				},
				"scripts/run-colony.sh": {
					"match": false,
					"packageHash": "c899a5f8c90a01a87928665e72de1cc5826f57aad1080ba17bcc47a8ddf84234",
					"size": 666,
					"status": "missing-in-source"
				},
				"scripts/run-metacoin.sh": {
					"match": false,
					"packageHash": "afcea925fc19348bfc37b113cf9fb8c2f9605b2d86442846460dcd98862fcc6f",
					"size": 1334,
					"status": "missing-in-source"
				},
				"scripts/run-netlify.sh": {
					"match": false,
					"packageHash": "1ab2de705301d83798a4b64f20fbb601e8aec38996ff6d507d9cbe0acbe28e32",
					"size": 465,
					"status": "missing-in-source"
				},
				"scripts/run-nomiclabs.sh": {
					"match": false,
					"packageHash": "ee4acc0a35c621d03ab482b9173713edb2dceee4fce6a692cb0e230cd129fe41",
					"size": 2122,
					"status": "missing-in-source"
				},
				"scripts/run-zeppelin.sh": {
					"match": false,
					"packageHash": "924803c4390e473d66ef9c6179b888134fce6106bb904d98fa3b2b4663fbea21",
					"size": 1038,
					"status": "missing-in-source"
				},
				"truffle-plugin.json": {
					"match": false,
					"packageHash": "3e8aeecbca62bae3cd2f2a1c20316c7614324813be2f545c7dfe3fd2c0c2d09e",
					"size": 60,
					"status": "missing-in-source"
				},
				".github/dependabot.yaml": {
					"match": false,
					"status": "missing-in-package"
				},
				"FUNDING.json": {
					"match": false,
					"status": "missing-in-package"
				},
				"lib/abi.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"plugins/resources/matrix.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"plugins/resources/plugin.ui.js": {
					"match": false,
					"status": "missing-in-package"
				},
				"scripts/ci.sh": {
					"match": false,
					"status": "missing-in-package"
				},
				"scripts/integration.sh": {
					"match": false,
					"status": "missing-in-package"
				},
				"scripts/nomiclabs.sh": {
					"match": false,
					"status": "missing-in-package"
				},
				"scripts/unit.sh": {
					"match": false,
					"status": "missing-in-package"
				},
				"scripts/zeppelin.sh": {
					"match": false,
					"status": "missing-in-package"
				}
			},
			"summary": {
				"differentFiles": 17,
				"matchingFiles": 5,
				"missingInPackage": 10,
				"missingInSource": 16,
				"score": 0.10416666666666667,
				"totalFiles": 48
			}
		}
	}
]
